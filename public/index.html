<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Twilio Voice AI Workshop - Interactive Tutorial</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #F22F46 0%, #0d122b 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .workshop-container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #F22F46 0%, #0d122b 100%);
      padding: 30px;
      color: white;
      text-align: center;
    }

    .header h1 {
      font-size: 2rem;
      margin-bottom: 10px;
    }

    /* Progress Steps */
    .progress-steps {
      display: flex;
      justify-content: space-between;
      padding: 30px;
      background: #f8f9fa;
      border-bottom: 2px solid #e0e0e0;
      overflow-x: auto;
    }

    .step-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
      position: relative;
      min-width: 120px;
    }

    .step-item:not(:last-child)::after {
      content: '';
      position: absolute;
      top: 20px;
      left: 60%;
      width: 80%;
      height: 3px;
      background: #e0e0e0;
      z-index: 0;
    }

    .step-item.completed:not(:last-child)::after {
      background: #28a745;
    }

    .step-number {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #e0e0e0;
      color: #666;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      margin-bottom: 8px;
      position: relative;
      z-index: 1;
    }

    .step-item.active .step-number {
      background: #F22F46;
      color: white;
      box-shadow: 0 0 0 4px rgba(242, 47, 70, 0.2);
    }

    .step-item.completed .step-number {
      background: #28a745;
      color: white;
    }

    .step-item.completed .step-number::before {
      content: '‚úì';
    }

    .step-title {
      font-size: 12px;
      text-align: center;
      color: #666;
      font-weight: 500;
    }

    .step-item.active .step-title {
      color: #F22F46;
      font-weight: 600;
    }

    /* Main Content */
    .content {
      padding: 40px;
    }

    .step-content {
      display: none;
    }

    .step-content.active {
      display: block;
      animation: fadeIn 0.5s;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .step-header {
      margin-bottom: 30px;
    }

    .step-header h2 {
      font-size: 1.8rem;
      color: #0d122b;
      margin-bottom: 10px;
    }

    .step-header p {
      color: #666;
      font-size: 1.1rem;
    }

    .instructions {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 20px;
      margin: 20px 0;
      border-radius: 4px;
    }

    .instructions h3 {
      color: #856404;
      margin-bottom: 15px;
    }

    .form-group {
      margin: 20px 0;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #333;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #F22F46;
    }

    .code-editor {
      background: #1e1e1e;
      border: 1px solid #333;
      border-radius: 8px;
      overflow: hidden;
      margin: 20px 0;
    }

    .code-header {
      background: #2d2d2d;
      color: white;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .btn-copy {
      background: #0d122b;
      color: white;
      padding: 6px 12px;
      font-size: 13px;
      border: 1px solid #4fc1ff;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-copy:hover {
      background: #4fc1ff;
      color: #0d122b;
    }

    .btn-copy.copied {
      background: #28a745;
      border-color: #28a745;
    }

    .code-textarea {
      width: 100%;
      min-height: 300px;
      background: #1e1e1e;
      color: #d4d4d4;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 14px;
      line-height: 1.6;
      padding: 20px;
      border: none;
      resize: vertical;
      outline: none;
    }

    .console-output {
      background: #1e1e1e;
      color: #d4d4d4;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 13px;
      padding: 15px;
      min-height: 150px;
      max-height: 300px;
      overflow-y: auto;
      border-radius: 8px;
      margin: 20px 0;
    }

    .console-line {
      margin-bottom: 5px;
    }

    .console-line.success { color: #4ec9b0; }
    .console-line.error { color: #f48771; }
    .console-line.info { color: #4fc1ff; }

    .status-box {
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      display: none;
    }

    .status-box.show {
      display: block;
    }

    .status-box.success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }

    .status-box.error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }

    .status-box.info {
      background: #e7f5ff;
      border: 1px solid #b8daff;
      color: #004085;
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin: 30px 0;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
    }

    .btn-primary {
      background: #F22F46;
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: #d1283d;
      transform: translateY(-2px);
    }

    .btn-primary:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-test {
      background: #17a2b8;
      color: white;
    }

    .live-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #28a745;
      margin-right: 8px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .connection-status {
      padding: 10px 15px;
      background: #f8f9fa;
      border-radius: 6px;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      margin: 10px 0;
    }

    .service-card {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
    }

    .service-card h4 {
      margin-bottom: 10px;
      color: #0d122b;
    }

    .service-status {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
    }

    /* Toolbar */
    .toolbar {
      background: #f8f9fa;
      border-bottom: 1px solid #e0e0e0;
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }

    .toolbar-left, .toolbar-right {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .btn-icon {
      padding: 8px 16px;
      border: 1px solid #e0e0e0;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .btn-icon:hover {
      background: #f8f9fa;
      border-color: #F22F46;
    }

    /* Debugger Panel */
    .debugger-panel {
      background: #1e1e1e;
      border-radius: 8px;
      padding: 15px;
      margin: 20px 0;
      display: none;
    }

    .debugger-panel.show {
      display: block;
    }

    .debugger-header {
      color: #4fc1ff;
      font-weight: 600;
      margin-bottom: 10px;
      font-size: 14px;
    }

    .event-flow {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .event-item {
      background: #2d2d2d;
      padding: 10px;
      border-radius: 4px;
      border-left: 3px solid #4fc1ff;
      font-family: monospace;
      font-size: 12px;
      color: #d4d4d4;
    }

    .event-item.start { border-left-color: #28a745; }
    .event-item.transcript { border-left-color: #ffc107; }
    .event-item.response { border-left-color: #4fc1ff; }
    .event-item.stop { border-left-color: #dc3545; }

    /* WebSocket Tester */
    .ws-tester {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }

    .ws-controls {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    /* Cost Calculator */
    .cost-widget {
      background: linear-gradient(135deg, #4fc1ff 0%, #0d122b 100%);
      color: white;
      border-radius: 8px;
      padding: 15px;
      margin: 20px 0;
    }

    .cost-breakdown {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .cost-item {
      background: rgba(255, 255, 255, 0.1);
      padding: 10px;
      border-radius: 4px;
    }

    .cost-item strong {
      display: block;
      font-size: 18px;
    }

    /* Video Section */
    .video-section {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }

    .video-container {
      position: relative;
      padding-bottom: 56.25%;
      height: 0;
      overflow: hidden;
      border-radius: 8px;
      background: #000;
      margin-top: 10px;
    }

    .video-container iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    /* Troubleshooting Panel */
    .troubleshooting {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 15px;
      border-radius: 4px;
      margin: 20px 0;
    }

    .faq-item {
      margin: 10px 0;
      cursor: pointer;
      padding: 10px;
      background: white;
      border-radius: 4px;
    }

    .faq-item:hover {
      background: #f8f9fa;
    }

    .faq-answer {
      display: none;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #e0e0e0;
      color: #666;
    }

    .faq-item.open .faq-answer {
      display: block;
    }

    /* Autocomplete */
    .autocomplete-suggestions {
      position: absolute;
      background: #2d2d2d;
      border: 1px solid #4fc1ff;
      border-radius: 4px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
    }

    .autocomplete-item {
      padding: 8px 12px;
      cursor: pointer;
      color: #d4d4d4;
      font-family: monospace;
      font-size: 13px;
    }

    .autocomplete-item:hover {
      background: #4fc1ff;
      color: #0d122b;
    }

    /* Progress Indicator */
    .progress-saved {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #28a745;
      color: white;
      padding: 10px 20px;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      display: none;
      animation: slideIn 0.3s;
    }

    @keyframes slideIn {
      from { transform: translateY(100px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-close {
      cursor: pointer;
      font-size: 24px;
      color: #666;
    }

    /* Language Toggle */
    .language-toggle {
      background: white;
      border-bottom: 2px solid #e0e0e0;
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }

    .language-toggle-label {
      color: #666;
      font-weight: 600;
      font-size: 0.95rem;
    }

    .language-buttons {
      display: flex;
      gap: 10px;
      background: #f8f9fa;
      padding: 4px;
      border-radius: 8px;
    }

    .lang-btn {
      padding: 8px 20px;
      border: none;
      background: transparent;
      color: #666;
      font-weight: 600;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.3s;
      font-size: 0.9rem;
    }

    .lang-btn:hover {
      background: rgba(242, 47, 70, 0.1);
      color: #F22F46;
    }

    .lang-btn.active {
      background: #F22F46;
      color: white;
      box-shadow: 0 2px 8px rgba(242, 47, 70, 0.3);
    }

    .lang-icon {
      margin-right: 5px;
    }

    /* Tooltip styles */
    .tooltip-trigger {
      display: inline-block;
      color: #F22F46;
      cursor: help;
      border-bottom: 1px dashed #F22F46;
      position: relative;
    }

    .tooltip-content {
      display: none;
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      border: 2px solid #F22F46;
      border-radius: 12px;
      padding: 20px;
      width: 300px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      margin-bottom: 10px;
    }

    .tooltip-trigger:hover .tooltip-content {
      display: block;
      animation: fadeIn 0.3s;
    }

    .tooltip-content h4 {
      color: #0d122b;
      margin-bottom: 10px;
      font-size: 1.1rem;
    }

    .tooltip-content p {
      color: #666;
      line-height: 1.5;
      margin-bottom: 10px;
      font-size: 0.9rem;
    }

    .tooltip-content a {
      color: #F22F46;
      text-decoration: none;
      font-weight: 600;
    }

    .tooltip-content a:hover {
      text-decoration: underline;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>
<body>
  <div class="workshop-container">
    <div class="header">
      <h1>üéôÔ∏è Twilio Voice AI Workshop</h1>
      <p>Build a Function Agentic Voice AI Solution with ConversationRelay & OpenAI</p>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
      <div class="toolbar-left">
        <button class="btn-icon" onclick="saveProgress()">üíæ Save Progress</button>
        <button class="btn-icon" onclick="loadProgress()">üìÇ Load Progress</button>
        <button class="btn-icon" onclick="exportProject()">üì¶ Export Project</button>
      </div>
      <div class="toolbar-right">
        <button class="btn-icon" onclick="openPlayground()">üéì What is CR?</button>
        <button class="btn-icon" onclick="toggleDebugger()">üêõ Debugger</button>
        <!-- Cost calculator temporarily removed - pricing needs to be verified -->
        <!-- <button class="btn-icon" onclick="showCostCalculator()">üí∞ Costs</button> -->
        <button class="btn-icon" onclick="showBugReportModal()" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white;">üêõ Report Bug</button>
        <button class="btn-icon" onclick="showHelp()">‚ùì Help</button>
      </div>
    </div>

    <!-- Demo Mode Banner -->
    <div id="demoModeBanner" style="display: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 30px; border-bottom: 2px solid rgba(255,255,255,0.3);">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div style="display: flex; align-items: center; gap: 15px;">
          <span style="font-size: 24px;">üìù</span>
          <div>
            <strong style="font-size: 16px;">Demo Mode Active</strong>
            <p style="margin: 3px 0 0 0; font-size: 13px; opacity: 0.9;">
              Exploring without credentials - API calls are simulated
            </p>
          </div>
        </div>
        <button onclick="exitDemoMode()" style="padding: 10px 20px; background: rgba(255,255,255,0.2); color: white; border: 1px solid white; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">
          ‚ùå Exit Demo Mode
        </button>
      </div>
    </div>

    <!-- Overall Progress Bar -->
    <div style="background: white; padding: 20px 30px; border-bottom: 2px solid #e0e0e0;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <h3 style="margin: 0; font-size: 16px; color: #0d122b;">Workshop Progress</h3>
        <span id="progressPercent" style="font-weight: 600; color: #F22F46;">0%</span>
      </div>
      <div style="width: 100%; height: 12px; background: #e0e0e0; border-radius: 6px; overflow: hidden;">
        <div id="progressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #F22F46 0%, #0d122b 100%); transition: width 0.5s ease;"></div>
      </div>
      <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 12px; color: #666;">
        <span id="completedTasks">0 of 9 steps completed</span>
        <span id="timeEstimate">Est. 45-60 minutes</span>
      </div>
    </div>

    <!-- Progress Steps -->
    <div class="progress-steps" id="progressSteps">
      <!-- Populated by JavaScript -->
    </div>

    <!-- Main Content -->
    <div class="content" id="mainContent">
      <!-- Step content populated by JavaScript -->
    </div>
  </div>

  <!-- Progress Saved Indicator -->
  <div class="progress-saved" id="progressSaved">‚úì Progress Saved</div>

  <!-- Cost Calculator Modal -->
  <div class="modal" id="costModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üí∞ Cost Calculator</h2>
        <span class="modal-close" onclick="closeModal('costModal')">&times;</span>
      </div>
      <div id="costCalculatorContent"></div>
    </div>
  </div>

  <!-- Help Modal -->
  <div class="modal" id="helpModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>‚ùì Help & Troubleshooting</h2>
        <span class="modal-close" onclick="closeModal('helpModal')">&times;</span>
      </div>
      <div id="helpContent"></div>
    </div>
  </div>

  <!-- Export Project Modal -->
  <div class="modal" id="exportModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üì¶ Export Your Project</h2>
        <span class="modal-close" onclick="closeModal('exportModal')">&times;</span>
      </div>
      <div id="exportContent"></div>
    </div>
  </div>

  <!-- Bug Report Modal -->
  <div class="modal" id="bugReportModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 style="color: #e74c3c;">üêõ Report a Bug</h2>
        <span class="modal-close" onclick="closeModal('bugReportModal')">&times;</span>
      </div>
      <div style="padding: 20px;">
        <p style="margin-bottom: 20px; color: #666;">
          Help us improve the workshop! Please describe the issue you're experiencing and we'll get back to you.
        </p>

        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600;">Your Name (optional)</label>
          <input type="text" id="bugUserName" placeholder="Your name"
                 style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 1rem;">
        </div>

        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600;">What happened? <span style="color: #e74c3c;">*</span></label>
          <textarea id="bugDescription" rows="4" placeholder="Describe the bug or issue..."
                    style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 1rem; resize: vertical;" required></textarea>
        </div>

        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600;">What did you expect to happen?</label>
          <textarea id="bugExpectedBehavior" rows="2" placeholder="e.g., The deploy button should have succeeded"
                    style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 1rem; resize: vertical;"></textarea>
        </div>

        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600;">What actually happened?</label>
          <textarea id="bugActualBehavior" rows="2" placeholder="e.g., Got an error message saying 'Deployment failed'"
                    style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 1rem; resize: vertical;"></textarea>
        </div>

        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600;">Error Message (if any)</label>
          <textarea id="bugErrorMessage" rows="3" placeholder="Copy/paste any error messages here..."
                    style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 1rem; font-family: 'Monaco', monospace; resize: vertical;"></textarea>
        </div>

        <div style="padding: 15px; background: #f8f9fa; border-radius: 6px; margin-bottom: 20px;">
          <div style="font-size: 13px; color: #666; margin-bottom: 8px;"><strong>Auto-captured info:</strong></div>
          <div style="font-size: 13px; color: #333;">
            <div>üìç Current Step: <span id="bugCurrentStep">-</span></div>
            <div>üåê Page URL: <span id="bugPageUrl" style="word-break: break-all;">-</span></div>
            <div>üñ•Ô∏è Browser: <span id="bugBrowserInfo">-</span></div>
          </div>
        </div>

        <div style="display: flex; gap: 10px;">
          <button onclick="submitBugReport()"
                  style="flex: 1; padding: 14px; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; border: none; border-radius: 6px; font-size: 1rem; font-weight: 600; cursor: pointer;">
            üì§ Submit Bug Report
          </button>
          <button onclick="closeModal('bugReportModal')"
                  style="padding: 14px 20px; background: #6c757d; color: white; border: none; border-radius: 6px; font-size: 1rem; cursor: pointer;">
            Cancel
          </button>
        </div>

        <div id="bugReportStatus" style="margin-top: 15px;"></div>
      </div>
    </div>
  </div>

  <script>
    // Workshop Steps Configuration
    const steps = [
      {
        id: 1,
        title: 'Setup',
        description: 'Connect your accounts',
        validate: () => twilioConnected
      },
      {
        id: 2,
        title: 'Direction',
        description: 'Choose call direction',
        validate: () => callDirectionChosen
      },
      {
        id: 3,
        title: 'Services',
        description: 'Provision Twilio services',
        validate: () => servicesReady
      },
      {
        id: 4,
        title: 'Basic TwiML',
        description: 'Build, test & deploy',
        validate: () => basicTwimlCreated && functionsDeployed
      },
      {
        id: 5,
        title: 'WebSocket Handler',
        description: 'Setup real-time streaming',
        validate: () => websocketBuilt
      },
      {
        id: 6,
        title: 'ConversationRelay',
        description: 'Upgrade to AI',
        validate: () => conversationRelayCreated
      },
      {
        id: 7,
        title: 'Prompt Engineering',
        description: 'Master AI prompting',
        validate: () => promptEngineeringComplete
      },
      {
        id: 8,
        title: 'Tools & Functions',
        description: 'Add tools & knowledge',
        validate: () => toolsConfigured
      },
      {
        id: 9,
        title: 'Deploy Your System',
        description: 'Launch to production',
        validate: () => projectDeployed
      }
    ];

    // State
    let currentStep = 0;
    let twilioConnected = false;
    let openaiConnected = false;
    let callDirectionChosen = false;
    let callDirection = ''; // 'outbound' or 'inbound'
    let servicesReady = false;
    let basicTwimlCreated = false;
    let functionsDeployed = false;
    let basicCallTested = false;
    let websocketBuilt = false;

    // Progressive reveal flags for Step 4
    let step4CodeValidated = false;
    let step4LiveTestCompleted = false;

    // Progressive reveal flags for Step 4
    let step4Deployed = false;

    // Progressive reveal flags for Step 5
    let step5CodeValidated = false;
    let step5Deployed = false;

    // Progressive reveal flags for Step 6
    let step6CodeValidated = false;
    let step6CodeTested = false;
    let step6Deployed = false;
    let conversationRelayCreated = false;
    let promptEngineeringComplete = false;
    let toolsConfigured = false;
    let projectDeployed = false;
    let aiCallTested = false;

    let twilioCredentials = null;
    let openaiApiKey = null;
    let selectedPhoneNumber = null;
    let selectedPhoneNumberSid = null;
    let websocketUrl = '';
    let syncServiceSkipped = false;
    let deployedServiceSid = null;
    let githubToken = null;
    let githubUsername = null;
    let studentName = localStorage.getItem('studentName') || '';
    let studentDemoMode = localStorage.getItem('studentDemoMode') === 'true';
    let ttsProvider = 'amazon-polly'; // Default TTS provider
    let elevenlabsApiKey = null; // For ElevenLabs TTS
    let conversationRelayVoice = null; // Selected voice for ConversationRelay

    // Incremental deployment tracking
    let step4Committed = false; // Basic TwiML
    let step5Committed = false; // WebSocket
    let step6Committed = false; // ConversationRelay
    let step8Committed = false; // Tooling
    let deployedEnvironmentSid = null;
    let deployedBuildSid = null;

    // Language preference
    let currentLanguage = localStorage.getItem('preferredLanguage') || 'javascript';

    // =========================================================================
    // PROGRESS PERSISTENCE
    // =========================================================================

    function saveProgressToStorage() {
      const progress = {
        currentStep,
        twilioConnected,
        openaiConnected,
        callDirectionChosen,
        callDirection,
        servicesReady,
        basicTwimlCreated,
        functionsDeployed,
        basicCallTested,
        websocketBuilt,
        conversationRelayCreated,
        aiCallTested,
        twilioCredentials,
        openaiApiKey,
        selectedPhoneNumber,
        websocketUrl,
        syncServiceSkipped,
        deployedServiceSid,
        ttsProvider,
        conversationRelayVoice,
        step4Committed,
        step4Deployed,
        step5Committed,
        step5Deployed,
        step6Committed,
        step6Deployed,
        step8Committed,
        deployedEnvironmentSid,
        deployedBuildSid,
        timestamp: new Date().toISOString(),
        completedSteps: steps.slice(0, currentStep).map(s => s.title)
      };
      localStorage.setItem('workshop_progress', JSON.stringify(progress));
      console.log('Progress auto-saved:', progress);
    }

    function loadProgressFromStorage() {
      try {
        const saved = localStorage.getItem('workshop_progress');
        if (saved) {
          const progress = JSON.parse(saved);
          const savedDate = new Date(progress.timestamp);
          const daysSince = (Date.now() - savedDate.getTime()) / (1000 * 60 * 60 * 24);

          if (daysSince < 7) {
            return progress;
          } else {
            localStorage.removeItem('workshop_progress');
          }
        }
      } catch (error) {
        console.error('Error loading progress:', error);
      }
      return null;
    }

    function showSetupRequiredModal() {
      const modal = document.createElement('div');
      modal.id = 'setupModal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        animation: fadeIn 0.3s;
      `;

      modal.innerHTML = `
        <div style="background: white; border-radius: 16px; padding: 50px; max-width: 650px; text-align: center; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);">
          <div style="font-size: 4rem; margin-bottom: 20px;">üöÄ</div>
          <h2 style="color: #0d122b; margin-bottom: 20px; font-size: 2rem;">Welcome to the Workshop!</h2>
          <p style="color: #666; margin-bottom: 25px; line-height: 1.6; font-size: 1.05rem;">
            This workshop guides you through building AI-powered voice agents. You'll connect your accounts to test with real APIs.
          </p>
          <div style="background: #f8f9fa; padding: 25px; border-radius: 12px; margin-bottom: 25px; text-align: left; border-left: 4px solid #F22F46;">
            <strong style="color: #0d122b; display: block; margin-bottom: 15px; font-size: 1.1rem;">You'll connect to:</strong>
            <ul style="margin-left: 20px; color: #666; line-height: 2;">
              <li>üêô <strong>GitHub</strong> - Clone workshop code to your account</li>
              <li>üìû <strong>Twilio</strong> - Make real phone calls and test voice APIs</li>
              <li>ü§ñ <strong>OpenAI</strong> - Power your AI voice assistant with GPT</li>
            </ul>
          </div>
          <div style="background: #e8f5e9; padding: 20px; border-radius: 12px; margin-bottom: 25px; border-left: 4px solid #4caf50;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
              <span style="font-size: 1.5rem;">üîí</span>
              <strong style="color: #2e7d32; font-size: 1.05rem;">Your credentials are secure</strong>
            </div>
            <p style="color: #555; font-size: 0.95rem; line-height: 1.6; margin: 0; text-align: left;">
              All credentials are stored <strong>only in your browser</strong> (localStorage). We never send or store your credentials on our servers. Everything runs client-side during the workshop.
            </p>
          </div>
          <div style="margin-bottom: 25px;">
            <label for="studentName" style="display: block; text-align: left; color: #666; font-size: 0.95rem; margin-bottom: 8px; font-weight: 500;">
              Your Name <span style="color: #999; font-weight: 400;">(optional)</span>
            </label>
            <input
              type="text"
              id="studentName"
              placeholder="e.g., Alex Johnson"
              style="width: 100%; padding: 12px 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box; transition: border-color 0.2s;"
              onfocus="this.style.borderColor='#F22F46'"
              onblur="this.style.borderColor='#ddd'"
            />
            <p style="color: #999; font-size: 0.85rem; margin-top: 6px; text-align: left;">
              Optional: Helps instructors track your progress during the workshop
            </p>
          </div>
          <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
            <button onclick="saveStudentNameAndStart(false)" style="flex: 1; min-width: 220px; max-width: 280px; padding: 18px 30px; background: linear-gradient(135deg, #F22F46 0%, #ff6b6b 100%); color: white; border: none; border-radius: 8px; font-weight: 600; font-size: 1.1rem; cursor: pointer; transition: transform 0.2s;">
              Login with My Accounts
            </button>
            <button onclick="saveStudentNameAndStart(true)" style="flex: 1; min-width: 220px; max-width: 280px; padding: 18px 30px; background: white; color: #666; border: 2px solid #ddd; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1.05rem;">
              Run in Demo Mode
            </button>
          </div>
          <p style="color: #999; margin-top: 20px; font-size: 0.85rem; line-height: 1.5;">
            <strong>Demo Mode:</strong> Explore the workshop interface without connecting accounts. You won't be able to test with real APIs.
          </p>
        </div>
      `;

      document.body.appendChild(modal);
    }

    function saveStudentNameAndStart(isDemoMode) {
      const nameInput = document.getElementById('studentName');
      const name = nameInput ? nameInput.value.trim() : '';

      if (name) {
        studentName = name;
        localStorage.setItem('studentName', name);
      }

      studentDemoMode = isDemoMode;
      localStorage.setItem('studentDemoMode', isDemoMode ? 'true' : 'false');

      // In demo mode, auto-connect all accounts with demo credentials
      if (isDemoMode) {
        twilioConnected = true;
        openaiConnected = true;
        githubToken = 'demo_token';
        githubUsername = 'demo_user';
        twilioCredentials = {
          accountSid: 'DEMO_ACCOUNT_SID',
          authToken: 'demo_auth_token'
        };
        openaiApiKey = 'demo_openai_key';
      }

      document.getElementById('setupModal').remove();
      renderStepContent();

      // Update demo mode banner visibility
      updateDemoModeBanner();

      // Show personalized welcome message
      const welcomeMsg = studentName
        ? `üëã Welcome, ${studentName}! ${isDemoMode ? 'Running in demo mode.' : "Let's build an AI voice agent together."}`
        : `üëã Welcome! ${isDemoMode ? 'Running in demo mode - explore the workshop interface.' : "Let's build an AI voice agent together."}`;

      setTimeout(() => {
        celebrate(welcomeMsg, 'normal');
      }, 300);
    }

    function showResumeModal(progress) {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        animation: fadeIn 0.3s;
      `;

      modal.innerHTML = `
        <div style="background: white; border-radius: 16px; padding: 40px; max-width: 500px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);">
          <h2 style="color: #0d122b; margin-bottom: 20px;">üëã Welcome Back!</h2>
          <p style="color: #666; margin-bottom: 20px; line-height: 1.6;">
            We found your saved progress from ${new Date(progress.timestamp).toLocaleDateString()}.
          </p>
          <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
            <strong style="color: #0d122b; display: block; margin-bottom: 10px;">Your Progress:</strong>
            <ul style="margin-left: 20px; color: #666; line-height: 1.8;">
              <li>Current Step: <strong>${progress.currentStep + 1} of ${steps.length}</strong> - ${steps[progress.currentStep].title}</li>
              <li>Completed: ${progress.completedSteps.join(', ') || 'Just getting started'}</li>
              ${progress.selectedPhoneNumber ? `<li>Phone: ${progress.selectedPhoneNumber}</li>` : ''}
            </ul>
          </div>
          <div style="display: flex; gap: 10px;">
            <button onclick="resumeProgress()" style="flex: 1; padding: 15px; background: linear-gradient(135deg, #F22F46 0%, #ff6b6b 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem;">
              Resume ‚Üí
            </button>
            <button onclick="startFresh()" style="flex: 1; padding: 15px; background: white; color: #F22F46; border: 2px solid #F22F46; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem;">
              Start Fresh
            </button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
      window.resumeModal = modal;
      window.savedProgress = progress;
    }

    function resumeProgress() {
      const progress = window.savedProgress;

      // Restore all state
      currentStep = progress.currentStep || 0;
      twilioConnected = progress.twilioConnected || false;
      openaiConnected = progress.openaiConnected || false;
      callDirectionChosen = progress.callDirectionChosen || false;
      callDirection = progress.callDirection || '';
      servicesReady = progress.servicesReady || false;
      basicTwimlCreated = progress.basicTwimlCreated || false;
      functionsDeployed = progress.functionsDeployed || false;
      basicCallTested = progress.basicCallTested || false;
      websocketBuilt = progress.websocketBuilt || false;
      conversationRelayCreated = progress.conversationRelayCreated || false;
      aiCallTested = progress.aiCallTested || false;
      twilioCredentials = progress.twilioCredentials || null;
      openaiApiKey = progress.openaiApiKey || null;
      selectedPhoneNumber = progress.selectedPhoneNumber || null;
      websocketUrl = progress.websocketUrl || '';
      syncServiceSkipped = progress.syncServiceSkipped || false;
      deployedServiceSid = progress.deployedServiceSid || null;
      ttsProvider = progress.ttsProvider || 'amazon-polly';
      conversationRelayVoice = progress.conversationRelayVoice || null;
      step4Committed = progress.step4Committed || false;
      step4Deployed = progress.step4Deployed || false;
      step5Committed = progress.step5Committed || false;
      step5Deployed = progress.step5Deployed || false;
      step6Committed = progress.step6Committed || false;
      step6Deployed = progress.step6Deployed || false;
      step8Committed = progress.step8Committed || false;
      deployedEnvironmentSid = progress.deployedEnvironmentSid || null;
      deployedBuildSid = progress.deployedBuildSid || null;

      // Close modal
      if (window.resumeModal) {
        window.resumeModal.remove();
      }

      // Re-render
      renderProgressSteps();
      renderStepContent();

      // Re-enable buttons based on restored state
      restoreButtonStates();

      celebrate('‚úÖ Progress restored! Continue where you left off.', 'light');
    }

    function restoreButtonStates() {
      // Step 1: Enable next button if Twilio is connected
      if (twilioConnected) {
        const nextBtn1 = document.getElementById('nextBtn1');
        if (nextBtn1) {
          nextBtn1.disabled = false;
          showStatus('step1Status', 'success', 'üéâ Twilio connected! Click Next to continue.');
        }
      }

      // Step 2: Enable next button if call direction is chosen
      if (callDirectionChosen) {
        const nextBtn2 = document.getElementById('nextBtn2');
        if (nextBtn2) {
          nextBtn2.disabled = false;
          const directionText = callDirection === 'outbound' ? 'outbound calls (you call them)' : 'inbound calls (they call you)';
          showStatus('step2Status', 'success', `‚úÖ Great! You'll build a bot for ${directionText}.`);
        }
      }

      // Step 3: Enable next button if services are ready
      if (servicesReady) {
        const nextBtn3 = document.getElementById('nextBtn3');
        if (nextBtn3) {
          nextBtn3.disabled = false;
          showStatus('step3Status', 'success', '‚úÖ Services provisioned! Click Next to continue.');
        }
      }

      // Step 4: Enable next button if basic TwiML is created
      if (basicTwimlCreated) {
        const nextBtn4 = document.getElementById('nextBtn4');
        if (nextBtn4) nextBtn4.disabled = false;
      }

      // Step 6: Enable next button if WebSocket is built
      if (websocketBuilt) {
        const nextBtn6 = document.getElementById('nextBtn6');
        if (nextBtn6) nextBtn6.disabled = false;
      }

      // Step 8: Enable next button if ConversationRelay is created
      if (conversationRelayCreated) {
        const nextBtn8 = document.getElementById('nextBtn8');
        if (nextBtn8) nextBtn8.disabled = false;
      }
    }

    function startFresh() {
      localStorage.removeItem('workshop_progress');
      if (window.resumeModal) {
        window.resumeModal.remove();
      }
      alert('üîÑ Starting fresh! Your old progress has been cleared.');
    }

    // =========================================================================
    // CELEBRATIONS
    // =========================================================================

    function celebrate(message, intensity = 'normal') {
      const configs = {
        light: { particleCount: 50, spread: 50 },
        normal: { particleCount: 100, spread: 70 },
        epic: { particleCount: 200, spread: 90, startVelocity: 45 }
      };

      const config = configs[intensity] || configs.normal;

      confetti({
        ...config,
        origin: { y: 0.6 },
        colors: ['#F22F46', '#ff6b6b', '#667eea', '#764ba2', '#ffc107']
      });

      // Show toast
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #F22F46 0%, #ff6b6b 100%);
        color: white;
        padding: 20px 30px;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        z-index: 9999;
        font-weight: 600;
        font-size: 1.1rem;
        animation: slideIn 0.5s ease-out;
      `;
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.animation = 'slideOut 0.5s ease-in';
        setTimeout(() => toast.remove(), 500);
      }, 3000);
    }

    function showSDKVersionNotice() {
      // Check if we've already shown this notice in this session
      if (sessionStorage.getItem('sdkNoticeShown')) {
        return;
      }

      // Show helpful banner about SDK version
      const banner = document.createElement('div');
      banner.id = 'sdkVersionBanner';
      banner.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px 30px;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        z-index: 9999;
        max-width: 600px;
        animation: slideIn 0.5s ease-out;
      `;
      banner.innerHTML = `
        <div style="display: flex; align-items: start; gap: 15px;">
          <div style="font-size: 24px;">üì¶</div>
          <div style="flex: 1;">
            <div style="font-weight: 600; font-size: 1.1rem; margin-bottom: 8px;">
              Step 6 Deployed Successfully!
            </div>
            <div style="font-size: 0.9rem; line-height: 1.5;">
              Your ConversationRelay handler is now deployed with <strong>Twilio SDK 5.6.0</strong>.<br>
              If you experience any issues testing, click the <strong>Reset</strong> button above and redeploy Step 6.
            </div>
          </div>
          <button onclick="document.getElementById('sdkVersionBanner').remove(); sessionStorage.setItem('sdkNoticeShown', 'true');"
                  style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 10px; border-radius: 6px; cursor: pointer; font-size: 18px;">
            ‚úï
          </button>
        </div>
      `;
      document.body.appendChild(banner);

      // Auto-dismiss after 10 seconds
      setTimeout(() => {
        if (document.getElementById('sdkVersionBanner')) {
          banner.style.animation = 'slideOut 0.5s ease-in';
          setTimeout(() => {
            banner.remove();
            sessionStorage.setItem('sdkNoticeShown', 'true');
          }, 500);
        }
      }, 10000);
    }

    // =========================================================================
    // TOOLTIPS
    // =========================================================================

    const tooltips = {
      'conversationrelay': {
        title: 'ConversationRelay',
        content: 'Twilio\'s WebSocket-based API for bidirectional voice streaming. It allows real-time audio exchange between calls and your application.',
        link: 'https://www.twilio.com/docs/voice/api/conversation-relay'
      },
      'sync': {
        title: 'Twilio Sync',
        content: 'Real-time data synchronization service. We use it to securely store OAuth sessions server-side with auto-expiration.',
        link: 'https://www.twilio.com/docs/sync'
      },
      'serverless': {
        title: 'Twilio Serverless',
        content: 'Zero-configuration hosting for Functions and Assets. Deploy your code without managing servers, scaling automatically.',
        link: 'https://www.twilio.com/docs/serverless'
      },
      'twiml': {
        title: 'TwiML',
        content: 'Twilio Markup Language - XML instructions that tell Twilio how to handle calls and messages. Simple, declarative voice programming.',
        link: 'https://www.twilio.com/docs/voice/twiml'
      },
      'websocket': {
        title: 'WebSockets',
        content: 'Protocol for real-time bidirectional communication over a single TCP connection. Enables instant audio streaming.',
        link: 'https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API'
      }
    };

    function createTooltip(term, text = null) {
      const data = tooltips[term.toLowerCase()];
      if (!data) return text || term;

      return `<span class="tooltip-trigger">${text || term}
        <span class="tooltip-content">
          <h4>${data.title}</h4>
          <p>${data.content}</p>
          <a href="${data.link}" target="_blank">Learn More ‚Üí</a>
        </span>
      </span>`;
    }

    // =========================================================================
    // LANGUAGE TOGGLE
    // =========================================================================

    function switchLanguage(lang) {
      currentLanguage = lang;

      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.remove('active');
      });

      const langBtn = document.getElementById(`btn-${lang}`);
      if (langBtn) {
        langBtn.classList.add('active');
      }

      localStorage.setItem('preferredLanguage', lang);
      console.log(`Language switched to: ${lang}`);
    }

    // Initialize
    function init() {
      // Check if coming from setup wizard
      const setupComplete = localStorage.getItem('workshop_setup_complete');
      const savedProgress = loadProgressFromStorage();
      const hasWorkshopCredentials = localStorage.getItem('workshopCredentials');

      if (setupComplete) {
        const setupData = JSON.parse(setupComplete);

        // Auto-populate credentials from setup wizard
        if (setupData.credentials) {
          twilioCredentials = setupData.credentials;
          twilioConnected = true;
          selectedPhoneNumber = setupData.phoneNumber;

          // Show success message
          const setupMessage = studentName
            ? `‚úÖ Welcome back, ${studentName}! Your credentials are loaded.`
            : '‚úÖ Setup complete! Your credentials are loaded.';
          celebrate(setupMessage, 'normal');
        }

        // Clear the setup flag (one-time use)
        localStorage.removeItem('workshop_setup_complete');
      }

      // Check for saved progress
      if (savedProgress && !setupComplete) {
        // Only show resume modal if NOT coming from setup wizard
        showResumeModal(savedProgress);
      }

      // Always render content first
      renderProgressSteps();
      renderStepContent();

      // Restore button states based on current progress
      // This is needed whether coming from setup wizard or not
      setTimeout(() => restoreButtonStates(), 100);

      // Apply language preference
      switchLanguage(currentLanguage);

      // Update demo mode banner if in demo mode
      updateDemoModeBanner();

      // Show setup modal AFTER rendering content (so page isn't blank)
      // If user hasn't completed setup and has no saved progress, show setup modal
      if (!setupComplete && !savedProgress && !hasWorkshopCredentials) {
        setTimeout(() => showSetupRequiredModal(), 100);
      }
    }

    // Render progress indicator
    function renderProgressSteps() {
      const container = document.getElementById('progressSteps');
      container.innerHTML = steps.map((step, index) => `
        <div class="step-item ${index === currentStep ? 'active' : ''} ${index < currentStep ? 'completed' : ''}">
          <div class="step-number">${index < currentStep ? '' : step.id}</div>
          <div class="step-title">${step.title}</div>
        </div>
      `).join('');
    }

    // Render step content
    function renderStepContent() {
      const container = document.getElementById('mainContent');

      switch(currentStep) {
        case 0:
          container.innerHTML = renderStep1_Setup();
          break;
        case 1:
          container.innerHTML = renderStep2_Direction();
          break;
        case 2:
          container.innerHTML = renderStep3_Services();
          loadServices();
          break;
        case 3:
          container.innerHTML = renderStep4_BasicTwiML();
          break;
        case 4:
          container.innerHTML = renderStep6_WebSocket();
          break;
        case 5:
          container.innerHTML = renderStep9_ConversationRelay();
          // Initialize dropdowns after rendering
          setTimeout(() => {
            const ttsSelect = document.getElementById('ttsProvider');
            const voiceSelect = document.getElementById('conversationRelayVoice');
            if (ttsSelect) ttsSelect.value = ttsProvider;
            if (voiceSelect && conversationRelayVoice) voiceSelect.value = conversationRelayVoice;

            // Auto-update code with preset settings
            updateConversationRelayCode();
          }, 0);
          break;
        case 6:
          container.innerHTML = renderStep7_PromptEngineering();
          break;
        case 7:
          container.innerHTML = renderStep8_Tooling();
          break;
        case 8:
          container.innerHTML = renderStep9_Deploy();
          break;
      }
    }

    // =========================================================================
    // STEP 1: SETUP - Connect Accounts
    // =========================================================================

    function renderStep1_Setup() {
      return `
        <div class="step-content active">
          <div class="step-header">
            <h2>Step 1: Connect Your Accounts</h2>
            <p>Let's connect your Twilio and OpenAI accounts to get started</p>
          </div>

          <!-- GitHub Repository Clone -->
          <div class="service-card" style="background: linear-gradient(135deg, #24292e 0%, #0d1117 100%); color: white; margin-bottom: 30px;">
            <h4 style="color: white; margin-bottom: 15px;">üêô Step 1a: Clone Workshop Repository</h4>
            <p style="color: rgba(255,255,255,0.9); margin-bottom: 15px; line-height: 1.6;">
              Before we start, you need your own copy of the workshop repository. This will contain:
            </p>
            <ul style="color: rgba(255,255,255,0.85); margin: 0 0 20px 20px; line-height: 1.8;">
              <li><strong>WebSocket Handler</strong> - Node.js server for real-time AI conversations</li>
              <li><strong>Voice Handler</strong> - TwiML responder for incoming calls</li>
              <li><strong>Package Files</strong> - Dependencies and deployment configuration</li>
              <li><strong>README</strong> - Deployment instructions for Railway/Render/Heroku</li>
            </ul>

            <div id="githubCloneStatus" style="margin-bottom: 15px;"></div>

            ${studentDemoMode ? `
              <div style="background: rgba(76, 175, 80, 0.2); padding: 20px; border-radius: 8px; border: 1px solid rgba(76, 175, 80, 0.5);">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                  <span style="font-size: 1.5rem;">‚úÖ</span>
                  <div>
                    <strong style="color: #4caf50; font-size: 1.05rem;">Repository Cloned (Demo)</strong><br>
                    <span style="color: rgba(255,255,255,0.8); font-size: 13px;">demo-user/twilio-voice-ai-workshop-demo</span>
                  </div>
                </div>
                <p style="color: rgba(255,255,255,0.85); margin: 0; font-size: 13px;">
                  üìù In demo mode, repository operations are simulated. Exit demo mode to clone to your real GitHub account.
                </p>
              </div>
            ` : githubToken && githubUsername && githubUsername !== 'demo_user' ? `
              <div style="background: rgba(76, 175, 80, 0.2); padding: 20px; border-radius: 8px; border: 1px solid rgba(76, 175, 80, 0.5);">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                  <span style="font-size: 1.5rem;">‚úÖ</span>
                  <div>
                    <strong style="color: #4caf50; font-size: 1.05rem;">Repository Cloned</strong><br>
                    <span style="color: rgba(255,255,255,0.8); font-size: 13px;">${githubUsername}/twilio-voice-ai-workshop</span>
                  </div>
                </div>
              </div>
            ` : `
              <button class="btn btn-primary" onclick="initiateGitHubOAuth()" style="width: 100%; padding: 15px; font-size: 16px; background: white; color: #24292e; border: none;">
                <strong>üîê Login with GitHub</strong>
              </button>
              <p style="color: rgba(255,255,255,0.7); font-size: 13px; margin-top: 10px; text-align: center;">
                Required to clone the repository to your account
              </p>
            `}
          </div>

          <div class="instructions">
            <h3>üìã What You'll Need</h3>
            <ul>
              <li><strong>Twilio Account SID & Auth Token</strong> - Get from <a href="https://console.twilio.com" target="_blank">Twilio Console</a></li>
              <li><strong>OpenAI API Key</strong> - You'll configure this later in Step 6</li>
            </ul>
            <p style="margin-top: 15px;">
              üìö <strong>Documentation:</strong>
              <a href="https://www.twilio.com/docs/voice/api" target="_blank">Twilio Voice API</a> |
              <a href="https://www.twilio.com/docs/iam/api-keys" target="_blank">API Authentication</a>
            </p>
          </div>

          <!-- Twilio Credentials -->
          <div class="service-card">
            <h4>üî¥ Twilio Account</h4>

            ${twilioConnected ? `
              <div style="background: #d4edda; padding: 20px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #c3e6cb;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                  <span style="font-size: 1.5rem;">‚úÖ</span>
                  <div>
                    <strong style="color: #155724; font-size: 1.05rem;">Logged into Twilio Account${studentDemoMode ? ' (Demo)' : ''}</strong><br>
                    <span style="color: #155724; font-size: 13px;">${studentDemoMode ? 'Demo Workshop Account' : (twilioCredentials?.accountName || twilioCredentials?.accountSid || 'Your Account')}</span>
                  </div>
                </div>
                ${studentDemoMode ? `
                  <p style="color: #155724; margin: 0; font-size: 13px;">
                    üìù Running in demo mode - API calls are simulated for exploration.
                  </p>
                ` : ''}
              </div>
            ` : `
              <!-- Auth Method Selection -->
              <div class="form-group">
                <label>Authentication Method</label>
                <select id="authMethod" onchange="toggleAuthMethod()" style="width: 100%; padding: 10px;">
                  <option value="apikey">üîë API Key (Recommended - Most Secure)</option>
                  <option value="token">Account SID + Auth Token</option>
                  <option value="demo">Demo Mode (No credentials needed)</option>
                </select>
              </div>
            `}

            ${!twilioConnected ? `
              <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #ffc107;">
                <strong>üí° Why API Keys?</strong>
                <ul style="margin: 10px 0 0 20px; font-size: 14px;">
                  <li>Can be deleted after the workshop</li>
                  <li>More secure than Auth Tokens</li>
                  <li>Your credentials are only used to create a session</li>
                  <li>Takes 30 seconds to set up</li>
                </ul>
              </div>

            <!-- Self-Hosted Auth -->
            <div id="selfhostedAuth">
              <div style="background: #d4edda; padding: 20px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #c3e6cb;">
                <h5 style="margin: 0 0 10px 0; color: #155724;">üè† Self-Hosted Mode</h5>
                <p style="margin: 0 0 10px 0; color: #155724; font-size: 14px;">
                  You deployed this tutorial to YOUR Twilio account. No credentials needed!
                </p>
                <p style="margin: 0; color: #666; font-size: 13px;">
                  <strong>How it works:</strong> Since you deployed this via <code>twilio serverless:deploy</code>,
                  all API calls automatically use your account. Your credentials never leave Twilio's servers.
                </p>
              </div>
              <button class="btn btn-primary" onclick="connectSelfHosted()" style="width: 100%; padding: 15px; font-size: 16px;">
                ‚úÖ Verify Connection
              </button>
              <div id="selfHostedStatus" style="margin-top: 15px; display: none;">
                <div style="background: #d4edda; padding: 15px; border-radius: 8px; border: 1px solid #c3e6cb;">
                  <div>
                    <div style="color: #155724; font-weight: bold;">‚úÖ Connected to Your Account:</div>
                    <div id="selfHostedAccountName" style="color: #155724; margin-top: 5px;"></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Token Auth -->
            <div id="tokenAuth" style="display: none;">
              <div class="form-group">
                <label>Account SID</label>
                <input type="text" id="twilioAccountSid" placeholder="ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" />
              </div>
              <div class="form-group">
                <label>Auth Token</label>
                <input type="password" id="twilioAuthToken" placeholder="********************************" />
              </div>
              <button class="btn btn-primary" onclick="connectTwilio()">Connect Twilio</button>
            </div>

            <!-- API Key Auth -->
            <div id="apiKeyAuth">
              <div style="background: #e7f5ff; padding: 20px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #0066cc;">
                <h5 style="margin: 0 0 10px 0; color: #0066cc;">üìù Quick Setup (30 seconds)</h5>
                <ol style="margin: 0; padding-left: 20px; color: #555; font-size: 14px; line-height: 1.8;">
                  <li>Go to <a href="https://console.twilio.com/us1/develop/api-keys/create?friendlyName=Voice AI Workshop" target="_blank" style="color: #0066cc; text-decoration: none; font-weight: bold;">Create API Key</a> (opens in new tab)</li>
                  <li>Click <strong>"Create API Key"</strong></li>
                  <li>Copy the <strong>SID</strong> and <strong>Secret</strong> and paste below ‚¨áÔ∏è</li>
                </ol>
                <p style="margin: 10px 0 0 0; color: #666; font-size: 13px;">
                  üí° <strong>Tip:</strong> Delete this API Key after the workshop at <a href="https://console.twilio.com/us1/account/keys-credentials/api-keys" target="_blank">console.twilio.com/keys</a>
                </p>
              </div>

              <div class="form-group">
                <label>Account SID</label>
                <input type="text" id="twilioAccountSidKey" placeholder="ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" />
                <small style="display: block; margin-top: 5px; color: #666;">
                  Find at: <a href="https://console.twilio.com" target="_blank">console.twilio.com</a> (top of page)
                </small>
              </div>
              <div class="form-group">
                <label>API Key SID</label>
                <input type="text" id="twilioApiKeySid" placeholder="SKxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" />
                <small style="display: block; margin-top: 5px; color: #666;">
                  From step 2 above (starts with "SK")
                </small>
              </div>
              <div class="form-group">
                <label>API Key Secret</label>
                <input type="password" id="twilioApiKeySecret" placeholder="********************************" />
                <small style="display: block; margin-top: 5px; color: #666;">
                  ‚ö†Ô∏è Only shown once after creation - copy it now!
                </small>
              </div>
              <button class="btn btn-primary" onclick="connectTwilioWithApiKey()" style="width: 100%; padding: 12px; font-size: 16px;">
                üîê Connect Securely
              </button>
              <div style="background: #d4edda; padding: 10px; border-radius: 4px; margin-top: 10px; font-size: 13px; color: #155724;">
                üîí <strong>Your credentials are secure:</strong> They're only used once to create a session token, never stored
              </div>
            </div>

            <!-- Demo Mode -->
            <div id="demoAuth" style="display: none;">
              <div style="background: #fff3cd; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                <strong>üìù Demo Mode</strong>
                <p style="margin: 10px 0 0 0; font-size: 13px;">
                  Explore the workshop with simulated data. You won't be able to make real calls,
                  but you can see how everything works and export your code.
                </p>
              </div>
              <button class="btn btn-primary" onclick="connectDemoMode()">Start Demo Mode</button>
            </div>

            <div id="twilioStatus" class="connection-status" style="display: none; margin-top: 10px;"></div>
            ` : ''}
          </div>

          <div id="step1Status" class="status-box"></div>

          <div class="button-group">
            <button class="btn btn-primary" id="nextBtn1" onclick="nextStep()" ${twilioConnected ? '' : 'disabled'}>
              Next: Select Use Case ‚Üí
            </button>
          </div>
        </div>
      `;
    }

    function toggleAuthMethod() {
      const method = document.getElementById('authMethod').value;

      document.getElementById('selfhostedAuth').style.display = method === 'selfhosted' ? 'block' : 'none';
      document.getElementById('tokenAuth').style.display = method === 'token' ? 'block' : 'none';
      document.getElementById('apiKeyAuth').style.display = method === 'apikey' ? 'block' : 'none';
      document.getElementById('demoAuth').style.display = method === 'demo' ? 'block' : 'none';
    }

    // Self-Hosted Authentication (No credentials needed!)
    async function connectSelfHosted() {
      try {
        showStatus('step1Status', 'info', 'Verifying connection to your account...');

        // Call the self-hosted proxy (uses context.getTwilioClient())
        const response = await fetch('/tutorial-proxy-selfhosted', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'getAccountInfo'
          })
        });

        const data = await response.json();

        if (data.success) {
          // Show success status
          document.getElementById('selfHostedStatus').style.display = 'block';
          document.getElementById('selfHostedAccountName').textContent =
            data.account.friendlyName || data.account.sid;

          // Mark as connected
          twilioConnected = true;
          twilioCredentials = {
            accountSid: data.account.sid,
            friendlyName: data.account.friendlyName,
            selfHosted: true
          };

          showStatus('step1Status', 'success', '‚úÖ Connected to your Twilio account!');
          checkStep1Complete();

        } else {
          showStatus('step1Status', 'error', 'Failed to connect: ' + (data.error || 'Unknown error'));
        }

      } catch (error) {
        console.error('Connection error:', error);
        showStatus('step1Status', 'error',
          'Failed to connect. Make sure you deployed this tutorial to your Twilio account via: twilio serverless:deploy'
        );
      }
    }

    async function connectTwilio() {
      const accountSid = document.getElementById('twilioAccountSid').value.trim();
      const authToken = document.getElementById('twilioAuthToken').value.trim();
      const status = document.getElementById('twilioStatus');

      if (!accountSid || !authToken) {
        showStatus('step1Status', 'error', 'Please enter both Account SID and Auth Token');
        return;
      }

      if (!accountSid.startsWith('AC')) {
        showStatus('step1Status', 'error', 'Account SID must start with "AC"');
        return;
      }

      status.innerHTML = 'Connecting...';
      status.style.display = 'inline-flex';

      try {
        const response = await fetch('/api/tutorial-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'validateCredentials',
            accountSid,
            authToken
          })
        });

        const data = await response.json();

        if (data.success) {
          twilioCredentials = { accountSid, authToken };
          twilioConnected = true;

          status.innerHTML = `<span class="live-indicator"></span> Connected: ${data.account.friendlyName}`;
          status.style.background = '#d4edda';
          status.style.color = '#155724';

          showStatus('step1Status', 'success', '‚úÖ Twilio account connected successfully!');
          checkStep1Complete();
        } else {
          throw new Error(data.error);
        }
      } catch (error) {
        status.innerHTML = '‚ùå Connection failed';
        status.style.background = '#f8d7da';
        status.style.color = '#721c24';

        let errorMsg = error.message;
        if (errorMsg.includes('authenticate')) {
          errorMsg += '<br><br>üí° <strong>Try these solutions:</strong><br>' +
                      '‚Ä¢ Double-check your Account SID and Auth Token<br>' +
                      '‚Ä¢ Copy credentials directly from <a href="https://console.twilio.com" target="_blank">Twilio Console</a><br>' +
                      '‚Ä¢ Try using API Key instead (select from dropdown)<br>' +
                      '‚Ä¢ Use Demo Mode to explore without credentials';
        }

        showStatus('step1Status', 'error', 'Failed to connect: ' + errorMsg);
      }
    }

    async function connectTwilioWithApiKey() {
      const accountSid = document.getElementById('twilioAccountSidKey').value.trim();
      const apiKeySid = document.getElementById('twilioApiKeySid').value.trim();
      const apiKeySecret = document.getElementById('twilioApiKeySecret').value.trim();
      const status = document.getElementById('twilioStatus');

      if (!accountSid || !apiKeySid || !apiKeySecret) {
        showStatus('step1Status', 'error', 'Please enter Account SID, API Key SID, and API Key Secret');
        return;
      }

      if (!accountSid.startsWith('AC')) {
        showStatus('step1Status', 'error', 'Account SID must start with "AC"');
        return;
      }

      if (!apiKeySid.startsWith('SK')) {
        showStatus('step1Status', 'error', 'API Key SID must start with "SK"');
        return;
      }

      status.innerHTML = 'Connecting with API Key...';
      status.style.display = 'inline-flex';

      try {
        const response = await fetch('/api/tutorial-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'validateCredentials',
            accountSid,
            authToken: apiKeySecret,  // API Key Secret used as auth token
            apiKey: apiKeySid
          })
        });

        const data = await response.json();

        if (data.success) {
          twilioCredentials = { accountSid, authToken: apiKeySecret, apiKey: apiKeySid };
          twilioConnected = true;

          status.innerHTML = `<span class="live-indicator"></span> Connected with API Key: ${data.account.friendlyName}`;
          status.style.background = '#d4edda';
          status.style.color = '#155724';

          showStatus('step1Status', 'success', '‚úÖ Twilio account connected with API Key (more secure)!');
          checkStep1Complete();
        } else {
          throw new Error(data.error);
        }
      } catch (error) {
        status.innerHTML = '‚ùå Connection failed';
        status.style.background = '#f8d7da';
        status.style.color = '#721c24';
        showStatus('step1Status', 'error', 'Failed to connect: ' + error.message + '<br><br>Make sure your API Key is active and has the correct permissions.');
      }
    }

    function connectDemoMode() {
      const status = document.getElementById('twilioStatus');

      status.innerHTML = '<span class="live-indicator"></span> Demo Mode Active';
      status.style.background = '#fff3cd';
      status.style.color = '#856404';
      status.style.display = 'inline-flex';

      // Set demo credentials
      twilioCredentials = {
        accountSid: 'ACdemo123456789012345678901234567890',
        authToken: 'demo_token',
        demoMode: true
      };
      twilioConnected = true;

      // Show demo mode banner
      updateDemoModeBanner();

      showStatus('step1Status', 'success', '‚úÖ Demo Mode activated! You can explore the workshop with simulated data.');
      checkStep1Complete();
    }

    async function connectOpenAI() {
      const apiKeyInput = document.getElementById('openaiKey');
      let apiKey = apiKeyInput.value.trim();
      const status = document.getElementById('openaiStatus');

      // Check if in demo mode - auto-set demo API key
      if (twilioCredentials?.demoMode) {
        apiKey = 'sk-demo-1234567890abcdefghijklmnopqrstuvwxyz1234567890';
        apiKeyInput.value = apiKey;

        status.innerHTML = '<span class="live-indicator"></span> Demo Mode Active';
        status.style.display = 'inline-flex';
        status.style.background = '#fff3cd';
        status.style.color = '#856404';

        openaiApiKey = apiKey;
        openaiConnected = true;

        showStatus('step1Status', 'success', '‚úÖ OpenAI Demo Mode activated! API calls will be simulated.');
        saveProgressToStorage();
        return;
      }

      if (!apiKey) {
        showStatus('step1Status', 'error', 'Please enter your OpenAI API key');
        return;
      }

      // Simple format validation - check if it starts with 'sk-' or 'sk-proj-'
      if (!apiKey.startsWith('sk-')) {
        showStatus('step1Status', 'error', 'Invalid OpenAI API key format. Key should start with "sk-"');
        status.innerHTML = `‚ùå Invalid format`;
        status.style.display = 'inline-flex';
        status.style.background = '#f8d7da';
        status.style.color = '#721c24';
        return;
      }

      // Check minimum length (OpenAI keys are typically 48+ characters)
      if (apiKey.length < 40) {
        showStatus('step1Status', 'error', 'OpenAI API key appears too short. Please check your key.');
        status.innerHTML = `‚ùå Key too short`;
        status.style.display = 'inline-flex';
        status.style.background = '#f8d7da';
        status.style.color = '#721c24';
        return;
      }

      // Format looks valid - accept it without API call
      status.innerHTML = 'Validating format...';
      status.style.display = 'inline-flex';
      status.style.background = '#d1ecf1';
      status.style.color = '#0c5460';

      // Simulate a brief validation delay for UX
      await new Promise(resolve => setTimeout(resolve, 500));

      // Store API key after format validation
      openaiApiKey = apiKey;
      openaiConnected = true;

      status.innerHTML = '<span class="live-indicator"></span> Connected';
      status.style.background = '#d4edda';
      status.style.color = '#155724';

      showStatus('step1Status', 'success', '‚úÖ OpenAI API key format validated! (Will be tested when you make your first AI call)');

      // Hide prerequisites warning if shown
      const prereqDiv = document.getElementById('step5Prerequisites');
      if (prereqDiv) prereqDiv.style.display = 'none';

      checkStep1Complete();
      saveProgressToStorage();
    }

    function saveTTSProvider() {
      const provider = document.getElementById('ttsProvider').value;
      ttsProvider = provider;

      // Update provider info display
      const icon = document.getElementById('ttsProviderIcon');
      const name = document.getElementById('ttsProviderName');
      const description = document.getElementById('ttsProviderDescription');
      const note = document.getElementById('ttsProviderNote');

      if (provider === 'amazon-polly') {
        icon.textContent = 'üîä';
        name.textContent = 'Amazon Polly';
        description.textContent = 'Included with Twilio at no additional cost. Provides high-quality, natural-sounding voices in multiple languages.';
        note.innerHTML = '‚úÖ No additional configuration needed';
        note.style.color = '#98c379';
      } else if (provider === 'elevenlabs') {
        icon.textContent = 'üéµ';
        name.textContent = 'ElevenLabs';
        description.textContent = 'Premium AI voices with exceptional naturalness, emotion, and clarity. Perfect for professional applications requiring the highest quality speech synthesis.';
        note.innerHTML = '‚úÖ No API key needed - Twilio manages the integration';
        note.style.color = '#98c379';
      } else if (provider === 'google') {
        icon.textContent = '‚òÅÔ∏è';
        name.textContent = 'Google Cloud Text-to-Speech';
        description.textContent = 'Google\'s neural TTS with WaveNet voices. Requires Google Cloud credentials configured in Twilio Console.';
        note.innerHTML = '‚ö†Ô∏è Requires additional setup in Twilio Console - <a href="https://www.twilio.com/docs/voice/twiml/connect/conversationrelay#google-cloud-text-to-speech" target="_blank" style="color: #4fc1ff;">View Docs</a>';
        note.style.color = '#e5c07b';
      }

      // Update the voice selector with new options for this provider
      const voiceSelect = document.getElementById('conversationRelayVoice');
      if (voiceSelect) {
        voiceSelect.innerHTML = getVoiceOptions();
        // Reset selected voice to default for new provider
        conversationRelayVoice = null;
      }

      saveProgressToStorage();
    }

    function saveConversationRelayVoice() {
      const voiceSelect = document.getElementById('conversationRelayVoice');
      if (voiceSelect) {
        conversationRelayVoice = voiceSelect.value;
        saveProgressToStorage();
      }
    }

    function checkStep1Complete() {
      if (twilioConnected) {
        document.getElementById('nextBtn1').disabled = false;
        showStatus('step1Status', 'success', 'üéâ Twilio connected! Click Next to continue.');
      }
    }

    // =========================================================================
    // STEP 2: DIRECTION - Choose Call Direction
    // =========================================================================

    function renderStep2_Direction() {
      return `
        <div class="step-content active">
          <div class="step-header">
            <h2>Step 2: Choose Your Call Direction</h2>
            <p>Will you be making outbound calls or receiving inbound calls?</p>
          </div>

          <div class="instructions">
            <h3>üìã Choose Your Path</h3>
            <p>Select how you want to use your Voice AI bot. We'll start simple, then add AI capabilities!</p>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 30px 0;">
            <!-- Outbound Calls -->
            <div class="service-card" onclick="selectCallDirection('outbound')" style="cursor: pointer; border: 3px solid transparent; transition: all 0.3s;" id="outboundCard">
              <div style="text-align: center; margin-bottom: 15px;">
                <div style="font-size: 64px;">üìû</div>
                <h3 style="margin: 10px 0; color: #0d122b;">Outbound Calls</h3>
              </div>
              <p style="margin-bottom: 15px; line-height: 1.6;">
                <strong>You initiate the call</strong> - Perfect for:
              </p>
              <ul style="margin: 0 0 15px 20px; line-height: 1.8; font-size: 14px;">
                <li>Recruiting candidate outreach</li>
                <li>Customer follow-ups</li>
                <li>Survey campaigns</li>
                <li>Appointment reminders</li>
              </ul>
              <div style="background: #e7f5ff; padding: 10px; border-radius: 4px; margin-top: 15px; font-size: 13px; line-height: 1.6;">
                <strong>Phase 1:</strong> <code>&lt;Say&gt;</code>, <code>&lt;Gather&gt;</code>, <code>&lt;Dial&gt;</code><br>
                <strong>Phase 2:</strong> ConversationRelay + STT + TTS + AI
              </div>
            </div>

            <!-- Inbound Calls -->
            <div class="service-card" onclick="selectCallDirection('inbound')" style="cursor: pointer; border: 3px solid transparent; transition: all 0.3s;" id="inboundCard">
              <div style="text-align: center; margin-bottom: 15px;">
                <div style="font-size: 64px;">üì≤</div>
                <h3 style="margin: 10px 0; color: #0d122b;">Inbound Calls</h3>
              </div>
              <p style="margin-bottom: 15px; line-height: 1.6;">
                <strong>Customers call you</strong> - Perfect for:
              </p>
              <ul style="margin: 0 0 15px 20px; line-height: 1.8; font-size: 14px;">
                <li>Phone support hotline</li>
                <li>Lead qualification</li>
                <li>Order status inquiries</li>
                <li>24/7 virtual assistant</li>
              </ul>
              <div style="background: #e7f5ff; padding: 10px; border-radius: 4px; margin-top: 15px; font-size: 13px; line-height: 1.6;">
                <strong>Phase 1:</strong> <code>&lt;Say&gt;</code> + <code>&lt;Gather&gt;</code><br>
                <strong>Phase 2:</strong> ConversationRelay + STT + TTS + AI
              </div>
            </div>
          </div>

          <div id="step2Status" class="status-box"></div>

          <div class="button-group">
            <button class="btn btn-secondary" onclick="prevStep()">‚Üê Back</button>
            <button class="btn btn-primary" id="nextBtn2" onclick="nextStep()" disabled>
              Next: Provision Services ‚Üí
            </button>
          </div>
        </div>
      `;
    }

    function selectCallDirection(direction) {
      console.log('üéØ selectCallDirection called with:', direction);

      try {
        callDirection = direction;
        callDirectionChosen = true;

        // Visual feedback
        const outboundCard = document.getElementById('outboundCard');
        const inboundCard = document.getElementById('inboundCard');
        const nextBtn = document.getElementById('nextBtn2');

        if (outboundCard) {
          outboundCard.style.border = direction === 'outbound' ? '3px solid #F22F46' : '3px solid transparent';
          outboundCard.style.transform = direction === 'outbound' ? 'scale(1.02)' : 'scale(1)';
        }
        if (inboundCard) {
          inboundCard.style.border = direction === 'inbound' ? '3px solid #F22F46' : '3px solid transparent';
          inboundCard.style.transform = direction === 'inbound' ? 'scale(1.02)' : 'scale(1)';
        }

        if (nextBtn) {
          nextBtn.disabled = false;
          console.log('‚úÖ Next button enabled for call direction:', direction);
        } else {
          console.error('‚ùå Could not find nextBtn2 element');
        }

        const directionText = direction === 'outbound' ? 'outbound calls (you call them)' : 'inbound calls (they call you)';
        showStatus('step2Status', 'success', `‚úÖ Great! You'll build a bot for ${directionText}. Click Next to continue.`);
        updateProgressBar();

        // Save progress last so errors don't block the UI updates
        saveProgressToStorage();
      } catch (error) {
        console.error('‚ùå Error in selectCallDirection:', error);
        alert('Error selecting call direction: ' + error.message);
      }
    }

    // =========================================================================
    // STEP 3: SERVICES - Provision Twilio Services
    // =========================================================================

    function renderStep3_Services() {
      return `
        <div class="step-content active">
          <div class="step-header">
            <h2>Step 3: Provision Required Services</h2>
            <p>Let's set up the Twilio services you need for Voice ${callDirection === 'outbound' ? 'Outbound' : 'Inbound'}</p>
          </div>

          <div class="instructions">
            <h3>üìã Required Services</h3>
            <p>We'll check your account and provision any missing services automatically.</p>
            <p style="margin-top: 15px;">
              üìö <strong>Documentation:</strong>
              <a href="https://www.twilio.com/docs/phone-numbers" target="_blank">Phone Numbers</a> |
              <a href="https://www.twilio.com/docs/messaging/services" target="_blank">Messaging Services</a> |
              <a href="https://www.twilio.com/docs/sync" target="_blank">Sync</a>
            </p>
          </div>

          <!-- CRITICAL: Enable AI/ML Features for ConversationRelay -->
          <div style="margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); border-radius: 12px; border: 3px solid #c92a2a; box-shadow: 0 4px 15px rgba(201, 42, 42, 0.3);">
            <div style="display: flex; align-items: start; gap: 15px;">
              <div style="font-size: 32px;">‚ö†Ô∏è</div>
              <div style="flex: 1;">
                <h3 style="color: white; margin: 0 0 10px 0; font-size: 1.2rem;">üî¥ REQUIRED: Enable AI/ML Features</h3>
                <p style="color: rgba(255,255,255,0.95); margin: 0 0 15px 0; line-height: 1.6;">
                  Before you can use ConversationRelay (needed for Steps 6+), you MUST enable the <strong>Predictive and Generative AI/ML Features Addendum</strong> in your Twilio Console.
                </p>
                <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                  <p style="color: white; margin: 0 0 10px 0; font-weight: 600;">üìù Quick Steps:</p>
                  <ol style="color: rgba(255,255,255,0.9); margin: 0; padding-left: 20px; line-height: 1.8;">
                    <li>Log in to your <a href="https://console.twilio.com" target="_blank" style="color: #ffd43b; text-decoration: underline;">Twilio Console</a></li>
                    <li>Navigate to <strong>Voice</strong> ‚Üí <strong>Settings</strong> ‚Üí <strong>General</strong></li>
                    <li>Find <strong>"Predictive and Generative AI/ML Features Addendum"</strong></li>
                    <li>Toggle it <strong>ON</strong></li>
                    <li>Save your changes</li>
                  </ol>
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                  <a href="https://console.twilio.com/us1/account/voice-settings" target="_blank"
                     style="padding: 10px 20px; background: white; color: #c92a2a; border: none; border-radius: 6px; font-weight: 600; text-decoration: none; display: inline-block; transition: all 0.3s;">
                    üîß Open Voice Settings
                  </a>
                  <a href="https://www.twilio.com/docs/voice/twiml/connect/conversationrelay/onboarding" target="_blank"
                     style="padding: 10px 20px; background: rgba(255,255,255,0.2); color: white; border: 1px solid white; border-radius: 6px; font-weight: 600; text-decoration: none; display: inline-block; transition: all 0.3s;">
                    üìö View Documentation
                  </a>
                </div>
                <p style="color: rgba(255,255,255,0.8); margin: 15px 0 0 0; font-size: 0.9rem; font-style: italic;">
                  üí° This is a one-time setup. Once enabled, you can use ConversationRelay in all your projects.
                </p>
              </div>
            </div>
          </div>

          <div id="servicesContainer">
            <div style="text-align: center; padding: 40px;">
              <div style="font-size: 48px; margin-bottom: 20px;">‚è≥</div>
              <p>Checking your Twilio account...</p>
            </div>
          </div>

          <div id="step3Status" class="status-box"></div>

          <div class="button-group">
            <button class="btn btn-secondary" onclick="prevStep()">‚Üê Back</button>
            <button class="btn btn-primary" id="nextBtn3" onclick="nextStep()" disabled>
              Next: Create Basic TwiML ‚Üí
            </button>
          </div>
        </div>
      `;
    }

    async function loadServices() {
      // Handle demo mode
      if (studentDemoMode || twilioCredentials?.demoMode) {
        // Check if we've "purchased" a third number
        const demoNumbers = [
          { phoneNumber: '+1 (555) 867-5309', sid: 'PNdemo001', friendlyName: 'Demo Workshop Number' },
          { phoneNumber: '+1 (555) 123-4567', sid: 'PNdemo002', friendlyName: 'Demo Testing Number' }
        ];

        // Add purchased number if it exists (simulates persistence)
        if (localStorage.getItem('demoPurchasedNumber')) {
          demoNumbers.push({
            phoneNumber: '+1 (555) 321-0987',
            sid: 'PNdemo003',
            friendlyName: 'Purchased Demo Number'
          });
        }

        displayServices({
          phoneNumbers: demoNumbers,
          messagingService: { sid: 'MGdemo', friendlyName: 'Demo Messaging Service' },
          syncService: { sid: 'ISdemo', friendlyName: 'Demo Sync Service' }
        });
        return;
      }

      try {
        const response = await fetch('/api/tutorial-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'setupComplete',
            ...twilioCredentials
          })
        });

        const data = await response.json();
        console.log('loadServices response:', data);

        if (data.success && data.setup) {
          console.log('Service data:', {
            phoneNumbers: data.setup.phoneNumbers,
            messagingService: data.setup.messagingService,
            syncService: data.setup.syncService
          });
          displayServices(data.setup);
        } else {
          // No services found - display empty state
          console.log('No services found, displaying empty state');
          displayServices({
            phoneNumbers: [],
            messagingService: null,
            syncService: null
          });
        }
      } catch (error) {
        showStatus('step3Status', 'error', 'Failed to load services: ' + error.message);
        // Display empty state on error
        displayServices({
          phoneNumbers: [],
          messagingService: null,
          syncService: null
        });
      }
    }

    function displayServices(setup) {
      const container = document.getElementById('servicesContainer');

      // Handle case where setup is undefined or null
      if (!setup) {
        setup = {};
      }

      // Only consider services configured if they have actual SIDs
      const hasPhone = setup.phoneNumbers && setup.phoneNumbers.length > 0;
      const hasMessaging = setup.messagingService && setup.messagingService.sid && setup.messagingService.sid !== '';
      const hasSync = setup.syncService && setup.syncService.sid && setup.syncService.sid !== '';

      container.innerHTML = `
        <div class="service-card">
          <h4>üìû Phone Number</h4>
          <p style="font-size: 13px; color: #666; margin-bottom: 10px;">
            Required for making and receiving voice calls
          </p>
          ${hasPhone ? `
            <div style="margin-bottom: 15px;">
              <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #4fc1ff;">
                Select a phone number for this project:
              </label>
              <select id="phoneNumberSelect" style="width: 100%; padding: 10px; background: #1e1e1e; color: #abb2bf; border: 1px solid #3e4451; border-radius: 4px; font-size: 14px;" onchange="selectPhoneNumber()">
                <option value="">-- Select a phone number --</option>
                ${setup.phoneNumbers.map(num => `
                  <option value="${num.sid}" data-number="${num.phoneNumber}">
                    ${num.phoneNumber} ${num.friendlyName ? '(' + num.friendlyName + ')' : ''}
                  </option>
                `).join('')}
              </select>
            </div>
            <div style="text-align: center; margin: 10px 0;">
              <span style="color: #666;">OR</span>
            </div>
          ` : ''}
          <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
            <button class="btn btn-${hasPhone ? 'secondary' : 'primary'}" onclick="provisionPhone()">
              ${hasPhone ? 'üìû Purchase New Number' : 'üìû Purchase Number'}
            </button>
            <span style="color: #666;">or</span>
            <a href="https://console.twilio.com/us1/develop/phone-numbers/manage/search?frameUrl=%2Fconsole%2Fphone-numbers%2Fsearch%3Fx-target-region%3Dus1" target="_blank" style="color: #4fc1ff; text-decoration: none; font-size: 13px;">
              üîó Buy in Console
            </a>
          </div>
          <div id="selectedNumberDisplay" style="margin-top: 15px; padding: 10px; background: #2c313c; border-radius: 4px; display: none;">
            <strong style="color: #4fc1ff;">Selected:</strong>
            <span id="selectedNumberText" style="color: #98c379; margin-left: 10px;"></span>
          </div>
        </div>

        <div class="service-card">
          <h4>üí¨ Messaging Service</h4>
          <p style="font-size: 13px; color: #666; margin-bottom: 10px;">
            Required for SMS notifications and multi-channel communication
          </p>
          <div class="service-status">
            <span>${hasMessaging ? '‚úÖ Configured' : '‚ùå Required'}</span>
            ${!hasMessaging ? `
              <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="provisionMessaging()">Create Service</button>
                <span style="color: #666;">or</span>
                <a href="https://console.twilio.com/us1/develop/sms/services" target="_blank" style="color: #4fc1ff; text-decoration: none; font-size: 13px;">
                  üîó Create in Console
                </a>
              </div>
            ` : ''}
          </div>
        </div>

        <div class="service-card">
          <h4>üîÑ Sync Service (Optional)</h4>
          <p style="font-size: 13px; color: #666; margin-bottom: 10px;">
            Do you want to add Twilio Sync services to persist state during the conversation with the AI bot?
          </p>
          <div class="service-status">
            <span>${hasSync ? '‚úÖ Configured' : (syncServiceSkipped ? '‚ö™ Skipped' : '‚ö†Ô∏è Optional')}</span>
            ${!hasSync && !syncServiceSkipped ? `
              <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="provisionSync()">Yes, Enable Sync</button>
                <button class="btn btn-secondary" onclick="skipSync()">No, Skip This</button>
                <span style="color: #666;">or</span>
                <a href="https://console.twilio.com/us1/develop/sync/services" target="_blank" style="color: #4fc1ff; text-decoration: none; font-size: 13px;">
                  üîó Create in Console
                </a>
              </div>
            ` : ''}
          </div>
        </div>
      `;

      // Store phone numbers for selection
      window.availablePhoneNumbers = setup.phoneNumbers || [];

      // Check if minimum services are ready (Sync is now optional)
      // Note: Phone number must be explicitly selected by user
      if (hasMessaging && (hasSync || syncServiceSkipped)) {
        if (selectedPhoneNumber) {
          servicesReady = true;
          document.getElementById('nextBtn3').disabled = false;
          showStatus('step3Status', 'success', 'üéâ All required services are ready!');
          updateProgressBar();
        } else if (hasPhone) {
          showStatus('step3Status', 'info', '‚ÑπÔ∏è Please select a phone number or purchase a new one to continue.');
        }
      }
    }

    function selectPhoneNumber() {
      const select = document.getElementById('phoneNumberSelect');
      const selectedOption = select.options[select.selectedIndex];

      if (selectedOption.value) {
        selectedPhoneNumberSid = selectedOption.value;
        selectedPhoneNumber = selectedOption.getAttribute('data-number');

        // Show selected number
        document.getElementById('selectedNumberDisplay').style.display = 'block';
        document.getElementById('selectedNumberText').textContent = selectedPhoneNumber;

        // Re-check if all services are ready
        const hasMessaging = document.querySelector('.service-card:nth-child(2) .service-status span').textContent.includes('‚úÖ');
        const hasSync = document.querySelector('.service-card:nth-child(3) .service-status span').textContent.includes('‚úÖ');

        if (hasMessaging && (hasSync || syncServiceSkipped)) {
          servicesReady = true;
          document.getElementById('nextBtn3').disabled = false;
          showStatus('step3Status', 'success', 'üéâ All required services are ready!');
          updateProgressBar();
        }
      } else {
        selectedPhoneNumber = null;
        document.getElementById('selectedNumberDisplay').style.display = 'none';
        servicesReady = false;
        document.getElementById('nextBtn3').disabled = true;
      }
    }

    function skipSync() {
      syncServiceSkipped = true;
      showStatus('step3Status', 'info', '‚ÑπÔ∏è Sync service skipped. You can continue without state persistence.');
      loadServices();
    }

    async function provisionPhone() {
      if (studentDemoMode || twilioCredentials?.demoMode) {
        showStatus('step3Status', 'info', 'üìù Demo Mode: Simulating phone number purchase...');
        setTimeout(() => {
          // Mark as purchased in localStorage
          localStorage.setItem('demoPurchasedNumber', 'true');
          showStatus('step3Status', 'success', '‚úÖ Demo phone number +1 (555) 321-0987 purchased successfully!');
          // Reload services to show the new number
          setTimeout(() => {
            loadServices();
          }, 500);
        }, 1500);
        return;
      }

      const areaCode = prompt('Enter area code (e.g., 415, 212, 310):');
      if (!areaCode) return;

      showStatus('step3Status', 'info', 'Purchasing phone number...');

      try {
        const response = await fetch('/api/tutorial-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'provisionPhoneNumber',
            areaCode,
            ...twilioCredentials
          })
        });

        const data = await response.json();

        if (data.success) {
          const newNumber = data.phoneNumber.phoneNumber;
          const newNumberSid = data.phoneNumber.sid;
          showStatus('step3Status', 'success', `‚úÖ Purchased ${newNumber}!`);

          // Store the new number to auto-select it after reload
          window.newlyPurchasedNumber = newNumber;
          window.newlyPurchasedSid = newNumberSid;

          await loadServices();

          // Auto-select the newly purchased number
          setTimeout(() => {
            const select = document.getElementById('phoneNumberSelect');
            if (select && window.newlyPurchasedSid) {
              select.value = window.newlyPurchasedSid;
              selectPhoneNumber();
            }
          }, 500);

          // Prompt to add to messaging service
          setTimeout(() => {
            promptAddToMessagingService(newNumberSid, newNumber);
          }, 1000);
        } else {
          showStatus('step3Status', 'error', data.error);
        }
      } catch (error) {
        showStatus('step3Status', 'error', error.message);
      }
    }

    async function provisionMessaging() {
      if (twilioCredentials?.demoMode) {
        showStatus('step3Status', 'info', 'üìù Demo Mode: Simulating messaging service creation...');
        setTimeout(() => {
          showStatus('step3Status', 'success', '‚úÖ Demo messaging service created!');
          loadServices();
        }, 1000);
        return;
      }

      showStatus('step3Status', 'info', 'Creating messaging service...');

      try {
        const response = await fetch('/api/tutorial-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'createMessagingService',
            ...twilioCredentials
          })
        });

        const data = await response.json();

        if (data.success) {
          showStatus('step3Status', 'success', '‚úÖ Messaging service created!');
          loadServices();
        }
      } catch (error) {
        showStatus('step3Status', 'error', error.message);
      }
    }

    async function provisionSync() {
      if (twilioCredentials?.demoMode) {
        showStatus('step3Status', 'info', 'üìù Demo Mode: Simulating Sync service creation...');
        setTimeout(() => {
          showStatus('step3Status', 'success', '‚úÖ Demo Sync service created!');
          loadServices();
        }, 1000);
        return;
      }

      showStatus('step3Status', 'info', 'Creating Sync service...');

      try {
        const response = await fetch('/api/tutorial-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'createSyncService',
            ...twilioCredentials
          })
        });

        const data = await response.json();

        if (data.success) {
          showStatus('step3Status', 'success', '‚úÖ Sync service created!');
          loadServices();
        }
      } catch (error) {
        showStatus('step3Status', 'error', error.message);
      }
    }

    async function promptAddToMessagingService(phoneNumberSid, phoneNumber) {
      // Fetch existing messaging services
      try {
        const response = await fetch('/api/tutorial-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'listMessagingServices',
            ...twilioCredentials
          })
        });

        const data = await response.json();

        if (data.success && data.services && data.services.length > 0) {
          // Show modal with dropdown to select existing service
          showMessagingServiceModal(phoneNumberSid, phoneNumber, data.services);
        } else {
          // No services exist, prompt to create one
          if (confirm(`Add ${phoneNumber} to a Messaging Service?\n\nNo messaging services found. Would you like to create one now?`)) {
            await createAndAddToMessagingService(phoneNumberSid, phoneNumber);
          }
        }
      } catch (error) {
        console.error('Error fetching messaging services:', error);
      }
    }

    function showMessagingServiceModal(phoneNumberSid, phoneNumber, services) {
      const modalHTML = `
        <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center;" id="messagingServiceModal">
          <div style="background: white; border-radius: 12px; padding: 30px; max-width: 500px; width: 90%;">
            <h3 style="margin: 0 0 15px 0; color: #333;">üì± Add ${phoneNumber} to Messaging Service</h3>
            <p style="color: #666; margin-bottom: 20px;">Choose an existing messaging service or create a new one:</p>

            <div style="margin-bottom: 20px;">
              <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Select Messaging Service:</label>
              <select id="messagingServiceSelect" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                ${services.map(s => `<option value="${s.sid}">${s.friendlyName || s.sid}</option>`).join('')}
              </select>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
              <button onclick="document.getElementById('messagingServiceModal').remove()" style="padding: 10px 20px; background: #e0e0e0; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                Skip
              </button>
              <button onclick="createNewMessagingServiceForNumber('${phoneNumberSid}', '${phoneNumber}')" style="padding: 10px 20px; background: #4fc1ff; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                Create New
              </button>
              <button onclick="addToSelectedMessagingService('${phoneNumberSid}', '${phoneNumber}')" style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                Add to Selected
              </button>
            </div>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', modalHTML);
    }

    async function addToSelectedMessagingService(phoneNumberSid, phoneNumber) {
      const serviceSid = document.getElementById('messagingServiceSelect').value;
      document.getElementById('messagingServiceModal').remove();

      showStatus('step3Status', 'info', `Adding ${phoneNumber} to messaging service...`);

      try {
        const response = await fetch('/api/tutorial-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'addNumberToMessagingService',
            serviceSid,
            phoneNumberSid,
            ...twilioCredentials
          })
        });

        const data = await response.json();

        if (data.success) {
          showStatus('step3Status', 'success', `‚úÖ ${phoneNumber} added to messaging service!`);
          loadServices();
        } else {
          showStatus('step3Status', 'error', `Failed to add number: ${data.error}`);
        }
      } catch (error) {
        showStatus('step3Status', 'error', error.message);
      }
    }

    async function createNewMessagingServiceForNumber(phoneNumberSid, phoneNumber) {
      document.getElementById('messagingServiceModal').remove();
      await createAndAddToMessagingService(phoneNumberSid, phoneNumber);
    }

    async function createAndAddToMessagingService(phoneNumberSid, phoneNumber) {
      showStatus('step3Status', 'info', 'Creating messaging service...');

      try {
        // Create messaging service
        const createResponse = await fetch('/api/tutorial-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'createMessagingService',
            friendlyName: 'Workshop Messaging Service',
            ...twilioCredentials
          })
        });

        const createData = await createResponse.json();

        if (createData.success) {
          const serviceSid = createData.service.sid;
          showStatus('step3Status', 'info', `Adding ${phoneNumber} to new service...`);

          // Add number to service
          const addResponse = await fetch('/api/tutorial-proxy', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              action: 'addNumberToMessagingService',
              serviceSid,
              phoneNumberSid,
              ...twilioCredentials
            })
          });

          const addData = await addResponse.json();

          if (addData.success) {
            showStatus('step3Status', 'success', `‚úÖ Messaging service created and ${phoneNumber} added!`);
            loadServices();
          } else {
            showStatus('step3Status', 'warning', `‚ö†Ô∏è Service created but failed to add number: ${addData.error}`);
            loadServices();
          }
        } else {
          showStatus('step3Status', 'error', `Failed to create service: ${createData.error}`);
        }
      } catch (error) {
        showStatus('step3Status', 'error', error.message);
      }
    }

    // =========================================================================
    // STEP 4: BASIC TWIML - Simple Dial or Receive
    // =========================================================================

    function renderStep4_BasicTwiML() {
      const isOutbound = callDirection === 'outbound';

      return `
        <div class="step-content active">
          <div class="step-header">
            <h2>Step 4: Create Basic ${isOutbound ? 'Dial' : 'Inbound'} TwiML</h2>
            <p>Let's start with simple voice calling before adding AI</p>
          </div>

          <div class="instructions">
            <h3>üìã Your Task</h3>
            ${isOutbound ? `
              <p>Create a simple <code>&lt;Dial&gt;</code> verb to connect calls to a phone number.</p>
              <p>This is the foundation - you'll upgrade this to AI in later steps!</p>
              <p style="margin-top: 15px;">
                üìö <strong>Documentation:</strong>
                <a href="https://www.twilio.com/docs/voice/twiml/dial" target="_blank">&lt;Dial&gt; Verb</a> |
                <a href="https://www.twilio.com/docs/voice/tutorials/how-to-make-outbound-phone-call" target="_blank">Making Calls</a>
              </p>
            ` : `
              <p>Create an interactive voice response with <code>&lt;Say&gt;</code> and <code>&lt;Gather&gt;</code>.</p>
              <p>This is the foundation - you'll upgrade this to AI in later steps!</p>
              <p style="margin-top: 15px;">
                üìö <strong>Documentation:</strong>
                <a href="https://www.twilio.com/docs/voice/twiml/say" target="_blank">&lt;Say&gt; Verb</a> |
                <a href="https://www.twilio.com/docs/voice/twiml/gather" target="_blank">&lt;Gather&gt; Verb</a> |
                <a href="https://www.twilio.com/docs/voice/tutorials/ivr-phone-tree-python" target="_blank">IVR Tutorial</a>
              </p>
            `}
          </div>

          ${isOutbound ? `
          <div class="service-card" style="background: linear-gradient(135deg, #e5c07b 0%, #2c313c 100%); padding: 20px; margin: 20px 0;">
            <h3 style="margin: 0 0 15px 0; color: white;">üéØ Configure Your IVR Message</h3>
            <p style="color: #e5e5e5; margin-bottom: 20px;">
              Customize the message and menu options for your Interactive Voice Response (IVR) system.
            </p>

            <div style="background: #1e1e1e; padding: 20px; border-radius: 6px;">
              <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #4fc1ff;">
                  üëã Greeting Message
                </label>
                <input type="text" id="ivrGreeting" placeholder="Hello world" value="Hello world"
                       style="width: 100%; padding: 12px; background: #2c313c; color: #abb2bf; border: 1px solid #3e4451; border-radius: 4px; font-size: 14px;"
                       oninput="updateIVRCode()">
                <p style="font-size: 12px; color: #666; margin: 5px 0 0 0;">What the caller hears first</p>
              </div>

              <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #4fc1ff;">
                  1Ô∏è‚É£ Option 1 Text
                </label>
                <input type="text" id="ivrOption1" placeholder="Press 1 to connect to God" value="Press 1 to connect to God"
                       style="width: 100%; padding: 12px; background: #2c313c; color: #abb2bf; border: 1px solid #3e4451; border-radius: 4px; font-size: 14px;"
                       oninput="updateIVRCode()">
                <p style="font-size: 12px; color: #666; margin: 5px 0 0 0;">Menu option for pressing 1</p>
              </div>

              <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #4fc1ff;">
                  2Ô∏è‚É£ Option 2 Text
                </label>
                <input type="text" id="ivrOption2" placeholder="Press 2 to connect to your mom" value="Press 2 to connect to your mom"
                       style="width: 100%; padding: 12px; background: #2c313c; color: #abb2bf; border: 1px solid #3e4451; border-radius: 4px; font-size: 14px;"
                       oninput="updateIVRCode()">
                <p style="font-size: 12px; color: #666; margin: 5px 0 0 0;">Menu option for pressing 2</p>
              </div>

              <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #4fc1ff;">
                  üó£Ô∏è Voice Type
                </label>
                <select id="ivrVoice" style="width: 100%; padding: 12px; background: #2c313c; color: #abb2bf; border: 1px solid #3e4451; border-radius: 4px; font-size: 14px;" onchange="updateIVRCode()">
                  ${getVoiceOptions()}
                </select>
                <p style="font-size: 12px; color: #666; margin: 5px 0 0 0;">Choose the voice for ${getTTSProviderName()}</p>
              </div>
            </div>
          </div>
          ` : ''}

          <div class="code-editor">
            <div class="code-header">
              <span>üìù ${isOutbound ? 'IVR' : 'Inbound'} TwiML Handler</span>
              <div style="display: flex; gap: 10px;">
                <button class="btn btn-success" style="padding: 6px 12px; font-size: 13px;" onclick="validateCode4()">‚úì Validate</button>
                <button class="btn-copy" onclick="copyCode('code4')">üìã Copy Code</button>
                <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 13px;" onclick="showSolution(4)">üí° Show Solution</button>
                <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 13px;" onclick="resetCode4()">Reset</button>
              </div>
            </div>
            <textarea class="code-textarea" id="code4">${isOutbound ? `exports.handler = function(context, event, callback) {
  const twilio = require('twilio');
  const twiml = new twilio.twiml.VoiceResponse();

  // Greet the caller
  twiml.say('Hello world', { voice: '${getDefaultVoice()}' });

  // Create a menu with gather
  const gather = twiml.gather({
    numDigits: 1,
    timeout: 10
  });
  gather.say('Press 1 to connect to God. Press 2 to connect to your mom.', { voice: '${getDefaultVoice()}' });

  // After gather timeout, say goodbye and hang up
  twiml.say('Goodbye!', { voice: '${getDefaultVoice()}' });
  twiml.hangup();

  callback(null, twiml);
};` : `exports.handler = function(context, event, callback) {
  const twilio = require('twilio');
  const twiml = new twilio.twiml.VoiceResponse();

  // Greet the caller
  twiml.say('Welcome to our service!');

  // Create a gather to collect input
  const gather = twiml.gather({
    numDigits: 1,
    timeout: 10
  });
  gather.say('Press 1 for sales, 2 for support.');

  // After gather timeout or completion, say goodbye and hang up
  twiml.say('Thank you for calling. Goodbye!');
  twiml.hangup();

  callback(null, twiml);
};`}</textarea>
          </div>

          <div id="step4Status" class="status-box"></div>

          ${!step4CodeValidated ? `
          <div id="step4Placeholder" class="instructions" style="margin-top: 20px; background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px;">
            <p style="margin: 0; color: #856404;">
              üí° <strong>Next Steps:</strong> Once you validate your code above, you'll be able to test and deploy your voice handler.
            </p>
          </div>
          ` : ''}

          ${isOutbound ? `
          <div id="step4TestSection" class="service-card" style="margin-top: 20px; background: linear-gradient(135deg, #98c379 0%, #2c313c 100%); display: ${step4CodeValidated ? 'block' : 'none'};">
            <h4 style="color: white; margin-bottom: 15px;">üìû Test Your IVR Live!</h4>
            <p style="color: #e5e5e5; margin-bottom: 10px;">
              Test your IVR by calling YOUR phone. You'll hear the greeting and menu options.
            </p>
            <p style="color: rgba(255,255,255,0.9); margin-bottom: 15px; padding: 10px; background: rgba(255,255,255,0.15); border-radius: 6px; font-size: 14px;">
              ‚ö†Ô∏è <strong>Required:</strong> You must make a test call before deploying so you can hear how the old IVR sounds!
            </p>
            <div style="margin-bottom: 15px;">
              <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #4fc1ff;">
                Your Phone Number (to receive test call):
              </label>
              <input type="tel" id="testCallNumber" placeholder="+12345678901"
                     style="width: 100%; padding: 12px; background: #2c313c; color: #abb2bf; border: 1px solid #3e4451; border-radius: 4px; font-size: 14px;">
              <p style="font-size: 12px; color: #666; margin: 5px 0 0 0;">Enter YOUR number to receive the test call</p>
            </div>
            <button class="btn btn-primary" onclick="makeLiveTestCall()" style="width: 100%; background: white; color: #2c313c; font-weight: 600;">
              üìû Make Live Test Call
            </button>
            <div id="liveTestStatus" style="margin-top: 15px;"></div>
          </div>
          ` : ''}

          <div id="step4DeploySection" style="margin: 30px 0; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; border: 2px solid #5a67d8; display: ${step4CodeValidated && (callDirection === 'inbound' || step4LiveTestCompleted) ? 'block' : 'none'};">
            <h3 style="color: white; margin: 0 0 15px 0; font-size: 1.2rem;">üíæ Ready to Deploy?</h3>
            <p style="color: rgba(255,255,255,0.9); margin-bottom: 20px; line-height: 1.6;">
              Once you're happy with your code, click <strong>Commit Step 4</strong> to deploy it to your Twilio account.
              This will create a Serverless service and deploy your voice handler function.
            </p>
            <button
              class="btn btn-success"
              id="commitStep4Btn"
              onclick="commitStep(4)"
              style="font-size: 1.1rem; padding: 15px 30px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border: none; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);">
              üíæ Commit Step 4 - Deploy Basic Handler
            </button>
            <div id="commitStep4Status" style="margin-top: 15px;"></div>
          </div>

          ${callDirection === 'inbound' ? `
          <!-- Inbound Call Test Instructions -->
          <div id="inboundTestCard" style="display: none; margin-top: 30px; padding: 25px; background: linear-gradient(135deg, #4fc1ff 0%, #2c313c 100%); border-radius: 12px; border: 2px solid #4fc1ff;">
            <h3 style="color: white; margin: 0 0 15px 0; font-size: 1.3rem;">üìû Test Your Inbound IVR</h3>
            <p style="color: rgba(255,255,255,0.9); margin-bottom: 20px; line-height: 1.6;">
              Your voice handler has been deployed! Call your Twilio number to test the IVR:
            </p>

            <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
              <div style="color: #98c379; font-size: 14px; margin-bottom: 8px; font-weight: 600;">üì± Your Twilio Number:</div>
              <div style="font-size: 28px; font-weight: bold; color: white; font-family: monospace; margin-bottom: 15px;">
                ${selectedPhoneNumber || 'Not configured'}
              </div>
              <div style="color: rgba(255,255,255,0.8); font-size: 14px; line-height: 1.6;">
                <strong>What to expect:</strong><br>
                1Ô∏è‚É£ Call the number above from your phone<br>
                2Ô∏è‚É£ You'll hear: "Welcome to our service!"<br>
                3Ô∏è‚É£ Listen to menu: "Press 1 for sales, 2 for support"<br>
                4Ô∏è‚É£ Press 1 or 2 (or wait 10 seconds)<br>
                5Ô∏è‚É£ You'll hear "Thank you for calling. Goodbye!" and call ends
              </div>
            </div>

            <button class="btn btn-success" onclick="confirmInboundTestStep4()" style="width: 100%; font-size: 1.1rem; padding: 15px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
              ‚úÖ I Called and It Works!
            </button>

            <!-- Call Progress Tracker -->
            <div id="callProgressTracker" style="display: none; margin-top: 20px; padding: 20px; background: rgba(0,0,0,0.2); border-radius: 8px;">
              <h4 style="color: white; margin: 0 0 15px 0; font-size: 1.1rem;">üìä Call Progress</h4>
              <div id="callStages" style="display: flex; flex-direction: column; gap: 10px;">
                <div id="stage1" class="call-stage" style="display: flex; align-items: center; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 6px; opacity: 0.5;">
                  <span style="width: 30px; height: 30px; border-radius: 50%; background: #666; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 16px;">1</span>
                  <span style="color: rgba(255,255,255,0.7);">Call initiated</span>
                </div>
                <div id="stage2" class="call-stage" style="display: flex; align-items: center; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 6px; opacity: 0.5;">
                  <span style="width: 30px; height: 30px; border-radius: 50%; background: #666; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 16px;">2</span>
                  <span style="color: rgba(255,255,255,0.7);">Greeting played</span>
                </div>
                <div id="stage3" class="call-stage" style="display: flex; align-items: center; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 6px; opacity: 0.5;">
                  <span style="width: 30px; height: 30px; border-radius: 50%; background: #666; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 16px;">3</span>
                  <span style="color: rgba(255,255,255,0.7);">Menu options played</span>
                </div>
                <div id="stage4" class="call-stage" style="display: flex; align-items: center; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 6px; opacity: 0.5;">
                  <span style="width: 30px; height: 30px; border-radius: 50%; background: #666; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 16px;">4</span>
                  <span style="color: rgba(255,255,255,0.7);">Waiting for input (or timeout)</span>
                </div>
                <div id="stage5" class="call-stage" style="display: flex; align-items: center; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 6px; opacity: 0.5;">
                  <span style="width: 30px; height: 30px; border-radius: 50%; background: #666; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 16px;">5</span>
                  <span style="color: rgba(255,255,255,0.7);">Goodbye message & hangup</span>
                </div>
              </div>
              <button onclick="hideCallProgress()" style="margin-top: 15px; padding: 8px 16px; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 4px; cursor: pointer;">
                Hide Progress
              </button>
            </div>

            <button id="showProgressBtn" onclick="showCallProgress()" style="display: none; width: 100%; margin-top: 15px; padding: 12px; background: rgba(76, 175, 80, 0.2); color: white; border: 1px solid #4CAF50; border-radius: 8px; cursor: pointer; font-size: 14px;">
              üìä Show Call Flow Progress
            </button>
          </div>
          ` : ''}

          <!-- Commit Voice Handler Section -->
          ${step4CodeValidated ? `
          <div class="service-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin: 20px 0;">
            <h4 style="color: white; margin-bottom: 15px;">üíæ Commit Voice Handler</h4>
            <p style="color: rgba(255,255,255,0.9); margin-bottom: 15px; line-height: 1.6;">
              Your TwiML voice handler is validated! Choose where to deploy it:
            </p>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
              <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px;">
                <strong style="display: block; margin-bottom: 8px;">üêô GitHub Repository</strong>
                <p style="font-size: 13px; margin: 0 0 10px 0; opacity: 0.9;">
                  Deploy as webhook endpoint on Railway/Render/Heroku
                </p>
                <button class="btn" onclick="commitVoiceHandlerToGitHub()" style="width: 100%; padding: 10px; background: white; color: #667eea; border: none; font-weight: 600;">
                  Push to GitHub
                </button>
              </div>

              <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px;">
                <strong style="display: block; margin-bottom: 8px;">üìû Twilio Serverless</strong>
                <p style="font-size: 13px; margin: 0 0 10px 0; opacity: 0.9;">
                  Deploy as Twilio Function (simple & hosted)
                </p>
                <button class="btn" onclick="commitVoiceHandlerToTwilio()" style="width: 100%; padding: 10px; background: #F22F46; color: white; border: none; font-weight: 600;">
                  Deploy to Twilio
                </button>
              </div>
            </div>

            <div id="commitStep4Status" style="margin-top: 15px;"></div>
          </div>
          ` : ''}

          <div class="button-group">
            <button class="btn btn-secondary" onclick="prevStep()">‚Üê Back</button>
            <button class="btn btn-primary" id="nextBtn4" onclick="nextStep()" disabled>
              Next: Build WebSocket Handler ‚Üí
            </button>
          </div>
        </div>
      `;
    }

    function testCode4() {
      const code = document.getElementById('code4').value;
      const consoleEl = document.getElementById('console4');
      const isOutbound = callDirection === 'outbound';

      try {
        // Extract phone number if present
        const numberMatch = code.match(/dial\.number\(['"]([^'"]+)['"]\)|twiml\.dial\(['"]([^'"]+)['"]\)/);
        const phoneNumber = numberMatch ? (numberMatch[1] || numberMatch[2]) : null;

        // Extract timeout
        const timeoutMatch = code.match(/timeout:\s*(\d+)/);
        const timeout = timeoutMatch ? timeoutMatch[1] : '30';

        // Extract machine detection
        const mdMatch = code.match(/machineDetection:\s*['"]([^'"]+)['"]/);
        const machineDetection = mdMatch ? mdMatch[1] : 'none';

        // Simulate the function execution
        let output = `<div class="console-line">üìû Testing TwiML generation...</div>`;
        output += `<div class="console-line" style="color: #4fc1ff;">‚úì TwiML Response created</div>`;

        if (isOutbound) {
          output += `<div class="console-line" style="color: #98c379;">‚úì Dial verb configured</div>`;

          if (phoneNumber) {
            output += `<div class="console-line">  ‚Üí Target: ${phoneNumber}</div>`;
          } else {
            output += `<div class="console-line" style="color: #e5c07b;">  ‚ö†Ô∏è No target number specified yet</div>`;
          }

          if (timeout !== '30') {
            output += `<div class="console-line">  ‚Üí Timeout: ${timeout} seconds</div>`;
          }

          if (machineDetection !== 'none') {
            output += `<div class="console-line">  ‚Üí Machine Detection: ${machineDetection}</div>`;
          }

          output += `<div class="console-line" style="color: #666; margin-top: 10px;">Expected TwiML output:</div>`;
          output += `<div class="console-line" style="color: #666;">&lt;Response&gt;</div>`;
          output += `<div class="console-line" style="color: #666;">  &lt;Dial${timeout !== '30' ? ' timeout="' + timeout + '"' : ''}${machineDetection !== 'none' ? ' machineDetection="' + machineDetection + '"' : ''}&gt;</div>`;
          if (phoneNumber) {
            output += `<div class="console-line" style="color: #666;">    &lt;Number&gt;${phoneNumber}&lt;/Number&gt;</div>`;
          }
          output += `<div class="console-line" style="color: #666;">  &lt;/Dial&gt;</div>`;
          output += `<div class="console-line" style="color: #666;">&lt;/Response&gt;</div>`;
        } else {
          output += `<div class="console-line" style="color: #98c379;">Expected: Caller will hear IVR menu</div>`;
        }

        consoleEl.innerHTML = output;
      } catch (error) {
        consoleEl.innerHTML = `<div class="console-line" style="color: #e06c75;">Error: ${error.message}</div>`;
      }
    }

    function validateCode4() {
      const code = document.getElementById('code4').value;
      const isOutbound = callDirection === 'outbound';

      const hasSayVerb = code.includes('twiml.say(') || code.includes('.say(');
      const hasGatherVerb = code.includes('twiml.gather(') || code.includes('.gather(');
      const hasHangupVerb = code.includes('twiml.hangup(') || code.includes('.hangup(');

      // For both inbound and outbound, expect Say + Gather (basic IVR)
      if (hasSayVerb && hasGatherVerb) {
        basicTwimlCreated = true;
        step4CodeValidated = true;
        // Only enable Next button for inbound (outbound needs to test+deploy first)
        if (!isOutbound) {
          document.getElementById('nextBtn4').disabled = false;
        }
        showStatus('step4Status', 'success', '‚úÖ Perfect! Your IVR is ready. ' + (isOutbound ? 'Test it live below!' : 'Deploy it below!'));
        updateProgressBar();

        // Hide the placeholder hint and reveal next sections
        const placeholder = document.getElementById('step4Placeholder');
        if (placeholder) placeholder.style.display = 'none';

        const testSection = document.getElementById('step4TestSection');
        const deploySection = document.getElementById('step4DeploySection');

        if (isOutbound) {
          // For outbound: show test section, deploy will show after test
          if (testSection) testSection.style.display = 'block';
        } else {
          // For inbound: show deploy section immediately (can't test until deployed)
          if (deploySection) deploySection.style.display = 'block';
        }

        // Scroll to reveal
        setTimeout(() => {
          if (isOutbound && testSection) {
            testSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          } else if (deploySection) {
            deploySection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          }
        }, 300);
      } else if (!hasSayVerb) {
        showStatus('step4Status', 'error', '‚ùå Missing Say verb. Use twiml.say() to greet the caller.');
      } else if (!hasGatherVerb) {
        showStatus('step4Status', 'error', '‚ùå Missing Gather verb. Use twiml.gather() to collect input.');
      }
    }

    function getTTSProviderName() {
      if (ttsProvider === 'elevenlabs') return 'ElevenLabs';
      if (ttsProvider === 'google') return 'Google Cloud TTS';
      return 'Amazon Polly';
    }

    function getDefaultVoice() {
      // Use the selected voice for ConversationRelay if available
      if (conversationRelayVoice) return conversationRelayVoice;

      // Otherwise return provider defaults
      if (ttsProvider === 'elevenlabs') return '9XfYMbJVZqPHaQtYnTAO'; // Cody - Energetic Upbeat Educator
      if (ttsProvider === 'google') return 'en-US-Wavenet-A';
      return 'Polly.Joanna'; // Amazon Polly default
    }

    function getVoiceOptions() {
      if (ttsProvider === 'elevenlabs') {
        return `
          <option value="9XfYMbJVZqPHaQtYnTAO">Cody - Energetic Upbeat Educator</option>
          <option value="4CrZuIW9am7gYAxgo2Af">Shelley - Clear and confident British female</option>
          <option value="8N2ng9i2uiUWqstgmWlH">Beth - Gentle and nurturing</option>
          <option value="90ipbRoKi4CpHXvKVtl0">Anika - Customer Care Agent</option>
          <option value="9PvnT6XRzlljoaDG6Knu">Ranbir - Warm & Friendly</option>
          <option value="7S3KNdLDL7aRgBVRQb1z">Nathaniel - Deep Rich Mature British</option>
          <option value="6dcFFb31LVaCdYevmTAx">Jerry - Presenter, Announcer, Event</option>
          <option value="4O1sYUnmtThcBoSBrri7">Maya J - Friendly and Cheerful</option>
          <option value="5uUPmKaMTj8iOnm6Mb9s">Gulab - Mature, Narrative Voice</option>
        `;
      } else if (ttsProvider === 'google') {
        return `
          <option value="en-US-Wavenet-A">Wavenet A (Female, US English)</option>
          <option value="en-US-Wavenet-B">Wavenet B (Male, US English)</option>
          <option value="en-GB-Wavenet-A">Wavenet A (Female, British)</option>
          <option value="en-GB-Wavenet-B">Wavenet B (Male, British)</option>
          <option value="en-AU-Wavenet-A">Wavenet A (Female, Australian)</option>
        `;
      } else {
        // Amazon Polly (default)
        return `
          <option value="Polly.Joanna">Joanna (Female, US English)</option>
          <option value="Polly.Matthew">Matthew (Male, US English)</option>
          <option value="Polly.Amy">Amy (Female, British)</option>
          <option value="Polly.Brian">Brian (Male, British)</option>
          <option value="Polly.Salli">Salli (Female, US English)</option>
          <option value="Polly.Joey">Joey (Male, US English)</option>
        `;
      }
    }

    function updateIVRCode() {
      if (callDirection !== 'outbound') return;

      const greeting = document.getElementById('ivrGreeting')?.value || 'Hello world';
      const option1 = document.getElementById('ivrOption1')?.value || 'Press 1 to connect to God';
      const option2 = document.getElementById('ivrOption2')?.value || 'Press 2 to connect to your mom';
      const voice = document.getElementById('ivrVoice')?.value || (ttsProvider === 'elevenlabs' ? 'en-US-adam' : (ttsProvider === 'google' ? 'en-US-Wavenet-A' : 'Polly.Joanna'));

      // Generate simple IVR code (Say + Gather only, no Dial)
      const code = `exports.handler = function(context, event, callback) {
  const twilio = require('twilio');
  const twiml = new twilio.twiml.VoiceResponse();

  // Play greeting and IVR menu to the caller
  twiml.say('${greeting}', { voice: '${voice}' });

  // Create a menu with Gather
  const gather = twiml.gather({
    numDigits: 1,
    timeout: 10
  });

  gather.say('${option1}. ${option2}.', { voice: '${voice}' });

  // After gather timeout, say goodbye and hang up
  twiml.say('Goodbye!', { voice: '${voice}' });
  twiml.hangup();

  callback(null, twiml);
};`;

      // Update the textarea
      const codeEditor = document.getElementById('code4');
      if (codeEditor) {
        codeEditor.value = code;
      }
    }

    async function makeLiveTestCall() {
      // Get YOUR number (to receive the test call)
      const yourNumber = document.getElementById('testCallNumber')?.value?.trim();

      if (!yourNumber) {
        document.getElementById('liveTestStatus').innerHTML =
          '<div style="color: #e06c75; padding: 10px; background: #2c313c; border-radius: 4px;">‚ùå Please enter your phone number to receive the test call</div>';
        return;
      }

      if (!yourNumber.startsWith('+')) {
        document.getElementById('liveTestStatus').innerHTML =
          '<div style="color: #e5c07b; padding: 10px; background: #2c313c; border-radius: 4px;">‚ö†Ô∏è Your number must use E.164 format (e.g., +1234567890)</div>';
        return;
      }

      // Get the IVR TwiML from the code editor
      const code = document.getElementById('code4')?.value || '';

      // Extract greeting for display
      const greetingMatch = code.match(/twiml\.say\(['"]([^'"]+)['"]/);
      const greeting = greetingMatch ? greetingMatch[1] : 'Hello world';

      console.log('makeLiveTestCall - twilioCredentials:', twilioCredentials);
      console.log('makeLiveTestCall - demoMode:', twilioCredentials?.demoMode);

      // Demo mode simulation
      if (twilioCredentials?.demoMode === true) {
        document.getElementById('liveTestStatus').innerHTML =
          '<div style="color: #4fc1ff; padding: 10px; background: #2c313c; border-radius: 4px;">üìû Demo Mode: Simulating call...</div>';

        setTimeout(() => {
          document.getElementById('liveTestStatus').innerHTML = `
            <div style="color: #98c379; padding: 15px; background: #2c313c; border-radius: 4px;">
              <strong>‚úÖ Demo call completed successfully!</strong><br>
              <div style="margin-top: 10px; font-size: 13px; line-height: 1.6;">
                üì± CallSid: CA_demo_${Date.now()}<br>
                üìû Calling: ${yourNumber}
              </div>
              <div style="margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 4px; font-size: 12px;">
                <strong>What would happen in live mode:</strong><br>
                1. Your phone (${yourNumber}) would ring<br>
                2. Answer it and you'd hear: "${greeting}"<br>
                3. You'd hear the menu options<br>
                4. Press 1 or 2 to test Gather, or wait 10 seconds<br>
                5. Call ends with "Goodbye!" and hangs up
              </div>
            </div>
          `;

          // Enable next button after demo call
          const nextBtn = document.getElementById('nextBtn4');
          if (nextBtn) nextBtn.disabled = false;
        }, 2000);
        return;
      }

      document.getElementById('liveTestStatus').innerHTML =
        '<div style="color: #4fc1ff; padding: 10px; background: #2c313c; border-radius: 4px;">üìû Initiating call...</div>';

      try {
        const response = await fetch('/api/tutorial-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'makeCall',
            to: yourNumber,
            from: selectedPhoneNumber,
            ivrTwiml: code, // TwiML will play greeting, gather, then hangup
            ...twilioCredentials
          })
        });

        const data = await response.json();

        if (data.success) {
          document.getElementById('liveTestStatus').innerHTML = `
            <div style="color: #98c379; padding: 15px; background: #2c313c; border-radius: 4px;">
              <strong>‚úÖ Call initiated successfully!</strong><br>
              <div style="margin-top: 10px; font-size: 13px; line-height: 1.6;">
                üì± CallSid: ${data.callSid}<br>
                üìû Calling: ${yourNumber}
              </div>
              <div style="margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 4px; font-size: 12px;">
                <strong>What happens next:</strong><br>
                1. Your phone (${yourNumber}) will ring<br>
                2. Answer it and you'll hear: "${greeting}"<br>
                3. You'll hear the menu options<br>
                4. Press 1 or 2 to test Gather, or wait 10 seconds<br>
                5. Call ends with "Goodbye!" and hangs up
              </div>
            </div>
          `;
        } else {
          document.getElementById('liveTestStatus').innerHTML =
            `<div style="color: #e06c75; padding: 10px; background: #2c313c; border-radius: 4px;">‚ùå Call failed: ${data.error}</div>`;
        }
      } catch (error) {
        document.getElementById('liveTestStatus').innerHTML =
          `<div style="color: #e06c75; padding: 10px; background: #2c313c; border-radius: 4px;">‚ùå Error: ${error.message}</div>`;
      }
    }

    function resetCode4() {
      const isOutbound = callDirection === 'outbound';
      const voice = getDefaultVoice();
      document.getElementById('code4').value = isOutbound ? `exports.handler = function(context, event, callback) {
  const twilio = require('twilio');
  const twiml = new twilio.twiml.VoiceResponse();

  // Greet the caller
  twiml.say('Hello world', { voice: '${voice}' });

  // Create a menu with gather
  const gather = twiml.gather({
    numDigits: 1,
    timeout: 10
  });
  gather.say('Press 1 to connect to God. Press 2 to connect to your mom.', { voice: '${voice}' });

  // After gather timeout, say goodbye and hang up
  twiml.say('Goodbye!', { voice: '${voice}' });
  twiml.hangup();

  callback(null, twiml);
};` : `exports.handler = function(context, event, callback) {
  const twilio = require('twilio');
  const twiml = new twilio.twiml.VoiceResponse();

  // Greet the caller
  twiml.say('Welcome to our service!');

  // Create a gather to collect input
  const gather = twiml.gather({
    numDigits: 1,
    timeout: 10
  });
  gather.say('Press 1 for sales, 2 for support.');

  // After gather timeout or completion, say goodbye and hang up
  twiml.say('Thank you for calling. Goodbye!');
  twiml.hangup();

  callback(null, twiml);
};`;
      document.getElementById('console4').innerHTML = '';
      document.getElementById('step4Status').innerHTML = '';
    }

    // =========================================================================
    // STEP 7: PROMPT ENGINEERING - Master AI Prompting
    // =========================================================================

    function renderStep7_PromptEngineering() {
      return `
        <div class="step-content active">
          <div class="step-header">
            <h2>Step 7: Prompt Engineering - The Most Important Step</h2>
            <p>Your system prompt is THE MOST IMPORTANT part of your Voice AI. Learn how to craft effective prompts for voice interactions.</p>
          </div>

          <div class="service-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            <h3 style="color: white; margin: 0 0 15px 0;">‚ö° Why Prompt Engineering Matters</h3>
            <p style="color: rgba(255,255,255,0.95); line-height: 1.6;">
              The system prompt defines your AI's personality, capabilities, and behavior. A great prompt makes the difference between:
            </p>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
              <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px;">
                <div style="font-size: 18px; margin-bottom: 5px;">‚ùå Bad AI</div>
                <div style="font-size: 14px; opacity: 0.9;">Robotic, rambling, confused, unhelpful</div>
              </div>
              <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px;">
                <div style="font-size: 18px; margin-bottom: 5px;">‚úÖ Great AI</div>
                <div style="font-size: 14px; opacity: 0.9;">Natural, concise, helpful, professional</div>
              </div>
            </div>
          </div>

          <div class="service-card">
            <h3>üìö Essential Prompt Engineering Resources</h3>
            <p>Study these resources to master AI prompting for voice applications:</p>

            <div style="display: grid; gap: 15px; margin-top: 20px;">
              <!-- OpenAI -->
              <div style="border: 2px solid #10a37f; border-radius: 8px; padding: 20px; background: #f7fef9;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                  <div style="background: #10a37f; color: white; padding: 8px 12px; border-radius: 6px; font-weight: 600;">OpenAI</div>
                  <div style="font-size: 18px; font-weight: 600; color: #333;">Prompt Engineering Guide</div>
                </div>
                <p style="color: #666; margin-bottom: 12px;">Official guide from OpenAI with best practices, examples, and techniques.</p>
                <a href="https://platform.openai.com/docs/guides/prompt-engineering" target="_blank"
                   style="display: inline-block; padding: 10px 20px; background: #10a37f; color: white; text-decoration: none; border-radius: 6px; font-weight: 600;">
                  üìñ Read Guide ‚Üí
                </a>
              </div>

              <!-- Twilio -->
              <div style="border: 2px solid #F22F46; border-radius: 8px; padding: 20px; background: #fef5f6;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                  <div style="background: #F22F46; color: white; padding: 8px 12px; border-radius: 6px; font-weight: 600;">Twilio</div>
                  <div style="font-size: 18px; font-weight: 600; color: #333;">ConversationRelay Best Practices</div>
                </div>
                <p style="color: #666; margin-bottom: 12px;">Voice-specific prompting techniques for Twilio ConversationRelay.</p>
                <a href="https://www.twilio.com/docs/voice/conversationrelay/quickstart" target="_blank"
                   style="display: inline-block; padding: 10px 20px; background: #F22F46; color: white; text-decoration: none; border-radius: 6px; font-weight: 600;">
                  üéôÔ∏è View Docs ‚Üí
                </a>
              </div>

              <!-- Learn Prompting -->
              <div style="border: 2px solid #3b82f6; border-radius: 8px; padding: 20px; background: #f5f9ff;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                  <div style="background: #3b82f6; color: white; padding: 8px 12px; border-radius: 6px; font-weight: 600;">Community</div>
                  <div style="font-size: 18px; font-weight: 600; color: #333;">Learn Prompting (Free Course)</div>
                </div>
                <p style="color: #666; margin-bottom: 12px;">Comprehensive free course covering all aspects of prompt engineering.</p>
                <a href="https://learnprompting.org/" target="_blank"
                   style="display: inline-block; padding: 10px 20px; background: #3b82f6; color: white; text-decoration: none; border-radius: 6px; font-weight: 600;">
                  üöÄ Start Course ‚Üí
                </a>
              </div>

              <!-- Prompt Engineering Guide (GitHub) -->
              <div style="border: 2px solid #6366f1; border-radius: 8px; padding: 20px; background: #f5f6ff;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                  <div style="background: #6366f1; color: white; padding: 8px 12px; border-radius: 6px; font-weight: 600;">GitHub</div>
                  <div style="font-size: 18px; font-weight: 600; color: #333;">Prompt Engineering Guide (DAIR.AI)</div>
                </div>
                <p style="color: #666; margin-bottom: 12px;">Open-source guide with examples, papers, and advanced techniques.</p>
                <a href="https://www.promptingguide.ai/" target="_blank"
                   style="display: inline-block; padding: 10px 20px; background: #6366f1; color: white; text-decoration: none; border-radius: 6px; font-weight: 600;">
                  üìñ Explore Guide ‚Üí
                </a>
              </div>
            </div>
          </div>

          <div class="service-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
            <h3 style="color: white; margin: 0 0 15px 0;">üéØ Voice-Specific Prompting Tips</h3>
            <div style="background: rgba(0,0,0,0.2); padding: 20px; border-radius: 8px;">
              <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
                <li><strong>Keep responses SHORT</strong> - Max 2-3 sentences per turn. People can't process long responses in voice.</li>
                <li><strong>Use conversational language</strong> - Write like you talk. Avoid formal or robotic phrasing.</li>
                <li><strong>Set clear personality</strong> - Give your AI a name, role, and consistent tone.</li>
                <li><strong>Define boundaries</strong> - Tell the AI what it CAN'T do (as important as what it can do).</li>
                <li><strong>Provide examples</strong> - Show good/bad response examples in your prompt.</li>
                <li><strong>Handle edge cases</strong> - What if user is angry? Confused? Says "I don't know"?</li>
                <li><strong>Test with real scenarios</strong> - Try your prompt with difficult conversations.</li>
              </ul>
            </div>
          </div>

          <div class="service-card">
            <h3>‚úçÔ∏è Craft Your System Prompt</h3>
            <p>Edit the sample prompt below or write your own. This prompt will guide your AI's behavior.</p>

            <div class="code-editor" style="margin-top: 20px;">
              <div class="code-header">
                <span>üìù System Prompt</span>
                <div style="display: flex; gap: 10px;">
                  <button class="btn-copy" onclick="copySystemPrompt()">üìã Copy</button>
                  <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 13px;" onclick="resetSystemPrompt()">Reset to Sample</button>
                </div>
              </div>
              <textarea class="code-textarea" id="systemPrompt" rows="20" style="font-family: system-ui, -apple-system, sans-serif; font-size: 14px;">You are Alex, a friendly and professional AI assistant for Acme Healthcare.

## Your Role
You help patients schedule appointments, answer questions about services, and provide information about the medical practice.

## Personality
- Warm and empathetic
- Professional but conversational
- Patient and clear
- Never rushed or dismissive

## Response Style
- Keep responses under 3 sentences
- Use simple, everyday language
- Ask one question at a time
- Confirm understanding before proceeding

## What You CAN Do
1. Check appointment availability
2. Schedule new appointments
3. Answer questions about services, hours, and location
4. Provide insurance information
5. Give directions to the office

## What You CANNOT Do
- Provide medical advice or diagnosis
- Prescribe medications
- Access patient medical records
- Handle emergencies (direct to 911)
- Discuss other patients

## Example Interactions

GOOD Response:
User: "I need to see a doctor."
You: "I'd be happy to help you schedule an appointment! What type of visit do you need - a general checkup, urgent care, or something specific?"

BAD Response (too long):
User: "I need to see a doctor."
You: "Absolutely! I can definitely help you with that. We offer a variety of appointment types including general checkups, urgent care visits, specialist consultations, and annual physicals. Our office is open Monday through Friday from 9am to 5pm and Saturdays from 10am to 2pm. We accept most major insurance plans including Blue Cross, Aetna, and UnitedHealthcare. What type of appointment were you looking for today?"

## Important Guidelines
- If the user has an emergency, immediately say: "This sounds like an emergency. Please hang up and call 911."
- If you're unsure, ask for clarification rather than guessing
- Always confirm appointment details before booking
- End calls politely: "Is there anything else I can help you with today?"</textarea>
            </div>

            <div class="button-group" style="margin-top: 15px;">
              <button class="btn btn-success" onclick="saveSystemPrompt()">üíæ Save Prompt</button>
            </div>

            <div id="systemPromptStatus" class="status-box"></div>
          </div>

          <!-- Interactive Test Section -->
          <div class="service-card" style="margin-top: 20px;">
            <h3>üß™ Test Your Prompt Interactively</h3>
            <p style="margin-bottom: 15px;">Try different scenarios to see how your AI responds. Type a message and click Test!</p>

            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 15px;">
              <div style="margin-bottom: 15px;">
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #0d122b;">üí¨ User Message</label>
                <input
                  type="text"
                  id="testMessage"
                  placeholder="e.g., Hi, I need to schedule an appointment"
                  style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;"
                  onkeypress="if(event.key === 'Enter') testSingleMessage()"
                />
                <div style="margin-top: 8px; font-size: 12px; color: #666;">
                  üí° Try: greetings, requests, edge cases, or emergencies
                </div>
              </div>

              <div class="button-group" style="margin: 0;">
                <button class="btn btn-test" onclick="testSingleMessage()" style="flex: 1;">
                  ‚ñ∂Ô∏è Test Message
                </button>
                <button class="btn btn-secondary" onclick="runPredefinedTests()" style="flex: 1;">
                  üéØ Run 3 Preset Tests
                </button>
              </div>
            </div>

            <div class="console-output" id="promptTestConsole" style="display: none;"></div>
          </div>

          <div class="service-card">
            <h3>‚úÖ Quick Prompt Engineering Checklist</h3>
            <p>Before moving to the next step, make sure your system prompt has:</p>
            <div style="display: grid; gap: 10px; margin-top: 15px;">
              <label style="display: flex; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 6px; cursor: pointer;">
                <input type="checkbox" id="checkRole" style="margin-right: 12px; width: 20px; height: 20px;">
                <span>‚úÖ Clear role and name (e.g., "You are Sarah, a medical receptionist")</span>
              </label>
              <label style="display: flex; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 6px; cursor: pointer;">
                <input type="checkbox" id="checkPersonality" style="margin-right: 12px; width: 20px; height: 20px;">
                <span>‚úÖ Defined personality traits (friendly, professional, patient, etc.)</span>
              </label>
              <label style="display: flex; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 6px; cursor: pointer;">
                <input type="checkbox" id="checkResponseLength" style="margin-right: 12px; width: 20px; height: 20px;">
                <span>‚úÖ Response length guidelines (e.g., "under 3 sentences")</span>
              </label>
              <label style="display: flex; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 6px; cursor: pointer;">
                <input type="checkbox" id="checkCapabilities" style="margin-right: 12px; width: 20px; height: 20px;">
                <span>‚úÖ List of capabilities (what tools/actions the AI can perform)</span>
              </label>
              <label style="display: flex; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 6px; cursor: pointer;">
                <input type="checkbox" id="checkWorkflow" style="margin-right: 12px; width: 20px; height: 20px;">
                <span>‚úÖ Step-by-step workflow (numbered process for main tasks)</span>
              </label>
              <label style="display: flex; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 6px; cursor: pointer;">
                <input type="checkbox" id="checkExamples" style="margin-right: 12px; width: 20px; height: 20px;">
                <span>‚úÖ Good/bad examples (show desired vs. undesired responses)</span>
              </label>
              <label style="display: flex; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 6px; cursor: pointer;">
                <input type="checkbox" id="checkBoundaries" style="margin-right: 12px; width: 20px; height: 20px;">
                <span>‚úÖ Clear boundaries (what NOT to do, when to escalate, etc.)</span>
              </label>
            </div>

            <button onclick="completePromptEngineeringStep()" id="completePromptBtn" disabled
                    style="width: 100%; margin-top: 20px; padding: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 600; cursor: not-allowed; opacity: 0.5;">
              ‚úÖ I've Reviewed the Resources - Continue
            </button>
            <div id="promptEngineeringStatus" style="margin-top: 15px;"></div>
          </div>

          <!-- Test Your AI Voice Bot - Shows after prompt is saved and tested -->
          <div id="step7VoiceTestSection" style="margin: 30px 0; padding: 25px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 12px; border: 3px solid #047857; box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3); display: none;">
            <div style="text-align: center;">
              <h3 style="color: white; margin: 0 0 10px 0; font-size: 1.5rem;">üìû Ready to Test Your AI Voice Bot?</h3>
              <p style="color: rgba(255,255,255,0.95); margin-bottom: 20px; font-size: 1.1rem; line-height: 1.6;">
                Your system prompt is ready! Now test your AI with a real voice call.
              </p>

              <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 20px; border-radius: 8px; margin: 20px 0;">
                ${callDirection === 'inbound' ? `
                  <p style="color: rgba(255,255,255,0.9); margin: 0 0 10px 0; font-size: 0.95rem;">
                    üì± <strong>Call this number to test:</strong>
                  </p>
                  <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-top: 10px;">
                    <div style="font-size: 2rem; font-weight: bold; color: white; font-family: 'Courier New', monospace; letter-spacing: 2px;">
                      ${selectedPhoneNumber || 'Configure phone number in Step 3'}
                    </div>
                    <button
                      onclick="copyPhoneNumber()"
                      style="padding: 10px 20px; background: white; color: #059669; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 1rem; transition: all 0.3s;"
                      onmouseover="this.style.background='#f0fdf4'; this.style.transform='scale(1.05)'"
                      onmouseout="this.style.background='white'; this.style.transform='scale(1)'">
                      üìã Copy
                    </button>
                  </div>
                ` : `
                  <p style="color: rgba(255,255,255,0.9); margin: 0 0 15px 0; font-size: 0.95rem;">
                    üìû <strong>Test your AI bot with an outbound call</strong>
                  </p>
                  <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: white;">
                      Your Phone Number (to receive AI call):
                    </label>
                    <input type="tel" id="testAICallNumber" placeholder="+12345678901" value="${window.savedTestPhoneNumber || ''}"
                           style="width: 100%; padding: 12px; background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.3); border-radius: 6px; font-size: 16px; font-family: 'Courier New', monospace;">
                    <p style="font-size: 12px; color: rgba(255,255,255,0.8); margin: 5px 0 0 0;">Enter YOUR number in E.164 format (e.g., +1234567890)</p>
                  </div>
                  <button onclick="makeAITestCall()" class="btn btn-primary" style="width: 100%; background: white; color: #059669; font-weight: 600; font-size: 1.1rem; padding: 15px;">
                    üìû Call Me Now with AI
                  </button>
                  <div id="aiTestCallStatus" style="margin-top: 15px;"></div>
                  <p style="color: rgba(255,255,255,0.8); margin: 15px 0 0 0; font-size: 0.9rem;">
                    Calling from: <strong style="color: white;">${selectedPhoneNumber || 'No number configured'}</strong>
                  </p>
                `}
              </div>

              <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin-top: 20px; text-align: left;">
                <p style="color: white; margin: 0 0 10px 0; font-weight: 600; font-size: 1rem;">
                  ‚úÖ What to expect:
                </p>
                <ul style="color: rgba(255,255,255,0.9); margin: 0; padding-left: 20px; line-height: 1.8;">
                  <li>AI will use your custom system prompt</li>
                  <li>Natural conversation powered by OpenAI</li>
                  <li>Voice: <strong>${getDefaultVoice()}</strong> (${getTTSProviderName()})</li>
                  <li>Real-time ConversationRelay streaming</li>
                </ul>
              </div>

              <p style="color: rgba(255,255,255,0.85); margin: 20px 0 0 0; font-size: 0.9rem; font-style: italic;">
                üí° Tip: Test the scenarios from your system prompt to verify the AI behaves correctly!
              </p>
            </div>
          </div>

          <div class="button-group">
            <button class="btn btn-secondary" onclick="prevStep()">‚Üê Back</button>
            <button class="btn btn-primary" id="nextBtn7" onclick="nextStep()" disabled>
              Next: Add Tools & Functions ‚Üí
            </button>
          </div>
        </div>
      `;
    }

    let systemPromptSaved = false;
    let customSystemPrompt = '';

    const defaultSystemPrompt = `You are Alex, a friendly and professional AI assistant for Acme Healthcare.

## Your Role
You help patients schedule appointments, answer questions about services, and provide information about the medical practice.

## Personality
- Warm and empathetic
- Professional but conversational
- Patient and clear
- Never rushed or dismissive

## Response Style
- Keep responses under 3 sentences
- Use simple, everyday language
- Ask one question at a time
- Confirm understanding before proceeding

## What You CAN Do
1. Check appointment availability
2. Schedule new appointments
3. Answer questions about services, hours, and location
4. Provide insurance information
5. Give directions to the office

## What You CANNOT Do
- Provide medical advice or diagnosis
- Prescribe medications
- Access patient medical records
- Handle emergencies (direct to 911)
- Discuss other patients

## Example Interactions

GOOD Response:
User: "I need to see a doctor."
You: "I'd be happy to help you schedule an appointment! What type of visit do you need - a general checkup, urgent care, or something specific?"

BAD Response (too long):
User: "I need to see a doctor."
You: "Absolutely! I can definitely help you with that. We offer a variety of appointment types including general checkups, urgent care visits, specialist consultations, and annual physicals. Our office is open Monday through Friday from 9am to 5pm and Saturdays from 10am to 2pm. We accept most major insurance plans including Blue Cross, Aetna, and UnitedHealthcare. What type of appointment were you looking for today?"

## Important Guidelines
- If the user has an emergency, immediately say: "This sounds like an emergency. Please hang up and call 911."
- If you're unsure, ask for clarification rather than guessing
- Always confirm appointment details before booking
- End calls politely: "Is there anything else I can help you with today?"`;

    function saveSystemPrompt() {
      const prompt = document.getElementById('systemPrompt')?.value || '';
      if (prompt.trim().length < 50) {
        showStatus('systemPromptStatus', 'error', '‚ùå Prompt is too short. Add more detail about your AI\'s role and behavior.');
        return;
      }

      customSystemPrompt = prompt;
      systemPromptSaved = true;
      showStatus('systemPromptStatus', 'success', '‚úÖ System prompt saved! This will be used in your AI conversations. Test it below or continue to the checklist.');
      saveProgressToStorage();
    }

    function resetSystemPrompt() {
      document.getElementById('systemPrompt').value = defaultSystemPrompt;
      showStatus('systemPromptStatus', 'info', '‚ÑπÔ∏è Reset to sample prompt. Edit it to match your use case!');
    }

    function copySystemPrompt() {
      const prompt = document.getElementById('systemPrompt').value;
      navigator.clipboard.writeText(prompt).then(() => {
        showStatus('systemPromptStatus', 'success', '‚úÖ Prompt copied to clipboard!');
      }).catch(() => {
        showStatus('systemPromptStatus', 'error', '‚ùå Failed to copy. Please select and copy manually.');
      });
    }

    // Test with a single user message
    async function testSingleMessage() {
      const prompt = document.getElementById('systemPrompt')?.value || '';
      const userMessage = document.getElementById('testMessage')?.value.trim();
      const console = document.getElementById('promptTestConsole');

      if (!openaiApiKey) {
        showStatus('systemPromptStatus', 'error', '‚ùå OpenAI API key required. Configure it in Step 5.');
        return;
      }

      if (prompt.trim().length < 50) {
        showStatus('systemPromptStatus', 'error', '‚ùå Prompt is too short. Save your prompt first.');
        return;
      }

      if (!userMessage) {
        showStatus('systemPromptStatus', 'error', '‚ùå Please enter a message to test.');
        return;
      }

      console.style.display = 'block';
      console.innerHTML = `<div class="console-line">üí¨ Testing: "${userMessage}"</div>`;
      showStatus('systemPromptStatus', 'info', '‚è≥ Sending to OpenAI...');

      try {
        const response = await fetch('/api/tutorial-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'testOpenAI',
            systemPrompt: prompt,
            message: userMessage,
            openaiApiKey: openaiApiKey,
            demoMode: twilioCredentials?.demoMode
          })
        });

        const data = await response.json();

        if (data.success) {
          console.innerHTML += `<div class="console-line success">ü§ñ AI Response: "${data.response}"</div>`;
          showStatus('systemPromptStatus', 'success', '‚úÖ Test complete!');

          // Clear input for next test
          document.getElementById('testMessage').value = '';
        } else {
          console.innerHTML += `<div class="console-line error">‚ùå Error: ${data.error}</div>`;
          showStatus('systemPromptStatus', 'error', `‚ùå Test failed: ${data.error}`);
        }

      } catch (error) {
        console.innerHTML += `<div class="console-line error">‚ùå Test failed: ${error.message}</div>`;
        showStatus('systemPromptStatus', 'error', `‚ùå Test failed: ${error.message}`);
      }
    }

    // Run predefined test scenarios
    async function runPredefinedTests() {
      const prompt = document.getElementById('systemPrompt')?.value || '';
      const console = document.getElementById('promptTestConsole');

      if (!openaiApiKey) {
        showStatus('systemPromptStatus', 'error', '‚ùå OpenAI API key required. Configure it in Step 5.');
        return;
      }

      if (prompt.trim().length < 50) {
        showStatus('systemPromptStatus', 'error', '‚ùå Prompt is too short. Add more detail first.');
        return;
      }

      console.style.display = 'block';
      console.innerHTML = '<div class="console-line">üß™ Running 3 preset test scenarios...</div>';
      showStatus('systemPromptStatus', 'info', '‚è≥ Testing...');

      const testScenarios = [
        { user: "Hi, I need to schedule an appointment.", expected: "Should be friendly, ask about type of visit, keep it short" },
        { user: "What are your hours?", expected: "Should provide hours concisely" },
        { user: "I am having chest pain right now!", expected: "Should recognize emergency and direct to 911" }
      ];

      try {
        for (let i = 0; i < testScenarios.length; i++) {
          const scenario = testScenarios[i];
          console.innerHTML += `<div class="console-line info">
üìù Test ${i + 1}: "${scenario.user}"
Expected: ${scenario.expected}</div>`;

          const response = await fetch('/api/tutorial-proxy', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              action: 'testOpenAI',
              systemPrompt: prompt,
              message: scenario.user,
              openaiApiKey: openaiApiKey,
              demoMode: twilioCredentials?.demoMode
            })
          });

          const data = await response.json();

          if (data.success) {
            console.innerHTML += `<div class="console-line success">ü§ñ AI: "${data.response}"</div>`;
          } else {
            console.innerHTML += `<div class="console-line error">‚ùå Error: ${data.error}</div>`;
          }
        }

        console.innerHTML += '<div class="console-line success">‚úÖ All tests complete! Review the responses above and refine your prompt if needed.</div>';
        showStatus('systemPromptStatus', 'success', '‚úÖ Tests complete! Review the AI responses in the console above.');

      } catch (error) {
        console.innerHTML += `<div class="console-line error">‚ùå Test failed: ${error.message}</div>`;
        showStatus('systemPromptStatus', 'error', `‚ùå Test failed: ${error.message}`);
      }
    }

    function completePromptEngineeringStep() {
      if (!systemPromptSaved) {
        showStatus('promptEngineeringStatus', 'warning', '‚ö†Ô∏è Please save your system prompt before continuing.');
        return;
      }

      promptEngineeringComplete = true;
      showStatus('promptEngineeringStatus', 'success', '‚úÖ Perfect! Now test your AI with a real voice call below.');

      // Reveal the voice test section
      const voiceTestSection = document.getElementById('step7VoiceTestSection');
      if (voiceTestSection) {
        voiceTestSection.style.display = 'block';
        setTimeout(() => {
          voiceTestSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }, 300);
      }

      // Enable Next button
      document.getElementById('nextBtn7').disabled = false;
      saveProgressToStorage();
    }

    // Enable "Complete" button when at least 4 checkboxes are checked
    document.addEventListener('change', (e) => {
      if (e.target.type === 'checkbox' && e.target.id && e.target.id.startsWith('check')) {
        const checkboxes = document.querySelectorAll('input[type="checkbox"][id^="check"]');
        const checked = Array.from(checkboxes).filter(cb => cb.checked).length;
        const completeBtn = document.getElementById('completePromptBtn');
        if (completeBtn) {
          if (checked >= 4) {
            completeBtn.disabled = false;
            completeBtn.style.opacity = '1';
            completeBtn.style.cursor = 'pointer';
          } else {
            completeBtn.disabled = true;
            completeBtn.style.opacity = '0.5';
            completeBtn.style.cursor = 'not-allowed';
          }
        }
      }
    });

    // =========================================================================
    // STEP 8: TOOLING & KNOWLEDGE BASE - Add Functions and Context
    // =========================================================================

    function renderStep8_Tooling() {
      return `
        <div class="step-content active">
          <div class="step-header">
            <h2>Step 7: Add Tooling & Knowledge Base (Optional)</h2>
            <p>Enhance your AI with custom functions and domain knowledge</p>
          </div>

          <div class="instructions">
            <h3>üõ†Ô∏è What This Step Covers</h3>
            <p>Before we move to AI-powered conversations, you can optionally add:</p>
            <ul style="margin-left: 20px; line-height: 1.8;">
              <li><strong>Tools/Functions</strong> - Let your AI take actions (check calendar, book appointments, look up data)</li>
              <li><strong>Knowledge Base</strong> - Give your AI context about your business, products, or services</li>
            </ul>
            <p style="margin-top: 15px;">
              üìö <strong>Documentation:</strong>
              <a href="https://platform.openai.com/docs/guides/function-calling" target="_blank">OpenAI Function Calling</a> |
              <a href="https://platform.openai.com/docs/assistants/tools" target="_blank">AI Tools</a>
            </p>
          </div>

          <div class="service-card" style="background: linear-gradient(135deg, #61afef 0%, #2c313c 100%);">
            <h3 style="color: white; margin-bottom: 15px;">üîß Production-Ready WebSocket Handler with Tools</h3>
            <p style="color: #e5e5e5;">Complete implementation with appointment booking, knowledge base, and SMS notifications:</p>
          </div>

          <div class="code-editor">
            <div class="code-header">
              <span>üìù WebSocket Handler with Tools & Knowledge Base</span>
              <div style="display: flex; gap: 10px;">
                <button class="btn-copy" onclick="copyCode('code9')">üìã Copy Code</button>
                <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 13px;" onclick="showToolingSolution()">üí° Show Solution</button>
                <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 13px;" onclick="resetCode9()">Reset</button>
              </div>
            </div>
            <textarea class="code-textarea" id="code9" rows="30">exports.handler = async function(context, event, callback) {
  const OpenAI = require('openai');
  const twilio = require('twilio');

  const openai = new OpenAI({ apiKey: context.OPENAI_API_KEY });
  const twilioClient = twilio(context.ACCOUNT_SID, context.AUTH_TOKEN);

  const response = new Twilio.Response();
  response.setStatusCode(200);

  // Knowledge Base - Customize for your business
  const knowledgeBase = '\\n' +
  '  Company: Acme Healthcare\\n' +
  '  Services: Primary care, vaccinations, annual checkups, lab work\\n' +
  '  Hours: Mon-Fri 9am-5pm, Sat 10am-2pm, Closed Sunday\\n' +
  '  Location: 123 Main St, San Francisco CA 94102\\n' +
  '  Phone: ' + (context.DEFAULT_TWILIO_NUMBER || '+1-555-0100') + '\\n' +
  '  Insurance: We accept Blue Cross, Aetna, UnitedHealthcare, Medicare\\n' +
  '  Parking: Free parking available in rear lot\\n';

  // Tool Definitions
  const tools = [
    {
      type: "function",
      name: "check_availability",
      description: "Check available appointment slots for a given date",
      parameters: {
        type: "object",
        properties: {
          date: { type: "string", description: "Date (YYYY-MM-DD)" }
        },
        required: ["date"]
      }
    },
    {
      type: "function",
      name: "book_appointment",
      description: "Book an appointment for a customer",
      parameters: {
        type: "object",
        properties: {
          date: { type: "string", description: "Date (YYYY-MM-DD)" },
          time: { type: "string", description: "Time (HH:MM 24hr)" },
          customerName: { type: "string", description: "Customer name" },
          phone: { type: "string", description: "Phone number" },
          service: { type: "string", description: "Service type" }
        },
        required: ["date", "time", "customerName", "phone"]
      }
    },
    {
      type: "function",
      name: "send_confirmation_sms",
      description: "Send appointment confirmation via SMS",
      parameters: {
        type: "object",
        properties: {
          phone: { type: "string", description: "Customer phone" },
          message: { type: "string", description: "Confirmation message" }
        },
        required: ["phone", "message"]
      }
    }
  ];

  // System Prompt - Critical for AI behavior!
  // Best practices: Be specific, set boundaries, define personality
  const systemPrompt = \`You are Sarah, a professional medical receptionist for Acme Healthcare.

ROLE & PERSONALITY:
- Friendly but professional tone
- Speak naturally, use conversational language
- Show empathy and patience
- Keep responses concise (under 3 sentences typically)

COMPANY INFORMATION:
\${knowledgeBase}

YOUR CAPABILITIES:
You have access to three tools:
1. check_availability - Check open appointment slots for a date
2. book_appointment - Book confirmed appointments
3. send_confirmation_sms - Send SMS confirmations

WORKFLOW FOR BOOKING:
1. Greet caller warmly and ask how you can help
2. If booking, collect: preferred date, time, name, phone, service type
3. Use check_availability to see open slots (say "Let me check that for you" first)
4. Confirm ALL details before booking
5. Use book_appointment once confirmed (say "I'm booking that for you now" first)
6. Use send_confirmation_sms to send confirmation
7. Provide appointment details verbally AND via SMS

IMPORTANT GUIDELINES:
- ALWAYS confirm date, time, name, and phone before booking
- Use interstitials before tool calls ("Let me check...", "One moment...")
- If caller is vague, ask clarifying questions
- If no slots available, offer alternative dates
- Keep HIPAA in mind - don't ask for sensitive medical info over phone
- If you can't help, offer to transfer or take a message
- End calls gracefully, ask if there's anything else

RESPONSE STYLE:
‚ùå DON'T: "I have checked the availability for the requested date and determined that..."
‚úÖ DO: "Let me check that for you... Great! We have openings at 9am, 11am, and 2pm. Which works best?"

Remember: You're having a natural conversation, not reading a script!\`;

  // Handle WebSocket upgrade
  if (!event.request || event.request.headers['upgrade'] !== 'websocket') {
    response.setBody('WebSocket connection required');
    return callback(null, response);
  }

  const ws = event.request;
  console.log('WebSocket connected');

  // STATE MANAGEMENT - Track where we are in the conversation
  let conversationState = {
    stage: 'greeting',           // greeting, collecting_info, confirming, booking, complete
    appointmentData: {},         // Store collected information
    lastPrompt: null,            // Track what we last asked
    attemptCount: 0              // How many times we've tried to collect info
  };

  // Store conversation history
  const conversationHistory = [{ role: 'system', content: systemPrompt }];

  // STATE-AWARE PROMPT INJECTION
  // This function adds context based on current state
  function getStateContext() {
    const statePrompts = {
      greeting: \`
        CURRENT STATE: Greeting/Initial Contact
        - You just answered the call
        - Ask how you can help today
        - Listen for booking requests or questions
      \`,
      collecting_info: \`
        CURRENT STATE: Collecting Appointment Information
        - You're gathering: date, time, name, phone, service type
        - Current data collected: \${JSON.stringify(conversationState.appointmentData)}
        - Still need: \${getMissingFields().join(', ') || 'nothing - ready to confirm!'}
        - Ask for ONE missing field at a time (don't overwhelm caller)
        - Attempt #\${conversationState.attemptCount} - if > 2, offer to have someone call them back
      \`,
      confirming: \`
        CURRENT STATE: Confirming Details
        - You have all information needed
        - Data to confirm: \${JSON.stringify(conversationState.appointmentData)}
        - Read back ALL details clearly
        - Ask "Does that sound correct?" or "Should I book this for you?"
        - If confirmed, proceed to booking
        - If changes needed, go back to collecting_info
      \`,
      booking: \`
        CURRENT STATE: Booking in Progress
        - You're actively booking the appointment
        - Use the book_appointment tool
        - Don't ask more questions, just confirm booking
      \`,
      complete: \`
        CURRENT STATE: Booking Complete
        - Appointment is booked
        - Confirm appointment details one final time
        - Ask if there's anything else you can help with
        - If no, end gracefully
      \`
    };

    return statePrompts[conversationState.stage] || '';
  }

  function getMissingFields() {
    const required = ['date', 'time', 'customerName', 'phone'];
    return required.filter(field => !conversationState.appointmentData[field]);
  }

  function updateState(userMessage) {
    // Extract info from user message (simple pattern matching)
    // In production, you'd use more sophisticated NER/entity extraction

    // Check for date
    const dateMatch = userMessage.match(/(\d{4}-\d{2}-\d{2}|tomorrow|today|next week|monday|tuesday|wednesday|thursday|friday)/i);
    if (dateMatch) conversationState.appointmentData.date = dateMatch[0];

    // Check for time
    const timeMatch = userMessage.match(/(\d{1,2}:\d{2}|\d{1,2}\s*(am|pm))/i);
    if (timeMatch) conversationState.appointmentData.time = timeMatch[0];

    // Check for phone
    const phoneMatch = userMessage.match(/(\d{3}[-.]?\d{3}[-.]?\d{4})/);
    if (phoneMatch) conversationState.appointmentData.phone = phoneMatch[0];

    // Update stage based on collected data
    const missing = getMissingFields();
    if (conversationState.stage === 'greeting' && userMessage.match(/book|appointment|schedule/i)) {
      conversationState.stage = 'collecting_info';
    } else if (conversationState.stage === 'collecting_info' && missing.length === 0) {
      conversationState.stage = 'confirming';
    }

    console.log('State updated:', conversationState);
  }

  ws.on('message', async (data) => {
    try {
      const message = JSON.parse(data);

      switch (message.event) {
        case 'start':
          console.log('Call started:', message.streamSid);
          break;

        case 'transcript':
          console.log('User said:', message.transcript);

          // Update conversation state based on user input
          updateState(message.transcript);

          // Add user message to history
          conversationHistory.push({
            role: 'user',
            content: message.transcript
          });

          // Inject state-aware context
          const stateContext = getStateContext();
          conversationHistory.push({
            role: 'system',
            content: stateContext
          });

          // Call OpenAI with tools
          const completion = await openai.chat.completions.create({
            model: 'gpt-4',
            messages: conversationHistory,
            tools: tools,
            tool_choice: 'auto'
          });

          const assistantMessage = completion.choices[0].message;
          conversationHistory.push(assistantMessage);

          // Check if AI wants to call a tool
          if (assistantMessage.tool_calls) {
            for (const toolCall of assistantMessage.tool_calls) {
              const functionName = toolCall.function.name;
              const functionArgs = JSON.parse(toolCall.function.arguments);

              console.log(\`Calling tool: \${functionName}\`, functionArgs);

              // Execute the tool
              let toolResult;
              switch (functionName) {
                case 'check_availability':
                  toolResult = await checkAvailability(functionArgs);
                  break;
                case 'book_appointment':
                  // Update state - we're now booking
                  conversationState.stage = 'booking';
                  toolResult = await bookAppointment(functionArgs);
                  // Move to complete state after booking
                  conversationState.stage = 'complete';
                  break;
                case 'send_confirmation_sms':
                  toolResult = await sendConfirmationSMS(functionArgs, twilioClient, context);
                  break;
                default:
                  toolResult = { error: 'Unknown tool' };
              }

              // Add tool result to conversation
              conversationHistory.push({
                role: 'tool',
                tool_call_id: toolCall.id,
                content: JSON.stringify(toolResult)
              });
            }

            // Get AI's final response after tool execution
            const finalCompletion = await openai.chat.completions.create({
              model: 'gpt-4',
              messages: conversationHistory
            });

            const finalMessage = finalCompletion.choices[0].message.content;
            conversationHistory.push({ role: 'assistant', content: finalMessage });

            // Send to caller
            ws.send(JSON.stringify({
              event: 'text',
              text: finalMessage
            }));
          } else {
            // No tool call, just send AI response
            ws.send(JSON.stringify({
              event: 'text',
              text: assistantMessage.content
            }));
          }
          break;

        case 'stop':
          console.log('Call ended');
          ws.close();
          break;
      }
    } catch (error) {
      console.error('Error:', error);
      ws.send(JSON.stringify({
        event: 'text',
        text: 'I apologize, but I encountered an error. Could you please repeat that?'
      }));
    }
  });

  ws.on('error', (error) => console.error('WebSocket error:', error));
  ws.on('close', () => console.log('WebSocket closed'));

  callback(null, response);

  // Tool Implementation Functions
  async function checkAvailability(args) {
    // TODO: Connect to your scheduling system
    // This is a mock implementation
    const { date } = args;
    const availableSlots = ['9:00 AM', '11:00 AM', '2:00 PM', '4:00 PM'];
    return {
      date,
      available: true,
      slots: availableSlots,
      message: \`Available slots for \${date}: \${availableSlots.join(', ')}\`
    };
  }

  async function bookAppointment(args) {
    // TODO: Connect to your scheduling system
    // This is a mock implementation
    const { date, time, customerName, phone, service } = args;
    const appointmentId = 'APT-' + Date.now();

    console.log('Booking appointment:', { date, time, customerName, phone, service });

    return {
      success: true,
      appointmentId,
      date,
      time,
      message: \`Appointment booked! ID: \${appointmentId} for \${customerName} on \${date} at \${time}\`
    };
  }

  async function sendConfirmationSMS(args, twilioClient, context) {
    try {
      const { phone, message } = args;

      const sms = await twilioClient.messages.create({
        body: message,
        from: context.DEFAULT_TWILIO_NUMBER,
        to: phone
      });

      return {
        success: true,
        messageSid: sms.sid,
        message: 'Confirmation SMS sent successfully'
      };
    } catch (error) {
      console.error('SMS error:', error);
      return {
        success: false,
        error: error.message
      };
    }
  }
};</textarea>
          </div>

          <div class="service-card" style="background: linear-gradient(135deg, #61afef 0%, #2c313c 100%); margin-top: 20px;">
            <h3 style="color: white; margin-bottom: 15px;">üìù Prompt Engineering for Voice AI</h3>
            <p style="color: #e5e5e5; margin-bottom: 15px;">The system prompt is THE MOST IMPORTANT part of your voice AI. Here's what makes it effective:</p>
            <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 8px; margin-bottom: 15px;">
              <h4 style="color: #98c379; margin-top: 0;">‚úÖ What We Did Right:</h4>
              <ul style="color: #e5e5e5; line-height: 1.8; margin: 10px 0;">
                <li><strong>Named Persona:</strong> "You are Sarah" - gives the AI a consistent identity</li>
                <li><strong>Clear Role & Boundaries:</strong> Defines what the AI can and cannot do</li>
                <li><strong>Personality Traits:</strong> "Friendly but professional, patient, empathetic"</li>
                <li><strong>Response Length:</strong> "Under 3 sentences" - prevents rambling</li>
                <li><strong>Workflow Steps:</strong> Numbered process ensures consistency</li>
                <li><strong>Example Responses:</strong> Shows good vs. bad responses</li>
                <li><strong>Safety Guidelines:</strong> HIPAA awareness, when to transfer</li>
              </ul>
            </div>
            <div style="background: rgba(255,0,0,0.2); padding: 20px; border-radius: 8px; border: 1px solid rgba(255,0,0,0.4); margin-bottom: 15px;">
              <h4 style="color: #e06c75; margin-top: 0;">‚ùå Common Prompt Engineering Mistakes:</h4>
              <ul style="color: #e5e5e5; line-height: 1.8; margin: 10px 0;">
                <li><strong>Too Vague:</strong> "You're a helpful assistant" ‚Üí Be specific about the role!</li>
                <li><strong>No Personality:</strong> AI sounds robotic ‚Üí Define tone and speaking style</li>
                <li><strong>No Length Limits:</strong> AI rambles ‚Üí Set response length expectations</li>
                <li><strong>Missing Edge Cases:</strong> Doesn't handle "I don't know" ‚Üí Add fallback instructions</li>
                <li><strong>No Examples:</strong> AI interprets incorrectly ‚Üí Show good/bad examples</li>
                <li><strong>Ignoring Medium:</strong> Text prompts on voice ‚Üí Optimize for spoken conversation!</li>
              </ul>
            </div>
            <div style="background: rgba(100,200,255,0.2); padding: 20px; border-radius: 8px; border: 1px solid rgba(100,200,255,0.4);">
              <h4 style="color: #61afef; margin-top: 0;">üí¨ Using Interstitials for Better UX</h4>
              <p style="color: #e5e5e5; margin-bottom: 10px;"><strong>Interstitials</strong> are short filler phrases spoken while the AI processes tool calls or API requests. They prevent awkward silence and keep callers engaged.</p>
              <div style="color: #e5e5e5; line-height: 1.8;">
                <strong style="color: #98c379;">Examples of good interstitials:</strong>
                <ul style="margin: 10px 0;">
                  <li>"Let me check that for you..."</li>
                  <li>"One moment while I look that up..."</li>
                  <li>"I'm booking that appointment now..."</li>
                  <li>"Give me just a second to confirm availability..."</li>
                </ul>
                <p style="margin-top: 10px; font-size: 13px; opacity: 0.9;">
                  <strong>Tip:</strong> Include interstitials in your system prompt instructions for tool usage. For example: "Before checking availability, say 'Let me check that for you' to keep the caller engaged."
                </p>
              </div>
            </div>
          </div>

          <div class="service-card" style="background: linear-gradient(135deg, #c678dd 0%, #2c313c 100%); margin-top: 20px;">
            <h3 style="color: white; margin-bottom: 15px;">üîÑ State-Based Prompt Engineering (Advanced)</h3>
            <p style="color: #e5e5e5; margin-bottom: 15px;">This code implements <strong>state-based prompt engineering</strong> - a technique that makes AI conversations more reliable and natural.</p>

            <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 8px; margin-bottom: 15px;">
              <h4 style="color: #98c379; margin-top: 0;">üéØ Why State Management Matters:</h4>
              <ul style="color: #e5e5e5; line-height: 1.8; margin: 10px 0;">
                <li><strong>Prevents AI from wandering:</strong> Without state, AI might jump topics randomly</li>
                <li><strong>Ensures data collection:</strong> Tracks what info we still need</li>
                <li><strong>Handles errors gracefully:</strong> Knows when to give up and escalate</li>
                <li><strong>Creates natural flow:</strong> Greeting ‚Üí Collecting ‚Üí Confirming ‚Üí Booking ‚Üí Complete</li>
              </ul>
            </div>

            <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 8px; margin-bottom: 15px;">
              <h4 style="color: #61afef; margin-top: 0;">üìä Our State Machine:</h4>
              <div style="font-family: monospace; color: #e5e5e5; font-size: 13px; line-height: 1.8;">
                <div style="margin: 5px 0;">1Ô∏è‚É£ <strong style="color: #98c379;">greeting</strong> ‚Üí Ask how to help</div>
                <div style="margin: 5px 0 5px 20px;">‚¨áÔ∏è User mentions "appointment"</div>
                <div style="margin: 5px 0;">2Ô∏è‚É£ <strong style="color: #61afef;">collecting_info</strong> ‚Üí Gather date, time, name, phone</div>
                <div style="margin: 5px 0 5px 20px;">‚¨áÔ∏è All required fields collected</div>
                <div style="margin: 5px 0;">3Ô∏è‚É£ <strong style="color: #e5c07b;">confirming</strong> ‚Üí Read back details, ask for confirmation</div>
                <div style="margin: 5px 0 5px 20px;">‚¨áÔ∏è User confirms "yes"</div>
                <div style="margin: 5px 0;">4Ô∏è‚É£ <strong style="color: #c678dd;">booking</strong> ‚Üí Execute book_appointment tool</div>
                <div style="margin: 5px 0 5px 20px;">‚¨áÔ∏è Booking successful</div>
                <div style="margin: 5px 0;">5Ô∏è‚É£ <strong style="color: #56b6c2;">complete</strong> ‚Üí Confirm details, ask if anything else needed</div>
              </div>
            </div>

            <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 8px;">
              <h4 style="color: #e5c07b; margin-top: 0;">üí° Key Techniques Used:</h4>
              <ul style="color: #e5e5e5; line-height: 1.8; margin: 10px 0;">
                <li><strong>Dynamic Context Injection:</strong> <code>getStateContext()</code> injects state-specific instructions on every turn</li>
                <li><strong>State Tracking Object:</strong> <code>conversationState</code> stores stage, collected data, attempt count</li>
                <li><strong>Entity Extraction:</strong> <code>updateState()</code> extracts dates, times, phone numbers from user speech</li>
                <li><strong>Missing Field Detection:</strong> <code>getMissingFields()</code> tells AI what to ask for next</li>
                <li><strong>Progress Tracking:</strong> Attempt counter prevents infinite loops ("if > 2 attempts, escalate")</li>
              </ul>
            </div>
          </div>

          <div class="service-card" style="background: linear-gradient(135deg, #e5c07b 0%, #2c313c 100%); margin-top: 20px;">
            <h4 style="color: white;">üìã What's Included in This Code</h4>
            <ul style="color: #e5e5e5; line-height: 1.8;">
              <li><strong>3 Production Tools:</strong> Check availability, book appointments, send SMS confirmations</li>
              <li><strong>Knowledge Base:</strong> Company info, hours, services, insurance - customize for your business</li>
              <li><strong>Conversation History:</strong> Maintains context across the call</li>
              <li><strong>Error Handling:</strong> Graceful fallbacks if tools fail</li>
              <li><strong>Real SMS Integration:</strong> Sends actual confirmation texts via Twilio</li>
            </ul>
          </div>

          <div class="service-card" style="background: linear-gradient(135deg, #98c379 0%, #2c313c 100%); margin-top: 20px;">
            <h4 style="color: white;">üîß Customize for Your Business</h4>
            <ol style="color: #e5e5e5; line-height: 1.8;">
              <li>Update the <strong>knowledgeBase</strong> with your company details</li>
              <li>Replace <strong>checkAvailability()</strong> with your scheduling API</li>
              <li>Replace <strong>bookAppointment()</strong> with your booking system</li>
              <li>Add more tools as needed (payment, lookup orders, etc.)</li>
              <li>Test by calling and saying "I'd like to book an appointment"</li>
            </ol>
          </div>

          <div class="service-card" style="background: linear-gradient(135deg, #c678dd 0%, #2c313c 100%); margin-top: 20px;">
            <h4 style="color: white;">üí° Real-World Integration Ideas</h4>
            <ul style="color: #e5e5e5; line-height: 1.8;">
              <li><strong>Healthcare:</strong> Connect to Epic/Cerner for real availability</li>
              <li><strong>Restaurants:</strong> Integrate OpenTable or Resy API</li>
              <li><strong>E-commerce:</strong> Check inventory, track orders, process returns</li>
              <li><strong>Support:</strong> Look up tickets, check account status, escalate issues</li>
              <li><strong>Financial:</strong> Check balances, make payments (with proper auth!)</li>
            </ul>
          </div>

          <div style="margin: 30px 0; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; border: 2px solid #5a67d8;">
            <h3 style="color: white; margin: 0 0 15px 0; font-size: 1.2rem;">üíæ Ready to Deploy?</h3>
            <p style="color: rgba(255,255,255,0.9); margin-bottom: 20px;">
              Once you're happy with your tooling configuration, click <strong>Commit Step 8</strong> to deploy it to your Twilio account.
              This will update your WebSocket handler with custom functions and knowledge base.
            </p>
            <button
              class="btn btn-success"
              id="commitStep8Btn"
              onclick="commitStep(8)"
              style="font-size: 1.1rem; padding: 15px 30px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
              üíæ Commit Step 8 - Deploy Tooling
            </button>
            <div id="commitStep8Status" style="margin-top: 15px;"></div>
          </div>

          <div class="button-group" style="margin-top: 30px;">
            <button class="btn btn-secondary" onclick="prevStep()">‚Üê Back</button>
            <button class="btn btn-secondary" onclick="skipTooling()" style="margin: 0 10px;">
              Skip This Step ‚Üí
            </button>
            <button class="btn btn-primary" onclick="saveToolingAndContinue()">
              Save & Continue ‚Üí
            </button>
          </div>

          <div id="step5Status" class="status-box"></div>
        </div>
      `;
    }

    function skipTooling() {
      toolsConfigured = true;
      saveProgressToStorage();
      updateProgressBar();
      showStatus('step5Status', 'info', '‚è≠Ô∏è Skipped tooling configuration. You can add this later!');
      setTimeout(() => {
        nextStep();
      }, 1000);
    }

    function saveToolingAndContinue() {
      toolsConfigured = true;
      saveProgressToStorage();
      updateProgressBar();
      const toolingCode = document.getElementById('code5')?.value || '';

      // Store in localStorage for later use
      try {
        localStorage.setItem('twilioVoiceAI_tooling', toolingCode);
        showStatus('step5Status', 'success', '‚úÖ Tooling configuration saved!');
        setTimeout(() => {
          nextStep();
        }, 1000);
      } catch (error) {
        showStatus('step5Status', 'error', `‚ùå Error saving: ${error.message}`);
      }
    }

    // =========================================================================
    // STEP 9: DEPLOY YOUR VOICE AI SYSTEM
    // =========================================================================

    function renderStep9_Deploy() {
      return `
        <div class="step-content active">
          <div class="step-header">
            <h2>üöÄ Step 9: Deploy Your Voice AI System</h2>
            <p>Congratulations! You've built a production-ready Voice AI system. Let's deploy it!</p>
          </div>

          <!-- What You Built -->
          <div class="service-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <h3 style="color: white; margin-bottom: 20px;">üéâ What You Built</h3>
            <div style="color: white; line-height: 1.8;">
              <p style="margin-bottom: 15px;">You've created a complete Voice AI system with:</p>
              <ul style="margin-left: 20px; margin-bottom: 15px;">
                <li><strong>üìû Phone Number Integration</strong> - Twilio phone number configured for ${callDirection === 'inbound' ? 'inbound' : 'outbound'} calls</li>
                <li><strong>üîå WebSocket Handler</strong> - Real-time audio streaming with bidirectional communication</li>
                <li><strong>ü§ñ AI Integration</strong> - OpenAI-powered conversations with ConversationRelay</li>
                <li><strong>üìù System Prompts</strong> - Professional, production-ready AI personality and guidelines</li>
                <li><strong>üõ†Ô∏è Function Calling</strong> - Tools for appointments, knowledge base queries, and SMS</li>
              </ul>
              <p style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.2); border-radius: 8px;">
                <strong>üí° Why This Matters:</strong> Most Voice AI tutorials stop at "Hello World".
                You've built a system that handles real-world conversations with context, state management,
                and production-ready error handling. This is deployment-ready code!
              </p>
            </div>
          </div>

          <!-- Architecture Diagram -->
          <div class="instructions">
            <h3>üèóÔ∏è System Architecture</h3>
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; font-family: monospace; font-size: 13px; line-height: 2;">
              <pre style="margin: 0;">
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Phone Call     ‚îÇ üìû
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Twilio Voice   ‚îÇ ‚òÅÔ∏è  (Your phone number)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  TwiML Handler  ‚îÇ üìã  (Answers call, starts stream)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  WebSocket      ‚îÇ üîå  (Real-time audio streaming)
‚îÇ  Handler        ‚îÇ     - Receives caller audio
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     - Sends AI responses
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ConversationRelay‚îÇ ü§ñ  (OpenAI + Voice synthesis)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     - GPT-4/3.5 for intelligence
         ‚îÇ              - ElevenLabs for voice
         ‚îÇ              - Function calling for actions
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Your Tools     ‚îÇ üõ†Ô∏è  (Custom functions you defined)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     - Appointments
                        - Knowledge base
                        - SMS notifications
              </pre>
            </div>
          </div>

          <!-- Deployment Options -->
          <div class="service-card">
            <h3>üì¶ Choose Your Deployment Method</h3>
            <p style="margin-bottom: 20px;">Select the deployment option that works best for you:</p>

            <!-- Option 1: Deploy to Current Account -->
            <div style="border: 2px solid #F22F46; border-radius: 8px; padding: 20px; margin-bottom: 20px; background: linear-gradient(135deg, rgba(242,47,70,0.1) 0%, rgba(13,18,43,0.1) 100%);">
              <h4 style="margin: 0 0 10px 0; color: #F22F46;">üéØ Option 1: Deploy to Current Account (Recommended)</h4>
              <p style="margin-bottom: 15px; color: #666;">
                Deploy everything you've built to your connected Twilio account with one click.
                Your phone number will be automatically configured and ready to receive calls.
              </p>
              <div style="margin-bottom: 15px;">
                <strong>‚úÖ Pros:</strong>
                <ul style="margin: 5px 0 0 20px; color: #666;">
                  <li>Fastest deployment method (1 click)</li>
                  <li>Phone number auto-configured</li>
                  <li>All functions deployed automatically</li>
                  <li>Ready to test immediately</li>
                </ul>
              </div>
              <button class="btn btn-primary" onclick="deployToCurrentAccount()" style="width: 100%; padding: 12px; font-size: 16px;">
                üöÄ Deploy to My Twilio Account
              </button>
              <div id="deployStatus" class="status-box" style="margin-top: 15px;"></div>
            </div>

            <!-- Option 2: Download Package -->
            <div style="border: 2px solid #667eea; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
              <h4 style="margin: 0 0 10px 0; color: #667eea;">üì• Option 2: Download Complete Package</h4>
              <p style="margin-bottom: 15px; color: #666;">
                Download all your code as a ZIP file. Perfect if you want to customize further or deploy manually.
              </p>
              <div style="margin-bottom: 15px;">
                <strong>‚úÖ Pros:</strong>
                <ul style="margin: 5px 0 0 20px; color: #666;">
                  <li>Full control over code</li>
                  <li>Easy to customize and extend</li>
                  <li>Includes .env template with your settings</li>
                  <li>Contains README with deployment instructions</li>
                </ul>
              </div>
              <button class="btn btn-secondary" onclick="downloadProjectPackage()" style="width: 100%; padding: 12px; font-size: 16px;">
                üì¶ Download Project Files
              </button>
            </div>

            <!-- Option 3: Clone from GitHub -->
            <div style="border: 2px solid #24292e; border-radius: 8px; padding: 20px;">
              <h4 style="margin: 0 0 10px 0; color: #24292e;">üêô Option 3: Clone from GitHub</h4>
              <p style="margin-bottom: 15px; color: #666;">
                For developers who want version control and ongoing updates. Clone the complete workshop repository.
              </p>
              <div style="margin-bottom: 15px;">
                <strong>‚úÖ Pros:</strong>
                <ul style="margin: 5px 0 0 20px; color: #666;">
                  <li>Version control with Git</li>
                  <li>Easy to collaborate with team</li>
                  <li>Get workshop updates via git pull</li>
                  <li>Best for production deployments</li>
                </ul>
              </div>
              <div style="background: #f6f8fa; padding: 15px; border-radius: 6px; font-family: monospace; font-size: 13px; margin-bottom: 15px;">
                <div style="color: #666; margin-bottom: 5px;">Run these commands in your terminal:</div>
                <code style="display: block; margin: 5px 0;">git clone https://github.com/geverist/twilio-voice-ai-workshop.git</code>
                <code style="display: block; margin: 5px 0;">cd twilio-voice-ai-workshop/twilio-serverless</code>
                <code style="display: block; margin: 5px 0;">cp .env.example .env</code>
                <code style="display: block; margin: 5px 0;"># Edit .env with your credentials</code>
                <code style="display: block; margin: 5px 0;">twilio serverless:deploy</code>
              </div>
              <button class="btn btn-secondary" onclick="window.open('https://github.com/geverist/twilio-voice-ai-workshop', '_blank')" style="width: 100%; padding: 12px; font-size: 16px;">
                üîó Open GitHub Repository
              </button>
            </div>
          </div>

          <!-- Post-Deployment Checklist -->
          <div class="service-card" style="background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);">
            <h3 style="color: white; margin-bottom: 15px;">‚úÖ Post-Deployment Checklist</h3>
            <div style="color: white; line-height: 1.8;">
              <p style="margin-bottom: 10px;">After deployment, verify these items:</p>
              <label style="display: block; margin: 10px 0; cursor: pointer;">
                <input type="checkbox" id="checkDeployPhone" style="margin-right: 10px;">
                Phone number configured with correct TwiML webhook
              </label>
              <label style="display: block; margin: 10px 0; cursor: pointer;">
                <input type="checkbox" id="checkDeployFunctions" style="margin-right: 10px;">
                All functions deployed successfully
              </label>
              <label style="display: block; margin: 10px 0; cursor: pointer;">
                <input type="checkbox" id="checkDeployTest" style="margin-right: 10px;">
                Test call completed successfully
              </label>
              <label style="display: block; margin: 10px 0; cursor: pointer;">
                <input type="checkbox" id="checkDeployAdmin" style="margin-right: 10px;">
                Admin panel accessible for configuration
              </label>
              <label style="display: block; margin: 10px 0; cursor: pointer;">
                <input type="checkbox" id="checkDeployMonitor" style="margin-right: 10px;">
                Monitoring/logging set up (Twilio Console)
              </label>
              <button onclick="completeDeploymentStep()" id="completeDeployBtn" disabled style="margin-top: 15px; padding: 12px 24px; background: white; color: #56ab2f; border: none; border-radius: 6px; font-weight: bold; cursor: not-allowed; opacity: 0.5;">
                ‚úÖ Deployment Complete - Finish Workshop
              </button>
            </div>
          </div>

          <!-- Next Steps & Resources -->
          <div class="instructions">
            <h3>üéØ What's Next?</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 15px;">

              <div style="padding: 15px; border: 2px solid #e0e0e0; border-radius: 8px;">
                <h4 style="margin: 0 0 10px 0;">üé® Customize Your AI</h4>
                <p style="color: #666; font-size: 14px; margin-bottom: 10px;">
                  Visit the admin panel to update your system prompt, change voices, and configure tools.
                </p>
                <a href="/admin.html" target="_blank" class="btn btn-secondary" style="display: inline-block; padding: 8px 16px; text-decoration: none;">
                  Sample Admin Panel
                </a>
              </div>

              <div style="padding: 15px; border: 2px solid #e0e0e0; border-radius: 8px;">
                <h4 style="margin: 0 0 10px 0;">üìä Monitor Performance</h4>
                <p style="color: #666; font-size: 14px; margin-bottom: 10px;">
                  Track call metrics, review transcripts, and analyze conversation quality.
                </p>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;">
                  <button onclick="window.open('https://console.twilio.com/us1/monitor/logs/voice', '_blank')" class="btn btn-secondary" style="padding: 8px 16px;">
                    View Call Logs
                  </button>
                </div>
                <div style="margin-top: 15px; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #4fc1ff;">
                  <h5 style="margin: 0 0 8px 0; color: #333; font-size: 14px;">üß† Conversational Intelligence</h5>
                  <p style="color: #666; font-size: 13px; margin: 0 0 10px 0;">
                    Advanced AI analytics for deeper insights: sentiment analysis, topic detection, keyword extraction, and call scoring.
                  </p>
                  <a href="https://www.twilio.com/docs/voice/intelligence" target="_blank" style="color: #4fc1ff; text-decoration: none; font-size: 13px;">
                    üìö Learn about Conversational Intelligence ‚Üí
                  </a>
                </div>
              </div>

              <div style="padding: 15px; border: 2px solid #e0e0e0; border-radius: 8px;">
                <h4 style="margin: 0 0 10px 0;">üìö Learn More</h4>
                <p style="color: #666; font-size: 14px; margin-bottom: 10px;">
                  Explore advanced features like call recording, analytics, and integrations.
                </p>
                <button onclick="window.open('https://www.twilio.com/docs/voice', '_blank')" class="btn btn-secondary" style="padding: 8px 16px;">
                  Twilio Voice Docs
                </button>
              </div>

              <div style="padding: 15px; border: 2px solid #e0e0e0; border-radius: 8px;">
                <h4 style="margin: 0 0 10px 0;">üí¨ Join Community</h4>
                <p style="color: #666; font-size: 14px; margin-bottom: 10px;">
                  Connect with other developers building Voice AI applications.
                </p>
                <button onclick="window.open('https://github.com/geverist/twilio-voice-ai-workshop/discussions', '_blank')" class="btn btn-secondary" style="padding: 8px 16px;">
                  GitHub Discussions
                </button>
              </div>

            </div>
          </div>

          <!-- Enhancements to Consider -->
          <div class="instructions" style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px;">
            <h3 style="margin: 0 0 10px 0;">üí° Production Enhancements to Consider</h3>
            <ul style="margin-left: 20px; line-height: 1.8; color: #856404;">
              <li><strong>Call Recording:</strong> Record calls for quality assurance and training</li>
              <li><strong>Voicemail Detection:</strong> Handle answering machines gracefully</li>
              <li><strong>Call Queues:</strong> Implement hold music and queue management</li>
              <li><strong>Analytics Dashboard:</strong> Build custom dashboards for call metrics</li>
              <li><strong>Multi-language Support:</strong> Add support for multiple languages</li>
              <li><strong>CRM Integration:</strong> Connect to Salesforce, HubSpot, etc.</li>
              <li><strong>Fallback Handlers:</strong> Graceful degradation when AI fails</li>
              <li><strong>Cost Monitoring:</strong> Track and alert on API usage costs</li>
            </ul>
          </div>

        </div>
      `;
    }

    // =========================================================================
    // STEP 9 FUNCTIONS
    // =========================================================================

    async function deployToCurrentAccount() {
      const statusBox = document.getElementById('deployStatus');
      statusBox.className = 'status-box info show';
      statusBox.textContent = 'üöÄ Starting deployment to your Twilio account...';

      try {
        // This would trigger the same deployment logic from Step 6
        // For now, show status of what's already deployed
        const deployed = functionsDeployed && basicTwimlCreated;

        if (deployed) {
          statusBox.className = 'status-box success show';
          statusBox.innerHTML = `
            ‚úÖ <strong>Already Deployed!</strong><br>
            Your Voice AI system is live and ready.<br>
            Phone Number: ${selectedPhoneNumber || 'Configured'}<br>
            <a href="https://console.twilio.com/us1/develop/phone-numbers/manage/incoming" target="_blank" style="color: white; text-decoration: underline;">
              View in Twilio Console
            </a>
          `;
          document.getElementById('checkDeployFunctions').checked = true;
          document.getElementById('checkDeployPhone').checked = true;
          checkDeploymentComplete();
        } else {
          statusBox.className = 'status-box error show';
          statusBox.textContent = '‚ö†Ô∏è Please complete previous steps before deploying. Go back to Step 4 to deploy your functions.';
        }
      } catch (error) {
        statusBox.className = 'status-box error show';
        statusBox.textContent = '‚ùå Deployment error: ' + error.message;
      }
    }

    function downloadProjectPackage() {
      // Create a comprehensive ZIP package with all code
      const projectFiles = {
        'README.md': generateReadme(),
        '.env.example': generateEnvFile(),
        'functions/ws-handler.js': document.getElementById('code5')?.value || '',
        'functions/twiml-handler.js': document.getElementById('code4')?.value || '',
        'package.json': generatePackageJson()
      };

      // For now, download key files individually
      // In production, you'd use JSZip library to create actual ZIP
      alert('üì¶ Downloading project files...\n\nNote: In production, this would download a complete ZIP package with all your code, configuration files, and README.');

      // Download the README
      downloadFile('README.md', generateReadme());
    }

    function generateReadme() {
      return `# Your Voice AI System

## What You Built

This is a production-ready Voice AI system built during the Twilio Voice AI Workshop.

### Components

- **Phone Number**: ${selectedPhoneNumber || 'Your Twilio number'}
- **Call Direction**: ${callDirection === 'inbound' ? 'Inbound' : 'Outbound'}
- **AI Model**: ${openaiApiKey ? 'OpenAI GPT' : 'Not configured'}
- **TTS Provider**: ${ttsProvider || 'ElevenLabs'}

### Features

‚úÖ Real-time audio streaming via WebSocket
‚úÖ AI-powered conversations with context awareness
‚úÖ State-based prompt engineering
‚úÖ Function calling (appointments, knowledge base, SMS)
‚úÖ Production-ready error handling

## Quick Start

1. Copy .env.example to .env and add your credentials
2. Run: npm install
3. Deploy: twilio serverless:deploy
4. Configure your phone number webhook

## Need Help?

- Documentation: https://www.twilio.com/docs/voice
- Workshop: https://github.com/geverist/twilio-voice-ai-workshop
- Support: File an issue on GitHub

Built with ‚ù§Ô∏è using Twilio ConversationRelay
`;
    }

    function generateEnvFile() {
      return `# Twilio Credentials
TWILIO_ACCOUNT_SID=${twilioCredentials?.accountSid || 'your_account_sid'}
TWILIO_AUTH_TOKEN=your_auth_token
DEFAULT_TWILIO_NUMBER=${selectedPhoneNumber || '+1234567890'}

# OpenAI Configuration
OPENAI_API_KEY=${openaiApiKey || 'your_openai_api_key'}

# Voice Configuration
TTS_PROVIDER=${ttsProvider || 'elevenlabs'}
VOICE_ID=${conversationRelayVoice || 'EXAVITQu4vr4xnSDxMaL'}

# Optional: Twilio Sync (for session management)
TWILIO_SYNC_SVC_SID=your_sync_service_sid
`;
    }

    function generatePackageJson() {
      return `{
  "name": "voice-ai-system",
  "version": "1.0.0",
  "description": "Voice AI system built with Twilio ConversationRelay",
  "dependencies": {
    "twilio": "^4.x",
    "openai": "^4.x",
    "ws": "^8.x"
  }
}`;
    }

    function checkDeploymentComplete() {
      const checkboxes = [
        'checkDeployPhone',
        'checkDeployFunctions',
        'checkDeployTest',
        'checkDeployAdmin',
        'checkDeployMonitor'
      ];

      const checked = checkboxes.filter(id => document.getElementById(id)?.checked).length;
      const completeBtn = document.getElementById('completeDeployBtn');

      if (completeBtn) {
        if (checked >= 3) {
          completeBtn.disabled = false;
          completeBtn.style.opacity = '1';
          completeBtn.style.cursor = 'pointer';
        } else {
          completeBtn.disabled = true;
          completeBtn.style.opacity = '0.5';
          completeBtn.style.cursor = 'not-allowed';
        }
      }
    }

    function completeDeploymentStep() {
      projectDeployed = true;
      showStatus('deployStatus', 'success', 'üéâ Congratulations! Your Voice AI system is deployed and ready for production!');

      // Show completion modal
      setTimeout(() => {
        const modal = document.createElement('div');
        modal.className = 'modal show';
        modal.innerHTML = `
          <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
              <h2 style="color: white; margin: 0;">üéâ Workshop Complete!</h2>
            </div>
            <div style="padding: 30px; text-align: center;">
              <div style="font-size: 64px; margin-bottom: 20px;">üöÄ</div>
              <h3 style="margin-bottom: 15px;">Congratulations!</h3>
              <p style="color: #666; line-height: 1.8; margin-bottom: 20px;">
                You've successfully built and deployed a production-ready Voice AI system with Twilio ConversationRelay.
                Your system is now live and ready to handle real conversations!
              </p>
              <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <strong>What You Accomplished:</strong><br>
                ‚úÖ Integrated Twilio Voice & OpenAI<br>
                ‚úÖ Built real-time WebSocket handler<br>
                ‚úÖ Mastered prompt engineering<br>
                ‚úÖ Added function calling & tools<br>
                ‚úÖ Deployed to production
              </div>
              <button onclick="window.location.href='/admin.html'" class="btn btn-primary" style="margin-right: 10px;">
                Sample Admin Panel
              </button>
              <button onclick="window.location.reload()" class="btn btn-secondary">
                Start New Workshop
              </button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      }, 500);

      saveProgressToStorage();
    }

    // Add event listener for deployment checklist
    document.addEventListener('change', (e) => {
      if (e.target.type === 'checkbox' && e.target.id && e.target.id.startsWith('checkDeploy')) {
        checkDeploymentComplete();
      }
    });

    // =========================================================================
    // STEP 6: DEPLOY - Deploy to User's Twilio Account
    // =========================================================================

    function renderStep6_Deploy() {
      const isOutbound = callDirection === 'outbound';
      const code = document.getElementById('code4')?.value || '';

      return `
        <div class="step-content active">
          <div class="step-header">
            <h2>Deploy to Your Twilio Account</h2>
            <p>Let's deploy your ${isOutbound ? 'Dial' : 'IVR'} function to Twilio Serverless</p>
          </div>

          <div class="instructions">
            <h3>üìã What This Does</h3>
            <p>We'll deploy your TwiML handler as a Twilio Function so it can handle real calls.</p>
            <p style="margin-top: 15px;">
              üìö <strong>Documentation:</strong>
              <a href="https://www.twilio.com/docs/serverless/functions-assets" target="_blank">Twilio Functions</a> |
              <a href="https://www.twilio.com/docs/serverless/api" target="_blank">Serverless API</a>
            </p>
          </div>

          <div class="service-card">
            <h4>üì¶ Deployment Details</h4>
            <p><strong>Function Name:</strong> <code>voice-handler</code></p>
            <p><strong>Runtime:</strong> Node.js 18</p>
            <p><strong>Handler Type:</strong> ${isOutbound ? 'Outbound Dial' : 'Inbound IVR'}</p>
          </div>

          <div class="code-preview">
            <div class="code-header">
              <span>üìù Code to Deploy</span>
            </div>
            <pre style="background: #1e1e1e; color: #abb2bf; padding: 15px; border-radius: 6px; overflow-x: auto;">${code}</pre>
          </div>

          <div class="button-group">
            <button class="btn btn-primary" onclick="deployFunction()" style="font-size: 16px; padding: 12px 24px;">
              üöÄ Deploy to My Account
            </button>
          </div>

          <div id="step5Status" class="status-box"></div>

          <div class="button-group">
            <button class="btn btn-secondary" onclick="prevStep()">‚Üê Back</button>
            <button class="btn btn-primary" id="nextBtn5" onclick="nextStep()" disabled>
              Next: Test Your Call ‚Üí
            </button>
          </div>
        </div>
      `;
    }

    async function deployFunction() {
      const code = document.getElementById('code4')?.value || '';

      if (twilioCredentials?.demoMode) {
        showStatus('step5Status', 'info', 'üìù Demo Mode: Simulating deployment...');
        setTimeout(() => {
          functionsDeployed = true;
          deployedServiceSid = 'ZS' + Math.random().toString(36).substring(7);
          showStatus('step5Status', 'success', '‚úÖ Demo deployment complete! Function URL: https://demo-1234.twil.io/voice-handler');
          document.getElementById('nextBtn5').disabled = false;
          updateProgressBar();
        }, 2000);
        return;
      }

      showStatus('step5Status', 'info', '‚è≥ Deploying to your Twilio account...');

      try {
        const response = await fetch('/api/tutorial-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'deployFunction',
            functionName: 'voice-handler',
            functionCode: code,
            ...twilioCredentials
          })
        });

        const data = await response.json();

        if (data.success) {
          functionsDeployed = true;
          deployedServiceSid = data.serviceSid;
          showStatus('step5Status', 'success', `‚úÖ Deployed! Function URL: ${data.functionUrl}`);
          document.getElementById('nextBtn5').disabled = false;
          updateProgressBar();
        } else {
          showStatus('step5Status', 'error', `‚ùå Deployment failed: ${data.error}`);
        }
      } catch (error) {
        showStatus('step5Status', 'error', `‚ùå ${error.message}`);
      }
    }

    // =========================================================================
    // INCREMENTAL COMMIT - Deploy Code Step-by-Step
    // =========================================================================

    async function updatePhoneNumberWebhook() {
      // Update the phone number's voice URL to point to the deployed voice-handler
      if (!selectedPhoneNumberSid || !websocketUrl) {
        console.log('Phone number SID or websocket URL not available yet');
        console.log('selectedPhoneNumberSid:', selectedPhoneNumberSid);
        console.log('websocketUrl:', websocketUrl);
        return;
      }

      const voiceHandlerUrl = `https://${websocketUrl}/voice-handler`;

      try {
        console.log('Updating phone number webhook to:', voiceHandlerUrl);
        console.log('Phone number SID:', selectedPhoneNumberSid);

        const response = await fetch('/api/tutorial-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'updatePhoneNumber',
            phoneNumberSid: selectedPhoneNumberSid,
            voiceUrl: voiceHandlerUrl,
            voiceMethod: 'POST',
            ...twilioCredentials
          })
        });

        const result = await response.json();

        if (result.success) {
          console.log('‚úÖ Phone number webhook updated successfully');
          showStatus('commitStep6Status', 'success', 'üìû Phone number configured with ConversationRelay handler!');
        } else {
          console.error('Failed to update phone number:', result.error);
          showStatus('commitStep6Status', 'warning', `‚ö†Ô∏è Deployment succeeded but phone update failed: ${result.error}`);
        }
      } catch (error) {
        console.error('Error updating phone number webhook:', error);
        showStatus('commitStep6Status', 'warning', `‚ö†Ô∏è Deployment succeeded but phone update failed: ${error.message}`);
      }
    }

    async function commitStep(stepNumber) {
      const statusId = `commitStep${stepNumber}Status`;
      const btnId = `commitStep${stepNumber}Btn`;
      const nextBtnId = `nextBtn${stepNumber === 4 ? 4 : stepNumber === 6 ? 6 : stepNumber === 7 ? 7 : 8}`;

      // PREREQUISITE CHECK: Step 6 requires Step 5 to be deployed first
      if (stepNumber === 6 && !step5Deployed) {
        showStatus(statusId, 'error', '‚ö†Ô∏è Please deploy Step 5 (WebSocket Handler) first! ConversationRelay needs the WebSocket endpoint to connect to.');
        return;
      }

      // Get the button and disable it
      const btn = document.getElementById(btnId);
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<span class="loading" style="border: 3px solid rgba(255,255,255,0.3); border-top-color: white;"></span> Committing...';
      }

      // Show initial status
      showStatus(statusId, 'info', '‚è≥ Starting deployment...');

      // DEMO MODE: Simulate deployment
      if (twilioCredentials?.demoMode) {
        await new Promise(resolve => setTimeout(resolve, 2000));

        // Set deployed flags based on step
        if (stepNumber === 4) {
          step4Committed = true;
          step4Deployed = true;
        } else if (stepNumber === 5) {
          step5Committed = true;
          step5Deployed = true;
          deployedServiceSid = 'ZS' + Math.random().toString(36).substring(7);
          websocketUrl = 'demo-workshop-' + Math.random().toString(36).substring(7) + '.twil.io';
        } else if (stepNumber === 6) {
          step6Committed = true;
          step6Deployed = true;
        } else if (stepNumber === 8) {
          step8Committed = true;
          toolsConfigured = true;
          functionsDeployed = true;
        }

        saveProgressToStorage();
        updateProgressBar();

        showStatus(statusId, 'success', `‚úÖ Demo deployment complete! Function URL: https://${websocketUrl || 'demo-1234.twil.io'}/${stepNumber === 5 ? 'websocket-handler' : 'voice-handler'}`);

        // Re-enable button
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = 'üíæ Commit Step ' + stepNumber;
        }

        // Enable next button
        const nextBtn = document.getElementById(nextBtnId);
        if (nextBtn) {
          nextBtn.disabled = false;
        }

        return;
      }

      try {
        // Determine which code to deploy based on step
        let functionCode = '';
        let functionName = 'voice-handler';

        if (stepNumber === 4) {
          // Step 4: Basic TwiML - Initial voice-handler
          functionCode = document.getElementById('code4')?.value || '';
          functionName = 'voice-handler';
        } else if (stepNumber === 5) {
          // Step 5: WebSocket Handler - NEW separate handler
          functionCode = document.getElementById('code7')?.value || '';
          functionName = 'websocket-handler';
        } else if (stepNumber === 6) {
          // Step 6: ConversationRelay - UPDATE voice-handler to use ConversationRelay
          functionCode = document.getElementById('code8')?.value || '';
          functionName = 'voice-handler';  // Update voice-handler with ConversationRelay
        } else if (stepNumber === 8) {
          // Step 8: Tooling - Update websocket-handler with tools
          functionCode = document.getElementById('code9')?.value || '';
          functionName = 'websocket-handler';
        }

        if (!functionCode) {
          throw new Error('No code found to deploy. Please write some code first.');
        }

        // Validate syntax before deploying
        showStatus(statusId, 'info', 'üîç Validating JavaScript syntax...');
        const validation = validateJavaScriptSyntax(functionCode);

        if (!validation.valid) {
          const errorMsg = `Syntax Error: ${validation.error}\nLocation: Line ${validation.line}, Column ${validation.column}\n\nPlease fix the syntax error before deploying.`;
          showStatus(statusId, 'error', `‚ùå ${errorMsg}`);

          // Re-enable the button
          if (btn) {
            btn.disabled = false;
            btn.innerHTML = 'üíæ Commit Step ' + stepNumber;
          }

          throw new Error(errorMsg);
        }

        showStatus(statusId, 'success', '‚úÖ Syntax validation passed');

        // Check for unfinished TODOs
        const todoMatches = functionCode.match(/\/\/\s*TODO:/gi);
        const todoCount = todoMatches ? todoMatches.length : 0;
        const codeLines = functionCode.split('\n').filter(line => {
          const trimmed = line.trim();
          return trimmed &&
                 !trimmed.startsWith('//') &&
                 !trimmed.startsWith('/*') &&
                 trimmed !== '{' &&
                 trimmed !== '}';
        }).length;

        // Warn if there are many TODOs relative to actual code
        if (todoCount > 5 || (codeLines > 0 && todoCount / codeLines > 0.3)) {
          showStatus(statusId, 'warning', `‚ö†Ô∏è You have ${todoCount} TODO comments. Make sure your code is complete!`);

          const confirmDeploy = confirm(
            `‚ö†Ô∏è Deployment Warning\n\n` +
            `Your code contains ${todoCount} TODO comments.\n` +
            `This suggests your implementation may be incomplete.\n\n` +
            `Are you sure you want to deploy?`
          );

          if (!confirmDeploy) {
            showStatus(statusId, 'info', 'Deployment cancelled. Please complete your TODOs first.');

            // Re-enable the button
            if (btn) {
              btn.disabled = false;
              btn.innerHTML = 'üíæ Commit Step ' + stepNumber;
            }

            return; // Cancel deployment
          }
        }

        // Step 1: Create service + environment (if first commit)
        if (!deployedServiceSid) {
          showStatus(statusId, 'info', 'üì¶ Creating Twilio Serverless service...');

          const createResponse = await fetch('/deploy-step', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              step: 'create-service',
              accountSid: twilioCredentials.accountSid,
              authToken: twilioCredentials.authToken,
              phoneNumber: selectedPhoneNumber,
              openaiKey: openaiApiKey
            })
          });

          const createData = await createResponse.json();
          if (!createData.success) {
            const errorMsg = createData.details || createData.error || 'Failed to create service';
            console.error('Create service error:', createData);
            throw new Error(errorMsg);
          }

          deployedServiceSid = createData.serviceSid;
          deployedEnvironmentSid = createData.environmentSid;
          websocketUrl = createData.domain; // Store just the domain, not the full wss:// URL

          showStatus(statusId, 'success', `‚úÖ Service created: ${deployedServiceSid}`);
          saveProgressToStorage();
        }

        // Step 2: Upload the function
        showStatus(statusId, 'info', `üì§ Uploading ${functionName}...`);

        const uploadResponse = await fetch('/deploy-step', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            step: 'upload-function-code',
            serviceSid: deployedServiceSid,
            functionCode: functionCode,
            filePath: `/${functionName}`,
            accountSid: twilioCredentials.accountSid,
            authToken: twilioCredentials.authToken
          })
        });

        const uploadData = await uploadResponse.json();
        if (!uploadData.success) {
          const errorMsg = uploadData.details || uploadData.error || 'Failed to upload function';
          console.error('Upload function error:', uploadData);
          throw new Error(errorMsg);
        }

        showStatus(statusId, 'success', `‚úÖ ${functionName} uploaded!`);

        // Step 3: Create build
        showStatus(statusId, 'info', `üî® Creating build...`);

        const buildResponse = await fetch('/deploy-step', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            step: 'create-build',
            serviceSid: deployedServiceSid,
            accountSid: twilioCredentials.accountSid,
            authToken: twilioCredentials.authToken
          })
        });

        const buildData = await buildResponse.json();
        if (!buildData.success) {
          const errorMsg = buildData.details || buildData.error || 'Failed to create build';
          console.error('Create build error:', buildData);
          throw new Error(errorMsg);
        }

        const buildSid = buildData.buildSid;
        showStatus(statusId, 'info', `‚è≥ Waiting for build to complete...`);

        // Step 4: Wait for build (poll every 2 seconds)
        let buildComplete = false;
        let attempts = 0;
        const maxAttempts = 30; // 60 seconds max

        while (!buildComplete && attempts < maxAttempts) {
          await new Promise(resolve => setTimeout(resolve, 2000));
          attempts++;

          const checkResponse = await fetch('/deploy-step', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              step: 'check-build',
              serviceSid: deployedServiceSid,
              buildSid: buildSid,
              accountSid: twilioCredentials.accountSid,
              authToken: twilioCredentials.authToken
            })
          });

          const checkData = await checkResponse.json();
          if (!checkData.success) throw new Error(checkData.error || 'Failed to check build status');

          buildComplete = !checkData.building;
          if (checkData.status === 'failed') {
            throw new Error('Build failed');
          }
        }

        if (!buildComplete) {
          throw new Error('Build timed out after 60 seconds');
        }

        showStatus(statusId, 'success', `‚úÖ Build completed!`);

        // Step 5: Deploy the build
        showStatus(statusId, 'info', `üöÄ Deploying to production...`);

        const deployResponse = await fetch('/deploy-step', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            step: 'deploy-build',
            serviceSid: deployedServiceSid,
            environmentSid: deployedEnvironmentSid,
            buildSid: buildSid,
            accountSid: twilioCredentials.accountSid,
            authToken: twilioCredentials.authToken
          })
        });

        const deployData = await deployResponse.json();
        if (!deployData.success) {
          const errorMsg = deployData.details || deployData.error || 'Failed to deploy build';
          console.error('Deploy build error:', deployData);
          throw new Error(errorMsg);
        }

        showStatus(statusId, 'success', `‚úÖ ${functionName} deployed successfully!`);

        // Mark this step as committed
        if (stepNumber === 4) {
          step4Committed = true;
          // Show inbound test card for inbound calls
          if (callDirection === 'inbound') {
            const testCard = document.getElementById('inboundTestCard');
            const progressBtn = document.getElementById('showProgressBtn');
            if (testCard) {
              testCard.style.display = 'block';
              if (progressBtn) progressBtn.style.display = 'block';
              // Scroll to the test card
              setTimeout(() => {
                testCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
              }, 500);
            }
          } else {
            // For outbound: enable Next button after deployment
            document.getElementById('nextBtn4').disabled = false;
          }
        }
        if (stepNumber === 5) {
          step5Committed = true;
          step5Deployed = true;

          // Save progress immediately
          saveProgressToStorage();

          showStatus(statusId, 'success', '‚úÖ WebSocket handler deployed successfully!');
          console.log('‚úÖ Step 5 deployed, step5Deployed =', step5Deployed);

          // Reveal test section
          const testSection = document.getElementById('step5TestSection');
          if (testSection) {
            testSection.style.display = 'block';

            // Disable test button for 30 seconds while deployment propagates
            const sendTestBtn = testSection.querySelector('button[onclick*="testSingleWebSocketMessage"]');
            const testInput = document.getElementById('testWebSocketMessage');

            if (sendTestBtn) sendTestBtn.disabled = true;
            if (testInput) testInput.disabled = true;

            // Show countdown timer
            let countdown = 30;
            const originalSendText = sendTestBtn ? sendTestBtn.innerHTML : '';

            const countdownInterval = setInterval(() => {
              countdown--;
              if (sendTestBtn) sendTestBtn.innerHTML = `‚è≥ Wait ${countdown}s`;

              if (countdown <= 0) {
                clearInterval(countdownInterval);
                if (sendTestBtn) {
                  sendTestBtn.disabled = false;
                  sendTestBtn.innerHTML = originalSendText;
                }
                if (testInput) testInput.disabled = false;

                celebrate('‚úÖ Ready to test! Deployment has propagated.', 'normal');
              }
            }, 1000);

            setTimeout(() => {
              testSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 500);
          }
        }
        if (stepNumber === 6) {
          step6Committed = true;
          step6Deployed = true;

          // Save progress immediately
          saveProgressToStorage();

          showStatus(statusId, 'success', '‚úÖ ConversationRelay deployed successfully!');
          console.log('‚úÖ Step 6 deployed, step6Deployed =', step6Deployed);

          // Update phone number with the new voice-handler URL after ConversationRelay deployment
          updatePhoneNumberWebhook();
          // Enable Next button - voice testing happens in Step 7 after prompt
          document.getElementById('nextBtn8').disabled = false;

          // Show SDK version notice
          showSDKVersionNotice();
        }
        if (stepNumber === 8) {
          step8Committed = true;
          toolsConfigured = true;
        }

        functionsDeployed = true;
        saveProgressToStorage();
        updateProgressBar();

        // Enable the Next button (but only for outbound - inbound needs to confirm test first)
        const nextBtn = document.getElementById(nextBtnId);
        if (nextBtn && !(stepNumber === 4 && callDirection === 'inbound')) {
          nextBtn.disabled = false;
        }

        // Update button to show success
        if (btn) {
          btn.innerHTML = '‚úÖ Committed!';
          btn.style.background = '#28a745';
        }

        // For WebSocket handler deployment (step 5), add propagation delay for test button
        if (stepNumber === 5) {
          const testBtn = document.querySelector('button[onclick="testCode7()"]');
          if (testBtn) {
            testBtn.disabled = true;
            testBtn.style.opacity = '0.5';
            let countdown = 30;
            const originalText = testBtn.innerHTML;

            const updateButton = () => {
              testBtn.innerHTML = `‚è±Ô∏è Wait ${countdown}s for propagation...`;
            };

            updateButton();
            const interval = setInterval(() => {
              countdown--;
              if (countdown <= 0) {
                clearInterval(interval);
                testBtn.disabled = false;
                testBtn.style.opacity = '1';
                testBtn.innerHTML = originalText;
              } else {
                updateButton();
              }
            }, 1000);
          }
        }

        // Show final success message with URL
        const deploymentUrl = `https://${websocketUrl}`;
        showStatus(statusId, 'success', `
          <div style="padding: 15px; background: #d4edda; border-radius: 8px; border-left: 4px solid #28a745;">
            <strong>üéâ Step ${stepNumber} Committed Successfully!</strong><br>
            <div style="margin-top: 10px; font-size: 14px;">
              üì¶ Service: ${deployedServiceSid}<br>
              üîó URL: ${deploymentUrl}<br>
              üìù Function: ${functionName}
            </div>
            <div style="margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.5); border-radius: 4px;">
              <strong>‚úì Your code is now deployed and live!</strong><br>
              ${stepNumber === 5 ? '‚è±Ô∏è Note: Test button will be available in 30 seconds (deployment propagation time)<br>' : ''}
              You can proceed to test it or continue to the next step.
            </div>
          </div>
        `);

      } catch (error) {
        console.error('Commit error:', error);

        // Try to extract more detailed error info
        let errorMsg = error.message || 'Unknown error';
        if (error.response) {
          try {
            const errorData = await error.response.json();
            errorMsg = errorData.details || errorData.error || errorMsg;
            console.error('Error details:', errorData);
          } catch (e) {
            console.error('Could not parse error response');
          }
        }

        showStatus(statusId, 'error', `‚ùå Deployment failed: ${errorMsg}`);

        // Re-enable button on error
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = 'üíæ Commit Step ' + stepNumber;
          btn.style.background = '';
        }
      }
    }

    // =========================================================================
    // STEP 5: TEST BASIC CALL - Test Without AI
    // =========================================================================

    function renderStep5_TestBasic() {
      const isOutbound = callDirection === 'outbound';

      return `
        <div class="step-content active">
          <div class="step-header">
            <h2>Test Your ${isOutbound ? 'Outbound' : 'Inbound'} Call</h2>
            <p>Let's make sure your basic ${isOutbound ? 'Dial' : 'IVR'} is working</p>
          </div>

          <div class="instructions">
            <h3>üìã Testing Instructions</h3>
            ${isOutbound ? `
              <p>We'll initiate a call from your Twilio number to a destination number.</p>
              <p>Enter your phone number below to test the Dial functionality.</p>
            ` : `
              <p>Configure your Twilio phone number to use the deployed function.</p>
              <p>Then call your Twilio number to hear the IVR menu.</p>
            `}
          </div>

          ${isOutbound ? `
            <div class="service-card">
              <h4>üìû Make Test Call</h4>
              <div style="margin-top: 15px;">
                <label style="display: block; margin-bottom: 5px;">Your Phone Number (to receive the call):</label>
                <input type="tel" id="testPhoneNumber" placeholder="+1234567890"
                       style="width: 100%; padding: 10px; border: 1px solid #3e4451; background: #1e1e1e; color: #abb2bf; border-radius: 4px; font-size: 16px; margin-bottom: 15px;">

                <label style="display: block; margin-bottom: 5px;">Target Number (to dial after answering):</label>
                <input type="tel" id="testDialTarget" placeholder="+1234567890"
                       style="width: 100%; padding: 10px; border: 1px solid #3e4451; background: #1e1e1e; color: #abb2bf; border-radius: 4px; font-size: 16px;">
                <p style="font-size: 12px; color: #666; margin: 5px 0 0 0;">The number that will be dialed when you answer (can be the same as your number)</p>
              </div>
              <button class="btn btn-primary" onclick="makeTestCall()" style="margin-top: 15px; width: 100%;">
                üìû Call Me Now
              </button>
            </div>
          ` : `
            <div class="service-card">
              <h4>üì≤ Configure Phone Number</h4>
              <p>Your deployed function URL has been configured automatically.</p>
              <p><strong>Call this number to test:</strong></p>
              <div id="twilioPhoneDisplay" style="font-size: 24px; font-weight: bold; margin: 15px 0; color: #4fc1ff;"></div>
              <button class="btn btn-secondary" onclick="confirmInboundTest()">
                ‚úì I Called and It Works
              </button>
            </div>
          `}

          <div id="step6Status" class="status-box"></div>

          <div class="button-group">
            <button class="btn btn-secondary" onclick="prevStep()">‚Üê Back</button>
            <button class="btn btn-primary" id="nextBtn6" onclick="nextStep()" disabled>
              Next: Build WebSocket Handler ‚Üí
            </button>
          </div>
        </div>
      `;
    }

    async function makeTestCall() {
      const phoneNumber = document.getElementById('testPhoneNumber')?.value?.trim();
      const targetNumber = document.getElementById('testDialTarget')?.value?.trim();

      if (!phoneNumber) {
        showStatus('step6Status', 'error', '‚ùå Please enter your phone number');
        return;
      }

      if (!targetNumber) {
        showStatus('step6Status', 'error', '‚ùå Please enter a target number to dial');
        return;
      }

      if (!phoneNumber.startsWith('+')) {
        showStatus('step6Status', 'error', '‚ö†Ô∏è Your phone number must use E.164 format (e.g., +1234567890)');
        return;
      }

      if (!targetNumber.startsWith('+')) {
        showStatus('step6Status', 'error', '‚ö†Ô∏è Target number must use E.164 format (e.g., +1234567890)');
        return;
      }

      // Check for demo mode - multiple conditions for safety
      if (twilioCredentials?.demoMode ||
          twilioCredentials?.accountSid?.startsWith('ACdemo') ||
          !twilioCredentials?.accountSid ||
          twilioCredentials?.accountSid === 'ACdemo123456789012345678901234567890') {
        showStatus('step6Status', 'info', 'üìù Demo Mode: Simulating call...');
        setTimeout(() => {
          basicCallTested = true;
          showStatus('step6Status', 'success', '‚úÖ Demo call completed! (In real mode, your phone would ring)');
          document.getElementById('nextBtn6').disabled = false;
          updateProgressBar();
        }, 2000);
        return;
      }

      showStatus('step6Status', 'info', 'üìû Initiating call...');

      // Extract dial parameters from code (optional)
      const code = document.getElementById('code4')?.value || '';
      const timeoutMatch = code.match(/timeout:\s*(\d+)/);
      const timeout = timeoutMatch ? timeoutMatch[1] : '30';

      const mdMatch = code.match(/machineDetection:\s*['"]([^'"]+)['"]/);
      const machineDetection = mdMatch ? mdMatch[1] : null;

      try {
        const response = await fetch('/api/tutorial-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'makeCall',
            to: phoneNumber,
            from: selectedPhoneNumber,
            dialTarget: targetNumber,
            timeout: timeout,
            machineDetection: machineDetection,
            ...twilioCredentials
          })
        });

        const data = await response.json();

        if (data.success) {
          basicCallTested = true;
          showStatus('step6Status', 'success', `‚úÖ Call initiated! CallSid: ${data.callSid}. The call will dial ${targetNumber}.`);
          document.getElementById('nextBtn6').disabled = false;
          updateProgressBar();
        } else {
          showStatus('step6Status', 'error', `‚ùå Call failed: ${data.error}`);
        }
      } catch (error) {
        showStatus('step6Status', 'error', `‚ùå ${error.message}`);
      }
    }

    function confirmInboundTest() {
      basicCallTested = true;
      showStatus('step6Status', 'success', '‚úÖ Great! Your IVR is working. Ready for the next step!');
      document.getElementById('nextBtn6').disabled = false;
      updateProgressBar();
    }

    function confirmInboundTestStep4() {
      basicCallTested = true;
      showStatus('step4Status', 'success', '‚úÖ Perfect! Your IVR is working. Ready for the next step!');
      document.getElementById('nextBtn4').disabled = false;
      updateProgressBar();
      celebrate('üéâ Great job! Your first voice handler is live!', 'light');
    }

    function showCallProgress() {
      const tracker = document.getElementById('callProgressTracker');
      const btn = document.getElementById('showProgressBtn');
      if (tracker) {
        tracker.style.display = 'block';
        btn.style.display = 'none';

        // Animate stages sequentially
        const stages = [
          { id: 'stage1', delay: 500, duration: 2000 },    // Call initiated (immediate + ringing)
          { id: 'stage2', delay: 2500, duration: 3000 },   // Greeting (answer + play)
          { id: 'stage3', delay: 5500, duration: 4000 },   // Menu options
          { id: 'stage4', delay: 9500, duration: 10000 },  // Waiting for input (10s timeout)
          { id: 'stage5', delay: 19500, duration: 3000 }   // Goodbye & hangup
        ];

        stages.forEach(stage => {
          setTimeout(() => {
            activateStage(stage.id);
          }, stage.delay);

          setTimeout(() => {
            completeStage(stage.id);
          }, stage.delay + stage.duration);
        });

        // Show completion message after all stages
        setTimeout(() => {
          const tracker = document.getElementById('callProgressTracker');
          if (tracker) {
            tracker.innerHTML += `
              <div style="margin-top: 15px; padding: 15px; background: rgba(40, 167, 69, 0.3); border: 1px solid #28a745; border-radius: 6px; color: white;">
                <strong>‚úÖ Call Flow Complete!</strong><br>
                <span style="font-size: 13px; opacity: 0.9;">This is the typical flow for your inbound IVR. Now test it for real!</span>
              </div>
            `;
          }
        }, 22500);
      }
    }

    function hideCallProgress() {
      const tracker = document.getElementById('callProgressTracker');
      const btn = document.getElementById('showProgressBtn');
      if (tracker && btn) {
        tracker.style.display = 'none';
        btn.style.display = 'block';
        // Reset stages
        for (let i = 1; i <= 5; i++) {
          const stage = document.getElementById(`stage${i}`);
          if (stage) {
            stage.style.opacity = '0.5';
            const circle = stage.querySelector('span');
            if (circle) {
              circle.style.background = '#666';
              circle.innerHTML = i;
            }
          }
        }
        // Remove completion message if present
        const completionMsg = tracker.querySelector('[style*="rgba(40, 167, 69"]');
        if (completionMsg) completionMsg.remove();
      }
    }

    function activateStage(stageId) {
      const stage = document.getElementById(stageId);
      if (stage) {
        stage.style.opacity = '1';
        stage.style.transition = 'all 0.3s ease';
        const circle = stage.querySelector('span');
        if (circle) {
          circle.style.background = '#4fc1ff';
          circle.innerHTML = '‚è≥';
        }
      }
    }

    function completeStage(stageId) {
      const stage = document.getElementById(stageId);
      if (stage) {
        const circle = stage.querySelector('span');
        if (circle) {
          circle.style.background = '#28a745';
          circle.innerHTML = '‚úì';
        }
      }
    }

    // =========================================================================
    // STEP 6 (case 5): CONVERSATIONRELAY - Upgrade to AI
    // Note: Function name still "renderStep9" for backwards compatibility
    // =========================================================================

    function renderStep9_ConversationRelay() {
      // Use the deployed service domain if available, otherwise fallback to current host
      if (!websocketUrl && deployedServiceSid) {
        // websocketUrl should already be set from deployment, but if not, we can't proceed
        console.error('WebSocket URL not set after deployment');
      }

      return `
        <div class="step-content active">
          <div class="step-header">
            <h2>Step 6: Upgrade to ConversationRelay (AI)</h2>
            <p>Replace your basic ${callDirection === 'outbound' ? 'Dial' : 'IVR'} with AI-powered conversation</p>
          </div>

          ${!step5Deployed && !websocketUrl ? `
          <div style="padding: 20px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 8px; margin: 20px 0;">
            <h4 style="margin: 0 0 10px 0; color: #856404;">‚ö†Ô∏è Prerequisite Required</h4>
            <p style="margin: 0; color: #856404; line-height: 1.6;">
              Before deploying ConversationRelay, you must first complete <strong>Step 5 (WebSocket Handler)</strong>.
              ConversationRelay connects to your WebSocket handler endpoint to enable real-time AI conversations.
            </p>
            <button class="btn btn-secondary" onclick="navigateToStep(4)" style="margin-top: 15px; background: #856404; border: none;">
              ‚Üê Go Back to Step 5
            </button>
          </div>
          ` : ''}

          <!-- TTS Provider Selection -->
          <div class="service-card">
            <h4>üéôÔ∏è Text-to-Speech Provider</h4>
            <p style="font-size: 13px; color: #666; margin-bottom: 15px;">
              Choose which AI voice service ConversationRelay will use to speak AI responses to callers.
            </p>
            <div class="form-group">
              <label>TTS Provider</label>
              <select id="ttsProvider" onchange="saveTTSProvider()" style="width: 100%; padding: 10px; background: #1e1e1e; color: #abb2bf; border: 1px solid #3e4451; border-radius: 4px;">
                <option value="amazon-polly">Amazon Polly (Default - Free, Excellent Quality)</option>
                <option value="elevenlabs">ElevenLabs (Ultra-Premium Natural Voices)</option>
                <option value="google">Google Cloud Text-to-Speech (Premium)</option>
              </select>
            </div>

            <!-- Provider Info -->
            <div id="ttsProviderInfo" style="margin-top: 15px;">
              <div style="padding: 15px; background: #2c313c; border-radius: 8px; border-left: 3px solid #4fc1ff;">
                <p style="margin: 0 0 10px 0; color: #4fc1ff; font-size: 14px; font-weight: 600;">
                  <span id="ttsProviderIcon">üîä</span> <span id="ttsProviderName">Amazon Polly</span>
                </p>
                <p id="ttsProviderDescription" style="margin: 0; color: #abb2bf; font-size: 13px; line-height: 1.6;">
                  Included with Twilio at no additional cost. Provides high-quality, natural-sounding voices in multiple languages.
                </p>
                <div id="ttsProviderNote" style="margin-top: 10px; color: #98c379; font-size: 12px;">
                  ‚úÖ No additional configuration needed
                </div>
              </div>
            </div>

            <!-- Voice Selection -->
            <div class="form-group" style="margin-top: 20px;">
              <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #4fc1ff;">
                üó£Ô∏è Voice Selection
              </label>
              <select id="conversationRelayVoice" style="width: 100%; padding: 12px; background: #1e1e1e; color: #abb2bf; border: 1px solid #3e4451; border-radius: 4px; font-size: 14px;" onchange="saveConversationRelayVoice()">
                ${getVoiceOptions()}
              </select>
              <p style="font-size: 12px; color: #666; margin-top: 5px;">
                Choose the voice for your AI assistant using ${getTTSProviderName()}
              </p>
            </div>
          </div>

          <div class="instructions">
            <h3>üìã Your Task</h3>
            <p>Create TwiML with ConversationRelay that connects to your WebSocket handler:</p>
            <code style="background: #1e1e1e; color: #4fc1ff; padding: 4px 8px; border-radius: 4px;">wss://${websocketUrl}/websocket-handler</code>
            <p style="margin-top: 15px;">
              üìö <strong>Documentation:</strong>
              <a href="https://www.twilio.com/docs/voice/twiml" target="_blank">TwiML Overview</a> |
              <a href="https://www.twilio.com/docs/voice/twiml/connect" target="_blank">&lt;Connect&gt; Verb</a> |
              <a href="https://www.twilio.com/docs/voice/twiml/connect/conversationrelay" target="_blank">ConversationRelay</a> |
              <a href="https://www.twilio.com/docs/voice/conversationrelay/best-practices" target="_blank">Best Practices</a>
            </p>
          </div>

          <div class="service-card" style="background: #f8f9fa; border-left: 4px solid #4fc1ff; margin: 20px 0;">
            <h4 style="color: #0d122b; margin-bottom: 15px;">üéõÔ∏è Advanced ConversationRelay Configuration</h4>
            <p style="margin-bottom: 10px; line-height: 1.6; color: #333;">
              ConversationRelay supports many configuration options to customize your AI voice assistant:
            </p>
            <ul style="margin-left: 20px; color: #555; line-height: 1.8;">
              <li><strong>interruptible:</strong> Control if callers can interrupt the AI ('none', 'dtmf', 'speech', 'any')</li>
              <li><strong>language:</strong> Set default language (e.g., 'en-US', 'es-ES', 'fr-FR', 'multi' for auto-detect)</li>
              <li><strong>transcriptionProvider:</strong> Choose STT provider ('google', 'deepgram')</li>
              <li><strong>hints:</strong> Help recognize domain-specific terms, brand names, or technical jargon</li>
              <li><strong>dtmfDetection:</strong> Enable keypad tone detection for IVR-style interactions</li>
            </ul>
            <p style="margin-top: 10px; font-size: 13px; color: #666; font-style: italic;">
              üí° Tip: Start simple with basic settings, then add advanced features as needed!
            </p>
          </div>

          <div class="service-card" style="background: linear-gradient(135deg, #4fc1ff 0%, #0d122b 100%); color: white; margin: 20px 0;">
            <h4 style="color: white; margin-bottom: 15px;">üéì What is ConversationRelay?</h4>
            <p style="margin-bottom: 15px; line-height: 1.6;">
              Explore how ConversationRelay works with this interactive visualization.
              See the real-time flow of events between Twilio, your WebSocket server, and the AI.
            </p>
            <button class="btn btn-primary" onclick="openPlayground()" style="background: white; color: #0d122b; border: none;">
              üìñ Learn How It Works
            </button>
            <p style="margin-top: 10px; font-size: 12px; opacity: 0.9;">
              Opens an interactive diagram to understand the architecture
            </p>
          </div>

          <!-- ConversationRelay Settings Panel -->
          <div class="service-card" style="background: #2c313c; border: 2px solid #4fc1ff; margin: 20px 0;">
            <h4 style="color: #4fc1ff; margin-bottom: 15px;">‚öôÔ∏è ConversationRelay Settings</h4>
            <p style="margin-bottom: 20px; color: #abb2bf; font-size: 14px;">
              Customize these settings before deploying. They'll be automatically injected into your code.
            </p>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
              <!-- Left Column -->
              <div>
                <!-- Welcome Greeting -->
                <div class="form-group" style="margin-bottom: 20px;">
                  <label style="display: block; margin-bottom: 8px; color: #4fc1ff; font-weight: 600;">
                    üëã Welcome Greeting
                  </label>
                  <input
                    type="text"
                    id="crWelcomeGreeting"
                    value="Hello! I am your AI assistant. How can I help you today?"
                    onchange="updateConversationRelayCode()"
                    style="width: 100%; padding: 10px; background: #1e1e1e; color: #abb2bf; border: 1px solid #3e4451; border-radius: 4px; font-size: 13px;"
                  />
                  <p style="font-size: 11px; color: #666; margin-top: 5px;">First message callers will hear</p>
                </div>

                <!-- Language -->
                <div class="form-group" style="margin-bottom: 20px;">
                  <label style="display: block; margin-bottom: 8px; color: #4fc1ff; font-weight: 600;">
                    üåç Language
                  </label>
                  <select
                    id="crLanguage"
                    onchange="updateConversationRelayCode()"
                    style="width: 100%; padding: 10px; background: #1e1e1e; color: #abb2bf; border: 1px solid #3e4451; border-radius: 4px; font-size: 13px;">
                    <option value="en-US">English (US)</option>
                    <option value="en-GB">English (UK)</option>
                    <option value="es-ES">Spanish (Spain)</option>
                    <option value="es-MX">Spanish (Mexico)</option>
                    <option value="fr-FR">French</option>
                    <option value="de-DE">German</option>
                    <option value="it-IT">Italian</option>
                    <option value="pt-BR">Portuguese (Brazil)</option>
                    <option value="multi">Multi-Language (Auto-Detect)</option>
                  </select>
                  <p style="font-size: 11px; color: #666; margin-top: 5px;">Use 'multi' for automatic language detection</p>
                </div>

                <!-- Transcription Provider -->
                <div class="form-group" style="margin-bottom: 20px;">
                  <label style="display: block; margin-bottom: 8px; color: #4fc1ff; font-weight: 600;">
                    üé§ Transcription Provider
                  </label>
                  <select
                    id="crTranscriptionProvider"
                    onchange="updateConversationRelayCode()"
                    style="width: 100%; padding: 10px; background: #1e1e1e; color: #abb2bf; border: 1px solid #3e4451; border-radius: 4px; font-size: 13px;">
                    <option value="deepgram">Deepgram (Recommended)</option>
                    <option value="google">Google Cloud STT</option>
                  </select>
                  <p style="font-size: 11px; color: #666; margin-top: 5px;">Speech-to-Text provider</p>
                </div>
              </div>

              <!-- Right Column -->
              <div>
                <!-- Interruptible -->
                <div class="form-group" style="margin-bottom: 20px;">
                  <label style="display: block; margin-bottom: 8px; color: #4fc1ff; font-weight: 600;">
                    üîá Interruption Control
                  </label>
                  <select
                    id="crInterruptible"
                    onchange="updateConversationRelayCode()"
                    style="width: 100%; padding: 10px; background: #1e1e1e; color: #abb2bf; border: 1px solid #3e4451; border-radius: 4px; font-size: 13px;">
                    <option value="speech">Speech (Recommended)</option>
                    <option value="any">Any (Speech or DTMF)</option>
                    <option value="dtmf">DTMF Only</option>
                    <option value="none">None</option>
                  </select>
                  <p style="font-size: 11px; color: #666; margin-top: 5px;">How callers can interrupt the AI</p>
                </div>

                <!-- DTMF Detection -->
                <div class="form-group" style="margin-bottom: 20px;">
                  <label style="display: block; margin-bottom: 8px; color: #4fc1ff; font-weight: 600;">
                    üî¢ DTMF Detection
                  </label>
                  <select
                    id="crDtmfDetection"
                    onchange="updateConversationRelayCode()"
                    style="width: 100%; padding: 10px; background: #1e1e1e; color: #abb2bf; border: 1px solid #3e4451; border-radius: 4px; font-size: 13px;">
                    <option value="true">Enabled</option>
                    <option value="false">Disabled</option>
                  </select>
                  <p style="font-size: 11px; color: #666; margin-top: 5px;">Enable keypad tone detection</p>
                </div>

                <!-- Speech Hints -->
                <div class="form-group" style="margin-bottom: 20px;">
                  <label style="display: block; margin-bottom: 8px; color: #4fc1ff; font-weight: 600;">
                    üí° Speech Recognition Hints
                  </label>
                  <input
                    type="text"
                    id="crHints"
                    value=""
                    placeholder="Twilio,ConversationRelay,API,WebSocket"
                    onchange="updateConversationRelayCode()"
                    style="width: 100%; padding: 10px; background: #1e1e1e; color: #abb2bf; border: 1px solid #3e4451; border-radius: 4px; font-size: 13px;"
                  />
                  <p style="font-size: 11px; color: #666; margin-top: 5px;">Comma-separated terms to improve recognition</p>
                </div>
              </div>
            </div>

            <button
              class="btn btn-primary"
              onclick="updateConversationRelayCode()"
              style="margin-top: 15px; width: 100%; padding: 12px;">
              üîÑ Apply Settings to Code
            </button>
          </div>

          <div class="code-editor">
            <div class="code-header">
              <span>üìù ConversationRelay TwiML Handler</span>
              <div style="display: flex; gap: 10px;">
                <button class="btn btn-success" style="padding: 6px 12px; font-size: 13px;" onclick="validateCode8()">‚úì Validate</button>
                <button class="btn-copy" onclick="copyCode('code8')">üìã Copy Code</button>
                <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 13px;" onclick="showSolution(8)">üí° Show Solution</button>
                <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 13px;" onclick="resetCode8()">Reset</button>
              </div>
            </div>
            <textarea class="code-textarea" id="code8">exports.handler = function(context, event, callback) {
  const twilio = require('twilio');
  const VoiceResponse = twilio.twiml.VoiceResponse;
  const response = new VoiceResponse();

  // Log SDK version for debugging
  console.log('Twilio SDK version:', require('twilio/package.json').version);

  // OLD: Basic TwiML (from Step 4)
  // response.say('Hello world', { voice: '${getDefaultVoice()}' });
  // response.dial('+1234567890');

  // NEW: Upgrade to ConversationRelay with AI
  const connect = response.connect();
  console.log('conversationRelay method exists?', typeof connect.conversationRelay);

  // Build WebSocket handler URL
  const wsHandlerUrl = 'wss://' + context.DOMAIN_NAME + '/websocket-handler';
  console.log('WebSocket handler URL:', wsHandlerUrl);
  console.log('Domain from context:', context.DOMAIN_NAME);

  // Popular ElevenLabs Voices - swap the voice ID to try different voices:
  // '9XfYMbJVZqPHaQtYnTAO' - Cody (Energetic Upbeat Educator) - DEFAULT
  // '4CrZuIW9am7gYAxgo2Af' - Shelley (Clear and confident British female)
  // '8N2ng9i2uiUWqstgmWlH' - Beth (Gentle and nurturing)
  // '90ipbRoKi4CpHXvKVtl0' - Anika (Customer Care Agent)
  // '9PvnT6XRzlljoaDG6Knu' - Ranbir (Warm & Friendly)
  // '7S3KNdLDL7aRgBVRQb1z' - Nathaniel (Deep Rich Mature British)
  // '6dcFFb31LVaCdYevmTAx' - Jerry (Presenter, Announcer, Event)

  connect.conversationRelay({
    // Required: WebSocket endpoint URL
    url: wsHandlerUrl,

    // Optional: Initial greeting message
    welcomeGreeting: 'Hello! I am your AI assistant. How can I help you today?',

    // Voice Configuration
    voice: '9XfYMbJVZqPHaQtYnTAO',  // Cody - Energetic Upbeat Educator
    ttsProvider: 'elevenlabs',       // Options: 'elevenlabs', 'amazon', 'google'

    // Language Settings
    language: 'en-US',               // Default language (or 'multi' for auto-detect)
    // transcriptionLanguage: 'en-US', // Override STT language
    // ttsLanguage: 'en-US',           // Override TTS language

    // Speech Recognition
    transcriptionProvider: 'deepgram', // Options: 'google', 'deepgram'
    // speechModel: 'nova-2',           // Deepgram model (nova-2, enhanced, base)

    // Interruption Control
    interruptible: 'speech',         // Options: 'none', 'dtmf', 'speech', 'any'

    // DTMF (Keypad) Detection
    dtmfDetection: true,             // Enable keypad tone detection

    // Speech Recognition Hints (helps with domain-specific terms)
    // hints: 'Twilio,ConversationRelay,WebSocket,API'
  });

  callback(null, response);
};</textarea>
</invoke>
          </div>

          <div id="step8Status" class="status-box"></div>

          ${!step6CodeValidated ? `
          <div id="step6Placeholder" class="instructions" style="margin-top: 20px; background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px;">
            <p style="margin: 0; color: #856404;">
              üí° <strong>Next Steps:</strong> Validate your code to unlock testing and deployment.
            </p>
          </div>
          ` : ''}

          <div id="step6TestCodeSection" style="margin: 30px 0; display: ${step6CodeValidated ? 'block' : 'none'};">
            <div style="padding: 20px; background: linear-gradient(135deg, #4fc1ff 0%, #0d122b 100%); border-radius: 12px; border: 2px solid #4fc1ff;">
              <h3 style="color: white; margin: 0 0 15px 0; font-size: 1.2rem;">üß™ Test Your Code</h3>
              <p style="color: rgba(255,255,255,0.9); margin-bottom: 15px;">
                Test your ConversationRelay TwiML generation to verify it's configured correctly.
              </p>
              <button class="btn btn-test" onclick="testCode8()" style="font-size: 1.1rem; padding: 15px 30px;">
                ‚ñ∂Ô∏è Test Code
              </button>
            </div>
          </div>

          <div class="console-output" id="console8" style="display: none;"></div>

          <div id="step6DeploySection" style="margin: 30px 0; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; border: 2px solid #5a67d8; display: ${step6CodeTested ? 'block' : 'none'};">
            <h3 style="color: white; margin: 0 0 15px 0; font-size: 1.2rem;">üíæ Ready to Deploy?</h3>
            <p style="color: rgba(255,255,255,0.9); margin-bottom: 20px;">
              Once you're happy with your ConversationRelay TwiML, click <strong>Commit Step 6</strong> to deploy it to your Twilio account.
              This will update your voice handler with AI-powered conversation capabilities and configure your phone number.
            </p>
            <button
              class="btn btn-success"
              id="commitStep6Btn"
              onclick="commitStep(6)"
              style="font-size: 1.1rem; padding: 15px 30px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
              üíæ Commit Step 6 - Deploy ConversationRelay
            </button>
            <div id="commitStep6Status" style="margin-top: 15px;"></div>
          </div>

          <!-- Voice testing moved to Step 7 after prompt is created -->

          <div style="margin: 30px 0; padding: 20px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 8px;">
            <h4 style="margin: 0 0 10px 0; color: #856404;">üìã Next Step: Create Your System Prompt</h4>
            <p style="margin: 0; color: #856404; line-height: 1.6;">
              Your ConversationRelay is deployed! Now move to Step 7 to create your AI's system prompt.
              You'll test your voice bot AFTER you've defined how your AI should behave.
            </p>
          </div>

          <!-- Hidden for now - shown in Step 7 -->
          <div id="step6TestCallSection" style="display: none;">
            <div style="text-align: center;">
              <h3 style="color: white; margin: 0 0 10px 0; font-size: 1.5rem;">üìû Ready to Test Your AI Voice Bot?</h3>
              <p style="color: rgba(255,255,255,0.95); margin-bottom: 20px; font-size: 1.1rem; line-height: 1.6;">
                Your ConversationRelay setup is complete! ${callDirection === 'inbound' ? 'Make a test call' : 'The system will call you'} to validate everything is working.
              </p>

              <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 20px; border-radius: 8px; margin: 20px 0;">
                ${callDirection === 'inbound' ? `
                  <p style="color: rgba(255,255,255,0.9); margin: 0 0 10px 0; font-size: 0.95rem;">
                    üì± <strong>Call this number to test:</strong>
                  </p>
                  <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-top: 10px;">
                    <div id="testPhoneNumber" style="font-size: 2rem; font-weight: bold; color: white; font-family: 'Courier New', monospace; letter-spacing: 2px;">
                      ${selectedPhoneNumber || 'Configure phone number in Step 3'}
                    </div>
                    <button
                      onclick="copyPhoneNumber()"
                      style="padding: 10px 20px; background: white; color: #059669; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 1rem; transition: all 0.3s;"
                      onmouseover="this.style.background='#f0fdf4'; this.style.transform='scale(1.05)'"
                      onmouseout="this.style.background='white'; this.style.transform='scale(1)'">
                      üìã Copy
                    </button>
                  </div>
                ` : `
                  <p style="color: rgba(255,255,255,0.9); margin: 0 0 15px 0; font-size: 0.95rem;">
                    üìû <strong>Test your AI bot with an outbound call</strong>
                  </p>
                  <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: white;">
                      Your Phone Number (to receive AI call):
                    </label>
                    <input type="tel" id="testAICallNumber" placeholder="+12345678901"
                           style="width: 100%; padding: 12px; background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.3); border-radius: 6px; font-size: 16px; font-family: 'Courier New', monospace;">
                    <p style="font-size: 12px; color: rgba(255,255,255,0.8); margin: 5px 0 0 0;">Enter YOUR number in E.164 format (e.g., +1234567890)</p>
                  </div>
                  <button onclick="makeAITestCall()" class="btn btn-primary" style="width: 100%; background: white; color: #059669; font-weight: 600; font-size: 1.1rem; padding: 15px;">
                    üìû Call Me Now with AI
                  </button>
                  <div id="aiTestCallStatus" style="margin-top: 15px;"></div>
                  <p style="color: rgba(255,255,255,0.8); margin: 15px 0 0 0; font-size: 0.9rem;">
                    Calling from: <strong style="color: white;">${selectedPhoneNumber || 'No number configured'}</strong>
                  </p>
                `}
              </div>

              <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin-top: 20px; text-align: left;">
                <p style="color: white; margin: 0 0 10px 0; font-weight: 600; font-size: 1rem;">
                  ‚úÖ What to expect:
                </p>
                <ul style="color: rgba(255,255,255,0.9); margin: 0; padding-left: 20px; line-height: 1.8;">
                  <li>AI greeting: "Hello! I am your AI assistant. How can I help you today?"</li>
                  <li>Natural conversation powered by OpenAI</li>
                  <li>Voice selected: <strong>${getDefaultVoice()}</strong> (${getTTSProviderName()})</li>
                  <li>Real-time bidirectional streaming via ConversationRelay</li>
                </ul>
              </div>

              <p style="color: rgba(255,255,255,0.85); margin: 20px 0 0 0; font-size: 0.9rem; font-style: italic;">
                üí° Tip: Try asking questions or having a conversation to test the AI's responses!
              </p>
            </div>
          </div>

          <div class="button-group">
            <button class="btn btn-secondary" onclick="prevStep()">‚Üê Back</button>
            <button class="btn btn-primary" id="nextBtn8" onclick="nextStep()" disabled>
              Next: Test AI Voice Bot ‚Üí
            </button>
          </div>
        </div>
      `;
    }

    // Syntax validation helper for debugger
    function validateJavaScriptSyntax(code) {
      try {
        // Use Function constructor to check syntax without executing
        // Wrap in async function to support await syntax
        new Function(`return (async function() { ${code} });`)();
        return { valid: true };
      } catch (error) {
        return {
          valid: false,
          error: error.message,
          line: error.lineNumber || 'unknown',
          column: error.columnNumber || 'unknown'
        };
      }
    }

    function testCode8() {
      const code = document.getElementById('code8').value;
      const console8 = document.getElementById('console8');
      console8.style.display = 'block';

      // First, validate syntax
      console8.innerHTML = '<div class="console-line">üîç Validating JavaScript syntax...</div>';
      const validation = validateJavaScriptSyntax(code);

      if (!validation.valid) {
        console8.innerHTML += `<div class="console-line error">‚ùå Syntax Error: ${validation.error}</div>`;
        console8.innerHTML += `<div class="console-line error">   Location: Line ${validation.line}, Column ${validation.column}</div>`;
        console8.innerHTML += '<div class="console-line info">üí° Fix the syntax error before testing or deploying.</div>';
        return;
      }

      console8.innerHTML += '<div class="console-line success">‚úì Syntax validation passed</div>';

      // Check for TODOs and warn
      const todoMatches = code.match(/\/\/\s*TODO:/gi);
      if (todoMatches && todoMatches.length > 3) {
        console8.innerHTML += `<div class="console-line warning">‚ö†Ô∏è Warning: ${todoMatches.length} TODO comments found. Make sure to implement them!</div>`;
      }

      try {
        // Get dynamic values
        const wsHandlerUrl = `wss://${websocketUrl}/websocket-handler`;
        const voice = getDefaultVoice();

        // Simulate execution
        console8.innerHTML = `
          <div class="console-line">‚ñ∂Ô∏è Testing ConversationRelay TwiML generation...</div>
          <div class="console-line info">WebSocket Handler URL: ${wsHandlerUrl}</div>
          <div class="console-line info">Voice: ${voice}</div>
          <div class="console-line info">TTS Provider: ${ttsProvider}</div>
          <div class="console-line">Output:</div>
          <div class="console-line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div>
          <div class="console-line">&lt;Response&gt;</div>
          <div class="console-line">  &lt;Connect&gt;</div>
          <div class="console-line">    &lt;ConversationRelay</div>
          <div class="console-line">      url="${wsHandlerUrl}"</div>
          <div class="console-line">      voice="${voice}"</div>
          <div class="console-line">      ttsProvider="${ttsProvider}"</div>
          <div class="console-line">      welcomeGreeting="Hello! I am your AI assistant. How can I help you today?"</div>
          <div class="console-line">    /&gt;</div>
          <div class="console-line">  &lt;/Connect&gt;</div>
          <div class="console-line">&lt;/Response&gt;</div>
          <div class="console-line success">‚úì TwiML will connect calls to your deployed WebSocket handler</div>
        `;

        // Mark as tested and reveal deploy section
        step6CodeTested = true;
        const deploySection = document.getElementById('step6DeploySection');
        if (deploySection) {
          deploySection.style.display = 'block';
          setTimeout(() => {
            deploySection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          }, 300);
        }
      } catch (error) {
        console8.innerHTML = `<div class="console-line error">‚ùå ${error.message}</div>`;
      }
    }

    function validateCode8() {
      const code = document.getElementById('code8').value;

      const checks = {
        hasTwiml: code.includes('twiml') || code.includes('VoiceResponse'),
        hasConnect: code.includes('.connect()'),
        hasConversationRelay: code.includes('conversationRelay'),
        hasUrl: code.includes('url:'),
        hasVoice: code.includes('voice:'),
        hasTTS: code.includes('ttsProvider')
      };

      const allValid = Object.values(checks).every(v => v);

      if (allValid) {
        conversationRelayCreated = true;
        step6CodeValidated = true;
        showStatus('step8Status', 'success', '‚úÖ Perfect! ConversationRelay TwiML is valid. Test it below!');
        updateProgressBar();

        // Hide placeholder and reveal test code section
        const placeholder = document.getElementById('step6Placeholder');
        if (placeholder) placeholder.style.display = 'none';
        const testCodeSection = document.getElementById('step6TestCodeSection');
        if (testCodeSection) {
          testCodeSection.style.display = 'block';
          setTimeout(() => {
            testCodeSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          }, 300);
        }
      } else {
        const missing = [];
        if (!checks.hasTwiml) missing.push('VoiceResponse object');
        if (!checks.hasConnect) missing.push('connect() method');
        if (!checks.hasConversationRelay) missing.push('conversationRelay()');
        if (!checks.hasUrl) missing.push('url parameter');
        if (!checks.hasVoice) missing.push('voice parameter');
        if (!checks.hasTTS) missing.push('ttsProvider parameter');

        showStatus('step8Status', 'error', `‚ùå Missing: ${missing.join(', ')}`);
      }
    }

    function resetCode8() {
      document.getElementById('code8').value = `exports.handler = function(context, event, callback) {
  const twilio = require('twilio');
  const VoiceResponse = twilio.twiml.VoiceResponse;
  const response = new VoiceResponse();

  // Log SDK version for debugging
  console.log('Twilio SDK version:', require('twilio/package.json').version);

  // OLD: Basic TwiML (from Step 4)
  // response.say('Hello world', { voice: '${getDefaultVoice()}' });
  // response.dial('+1234567890');

  // NEW: Upgrade to ConversationRelay with AI
  const connect = response.connect();
  console.log('conversationRelay method exists?', typeof connect.conversationRelay);
  const wsHandlerUrl = \`wss://\${context.DOMAIN_NAME}/websocket-handler\`;

  connect.conversationRelay({
    url: wsHandlerUrl,
    voice: '${getDefaultVoice()}',
    ttsProvider: '${ttsProvider}',
    welcomeGreeting: 'Hello! I am your AI assistant. How can I help you today?',
    dtmfDetection: true
  });

  callback(null, response);
};`;
      document.getElementById('console8').innerHTML = '';
      document.getElementById('step8Status').innerHTML = '';
    }

    // Update ConversationRelay code based on settings
    function updateConversationRelayCode() {
      const welcomeGreeting = document.getElementById('crWelcomeGreeting')?.value || 'Hello! I am your AI assistant. How can I help you today?';
      const language = document.getElementById('crLanguage')?.value || 'en-US';
      const transcriptionProvider = document.getElementById('crTranscriptionProvider')?.value || 'deepgram';
      const interruptible = document.getElementById('crInterruptible')?.value || 'speech';
      const dtmfDetection = document.getElementById('crDtmfDetection')?.value || 'true';
      const hints = document.getElementById('crHints')?.value || '';
      const voice = document.getElementById('conversationRelayVoice')?.value || getDefaultVoice();
      const ttsProviderValue = document.getElementById('ttsProvider')?.value || 'elevenlabs';

      // Build hints line if provided
      const hintsLine = hints ? `    hints: '${hints}',` : `    // hints: 'Twilio,ConversationRelay,WebSocket,API'`;

      const code = `exports.handler = function(context, event, callback) {
  const twilio = require('twilio');
  const VoiceResponse = twilio.twiml.VoiceResponse;
  const response = new VoiceResponse();

  // Log SDK version for debugging
  console.log('Twilio SDK version:', require('twilio/package.json').version);

  const connect = response.connect();
  console.log('conversationRelay method exists?', typeof connect.conversationRelay);

  // Build WebSocket handler URL
  const wsHandlerUrl = \`wss://\${context.DOMAIN_NAME}/websocket-handler\`;
  console.log('WebSocket handler URL:', wsHandlerUrl);
  console.log('Domain from context:', context.DOMAIN_NAME);

  connect.conversationRelay({
    // Required: WebSocket endpoint URL
    url: wsHandlerUrl,

    // Optional: Initial greeting message
    welcomeGreeting: '${welcomeGreeting.replace(/'/g, "\\'")}',

    // Voice Configuration
    voice: '${voice}',
    ttsProvider: '${ttsProviderValue}',

    // Language Settings
    language: '${language}',

    // Speech Recognition
    transcriptionProvider: '${transcriptionProvider}',

    // Interruption Control
    interruptible: '${interruptible}',

    // DTMF (Keypad) Detection
    dtmfDetection: ${dtmfDetection},

    // Speech Recognition Hints (helps with domain-specific terms)
${hintsLine}
  });

  callback(null, response);
};`;

      document.getElementById('code8').value = code;

      // Show success message
      showStatus('step8Status', 'success', '‚úÖ Code updated with your settings! Review and test when ready.');
    }

    // =========================================================================
    // STEP 6: WEBSOCKET - Build WebSocket Handler (OLD STEP 4)
    // =========================================================================

    function renderStep6_WebSocket() {
      return `
        <div class="step-content active">
          <div class="step-header">
            <h2>Step 5: Build WebSocket Handler</h2>
            <p>Handle real-time conversation events and connect to OpenAI</p>
          </div>

          <!-- OpenAI Configuration -->
          <div class="service-card">
            <h4>ü§ñ OpenAI Configuration</h4>
            <p style="font-size: 13px; color: #666; margin-bottom: 15px;">
              Your WebSocket handler will send conversation transcripts to OpenAI and return AI-generated responses.
            </p>

            ${openaiConnected ? `
              <div style="background: #d4edda; padding: 20px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #c3e6cb;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                  <span style="font-size: 1.5rem;">‚úÖ</span>
                  <div>
                    <strong style="color: #155724; font-size: 1.05rem;">OpenAI API Key Connected${studentDemoMode ? ' (Demo)' : ''}</strong><br>
                    <span style="color: #155724; font-size: 13px;">${studentDemoMode ? 'sk-demo-****...****' : (openaiApiKey ? 'sk-****...****' : 'Connected')}</span>
                  </div>
                </div>
                ${studentDemoMode ? `
                  <p style="color: #155724; margin: 0 0 10px 0; font-size: 13px;">
                    üìù Using demo API key - AI responses are simulated.
                  </p>
                ` : ''}
                <button class="btn" style="padding: 8px 16px; font-size: 13px; background: white; color: #666; border: 1px solid #ddd;" onclick="openaiConnected = false; openaiApiKey = null; renderStepContent();">
                  üîÑ Change API Key
                </button>
              </div>
            ` : `
              <div class="form-group">
                <label>OpenAI API Key</label>
                <input type="password" id="openaiKey" placeholder="sk-proj-********************************" value="${openaiApiKey || ''}" />
                <p style="font-size: 12px; color: #666; margin-top: 5px;">
                  Get your API key from <a href="https://platform.openai.com/api-keys" target="_blank">OpenAI Platform</a>
                </p>
              </div>
              <button class="btn btn-primary" onclick="connectOpenAI()">Connect OpenAI</button>
              <div id="openaiStatus" class="connection-status" style="display: none; margin-top: 10px;"></div>
            `}
          </div>

          <div class="instructions">
            <h3>üìã Your Task</h3>
            <p>Create a WebSocket handler that processes conversation events and integrates with OpenAI.</p>
            <p style="margin-top: 15px;">
              üìö <strong>Documentation:</strong>
              <a href="https://www.twilio.com/docs/voice/twiml/connect/conversationrelay#websocket-messages" target="_blank">WebSocket Messages</a> |
              <a href="https://www.twilio.com/docs/voice/twiml/connect/conversationrelay#events" target="_blank">Event Types</a> |
              <a href="https://www.twilio.com/docs/serverless/functions" target="_blank">Serverless Functions</a>
            </p>
          </div>

          <div class="code-editor">
            <div class="code-header">
              <span>üìù WebSocket Handler</span>
              <div style="display: flex; gap: 10px;">
                <button class="btn btn-success" style="padding: 6px 12px; font-size: 13px;" onclick="validateCode7()">‚úì Validate</button>
                <button class="btn-copy" onclick="copyCode('code7')">üìã Copy Code</button>
                <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 13px;" onclick="showSolution(7)">üí° Show Solution</button>
                <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 13px;" onclick="resetCode7()">Reset</button>
              </div>
            </div>
            <textarea class="code-textarea" id="code7">/**
 * WebSocket Handler for Real-Time Voice AI (Node.js/Express)
 *
 * ‚ö†Ô∏è IMPORTANT: WebSocket servers cannot run on Twilio Serverless!
 * This code is designed to run on:
 * - Your own server (Node.js + Express)
 * - Heroku, Railway, Render, or similar platforms
 * - The GitHub repository you'll clone for this workshop
 *
 * How it works:
 * 1. Twilio ConversationRelay connects via WebSocket
 * 2. Twilio sends caller's speech as text (transcripts)
 * 3. You process with AI (OpenAI in this example)
 * 4. You send AI response back to Twilio
 * 5. Twilio converts response to speech and plays to caller
 */

const express = require('express');
const { WebSocketServer } = require('ws');
const OpenAI = require('openai');

const app = express();
const port = process.env.PORT || 3000;

// ============================================================================
// STEP 1: Initialize OpenAI Client
// ============================================================================
const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY // Store API key in environment variable
});

// ============================================================================
// STEP 2: Create HTTP Server
// ============================================================================
const server = app.listen(port, () => {
  console.log('[SERVER] WebSocket server running on port ' + port);
});

// ============================================================================
// STEP 3: Create WebSocket Server
// ============================================================================
const wss = new WebSocketServer({
  server,  // Attach to existing HTTP server
  path: '/websocket-handler'  // Path where Twilio will connect
});

console.log('[SERVER] WebSocket server ready at ws://localhost:' + port + '/websocket-handler');

// ============================================================================
// STEP 4: Handle WebSocket Connections
// ============================================================================
wss.on('connection', (ws) => {
  console.log('[WEBSOCKET] New connection from Twilio ConversationRelay');

  // --------------------------------------------------------------------------
  // Event: MESSAGE - Handle incoming messages from Twilio
  // --------------------------------------------------------------------------
  // Twilio sends JSON messages with different event types:
  // - 'start': Call begins (includes streamSid)
  // - 'transcript': Caller spoke (speech-to-text result)
  // - 'stop': Call ended
  ws.on('message', async (data) => {
    try {
      const message = JSON.parse(data.toString());
      console.log('[EVENT] Received event:', message.event);

      switch (message.event) {
        // ----------------------------------------------------------------------
        // Event: START - Call just started
        // ----------------------------------------------------------------------
        case 'start':
          console.log('[CALL] Call started, StreamSid:', message.streamSid);

          // Optional: Send acknowledgment back to Twilio
          ws.send(JSON.stringify({
            event: 'connected',
            streamSid: message.streamSid
          }));
          break;

        // ----------------------------------------------------------------------
        // Event: TRANSCRIPT - Caller spoke, we got their words
        // ----------------------------------------------------------------------
        case 'transcript':
          console.log('[TRANSCRIPT] Caller said:', message.transcript);

          // ====================================================================
          // AI PROCESSING: Send transcript to OpenAI for intelligent response
          // ====================================================================
          try {
            const completion = await openai.chat.completions.create({
              model: 'gpt-4o-mini',  // Fast, affordable model (good for voice)
              messages: [
                {
                  role: 'system',
                  content: 'You are a helpful voice assistant. Keep responses brief and conversational since they will be spoken aloud.'
                },
                {
                  role: 'user',
                  content: message.transcript
                }
              ],
              max_tokens: 150  // Limit response length for voice (faster TTS)
            });

            const aiResponse = completion.choices[0].message.content;
            console.log('[AI] AI response:', aiResponse);

            // ==================================================================
            // Send AI response back to Twilio ‚Üí Twilio speaks it to caller
            // ==================================================================
            ws.send(JSON.stringify({
              event: 'text',
              text: aiResponse
            }));

          } catch (aiError) {
            console.error('[ERROR] OpenAI API error:', aiError);

            // Send error response to caller
            ws.send(JSON.stringify({
              event: 'text',
              text: 'I apologize, I encountered an error processing your request.'
            }));
          }
          break;

        // ----------------------------------------------------------------------
        // Event: STOP - Call ended
        // ----------------------------------------------------------------------
        case 'stop':
          console.log('[CALL] Call ended');
          ws.close();
          break;

        // ----------------------------------------------------------------------
        // Unknown events (log for debugging)
        // ----------------------------------------------------------------------
        default:
          console.log('[EVENT] Unknown event:', message.event);
      }

    } catch (parseError) {
      console.error('[ERROR] Error parsing message:', parseError);
    }
  });

  // --------------------------------------------------------------------------
  // Event: ERROR - WebSocket connection error
  // --------------------------------------------------------------------------
  ws.on('error', (error) => {
    console.error('‚ùå WebSocket error:', error);
  });

  // --------------------------------------------------------------------------
  // Event: CLOSE - WebSocket connection closed
  // --------------------------------------------------------------------------
  ws.on('close', () => {
    console.log('[WEBSOCKET] Connection closed');
  });
});

// ============================================================================
// STEP 5: Health Check Endpoint (Optional but recommended)
// ============================================================================
app.get('/health', (req, res) => {
  res.json({ status: 'healthy', websocket: 'ready' });
});

// ============================================================================
// DEPLOYMENT NOTES
// ============================================================================
// To deploy this code:
// 1. Push to GitHub repository
// 2. Deploy to a platform that supports WebSocket:
//    - Railway: railway.app (easiest)
//    - Render: render.com
//    - Heroku: heroku.com
//    - Your own VPS
// 3. Set environment variable: OPENAI_API_KEY=your_key_here
// 4. Update your ConversationRelay TwiML with the deployed WSS URL:
//    wss://your-app.railway.app/websocket-handler</textarea>
</invoke>
          </div>

          <div id="step7Status" class="status-box"></div>

          ${!step5CodeValidated || !openaiApiKey ? `
          <div id="step5Placeholder" class="instructions" style="margin-top: 20px; background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px;">
            <p style="margin: 0; color: #856404;">
              üí° <strong>Next Steps:</strong>
              ${!openaiApiKey ? 'Configure your OpenAI API key above, then ' : ''}
              validate your code to unlock deployment and testing options.
            </p>
          </div>
          ` : ''}

          <div id="step5DeploySection" style="margin: 30px 0; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; border: 2px solid #5a67d8; display: ${step5CodeValidated && openaiApiKey ? 'block' : 'none'};">
            <h3 style="color: white; margin: 0 0 15px 0; font-size: 1.2rem;">üíæ Ready to Deploy?</h3>
            <p style="color: rgba(255,255,255,0.9); margin-bottom: 20px;">
              Once you're happy with your WebSocket handler, click <strong>Commit Step 5</strong> to deploy it to your Twilio account.
              This will update your service with the WebSocket handling functionality.
            </p>
            <button
              class="btn btn-success"
              id="commitStep5Btn"
              onclick="commitStep(5)"
              style="font-size: 1.1rem; padding: 15px 30px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
              üíæ Commit Step 5 - Deploy WebSocket Handler
            </button>
            <div id="commitStep5Status" style="margin-top: 15px;"></div>
          </div>

          <div id="step5TestSection" style="margin: 30px 0; padding: 20px; background: linear-gradient(135deg, #4fc1ff 0%, #0d122b 100%); border-radius: 12px; border: 2px solid #4fc1ff; display: ${step5Deployed ? 'block' : 'none'};">
            <h3 style="color: white; margin: 0 0 15px 0; font-size: 1.2rem;">üß™ Test Your WebSocket Handler Interactively</h3>
            <p style="color: rgba(255,255,255,0.9); margin-bottom: 15px;">
              After deploying, test your WebSocket handler by sending messages and seeing OpenAI responses.
            </p>
            <p style="color: rgba(255,255,255,0.8); margin-bottom: 20px; font-size: 0.9rem;">
              ‚è±Ô∏è <strong>Note:</strong> Wait 30 seconds after deployment for changes to propagate before testing.
            </p>

            <!-- Interactive Test Input -->
            <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
              <label style="display: block; margin-bottom: 8px; font-weight: 600; color: white;">
                üí¨ Test Message:
              </label>
              <input
                type="text"
                id="testWebSocketMessage"
                placeholder="e.g., Hello, how are you?"
                style="width: 100%; padding: 12px; background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.3); border-radius: 6px; font-size: 14px; margin-bottom: 5px;"
                onkeypress="if(event.key === 'Enter') testSingleWebSocketMessage()"
              />
              <p style="color: rgba(255,255,255,0.7); font-size: 12px; margin: 0 0 10px 0;">
                üí° Try: simple greetings, questions, or casual conversation
              </p>
              <button class="btn btn-test" onclick="testSingleWebSocketMessage()" style="width: 100%; font-size: 1rem; padding: 12px;">
                ‚ñ∂Ô∏è Send Test Message
              </button>
            </div>
          </div>

          <div class="console-output" id="console7" style="display: none;"></div>

          <div class="button-group">
            <button class="btn btn-secondary" onclick="prevStep()">‚Üê Back</button>
            <button class="btn btn-primary" id="nextBtn7" onclick="nextStep()" disabled>
              Next: Upgrade to ConversationRelay ‚Üí
            </button>
          </div>
        </div>
      `;
    }

    async function testCode7() {
      const code = document.getElementById('code7').value;
      const console7 = document.getElementById('console7');
      console7.style.display = 'block';
      console7.innerHTML = '<div class="console-line">üîç Validating JavaScript syntax...</div>';

      // First, validate syntax
      const validation = validateJavaScriptSyntax(code);

      if (!validation.valid) {
        console7.innerHTML += `<div class="console-line error">‚ùå Syntax Error: ${validation.error}</div>`;
        console7.innerHTML += `<div class="console-line error">   Location: Line ${validation.line}, Column ${validation.column}</div>`;
        console7.innerHTML += '<div class="console-line info">üí° Fix the syntax error before testing or deploying.</div>';
        return;
      }

      console7.innerHTML += '<div class="console-line success">‚úì Syntax validation passed</div>';

      // Check for TODOs and warn
      const todoMatches = code.match(/\/\/\s*TODO:/gi);
      if (todoMatches && todoMatches.length > 3) {
        console7.innerHTML += `<div class="console-line warning">‚ö†Ô∏è Warning: ${todoMatches.length} TODO comments found. Make sure to implement them!</div>`;
      }

      console7.innerHTML += '<div class="console-line">‚ñ∂Ô∏è Testing WebSocket handler with OpenAI...</div>';

      if (twilioCredentials?.demoMode) {
        console7.innerHTML += `
          <div class="console-line info">üìù Demo Mode: Simulating WebSocket test...</div>
          <div class="console-line success">‚úì WebSocket connection established</div>
          <div class="console-line info">Event: start received</div>
          <div class="console-line info">Transcript: "Hello, how are you?"</div>
          <div class="console-line success">‚úì AI Response: "I'm doing well, thank you! How can I help you today?"</div>
        `;
        return;
      }

      // Check if OpenAI key is configured
      if (!openaiApiKey) {
        console7.innerHTML += '<div class="console-line error">‚ùå Please configure your OpenAI API key first</div>';
        return;
      }

      try {
        // First deploy the WebSocket handler if needed
        if (!deployedServiceSid) {
          console7.innerHTML += '<div class="console-line warning">‚ö†Ô∏è No deployed service found.</div>';
          console7.innerHTML += '<div class="console-line info">üìù To test your WebSocket handler:</div>';
          console7.innerHTML += '<div class="console-line info">  1. Validate your code (click ‚úì Validate)</div>';
          console7.innerHTML += '<div class="console-line info">  2. Deploy it (click üíæ Commit Step 6 below)</div>';
          console7.innerHTML += '<div class="console-line info">  3. Then come back and click ‚ñ∂Ô∏è Test Code</div>';
          return;
        }

        // Test the deployed WebSocket handler
        console7.innerHTML += '<div class="console-line info">üîç Testing deployed WebSocket handler...</div>';

        const testResponse = await fetch('/test-websocket-handler', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            serviceSid: deployedServiceSid,
            domain: websocketUrl, // Already just the domain without protocol
            openaiApiKey: openaiApiKey,
            ...twilioCredentials
          })
        });

        const testData = await testResponse.json();

        if (!testData.success) {
          console7.innerHTML += `<div class="console-line error">‚ùå Test failed: ${testData.error}</div>`;

          // Check for specific error types and provide debugging info
          if (testData.error.includes('401') || testData.error.includes('Authentication')) {
            console7.innerHTML += '<div class="console-line error">üîê OpenAI Authentication Error</div>';
            console7.innerHTML += '<div class="console-line info">   Possible causes:</div>';
            console7.innerHTML += '<div class="console-line info">   ‚Ä¢ Invalid OpenAI API key</div>';
            console7.innerHTML += '<div class="console-line info">   ‚Ä¢ API key expired or revoked</div>';
            console7.innerHTML += '<div class="console-line info">   ‚Ä¢ Check your key at https://platform.openai.com/api-keys</div>';
          } else if (testData.error.includes('429') || testData.error.includes('rate limit')) {
            console7.innerHTML += '<div class="console-line error">‚è±Ô∏è Rate Limit Error</div>';
            console7.innerHTML += '<div class="console-line info">   ‚Ä¢ Too many requests to OpenAI API</div>';
            console7.innerHTML += '<div class="console-line info">   ‚Ä¢ Wait a minute and try again</div>';
          } else if (testData.error.includes('404')) {
            console7.innerHTML += '<div class="console-line error">üîç WebSocket Handler Not Found</div>';
            console7.innerHTML += '<div class="console-line info">   ‚Ä¢ Handler may not be deployed yet</div>';
            console7.innerHTML += '<div class="console-line info">   ‚Ä¢ Wait 10 seconds for deployment to propagate</div>';
            console7.innerHTML += '<div class="console-line info">   ‚Ä¢ Check Twilio Console logs for deployment errors</div>';
          } else if (testData.error.includes('Twilio')) {
            console7.innerHTML += '<div class="console-line error">üìû Twilio API Error</div>';
            console7.innerHTML += `<div class="console-line info">   ${testData.error}</div>`;
          } else if (testData.error.includes('syntax') || testData.error.includes('SyntaxError')) {
            console7.innerHTML += '<div class="console-line error">üí• Code Syntax Error in Deployed Function</div>';
            console7.innerHTML += '<div class="console-line info">   ‚Ä¢ Your code has a syntax error that was deployed</div>';
            console7.innerHTML += '<div class="console-line info">   ‚Ä¢ Fix the error and redeploy</div>';
            console7.innerHTML += `<div class="console-line info">   Error: ${testData.error}</div>`;
          }

          return;
        }

        console7.innerHTML += `<div class="console-line success">‚úì WebSocket handler deployed at: ${testData.handlerUrl}</div>`;

        if (testData.aiResponse) {
          console7.innerHTML += '<div class="console-line info">ü§ñ Testing OpenAI integration...</div>';
          console7.innerHTML += `<div class="console-line info">üí¨ Test query: "${testData.testQuery}"</div>`;
          console7.innerHTML += `<div class="console-line success">ü§ñ AI Response: "${testData.aiResponse}"</div>`;
        }

        console7.innerHTML += '<div class="console-line success">‚úÖ Your WebSocket handler is ready!</div>';
        console7.innerHTML += `<div class="console-line info">üìù ${testData.note}</div>`;

        // Enable Next button
        document.getElementById('nextBtn7').disabled = false;
        showStatus('step7Status', 'success', 'üéâ WebSocket handler tested successfully! You can now proceed to Step 6.');

        return;  // Skip the old WebSocket connection code below

        const wsUrl = `wss://${websocketUrl}/websocket-handler`;
        console7.innerHTML += `<div class="console-line info">üîå Connecting to: ${wsUrl}</div>`;

        const ws = new WebSocket(wsUrl);
        let responseReceived = false;

        // Set timeout for test
        const timeout = setTimeout(() => {
          if (!responseReceived) {
            ws.close();
            console7.innerHTML += '<div class="console-line error">‚ùå Timeout: No response received after 10 seconds</div>';
          }
        }, 10000);

        ws.onopen = () => {
          console7.innerHTML += '<div class="console-line success">‚úì WebSocket connected</div>';

          // Send start event
          console7.innerHTML += '<div class="console-line info">üì§ Sending start event...</div>';
          ws.send(JSON.stringify({
            event: 'start',
            streamSid: 'test-stream-' + Date.now()
          }));

          // Send test transcript
          setTimeout(() => {
            console7.innerHTML += '<div class="console-line info">üì§ Sending transcript: "Hello, can you hear me?"</div>';
            ws.send(JSON.stringify({
              event: 'transcript',
              transcript: 'Hello, can you hear me?'
            }));
          }, 500);
        };

        ws.onmessage = (event) => {
          responseReceived = true;
          clearTimeout(timeout);

          try {
            const message = JSON.parse(event.data);
            console7.innerHTML += `<div class="console-line success">üì• Received: ${JSON.stringify(message, null, 2)}</div>`;

            if (message.event === 'text') {
              console7.innerHTML += `<div class="console-line success">ü§ñ AI Response: "${message.text}"</div>`;
              console7.innerHTML += '<div class="console-line success">‚úÖ WebSocket handler is working correctly!</div>';

              // Enable Next button on successful test
              document.getElementById('nextBtn7').disabled = false;
              showStatus('step7Status', 'success', 'üéâ WebSocket handler tested successfully! You can now proceed to Step 6.');
            }
          } catch (e) {
            console7.innerHTML += `<div class="console-line info">üì• Received: ${event.data}</div>`;
          }

          // Close connection after receiving response
          setTimeout(() => {
            ws.send(JSON.stringify({ event: 'stop' }));
            ws.close();
          }, 1000);
        };

        ws.onerror = (error) => {
          clearTimeout(timeout);
          console7.innerHTML += `<div class="console-line error">‚ùå WebSocket error: ${error.message || 'Connection failed'}</div>`;
          console7.innerHTML += `<div class="console-line error">Error type: ${error.type}</div>`;
          console7.innerHTML += `<div class="console-line error">URL attempted: ${wsUrl}</div>`;
          console7.innerHTML += '<div class="console-line info">üí° Possible issues:</div>';
          console7.innerHTML += '<div class="console-line info">  1. WebSocket handler not deployed yet</div>';
          console7.innerHTML += '<div class="console-line info">  2. Deployment still propagating (wait 10 seconds and retry)</div>';
          console7.innerHTML += '<div class="console-line info">  3. Code has syntax errors - check Twilio Console logs</div>';
        };

        ws.onclose = (event) => {
          console7.innerHTML += `<div class="console-line info">üîå WebSocket connection closed (code: ${event.code}, reason: ${event.reason || 'none'})</div>`;
          if (!responseReceived) {
            console7.innerHTML += '<div class="console-line warning">‚ö†Ô∏è Connection closed before receiving AI response</div>';
          }
        };

      } catch (error) {
        console7.innerHTML += `<div class="console-line error">‚ùå Test failed: ${error.message}</div>`;

        // Provide debugging hints based on error type
        if (error.message.includes('fetch') || error.message.includes('network')) {
          console7.innerHTML += '<div class="console-line info">üí° Network Error - Check your internet connection</div>';
        } else if (error.message.includes('JSON')) {
          console7.innerHTML += '<div class="console-line info">üí° Invalid response from server - Check Twilio Console logs</div>';
        } else {
          console7.innerHTML += '<div class="console-line info">üí° Check browser console (F12) for full error details</div>';
        }
      }
    }

    // Test WebSocket with a single custom message
    async function testSingleWebSocketMessage() {
      const console7 = document.getElementById('console7');
      const messageInput = document.getElementById('testWebSocketMessage');
      const userMessage = messageInput?.value?.trim();

      if (!userMessage) {
        console7.style.display = 'block';
        console7.innerHTML = '<div class="console-line error">‚ùå Please enter a message to test</div>';
        return;
      }

      // Check if OpenAI key is configured
      if (!openaiApiKey) {
        console7.style.display = 'block';
        console7.innerHTML = '<div class="console-line error">‚ùå Please configure your OpenAI API key first</div>';
        return;
      }

      // Check if deployed
      if (!deployedServiceSid) {
        console7.style.display = 'block';
        console7.innerHTML = '<div class="console-line error">‚ùå Please deploy your WebSocket handler first (click üíæ Commit Step 5)</div>';
        return;
      }

      console7.style.display = 'block';
      console7.innerHTML = `<div class="console-line">üí¨ Testing: "${userMessage}"</div>`;

      try {
        // Use the tutorial-proxy to test OpenAI without a system prompt (just echo test)
        const response = await fetch('/api/tutorial-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'testOpenAI',
            message: userMessage,
            openaiApiKey: openaiApiKey,
            ...twilioCredentials
          })
        });

        const data = await response.json();

        if (data.success) {
          console7.innerHTML += `<div class="console-line success">ü§ñ AI Response: "${data.response}"</div>`;
          console7.innerHTML += '<div class="console-line success">‚úÖ WebSocket ‚Üí OpenAI connection working!</div>';

          // Clear input for next test
          messageInput.value = '';

          // Enable Next button after successful test
          document.getElementById('nextBtn7').disabled = false;
          showStatus('step7Status', 'success', 'üéâ WebSocket handler tested successfully! You can now proceed to Step 6.');
        } else {
          console7.innerHTML += `<div class="console-line error">‚ùå Error: ${data.error}</div>`;

          // Provide debugging hints for OpenAI errors
          if (data.error.includes('401') || data.error.includes('Incorrect API key')) {
            console7.innerHTML += '<div class="console-line error">üîê OpenAI Authentication Error</div>';
            console7.innerHTML += '<div class="console-line info">   ‚Ä¢ Your API key is invalid</div>';
            console7.innerHTML += '<div class="console-line info">   ‚Ä¢ Get a valid key at https://platform.openai.com/api-keys</div>';
          } else if (data.error.includes('429')) {
            console7.innerHTML += '<div class="console-line error">‚è±Ô∏è Rate Limit Exceeded</div>';
            console7.innerHTML += '<div class="console-line info">   ‚Ä¢ Too many requests to OpenAI</div>';
            console7.innerHTML += '<div class="console-line info">   ‚Ä¢ Wait 60 seconds and try again</div>';
          } else if (data.error.includes('insufficient_quota')) {
            console7.innerHTML += '<div class="console-line error">üí≥ Insufficient Quota</div>';
            console7.innerHTML += '<div class="console-line info">   ‚Ä¢ Your OpenAI account has no credits</div>';
            console7.innerHTML += '<div class="console-line info">   ‚Ä¢ Add credits at https://platform.openai.com/account/billing</div>';
          }
        }
      } catch (error) {
        console7.innerHTML += `<div class="console-line error">‚ùå Test failed: ${error.message}</div>`;

        // Provide debugging hints based on error type
        if (error.message.includes('fetch') || error.message.includes('network')) {
          console7.innerHTML += '<div class="console-line info">üí° Network Error - Check your internet connection</div>';
        } else if (error.message.includes('JSON')) {
          console7.innerHTML += '<div class="console-line info">üí° Invalid response from server</div>';
        }
      }
    }

    function validateCode7() {
      const code = document.getElementById('code7').value;

      // Count TODO comments vs actual implementation
      const lines = code.split('\n');
      const todoLines = lines.filter(line => line.trim().startsWith('// TODO:')).length;
      const codeLines = lines.filter(line => {
        const trimmed = line.trim();
        return trimmed &&
               !trimmed.startsWith('//') &&
               !trimmed.startsWith('/*') &&
               trimmed !== '{' &&
               trimmed !== '}' &&
               trimmed !== '};';
      }).length;

      const checks = {
        hasWebSocket: code.includes('WebSocket') || code.includes('ws'),
        hasHandler: code.includes('exports.handler') || code.includes('module.exports'),
        hasCallback: code.includes('callback'),
        hasImplementation: codeLines > 5 && (todoLines === 0 || codeLines > todoLines * 2)
      };

      const allPassed = Object.values(checks).every(v => v);

      if (allPassed) {
        showStatus('step7Status', 'success', '‚úÖ Code validation passed! This WebSocket handler will be deployed to your GitHub repository (not Twilio Serverless since WSS doesn\'t run there).');
        websocketBuilt = true;
        step5CodeValidated = true;
        step5Deployed = true; // Mark as "deployed" since we're not actually deploying

        // Enable next button immediately - no deployment needed
        const nextBtn = document.getElementById('nextBtn7');
        if (nextBtn) nextBtn.disabled = false;

        updateProgressBar();

        // Hide placeholder
        const placeholder = document.getElementById('step5Placeholder');
        if (placeholder) placeholder.style.display = 'none';

        // Hide deploy section since WebSocket doesn't deploy to Twilio
        const deploySection = document.getElementById('step5DeploySection');
        if (deploySection) deploySection.style.display = 'none';
      } else {
        let message = '‚ö†Ô∏è Validation issues found:\n';
        if (!checks.hasWebSocket) message += '- Missing WebSocket import\n';
        if (!checks.hasHandler) message += '- Missing exports.handler function\n';
        if (!checks.hasCallback) message += '- Missing callback() call\n';
        if (!checks.hasImplementation) message += `- Not enough implementation code (found ${codeLines} lines of code, ${todoLines} TODOs)\n`;
        showStatus('step7Status', 'warning', message);
      }
    }

    function validateCode7_OLD_WEBSOCKET() {
      const code = document.getElementById('code7').value;
      const checks = {
        hasWebSocket: code.includes('WebSocket') || code.includes('ws'),
        hasOpenAI: code.includes('OpenAI'),
        hasStart: code.includes('start'),
        hasTranscript: code.includes('transcript')
      };

      if (Object.values(checks).every(v => v)) {
        websocketBuilt = true;
        document.getElementById('nextBtn7').disabled = false;
        showStatus('step7Status', 'success', '‚úÖ WebSocket handler looks good! Next we\'ll upgrade to ConversationRelay.');
        updateProgressBar();
      } else {
        showStatus('step7Status', 'error', '‚ùå Please implement all required event handlers');
      }
    }

    function resetCode7() {
      document.getElementById('code7').value = `exports.handler = async function(context, event, callback) {
  const response = new Twilio.Response();
  response.setStatusCode(200);
  response.appendHeader('Content-Type', 'text/plain');

  // Check if this is a WebSocket upgrade request
  if (!event.request || !event.request.headers || event.request.headers.upgrade !== 'websocket') {
    response.setBody('This endpoint requires WebSocket connection');
    return callback(null, response);
  }

  // Initialize OpenAI
  const OpenAI = require('openai');
  const openaiApiKey = context.OPENAI_API_KEY;

  if (!openaiApiKey) {
    console.log('No OpenAI API key configured');
    response.setBody('OpenAI API key not configured');
    return callback(null, response);
  }

  const openai = new OpenAI({ apiKey: openaiApiKey });

  // Handle WebSocket connection
  try {
    const WebSocket = require('ws');
    const ws = event.request;

    console.log('WebSocket connection established');

    ws.on('message', async (data) => {
      try {
        const message = JSON.parse(data);
        console.log('Received message:', message);

        switch (message.event) {
          case 'start':
            console.log('Call started:', message.streamSid || 'test-stream');
            ws.send(JSON.stringify({
              event: 'connected',
              message: 'WebSocket handler ready'
            }));
            break;

          case 'transcript':
            console.log('Transcript received:', message.transcript);

            let aiResponse;

            if (openai) {
              // Send to OpenAI
              const completion = await openai.chat.completions.create({
                model: 'gpt-4o-mini',
                messages: [{
                  role: 'user',
                  content: message.transcript
                }],
                max_tokens: 150
              });
              aiResponse = completion.choices[0].message.content;
            } else {
              // Placeholder response when OpenAI not configured
              aiResponse = 'I received your message: ' + message.transcript + '. However, OpenAI is not configured yet. Please set your OPENAI_API_KEY environment variable.';
            }

            console.log('AI response:', aiResponse);

            // Send response back
            ws.send(JSON.stringify({
              event: 'text',
              text: aiResponse
            }));
            break;

          case 'stop':
            console.log('Call ended');
            ws.close();
            break;

          default:
            console.log('Unknown event:', message.event);
        }
      } catch (error) {
        console.error('Error processing message:', error);
        ws.send(JSON.stringify({
          event: 'error',
          message: error.message
        }));
      }
    });

    ws.on('error', (error) => {
      console.error('WebSocket error:', error);
    });

    ws.on('close', () => {
      console.log('WebSocket connection closed');
      callback(null, response);
    });

  } catch (error) {
    console.error('Failed to establish WebSocket:', error);
    response.setBody('WebSocket connection failed: ' + error.message);
    return callback(null, response);
  }

  // Don't call callback here - let the 'close' event handle it
};`;
      document.getElementById('console7').innerHTML = '';
      document.getElementById('step7Status').innerHTML = '';
    }

    function resetCode7_OLD_WEBSOCKET() {
      document.getElementById('code7').value = `exports.handler = function(context, event, callback) {
  const WebSocket = require('ws');
  const OpenAI = require('openai');

  // TODO: Handle WebSocket connection
  // TODO: Listen for 'start' event
  // TODO: Process 'transcript' events
  // TODO: Send responses back to Twilio
  // TODO: Handle 'stop' event

  callback(null, {});
};`;
    }

    // =========================================================================
    // STEP 5: OPENAI - Integrate AI Responses
    // =========================================================================

    function renderStep5() {
      return `
        <div class="step-content active">
          <div class="step-header">
            <h2>Integrate OpenAI</h2>
            <p>Generate dynamic AI responses for your voice bot</p>
          </div>

          <div class="instructions">
            <h3>üìã Your Task</h3>
            <p>Configure OpenAI to generate contextual responses based on conversation transcripts.</p>
            <p style="margin-top: 15px;">
              üìö <strong>Documentation:</strong>
              <a href="https://platform.openai.com/docs/api-reference/chat" target="_blank">OpenAI Chat API</a> |
              <a href="https://platform.openai.com/docs/guides/function-calling" target="_blank">Function Calling</a> |
              <a href="https://www.twilio.com/docs/voice/twiml/connect/conversationrelay#sending-messages" target="_blank">Sending Messages</a>
            </p>
          </div>

          <div class="code-editor">
            <div class="code-header">
              <span>üìù OpenAI Integration</span>
              <div style="display: flex; gap: 10px;">
                <button class="btn btn-success" style="padding: 6px 12px; font-size: 13px;" onclick="validateCode5()">‚úì Validate</button>
                <button class="btn btn-test" style="padding: 6px 12px; font-size: 13px;" onclick="testCode5()">‚ñ∂Ô∏è Test</button>
                <button class="btn-copy" onclick="copyCode('code5')">üìã Copy Code</button>
                <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 13px;" onclick="showSolution(5)">üí° Show Solution</button>
                <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 13px;" onclick="resetCode5()">Reset</button>
              </div>
            </div>
            <textarea class="code-textarea" id="code5">async function generateAIResponse(transcript, conversationHistory) {
  const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

  // TODO: Build messages array with system prompt
  // TODO: Add conversation history
  // TODO: Add current transcript
  // TODO: Call OpenAI API
  // TODO: Return assistant response

  return "AI response here";
}</textarea>
          </div>

          <div class="console-output" id="console5"></div>

          <div id="step5Status" class="status-box"></div>

          <div class="button-group">
            <button class="btn btn-secondary" onclick="prevStep()">‚Üê Back</button>
            <button class="btn btn-primary" id="nextBtn5" onclick="nextStep()" disabled>
              Next: Test Your Bot ‚Üí
            </button>
          </div>
        </div>
      `;
    }

    function testCode5() {
      const code = document.getElementById('code5').value;
      const console5 = document.getElementById('console5');
      console5.innerHTML = '<div class="console-line">üîç Validating JavaScript syntax...</div>';

      // First, validate syntax
      const validation = validateJavaScriptSyntax(code);

      if (!validation.valid) {
        console5.innerHTML += `<div class="console-line error">‚ùå Syntax Error: ${validation.error}</div>`;
        console5.innerHTML += `<div class="console-line error">   Location: Line ${validation.line}, Column ${validation.column}</div>`;
        console5.innerHTML += '<div class="console-line info">üí° Fix the syntax error before testing or deploying.</div>';
        return;
      }

      console5.innerHTML += '<div class="console-line success">‚úì Syntax validation passed</div>';
      console5.innerHTML += `
        <div class="console-line">‚ñ∂Ô∏è Testing OpenAI integration...</div>
        <div class="console-line info">Input: "Hi, I'm interested in the position"</div>
        <div class="console-line success">‚úì OpenAI response generated</div>
        <div class="console-line">Output: "Great! I'd be happy to help you learn more..."</div>
      `;
    }

    function validateCode5() {
      const code = document.getElementById('code5').value;
      const checks = {
        hasOpenAI: code.includes('openai') || code.includes('OpenAI'),
        hasMessages: code.includes('messages'),
        hasSystemPrompt: code.includes('system') || code.includes('role'),
        hasAPICall: code.includes('chat.completions') || code.includes('create')
      };

      if (Object.values(checks).every(v => v)) {
        openaiIntegrated = true;
        document.getElementById('nextBtn5').disabled = false;
        showStatus('step5Status', 'success', '‚úÖ OpenAI integration complete! Ready to test.');
        updateProgressBar();
      } else {
        showStatus('step5Status', 'error', '‚ùå Please implement all OpenAI integration components');
      }
    }

    function resetCode5() {
      document.getElementById('code5').value = `async function generateAIResponse(transcript, conversationHistory) {
  const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

  // TODO: Build messages array with system prompt
  // TODO: Add conversation history
  // TODO: Add current transcript
  // TODO: Call OpenAI API
  // TODO: Return assistant response

  return "AI response here";
}`;
    }

    // =========================================================================
    // STEP 6: TEST - Make a Live Call
    // =========================================================================

    function renderStep6() {
      return `
        <div class="step-content active">
          <div class="step-header">
            <h2>Test Your Voice AI Bot</h2>
            <p>Make a live call and see your bot in action!</p>
          </div>

          <div class="instructions">
            <h3>üéâ You're Ready!</h3>
            <p>Your Voice AI bot is now configured. Let's make a test call to see it work.</p>
            <p style="margin-top: 15px;">
              üìö <strong>Documentation:</strong>
              <a href="https://www.twilio.com/docs/voice/api/call-resource" target="_blank">Call Resource</a> |
              <a href="https://www.twilio.com/docs/voice/tutorials/how-to-make-outbound-phone-calls" target="_blank">Outbound Calls</a> |
              <a href="https://www.twilio.com/docs/usage/monitor-debugger" target="_blank">Debugging</a>
            </p>
          </div>

          <div class="service-card">
            <h4>üìû Test Configuration</h4>
            <div class="form-group">
              <label>Your Phone Number (to receive test call)</label>
              <input type="tel" id="testPhoneNumber" placeholder="+1234567890" />
            </div>
            <div class="form-group">
              <label>From Number</label>
              <input type="tel" id="fromNumber" value="${selectedPhoneNumber || ''}" readonly />
            </div>
            <button class="btn btn-primary" onclick="makeTestCall()">üìû Start Test Call</button>
          </div>

          <div id="callStatus" class="service-card" style="display: none;">
            <h4>üìä Call Status</h4>
            <div id="callDetails"></div>
          </div>

          <div id="step6Status" class="status-box"></div>

          <div class="service-card" style="margin-top: 20px; background: #e7f5ff;">
            <h4>üîç Monitor in Twilio Console</h4>
            <p style="margin: 10px 0;">View live logs and debug your calls:</p>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
              <button class="btn btn-primary" onclick="openTwilioConsole('calls')">üìû Call Logs</button>
              <button class="btn btn-primary" onclick="openTwilioConsole('functions')">‚öôÔ∏è Function Logs</button>
              <button class="btn btn-primary" onclick="openTwilioConsole('debugger')">üêõ Debugger</button>
            </div>
          </div>

          <div class="button-group">
            <button class="btn btn-secondary" onclick="prevStep()">‚Üê Back</button>
            <button class="btn btn-success" id="completeBtn" onclick="completeWorkshop()" disabled>
              üéâ Complete Workshop
            </button>
          </div>
        </div>
      `;
    }

    async function makeTestCall() {
      const toNumber = document.getElementById('testPhoneNumber').value.trim();
      const fromNumber = document.getElementById('fromNumber').value.trim();

      if (!toNumber || !toNumber.startsWith('+')) {
        showStatus('step6Status', 'error', 'Please enter a valid phone number with country code (e.g., +1234567890)');
        return;
      }

      // Handle demo mode
      if (twilioCredentials?.demoMode) {
        showStatus('step6Status', 'info', 'üìù Demo Mode: Simulating call...');

        setTimeout(() => {
          document.getElementById('callStatus').style.display = 'block';
          document.getElementById('callDetails').innerHTML = `
            <div style="margin: 10px 0;">
              <strong>Call SID:</strong> CAdemo123456789<br>
              <strong>Status:</strong> <span id="callStatusText">completed</span><br>
              <strong>To:</strong> ${toNumber}<br>
              <strong>From:</strong> ${fromNumber}<br>
              <strong>Duration:</strong> 45 seconds
            </div>
            <div style="margin-top: 15px; padding: 15px; background: #fff3cd; border-radius: 6px;">
              <strong>üìù Demo Mode Simulation</strong>
              <p style="margin: 10px 0 0 0; font-size: 13px;">
                In a real call, the bot would answer and conduct the conversation.
                Your code is ready to deploy for live testing!
              </p>
            </div>
          `;

          showStatus('step6Status', 'success', '‚úÖ Demo call simulated! Your bot is ready for real deployment.');
          callTested = true;
          document.getElementById('completeBtn').disabled = false;
          updateProgressBar();
        }, 1500);
        return;
      }

      showStatus('step6Status', 'info', 'Initiating call...');

      try {
        const response = await fetch('/api/tutorial-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'makeCall',
            to: toNumber,
            from: fromNumber,
            url: `https://${window.location.host}/voice-handler`,
            ...twilioCredentials
          })
        });

        const data = await response.json();

        if (data.success) {
          document.getElementById('callStatus').style.display = 'block';
          document.getElementById('callDetails').innerHTML = `
            <div style="margin: 10px 0;">
              <strong>Call SID:</strong> ${data.callSid}<br>
              <strong>Status:</strong> <span id="callStatusText">${data.status}</span><br>
              <strong>To:</strong> ${data.to}<br>
              <strong>From:</strong> ${data.from}
            </div>
            <button class="btn btn-test" onclick="checkCallStatus('${data.callSid}')">üîÑ Refresh Status</button>
          `;

          showStatus('step6Status', 'success', '‚úÖ Call initiated! Answer your phone to test the bot.');
          callTested = true;
          document.getElementById('completeBtn').disabled = false;
          updateProgressBar();
        } else {
          throw new Error(data.error);
        }
      } catch (error) {
        showStatus('step6Status', 'error', 'Failed to make call: ' + error.message);
      }
    }

    async function checkCallStatus(callSid) {
      try {
        const response = await fetch('/api/tutorial-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'getCall',
            callSid,
            ...twilioCredentials
          })
        });

        const data = await response.json();

        if (data.success) {
          document.getElementById('callStatusText').textContent = data.call.status;
          if (data.call.duration) {
            document.getElementById('callDetails').innerHTML += `<br><strong>Duration:</strong> ${data.call.duration} seconds`;
          }
        }
      } catch (error) {
        console.error('Failed to check call status:', error);
      }
    }

    function completeWorkshop() {
      showStatus('step6Status', 'success', `
        <h3 style="margin-bottom: 15px;">üéâ Workshop Complete!</h3>
        <p>You've successfully built a production-ready Twilio Voice AI bot with:</p>
        <ul style="margin: 15px 0; padding-left: 20px;">
          <li>Twilio ConversationRelay for bidirectional streaming</li>
          <li>WebSocket integration for real-time events</li>
          <li>OpenAI for intelligent responses</li>
          <li>Complete service provisioning</li>
        </ul>
        <div style="margin-top: 30px; padding: 20px; background: #d4edda; border-radius: 8px; border-left: 4px solid #28a745;">
          <p style="margin: 0 0 15px 0;"><strong>üöÄ Your Production-Ready Application</strong></p>
          <p style="margin: 0 0 15px 0;">You now have a fully functional AI voice assistant! View your deployment details below.</p>
          <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-top: 20px;">
            <button onclick="showDeploymentSummary()" class="btn btn-primary" style="display: inline-block; padding: 12px 30px; background: linear-gradient(135deg, #F22F46 0%, #d91c3a 100%); color: white; text-decoration: none; border-radius: 50px; font-weight: bold; border: none; cursor: pointer;">
              üìã View Deployment Summary
            </button>
            <a href="/instructor-dashboard.html" class="btn btn-primary" style="display: inline-block; padding: 12px 30px; background: linear-gradient(135deg, #28a745 0%, #218838 100%); color: white; text-decoration: none; border-radius: 50px; font-weight: bold;">
              üìä Instructor Dashboard
            </a>
          </div>
        </div>
        <p style="margin-top: 20px; font-size: 0.9em; color: #666;">
          üìö Or continue learning: <a href="https://www.twilio.com/docs/voice" target="_blank">Twilio Voice Docs</a>
        </p>
      `);

      // Auto-show deployment summary after 2 seconds
      setTimeout(() => {
        showDeploymentSummary();
      }, 2000);
    }

    // =========================================================================
    // DEPLOYMENT SUMMARY
    // =========================================================================

    function showDeploymentSummary() {
      const deploymentUrl = websocketUrl ? `https://${websocketUrl}` : 'Not deployed';

      const summaryHTML = `
        <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;" onclick="this.remove()">
          <div style="background: white; border-radius: 16px; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto; padding: 40px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);" onclick="event.stopPropagation()">
            <div style="text-align: center; margin-bottom: 30px;">
              <h2 style="font-size: 2rem; margin-bottom: 10px; color: #F22F46;">üéâ Deployment Summary</h2>
              <p style="color: #666; font-size: 1.1rem;">Your Production-Ready AI Voice Assistant</p>
            </div>

            <div style="background: linear-gradient(135deg, #F22F46 0%, #0d122b 100%); padding: 25px; border-radius: 12px; color: white; margin-bottom: 30px;">
              <h3 style="margin: 0 0 15px 0; font-size: 1.3rem;">üì¶ Twilio Serverless Service</h3>
              <div style="font-family: monospace; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                <div style="margin-bottom: 10px;"><strong>Service SID:</strong> ${deployedServiceSid || 'Not deployed'}</div>
                <div style="margin-bottom: 10px;"><strong>Environment SID:</strong> ${deployedEnvironmentSid || 'Not deployed'}</div>
                <div style="margin-bottom: 10px;"><strong>Domain:</strong> ${deploymentUrl}</div>
                <div><strong>Phone Number:</strong> ${selectedPhoneNumber || 'Not configured'}</div>
              </div>
            </div>

            <div style="margin-bottom: 30px;">
              <h3 style="margin: 0 0 15px 0; color: #333; font-size: 1.2rem;">üîß Deployed Functions</h3>
              <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #28a745;">
                <div style="margin-bottom: 15px;">
                  <strong>voice-handler</strong>
                  <div style="color: #666; font-size: 0.9rem; margin-top: 5px;">
                    ${step6Committed ? '‚úÖ ConversationRelay TwiML (upgraded in Step 6)' : step4Committed ? 'üìù Basic TwiML (Step 4)' : '‚ùå Not deployed'}
                  </div>
                  <div style="font-family: monospace; font-size: 0.85rem; color: #0066cc; margin-top: 5px;">
                    ${deploymentUrl}/voice-handler
                  </div>
                </div>
                <div>
                  <strong>websocket-handler</strong>
                  <div style="color: #666; font-size: 0.9rem; margin-top: 5px;">
                    ${step8Committed ? '‚úÖ With AI Tools (Step 7)' : step6Committed ? '‚úÖ OpenAI Integration (Step 5)' : '‚ùå Not deployed'}
                  </div>
                  <div style="font-family: monospace; font-size: 0.85rem; color: #0066cc; margin-top: 5px;">
                    wss://${websocketUrl}/websocket-handler
                  </div>
                </div>
              </div>
            </div>

            <div style="margin-bottom: 30px;">
              <h3 style="margin: 0 0 15px 0; color: #333; font-size: 1.2rem;">üîë Configuration</h3>
              <div style="background: #fff3cd; padding: 20px; border-radius: 8px; border-left: 4px solid #ffc107;">
                <div style="margin-bottom: 10px;">
                  <strong>OpenAI API Key:</strong> ${openaiApiKey ? '‚úÖ Configured' : '‚ùå Not configured'}
                </div>
                <div style="margin-bottom: 10px;">
                  <strong>TTS Provider:</strong> ${ttsProvider || 'amazon-polly'}
                </div>
                <div style="margin-bottom: 10px;">
                  <strong>Call Direction:</strong> ${callDirection || 'Not selected'}
                </div>
                <div>
                  <strong>Default Voice:</strong> ${getDefaultVoice ? getDefaultVoice() : 'Not configured'}
                </div>
              </div>
            </div>

            <div style="margin-bottom: 30px;">
              <h3 style="margin: 0 0 15px 0; color: #333; font-size: 1.2rem;">üìä Progress Summary</h3>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div style="background: ${step4Committed ? '#d4edda' : '#f8d7da'}; padding: 15px; border-radius: 8px; text-align: center;">
                  <div style="font-size: 2rem; margin-bottom: 5px;">${step4Committed ? '‚úÖ' : '‚è≥'}</div>
                  <strong>Step 4</strong><br>
                  <small>Basic TwiML</small>
                </div>
                <div style="background: ${step6Committed ? '#d4edda' : '#f8d7da'}; padding: 15px; border-radius: 8px; text-align: center;">
                  <div style="font-size: 2rem; margin-bottom: 5px;">${step6Committed ? '‚úÖ' : '‚è≥'}</div>
                  <strong>Step 5</strong><br>
                  <small>WebSocket Handler</small>
                </div>
                <div style="background: ${step6Committed ? '#d4edda' : '#f8d7da'}; padding: 15px; border-radius: 8px; text-align: center;">
                  <div style="font-size: 2rem; margin-bottom: 5px;">${step6Committed ? '‚úÖ' : '‚è≥'}</div>
                  <strong>Step 6</strong><br>
                  <small>ConversationRelay</small>
                </div>
                <div style="background: ${step8Committed ? '#d4edda' : '#f8d7da'}; padding: 15px; border-radius: 8px; text-align: center;">
                  <div style="font-size: 2rem; margin-bottom: 5px;">${step8Committed ? '‚úÖ' : '‚è≥'}</div>
                  <strong>Step 7</strong><br>
                  <small>AI Tools</small>
                </div>
              </div>
            </div>

            <div style="background: #e7f3ff; padding: 20px; border-radius: 8px; border-left: 4px solid #0066cc; margin-bottom: 20px;">
              <h4 style="margin: 0 0 10px 0; color: #0066cc;">üöÄ Next Steps</h4>
              <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
                <li>Test your voice handler by calling ${selectedPhoneNumber || 'your configured number'}</li>
                <li>Monitor calls in the <a href="https://console.twilio.com/us1/monitor/logs/calls" target="_blank">Twilio Console</a></li>
                <li>View function logs in the <a href="https://console.twilio.com/us1/develop/functions/services/${deployedServiceSid || ''}" target="_blank">Functions Editor</a></li>
                <li>Customize your AI prompts and add more tools</li>
                <li>Review the <a href="https://www.twilio.com/docs/voice/conversationrelay" target="_blank">ConversationRelay Documentation</a></li>
              </ul>
            </div>

            <div style="text-align: center;">
              <button onclick="this.closest('[style*=fixed]').remove()" style="padding: 15px 40px; background: linear-gradient(135deg, #F22F46 0%, #d91c3a 100%); color: white; border: none; border-radius: 50px; font-size: 1.1rem; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(242, 47, 70, 0.3);">
                Close Summary
              </button>
            </div>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', summaryHTML);
    }

    // =========================================================================
    // NAVIGATION & HELPERS
    // =========================================================================

    // Debouncing variables to prevent double-clicks
    let nextStepDebounce = false;
    let prevStepDebounce = false;

    function nextStep() {
      // Prevent double-clicks
      if (nextStepDebounce) {
        console.log('Next step debounced - preventing double click');
        return;
      }

      // Set debounce flag immediately to prevent any double-clicks
      nextStepDebounce = true;

      // Check prerequisites before allowing progression
      const prerequisiteCheck = checkPrerequisites();
      if (!prerequisiteCheck.canProceed) {
        showStatus(`step${currentStep + 1}Status`, 'error', `‚ö†Ô∏è ${prerequisiteCheck.message}`);
        // Scroll to the prerequisite message
        document.getElementById(`step${currentStep + 1}Status`)?.scrollIntoView({ behavior: 'smooth', block: 'center' });
        // Reset debounce since we're not proceeding
        setTimeout(() => {
          nextStepDebounce = false;
        }, 500);
        return;
      }

      if (currentStep < steps.length - 1) {

        // Celebrate milestones
        if (currentStep === 2) {
          celebrate('üéâ Great! You\'ve completed the basics!', 'light');
        } else if (currentStep === 5) {
          celebrate('üöÄ Halfway there! Keep going!', 'normal');
        } else if (currentStep === 7) {
          celebrate('üéä Almost done! Final step ahead!', 'normal');
        }

        currentStep++;
        renderProgressSteps();
        renderStepContent();
        window.scrollTo(0, 0);
        saveProgressToStorage(); // Auto-save after navigation

        // Epic celebration on completion
        if (currentStep === steps.length - 1) {
          setTimeout(() => {
            const message = studentName
              ? `üèÜ Congratulations, ${studentName}! Workshop Complete!`
              : 'üèÜ Congratulations! Workshop Complete!';
            celebrate(message, 'epic');
          }, 1000);
        }

        // Reset debounce after 500ms
        setTimeout(() => {
          nextStepDebounce = false;
        }, 500);
      }
    }

    function checkPrerequisites() {
      switch(currentStep) {
        case 0: // Step 1: Setup
          if (!twilioConnected) {
            return { canProceed: false, message: 'Please connect your Twilio account first!' };
          }
          break;

        case 1: // Step 2: Direction
          if (!callDirectionChosen) {
            return { canProceed: false, message: 'Please choose a call direction (Inbound or Outbound)!' };
          }
          break;

        case 2: // Step 3: Services
          if (!selectedPhoneNumber) {
            return { canProceed: false, message: 'Please select or purchase a phone number!' };
          }
          if (!servicesReady) {
            return { canProceed: false, message: 'Please complete service setup: Messaging Service and Sync Service (or skip Sync)!' };
          }
          break;

        case 3: // Step 4: Basic TwiML
          if (!basicTwimlCreated) {
            return { canProceed: false, message: 'Please create and validate your Basic TwiML code!' };
          }
          break;

        case 4: // Step 5: WebSocket
          if (!websocketBuilt) {
            return { canProceed: false, message: 'Please create and validate your WebSocket handler!' };
          }
          if (!openaiConnected) {
            return { canProceed: false, message: 'Please connect your OpenAI API key at the top of Step 5 first!' };
          }
          break;

        case 5: // Step 6: ConversationRelay
          if (!conversationRelayCreated) {
            return { canProceed: false, message: 'Please create and validate your ConversationRelay TwiML!' };
          }
          break;
      }

      return { canProceed: true };
    }

    function prevStep() {
      // Prevent double-clicks
      if (prevStepDebounce) {
        console.log('Prev step debounced - preventing double click');
        return;
      }

      if (currentStep > 0) {
        // Set debounce flag
        prevStepDebounce = true;

        currentStep--;
        renderProgressSteps();
        renderStepContent();
        window.scrollTo(0, 0);
        saveProgressToStorage(); // Auto-save after navigation

        // Reset debounce after 500ms
        setTimeout(() => {
          prevStepDebounce = false;
        }, 500);
      }
    }

    function showStatus(elementId, type, message) {
      const element = document.getElementById(elementId);
      element.className = `status-box show ${type}`;
      element.innerHTML = message;
    }

    // Copy code to clipboard
    async function copyCode(textareaId) {
      const textarea = document.getElementById(textareaId);
      const code = textarea.value;

      try {
        await navigator.clipboard.writeText(code);

        // Find the copy button for this textarea
        const button = event.target;
        const originalText = button.innerHTML;

        // Show success feedback
        button.innerHTML = '‚úì Copied!';
        button.classList.add('copied');

        // Reset after 2 seconds
        setTimeout(() => {
          button.innerHTML = originalText;
          button.classList.remove('copied');
        }, 2000);
      } catch (error) {
        // Fallback for older browsers
        textarea.select();
        document.execCommand('copy');

        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '‚úì Copied!';
        button.classList.add('copied');

        setTimeout(() => {
          button.innerHTML = originalText;
          button.classList.remove('copied');
        }, 2000);
      }
    }

    async function copyPhoneNumber() {
      const phoneNumber = selectedPhoneNumber || 'No phone number configured';

      try {
        await navigator.clipboard.writeText(phoneNumber);

        // Show success feedback
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '‚úì Copied!';
        button.style.background = '#d1fae5';

        // Reset after 2 seconds
        setTimeout(() => {
          button.innerHTML = originalText;
          button.style.background = 'white';
        }, 2000);
      } catch (error) {
        // Fallback for older browsers
        alert(`Phone number: ${phoneNumber}\n\nCopy this number to test your AI voice bot!`);
      }
    }

    async function makeAITestCall() {
      const yourNumber = document.getElementById('testAICallNumber')?.value?.trim();
      const statusDiv = document.getElementById('aiTestCallStatus');

      if (!yourNumber) {
        statusDiv.innerHTML = '<div style="color: #e06c75; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 4px;">‚ùå Please enter your phone number</div>';
        return;
      }

      if (!yourNumber.startsWith('+')) {
        statusDiv.innerHTML = '<div style="color: #e5c07b; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 4px;">‚ö†Ô∏è Phone number must use E.164 format (e.g., +1234567890)</div>';
        return;
      }

      statusDiv.innerHTML = '<div style="color: white; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 4px;">üìû Initiating AI call...</div>';

      try {
        // Use the deployed voice-handler URL which now has ConversationRelay
        const voiceHandlerUrl = `https://${websocketUrl}/voice-handler`;

        const response = await fetch('/api/tutorial-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'makeCall',
            to: yourNumber,
            from: selectedPhoneNumber,
            url: voiceHandlerUrl,
            ...twilioCredentials
          })
        });

        const data = await response.json();

        if (data.success) {
          statusDiv.innerHTML = `
            <div style="color: #98c379; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 4px;">
              <strong>‚úÖ AI call initiated successfully!</strong><br>
              <div style="margin-top: 10px; font-size: 13px;">
                üì± CallSid: ${data.callSid}<br>
                üìû Calling: ${yourNumber}<br>
                ü§ñ Using: ConversationRelay + OpenAI
              </div>
              <div style="margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 4px; font-size: 12px;">
                <strong>What happens next:</strong><br>
                1. Your phone will ring in a few seconds<br>
                2. Answer and you'll hear the AI greeting<br>
                3. Try having a natural conversation!<br>
                4. The AI will respond using ${getTTSProviderName()}
              </div>
            </div>
          `;
        } else {
          statusDiv.innerHTML = `<div style="color: #e06c75; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 4px;">‚ùå Call failed: ${data.error}</div>`;
        }
      } catch (error) {
        statusDiv.innerHTML = `<div style="color: #e06c75; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 4px;">‚ùå Error: ${error.message}</div>`;
      }
    }

    // =========================================================================
    // SAVE/LOAD PROGRESS
    // =========================================================================

    function saveProgress() {
      // Manual save - calls auto-save function
      saveProgressToStorage();
      celebrate('üíæ Progress saved!', 'light');
    }

    function loadProgress() {
      const progress = loadProgressFromStorage();

      if (!progress) {
        alert('No saved progress found');
        return;
      }

      // Show resume modal
      showResumeModal(progress);
    }

    // Auto-save every 30 seconds (silent, updates existing auto-save session)
    setInterval(() => {
      if (currentStep > 0) {
        autoSaveProgress();
      }
    }, 30000);

    function autoSaveProgress() {
      const progressData = {
        name: 'Auto-save',
        currentStep,
        twilioConnected,
        openaiConnected,
        callDirectionChosen,
        callDirection,
        servicesReady,
        basicTwimlCreated,
        functionsDeployed,
        basicCallTested,
        websocketBuilt,
        conversationRelayCreated,
        aiCallTested,
        twilioCredentials,
        openaiApiKey,
        selectedPhoneNumber,
        syncServiceSkipped,
        code4: document.getElementById('code4')?.value,
        code7: document.getElementById('code7')?.value,
        code8: document.getElementById('code8')?.value,
        timestamp: new Date().toISOString()
      };

      // Get existing sessions
      const sessions = JSON.parse(localStorage.getItem('twilioVoiceAISessions') || '[]');

      // Find and update auto-save session, or add if doesn't exist
      const autoSaveIndex = sessions.findIndex(s => s.name === 'Auto-save');
      if (autoSaveIndex >= 0) {
        sessions[autoSaveIndex] = progressData;
      } else {
        sessions.push(progressData);
      }

      localStorage.setItem('twilioVoiceAISessions', JSON.stringify(sessions));

      // Flash save indicator briefly
      const indicator = document.getElementById('progressSaved');
      if (indicator) {
        indicator.style.display = 'block';
        indicator.style.opacity = '0.5';
        setTimeout(() => {
          indicator.style.display = 'none';
          indicator.style.opacity = '1';
        }, 1000);
      }
    }

    // =========================================================================
    // EXPORT PROJECT
    // =========================================================================

    function exportProject() {
      const code3 = document.getElementById('code3')?.value || '';
      const code4 = document.getElementById('code4')?.value || '';
      const code5 = document.getElementById('code5')?.value || '';

      const projectFiles = {
        'functions/voice-handler.js': code3,
        'functions/websocket-handler.js': code4,
        'functions/ai-integration.js': code5,
        '.env.example': `# Twilio Configuration
TWILIO_ACCOUNT_SID=ACxxxxxx
TWILIO_AUTH_TOKEN=xxxxxx
TWILIO_PHONE_NUMBER=+1234567890

# OpenAI Configuration
OPENAI_API_KEY=sk-proj-xxxxxx

# Optional: Sync Service
TWILIO_SYNC_SERVICE_SID=ISxxxxxx`,
        'package.json': JSON.stringify({
          name: 'twilio-voice-ai-bot',
          version: '1.0.0',
          description: 'Voice AI Bot built with Twilio ConversationRelay and OpenAI',
          dependencies: {
            'twilio': '^5.0.0',
            'openai': '^4.0.0',
            'ws': '^8.0.0'
          }
        }, null, 2),
        'README.md': `# Twilio Voice AI Bot

Built during the Twilio Voice AI Workshop

## Setup

1. Install dependencies:
\`\`\`bash
npm install
\`\`\`

2. Copy \`.env.example\` to \`.env\` and fill in your credentials

3. Deploy to Twilio Serverless:
\`\`\`bash
twilio serverless:deploy
\`\`\`

## Documentation

- [ConversationRelay Docs](https://www.twilio.com/docs/voice/twiml/connect/conversationrelay)
- [Twilio Functions](https://www.twilio.com/docs/serverless/functions)
- [OpenAI API](https://platform.openai.com/docs)

## Support

- Workshop URL: ${window.location.href}
- Twilio Console: https://console.twilio.com
`
      };

      const modal = document.getElementById('exportModal');
      const content = document.getElementById('exportContent');

      content.innerHTML = `
        <div class="service-card">
          <h3>üì¶ Your Project Files</h3>
          <p style="margin: 15px 0;">Download individual files or the complete project as a ZIP.</p>

          <div style="display: flex; flex-direction: column; gap: 10px; margin: 20px 0;">
            ${Object.keys(projectFiles).map(filename => {
              const escapedContent = projectFiles[filename].replace(/`/g, '\\`').replace(/\$/g, '\\$').replace(/\\/g, '\\\\');
              return `
              <button class="btn btn-primary" onclick="downloadFile('${filename}', \`${escapedContent}\`)">
                üìÑ ${filename}
              </button>
            `;
            }).join('')}
          </div>

          <button class="btn btn-success" onclick="downloadAllFiles()">
            üì¶ Download Complete Project (ZIP)
          </button>

          <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
            <h4>Next Steps:</h4>
            <ol style="margin: 10px 0 0 20px; line-height: 1.8;">
              <li>Extract the ZIP file</li>
              <li>Run <code>npm install</code></li>
              <li>Configure your <code>.env</code> file</li>
              <li>Deploy with <code>twilio serverless:deploy</code></li>
            </ol>
          </div>
        </div>
      `;

      modal.classList.add('show');
    }

    function downloadFile(filename, content) {
      const blob = new Blob([content], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    function downloadAllFiles() {
      alert('ZIP download functionality requires a library like JSZip. For now, download files individually.');
    }

    // =========================================================================
    // DEBUGGER
    // =========================================================================

    let debuggerVisible = false;
    let debugEvents = [];

    function toggleDebugger() {
      debuggerVisible = !debuggerVisible;

      if (debuggerVisible && !document.querySelector('.debugger-panel')) {
        const panel = document.createElement('div');
        panel.className = 'debugger-panel show';
        panel.id = 'debuggerPanel';
        panel.innerHTML = `
          <div class="debugger-header">üêõ Live Event Debugger</div>
          <div class="event-flow" id="eventFlow">
            <div class="event-item">Debugger started. Events will appear here...</div>
          </div>
          <div style="margin-top: 15px;">
            <button class="btn btn-secondary" onclick="clearDebugger()">Clear Events</button>
            <button class="btn btn-test" onclick="simulateEvent()">Simulate Event</button>
          </div>
        `;
        document.querySelector('.content').prepend(panel);
      } else {
        const panel = document.getElementById('debuggerPanel');
        if (panel) {
          panel.classList.toggle('show');
        }
      }
    }

    function addDebugEvent(type, data) {
      const eventFlow = document.getElementById('eventFlow');
      if (!eventFlow) return;

      const event = document.createElement('div');
      event.className = `event-item ${type}`;
      event.innerHTML = `
        <strong>${new Date().toLocaleTimeString()}</strong> - ${type.toUpperCase()}<br>
        ${JSON.stringify(data, null, 2)}
      `;

      eventFlow.appendChild(event);
      debugEvents.push({ type, data, timestamp: new Date() });

      // Keep only last 20 events
      if (eventFlow.children.length > 20) {
        eventFlow.removeChild(eventFlow.firstChild);
      }
    }

    function clearDebugger() {
      const eventFlow = document.getElementById('eventFlow');
      if (eventFlow) {
        eventFlow.innerHTML = '<div class="event-item">Cleared. Waiting for events...</div>';
      }
      debugEvents = [];
    }

    function simulateEvent() {
      const events = [
        { type: 'start', data: { streamSid: 'MZ' + Math.random().toString(36).substr(2, 9) } },
        { type: 'transcript', data: { text: 'Hello, I am interested in the position' } },
        { type: 'response', data: { text: 'Great! Let me tell you more about it...' } },
        { type: 'stop', data: { reason: 'user_hangup' } }
      ];

      const event = events[Math.floor(Math.random() * events.length)];
      addDebugEvent(event.type, event.data);
    }

    // =========================================================================
    // COST CALCULATOR
    // =========================================================================

    function showCostCalculator() {
      const modal = document.getElementById('costModal');
      const content = document.getElementById('costCalculatorContent');

      content.innerHTML = `
        <div class="cost-widget">
          <h3 style="margin-bottom: 15px;">üí∞ Estimated Costs per Call</h3>

          <div class="form-group">
            <label>Average Call Duration (minutes)</label>
            <input type="number" id="callDuration" value="3" min="1" max="60" onchange="updateCostEstimate()">
          </div>

          <div class="form-group">
            <label>Monthly Call Volume</label>
            <input type="number" id="callVolume" value="1000" min="1" onchange="updateCostEstimate()">
          </div>

          <div class="cost-breakdown" id="costBreakdown"></div>

          <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 6px;">
            <h4>üí° Cost Optimization Tips:</h4>
            <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
              <li>Use ConversationRelay for real-time streaming (more efficient)</li>
              <li>Implement smart interruption handling to reduce wait time</li>
              <li>Cache common responses to reduce OpenAI API calls</li>
              <li>Use GPT-4o-mini instead of GPT-4 for cost savings</li>
            </ul>
          </div>
        </div>
      `;

      modal.classList.add('show');
      updateCostEstimate();
    }

    function updateCostEstimate() {
      const duration = parseFloat(document.getElementById('callDuration')?.value || 3);
      const volume = parseInt(document.getElementById('callVolume')?.value || 1000);

      // Twilio pricing (approximate)
      const twilioVoice = 0.0085 * duration; // $0.0085 per minute
      const twilioStreaming = 0.0040 * duration; // $0.004 per minute for Media Streams
      const twilioTranscription = 0.02; // $0.02 per minute

      // OpenAI pricing (GPT-4o-mini approximate)
      const openaiInput = 0.0003; // per 1K tokens, ~500 tokens per call
      const openaiOutput = 0.0006; // per 1K tokens, ~300 tokens per call

      const perCallCost = twilioVoice + twilioStreaming + twilioTranscription + openaiInput + openaiOutput;
      const monthlyCost = perCallCost * volume;
      const annualCost = monthlyCost * 12;

      const breakdown = document.getElementById('costBreakdown');
      if (breakdown) {
        breakdown.innerHTML = `
          <div class="cost-item">
            <span style="font-size: 12px;">Per Call</span>
            <strong>$${perCallCost.toFixed(3)}</strong>
          </div>
          <div class="cost-item">
            <span style="font-size: 12px;">Monthly (${volume} calls)</span>
            <strong>$${monthlyCost.toFixed(2)}</strong>
          </div>
          <div class="cost-item">
            <span style="font-size: 12px;">Annual</span>
            <strong>$${annualCost.toFixed(2)}</strong>
          </div>
          <div class="cost-item">
            <span style="font-size: 12px;">vs. Human ($25/hr)</span>
            <strong>${((25 * duration / 60 * volume * 12) / annualCost).toFixed(1)}x cheaper</strong>
          </div>
        `;
      }
    }

    // =========================================================================
    // HELP & TROUBLESHOOTING
    // =========================================================================

    function showHelp() {
      const modal = document.getElementById('helpModal');
      const content = document.getElementById('helpContent');

      const faqs = [
        {
          q: 'My Twilio credentials are not working',
          a: 'Make sure you\'re using your Account SID (starts with "AC") and Auth Token from the Twilio Console. Check that your account is active and has sufficient balance.'
        },
        {
          q: 'WebSocket connection fails',
          a: 'Verify your WebSocket URL is using wss:// (secure). Check that your Twilio Function is deployed and publicly accessible. Review function logs in Twilio Console.'
        },
        {
          q: 'OpenAI API returns errors',
          a: 'Confirm your API key is valid and starts with "sk-proj-" or "sk-". Check your OpenAI account has available credits. Ensure you\'re using a supported model.'
        },
        {
          q: 'Call connects but no audio',
          a: 'Check ConversationRelay configuration. Verify voice parameter is set correctly. Test with a simple TwiML response first.'
        },
        {
          q: 'How do I debug my code?',
          a: 'Use the built-in Debugger (click üêõ button in toolbar). Check Twilio Function logs in Console. Add console.log() statements in your code.'
        },
        {
          q: 'Can I use this in production?',
          a: 'Yes! Make sure to: 1) Move credentials to environment variables, 2) Enable error handling, 3) Implement rate limiting, 4) Add monitoring/logging, 5) Test thoroughly with real calls.'
        },
        {
          q: 'What are the usage limits?',
          a: 'Twilio has generous limits but check your account tier. OpenAI has rate limits based on your tier. Monitor usage in both consoles to avoid surprises.'
        },
        {
          q: 'How do I add custom functionality?',
          a: 'Use OpenAI function calling to connect to your database or APIs. Implement Sync for conversation state. Add webhooks for events like call recording.'
        }
      ];

      content.innerHTML = `
        <div class="troubleshooting">
          <h3>üîß Common Issues</h3>
          <div style="margin-top: 15px;">
            ${faqs.map((faq, i) => `
              <div class="faq-item" onclick="toggleFaq(${i})">
                <strong>‚ùì ${faq.q}</strong>
                <div class="faq-answer" id="faq${i}">
                  ${faq.a}
                </div>
              </div>
            `).join('')}
          </div>
        </div>

        <div class="service-card" style="margin-top: 20px;">
          <h3>üìö Additional Resources</h3>
          <ul style="margin: 15px 0 0 20px; line-height: 2;">
            <li><a href="https://www.twilio.com/docs/voice/twiml/connect/conversationrelay" target="_blank">ConversationRelay Documentation</a></li>
            <li><a href="https://www.twilio.com/console/voice/logs" target="_blank">View Call Logs in Console</a></li>
            <li><a href="https://www.twilio.com/console/functions/logs" target="_blank">View Function Logs</a></li>
            <li><a href="https://platform.openai.com/docs" target="_blank">OpenAI Documentation</a></li>
            <li><a href="https://www.twilio.com/support" target="_blank">Contact Twilio Support</a></li>
          </ul>
        </div>

        <div class="service-card" style="margin-top: 20px; background: #e7f5ff;">
          <h3>üí¨ Need More Help?</h3>
          <p style="margin: 10px 0;">Join the Twilio community or contact support:</p>
          <button class="btn btn-primary" onclick="window.open('https://support.twilio.com/hc/en-us/community/topics', '_blank')">
            üåê Twilio Community
          </button>
        </div>
      `;

      modal.classList.add('show');
    }

    function toggleFaq(index) {
      const faq = document.getElementById('faq' + index);
      const item = faq.parentElement;
      item.classList.toggle('open');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('show');
    }

    // ==========================================================================
    // BUG REPORT FUNCTIONS
    // ==========================================================================

    function showBugReportModal() {
      const modal = document.getElementById('bugReportModal');

      // Auto-fill context information
      const stepName = steps[currentStep]?.title || 'Unknown';
      document.getElementById('bugCurrentStep').textContent = `Step ${currentStep + 1}: ${stepName}`;
      document.getElementById('bugPageUrl').textContent = window.location.href;
      document.getElementById('bugBrowserInfo').textContent = navigator.userAgent;

      // Clear previous values
      document.getElementById('bugUserName').value = '';
      document.getElementById('bugDescription').value = '';
      document.getElementById('bugExpectedBehavior').value = '';
      document.getElementById('bugActualBehavior').value = '';
      document.getElementById('bugErrorMessage').value = '';
      document.getElementById('bugReportStatus').innerHTML = '';

      modal.classList.add('show');
    }

    async function submitBugReport() {
      const description = document.getElementById('bugDescription').value.trim();

      if (!description) {
        showStatus('bugReportStatus', 'error', '‚ùå Please describe the issue');
        return;
      }

      // Disable submit button
      const submitBtn = event.target;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="loading" style="border: 3px solid rgba(255,255,255,0.3); border-top-color: white; display: inline-block; width: 16px; height: 16px; margin-right: 8px;"></span> Sending...';

      try {
        const bugData = {
          description: description,
          step: `Step ${currentStep + 1}: ${steps[currentStep]?.title || 'Unknown'}`,
          errorMessage: document.getElementById('bugErrorMessage').value.trim() || null,
          expectedBehavior: document.getElementById('bugExpectedBehavior').value.trim() || null,
          actualBehavior: document.getElementById('bugActualBehavior').value.trim() || null,
          userName: document.getElementById('bugUserName').value.trim() || null,
          browserInfo: navigator.userAgent,
          timestamp: new Date().toISOString(),
          pageUrl: window.location.href,
          callDirection: callDirection || 'Not set',
          deploymentStatus: {
            twilioConnected,
            openaiConnected,
            servicesReady,
            functionsDeployed,
            basicCallTested,
            websocketBuilt,
            conversationRelayCreated
          }
        };

        const response = await fetch('/report-bug', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(bugData)
        });

        const result = await response.json();

        if (result.success) {
          showStatus('bugReportStatus', 'success', '‚úÖ ' + result.message);
          // Clear form after successful submission
          setTimeout(() => {
            closeModal('bugReportModal');
          }, 2000);
        } else {
          showStatus('bugReportStatus', 'error', '‚ùå ' + result.error);
          submitBtn.disabled = false;
          submitBtn.innerHTML = 'üì§ Submit Bug Report';
        }
      } catch (error) {
        console.error('Error submitting bug report:', error);
        showStatus('bugReportStatus', 'error', '‚ùå Failed to send bug report. Please try again.');
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'üì§ Submit Bug Report';
      }
    }

    // Close modal when clicking outside
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('modal')) {
        e.target.classList.remove('show');
      }
    });

    // =========================================================================
    // CONVERSATIONRELAY PLAYGROUND
    // =========================================================================

    function openPlayground() {
      // Open in new window
      const playgroundWindow = window.open(
        'https://playground.twilio.world/products/cr',
        'TwilioPlayground',
        'width=1400,height=900,menubar=no,toolbar=no,location=no,status=no'
      );

      if (!playgroundWindow) {
        // Fallback if popup blocked - show embedded iframe
        showPlaygroundModal();
      } else {
        // Show helpful tip about the playground
        setTimeout(() => {
          showStatus('step3Status', 'info',
            'üí° Tip: Use the playground to see how ConversationRelay events flow in real-time. ' +
            'Try clicking through the different scenarios!'
          );
        }, 500);
      }
    }

    function showPlaygroundModal() {
      const modal = document.createElement('div');
      modal.className = 'modal show';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 95%; max-height: 95vh; padding: 0;">
          <div style="background: linear-gradient(135deg, #F22F46 0%, #0d122b 100%); padding: 20px; color: white; display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin: 0; color: white;">üéì What is ConversationRelay?</h2>
            <span class="modal-close" onclick="this.closest('.modal').remove()" style="color: white; cursor: pointer; font-size: 28px;">&times;</span>
          </div>
          <div style="padding: 20px; background: #f8f9fa;">
            <p style="margin-bottom: 15px;">
              <strong>üìö How to use:</strong>
            </p>
            <ul style="margin: 0 0 15px 20px; line-height: 1.8;">
              <li>Click on different components to see how they interact</li>
              <li>Follow the event flow from caller ‚Üí Twilio ‚Üí WebSocket ‚Üí AI</li>
              <li>See example payloads for each event type</li>
              <li>Understand bidirectional streaming in real-time</li>
            </ul>
          </div>
          <iframe
            src="https://playground.twilio.world/products/cr"
            style="width: 100%; height: 70vh; border: none;"
            title="Twilio ConversationRelay Playground"
          ></iframe>
          <div style="padding: 15px; background: #f8f9fa; text-align: center;">
            <button class="btn btn-primary" onclick="window.open('https://playground.twilio.world/products/cr', '_blank')">
              üöÄ Open in Full Window
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      // Close on background click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
        }
      });
    }

    // =========================================================================
    // SHOW SOLUTION
    // =========================================================================

    const solutions = {
      3: `function createConversationRelayTwiML() {
  const twilio = require('twilio');
  const twiml = new twilio.twiml.VoiceResponse();

  const connect = twiml.connect();
  connect.conversationRelay({
    url: '${websocketUrl || 'wss://your-domain.twil.io/tutorial-ws'}',
    voice: 'Polly.Brian',
    language: 'en-US',
    transcriptionProvider: 'twilio',
    ttsProvider: 'amazon-polly'
  });

  return twiml.toString();
}`,
      4: `exports.handler = function(context, event, callback) {
  const twilio = require('twilio');
  const twiml = new twilio.twiml.VoiceResponse();

  // Dial a phone number to connect the call
  const dial = twiml.dial({
    timeout: 30,
    callerId: context.DEFAULT_TWILIO_NUMBER || '+1234567890'
  });
  dial.number('+15555551234');  // Replace with actual number

  // If no answer, say goodbye
  twiml.say('Sorry, no one is available. Goodbye!', { voice: 'Polly.Joanna' });

  callback(null, twiml);
}`,
      6: `exports.handler = function(context, event, callback) {
  const WebSocket = require('ws');
  const OpenAI = require('openai');

  // WebSocket connection handling
  const ws = new WebSocket(event.url);

  ws.on('open', () => {
    console.log('WebSocket connected');
  });

  ws.on('message', async (message) => {
    const data = JSON.parse(message);

    if (data.event === 'start') {
      console.log('Call started:', data.streamSid);
      // Initialize conversation state
    }

    if (data.event === 'transcript') {
      console.log('Transcript:', data.text);

      // Generate AI response
      const response = await generateAIResponse(data.text);

      // Send response back to Twilio
      ws.send(JSON.stringify({
        event: 'text',
        text: response
      }));
    }

    if (data.event === 'stop') {
      console.log('Call ended');
      ws.close();
    }
  });

  callback(null, {});
}`,
      5: `async function generateAIResponse(transcript, conversationHistory) {
  const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

  const messages = [
    {
      role: 'system',
      content: 'You are a helpful recruiting assistant. Be friendly, professional, and concise.'
    },
    ...conversationHistory,
    {
      role: 'user',
      content: transcript
    }
  ];

  const completion = await openai.chat.completions.create({
    model: 'gpt-4o-mini',
    messages: messages,
    temperature: 0.7,
    max_tokens: 150
  });

  return completion.choices[0].message.content;
}`,
      7: `exports.handler = async function(context, event, callback) {
  const response = new Twilio.Response();
  response.setStatusCode(200);
  response.appendHeader('Content-Type', 'text/plain');

  // Check if this is a WebSocket upgrade request
  if (!event.request || !event.request.headers || event.request.headers.upgrade !== 'websocket') {
    response.setBody('This endpoint requires WebSocket connection');
    return callback(null, response);
  }

  // Initialize OpenAI (if available)
  const OpenAI = require('openai');
  const openaiApiKey = context.OPENAI_API_KEY;
  let openai = null;

  if (openaiApiKey) {
    openai = new OpenAI({ apiKey: openaiApiKey });
  } else {
    console.log('‚ö†Ô∏è OpenAI API key not configured - will use placeholder responses');
  }

  // Handle WebSocket connection
  try {
    const ws = event.request;
    console.log('WebSocket connection established');

    ws.on('message', async (data) => {
      try {
        const message = JSON.parse(data);
        console.log('Received message:', message);

        switch (message.event) {
          case 'start':
            console.log('Call started:', message.streamSid || 'test-stream');
            ws.send(JSON.stringify({
              event: 'connected',
              message: 'WebSocket handler ready'
            }));
            break;

          case 'transcript':
            console.log('Transcript received:', message.transcript);

            let aiResponse;

            if (openai) {
              const completion = await openai.chat.completions.create({
                model: 'gpt-4o-mini',
                messages: [{
                  role: 'user',
                  content: message.transcript
                }],
                max_tokens: 150
              });
              aiResponse = completion.choices[0].message.content;
            } else {
              aiResponse = 'I received your message: ' + message.transcript + '. However, OpenAI is not configured yet.';
            }

            console.log('AI response:', aiResponse);
            ws.send(JSON.stringify({
              event: 'text',
              text: aiResponse
            }));
            break;

          case 'stop':
            console.log('Call ended');
            ws.close();
            break;

          default:
            console.log('Unknown event:', message.event);
        }
      } catch (error) {
        console.error('Error processing message:', error);
        ws.send(JSON.stringify({
          event: 'error',
          message: error.message
        }));
      }
    });

    ws.on('error', (error) => {
      console.error('WebSocket error:', error);
    });

    ws.on('close', () => {
      console.log('WebSocket connection closed');
      callback(null, response);
    });

  } catch (error) {
    console.error('Failed to establish WebSocket:', error);
    response.setBody('WebSocket connection failed: ' + error.message);
    return callback(null, response);
  }
}`,
      8: `exports.handler = function(context, event, callback) {
  const twilio = require('twilio');
  const VoiceResponse = twilio.twiml.VoiceResponse;
  const response = new VoiceResponse();

  const connect = response.connect();
  const wsHandlerUrl = 'wss://' + context.DOMAIN_NAME + '/websocket-handler';

  connect.conversationRelay({
    // Required: WebSocket endpoint URL
    url: wsHandlerUrl,

    // Optional: Initial greeting message
    welcomeGreeting: 'Hello! I am your AI assistant. How can I help you today?',

    // Voice Configuration
    voice: '9XfYMbJVZqPHaQtYnTAO',  // Cody - Energetic Upbeat Educator
    ttsProvider: 'elevenlabs',       // Options: 'elevenlabs', 'amazon', 'google'

    // Language Settings
    language: 'en-US',               // Default language (or 'multi' for auto-detect)
    // transcriptionLanguage: 'en-US', // Override STT language
    // ttsLanguage: 'en-US',           // Override TTS language

    // Speech Recognition
    transcriptionProvider: 'deepgram', // Options: 'google', 'deepgram'
    // speechModel: 'nova-2',           // Deepgram model (nova-2, enhanced, base)

    // Interruption Control
    interruptible: 'speech',         // Options: 'none', 'dtmf', 'speech', 'any'

    // DTMF (Keypad) Detection
    dtmfDetection: true,             // Enable keypad tone detection

    // Speech Recognition Hints (helps with domain-specific terms)
    // hints: 'Twilio,ConversationRelay,WebSocket,API'
  });

  callback(null, response);
}`
    };

    function showSolution(step) {
      const code = solutions[step];
      if (!code) return;

      if (confirm('Show the solution code? This will replace your current code.')) {
        document.getElementById('code' + step).value = code;
      }
    }

    // =========================================================================
    // PROGRESS BAR UPDATE
    // =========================================================================

    function updateProgressBar() {
      const totalSteps = 9; // All 9 steps in the workshop
      const completedSteps = [
        twilioConnected,
        callDirectionChosen,
        servicesReady,
        basicTwimlCreated,
        websocketBuilt,
        conversationRelayCreated,
        promptEngineeringComplete,
        toolsConfigured,
        projectDeployed
      ].filter(Boolean).length;

      const percentage = Math.round((completedSteps / totalSteps) * 100);

      document.getElementById('progressBar').style.width = percentage + '%';
      document.getElementById('progressPercent').textContent = percentage + '%';
      document.getElementById('completedTasks').textContent = `${completedSteps} of ${totalSteps} steps completed`;

      // Estimate time remaining
      const avgTimePerStep = 5; // minutes
      const remaining = (totalSteps - completedSteps) * avgTimePerStep;
      if (remaining > 0) {
        document.getElementById('timeEstimate').textContent = `Est. ${remaining}-${remaining + 10} minutes remaining`;
      } else {
        document.getElementById('timeEstimate').textContent = 'üéâ Complete!';
      }
    }

    // Update progress bar whenever state changes
    function checkStep1Complete() {
      if (twilioConnected) {
        document.getElementById('nextBtn1').disabled = false;
        showStatus('step1Status', 'success', 'üéâ Twilio connected! Click Next to continue.');
        updateProgressBar();
      }
    }

    // =========================================================================
    // CONSOLE INTEGRATION
    // =========================================================================

    function openTwilioConsole(section) {
      const urls = {
        calls: 'https://console.twilio.com/us1/monitor/logs/calls',
        functions: `https://console.twilio.com/us1/develop/functions/editor/${twilioCredentials?.accountSid || ''}`,
        debugger: 'https://console.twilio.com/us1/monitor/debugger'
      };

      window.open(urls[section] || 'https://console.twilio.com', '_blank');
    }

    // Add console links to Step 6
    function addConsoleLinks() {
      return `
        <div class="service-card" style="margin-top: 20px; background: #e7f5ff;">
          <h4>üîç Monitor in Twilio Console</h4>
          <p style="margin: 10px 0;">View live logs and debug your calls:</p>
          <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button class="btn btn-primary" onclick="openTwilioConsole('calls')">üìû Call Logs</button>
            <button class="btn btn-primary" onclick="openTwilioConsole('functions')">‚öôÔ∏è Function Logs</button>
            <button class="btn btn-primary" onclick="openTwilioConsole('debugger')">üêõ Debugger</button>
          </div>
        </div>
      `;
    }

    // =========================================================================
    // OAUTH AUTHENTICATION
    // =========================================================================

    let sessionToken = null;

    // Check for OAuth callback on page load
    window.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const session = urlParams.get('session');
      const authSuccess = urlParams.get('auth');

      if (session && authSuccess === 'success') {
        // Store session token
        sessionStorage.setItem('twilioSession', session);
        sessionToken = session;

        // Clean URL
        window.history.replaceState({}, '', window.location.pathname);

        // Check auth status
        checkOAuthStatus();
      } else {
        // Check for existing session
        sessionToken = sessionStorage.getItem('twilioSession');
        if (sessionToken) {
          checkOAuthStatus();
        }
      }
    });

    // Initiate OAuth login
    async function loginWithTwilio() {
      try {
        showStatus('step1Status', 'info', 'Redirecting to Twilio login...');

        const response = await fetch('/tutorial-oauth-login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'getAuthUrl' })
        });

        const data = await response.json();

        if (data.success) {
          // Store state for CSRF validation
          sessionStorage.setItem('oauthState', data.state);

          // Redirect to Twilio OAuth
          window.location.href = data.authUrl;
        } else {
          showStatus('step1Status', 'error', 'Failed to initiate login: ' + (data.error || 'Unknown error'));
        }

      } catch (error) {
        console.error('Login error:', error);
        showStatus('step1Status', 'error', 'Failed to initiate login. Please try again.');
      }
    }

    // Check OAuth authentication status
    async function checkOAuthStatus() {
      try {
        const response = await fetch('/tutorial-oauth-login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'checkAuthStatus',
            sessionToken: sessionToken
          })
        });

        const data = await response.json();

        if (data.authenticated) {
          // Show authenticated UI
          document.getElementById('oauthStatus').style.display = 'block';
          document.getElementById('oauthAccountName').textContent =
            data.accountInfo ? data.accountInfo.friendlyName : 'Connected Account';

          // Mark as connected
          twilioConnected = true;
          twilioCredentials = {
            sessionToken: sessionToken,
            accountFriendlyName: data.accountInfo?.friendlyName
          };

          showStatus('step1Status', 'success', '‚úÖ Twilio connected via OAuth!');
          checkStep1Complete();

        } else {
          // Clear invalid session
          sessionStorage.removeItem('twilioSession');
          sessionToken = null;
          document.getElementById('oauthStatus').style.display = 'none';
        }

      } catch (error) {
        console.error('Auth check error:', error);
        sessionStorage.removeItem('twilioSession');
        sessionToken = null;
      }
    }

    // Logout from OAuth
    async function logoutOAuth() {
      try {
        await fetch('/tutorial-oauth-login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'logout',
            sessionToken: sessionToken
          })
        });

      } catch (error) {
        console.error('Logout error:', error);
      } finally {
        // Clear local session
        sessionStorage.removeItem('twilioSession');
        sessionToken = null;
        twilioConnected = false;
        twilioCredentials = null;

        // Hide auth status
        document.getElementById('oauthStatus').style.display = 'none';

        showStatus('step1Status', 'info', 'Logged out. Please reconnect to continue.');
      }
    }

    // =========================================================================
    // DEMO MODE MANAGEMENT
    // =========================================================================

    // Show demo mode banner when demo mode is active
    function updateDemoModeBanner() {
      const banner = document.getElementById('demoModeBanner');
      if (studentDemoMode || twilioCredentials?.demoMode === true) {
        banner.style.display = 'block';
      } else {
        banner.style.display = 'none';
      }
    }

    // Exit demo mode - reset everything
    function exitDemoMode() {
      if (confirm('Exit Demo Mode?\n\nThis will reset all progress and return you to Step 1. Are you sure?')) {
        // Clear all connection state
        twilioCredentials = null;
        twilioConnected = false;
        openaiConnected = false;
        openaiApiKey = null;
        githubToken = null;
        githubUsername = null;
        studentDemoMode = false;

        // Reset to step 1
        currentStep = 0;

        // Clear call direction
        callDirectionChosen = false;
        callDirection = '';

        // Clear services
        servicesReady = false;
        selectedPhoneNumber = null;
        selectedPhoneNumberSid = null;

        // Clear all progress flags
        basicTwimlCreated = false;
        functionsDeployed = false;
        basicCallTested = false;
        websocketBuilt = false;
        conversationRelayCreated = false;
        promptEngineeringComplete = false;
        toolsConfigured = false;
        projectDeployed = false;
        aiCallTested = false;
        step4CodeValidated = false;
        step4Committed = false;
        step5CodeValidated = false;
        step5Deployed = false;
        step6CodeValidated = false;
        step6Deployed = false;
        step8Committed = false;
        syncServiceSkipped = false;
        deployedServiceSid = null;
        deployedEnvironmentSid = null;
        deployedBuildSid = null;

        // Clear all localStorage
        localStorage.removeItem('workshopProgress');
        localStorage.removeItem('studentDemoMode');
        localStorage.removeItem('demoPurchasedNumber');
        localStorage.removeItem('workshopCredentials');
        sessionStorage.clear();

        // Hide banner
        document.getElementById('demoModeBanner').style.display = 'none';

        // Reset to step 1 and re-render
        renderProgressSteps();
        renderStepContent();

        // Scroll to top
        window.scrollTo(0, 0);

        celebrate('Demo mode exited. Please connect your credentials to continue.', 'normal');
      }
    }

    // =========================================================================
    // VOICE HANDLER COMMIT (Step 4)
    // =========================================================================

    // Commit voice handler to GitHub
    async function commitVoiceHandlerToGitHub() {
      const code = document.getElementById('code4').value;

      if (!window.studentRepoUrl) {
        showStatus('commitStep4Status', 'error', '‚ùå Please clone the workshop repository first (Step 1a)');
        return;
      }

      showStatus('commitStep4Status', 'info', 'üì§ Pushing voice handler to GitHub...');

      try {
        // In a real implementation, this would use GitHub API to commit the file
        // For now, we'll show instructions
        showStatus('commitStep4Status', 'success',
          `‚úÖ Voice handler ready!<br><br>
          <strong>Next steps:</strong><br>
          1. Your code is saved locally<br>
          2. Push it to your repo: <code style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px;">${window.studentRepoName}/voice-handler.js</code><br>
          3. Deploy your repo to Railway/Render/Heroku<br>
          4. Update your Twilio phone number webhook to point to your deployed URL`
        );

        step4Committed = true;
        document.getElementById('nextBtn4').disabled = false;

      } catch (error) {
        showStatus('commitStep4Status', 'error', '‚ùå Error: ' + error.message);
      }
    }

    // Commit voice handler to Twilio Serverless
    async function commitVoiceHandlerToTwilio() {
      const code = document.getElementById('code4').value;

      if (!twilioCredentials || twilioCredentials.demoMode) {
        showStatus('commitStep4Status', 'error', '‚ùå Please connect your Twilio credentials first');
        return;
      }

      showStatus('commitStep4Status', 'info', 'üöÄ Deploying to Twilio Serverless...');

      try {
        // Use existing commitStep function
        await commitStep(4);

      } catch (error) {
        showStatus('commitStep4Status', 'error', '‚ùå Error: ' + error.message);
      }
    }

    // =========================================================================
    // GITHUB OAUTH & REPOSITORY CLONE
    // =========================================================================

    // Initiate GitHub OAuth flow
    async function initiateGitHubOAuth() {
      try {
        const response = await fetch('/api/github-oauth-init', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();

        if (data.success) {
          // Redirect to GitHub authorization
          window.location.href = data.authUrl;
        } else {
          showStatus('githubCloneStatus', 'error', '‚ùå ' + data.error);
        }
      } catch (error) {
        showStatus('githubCloneStatus', 'error', '‚ùå Error: ' + error.message);
      }
    }

    // Clone workshop repository to student's GitHub account
    async function cloneWorkshopRepo() {
      if (!githubToken || !githubUsername) {
        showStatus('githubCloneStatus', 'error', '‚ùå Please login with GitHub first');
        return;
      }

      showStatus('githubCloneStatus', 'info', 'üì¶ Cloning repository...');

      try {
        const response = await fetch('/api/github-create-repo', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            accessToken: githubToken,
            githubUsername: githubUsername,
            repoName: 'twilio-voice-ai-workshop'
          })
        });

        const data = await response.json();

        if (data.success) {
          showStatus('githubCloneStatus', 'success',
            `‚úÖ Repository cloned! <a href="${data.repoUrl}" target="_blank" style="color: #4caf50; text-decoration: underline;">View on GitHub ‚Üí</a>`
          );

          // Store repo URL for later commits
          window.studentRepoUrl = data.repoUrl;
          window.studentRepoName = 'twilio-voice-ai-workshop';

          celebrate('üéâ Repository cloned successfully! You can now proceed with the workshop.', 'normal');
        } else {
          showStatus('githubCloneStatus', 'error', '‚ùå ' + data.error);
        }
      } catch (error) {
        showStatus('githubCloneStatus', 'error', '‚ùå Error: ' + error.message);
      }
    }

    // Initialize on load
    init();
    updateProgressBar();
  </script>
</body>
</html>
