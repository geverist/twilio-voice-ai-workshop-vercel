<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Twilio Voice AI Workshop - Interactive Tutorial</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #F22F46 0%, #0d122b 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .workshop-container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #F22F46 0%, #0d122b 100%);
      padding: 30px;
      color: white;
      text-align: center;
    }

    .header h1 {
      font-size: 2rem;
      margin-bottom: 10px;
    }

    /* Progress Steps */
    .progress-steps {
      display: flex;
      justify-content: space-between;
      padding: 30px;
      background: #f8f9fa;
      border-bottom: 2px solid #e0e0e0;
      overflow-x: auto;
    }

    .step-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
      position: relative;
      min-width: 120px;
    }

    .step-item:not(:last-child)::after {
      content: '';
      position: absolute;
      top: 20px;
      left: 60%;
      width: 80%;
      height: 3px;
      background: #e0e0e0;
      z-index: 0;
    }

    .step-item.completed:not(:last-child)::after {
      background: #28a745;
    }

    .step-number {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #e0e0e0;
      color: #666;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      margin-bottom: 8px;
      position: relative;
      z-index: 1;
    }

    .step-item.active .step-number {
      background: #F22F46;
      color: white;
      box-shadow: 0 0 0 4px rgba(242, 47, 70, 0.2);
    }

    .step-item.completed .step-number {
      background: #28a745;
      color: white;
    }

    /* Attention-grabbing animations */
    @keyframes pulse {
      0%, 100% {
        box-shadow: 0 0 0 0 rgba(242, 47, 70, 0.7);
        transform: scale(1);
      }
      50% {
        box-shadow: 0 0 0 15px rgba(242, 47, 70, 0);
        transform: scale(1.05);
      }
    }

    @keyframes glow {
      0%, 100% {
        box-shadow: 0 0 10px rgba(242, 47, 70, 0.5), 0 0 20px rgba(242, 47, 70, 0.3);
      }
      50% {
        box-shadow: 0 0 20px rgba(242, 47, 70, 0.8), 0 0 40px rgba(242, 47, 70, 0.5);
      }
    }

    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% {
        transform: translateY(-50%);
      }
      40% {
        transform: translateY(calc(-50% - 10px));
      }
      60% {
        transform: translateY(calc(-50% - 5px));
      }
    }

    /* Next action indicator class */
    .next-action {
      animation: pulse 2s infinite, glow 2s infinite;
      position: relative;
      z-index: 1;
    }

    .next-action::before {
      content: 'üëâ';
      position: absolute;
      left: -45px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1.5rem;
      animation: bounce 1s infinite;
      z-index: 2;
    }

    /* Add extra left margin to next-action buttons in button-group to make room for finger */
    .button-group .next-action {
      margin-left: 60px;
    }

    .step-item.completed .step-number::before {
      content: '‚úì';
    }

    .step-title {
      font-size: 12px;
      text-align: center;
      color: #666;
      font-weight: 500;
    }

    .step-item.active .step-title {
      color: #F22F46;
      font-weight: 600;
    }

    /* Main Content */
    .content {
      padding: 40px;
    }

    .step-content {
      display: none;
    }

    .step-content.active {
      display: block;
      animation: fadeIn 0.5s;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .step-header {
      margin-bottom: 30px;
    }

    .step-header h2 {
      font-size: 1.8rem;
      color: #0d122b;
      margin-bottom: 10px;
    }

    .step-header p {
      color: #666;
      font-size: 1.1rem;
    }

    .instructions {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 20px;
      margin: 20px 0;
      border-radius: 4px;
    }

    .instructions h3 {
      color: #856404;
      margin-bottom: 15px;
    }

    .form-group {
      margin: 20px 0;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #333;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #F22F46;
    }

    .code-editor {
      background: #1e1e1e;
      border: 1px solid #333;
      border-radius: 8px;
      overflow: hidden;
      margin: 20px 0;
    }

    .code-header {
      background: #2d2d2d;
      color: white;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .btn-copy {
      background: #0d122b;
      color: white;
      padding: 6px 12px;
      font-size: 13px;
      border: 1px solid #4fc1ff;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-copy:hover {
      background: #4fc1ff;
      color: #0d122b;
    }

    .btn-copy.copied {
      background: #28a745;
      border-color: #28a745;
    }

    .code-textarea {
      width: 100%;
      min-height: 300px;
      background: #1e1e1e;
      color: #d4d4d4;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 14px;
      line-height: 1.6;
      padding: 20px;
      border: none;
      resize: vertical;
      outline: none;
    }

    .console-output {
      background: #1e1e1e;
      color: #d4d4d4;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 13px;
      padding: 15px;
      min-height: 150px;
      max-height: 300px;
      overflow-y: auto;
      border-radius: 8px;
      margin: 20px 0;
    }

    .console-line {
      margin-bottom: 5px;
    }

    .console-line.success { color: #4ec9b0; }
    .console-line.error { color: #f48771; }
    .console-line.info { color: #4fc1ff; }

    .status-box {
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      display: none;
    }

    .status-box.show {
      display: block;
    }

    .status-box.success {
      background: #f0fdf4;
      border: 2px solid #22c55e;
      color: #0f172a;
    }

    .status-box.error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }

    .status-box.info {
      background: #e7f5ff;
      border: 1px solid #b8daff;
      color: #004085;
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin: 30px 0;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
    }

    .btn-primary {
      background: #F22F46;
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: #d1283d;
      transform: translateY(-2px);
    }

    .btn-primary:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-test {
      background: #17a2b8;
      color: white;
    }

    .live-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #28a745;
      margin-right: 8px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .connection-status {
      padding: 10px 15px;
      background: #f8f9fa;
      border-radius: 6px;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      margin: 10px 0;
    }

    .service-card {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
    }

    .service-card h4 {
      margin-bottom: 10px;
      color: #0d122b;
    }

    .service-status {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
    }

    /* Toolbar */
    .toolbar {
      background: #f8f9fa;
      border-bottom: 1px solid #e0e0e0;
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }

    .toolbar-left, .toolbar-right {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .btn-icon {
      padding: 8px 16px;
      border: 1px solid #e0e0e0;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .btn-icon:hover {
      background: #f8f9fa;
      border-color: #F22F46;
    }

    /* Debugger Panel */
    .debugger-panel {
      background: #1e1e1e;
      border-radius: 8px;
      padding: 15px;
      margin: 20px 0;
      display: none;
    }

    .debugger-panel.show {
      display: block;
    }

    .debugger-header {
      color: #4fc1ff;
      font-weight: 600;
      margin-bottom: 10px;
      font-size: 14px;
    }

    .event-flow {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .event-item {
      background: #2d2d2d;
      padding: 10px;
      border-radius: 4px;
      border-left: 3px solid #4fc1ff;
      font-family: monospace;
      font-size: 12px;
      color: #d4d4d4;
    }

    .event-item.start { border-left-color: #28a745; }
    .event-item.transcript { border-left-color: #ffc107; }
    .event-item.response { border-left-color: #4fc1ff; }
    .event-item.stop { border-left-color: #dc3545; }

    /* WebSocket Tester */
    .ws-tester {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }

    .ws-controls {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    /* Cost Calculator */
    .cost-widget {
      background: linear-gradient(135deg, #4fc1ff 0%, #0d122b 100%);
      color: white;
      border-radius: 8px;
      padding: 15px;
      margin: 20px 0;
    }

    .cost-breakdown {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .cost-item {
      background: rgba(255, 255, 255, 0.1);
      padding: 10px;
      border-radius: 4px;
    }

    .cost-item strong {
      display: block;
      font-size: 18px;
    }

    /* Video Section */
    .video-section {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }

    .video-container {
      position: relative;
      padding-bottom: 56.25%;
      height: 0;
      overflow: hidden;
      border-radius: 8px;
      background: #000;
      margin-top: 10px;
    }

    .video-container iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    /* Troubleshooting Panel */
    .troubleshooting {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 15px;
      border-radius: 4px;
      margin: 20px 0;
    }

    .faq-item {
      margin: 10px 0;
      cursor: pointer;
      padding: 10px;
      background: white;
      border-radius: 4px;
    }

    .faq-item:hover {
      background: #f8f9fa;
    }

    .faq-answer {
      display: none;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #e0e0e0;
      color: #666;
    }

    .faq-item.open .faq-answer {
      display: block;
    }

    /* Autocomplete */
    .autocomplete-suggestions {
      position: absolute;
      background: #2d2d2d;
      border: 1px solid #4fc1ff;
      border-radius: 4px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
    }

    .autocomplete-item {
      padding: 8px 12px;
      cursor: pointer;
      color: #d4d4d4;
      font-family: monospace;
      font-size: 13px;
    }

    .autocomplete-item:hover {
      background: #4fc1ff;
      color: #0d122b;
    }

    /* Progress Indicator */
    .progress-saved {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #28a745;
      color: white;
      padding: 10px 20px;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      display: none;
      animation: slideIn 0.3s;
    }

    @keyframes slideIn {
      from { transform: translateY(100px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-close {
      cursor: pointer;
      font-size: 24px;
      color: #666;
    }

    /* Language Toggle */
    .language-toggle {
      background: white;
      border-bottom: 2px solid #e0e0e0;
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }

    .language-toggle-label {
      color: #666;
      font-weight: 600;
      font-size: 0.95rem;
    }

    .language-buttons {
      display: flex;
      gap: 10px;
      background: #f8f9fa;
      padding: 4px;
      border-radius: 8px;
    }

    .lang-btn {
      padding: 8px 20px;
      border: none;
      background: transparent;
      color: #666;
      font-weight: 600;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.3s;
      font-size: 0.9rem;
    }

    .lang-btn:hover {
      background: rgba(242, 47, 70, 0.1);
      color: #F22F46;
    }

    .lang-btn.active {
      background: #F22F46;
      color: white;
      box-shadow: 0 2px 8px rgba(242, 47, 70, 0.3);
    }

    .lang-icon {
      margin-right: 5px;
    }

    /* Tooltip styles */
    .tooltip-trigger {
      display: inline-block;
      color: #F22F46;
      cursor: help;
      border-bottom: 1px dashed #F22F46;
      position: relative;
    }

    .tooltip-content {
      display: none;
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      border: 2px solid #F22F46;
      border-radius: 12px;
      padding: 20px;
      width: 300px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      margin-bottom: 10px;
    }

    .tooltip-trigger:hover .tooltip-content {
      display: block;
      animation: fadeIn 0.3s;
    }

    .tooltip-content h4 {
      color: #0d122b;
      margin-bottom: 10px;
      font-size: 1.1rem;
    }

    .tooltip-content p {
      color: #666;
      line-height: 1.5;
      margin-bottom: 10px;
      font-size: 0.9rem;
    }

    .tooltip-content a {
      color: #F22F46;
      text-decoration: none;
      font-weight: 600;
    }

    .tooltip-content a:hover {
      text-decoration: underline;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>
<body>
  <div class="workshop-container">
    <div class="header">
      <h1>üéôÔ∏è Twilio Voice AI Workshop</h1>
      <p>Build a Functional Agentic Voice AI Solution with ConversationRelay & OpenAI</p>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
      <div class="toolbar-left">
        <button class="btn-icon" onclick="saveProgress()">üíæ Save Progress</button>
        <button class="btn-icon" onclick="loadProgress()">üìÇ Load Progress</button>
        <button class="btn-icon" onclick="exportProject()">üì¶ Export Project</button>
        <button class="btn-icon" onclick="openUseCases()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">üéØ Use Cases</button>
      </div>
      <div class="toolbar-right">
        <button class="btn-icon" onclick="openConversationHistory()" title="View your conversation history">üí¨ History</button>
        <button class="btn-icon" onclick="openVXMLConverter()" title="Convert VXML IVR to AI prompt">üîÑ VXML</button>
        <button class="btn-icon" disabled style="opacity: 0.5; cursor: not-allowed; background: #2c313c; color: #666;" title="Collaborate With Your Team">üë• Collaborate</button>
        <button class="btn-icon" onclick="openPlayground()">üéì What is CR?</button>
        <button class="btn-icon" onclick="toggleDebugger()">üêõ Debugger</button>
        <!-- Cost calculator temporarily removed - pricing needs to be verified -->
        <!-- <button class="btn-icon" onclick="showCostCalculator()">üí∞ Costs</button> -->
        <button class="btn-icon" onclick="showBugReportModal()" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white;">üêõ Report Bug</button>
        <button class="btn-icon" onclick="showHelp()">‚ùì Help</button>
      </div>
    </div>

    <!-- Demo Mode Banner -->
    <div id="demoModeBanner" style="display: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 30px; border-bottom: 2px solid rgba(255,255,255,0.3);">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div style="display: flex; align-items: center; gap: 15px;">
          <span style="font-size: 24px;">üìù</span>
          <div>
            <strong style="font-size: 16px;">Demo Mode Active</strong>
            <p style="margin: 3px 0 0 0; font-size: 13px; opacity: 0.9;">
              Exploring without credentials - API calls are simulated
            </p>
          </div>
        </div>
        <button onclick="exitDemoMode()" style="padding: 10px 20px; background: rgba(255,255,255,0.2); color: white; border: 1px solid white; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">
          ‚ùå Exit Demo Mode
        </button>
      </div>
    </div>

    <!-- Overall Progress Bar -->
    <div style="background: white; padding: 20px 30px; border-bottom: 2px solid #e0e0e0;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <h3 style="margin: 0; font-size: 16px; color: #0d122b;">Workshop Progress</h3>
        <span id="progressPercent" style="font-weight: 600; color: #F22F46;">0%</span>
      </div>
      <div style="width: 100%; height: 12px; background: #e0e0e0; border-radius: 6px; overflow: hidden;">
        <div id="progressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #F22F46 0%, #0d122b 100%); transition: width 0.5s ease;"></div>
      </div>
      <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 12px; color: #666;">
        <span id="completedTasks">0 of 9 steps completed</span>
        <span id="timeEstimate">Est. 45-60 minutes</span>
      </div>
    </div>

    <!-- Progress Steps -->
    <div class="progress-steps" id="progressSteps">
      <!-- Populated by JavaScript -->
    </div>

    <!-- Main Content -->
    <div class="content" id="mainContent">
      <!-- Step content populated by JavaScript -->
    </div>
  </div>

  <!-- Progress Saved Indicator -->
  <div class="progress-saved" id="progressSaved">‚úì Progress Saved</div>

  <!-- Cost Calculator Modal -->
  <div class="modal" id="costModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üí∞ Cost Calculator</h2>
        <span class="modal-close" onclick="closeModal('costModal')">&times;</span>
      </div>
      <div id="costCalculatorContent"></div>
    </div>
  </div>

  <!-- Help Modal -->
  <div class="modal" id="helpModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>‚ùì Help & Troubleshooting</h2>
        <span class="modal-close" onclick="closeModal('helpModal')">&times;</span>
      </div>
      <div id="helpContent"></div>
    </div>
  </div>

  <!-- Export Project Modal -->
  <div class="modal" id="exportModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üì¶ Export Your Project</h2>
        <span class="modal-close" onclick="closeModal('exportModal')">&times;</span>
      </div>
      <div id="exportContent"></div>
    </div>
  </div>

  <!-- Bug Report Modal -->
  <div class="modal" id="bugReportModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 style="color: #e74c3c;">üêõ Report a Bug</h2>
        <span class="modal-close" onclick="closeModal('bugReportModal')">&times;</span>
      </div>
      <div style="padding: 20px;">
        <p style="margin-bottom: 20px; color: #666;">
          Help us improve the workshop! Please describe the issue you're experiencing and we'll get back to you.
        </p>

        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600;">Your Name (optional)</label>
          <input type="text" id="bugUserName" placeholder="Your name"
                 style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 1rem;">
        </div>

        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600;">What happened? <span style="color: #e74c3c;">*</span></label>
          <textarea id="bugDescription" rows="4" placeholder="Describe the bug or issue..."
                    style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 1rem; resize: vertical;" required></textarea>
        </div>

        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600;">What did you expect to happen?</label>
          <textarea id="bugExpectedBehavior" rows="2" placeholder="e.g., The deploy button should have succeeded"
                    style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 1rem; resize: vertical;"></textarea>
        </div>

        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600;">What actually happened?</label>
          <textarea id="bugActualBehavior" rows="2" placeholder="e.g., Got an error message saying 'Deployment failed'"
                    style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 1rem; resize: vertical;"></textarea>
        </div>

        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600;">Error Message (if any)</label>
          <textarea id="bugErrorMessage" rows="3" placeholder="Copy/paste any error messages here..."
                    style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 1rem; font-family: 'Monaco', monospace; resize: vertical;"></textarea>
        </div>

        <div style="padding: 15px; background: #f8f9fa; border-radius: 6px; margin-bottom: 20px;">
          <div style="font-size: 13px; color: #666; margin-bottom: 8px;"><strong>Auto-captured info:</strong></div>
          <div style="font-size: 13px; color: #333;">
            <div>üìç Current Step: <span id="bugCurrentStep">-</span></div>
            <div>üåê Page URL: <span id="bugPageUrl" style="word-break: break-all;">-</span></div>
            <div>üñ•Ô∏è Browser: <span id="bugBrowserInfo">-</span></div>
          </div>
        </div>

        <div style="display: flex; gap: 10px;">
          <button onclick="submitBugReport()"
                  style="flex: 1; padding: 14px; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; border: none; border-radius: 6px; font-size: 1rem; font-weight: 600; cursor: pointer;">
            üì§ Submit Bug Report
          </button>
          <button onclick="closeModal('bugReportModal')"
                  style="padding: 14px 20px; background: #6c757d; color: white; border: none; border-radius: 6px; font-size: 1rem; cursor: pointer;">
            Cancel
          </button>
        </div>

        <div id="bugReportStatus" style="margin-top: 15px;"></div>
      </div>
    </div>
  </div>

  <!-- Feedback Modal -->
  <div class="modal" id="feedbackModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 style="color: #667eea;">üí¨ Share Your Feedback</h2>
        <span class="modal-close" onclick="closeModal('feedbackModal')">&times;</span>
      </div>
      <div style="padding: 20px;">
        <p style="margin-bottom: 20px; color: #666;">
          Your feedback helps us improve the workshop! Please share your thoughts about your experience.
        </p>

        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600;">Your Name (optional)</label>
          <input type="text" id="feedbackUserName" placeholder="Your name"
                 style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 1rem;">
        </div>

        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600;">Your Feedback <span style="color: #667eea;">*</span></label>
          <textarea id="feedbackMessage" rows="6" placeholder="What did you think of the workshop? What could we improve?"
                    style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 1rem; resize: vertical;" required></textarea>
        </div>

        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600;">Overall Rating</label>
          <div style="display: flex; gap: 10px;">
            <button onclick="setFeedbackRating(1)" id="rating-1" class="rating-btn" style="padding: 10px 15px; background: #f8f9fa; border: 2px solid #e0e0e0; border-radius: 6px; cursor: pointer; font-size: 1.2rem;">‚≠ê</button>
            <button onclick="setFeedbackRating(2)" id="rating-2" class="rating-btn" style="padding: 10px 15px; background: #f8f9fa; border: 2px solid #e0e0e0; border-radius: 6px; cursor: pointer; font-size: 1.2rem;">‚≠ê‚≠ê</button>
            <button onclick="setFeedbackRating(3)" id="rating-3" class="rating-btn" style="padding: 10px 15px; background: #f8f9fa; border: 2px solid #e0e0e0; border-radius: 6px; cursor: pointer; font-size: 1.2rem;">‚≠ê‚≠ê‚≠ê</button>
            <button onclick="setFeedbackRating(4)" id="rating-4" class="rating-btn" style="padding: 10px 15px; background: #f8f9fa; border: 2px solid #e0e0e0; border-radius: 6px; cursor: pointer; font-size: 1.2rem;">‚≠ê‚≠ê‚≠ê‚≠ê</button>
            <button onclick="setFeedbackRating(5)" id="rating-5" class="rating-btn" style="padding: 10px 15px; background: #f8f9fa; border: 2px solid #e0e0e0; border-radius: 6px; cursor: pointer; font-size: 1.2rem;">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</button>
          </div>
        </div>

        <div style="padding: 15px; background: #f8f9fa; border-radius: 6px; margin-bottom: 20px;">
          <div style="font-size: 13px; color: #666; margin-bottom: 8px;"><strong>Auto-captured info:</strong></div>
          <div style="font-size: 13px; color: #333;">
            <div>üìç Completed Steps: <span id="feedbackCompletedSteps">-</span></div>
            <div>‚è±Ô∏è Time Spent: <span id="feedbackTimeSpent">-</span></div>
          </div>
        </div>

        <div style="display: flex; gap: 10px;">
          <button onclick="submitFeedback()"
                  style="flex: 1; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; font-size: 1rem; font-weight: 600; cursor: pointer;">
            üì§ Submit Feedback
          </button>
          <button onclick="closeModal('feedbackModal')"
                  style="padding: 14px 20px; background: #6c757d; color: white; border: none; border-radius: 6px; font-size: 1rem; cursor: pointer;">
            Cancel
          </button>
        </div>

        <div id="feedbackStatus" style="margin-top: 15px;"></div>
      </div>
    </div>
  </div>

  <script>
    // Workshop Steps Configuration
    const steps = [
      {
        id: 1,
        title: 'Setup',
        description: 'Connect your accounts',
        validate: () => twilioConnected
      },
      {
        id: 2,
        title: 'Use Case',
        description: 'Define your use case',
        validate: () => callDirectionChosen
      },
      {
        id: 3,
        title: 'Services',
        description: 'Provision Twilio services',
        validate: () => servicesReady
      },
      {
        id: 4,
        title: 'Basic TwiML',
        description: 'Build, test & deploy',
        validate: () => basicTwimlCreated && functionsDeployed
      },
      {
        id: 5,
        title: 'WebSocket Handler',
        description: 'Build AI backend',
        validate: () => websocketBuilt
      },
      {
        id: 6,
        title: 'ConversationRelay',
        description: 'Upgrade to AI',
        validate: () => conversationRelayCreated
      },
      {
        id: 7,
        title: 'Prompt Engineering',
        description: 'Master AI prompting',
        validate: () => promptEngineeringComplete
      },
      {
        id: 8,
        title: 'Tools & Functions',
        description: 'Add tools & knowledge',
        validate: () => toolsConfigured
      },
      {
        id: 9,
        title: 'Deploy Your System',
        description: 'Launch to production',
        validate: () => projectDeployed
      }
    ];

    // State
    let currentStep = 0;
    let twilioConnected = false;
    let openaiConnected = false;
    let callDirectionChosen = false;
    let callDirection = ''; // 'outbound' or 'inbound'
    let useCaseDescription = ''; // User's custom use case description
    let skipInitialGreeting = false; // Skip the AI's initial greeting (wait for caller to speak first)
    let generatedContent = null; // AI-generated content based on use case
    let servicesReady = false;
    let basicTwimlCreated = false;
    let functionsDeployed = false;
    let basicCallTested = false;
    let websocketBuilt = false;

    // Progressive reveal flags for Step 4
    let step4CodeValidated = false;
    let step4LiveTestCompleted = false;

    // Progressive reveal flags for Step 4
    let step4Deployed = false;

    // Progressive reveal flags for Step 5
    let step5CodeValidated = false;
    let step5Deployed = false;

    // Progressive reveal flags for Step 6
    let step6CodeValidated = false;
    let step6CodeTested = false;
    let step6Deployed = false;
    let conversationRelayCreated = false;

    // Progressive reveal flags for Step 7 (Prompt Engineering)
    let systemPromptSaved = false;
    let promptEngineeringComplete = false;

    // Progressive reveal flags for Step 8 (Tools & Functions)
    let step8CodeValidated = false;
    let step8Deployed = false;
    let toolsConfigured = false;

    // Progressive reveal flags for Step 9 (Final Deployment)
    let projectDeployed = false;
    let aiCallTested = false;

    // Code change tracking flags (for validate button state)
    let code4Changed = false;
    let code7Changed = false;
    let code8Changed = false;
    let code9Changed = false;

    let twilioCredentials = null;
    let openaiApiKey = null;
    let selectedPhoneNumber = null;
    let selectedPhoneNumberSid = null;
    let websocketUrl = '';
    let twilioServerlessDomain = ''; // Domain for Twilio Serverless functions (e.g., 'my-service-1234.twil.io')
    let syncServiceSkipped = false;
    let deployedServiceSid = null;
    let githubToken = null;
    let githubUsername = null;
    let studentRepoName = null; // Student's GitHub repository name

    // Check URL parameters for pre-populated email and name (from invitation link)
    const urlParams = new URLSearchParams(window.location.search);
    const emailParam = urlParams.get('email');
    const nameParam = urlParams.get('name');

    // Use URL params if present, otherwise fall back to localStorage
    let studentName = nameParam || localStorage.getItem('studentName') || '';
    let studentEmail = emailParam || localStorage.getItem('studentEmail') || '';
    let studentDemoMode = localStorage.getItem('studentDemoMode') === 'true';

    // If URL params were provided, save them to localStorage
    if (emailParam) {
      localStorage.setItem('studentEmail', emailParam);
    }
    if (nameParam) {
      localStorage.setItem('studentName', nameParam);
    }

    // Codespaces variables
    let codespaceUrl = ''; // WebSocket URL (wss://...)
    let codespaceWebUrl = ''; // Browser URL to open Codespace
    let codespaceName = ''; // Codespace identifier
    let isConnected = false; // WebSocket test connection status

    // Railway variables
    let railwayToken = null; // Railway API token
    let railwayProjectId = null; // Railway project ID
    let railwayUrl = ''; // Railway deployment URL

    // GitHub variables
    let githubRepoUrl = ''; // GitHub repository URL

    // Session token for identifying student across requests (works for both live and demo mode)
    let sessionToken = localStorage.getItem('sessionToken') || null;
    let ttsProvider = 'elevenlabs'; // Default TTS provider
    let voiceLanguage = 'en-US'; // Default voice language
    let elevenlabsApiKey = null; // For ElevenLabs TTS
    let conversationRelayVoice = null; // Selected voice for ConversationRelay
    let ciServiceSid = null; // Conversational Intelligence service (silent background setup)
    let workshopCallSids = []; // Track all calls made during workshop for analytics
    let testWebSocket = null; // WebSocket test connection (needs to be closed before making calls)

    // Incremental deployment tracking
    let step4Committed = false; // Basic TwiML
    let step5Committed = false; // WebSocket
    let step6Committed = false; // ConversationRelay
    let step7Committed = false; // Custom Prompt
    let step7Deployed = false;  // Custom Prompt deployed
    let step8Committed = false; // Tooling
    let deployedEnvironmentSid = null;
    let deployedBuildSid = null;

    // Language preference
    let currentLanguage = localStorage.getItem('preferredLanguage') || 'javascript';

    // =========================================================================
    // CENTRALIZED STATE MANAGEMENT SYSTEM
    // =========================================================================

    // State change listeners
    const stateListeners = {};
    let syncTimer = null;

    // Get nested property from object using dot notation
    function getNestedProperty(obj, path) {
      return path.split('.').reduce((curr, prop) => curr?.[prop], obj);
    }

    // Set nested property on object using dot notation
    function setNestedProperty(obj, path, value) {
      const parts = path.split('.');
      const last = parts.pop();
      const target = parts.reduce((curr, prop) => {
        if (!curr[prop]) curr[prop] = {};
        return curr[prop];
      }, obj);
      target[last] = value;
    }

    // Get state value
    function getState(path) {
      // For now, just access the global variables directly
      // Later we'll migrate to workshopState object
      const varName = path.split('.').pop();
      return window[varName];
    }

    // Set state value with automatic localStorage and database sync
    function setState(path, value) {
      const varName = path.split('.').pop();
      const oldValue = window[varName];

      // Update the window variable
      window[varName] = value;

      // Also update internal variables (for consistency and tests)
      if (varName === 'twilioConnected') twilioConnected = value;
      if (varName === 'openaiConnected') openaiConnected = value;
      if (varName === 'currentStep') currentStep = value;
      if (varName === 'callDirectionChosen') callDirectionChosen = value;
      if (varName === 'callDirection') callDirection = value;
      if (varName === 'useCaseDescription') useCaseDescription = value;
      if (varName === 'servicesReady') servicesReady = value;
      if (varName === 'selectedPhoneNumber') selectedPhoneNumber = value;

      // Save to localStorage immediately
      saveProgressToStorage();

      // Queue database sync (debounced)
      queueDatabaseSync();

      // Trigger listeners
      if (stateListeners[path]) {
        stateListeners[path].forEach(callback => callback(value, oldValue));
      }

      // Trigger wildcard listeners
      if (stateListeners['*']) {
        stateListeners['*'].forEach(callback => callback(path, value, oldValue));
      }

      // Check conditions after state change
      setTimeout(() => checkAllConditions(), 0);

      return value;
    }

    // Watch for state changes
    function watchState(path, callback) {
      if (!stateListeners[path]) {
        stateListeners[path] = [];
      }
      stateListeners[path].push(callback);
    }

    // =============================================
    // SESSION LOGGING (for troubleshooting)
    // =============================================

    /**
     * Log session event for troubleshooting
     * @param {string} eventType - Type of event: navigation|error|action|api_call|state_change
     * @param {object} eventData - Event details
     */
    async function logSessionEvent(eventType, eventData) {
      if (!sessionToken) return; // Don't log if no session

      try {
        await fetch(`${window.location.origin}/api/session-log`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sessionToken: sessionToken,
            studentEmail: studentEmail || null,
            eventType: eventType,
            eventData: {
              ...eventData,
              currentStep: currentStep,
              stepName: steps[currentStep]?.title || 'Unknown',
              demoMode: studentDemoMode,
              userAgent: navigator.userAgent,
              timestamp: new Date().toISOString()
            }
          })
        });
      } catch (error) {
        // Silently fail - don't break app if logging fails
        console.warn('Failed to log session event:', error);
      }
    }

    // Log navigation events
    function logNavigation(from, to) {
      logSessionEvent('navigation', {
        from: from,
        to: to,
        fromStepName: steps[from]?.title || 'Unknown',
        toStepName: steps[to]?.title || 'Unknown'
      });
    }

    // Log errors
    function logError(errorType, errorMessage, errorDetails = {}) {
      logSessionEvent('error', {
        errorType: errorType,
        errorMessage: errorMessage,
        ...errorDetails
      });
      console.error(`[Session Error] ${errorType}:`, errorMessage, errorDetails);
    }

    // Log user actions
    function logAction(actionName, actionDetails = {}) {
      logSessionEvent('action', {
        actionName: actionName,
        ...actionDetails
      });
    }

    // Log API calls
    function logApiCall(endpoint, method, status, details = {}) {
      logSessionEvent('api_call', {
        endpoint: endpoint,
        method: method,
        status: status,
        ...details
      });
    }

    // Log state changes
    function logStateChange(stateName, oldValue, newValue) {
      logSessionEvent('state_change', {
        stateName: stateName,
        oldValue: oldValue,
        newValue: newValue
      });
    }

    // Queue database sync with debouncing
    function queueDatabaseSync() {
      clearTimeout(syncTimer);
      syncTimer = setTimeout(() => {
        syncToDatabase();
      }, 2000); // Wait 2 seconds after last change
    }

    // Sync current state to database
    async function syncToDatabase() {
      if (!sessionToken) {
        console.log('‚ö†Ô∏è No sessionToken - skipping database sync');
        return;
      }

      console.log('üîÑ Syncing state to database for session:', sessionToken);

      try {
        const payload = {
          sessionToken: sessionToken,
          studentEmail: studentEmail || null, // Allow null for demo mode
          studentName: studentName || (studentDemoMode ? 'Demo User' : null),
          demoMode: studentDemoMode, // Track demo mode sessions

          // Step states
          currentStep: currentStep,
          twilioConnected: twilioConnected,
          openaiConnected: openaiConnected,
          callDirectionChosen: callDirectionChosen, // Added missing field
          callDirection: callDirection,
          useCaseDescription: useCaseDescription,
          selectedPhoneNumber: selectedPhoneNumber,
          servicesReady: servicesReady,

          // Step 4 state
          step4CodeValidated: step4CodeValidated,
          step4Committed: step4Committed,
          step4Deployed: step4Deployed,

          // Step 5 state
          step5CodeValidated: step5CodeValidated,
          step5Committed: step5Committed,
          step5Deployed: step5Deployed,

          // Step 6 state
          step6CodeValidated: step6CodeValidated,
          step6Committed: step6Committed,
          step6Deployed: step6Deployed,

          // Step 7 state
          systemPromptSaved: systemPromptSaved,
          step7Committed: step7Committed,
          step7Deployed: step7Deployed,

          // Step 8 state
          toolsConfigured: toolsConfigured,
          step8CodeValidated: step8CodeValidated,
          step8Committed: step8Committed,
          step8Deployed: step8Deployed,

          // Step 9 state
          projectDeployed: projectDeployed,

          // Configuration data
          openaiApiKey: openaiApiKey,
          systemPrompt: customSystemPrompt,
          tools: toolsPayload,
          selectedVoice: conversationRelayVoice,
          ttsProvider: ttsProvider
        };

        const response = await fetch('/api/student-config-save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const data = await response.json();

        if (data.success) {
          console.log('‚úÖ State synced to database for session:', sessionToken);
        } else {
          console.warn('‚ö†Ô∏è Database sync failed:', data.error);
        }
      } catch (error) {
        console.error('‚ùå Database sync error:', error);
      }
    }

    // Step completion conditions
    const STEP_CONDITIONS = {
      0: () => twilioConnected && openaiConnected,
      1: () => callDirectionChosen && useCaseDescription?.trim(),
      2: () => selectedPhoneNumber && servicesReady,
      3: () => step4CodeValidated && step4Deployed,
      4: () => step5CodeValidated && step5Deployed,
      5: () => step6CodeValidated && step6Deployed,
      6: () => systemPromptSaved,
      7: () => toolsConfigured && step8Deployed,
      8: () => projectDeployed
    };

    // Check if step is complete
    function checkStepComplete(stepNum) {
      const condition = STEP_CONDITIONS[stepNum];
      if (!condition) return false;

      const isComplete = condition();

      if (isComplete) {
        const nextBtn = document.getElementById(`nextBtn${stepNum + 1}`);
        if (nextBtn) {
          nextBtn.disabled = false;
        }
      }

      return isComplete;
    }

    // Check all conditions and update UI
    function checkAllConditions() {
      // Check current step completion
      checkStepComplete(currentStep);

      // Update next-action target
      updateNextActionTarget();
    }

    // Update which element should have next-action class
    function updateNextActionTarget() {
      // Remove all existing next-actions
      document.querySelectorAll('.next-action').forEach(el => {
        el.classList.remove('next-action');
      });

      // Determine what should have next-action based on current step and state
      let targetSelector = null;

      switch(currentStep) {
        case 0: // currentStep 0 = Step 1: Setup
          if (!twilioConnected) {
            targetSelector = '[onclick*="connectTwilio"]';
          } else if (!openaiConnected) {
            targetSelector = '[onclick*="connectOpenAI"]';
          } else {
            targetSelector = '#nextBtn1';
          }
          break;

        case 1: // currentStep 1 = Step 2: Use Case
          if (!callDirectionChosen) {
            targetSelector = '.direction-card';
          } else if (!useCaseDescription?.trim()) {
            targetSelector = '#useCaseDescription';
          } else {
            targetSelector = '#nextBtn2';
          }
          break;

        case 2: // currentStep 2 = Step 3: Services
          if (!selectedPhoneNumber) {
            // First priority: Select a phone number
            targetSelector = '.phone-option';
          } else if (!servicesReady) {
            // Phone selected but services not ready - highlight service creation
            // Check what's missing: messaging service or sync service
            const messagingCard = document.querySelector('.service-card:nth-child(2) .service-status span');
            const hasMessaging = messagingCard && messagingCard.textContent.includes('‚úÖ');

            if (!hasMessaging) {
              // Need to create messaging service
              targetSelector = '[onclick*="createMessagingService"]';
            } else {
              // Messaging is ready, must need Sync (or skip)
              const syncCard = document.querySelector('.service-card:nth-child(3) .service-status span');
              const hasSync = syncCard && syncCard.textContent.includes('‚úÖ');

              if (!hasSync && !syncServiceSkipped) {
                // Highlight either provision or skip sync button
                targetSelector = '[onclick*="provisionSync"]';
              }
            }
          } else if (servicesReady && selectedPhoneNumber) {
            // Everything ready - highlight next button
            targetSelector = '#nextBtn3';
          }
          break;

        case 3: // currentStep 3 = Step 4: Basic TwiML
          if (!step4CodeValidated) {
            targetSelector = '[onclick="validateCode4()"]';
          } else if (!step4Deployed) {
            targetSelector = '[onclick*="commitStep(4)"]';
          } else {
            targetSelector = '#nextBtn4';
          }
          break;

        case 4: // currentStep 4 = Step 5: WebSocket
          if (!step5CodeValidated) {
            targetSelector = '#validateBtn7';
          } else if (!step5Deployed) {
            targetSelector = '[onclick*="commitStep(5)"]';
          } else {
            targetSelector = '#nextBtn5';
          }
          break;

        case 5: // currentStep 5 = Step 6: ConversationRelay
          if (!step6CodeValidated) {
            targetSelector = '[onclick="validateCode8()"]';
          } else if (!step6Deployed) {
            targetSelector = '[onclick*="commitStep(6)"]';
          } else {
            targetSelector = '#nextBtn6';
          }
          break;

        case 6: // currentStep 6 = Step 7: Prompt Engineering
          if (!systemPromptSaved) {
            targetSelector = '[onclick*="savePrompt"]';
          } else {
            targetSelector = '#nextBtn7';
          }
          break;

        case 7: // currentStep 7 = Step 8: Tools
          if (!toolsConfigured) {
            targetSelector = '[onclick="validateCode9()"]';
          } else {
            targetSelector = '#nextBtn8';
          }
          break;

        case 8: // currentStep 8 = Step 9: Deploy
          targetSelector = '[onclick*="deployProject"]';
          break;
      }

      if (targetSelector) {
        const element = document.querySelector(targetSelector);
        if (element) {
          element.classList.add('next-action');
        }
      }
    }

    // =========================================================================
    // PROGRESS PERSISTENCE
    // =========================================================================

    function saveProgressToStorage() {
      const progress = {
        currentStep,
        twilioConnected,
        openaiConnected,
        callDirectionChosen,
        callDirection,
        useCaseDescription,
        skipInitialGreeting,  // ‚úÖ ADDED - user preference for greeting behavior
        generatedContent,
        servicesReady,
        basicTwimlCreated,
        functionsDeployed,
        basicCallTested,
        websocketBuilt,
        conversationRelayCreated,
        aiCallTested,
        twilioCredentials,
        openaiApiKey,
        selectedPhoneNumber,
        websocketUrl,
        twilioServerlessDomain,
        syncServiceSkipped,
        deployedServiceSid,
        ttsProvider,
        conversationRelayVoice,
        // Deployment flags
        step4Committed,
        step4Deployed,
        step4CodeValidated,  // ‚úÖ ADDED
        step5Committed,
        step5Deployed,
        step5CodeValidated,  // ‚úÖ ADDED
        step6Committed,
        step6Deployed,
        step6CodeValidated,  // ‚úÖ ADDED
        step7Committed,      // ‚úÖ ADDED (was missing!)
        step7Deployed,       // ‚úÖ ADDED (was missing!)
        systemPromptSaved,   // ‚úÖ ADDED
        promptEngineeringComplete,  // ‚úÖ ADDED - needed for progress bar
        step8Committed,
        step8Deployed,       // ‚úÖ ADDED
        step8CodeValidated,  // ‚úÖ ADDED
        toolsConfigured,     // ‚úÖ ADDED
        projectDeployed,     // ‚úÖ ADDED
        deployedEnvironmentSid,
        deployedBuildSid,
        studentRepoName,
        codespaceUrl,
        codespaceWebUrl,
        codespaceName,
        railwayToken,
        railwayProjectId,
        sessionToken,  // Save session token with progress
        timestamp: new Date().toISOString(),
        completedSteps: steps.slice(0, currentStep).map(s => s.title)
      };
      // Save progress per session token so each session has independent state
      const storageKey = `workshop_progress_${sessionToken}`;
      localStorage.setItem(storageKey, JSON.stringify(progress));
      console.log('Progress auto-saved for session:', sessionToken.substring(0, 8), progress);

      // Update UI highlights after state change
      if (typeof highlightNextAction === 'function') {
        setTimeout(() => highlightNextAction(), 100);
      }

      // Track progress to API if student email is provided
      trackStudentProgress();
    }

    async function trackStudentProgress() {
      // Track if we have session token (email is optional)
      if (!sessionToken) {
        console.log('üìä Progress tracking skipped - missing session token');
        return;
      }

      try {
        // Determine completion status for each step based on validation flags
        const stepCompletionStatus = {
          0: twilioConnected && openaiConnected,                    // Step 0 (UI shows Step 1): Connect accounts
          1: callDirectionChosen && useCaseDescription?.trim(),     // Step 1 (UI shows Step 2): Choose use case + description
          2: selectedPhoneNumber && servicesReady,                  // Step 2 (UI shows Step 3): Provision services
          3: step4CodeValidated && step4Deployed,                   // Step 3 (UI shows Step 4): Basic TwiML
          4: step5CodeValidated && step5Deployed,                   // Step 4 (UI shows Step 5): WebSocket handler
          5: step6CodeValidated && step6Deployed,                   // Step 5 (UI shows Step 6): ConversationRelay
          6: systemPromptSaved && step7Deployed,                    // Step 6 (UI shows Step 7): Custom AI Prompt
          7: step8CodeValidated && step8Deployed,                   // Step 7 (UI shows Step 8): Tools & Functions
          8: projectDeployed                                        // Step 8 (UI shows Step 9): Final Deployment
        };

        // Map step indices (0-8) to step names
        const stepNames = {
          0: 'Connect Accounts',
          1: 'Choose Use Case',
          2: 'Provision Services',
          3: 'Basic TwiML',
          4: 'WebSocket Handler',
          5: 'ConversationRelay',
          6: 'Custom AI Prompt',
          7: 'Tools & Functions',
          8: 'Final Deployment'
        };

        const identifier = studentEmail || 'anonymous';
        console.log(`üìä Tracking progress for ${identifier} session ${sessionToken.substring(0, 8)} (currentStep: ${currentStep}, UI Step: ${currentStep + 1})`);

        // Track progress for current step using the normalized V2 student-progress API
        const stepNumber = currentStep;  // 0-indexed (0-8)
        const isCompleted = stepCompletionStatus[stepNumber] || false;
        const stepName = stepNames[stepNumber];

        console.log(`  üìù Recording step ${stepNumber} (${stepName}): ${isCompleted ? 'COMPLETED' : 'IN PROGRESS'}`);

        const response = await fetch(`${window.location.origin}/api/student-progress`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            sessionToken: sessionToken,
            studentEmail: studentEmail || null,  // Allow null email for anonymous sessions
            studentName: studentName || studentEmail || 'Anonymous Student',
            stepNumber: stepNumber,
            stepName: stepName,
            completed: isCompleted,
            timeSpent: 0,  // TODO: Track actual time spent per step
            codeSubmitted: null,  // TODO: Track code submissions if needed
            demoMode: studentDemoMode  // Track if this is demo mode
          })
        });

        const data = await response.json();
        if (data.success) {
          console.log(`  ‚úÖ Step ${stepNumber} progress recorded successfully`);
        } else {
          console.warn(`  ‚ö†Ô∏è Failed to record step ${stepNumber}:`, data.error);
        }

      } catch (error) {
        console.error('‚ùå Error tracking student progress:', error);
        // Don't interrupt the user experience if tracking fails
      }
    }

    function loadProgressFromStorage() {
      try {
        // Load progress for THIS session token specifically
        const storageKey = `workshop_progress_${sessionToken}`;
        const saved = localStorage.getItem(storageKey);
        if (saved) {
          const progress = JSON.parse(saved);
          const savedDate = new Date(progress.timestamp);
          const daysSince = (Date.now() - savedDate.getTime()) / (1000 * 60 * 60 * 24);

          if (daysSince < 7) {
            console.log('Loaded progress for session:', sessionToken.substring(0, 8));
            return progress;
          } else {
            localStorage.removeItem(storageKey);
            console.log('Removed stale progress for session:', sessionToken.substring(0, 8));
          }
        }
      } catch (error) {
        console.error('Error loading progress:', error);
      }
      return null;
    }

    function showSetupRequiredModal() {
      const modal = document.createElement('div');
      modal.id = 'setupModal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        align-items: flex-start;
        justify-content: center;
        z-index: 10000;
        animation: fadeIn 0.3s;
        overflow-y: auto;
        padding: 20px;
      `;

      modal.innerHTML = `
        <div style="background: white; border-radius: 16px; padding: 30px; max-width: 650px; width: 100%; text-align: center; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); margin: auto; box-sizing: border-box;">
          <div style="font-size: 3rem; margin-bottom: 20px;">üöÄ</div>
          <h2 style="color: #0d122b; margin-bottom: 20px; font-size: 2rem;">Welcome to the Workshop!</h2>
          <p style="color: #666; margin-bottom: 25px; line-height: 1.6; font-size: 1.05rem;">
            This workshop guides you through building AI-powered voice agents. You'll connect your accounts to test with real APIs.
          </p>
          <div style="background: #f8f9fa; padding: 25px; border-radius: 12px; margin-bottom: 25px; text-align: left; border-left: 4px solid #F22F46;">
            <strong style="color: #0d122b; display: block; margin-bottom: 15px; font-size: 1.1rem;">You'll connect to:</strong>
            <ul style="margin-left: 20px; color: #666; line-height: 2;">
              <li>üêô <strong>GitHub</strong> - Clone workshop code to your account</li>
              <li>üìû <strong>Twilio</strong> - Make real phone calls and test voice APIs</li>
              <li>ü§ñ <strong>OpenAI</strong> - Power your AI voice assistant with GPT</li>
            </ul>
          </div>
          <div style="background: #e8f5e9; padding: 20px; border-radius: 12px; margin-bottom: 25px; border-left: 4px solid #4caf50;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
              <span style="font-size: 1.5rem;">üîí</span>
              <strong style="color: #2e7d32; font-size: 1.05rem;">Your credentials are secure</strong>
            </div>
            <p style="color: #555; font-size: 0.95rem; line-height: 1.6; margin: 0; text-align: left;">
              All credentials are stored <strong>only in your browser</strong> (localStorage). We never send or store your credentials on our servers. Everything runs client-side during the workshop.
            </p>
          </div>
          <div style="margin-bottom: 25px;">
            <label for="studentEmail" style="display: block; text-align: left; color: #666; font-size: 0.95rem; margin-bottom: 8px; font-weight: 500;">
              Your Email <span style="color: #F22F46; font-weight: 600;">*</span>
            </label>
            <input
              type="email"
              id="studentEmail"
              value="${studentEmail}"
              placeholder="e.g., alex.johnson@company.com"
              required
              style="width: 100%; padding: 12px 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box; transition: border-color 0.2s;"
              onfocus="this.style.borderColor='#F22F46'"
              onblur="this.style.borderColor='#ddd'"
            />
            <p style="color: #999; font-size: 0.85rem; margin-top: 6px; text-align: left;">
              Required to track your workshop progress and provide support
            </p>
            <p id="emailError" style="color: #F22F46; font-size: 0.85rem; margin-top: 6px; text-align: left; display: none;"></p>
          </div>
          <div style="margin-bottom: 25px;">
            <label for="studentName" style="display: block; text-align: left; color: #666; font-size: 0.95rem; margin-bottom: 8px; font-weight: 500;">
              Your Name <span style="color: #F22F46; font-weight: 600;">*</span>
            </label>
            <input
              type="text"
              id="studentName"
              value="${studentName}"
              placeholder="e.g., Alex Johnson"
              required
              style="width: 100%; padding: 12px 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box; transition: border-color 0.2s;"
              onfocus="this.style.borderColor='#F22F46'"
              onblur="this.style.borderColor='#ddd'"
            />
            <p id="nameError" style="color: #F22F46; font-size: 0.85rem; margin-top: 6px; text-align: left; display: none;"></p>
          </div>
          <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
            <button onclick="saveStudentNameAndStart(false)" style="flex: 1; min-width: 220px; max-width: 280px; padding: 18px 30px; background: linear-gradient(135deg, #F22F46 0%, #ff6b6b 100%); color: white; border: none; border-radius: 8px; font-weight: 600; font-size: 1.1rem; cursor: pointer; transition: transform 0.2s;">
              Login with My Accounts
            </button>
            <button onclick="saveStudentNameAndStart(true)" style="flex: 1; min-width: 220px; max-width: 280px; padding: 18px 30px; background: white; color: #666; border: 2px solid #ddd; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1.05rem;">
              Run in Demo Mode
            </button>
          </div>
          <p style="color: #999; margin-top: 20px; font-size: 0.85rem; line-height: 1.5;">
            <strong>Demo Mode:</strong> Explore the workshop interface without connecting accounts. You won't be able to test with real APIs.
          </p>
        </div>
      `;

      document.body.appendChild(modal);
    }

    function saveStudentNameAndStart(isDemoMode) {
      const nameInput = document.getElementById('studentName');
      const emailInput = document.getElementById('studentEmail');
      const nameError = document.getElementById('nameError');
      const emailError = document.getElementById('emailError');
      const name = nameInput ? nameInput.value.trim() : '';
      const email = emailInput ? emailInput.value.trim() : '';

      // Reset error messages
      if (nameError) nameError.style.display = 'none';
      if (emailError) emailError.style.display = 'none';
      if (nameInput) nameInput.style.borderColor = '#ddd';
      if (emailInput) emailInput.style.borderColor = '#ddd';

      // Validate name (required)
      if (!name) {
        if (nameError) {
          nameError.textContent = 'Please enter your name';
          nameError.style.display = 'block';
        }
        if (nameInput) nameInput.style.borderColor = '#F22F46';
        return; // Stop execution
      }

      // Validate email (required and format)
      if (!email) {
        if (emailError) {
          emailError.textContent = 'Please enter your email address';
          emailError.style.display = 'block';
        }
        if (emailInput) emailInput.style.borderColor = '#F22F46';
        return; // Stop execution
      }

      // Validate email format
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        if (emailError) {
          emailError.textContent = 'Please enter a valid email address';
          emailError.style.display = 'block';
        }
        if (emailInput) emailInput.style.borderColor = '#F22F46';
        return; // Stop execution
      }

      // Save name and email (both are now required)
      setState("studentName", name);
      localStorage.setItem('studentName', name);

      setState("studentEmail", email);
      localStorage.setItem('studentEmail', email);

      studentDemoMode = isDemoMode;
      localStorage.setItem('studentDemoMode', isDemoMode ? 'true' : 'false');

      // Set flag to indicate we're setting up accounts (not resuming)
      // Add timestamp so we can expire old flags
      if (!isDemoMode) {
        localStorage.setItem('settingUpAccounts', JSON.stringify({
          flag: true,
          timestamp: Date.now()
        }));
      }

      // In demo mode, auto-connect all accounts with demo credentials
      if (isDemoMode) {
        setState("twilioConnected", true);
        setState("openaiConnected", true);
        githubToken = 'demo_token';
        githubUsername = 'demo_user';
        twilioCredentials = {
          accountSid: 'DEMO_ACCOUNT_SID',
          authToken: 'demo_auth_token'
        };
        openaiApiKey = 'demo_openai_key';

        // Clear any previous demo service provisions to start fresh
        localStorage.removeItem('demoMessagingProvisioned');
        localStorage.removeItem('demoSyncProvisioned');
        localStorage.removeItem('demoPurchasedNumber');
      }

      document.getElementById('setupModal').remove();
      renderStepContent();

      // Update demo mode banner visibility
      updateDemoModeBanner();

      // Update progress bar to reflect Step 1 completion in demo mode
      updateProgressBar();

      // In demo mode, check Step 1 completion to add next-action to button
      if (isDemoMode) {
        setTimeout(() => checkStep1Complete(), 100);
      }

      // Show personalized welcome message
      const welcomeMsg = studentName
        ? `üëã Welcome, ${studentName}! ${isDemoMode ? 'Running in demo mode.' : "Let's build an AI voice agent together."}`
        : `üëã Welcome! ${isDemoMode ? 'Running in demo mode - explore the workshop interface.' : "Let's build an AI voice agent together."}`;

      setTimeout(() => {
        celebrate(welcomeMsg, 'normal');
      }, 300);
    }

    function showResumeModal(progress) {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        animation: fadeIn 0.3s;
      `;

      modal.innerHTML = `
        <div style="background: white; border-radius: 16px; padding: 40px; max-width: 500px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);">
          <h2 style="color: #0d122b; margin-bottom: 20px;">üëã Welcome Back!</h2>
          <p style="color: #666; margin-bottom: 20px; line-height: 1.6;">
            We found your saved progress from ${new Date(progress.timestamp).toLocaleDateString()}.
          </p>
          <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
            <strong style="color: #0d122b; display: block; margin-bottom: 10px;">Your Progress:</strong>
            <ul style="margin-left: 20px; color: #666; line-height: 1.8;">
              <li>Current Step: <strong>${progress.currentStep + 1} of ${steps.length}</strong> - ${steps[progress.currentStep].title}</li>
              <li>Completed: ${progress.completedSteps.join(', ') || 'Just getting started'}</li>
              ${progress.selectedPhoneNumber ? `<li>Phone: ${progress.selectedPhoneNumber}</li>` : ''}
            </ul>
          </div>
          <div style="display: flex; gap: 10px;">
            <button onclick="resumeProgress()" style="flex: 1; padding: 15px; background: linear-gradient(135deg, #F22F46 0%, #ff6b6b 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem;">
              Resume ‚Üí
            </button>
            <button onclick="startFresh()" style="flex: 1; padding: 15px; background: white; color: #F22F46; border: 2px solid #F22F46; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem;">
              Start Fresh
            </button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
      window.resumeModal = modal;
      window.savedProgress = progress;
    }

    function resumeProgress() {
      const progress = window.savedProgress;

      // Restore all state
      currentStep = progress.currentStep || 0;
      twilioConnected = progress.twilioConnected || false;
      openaiConnected = progress.openaiConnected || false;
      callDirectionChosen = progress.callDirectionChosen || false;
      callDirection = progress.callDirection || '';
      useCaseDescription = progress.useCaseDescription || '';
      skipInitialGreeting = progress.skipInitialGreeting || false;  // ‚úÖ ADDED - user preference for greeting behavior
      generatedContent = progress.generatedContent || null;
      servicesReady = progress.servicesReady || false;
      basicTwimlCreated = progress.basicTwimlCreated || false;
      functionsDeployed = progress.functionsDeployed || false;
      basicCallTested = progress.basicCallTested || false;
      websocketBuilt = progress.websocketBuilt || false;
      conversationRelayCreated = progress.conversationRelayCreated || false;
      aiCallTested = progress.aiCallTested || false;
      twilioCredentials = progress.twilioCredentials || null;
      openaiApiKey = progress.openaiApiKey || null;
      selectedPhoneNumber = progress.selectedPhoneNumber || null;
      websocketUrl = progress.websocketUrl || '';
      twilioServerlessDomain = progress.twilioServerlessDomain || '';
      syncServiceSkipped = progress.syncServiceSkipped || false;
      deployedServiceSid = progress.deployedServiceSid || null;
      ttsProvider = progress.ttsProvider || 'elevenlabs';
      conversationRelayVoice = progress.conversationRelayVoice || null;
      step4Committed = progress.step4Committed || false;
      step4Deployed = progress.step4Deployed || false;
      step4CodeValidated = progress.step4CodeValidated || false;  // ‚úÖ ADDED
      step5Committed = progress.step5Committed || false;
      step5Deployed = progress.step5Deployed || false;
      step5CodeValidated = progress.step5CodeValidated || false;  // ‚úÖ ADDED
      step6Committed = progress.step6Committed || false;
      step6Deployed = progress.step6Deployed || false;
      step6CodeValidated = progress.step6CodeValidated || false;  // ‚úÖ ADDED
      step7Committed = progress.step7Committed || false;          // ‚úÖ ADDED
      step7Deployed = progress.step7Deployed || false;            // ‚úÖ ADDED
      systemPromptSaved = progress.systemPromptSaved || false;    // ‚úÖ ADDED
      promptEngineeringComplete = progress.promptEngineeringComplete || false;  // ‚úÖ ADDED - needed for progress bar
      step8Committed = progress.step8Committed || false;
      step8Deployed = progress.step8Deployed || false;            // ‚úÖ ADDED
      step8CodeValidated = progress.step8CodeValidated || false;  // ‚úÖ ADDED
      toolsConfigured = progress.toolsConfigured || false;        // ‚úÖ ADDED
      projectDeployed = progress.projectDeployed || false;        // ‚úÖ ADDED
      deployedEnvironmentSid = progress.deployedEnvironmentSid || null;
      deployedBuildSid = progress.deployedBuildSid || null;
      studentRepoName = progress.studentRepoName || null;
      codespaceUrl = progress.codespaceUrl || '';
      codespaceWebUrl = progress.codespaceWebUrl || '';
      codespaceName = progress.codespaceName || '';
      railwayToken = progress.railwayToken || null;
      railwayProjectId = progress.railwayProjectId || null;

      // Close modal
      if (window.resumeModal) {
        window.resumeModal.remove();
      }

      // Re-render
      renderProgressSteps();
      renderStepContent();

      // Re-enable buttons based on restored state
      restoreButtonStates();

      // Reveal test sections that should be visible based on deployment flags
      revealTestSections();

      celebrate('‚úÖ Progress restored! Continue where you left off.', 'light');
    }

    function revealTestSections() {
      // Show test sections only when their respective deployment flags are true
      setTimeout(() => {
        // Step 5 - Always show for now (to be fixed later)
        const step5Test = document.getElementById('step5TestSection');
        if (step5Test) step5Test.style.display = 'block';

        // Step 4 - Only show if deployed
        const step4Test = document.getElementById('step4TestSection');
        if (step4Test && step4Deployed) {
          step4Test.style.display = 'block';
        }

        // Step 6 - Only show if deployed
        const step6Test = document.getElementById('step6TestCallSection');
        if (step6Test && step6Deployed) {
          step6Test.style.display = 'block';
        }
      }, 100);
    }

    function restoreButtonStates() {
      // Clear all next-action highlights first to prevent duplicates
      document.querySelectorAll('.next-action').forEach(el => {
        el.classList.remove('next-action');
      });

      // Step 1: Enable next button if both Twilio and OpenAI are connected
      if (currentStep === 0 && twilioConnected && openaiConnected) {
        const nextBtn1 = document.getElementById('nextBtn1');
        if (nextBtn1) {
          nextBtn1.disabled = false;
          nextBtn1.classList.add('next-action');
          showStatus('step1Status', 'success', 'üéâ All accounts connected! Click Next to continue.');
        }
      }

      // Step 2: Enable next button if call direction is chosen (only add next-action if on Step 2)
      if (callDirectionChosen) {
        const nextBtn2 = document.getElementById('nextBtn2');
        if (nextBtn2) {
          nextBtn2.disabled = false;
          // Only add next-action and show status if we're currently on Step 2
          if (currentStep === 1) {
            nextBtn2.classList.add('next-action');
            const directionText = callDirection === 'outbound' ? 'outbound calls (you call them)' : 'inbound calls (they call you)';
            showStatus('step2Status', 'success', `‚úÖ Great! You'll build a bot for ${directionText}.`);
          }
        }
      }

      // Step 3: Enable next button if services are ready
      if (servicesReady) {
        const nextBtn3 = document.getElementById('nextBtn3');
        if (nextBtn3) {
          nextBtn3.disabled = false;
          // Only show status if we're currently on Step 3
          if (currentStep === 2) {
            showStatus('step3Status', 'success', '‚úÖ Services provisioned! Click Next to continue.');
          }
        }
      }

      // Step 4: Enable next button only if deployment is complete
      if (step4Deployed) {
        const nextBtn4 = document.getElementById('nextBtn4');
        if (nextBtn4) {
          nextBtn4.disabled = false;
          if (currentStep === 3) {
            nextBtn4.classList.add('next-action');
          }
        }
      }

      // Step 4: Add next-action to validate button if not yet validated and on step 4
      if (currentStep === 3 && !step4CodeValidated) {
        const validateBtn4 = document.querySelector('[onclick="validateCode4()"]');
        if (validateBtn4) validateBtn4.classList.add('next-action');
      }

      // Step 5: Enable next button only if deployment is complete
      if (step5Deployed) {
        const nextBtn5 = document.getElementById('nextBtn5');
        if (nextBtn5) {
          nextBtn5.disabled = false;
          if (currentStep === 4) {
            nextBtn5.classList.add('next-action');
          }
        }
      }

      // Step 5: Add next-action to validate button if not yet validated and on step 5
      if (currentStep === 4 && !step5CodeValidated) {
        const validateBtn5 = document.getElementById('validateBtn7');
        if (validateBtn5) validateBtn5.classList.add('next-action');
      }

      // Step 6: Enable next button only if deployment is complete
      if (step6Deployed) {
        const nextBtn6 = document.getElementById('nextBtn6');
        if (nextBtn6) {
          nextBtn6.disabled = false;
          if (currentStep === 5) {
            nextBtn6.classList.add('next-action');
          }
        }
      }

      // Step 6: Add next-action to validate button if not yet validated and on step 6
      if (currentStep === 5 && !step6CodeValidated) {
        const validateBtn6 = document.querySelector('[onclick="validateCode8()"]');
        if (validateBtn6) validateBtn6.classList.add('next-action');
      }

      // Step 7: Enable next button only if deployment is complete
      if (step7Deployed) {
        const nextBtn7 = document.getElementById('nextBtn7');
        if (nextBtn7) {
          nextBtn7.disabled = false;
          if (currentStep === 6) {
            nextBtn7.classList.add('next-action');
          }
        }
      }

      // Step 8: Enable next button only if deployment is complete
      if (step8Deployed) {
        const nextBtn8 = document.getElementById('nextBtn8');
        if (nextBtn8) {
          nextBtn8.disabled = false;
          if (currentStep === 7) {
            nextBtn8.classList.add('next-action');
          }
        }
      }

      // Step 8: Add next-action to validate button if not yet validated and on step 8
      if (currentStep === 7 && !toolsConfigured) {
        const validateBtn8 = document.querySelector('[onclick="validateCode9()"]');
        if (validateBtn8) validateBtn8.classList.add('next-action');
      }

      // Step 9: Enable next button if project is deployed  (‚úÖ ADDED)
      if (projectDeployed) {
        const nextBtn9 = document.getElementById('nextBtn9');
        if (nextBtn9) {
          nextBtn9.disabled = false;
          if (currentStep === 8) {
            nextBtn9.classList.add('next-action');
          }
        }
      }
    }

    function startFresh() {
      // Clear all progress and state
      localStorage.removeItem('workshop_progress');
      localStorage.removeItem('workshopProgress');  // Also clear alternative key
      localStorage.removeItem('studentDemoMode');
      localStorage.removeItem('studentName');
      localStorage.removeItem('demoPurchasedNumber');
      localStorage.removeItem('demoMessagingProvisioned');
      localStorage.removeItem('demoSyncProvisioned');
      localStorage.removeItem('workshopCredentials');
      localStorage.removeItem('workshop_setup_complete');  // Also clear setup flag
      localStorage.removeItem('settingUpAccounts');  // Clear account setup flag
      sessionStorage.clear();

      // Set flag to prevent resume modal from showing
      sessionStorage.setItem('startingFresh', 'true');

      // Reset all state variables to initial values
      currentStep = 0;
      studentDemoMode = false;
      setState("studentName", '');
      setState("twilioConnected", false);
      setState("openaiConnected", false);
      githubToken = null;
      githubUsername = null;
      twilioCredentials = null;
      openaiApiKey = null;
      callDirectionChosen = false;
      callDirection = '';
      servicesReady = false;
      basicTwimlCreated = false;
      functionsDeployed = false;
      basicCallTested = false;
      websocketBuilt = false;
      conversationRelayCreated = false;
      aiCallTested = false;
      selectedPhoneNumber = null;
      websocketUrl = '';
      twilioServerlessDomain = '';
      syncServiceSkipped = false;
      deployedServiceSid = null;
      ttsProvider = 'elevenlabs';
      conversationRelayVoice = null;
      step4Committed = false;
      step4Deployed = false;
      step5Committed = false;
      step5Deployed = false;
      step6Committed = false;
      step6Deployed = false;
      step8Committed = false;
      deployedEnvironmentSid = null;
      deployedBuildSid = null;
      studentRepoName = null;

      // Close the resume modal
      if (window.resumeModal) {
        window.resumeModal.remove();
      }

      // Reset to step 1
      renderProgressSteps();
      renderStepContent();
      updateProgressBar();

      // DON'T save progress after clearing - we want a completely fresh start
      // saveProgressToStorage();

      // Show the setup modal
      showSetupRequiredModal();
    }

    // =========================================================================
    // CELEBRATIONS
    // =========================================================================

    function celebrate(message, intensity = 'normal') {
      const configs = {
        light: { particleCount: 50, spread: 50 },
        normal: { particleCount: 100, spread: 70 },
        epic: { particleCount: 200, spread: 90, startVelocity: 45 }
      };

      const config = configs[intensity] || configs.normal;

      confetti({
        ...config,
        origin: { y: 0.6 },
        colors: ['#F22F46', '#ff6b6b', '#667eea', '#764ba2', '#ffc107']
      });

      // Show toast
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #F22F46 0%, #ff6b6b 100%);
        color: white;
        padding: 20px 30px;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        z-index: 9999;
        font-weight: 600;
        font-size: 1.1rem;
        animation: slideIn 0.5s ease-out;
      `;
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.animation = 'slideOut 0.5s ease-in';
        setTimeout(() => toast.remove(), 500);
      }, 3000);
    }

    function showSDKVersionNotice() {
      // Check if we've already shown this notice in this session
      if (sessionStorage.getItem('sdkNoticeShown')) {
        return;
      }

      // Show helpful banner about SDK version
      const banner = document.createElement('div');
      banner.id = 'sdkVersionBanner';
      banner.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px 30px;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        z-index: 9999;
        max-width: 600px;
        animation: slideIn 0.5s ease-out;
      `;
      banner.innerHTML = `
        <div style="display: flex; align-items: start; gap: 15px;">
          <div style="font-size: 24px;">üì¶</div>
          <div style="flex: 1;">
            <div style="font-weight: 600; font-size: 1.1rem; margin-bottom: 8px;">
              Step 6 Deployed Successfully!
            </div>
            <div style="font-size: 0.9rem; line-height: 1.5;">
              Your ConversationRelay handler is now deployed with <strong>Twilio SDK 5.6.0</strong>.<br>
              If you experience any issues testing, click the <strong>Reset</strong> button above and redeploy Step 6.
            </div>
          </div>
          <button onclick="document.getElementById('sdkVersionBanner').remove(); sessionStorage.setItem('sdkNoticeShown', 'true');"
                  style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 10px; border-radius: 6px; cursor: pointer; font-size: 18px;">
            ‚úï
          </button>
        </div>
      `;
      document.body.appendChild(banner);

      // Auto-dismiss after 10 seconds
      setTimeout(() => {
        if (document.getElementById('sdkVersionBanner')) {
          banner.style.animation = 'slideOut 0.5s ease-in';
          setTimeout(() => {
            banner.remove();
            sessionStorage.setItem('sdkNoticeShown', 'true');
          }, 500);
        }
      }, 10000);
    }

    // =========================================================================
    // TOOLTIPS
    // =========================================================================

    const tooltips = {
      'conversationrelay': {
        title: 'ConversationRelay',
        content: 'Twilio\'s WebSocket-based API for bidirectional voice streaming. It allows real-time audio exchange between calls and your application.',
        link: 'https://www.twilio.com/docs/voice/api/conversation-relay'
      },
      'sync': {
        title: 'Twilio Sync',
        content: 'Real-time data synchronization service. We use it to securely store OAuth sessions server-side with auto-expiration.',
        link: 'https://www.twilio.com/docs/sync'
      },
      'serverless': {
        title: 'Twilio Serverless',
        content: 'Zero-configuration hosting for Functions and Assets. Deploy your code without managing servers, scaling automatically.',
        link: 'https://www.twilio.com/docs/serverless'
      },
      'twiml': {
        title: 'TwiML',
        content: 'Twilio Markup Language - XML instructions that tell Twilio how to handle calls and messages. Simple, declarative voice programming.',
        link: 'https://www.twilio.com/docs/voice/twiml'
      },
      'websocket': {
        title: 'WebSockets',
        content: 'Protocol for real-time bidirectional communication over a single TCP connection. Enables instant audio streaming.',
        link: 'https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API'
      }
    };

    function createTooltip(term, text = null) {
      const data = tooltips[term.toLowerCase()];
      if (!data) return text || term;

      return `<span class="tooltip-trigger">${text || term}
        <span class="tooltip-content">
          <h4>${data.title}</h4>
          <p>${data.content}</p>
          <a href="${data.link}" target="_blank">Learn More ‚Üí</a>
        </span>
      </span>`;
    }

    // =========================================================================
    // LANGUAGE TOGGLE
    // =========================================================================

    function switchLanguage(lang) {
      currentLanguage = lang;

      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.remove('active');
      });

      const langBtn = document.getElementById(`btn-${lang}`);
      if (langBtn) {
        langBtn.classList.add('active');
      }

      localStorage.setItem('preferredLanguage', lang);
      console.log(`Language switched to: ${lang}`);
    }

    // Initialize
    async function init() {
      // Generate or restore session token (used for identifying student across workshop)
      if (!sessionToken || sessionToken === 'null' || sessionToken === 'undefined') {
        // Generate a cryptographically secure session token from server
        try {
          const response = await fetch('/api/generate-session', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              studentEmail: studentEmail || undefined,
              studentName: studentName || undefined
            })
          });

          const data = await response.json();

          if (data.success && data.sessionToken) {
            sessionToken = data.sessionToken;
            localStorage.setItem('sessionToken', sessionToken);
            console.log('üîê Generated secure session token from server:', sessionToken);
          } else {
            throw new Error('Failed to generate session token');
          }
        } catch (error) {
          console.error('Error generating session token:', error);
          // Fallback to client-side generation (not recommended but prevents app from breaking)
          sessionToken = 'ws_' + Date.now() + '_' + Math.random().toString(36).substring(2, 15);
          localStorage.setItem('sessionToken', sessionToken);
          console.warn('‚ö†Ô∏è Using fallback client-side session token (less secure)');
        }
      } else {
        console.log('Restored session token from localStorage:', sessionToken);
      }

      // Restore GitHub credentials from localStorage if they exist
      const savedGithubToken = localStorage.getItem('github_token');
      const savedGithubUsername = localStorage.getItem('github_username');
      if (savedGithubToken && savedGithubUsername) {
        githubToken = savedGithubToken;
        githubUsername = savedGithubUsername;
      }

      // Check for GitHub OAuth callback parameters
      const urlParams = new URLSearchParams(window.location.search);
      const githubTokenParam = urlParams.get('github_token');
      const githubUserParam = urlParams.get('github_user');
      const isGithubCallback = !!(githubTokenParam && githubUserParam);

      if (isGithubCallback) {
        // Decode the token
        try {
          githubToken = atob(githubTokenParam);
          githubUsername = githubUserParam;

          // Store in localStorage
          localStorage.setItem('github_token', githubToken);
          localStorage.setItem('github_username', githubUsername);

          // Load any existing progress (including studentRepoName)
          const existingProgress = loadProgressFromStorage();
          if (existingProgress && existingProgress.studentRepoName) {
            studentRepoName = existingProgress.studentRepoName;
            console.log(`Restored studentRepoName from storage: ${studentRepoName}`);
          }

          // Clean up URL
          window.history.replaceState({}, document.title, window.location.pathname);

          celebrate(`‚úÖ GitHub connected as ${githubUsername}!`, 'normal');
        } catch (e) {
          console.error('Failed to decode GitHub token:', e);
        }
      }

      // Check if coming from setup wizard
      const setupComplete = localStorage.getItem('workshop_setup_complete');
      const savedProgress = loadProgressFromStorage();
      console.log('üîé savedProgress loaded:', savedProgress);
      const hasWorkshopCredentials = localStorage.getItem('workshopCredentials');

      if (setupComplete) {
        const setupData = JSON.parse(setupComplete);

        // Auto-populate credentials from setup wizard
        if (setupData.credentials) {
          twilioCredentials = setupData.credentials;
          setState("twilioConnected", true);
          selectedPhoneNumber = setupData.phoneNumber;

          // Show success message
          const setupMessage = studentName
            ? `‚úÖ Welcome back, ${studentName}! Your credentials are loaded.`
            : '‚úÖ Setup complete! Your credentials are loaded.';
          celebrate(setupMessage, 'normal');
        }

        // Clear the setup flag (one-time use)
        localStorage.removeItem('workshop_setup_complete');
      }

      // Restore demo mode if it was previously active
      if (studentDemoMode && !twilioCredentials) {
        console.log('üé≠ Restoring demo mode from localStorage');
        twilioCredentials = {
          accountSid: 'ACdemo123456789012345678901234567890',
          authToken: 'demo_token',
          demoMode: true
        };
        twilioConnected = true;
        openaiConnected = true; // Auto-connect OpenAI in demo mode
        openaiApiKey = 'sk-demo-1234567890abcdefghijklmnopqrstuvwxyz1234567890';
        updateDemoModeBanner();
        console.log('üé≠ Demo mode restored - twilioConnected:', twilioConnected);
      }

      // Check for saved progress
      // Check if user is in the middle of setting up accounts (with expiration)
      let isSettingUpAccounts = false;
      try {
        const settingUpData = localStorage.getItem('settingUpAccounts');
        if (settingUpData) {
          const parsed = JSON.parse(settingUpData);
          const tenMinutes = 10 * 60 * 1000;
          if (parsed.flag && (Date.now() - parsed.timestamp) < tenMinutes) {
            isSettingUpAccounts = true;
          } else {
            // Expired, remove it
            localStorage.removeItem('settingUpAccounts');
          }
        }
      } catch (e) {
        // If parsing fails, remove invalid data
        localStorage.removeItem('settingUpAccounts');
      }

      if (savedProgress && !setupComplete && !isGithubCallback && !isSettingUpAccounts && sessionStorage.getItem('startingFresh') !== 'true') {
        // Only show resume modal if NOT coming from setup wizard, NOT from GitHub callback, NOT setting up accounts, AND not starting fresh
        showResumeModal(savedProgress);
      } else if (sessionStorage.getItem('startingFresh') === 'true') {
        // Clear the flag after checking
        sessionStorage.removeItem('startingFresh');
      }

      // Clear settingUpAccounts flag if coming from GitHub callback
      if (isGithubCallback) {
        localStorage.removeItem('settingUpAccounts');
      }

      // IMPORTANT: Always ensure we start at step 0 unless explicitly resuming
      // But ALWAYS load deployment flags if we have saved progress (so templates render correctly)
      if (savedProgress) {
        // Load deployment flags so templates render correctly even before resume modal
        step4Deployed = savedProgress.step4Deployed || false;
        step5Deployed = savedProgress.step5Deployed || false;
        step6Deployed = savedProgress.step6Deployed || false;
        console.log('üì¶ Pre-loaded deployment flags for rendering: step4Deployed=' + step4Deployed + ', step5Deployed=' + step5Deployed + ', step6Deployed=' + step6Deployed);
      }

      // Determine starting step
      if (!savedProgress || setupComplete || sessionStorage.getItem('startingFresh') === 'true') {
        // Start fresh at step 0
        currentStep = 0;
      } else if (savedProgress) {
        // Resume from saved step (even if coming from GitHub callback or setting up accounts)
        currentStep = savedProgress.currentStep || 0;
        console.log('üì¶ Resuming from step: ' + currentStep);
      }

      // Always render content first
      renderProgressSteps();
      renderStepContent();

      // Restore button states based on current progress
      // This is needed whether coming from setup wizard or not
      setTimeout(() => restoreButtonStates(), 100);

      // Apply language preference
      switchLanguage(currentLanguage);

      // Update demo mode banner if in demo mode
      updateDemoModeBanner();

      // Show setup modal AFTER rendering content (so page isn't blank)
      // If user hasn't completed setup and has no saved progress, show setup modal
      // BUT don't show if they're in the middle of setting up accounts or just returned from GitHub
      if (!setupComplete && !savedProgress && !hasWorkshopCredentials && !isSettingUpAccounts && !isGithubCallback) {
        setTimeout(() => showSetupRequiredModal(), 100);
      }

      // Check Step 1 completion status and add next-action if both accounts connected
      if (currentStep === 0) {
        setTimeout(() => checkStep1Complete(), 200);
      }

      // Check for existing Codespace if we have GitHub credentials and a repo
      if (githubToken && githubUsername && studentRepoName && !codespaceUrl) {
        console.log('üîç Checking for existing Codespace...');
        checkForExistingCodespace();
      }
    }

    // Render progress indicator
    function renderProgressSteps() {
      const container = document.getElementById('progressSteps');
      container.innerHTML = steps.map((step, index) => `
        <div class="step-item ${index === currentStep ? 'active' : ''} ${index < currentStep ? 'completed' : ''}"
             onclick="navigateToStep(${index})"
             style="cursor: pointer;"
             title="Click to go to ${step.title}">
          <div class="step-number">${index < currentStep ? '' : step.id}</div>
          <div class="step-title">${step.title}</div>
        </div>
      `).join('');
    }

    // Render step content
    function renderStepContent() {
      const container = document.getElementById('mainContent');

      switch(currentStep) {
        case 0:
          container.innerHTML = renderStep_Setup();
          break;
        case 1:
          container.innerHTML = renderStep_Direction();
          break;
        case 2:
          container.innerHTML = renderStep_Services();
          loadServices();
          break;
        case 3:
          container.innerHTML = renderStep_BasicTwiML();
          break;
        case 4:
          container.innerHTML = renderStep_WebSocket();
          // Auto-connect to WebSocket test when entering Step 5
          setTimeout(() => {
            if ((codespaceUrl || websocketUrl) && !isConnected) {
              connectWebSocketTest();
            }
          }, 500);
          break;
        case 5:
          container.innerHTML = renderStep_ConversationRelay();
          // Initialize dropdowns after rendering
          setTimeout(() => {
            const ttsSelect = document.getElementById('ttsProvider');
            const voiceSelect = document.getElementById('conversationRelayVoice');
            if (ttsSelect) ttsSelect.value = ttsProvider;
            if (voiceSelect && conversationRelayVoice) voiceSelect.value = conversationRelayVoice;

            // Update TTS provider display to match default selection
            if (typeof saveTTSProvider === 'function') {
              saveTTSProvider();
            }

            // Auto-update code with preset settings
            updateConversationRelayCode();
          }, 0);
          break;
        case 6:
          // Generate enhanced prompt based on use case if not already generated
          if (!generatedContent && useCaseDescription && useCaseDescription.trim()) {
            const enhancedPrompt = generateEnhancedPrompt();
            if (enhancedPrompt) {
              generatedContent = {
                systemPrompt: enhancedPrompt
              };
            }
          }
          container.innerHTML = renderStep_PromptEngineering();
          break;
        case 7:
          container.innerHTML = renderStep_Tooling();
          break;
        case 8:
          container.innerHTML = renderStep_Deploy();
          break;
      }

      // After rendering, explicitly reveal test sections that should be visible
      console.log('üìç renderStepContent() finished, about to call revealTestSections()');
      revealTestSections();
      console.log('üìç revealTestSections() call completed');

      // Check Codespaces usage on Step 1 (Setup) if GitHub is connected
      if (currentStep === 0 && githubToken && githubUsername) {
        setTimeout(() => checkCodespacesUsage(), 500);
      }

      // Highlight the next action the student should take
      highlightNextAction();

      // NEW: Check all conditions and update next-action (centralized state management)
      setTimeout(() => checkAllConditions(), 100);
    }

    /**
     * Clears all highlight effects immediately
     * Called when user takes an action
     */
    function clearHighlights() {
      document.querySelectorAll('.next-action').forEach(el => {
        el.classList.remove('next-action');
      });
    }

    /**
     * Highlights the next button/action the student should click
     * Adds pulsing animation to guide their workflow
     */
    function highlightNextAction() {
      // Remove all existing next-action highlights
      clearHighlights();

      // Determine which button to highlight based on current state
      let nextButton = null;

      if (currentStep === 0) {
        // Step 1: Setup
        if (!githubToken) {
          // Need to login with GitHub
          nextButton = document.querySelector('[onclick*="initiateGitHubOAuth"]');
        } else if (!studentRepoName) {
          // Need to clone repository - but only if not currently processing
          const cloneBtn = document.querySelector('[onclick*="cloneWorkshopRepo"]');
          if (cloneBtn && !cloneBtn.disabled) {
            nextButton = cloneBtn;
          }
        } else if (!twilioConnected) {
          // Need to connect Twilio - highlight Account SID input field first
          nextButton = document.getElementById('accountSidGroup');
        } else if (!openaiConnected) {
          // Twilio connected, now need OpenAI - highlight OpenAI key input field
          nextButton = document.getElementById('openaiKeyGroup');
        } else if (twilioConnected && openaiConnected) {
          // Both connected - highlight Next button
          nextButton = document.getElementById('nextBtn1');
        }
      } else if (currentStep === 1) {
        // Step 2: Use Case - check if both use case and direction are provided
        if (useCaseDescription && useCaseDescription.trim() && callDirectionChosen) {
          // Both requirements met - highlight Next button
          nextButton = document.getElementById('nextBtn2');
        } else if (!useCaseDescription || !useCaseDescription.trim()) {
          // Need use case description - highlight the textarea
          nextButton = document.getElementById('useCaseDescription');
        } else if (!callDirectionChosen) {
          // Have description, need direction - highlight outbound card
          nextButton = document.getElementById('outboundCard');
        }
      } else if (currentStep === 2) {
        // Step 3: Services - guide through phone ‚Üí messaging ‚Üí sync/skip ‚Üí next
        if (!selectedPhoneNumberSid) {
          // No phone selected - highlight phone options
          const selectBtn = document.querySelector('.phone-option');
          if (selectBtn) selectBtn.classList.add('next-action');
        } else if (selectedPhoneNumberSid && !servicesReady) {
          // Phone selected but services not ready
          // Check what's missing and highlight accordingly
          const hasMessaging = twilioCredentials?.services?.messagingService;
          const hasSyncOrSkipped = twilioCredentials?.services?.syncService || syncServiceSkipped;

          if (!hasMessaging) {
            // Messaging service needed - highlight Create Service button
            nextButton = document.getElementById('createMessagingBtn');
          } else if (!hasSyncOrSkipped) {
            // Messaging done, now need Sync or Skip
            const createSyncBtn = document.querySelector('[onclick*="provisionSync"]');
            const skipSyncBtn = document.querySelector('[onclick*="skipSync"]');
            // Highlight Skip button as it's the recommended action
            nextButton = skipSyncBtn || createSyncBtn;
          }
        } else {
          // All services ready - highlight Next button
          nextButton = document.getElementById('nextBtn3');
        }
      } else if (currentStep === 4) {
        // Step 5: WebSocket Handler - uses validateCode7, deployCodespaceBtn5, nextBtn7
        const validateBtn = document.querySelector('[onclick="validateCode7()"]');
        const deployBtn = document.getElementById('deployCodespaceBtn5');
        const nextBtn = document.getElementById('nextBtn7');

        if (nextBtn && !nextBtn.disabled) {
          // Already deployed - highlight next button
          nextButton = nextBtn;
        } else if (step5CodeValidated && deployBtn && !deployBtn.disabled) {
          // Code validated, ready to deploy - highlight deploy button
          nextButton = deployBtn;
        } else if (validateBtn && !validateBtn.disabled) {
          // Need to validate first - highlight validate button
          nextButton = validateBtn;
        }
      } else if (currentStep === 5) {
        // Step 6: ConversationRelay - uses validateCode8, commitStep6Btn, nextBtn8
        const validateBtn = document.querySelector('[onclick="validateCode8()"]');
        const deployBtn = document.getElementById('commitStep6Btn');
        const nextBtn = document.getElementById('nextBtn8');

        if (nextBtn && !nextBtn.disabled) {
          // Already deployed - highlight next button
          nextButton = nextBtn;
        } else if (deployBtn && !deployBtn.disabled) {
          // Code validated, ready to deploy - highlight deploy button
          nextButton = deployBtn;
        } else if (validateBtn && !validateBtn.disabled) {
          // Need to validate first - highlight validate button
          nextButton = validateBtn;
        }
      } else if (currentStep === 3 || currentStep === 6 || currentStep === 7) {
        // Code editing steps (4, 7, 8) - highlight based on validation state
        // Note: Steps 5 and 6 (currentStep 4 and 5) have special handling above
        const stepNum = currentStep + 1;
        const testBtn = document.querySelector(`[onclick*="testCode${stepNum}"]`);
        const nextBtn = document.getElementById(`nextBtn${stepNum}`);

        if (testBtn && testBtn.style.display !== 'none' && !nextBtn?.disabled) {
          // Code validated but not tested - highlight test button
          nextButton = testBtn;
        } else if (nextBtn && !nextBtn.disabled) {
          // Ready to proceed - highlight next button
          nextButton = nextBtn;
        } else {
          // Need to validate code first - highlight validate button
          const validateBtn = document.querySelector(`[onclick*="validateCode${stepNum}"]`);
          if (validateBtn) nextButton = validateBtn;
        }
      }

      // Apply the highlight
      if (nextButton) {
        nextButton.classList.add('next-action');
      }
    }

    // =========================================================================
    // STEP 1: SETUP - Connect Accounts
    // =========================================================================

    function renderStep_Setup() {
      const step = steps[currentStep];
      return `
        <div class="step-content active">
          <div class="step-header">
            <h2>Step ${step.id}: ${step.title}</h2>
            <p>Let's connect your Twilio and OpenAI accounts to get started</p>
          </div>

          <div class="instructions">
            <h3>üìã What You'll Need</h3>
            <ul>
              <li><strong>GitHub Account</strong> - For cloning the workshop repository and hosting your code</li>
              <li><strong>Twilio Account SID & Auth Token</strong> - Get from <a href="https://console.twilio.com" target="_blank">Twilio Console</a></li>
              <li><strong>OpenAI API Key</strong> - You'll configure this in Step 1 after connecting Twilio</li>
            </ul>
            <p style="margin-top: 15px;">
              üìö <strong>Documentation:</strong>
              <a href="https://www.twilio.com/docs/voice/api" target="_blank">Twilio Voice API</a> |
              <a href="https://www.twilio.com/docs/iam/api-keys" target="_blank">API Authentication</a>
            </p>
          </div>

          <!-- GitHub Repository Clone -->
          <div class="service-card" style="background: linear-gradient(135deg, #24292e 0%, #0d1117 100%); color: white; margin-bottom: 30px;">
            <h4 style="color: white; margin-bottom: 15px;">üêô Step 1a: Clone Workshop Repository</h4>
            <p style="color: rgba(255,255,255,0.9); margin-bottom: 15px; line-height: 1.6;">
              Before we start, you need your own copy of the workshop repository. This will contain:
            </p>
            <ul style="color: rgba(255,255,255,0.85); margin: 0 0 20px 20px; line-height: 1.8;">
              <li><strong>WebSocket Handler</strong> - Node.js server for real-time AI conversations</li>
              <li><strong>Voice Handler</strong> - TwiML responder for incoming calls</li>
              <li><strong>Package Files</strong> - Dependencies and deployment configuration</li>
              <li><strong>README</strong> - Deployment instructions for Railway/Render/Heroku</li>
            </ul>

            <div id="githubCloneStatus" style="margin-bottom: 15px;"></div>

            ${studentDemoMode ? `
              <div style="background: rgba(76, 175, 80, 0.2); padding: 20px; border-radius: 8px; border: 1px solid rgba(76, 175, 80, 0.5);">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                  <span style="font-size: 1.5rem;">‚úÖ</span>
                  <div>
                    <strong style="color: #4caf50; font-size: 1.05rem;">Repository Cloned (Demo)</strong><br>
                    <span style="color: rgba(255,255,255,0.8); font-size: 13px;">demo-user/twilio-voice-ai-workshop-demo</span>
                  </div>
                </div>
                <p style="color: rgba(255,255,255,0.85); margin: 0; font-size: 13px;">
                  üìù In demo mode, repository operations are simulated. Exit demo mode to clone to your real GitHub account.
                </p>
              </div>
            ` : githubToken && githubUsername && githubUsername !== 'demo_user' && studentRepoName ? `
              <!-- GitHub connected AND repo cloned -->
              <div style="background: rgba(76, 175, 80, 0.2); padding: 20px; border-radius: 8px; border: 1px solid rgba(76, 175, 80, 0.5);">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                  <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.5rem;">‚úÖ</span>
                    <div>
                      <strong style="color: #4caf50; font-size: 1.05rem;">Repository Ready</strong><br>
                      <span style="color: rgba(255,255,255,0.8); font-size: 13px;">${githubUsername}/${studentRepoName}</span>
                    </div>
                  </div>
                  <button class="btn btn-secondary" onclick="signOutGitHub()" style="padding: 8px 16px; font-size: 13px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white;">
                    üö™ Sign Out
                  </button>
                </div>
                <p style="color: rgba(255,255,255,0.85); margin: 0 0 12px 0; font-size: 13px;">
                  You can deploy your code to this repository throughout the workshop.
                </p>
                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                  <a href="https://github.com/${githubUsername}/${studentRepoName}" target="_blank" style="color: white; text-decoration: none; font-size: 13px; opacity: 0.9;">
                    üîó View Repository ‚Üí
                  </a>
                  <span style="color: rgba(255,255,255,0.4);">‚Ä¢</span>
                  <a href="javascript:void(0)" onclick="cloneNewRepository()" style="color: white; text-decoration: none; font-size: 13px; opacity: 0.9;">
                    üì¶ Clone New Repository
                  </a>
                  <span style="color: rgba(255,255,255,0.4);">‚Ä¢</span>
                  <a href="javascript:void(0)" onclick="deleteRepository()" style="color: #ff6b6b; text-decoration: none; font-size: 13px; opacity: 0.9;">
                    üóëÔ∏è Delete Repository
                  </a>
                </div>
              </div>
            ` : githubToken && githubUsername && githubUsername !== 'demo_user' ? `
              <!-- GitHub connected but NO repo cloned yet -->
              <div style="background: rgba(33, 150, 243, 0.2); padding: 20px; border-radius: 8px; border: 1px solid rgba(33, 150, 243, 0.5);">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                  <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.5rem;">üîê</span>
                    <div>
                      <strong style="color: #2196f3; font-size: 1.05rem;">GitHub Connected</strong><br>
                      <span style="color: rgba(255,255,255,0.8); font-size: 13px;">Logged in as ${githubUsername}</span>
                    </div>
                  </div>
                  <button class="btn btn-secondary" onclick="signOutGitHub()" style="padding: 8px 16px; font-size: 13px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white;">
                    üö™ Sign Out
                  </button>
                </div>
                <p style="color: rgba(255,255,255,0.85); margin: 0 0 15px 0; font-size: 13px;">
                  Next step: Clone the workshop repository to your GitHub account.
                </p>
                <button class="btn btn-primary next-action" id="cloneRepoBtn" onclick="cloneWorkshopRepo()" style="width: 100%; padding: 12px; font-size: 15px; background: white; color: #24292e; border: none;">
                  <strong>üì¶ Clone Workshop Repository</strong>
                </button>
              </div>
            ` : `
              <button class="btn btn-primary next-action" id="githubLoginBtn" onclick="initiateGitHubOAuth()" style="width: 100%; padding: 15px; font-size: 16px; background: white; color: #24292e; border: none;">
                <strong>üîê Login with GitHub</strong>
              </button>
              <p style="color: rgba(255,255,255,0.7); font-size: 13px; margin-top: 10px; text-align: center;">
                Required to clone the repository to your account
              </p>
            `}
          </div>

          <!-- Twilio Credentials (Shown after GitHub repo is cloned OR in demo mode) -->
          ${studentRepoName || studentDemoMode ? `
          <div class="service-card">
            <h4>üî¥ Twilio Account</h4>

            ${twilioConnected ? `
              <div style="background: #d4edda; padding: 20px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #c3e6cb;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                  <span style="font-size: 1.5rem;">‚úÖ</span>
                  <div>
                    <strong style="color: #155724; font-size: 1.05rem;">Logged into Twilio Account${studentDemoMode ? ' (Demo)' : ''}</strong><br>
                    <span style="color: #155724; font-size: 13px;">${studentDemoMode ? 'Demo Workshop Account' : (twilioCredentials?.accountName || twilioCredentials?.accountSid || 'Your Account')}</span>
                  </div>
                </div>
                ${studentDemoMode ? `
                  <p style="color: #155724; margin: 0; font-size: 13px;">
                    üìù Running in demo mode - API calls are simulated for exploration.
                  </p>
                ` : ''}
              </div>
            ` : `
              <!-- Auth Method Selection - Horizontal Button Selector -->
              <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">Authentication Method</label>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                  <button
                    id="authMethodApiKey"
                    disabled
                    class="auth-method-btn"
                    style="flex: 1; padding: 12px 20px; border: 2px solid #ddd; background: #f5f5f5; color: #999; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: not-allowed; transition: all 0.2s; opacity: 0.6;">
                    üîë API Key<br><span style="font-size: 11px; font-weight: 400;">Coming Soon</span>
                  </button>
                  <button
                    id="authMethodToken"
                    onclick="selectAuthMethod('token')"
                    class="auth-method-btn"
                    style="flex: 1; padding: 12px 20px; border: 2px solid #0066cc; background: #0066cc; color: white; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                    üîê SID + Token<br><span style="font-size: 11px; font-weight: 400;">Recommended</span>
                  </button>
                </div>
              </div>
            `}

            ${!twilioConnected ? `
              <!-- Why API Keys info box - Hidden for now (API key auth under development) -->
              <div id="whyApiKeys" style="display: none; background: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #ffc107;">
                <strong>üí° Why API Keys?</strong>
                <ul style="margin: 10px 0 0 20px; font-size: 14px;">
                  <li>Can be deleted after the workshop</li>
                  <li>More secure than Auth Tokens</li>
                  <li>Your credentials are only used to create a session</li>
                  <li>Takes 30 seconds to set up</li>
                </ul>
              </div>

            <!-- Token Auth -->
            <div id="tokenAuth">
              <div class="form-group" id="accountSidGroup">
                <label>Account SID</label>
                <input type="text" id="twilioAccountSid" placeholder="ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" oninput="handleAccountSidInput()" />
              </div>
              <div class="form-group" id="authTokenGroup">
                <label>Auth Token</label>
                <input type="password" id="twilioAuthToken" placeholder="********************************" oninput="handleAuthTokenInput()" />
              </div>
              <button class="btn btn-primary" id="connectTwilioBtn" onclick="connectTwilio()">Connect Twilio</button>
            </div>

            <!-- API Key Auth (DISABLED - Coming Soon) -->
            <div id="apiKeyAuth" style="display: none;">
              <div style="background: #e7f5ff; padding: 20px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #0066cc;">
                <h5 style="margin: 0 0 10px 0; color: #0066cc;">üìù Quick Setup (30 seconds)</h5>
                <ol style="margin: 0; padding-left: 20px; color: #555; font-size: 14px; line-height: 1.8;">
                  <li>Go to <a href="https://console.twilio.com/us1/account/keys-credentials/api-keys?frameUrl=%2Fconsole%2Fproject%2Fapi-keys%3Fx-target-region%3Dus1" target="_blank" style="color: #0066cc; text-decoration: none; font-weight: bold;">API Keys page</a> and click "Create API Key"</li>
                  <li>Enter friendly name: <strong>"Voice AI Workshop"</strong></li>
                  <li>Copy the <strong>SID</strong> and <strong>Secret</strong> and paste below ‚¨áÔ∏è</li>
                </ol>
                <p style="margin: 10px 0 0 0; color: #666; font-size: 13px;">
                  üí° <strong>Tip:</strong> Delete this API Key after the workshop at <a href="https://console.twilio.com/us1/account/keys-credentials/api-keys" target="_blank">console.twilio.com/keys</a>
                </p>
              </div>

              <div class="form-group">
                <label>Account SID</label>
                <input type="text" id="twilioAccountSidKey" placeholder="ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" />
                <small style="display: block; margin-top: 5px; color: #666;">
                  Find at: <a href="https://console.twilio.com" target="_blank">console.twilio.com</a> (top of page)
                </small>
              </div>
              <div class="form-group">
                <label>API Key SID</label>
                <input type="text" id="twilioApiKeySid" placeholder="SKxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" />
                <small style="display: block; margin-top: 5px; color: #666;">
                  From step 2 above (starts with "SK")
                </small>
              </div>
              <div class="form-group">
                <label>API Key Secret</label>
                <input type="password" id="twilioApiKeySecret" placeholder="********************************" />
                <small style="display: block; margin-top: 5px; color: #666;">
                  ‚ö†Ô∏è Only shown once after creation - copy it now!
                </small>
              </div>
              <button class="btn btn-primary" onclick="connectTwilioWithApiKey()" style="width: 100%; padding: 12px; font-size: 16px;">
                üîê Connect Securely
              </button>
              <div style="background: #d4edda; padding: 10px; border-radius: 4px; margin-top: 10px; font-size: 13px; color: #155724;">
                üîí <strong>Your credentials are secure:</strong> They're only used once to create a session token, never stored
              </div>
            </div>

            <!-- Demo Mode -->
            <div id="demoAuth" style="display: none;">
              <div style="background: #fff3cd; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                <strong>üìù Demo Mode</strong>
                <p style="margin: 10px 0 0 0; font-size: 13px;">
                  Explore the workshop with simulated data. You won't be able to make real calls,
                  but you can see how everything works and export your code.
                </p>
              </div>
              <button class="btn btn-primary" onclick="connectDemoMode()">Start Demo Mode</button>
            </div>

            <div id="twilioStatus" class="connection-status" style="display: none; margin-top: 10px;"></div>
            ` : ''}
          </div>
          ` : ''}

          <!-- OpenAI API Key Configuration -->
          ${twilioConnected ? `
          <div class="service-card" style="margin-top: 30px;">
            <h3 style="color: #0d122b; margin-bottom: 15px;">ü§ñ OpenAI API Key</h3>
            <p style="font-size: 13px; color: #666; margin-bottom: 15px;">
              Connect your OpenAI API key to power the AI voice assistant. This will be used in Step 5 when you build the WebSocket handler.
            </p>

            ${openaiConnected ? `
              <div style="background: #d4edda; padding: 20px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #c3e6cb;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                  <span style="font-size: 1.5rem;">‚úÖ</span>
                  <div>
                    <strong style="color: #155724; font-size: 1.05rem;">OpenAI API Key Connected${studentDemoMode ? ' (Demo)' : ''}</strong><br>
                    <span style="color: #155724; font-size: 13px;">${studentDemoMode ? 'sk-demo-****...****' : (openaiApiKey ? 'sk-****...****' : 'Connected')}</span>
                  </div>
                </div>
                ${studentDemoMode ? `
                  <p style="color: #155724; margin: 0 0 10px 0; font-size: 13px;">
                    üìù Using demo API key - AI responses are simulated.
                  </p>
                ` : ''}
                <button class="btn" style="padding: 8px 16px; font-size: 13px; background: white; color: #666; border: 1px solid #ddd;" onclick="setState("openaiConnected", false); openaiApiKey = null; renderStepContent();">
                  üîÑ Change API Key
                </button>
              </div>
            ` : `
              <div class="form-group next-action" id="openaiKeyGroup">
                <label>OpenAI API Key</label>
                <input type="password" id="openaiKey" placeholder="sk-proj-********************************" value="${openaiApiKey || ''}" oninput="handleOpenAIKeyInput()" />
                <p style="font-size: 12px; color: #666; margin-top: 5px;">
                  Get your API key from <a href="https://platform.openai.com/api-keys" target="_blank">OpenAI Platform</a>
                </p>
              </div>
              <button class="btn btn-primary" id="connectOpenAIBtn" onclick="connectOpenAI()">Connect OpenAI</button>
              <div id="openaiStatusStep1" class="connection-status" style="display: none; margin-top: 10px;"></div>
            `}
          </div>
          ` : ''}

          <div id="step1Status" class="status-box"></div>

          <div class="button-group">
            <button class="btn btn-primary ${twilioConnected && openaiConnected ? 'next-action' : ''}" id="nextBtn1" onclick="nextStep()" ${twilioConnected && openaiConnected ? '' : 'disabled'}>
              Next: Choose Use Case ‚Üí
            </button>
          </div>
        </div>
      `;
    }

    function selectAuthMethod(method) {
      // API Key is disabled - ignore if user somehow clicks it
      if (method === 'apikey') {
        return;
      }

      // Update button styles
      const tokenBtn = document.getElementById('authMethodToken');

      if (method === 'token') {
        tokenBtn.style.background = '#0066cc';
        tokenBtn.style.color = 'white';
        tokenBtn.style.borderColor = '#0066cc';
      }

      // Hide "Why API Keys?" info box (API Key auth is disabled)
      const whyApiKeys = document.getElementById('whyApiKeys');
      if (whyApiKeys) {
        whyApiKeys.style.display = 'none';
      }

      // Show/hide auth sections
      document.getElementById('selfhostedAuth').style.display = method === 'selfhosted' ? 'block' : 'none';
      document.getElementById('tokenAuth').style.display = method === 'token' ? 'block' : 'none';
      document.getElementById('apiKeyAuth').style.display = 'none'; // API Key auth disabled
      document.getElementById('demoAuth').style.display = method === 'demo' ? 'block' : 'none';
    }

    // =========================================================================
    // STEP 1 SUB-STEP HANDLERS - Progressive next-action flow
    // =========================================================================

    function handleAccountSidInput() {
      const accountSid = document.getElementById('twilioAccountSid')?.value?.trim();
      const accountSidGroup = document.getElementById('accountSidGroup');
      const authTokenGroup = document.getElementById('authTokenGroup');

      // If Account SID is valid (starts with AC and is 34 chars)
      if (accountSid && accountSid.startsWith('AC') && accountSid.length === 34) {
        // Move next-action from SID to Auth Token
        if (accountSidGroup) accountSidGroup.classList.remove('next-action');
        if (authTokenGroup) authTokenGroup.classList.add('next-action');
      } else {
        // Keep next-action on SID if invalid
        if (accountSidGroup) accountSidGroup.classList.add('next-action');
        if (authTokenGroup) authTokenGroup.classList.remove('next-action');
      }
    }

    function handleAuthTokenInput() {
      const accountSid = document.getElementById('twilioAccountSid')?.value?.trim();
      const authToken = document.getElementById('twilioAuthToken')?.value?.trim();
      const authTokenGroup = document.getElementById('authTokenGroup');
      const connectBtn = document.getElementById('connectTwilioBtn');

      // If both SID and Token are filled
      if (accountSid && accountSid.startsWith('AC') && accountSid.length === 34 && authToken && authToken.length > 10) {
        // Move next-action from Auth Token to Connect button
        if (authTokenGroup) authTokenGroup.classList.remove('next-action');
        if (connectBtn) connectBtn.classList.add('next-action');
      } else {
        // Keep next-action on Auth Token
        if (authTokenGroup) authTokenGroup.classList.add('next-action');
        if (connectBtn) connectBtn.classList.remove('next-action');
      }
    }

    function handleOpenAIKeyInput() {
      const openaiKey = document.getElementById('openaiKey')?.value?.trim();
      const openaiKeyGroup = document.getElementById('openaiKeyGroup');
      const connectBtn = document.getElementById('connectOpenAIBtn');

      // If key is filled (starts with sk- and reasonable length)
      if (openaiKey && (openaiKey.startsWith('sk-') || openaiKey.startsWith('demo')) && openaiKey.length > 10) {
        // Move next-action from input to Connect button
        if (openaiKeyGroup) openaiKeyGroup.classList.remove('next-action');
        if (connectBtn) connectBtn.classList.add('next-action');
      } else {
        // Keep next-action on input
        if (openaiKeyGroup) openaiKeyGroup.classList.add('next-action');
        if (connectBtn) connectBtn.classList.remove('next-action');
      }
    }

    // Self-Hosted Authentication (No credentials needed!)
    async function connectTwilio() {
      clearHighlights(); // Remove highlight immediately when clicked
      const accountSid = document.getElementById('twilioAccountSid').value.trim();
      const authToken = document.getElementById('twilioAuthToken').value.trim();
      const status = document.getElementById('twilioStatus');

      if (!accountSid || !authToken) {
        showStatus('step1Status', 'error', 'Please enter both Account SID and Auth Token');
        return;
      }

      if (!accountSid.startsWith('AC')) {
        showStatus('step1Status', 'error', 'Account SID must start with "AC"');
        return;
      }

      status.innerHTML = 'Connecting...';
      status.style.display = 'inline-flex';

      try {
        const response = await fetch('/api/tutorial-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'validateCredentials',
            accountSid,
            authToken
          })
        });

        const data = await response.json();

        if (data.success) {
          twilioCredentials = { accountSid, authToken };
          setState("twilioConnected", true);

          status.innerHTML = `<span class="live-indicator"></span> Connected: ${data.account.friendlyName}`;
          status.style.background = '#d4edda';
          status.style.color = '#155724';

          showStatus('step1Status', 'success', '‚úÖ Twilio account connected successfully!');

          // Re-render to show OpenAI section
          renderStepContent();
          await checkStep1Complete();
        } else {
          throw new Error(data.error);
        }
      } catch (error) {
        status.innerHTML = '‚ùå Connection failed';
        status.style.background = '#f8d7da';
        status.style.color = '#721c24';

        let errorMsg = error.message;
        if (errorMsg.includes('authenticate')) {
          errorMsg += '<br><br>üí° <strong>Try these solutions:</strong><br>' +
                      '‚Ä¢ Double-check your Account SID and Auth Token<br>' +
                      '‚Ä¢ Copy credentials directly from <a href="https://console.twilio.com" target="_blank">Twilio Console</a><br>' +
                      '‚Ä¢ Try using API Key instead (select from dropdown)<br>' +
                      '‚Ä¢ Use Demo Mode to explore without credentials';
        }

        showStatus('step1Status', 'error', 'Failed to connect: ' + errorMsg);
      }
    }

    async function connectTwilioWithApiKey() {
      clearHighlights(); // Remove highlight immediately when clicked
      const accountSid = document.getElementById('twilioAccountSidKey').value.trim();
      const apiKeySid = document.getElementById('twilioApiKeySid').value.trim();
      const apiKeySecret = document.getElementById('twilioApiKeySecret').value.trim();
      const status = document.getElementById('twilioStatus');

      if (!accountSid || !apiKeySid || !apiKeySecret) {
        showStatus('step1Status', 'error', 'Please enter Account SID, API Key SID, and API Key Secret');
        return;
      }

      if (!accountSid.startsWith('AC')) {
        showStatus('step1Status', 'error', 'Account SID must start with "AC"');
        return;
      }

      if (!apiKeySid.startsWith('SK')) {
        showStatus('step1Status', 'error', 'API Key SID must start with "SK"');
        return;
      }

      status.innerHTML = 'Connecting with API Key...';
      status.style.display = 'inline-flex';

      try {
        const response = await fetch('/api/tutorial-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'validateCredentials',
            accountSid,
            authToken: apiKeySecret,  // API Key Secret used as auth token
            apiKey: apiKeySid
          })
        });

        const data = await response.json();

        if (data.success) {
          twilioCredentials = { accountSid, authToken: apiKeySecret, apiKey: apiKeySid };
          setState("twilioConnected", true);

          status.innerHTML = `<span class="live-indicator"></span> Connected with API Key: ${data.account.friendlyName}`;
          status.style.background = '#d4edda';
          status.style.color = '#155724';

          showStatus('step1Status', 'success', '‚úÖ Twilio account connected with API Key (more secure)!');

          // Re-render to show OpenAI section
          renderStepContent();
          await checkStep1Complete();
        } else {
          throw new Error(data.error);
        }
      } catch (error) {
        status.innerHTML = '‚ùå Connection failed';
        status.style.background = '#f8d7da';
        status.style.color = '#721c24';
        showStatus('step1Status', 'error', 'Failed to connect: ' + error.message + '<br><br>Make sure your API Key is active and has the correct permissions.');
      }
    }

    function connectDemoMode() {
      clearHighlights(); // Remove highlight immediately when clicked
      const status = document.getElementById('twilioStatus');

      status.innerHTML = '<span class="live-indicator"></span> Demo Mode Active';
      status.style.background = '#fff3cd';
      status.style.color = '#856404';
      status.style.display = 'inline-flex';

      // Set demo credentials
      twilioCredentials = {
        accountSid: 'ACdemo123456789012345678901234567890',
        authToken: 'demo_token',
        demoMode: true
      };
      setState("twilioConnected", true);

      // Show demo mode banner
      updateDemoModeBanner();

      showStatus('step1Status', 'success', '‚úÖ Demo Mode activated! You can explore the workshop with simulated data.');

      // Re-render to show OpenAI section
      renderStepContent();
      checkStep1Complete();
    }

    async function connectOpenAI() {
      clearHighlights(); // Remove highlight immediately when clicked
      const apiKeyInput = document.getElementById('openaiKey');
      let apiKey = apiKeyInput.value.trim();
      // Support both Step 1 and Step 5
      const status = document.getElementById('openaiStatusStep1') || document.getElementById('openaiStatus');

      // Check if in demo mode - auto-set demo API key
      if (twilioCredentials?.demoMode) {
        apiKey = 'sk-demo-1234567890abcdefghijklmnopqrstuvwxyz1234567890';
        apiKeyInput.value = apiKey;

        status.innerHTML = '<span class="live-indicator"></span> Demo Mode Active';
        status.style.display = 'inline-flex';
        status.style.background = '#fff3cd';
        status.style.color = '#856404';

        openaiApiKey = apiKey;
        setState("openaiConnected", true);

        showStatus('step1Status', 'success', '‚úÖ OpenAI Demo Mode activated! API calls will be simulated.');
        saveProgressToStorage();
        return;
      }

      if (!apiKey) {
        showStatus('step1Status', 'error', 'Please enter your OpenAI API key');
        return;
      }

      // Simple format validation - check if it starts with 'sk-' or 'sk-proj-'
      if (!apiKey.startsWith('sk-')) {
        showStatus('step1Status', 'error', 'Invalid OpenAI API key format. Key should start with "sk-"');
        status.innerHTML = `‚ùå Invalid format`;
        status.style.display = 'inline-flex';
        status.style.background = '#f8d7da';
        status.style.color = '#721c24';
        return;
      }

      // Check minimum length (OpenAI keys are typically 48+ characters)
      if (apiKey.length < 40) {
        showStatus('step1Status', 'error', 'OpenAI API key appears too short. Please check your key.');
        status.innerHTML = `‚ùå Key too short`;
        status.style.display = 'inline-flex';
        status.style.background = '#f8d7da';
        status.style.color = '#721c24';
        return;
      }

      // Test the API key with actual OpenAI API call
      status.innerHTML = 'Testing API key...';
      status.style.display = 'inline-flex';
      status.style.background = '#d1ecf1';
      status.style.color = '#0c5460';

      try {
        // Make a minimal API call to validate the key
        const response = await fetch('https://api.openai.com/v1/models', {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${apiKey}`
          }
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({ error: { message: 'Unknown error' } }));
          const errorMessage = errorData.error?.message || 'Invalid API key';

          logApiCall('/v1/models', 'GET', response.status, { error: errorMessage });
          logError('openai_validation_failed', errorMessage, { statusCode: response.status });

          showStatus('step1Status', 'error', `‚ùå API key validation failed: ${errorMessage}`);
          status.innerHTML = `‚ùå Invalid key`;
          status.style.display = 'inline-flex';
          status.style.background = '#f8d7da';
          status.style.color = '#721c24';
          return;
        }

        // API key is valid
        logApiCall('/v1/models', 'GET', 200, { success: true });
        logAction('openai_connected', { validated: true });

        openaiApiKey = apiKey;
        setState("openaiConnected", true);

        status.innerHTML = '<span class="live-indicator"></span> Connected';
        status.style.background = '#d4edda';
        status.style.color = '#155724';

        showStatus('step1Status', 'success', '‚úÖ OpenAI API key validated successfully!');
      } catch (error) {
        console.error('OpenAI validation error:', error);
        logError('openai_validation_exception', error.message, { stack: error.stack });
        showStatus('step1Status', 'error', `‚ùå Failed to validate API key: ${error.message}`);
        status.innerHTML = `‚ùå Validation failed`;
        status.style.display = 'inline-flex';
        status.style.background = '#f8d7da';
        status.style.color = '#721c24';
        return;
      }

      // Hide prerequisites warning if shown
      const prereqDiv = document.getElementById('step5Prerequisites');
      if (prereqDiv) prereqDiv.style.display = 'none';

      checkStep1Complete();
      saveProgressToStorage();

      // Re-render to show updated UI (important for Step 1)
      renderStepContent();
    }

    function saveTTSProvider() {
      const provider = document.getElementById('ttsProvider').value;
      ttsProvider = provider;

      // Update provider info display
      const icon = document.getElementById('ttsProviderIcon');
      const name = document.getElementById('ttsProviderName');
      const description = document.getElementById('ttsProviderDescription');
      const note = document.getElementById('ttsProviderNote');

      if (provider === 'amazon-polly') {
        icon.textContent = 'üîä';
        name.textContent = 'Amazon Polly';
        description.textContent = 'Included with Twilio at no additional cost. Provides high-quality, natural-sounding voices in multiple languages.';
        note.innerHTML = '‚úÖ No additional configuration needed';
        note.style.color = '#98c379';
      } else if (provider === 'elevenlabs') {
        icon.textContent = 'üéµ';
        name.textContent = 'ElevenLabs';
        description.textContent = 'Premium AI voices with exceptional naturalness, emotion, and clarity. Perfect for professional applications requiring the highest quality speech synthesis.';
        note.innerHTML = '‚úÖ No API key needed - Twilio manages the integration';
        note.style.color = '#98c379';
      } else if (provider === 'google') {
        icon.textContent = '‚òÅÔ∏è';
        name.textContent = 'Google Cloud Text-to-Speech';
        description.textContent = 'Google\'s neural TTS with WaveNet voices. Requires Google Cloud credentials configured in Twilio Console.';
        note.innerHTML = '‚ö†Ô∏è Requires additional setup in Twilio Console - <a href="https://www.twilio.com/docs/voice/twiml/connect/conversationrelay#google-cloud-text-to-speech" target="_blank" style="color: #4fc1ff;">View Docs</a>';
        note.style.color = '#e5c07b';
      }

      // Update the voice selector with new options for this provider
      const voiceSelect = document.getElementById('conversationRelayVoice');
      if (voiceSelect) {
        voiceSelect.innerHTML = getVoiceOptions();
        // Reset selected voice to default for new provider
        conversationRelayVoice = null;
      }

      // Update the code with new TTS provider
      if (typeof updateConversationRelayCode === 'function') {
        updateConversationRelayCode();
      }

      saveProgressToStorage();
    }

    function saveConversationRelayVoice() {
      const voiceSelect = document.getElementById('conversationRelayVoice');
      if (voiceSelect) {
        conversationRelayVoice = voiceSelect.value;
        saveProgressToStorage();
      }
    }

    async function checkStep1Complete() {
      if (twilioConnected && !openaiConnected) {
        // Twilio is connected but OpenAI is not - highlight OpenAI button
        setTimeout(() => {
          // Clear all existing next-action highlights first
          document.querySelectorAll('.next-action').forEach(el => {
            el.classList.remove('next-action');
          });

          const connectOpenAIBtn = document.querySelector('[onclick*="connectOpenAI"]');
          if (connectOpenAIBtn) {
            connectOpenAIBtn.classList.add('next-action');
          }
        }, 500);
        showStatus('step1Status', 'success', '‚úÖ Twilio connected! Now connect your OpenAI account below.');
      } else if (twilioConnected && openaiConnected) {
        // Both connected - create session in database and enable Next button

        // Create initial session in database (skip for demo mode)
        if (!twilioCredentials?.demoMode && !studentDemoMode) {
          try {
            console.log('üíæ Creating initial student session in database...');

            const initialSystemPrompt = `You are a helpful assistant.

# Voice Conversation Guidelines
- Keep responses BRIEF (1-2 sentences max)
- Be conversational and natural
- Avoid lists, bullet points, or structured formatting
- Don't say "as an AI" or mention you're artificial
- If you don't know something, say so briefly
- Respond quickly - every second matters in voice
- Use casual language, contractions, and natural speech patterns

# Response Style
- Short and direct
- Friendly but professional
- Natural and human-like`.trim();

            const configResponse = await fetch('/api/student-config-save', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                sessionToken: sessionToken,
                studentName: studentName || githubUsername || 'Student',
                openaiApiKey: openaiApiKey || null,
                systemPrompt: initialSystemPrompt,
                tools: [],
                voiceSettings: {}
              })
            });

            const configData = await configResponse.json();

            if (configData.success) {
              console.log('‚úÖ Initial student session created in database');
            } else {
              console.warn('‚ö†Ô∏è Failed to create initial session:', configData.error);
            }
          } catch (error) {
            console.error('‚ùå Error creating initial session:', error);
            // Don't block progress - just log the error
          }
        }

        // Clear all existing next-action highlights first
        document.querySelectorAll('.next-action').forEach(el => {
          el.classList.remove('next-action');
        });

        const nextBtn = document.getElementById('nextBtn1');
        if (nextBtn) {
          nextBtn.disabled = false;
          nextBtn.classList.add('next-action');
        }
        showStatus('step1Status', 'success', 'üéâ All accounts connected! Click Next to continue.');
      }
    }

    // =========================================================================
    // STEP 2: DIRECTION - Choose Call Direction
    // =========================================================================

    function renderStep_Direction() {
      const step = steps[currentStep];
      return `
        <div class="step-content active">
          <div class="step-header">
            <h2>Step ${step.id}: ${step.title}</h2>
            <p>Describe what you want to build and choose your call direction</p>
          </div>

          <div class="instructions">
            <h3>üìã Describe Your Use Case</h3>
            <p>Tell us what you want to build. We'll use AI to customize the workshop content for your specific needs.</p>
          </div>

          <!-- Use Case Description Input -->
          <div class="service-card" style="margin-bottom: 30px;">
            <div class="form-group">
              <label style="font-weight: 600; margin-bottom: 10px; display: block;">What do you want to build?</label>
              <textarea
                id="useCaseDescription"
                placeholder="Example: An AI receptionist that answers common questions about business hours, services, and can schedule appointments..."
                style="width: 100%; min-height: 120px; padding: 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical;"
                oninput="handleUseCaseInput()"
              >${window.useCaseDescription || ''}</textarea>
              <p style="font-size: 12px; color: #666; margin-top: 8px;">
                üí° Be specific! The more detail you provide, the better we can customize prompt suggestions and examples throughout the workshop.
              </p>
              ${generatedContent ? `
              <button
                id="regenerateContentBtn"
                onclick="regenerateUseCaseContent()"
                style="margin-top: 12px; padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; transition: transform 0.2s;"
                onmouseover="this.style.transform='scale(1.05)'"
                onmouseout="this.style.transform='scale(1)'">
                ‚ú® Regenerate AI Content
              </button>
              ` : ''}
            </div>
          </div>

          <!-- Skip Initial Greeting Option -->
          <div class="service-card" style="margin-bottom: 20px; background: #f8f9fa;">
            <label style="display: flex; align-items: start; gap: 12px; cursor: pointer; user-select: none;">
              <input
                type="checkbox"
                id="skipInitialGreeting"
                onchange="handleSkipGreetingChange()"
                ${window.skipInitialGreeting ? 'checked' : ''}
                style="width: 20px; height: 20px; cursor: pointer; margin-top: 2px; flex-shrink: 0;"
              />
              <div style="flex: 1;">
                <div style="font-weight: 600; color: #0d122b; margin-bottom: 4px;">Dynamic AI Greeting</div>
                <div style="font-size: 13px; color: #666; line-height: 1.5;">
                  <strong>For outbound calls:</strong> Moves the greeting into the system prompt so the AI can personalize it (e.g., "Hi Sarah, this is...") based on your use case.<br>
                  <strong>For inbound calls:</strong> The AI will wait for the caller to speak first instead of using a pre-recorded greeting.
                </div>
              </div>
            </label>
          </div>

          <div class="instructions">
            <h3>üìû Choose Your Call Direction</h3>
            <p>Select how you want to use your Voice AI bot. We'll start simple, then add AI capabilities!</p>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 30px 0;">
            <!-- Outbound Calls -->
            <div class="service-card" onclick="selectCallDirection('outbound')" style="cursor: pointer; border: 3px solid transparent; transition: all 0.3s;" id="outboundCard">
              <div style="text-align: center; margin-bottom: 15px;">
                <div style="font-size: 64px;">üìû</div>
                <h3 style="margin: 10px 0; color: #0d122b;">Outbound Calls</h3>
              </div>
              <p style="margin-bottom: 15px; line-height: 1.6;">
                <strong>You initiate the call</strong> - Perfect for:
              </p>
              <ul style="margin: 0 0 15px 20px; line-height: 1.8; font-size: 14px;">
                <li>Recruiting candidate outreach</li>
                <li>Customer follow-ups</li>
                <li>Survey campaigns</li>
                <li>Appointment reminders</li>
              </ul>
              <div style="background: #e7f5ff; padding: 10px; border-radius: 4px; margin-top: 15px; font-size: 13px; line-height: 1.6;">
                <strong>Phase 1:</strong> <code>&lt;Say&gt;</code>, <code>&lt;Gather&gt;</code>, <code>&lt;Dial&gt;</code><br>
                <strong>Phase 2:</strong> ConversationRelay + STT + TTS + AI
              </div>
            </div>

            <!-- Inbound Calls -->
            <div class="service-card" onclick="selectCallDirection('inbound')" style="cursor: pointer; border: 3px solid transparent; transition: all 0.3s;" id="inboundCard">
              <div style="text-align: center; margin-bottom: 15px;">
                <div style="font-size: 64px;">üì≤</div>
                <h3 style="margin: 10px 0; color: #0d122b;">Inbound Calls</h3>
              </div>
              <p style="margin-bottom: 15px; line-height: 1.6;">
                <strong>Customers call you</strong> - Perfect for:
              </p>
              <ul style="margin: 0 0 15px 20px; line-height: 1.8; font-size: 14px;">
                <li>Phone support hotline</li>
                <li>Lead qualification</li>
                <li>Order status inquiries</li>
                <li>24/7 virtual assistant</li>
              </ul>
              <div style="background: #e7f5ff; padding: 10px; border-radius: 4px; margin-top: 15px; font-size: 13px; line-height: 1.6;">
                <strong>Phase 1:</strong> <code>&lt;Say&gt;</code> + <code>&lt;Gather&gt;</code><br>
                <strong>Phase 2:</strong> ConversationRelay + STT + TTS + AI
              </div>
            </div>
          </div>

          <div id="step2Status" class="status-box"></div>

          <div class="button-group" style="gap: 20px;">
            <button class="btn btn-secondary" onclick="prevStep()">‚Üê Back</button>
            <button class="btn btn-primary" id="nextBtn2" onclick="nextStep()" disabled>
              Next: Provision Services ‚Üí
            </button>
          </div>
        </div>
      `;
    }

    function handleUseCaseInput() {
      const textarea = document.getElementById('useCaseDescription');
      if (textarea) {
        useCaseDescription = textarea.value.trim();
        saveProgressToStorage();
        console.log('üìù Use case updated:', useCaseDescription);

        // Enable next button if BOTH use case and direction are selected
        const nextBtn = document.getElementById('nextBtn2');
        if (nextBtn) {
          if (useCaseDescription && callDirectionChosen) {
            // Clear all existing next-action highlights first
            document.querySelectorAll('.next-action').forEach(el => {
              el.classList.remove('next-action');
            });

            nextBtn.disabled = false;
            nextBtn.classList.add('next-action'); // Add glow effect
            console.log('‚úÖ Next button enabled (use case + direction selected)');
          } else if (!useCaseDescription) {
            // Disable if use case is empty (even if direction was selected)
            nextBtn.disabled = true;
            nextBtn.classList.remove('next-action');
            console.log('‚ö†Ô∏è Next button disabled (use case empty)');
          }
        }
      }
    }

    function handleSkipGreetingChange() {
      const checkbox = document.getElementById('skipInitialGreeting');
      if (checkbox) {
        skipInitialGreeting = checkbox.checked;
        saveProgressToStorage();
        console.log('üëã Skip initial greeting:', skipInitialGreeting ? 'YES (AI waits for caller)' : 'NO (AI greets first)');

        // If greeting is now skipped and we already generated content, we should regenerate
        if (generatedContent && skipInitialGreeting) {
          console.log('üí° Tip: Greeting will be skipped when you generate ConversationRelay code');
        }
      }
    }

    async function regenerateUseCaseContent() {
      // Update use case description from textarea first
      handleUseCaseInput();

      // Re-generate content with the updated description
      const success = await generateUseCaseContent(true);

      // Re-render the step to show updated button state and content
      if (success) {
        renderStepContent();
      }
    }

    async function generateUseCaseContent(isRegenerate = false) {
      if (!useCaseDescription || !useCaseDescription.trim()) {
        console.log('‚ö†Ô∏è No use case description provided, skipping content generation');
        if (isRegenerate) {
          showStatus('step2Status', 'error', '‚ùå Please enter a use case description first');
        }
        return false;
      }

      if (!callDirection) {
        console.log('‚ö†Ô∏è No call direction selected, skipping content generation');
        if (isRegenerate) {
          showStatus('step2Status', 'error', '‚ùå Please select a call direction first');
        }
        return false;
      }

      // Demo mode: Simulate AI content generation
      if (studentDemoMode || !openaiApiKey || openaiApiKey === 'demo-key') {
        try {
          showStatus('step2Status', 'info', 'ü§ñ Generating custom content... (Demo Mode)');
          console.log('ü§ñ Generating custom content (Demo Mode)...');

          // Simulate AI delay
          await new Promise(resolve => setTimeout(resolve, 2000));

          // Generate demo content based on use case
          const roleDescription = callDirection === 'inbound'
            ? `helping customers who call about: ${useCaseDescription}`
            : `making calls to users for: ${useCaseDescription}`;

          generatedContent = {
            systemPrompt: `You are a helpful assistant ${roleDescription}.

# Voice Conversation Guidelines
- Keep responses BRIEF (1-2 sentences max)
- Be conversational and natural
- Avoid lists, bullet points, or structured formatting
- Don't say "as an AI" or mention you're artificial
- If you don't know something, say so briefly
- Respond quickly - every second matters in voice
- Use casual language, contractions, and natural speech patterns

# Response Style
- Short and direct
- Friendly but professional
- Natural and human-like

# Example Interactions

GOOD Response:
User: "Can you help me with this?"
You: "Of course! What would you like help with?"

BAD Response (too long):
User: "Can you help me with this?"
You: "I'd be absolutely delighted to help you with whatever you need assistance with today. I have a wide range of capabilities and knowledge at my disposal, so please feel free to ask me anything and I'll do my very best to provide you with the most comprehensive and helpful answer possible."

Remember: In voice conversations, brevity is key. Keep it natural and conversational.`,
            ivrGreeting: skipInitialGreeting ? '' : (
              callDirection === 'inbound'
                ? `Hi! Thanks for calling. I'm here to help with ${useCaseDescription}. How can I assist you?`
                : `Hello! I'm calling about ${useCaseDescription}. Do you have a moment to chat?`
            ),
            exampleQuestions: [
              `How can I help with ${useCaseDescription}?`,
              'Can you tell me more about what you need?',
              'What specific aspect would you like to know about?'
            ],
            suggestedVoice: 'friendly'
          };

          saveProgressToStorage();

          console.log('‚úÖ Generated content (Demo Mode):', generatedContent);
          showStatus('step2Status', 'success',
            `‚ú® AI customized the workshop content! (Demo Mode)<br>` +
            `<div style="margin-top: 8px; font-size: 13px;">üìù Using simulated AI generation for learning purposes.</div>`
          );

          // Show regenerate button if not already visible
          const regenerateBtn = document.getElementById('regenerateContentBtn');
          if (regenerateBtn) {
            regenerateBtn.style.display = 'inline-flex';
          }

          return true;

        } catch (error) {
          console.error('‚ùå Error in demo content generation:', error);
          showStatus('step2Status', 'warning', '‚ö†Ô∏è Demo content generation failed. Using defaults.');
          return false;
        }
      }

      // Real mode: Call OpenAI API
      if (!openaiApiKey) {
        console.log('‚ö†Ô∏è No OpenAI API key configured, skipping content generation');
        if (isRegenerate) {
          showStatus('step2Status', 'error', '‚ùå OpenAI API key required for content generation');
        }
        return false;
      }

      try {
        // Show loading state
        showStatus('step2Status', 'info', 'ü§ñ Generating custom content with AI... This may take a few seconds.');
        console.log('ü§ñ Generating custom content for use case...');
        console.log('üìä API Call Details:', {
          useCaseDescription: useCaseDescription.substring(0, 100),
          callDirection,
          hasOpenAIKey: !!openaiApiKey,
          openaiKeyPrefix: openaiApiKey?.substring(0, 7)
        });

        const response = await fetch('/api/generate-use-case-content', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            useCaseDescription,
            callDirection,
            openaiApiKey,
            skipInitialGreeting
          })
        });

        console.log('üì° API Response Status:', response.status, response.statusText);

        if (!response.ok) {
          const error = await response.json();
          console.error('‚ùå Failed to generate content:', error);
          console.error('‚ùå Full error details:', JSON.stringify(error, null, 2));

          // Fallback: Use template-based content when API fails
          const roleDescription = callDirection === 'inbound'
            ? `helping customers who call about: ${useCaseDescription}`
            : `making calls to users for: ${useCaseDescription}`;

          generatedContent = {
            systemPrompt: `You are a helpful assistant ${roleDescription}.

# Voice Conversation Guidelines
- Keep responses BRIEF (1-2 sentences max)
- Be conversational and natural
- Avoid lists, bullet points, or structured formatting
- Don't say "as an AI" or mention you're artificial
- If you don't know something, say so briefly
- Respond quickly - every second matters in voice
- Use casual language, contractions, and natural speech patterns

# Response Style
- Short and direct
- Friendly but professional
- Natural and human-like

# Example Interactions

GOOD Response:
User: "Can you help me with this?"
You: "Of course! What would you like help with?"

BAD Response (too long):
User: "Can you help me with this?"
You: "I'd be absolutely delighted to help you with whatever you need assistance with today. I have a wide range of capabilities and knowledge at my disposal, so please feel free to ask me anything and I'll do my very best to provide you with the most comprehensive and helpful answer possible."

Remember: In voice conversations, brevity is key. Keep it natural and conversational.`,
            ivrGreeting: skipInitialGreeting ? '' : (
              callDirection === 'inbound'
                ? `Hi! Thanks for calling. I'm here to help with ${useCaseDescription}. How can I assist you?`
                : `Hello! I'm calling about ${useCaseDescription}. Do you have a moment to chat?`
            ),
            exampleQuestions: [
              `How can I help with ${useCaseDescription}?`,
              'Can you tell me more about what you need?',
              'What specific aspect would you like to know about?'
            ],
            suggestedVoice: 'friendly'
          };

          saveProgressToStorage();

          // Show user-friendly error message
          showStatus('step2Status', 'warning',
            '‚ö†Ô∏è AI content generation failed. Using template-based content instead. ' +
            (error.error ? `(${error.error})` : '')
          );
          return true; // Return true since we have fallback content
        }

        const data = await response.json();
        generatedContent = data.content;
        saveProgressToStorage();

        console.log('‚úÖ Generated content successfully!');
        console.log('üìù System Prompt Preview:', generatedContent.systemPrompt?.substring(0, 200) + '...');
        console.log('üëã IVR Greeting:', generatedContent.ivrGreeting);
        console.log(`üìä Used ${data.usageTokens} tokens`);

        // Show success message with token usage
        const tokenInfo = data.usageTokens ? ` (${data.usageTokens} tokens used)` : '';
        showStatus('step2Status', 'success',
          `‚ú® AI customized the workshop content based on your use case!${tokenInfo}`
        );

        // Show regenerate button if not already visible
        const regenerateBtn = document.getElementById('regenerateContentBtn');
        if (regenerateBtn) {
          regenerateBtn.style.display = 'inline-flex';
        }

        return true;

      } catch (error) {
        console.error('‚ùå Error generating content:', error);

        // Fallback: Use template-based content when API fails
        const roleDescription = callDirection === 'inbound'
          ? `helping customers who call about: ${useCaseDescription}`
          : `making calls to users for: ${useCaseDescription}`;

        generatedContent = {
          systemPrompt: `You are a helpful assistant ${roleDescription}.

# Voice Conversation Guidelines
- Keep responses BRIEF (1-2 sentences max)
- Be conversational and natural
- Avoid lists, bullet points, or structured formatting
- Don't say "as an AI" or mention you're artificial
- If you don't know something, say so briefly
- Respond quickly - every second matters in voice
- Use casual language, contractions, and natural speech patterns

# Response Style
- Short and direct
- Friendly but professional
- Natural and human-like

# Example Interactions

GOOD Response:
User: "Can you help me with this?"
You: "Of course! What would you like help with?"

BAD Response (too long):
User: "Can you help me with this?"
You: "I'd be absolutely delighted to help you with whatever you need assistance with today. I have a wide range of capabilities and knowledge at my disposal, so please feel free to ask me anything and I'll do my very best to provide you with the most comprehensive and helpful answer possible."

Remember: In voice conversations, brevity is key. Keep it natural and conversational.`,
          ivrGreeting: skipInitialGreeting ? '' : (
            callDirection === 'inbound'
              ? `Hi! Thanks for calling. I'm here to help with ${useCaseDescription}. How can I assist you?`
              : `Hello! I'm calling about ${useCaseDescription}. Do you have a moment to chat?`
          ),
          exampleQuestions: [
            `How can I help with ${useCaseDescription}?`,
            'Can you tell me more about what you need?',
            'What specific aspect would you like to know about?'
          ],
          suggestedVoice: 'friendly'
        };

        saveProgressToStorage();

        // Show user-friendly error message
        showStatus('step2Status', 'warning',
          '‚ö†Ô∏è AI content generation failed. Using template-based content instead. Check your internet connection and OpenAI API key.'
        );
        return true; // Return true since we have fallback content
      }
    }

    function selectCallDirection(direction) {
      console.log('üéØ selectCallDirection called with:', direction);

      try {
        callDirection = direction;
        callDirectionChosen = true;

        // Visual feedback
        const outboundCard = document.getElementById('outboundCard');
        const inboundCard = document.getElementById('inboundCard');
        const nextBtn = document.getElementById('nextBtn2');

        if (outboundCard) {
          outboundCard.style.border = direction === 'outbound' ? '3px solid #F22F46' : '3px solid transparent';
          outboundCard.style.transform = direction === 'outbound' ? 'scale(1.02)' : 'scale(1)';
        }
        if (inboundCard) {
          inboundCard.style.border = direction === 'inbound' ? '3px solid #F22F46' : '3px solid transparent';
          inboundCard.style.transform = direction === 'inbound' ? 'scale(1.02)' : 'scale(1)';
        }

        if (nextBtn) {
          // Only enable if use case description is also provided
          if (useCaseDescription && useCaseDescription.trim()) {
            // Clear all existing next-action highlights first
            document.querySelectorAll('.next-action').forEach(el => {
              el.classList.remove('next-action');
            });

            nextBtn.disabled = false;
            nextBtn.classList.add('next-action'); // Add glow effect
            console.log('‚úÖ Next button enabled for call direction:', direction);
          }
        } else {
          console.error('‚ùå Could not find nextBtn2 element');
        }

        const directionText = direction === 'outbound' ? 'outbound calls (you call them)' : 'inbound calls (they call you)';
        showStatus('step2Status', 'success', `‚úÖ Great! You'll build a bot for ${directionText}. Customizing workshop content...`);
        updateProgressBar();

        // Save progress last so errors don't block the UI updates
        saveProgressToStorage();

        // Generate custom content based on use case (async, non-blocking)
        generateUseCaseContent();
      } catch (error) {
        console.error('‚ùå Error in selectCallDirection:', error);
        alert('Error selecting call direction: ' + error.message);
      }
    }

    // =========================================================================
    // STEP 3: SERVICES - Provision Twilio Services
    // =========================================================================

    function renderStep_Services() {
      const step = steps[currentStep];
      return `
        <div class="step-content active">
          <div class="step-header">
            <h2>Step ${step.id}: ${step.title}</h2>
            <p>Let's set up the Twilio services you need for Voice ${callDirection === 'outbound' ? 'Outbound' : 'Inbound'}</p>
          </div>

          <div class="instructions">
            <h3>üìã Required Services</h3>
            <p>We'll check your account and provision any missing services automatically.</p>
            <p style="margin-top: 15px;">
              üìö <strong>Documentation:</strong>
              <a href="https://www.twilio.com/docs/phone-numbers" target="_blank">Phone Numbers</a> |
              <a href="https://www.twilio.com/docs/messaging/services" target="_blank">Messaging Services</a> |
              <a href="https://www.twilio.com/docs/sync" target="_blank">Sync</a>
            </p>
          </div>

          <!-- CRITICAL: Enable AI/ML Features for ConversationRelay -->
          <div style="margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); border-radius: 12px; border: 3px solid #c92a2a; box-shadow: 0 4px 15px rgba(201, 42, 42, 0.3);">
            <div style="display: flex; align-items: start; gap: 15px;">
              <div style="font-size: 32px;">‚ö†Ô∏è</div>
              <div style="flex: 1;">
                <h3 style="color: white; margin: 0 0 10px 0; font-size: 1.2rem;">üî¥ REQUIRED: Enable AI/ML Features</h3>
                <p style="color: rgba(255,255,255,0.95); margin: 0 0 15px 0; line-height: 1.6;">
                  Before you can use ConversationRelay (needed for Steps 6+), you MUST enable the <strong>Predictive and Generative AI/ML Features Addendum</strong> in your Twilio Console.
                </p>
                <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                  <p style="color: white; margin: 0 0 10px 0; font-weight: 600;">üìù Quick Steps:</p>
                  <ol style="color: rgba(255,255,255,0.9); margin: 0; padding-left: 20px; line-height: 1.8;">
                    <li>Log in to your <a href="https://console.twilio.com" target="_blank" style="color: #ffd43b; text-decoration: underline;">Twilio Console</a></li>
                    <li>Navigate to <strong>Voice</strong> ‚Üí <strong>Settings</strong> ‚Üí <strong>General</strong></li>
                    <li>Find <strong>"Predictive and Generative AI/ML Features Addendum"</strong></li>
                    <li>Toggle it <strong>ON</strong></li>
                    <li>Save your changes</li>
                  </ol>
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                  <a href="https://console.twilio.com/us1/develop/voice/settings/general" target="_blank"
                     style="padding: 10px 20px; background: white; color: #c92a2a; border: none; border-radius: 6px; font-weight: 600; text-decoration: none; display: inline-block; transition: all 0.3s;">
                    üîß Open Voice Settings
                  </a>
                  <a href="https://www.twilio.com/docs/voice/twiml/connect/conversationrelay/onboarding" target="_blank"
                     style="padding: 10px 20px; background: rgba(255,255,255,0.2); color: white; border: 1px solid white; border-radius: 6px; font-weight: 600; text-decoration: none; display: inline-block; transition: all 0.3s;">
                    üìö View Documentation
                  </a>
                </div>
                <p style="color: rgba(255,255,255,0.8); margin: 15px 0 0 0; font-size: 0.9rem; font-style: italic;">
                  üí° This is a one-time setup. Once enabled, you can use ConversationRelay in all your projects.
                </p>
              </div>
            </div>
          </div>

          <div id="servicesContainer">
            <div style="text-align: center; padding: 40px;">
              <div style="font-size: 48px; margin-bottom: 20px;">‚è≥</div>
              <p>Checking your Twilio account...</p>
            </div>
          </div>

          <div id="step3Status" class="status-box"></div>

          <div class="button-group" style="gap: 20px;">
            <button class="btn btn-secondary" onclick="prevStep()">‚Üê Back</button>
            <button class="btn btn-primary" id="nextBtn3" onclick="nextStep()" disabled>
              Next: Create Basic TwiML ‚Üí
            </button>
          </div>
        </div>
      `;
    }

    async function loadServices() {
      // Handle demo mode
      if (studentDemoMode || twilioCredentials?.demoMode) {
        // Check if we've "purchased" a third number
        const demoNumbers = [
          { phoneNumber: '+1 (555) 867-5309', sid: 'PNdemo001', friendlyName: 'Demo Workshop Number' },
          { phoneNumber: '+1 (555) 123-4567', sid: 'PNdemo002', friendlyName: 'Demo Testing Number' }
        ];

        // Add purchased number if it exists (simulates persistence)
        if (localStorage.getItem('demoPurchasedNumber')) {
          demoNumbers.push({
            phoneNumber: '+1 (555) 321-0987',
            sid: 'PNdemo003',
            friendlyName: 'Purchased Demo Number'
          });
        }

        // In demo mode, only show services as configured if user has provisioned them
        const demoSetup = {
          phoneNumbers: demoNumbers
        };

        // Only add messaging service if user has provisioned it
        if (localStorage.getItem('demoMessagingProvisioned')) {
          demoSetup.messagingService = { sid: 'MGdemo', friendlyName: 'Demo Messaging Service' };
        }

        // Only add sync service if user has provisioned it
        if (localStorage.getItem('demoSyncProvisioned')) {
          demoSetup.syncService = { sid: 'ISdemo', friendlyName: 'Demo Sync Service' };
        }

        displayServices(demoSetup);
        return;
      }

      try {
        const response = await fetch('/api/tutorial-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'setupComplete',
            ...twilioCredentials
          })
        });

        const data = await response.json();
        console.log('loadServices response:', data);

        if (data.success && data.setup) {
          console.log('Service data:', {
            phoneNumbers: data.setup.phoneNumbers,
            messagingService: data.setup.messagingService,
            syncService: data.setup.syncService
          });
          displayServices(data.setup);
        } else {
          // No services found - display empty state
          console.log('No services found, displaying empty state');
          displayServices({
            phoneNumbers: [],
            messagingService: null,
            syncService: null
          });
        }
      } catch (error) {
        showStatus('step3Status', 'error', 'Failed to load services: ' + error.message);
        // Display empty state on error
        displayServices({
          phoneNumbers: [],
          messagingService: null,
          syncService: null
        });
      }
    }

    function displayServices(setup) {
      const container = document.getElementById('servicesContainer');

      // Handle case where setup is undefined or null
      if (!setup) {
        setup = {};
      }

      // Only consider services configured if they have actual SIDs
      const hasPhone = setup.phoneNumbers && setup.phoneNumbers.length > 0;
      const hasMessaging = setup.messagingService && setup.messagingService.sid && setup.messagingService.sid !== '';
      const hasSync = setup.syncService && setup.syncService.sid && setup.syncService.sid !== '';

      container.innerHTML = `
        <div class="service-card">
          <h4>üìû Phone Number</h4>
          <p style="font-size: 13px; color: #666; margin-bottom: 10px;">
            Required for making and receiving voice calls
          </p>
          ${hasPhone ? `
            <div style="margin-bottom: 15px;">
              <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #4fc1ff;">
                Select a phone number for this project:
              </label>
              <select id="phoneNumberSelect" style="width: 100%; padding: 10px; background: #1e1e1e; color: #abb2bf; border: 1px solid #3e4451; border-radius: 4px; font-size: 14px;" onchange="selectPhoneNumber()">
                <option value="">-- Select a phone number --</option>
                ${setup.phoneNumbers.map(num => `
                  <option value="${num.sid}" data-number="${num.phoneNumber}">
                    ${num.phoneNumber} ${num.friendlyName ? '(' + num.friendlyName + ')' : ''}
                  </option>
                `).join('')}
              </select>
              <div id="selectedNumberDisplay" style="margin-top: 10px; padding: 10px; background: #2c313c; border-radius: 4px; display: none;">
                <strong style="color: #4fc1ff;">Selected:</strong>
                <span id="selectedNumberText" style="color: #98c379; margin-left: 10px;"></span>
              </div>
            </div>
            <div style="text-align: center; margin: 10px 0;">
              <span style="color: #666;">OR</span>
            </div>
          ` : ''}
          <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
            <button class="btn btn-${hasPhone ? 'secondary' : 'primary'}" onclick="provisionPhone()">
              ${hasPhone ? 'üìû Purchase New Number' : 'üìû Purchase Number'}
            </button>
            <span style="color: #666;">or</span>
            <a href="https://console.twilio.com/us1/develop/phone-numbers/manage/search?frameUrl=%2Fconsole%2Fphone-numbers%2Fsearch%3Fx-target-region%3Dus1" target="_blank" style="color: #4fc1ff; text-decoration: none; font-size: 13px;">
              üîó Buy in Console
            </a>
          </div>
        </div>

        <div class="service-card">
          <h4>üí¨ Messaging Service</h4>
          <p style="font-size: 13px; color: #666; margin-bottom: 10px;">
            Required for SMS notifications and multi-channel communication
          </p>
          <div class="service-status">
            <span>${hasMessaging ? '‚úÖ Configured' : '‚ùå Required'}</span>
            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-top: 10px;">
              <button class="btn btn-${hasMessaging ? 'secondary' : 'primary'}" id="createMessagingBtn" onclick="provisionMessaging()" ${hasMessaging ? 'disabled style="opacity: 0.6;"' : ''}>
                ${hasMessaging ? '‚úÖ Service Created' : 'Create Service'}
              </button>
              <span style="color: #666;">or</span>
              <a href="https://console.twilio.com/us1/develop/sms/services" target="_blank" style="color: #4fc1ff; text-decoration: none; font-size: 13px;">
                üîó Create in Console
              </a>
              ${!hasMessaging ? `
              <button class="btn btn-success" onclick="verifyMessagingSetup()" style="padding: 6px 12px; font-size: 12px; background: #10b981;">
                ‚úì Verify Setup
              </button>
              ` : ''}
            </div>
          </div>
        </div>

        <div class="service-card">
          <h4>üîÑ Sync Service (Optional)</h4>
          <p style="font-size: 13px; color: #666; margin-bottom: 10px;">
            Do you want to add Twilio Sync services to persist state during the conversation with the AI bot?
          </p>
          <div class="service-status">
            <span>${hasSync ? '‚úÖ Configured' : (syncServiceSkipped ? '‚ö™ Skipped' : '‚ö†Ô∏è Optional')}</span>
            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-top: 10px;">
              <button class="btn btn-${hasSync ? 'secondary' : 'primary'}" onclick="provisionSync()" ${hasSync ? 'disabled style="opacity: 0.6;"' : ''}>
                ${hasSync ? '‚úÖ Sync Created' : 'Yes, Enable Sync'}
              </button>
              <button class="btn btn-secondary" onclick="skipSync()" ${hasSync || syncServiceSkipped ? 'disabled style="opacity: 0.6;"' : ''}>
                ${syncServiceSkipped ? '‚ö™ Skipped' : 'No, Skip This'}
              </button>
              <span style="color: #666;">or</span>
              <a href="https://console.twilio.com/us1/develop/sync/services" target="_blank" style="color: #4fc1ff; text-decoration: none; font-size: 13px;">
                üîó Create in Console
              </a>
              ${!hasSync && !syncServiceSkipped ? `
              <button class="btn btn-success" onclick="verifySyncSetup()" style="padding: 6px 12px; font-size: 12px; background: #10b981;">
                ‚úì Verify Setup
              </button>
              ` : ''}
            </div>
          </div>
        </div>

        <div class="service-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: 2px solid #5a67d8;">
          <h4 style="color: white;">üß† Conversational Intelligence (Recommended)</h4>
          <p style="color: rgba(255,255,255,0.95); font-size: 13px; margin-bottom: 15px; line-height: 1.6;">
            Get AI-powered call transcripts, sentiment analysis, and topic detection for all your workshop calls.
            This helps you see exactly what your AI said and how callers responded!
          </p>
          <div class="service-status">
            <span style="color: white;">${ciServiceSid ? '‚úÖ Enabled' : '‚ö™ Optional'}</span>
            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-top: 15px;">
              <button
                class="btn"
                onclick="enableConversationalIntelligence()"
                ${ciServiceSid ? 'disabled' : ''}
                style="background: ${ciServiceSid ? 'rgba(255,255,255,0.3)' : 'white'}; color: ${ciServiceSid ? 'rgba(255,255,255,0.7)' : '#667eea'}; padding: 10px 20px; font-weight: 600; ${ciServiceSid ? 'opacity: 0.6; cursor: not-allowed;' : ''}">
                ${ciServiceSid ? '‚úÖ Intelligence Enabled' : 'üß† Enable Conversational Intelligence'}
              </button>
              <a href="https://www.twilio.com/docs/conversational-intelligence" target="_blank"
                 style="color: rgba(255,255,255,0.9); text-decoration: underline; font-size: 13px;">
                üìö Learn More
              </a>
            </div>
            ${ciServiceSid ? `
              <div style="margin-top: 15px; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 6px;">
                <p style="color: rgba(255,255,255,0.95); font-size: 12px; margin: 0; line-height: 1.6;">
                  ‚úÖ <strong>Service ID:</strong> <code style="background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 3px; font-family: monospace;">${ciServiceSid}</code><br>
                  All calls will automatically include transcripts and insights!
                </p>
              </div>
            ` : `
              <div style="margin-top: 15px; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 6px; border-left: 3px solid #ffd43b;">
                <p style="color: rgba(255,255,255,0.95); font-size: 12px; margin: 0; line-height: 1.6;">
                  üí° <strong>Why enable this?</strong><br>
                  ‚Ä¢ See full transcripts of AI conversations<br>
                  ‚Ä¢ Analyze sentiment (positive, negative, neutral)<br>
                  ‚Ä¢ Track conversation topics automatically<br>
                  ‚Ä¢ Debug and improve your AI assistant
                </p>
              </div>
            `}
          </div>
        </div>
      `;

      // Store phone numbers for selection
      window.availablePhoneNumbers = setup.phoneNumbers || [];

      // Check if minimum services are ready (Sync is now optional)
      // Note: Phone number must be explicitly selected by user
      if (hasMessaging && (hasSync || syncServiceSkipped)) {
        if (selectedPhoneNumber) {
          servicesReady = true;
          const nextBtn3 = document.getElementById('nextBtn3');
          if (nextBtn3) {
            nextBtn3.disabled = false;
          }
          showStatus('step3Status', 'success', 'üéâ All required services are ready!');
          updateProgressBar();
          // Let highlightNextAction() determine if this button should have next-action
          highlightNextAction();
        } else if (hasPhone) {
          showStatus('step3Status', 'info', '‚ÑπÔ∏è Please select a phone number or purchase a new one to continue.');
        }
      }
    }

    function selectPhoneNumber() {
      const select = document.getElementById('phoneNumberSelect');
      const selectedOption = select.options[select.selectedIndex];

      if (selectedOption.value) {
        selectedPhoneNumberSid = selectedOption.value;
        selectedPhoneNumber = selectedOption.getAttribute('data-number');

        // Show selected number
        document.getElementById('selectedNumberDisplay').style.display = 'block';
        document.getElementById('selectedNumberText').textContent = selectedPhoneNumber;

        // Re-check if all services are ready
        const hasMessaging = document.querySelector('.service-card:nth-child(2) .service-status span').textContent.includes('‚úÖ');
        const hasSync = document.querySelector('.service-card:nth-child(3) .service-status span').textContent.includes('‚úÖ');

        if (hasMessaging && (hasSync || syncServiceSkipped)) {
          servicesReady = true;
          const nextBtn3 = document.getElementById('nextBtn3');
          if (nextBtn3) {
            nextBtn3.disabled = false;
          }
          showStatus('step3Status', 'success', 'üéâ All required services are ready!');
          updateProgressBar();
          // Let highlightNextAction() determine if this button should have next-action
          highlightNextAction();
        }
      } else {
        selectedPhoneNumber = null;
        document.getElementById('selectedNumberDisplay').style.display = 'none';
        servicesReady = false;
        document.getElementById('nextBtn3').disabled = true;
      }
    }

    function skipSync() {
      syncServiceSkipped = true;
      showStatus('step3Status', 'info', '‚ÑπÔ∏è Sync service skipped. You can continue without state persistence.');
      loadServices();
    }

    async function provisionPhone() {
      if (studentDemoMode || twilioCredentials?.demoMode) {
        showStatus('step3Status', 'info', 'üìù Demo Mode: Searching for available phone numbers...');

        setTimeout(() => {
          showStatus('step3Status', 'info', 'üìù Demo Mode: Found 3 numbers, purchasing +1 (555) 321-0987...');

          setTimeout(() => {
            // Mark as purchased in localStorage
            localStorage.setItem('demoPurchasedNumber', 'true');
            showStatus('step3Status', 'success', '‚úÖ Demo phone number +1 (555) 321-0987 purchased successfully!');

            // Reload services to show the new number
            setTimeout(() => {
              loadServices();
            }, 500);
          }, 1000);
        }, 1000);
        return;
      }

      const areaCode = prompt('Enter area code (e.g., 415, 212, 310):');
      if (!areaCode) return;

      showStatus('step3Status', 'info', 'Purchasing phone number...');

      try {
        const response = await fetch('/api/tutorial-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'provisionPhoneNumber',
            areaCode,
            ...twilioCredentials
          })
        });

        const data = await response.json();

        if (data.success) {
          const newNumber = data.phoneNumber.phoneNumber;
          const newNumberSid = data.phoneNumber.sid;
          showStatus('step3Status', 'success', `‚úÖ Purchased ${newNumber}!`);

          // Store the new number to auto-select it after reload
          window.newlyPurchasedNumber = newNumber;
          window.newlyPurchasedSid = newNumberSid;

          await loadServices();

          // Auto-select the newly purchased number
          setTimeout(() => {
            const select = document.getElementById('phoneNumberSelect');
            if (select && window.newlyPurchasedSid) {
              select.value = window.newlyPurchasedSid;
              selectPhoneNumber();
            }
          }, 500);

          // Prompt to add to messaging service
          setTimeout(() => {
            promptAddToMessagingService(newNumberSid, newNumber);
          }, 1000);
        } else {
          showStatus('step3Status', 'error', data.error);
        }
      } catch (error) {
        showStatus('step3Status', 'error', error.message);
      }
    }

    async function provisionMessaging() {
      if (studentDemoMode || twilioCredentials?.demoMode) {
        showStatus('step3Status', 'info', 'üìù Demo Mode: Simulating messaging service creation...');
        setTimeout(() => {
          localStorage.setItem('demoMessagingProvisioned', 'true');
          showStatus('step3Status', 'success', '‚úÖ Demo messaging service created!');
          loadServices();
        }, 1000);
        return;
      }

      showStatus('step3Status', 'info', 'Creating messaging service...');

      try {
        const response = await fetch('/api/tutorial-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'createMessagingService',
            ...twilioCredentials
          })
        });

        const data = await response.json();

        if (data.success) {
          showStatus('step3Status', 'success', '‚úÖ Messaging service created!');

          // ===================================================================
          // SILENT: Create Conversational Intelligence service in background
          // ===================================================================
          // This runs silently - students won't know until the "big reveal" in Step 9
          setupConversationalIntelligence();

          loadServices();
        }
      } catch (error) {
        showStatus('step3Status', 'error', error.message);
      }
    }

    async function setupConversationalIntelligence() {
      // Silent background setup - no status messages shown to user
      console.log('üîá Silently setting up Conversational Intelligence...');

      try {
        // Handle demo mode
        if (studentDemoMode || twilioCredentials?.demoMode) {
          ciServiceSid = 'ISdemo123456789';
          console.log('‚úÖ Demo CI service created (silent)');
          return;
        }

        // Create CI service
        const response = await fetch('/api/setup-ci', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            accountSid: twilioAccountSid,
            authToken: twilioAuthToken,
            action: 'create-service'
          })
        });

        const data = await response.json();

        if (data.success) {
          ciServiceSid = data.serviceSid;
          console.log('‚úÖ CI service created silently:', ciServiceSid);
          console.log('   Operators attached:', data.operators);
        } else {
          console.warn('‚ö†Ô∏è CI service creation failed (non-critical):', data.error);
        }

      } catch (error) {
        // Don't show error to user - CI is a "nice to have" feature
        console.warn('‚ö†Ô∏è CI setup failed (non-critical):', error.message);
      }
    }

    async function provisionSync() {
      if (studentDemoMode || twilioCredentials?.demoMode) {
        showStatus('step3Status', 'info', 'üìù Demo Mode: Simulating Sync service creation...');
        setTimeout(() => {
          localStorage.setItem('demoSyncProvisioned', 'true');
          showStatus('step3Status', 'success', '‚úÖ Demo Sync service created!');
          loadServices();
        }, 1000);
        return;
      }

      showStatus('step3Status', 'info', 'Creating Sync service...');

      try {
        const response = await fetch('/api/tutorial-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'createSyncService',
            ...twilioCredentials
          })
        });

        const data = await response.json();

        if (data.success) {
          showStatus('step3Status', 'success', '‚úÖ Sync service created!');
          loadServices();
        }
      } catch (error) {
        showStatus('step3Status', 'error', error.message);
      }
    }

    async function verifyMessagingSetup() {
      if (studentDemoMode || twilioCredentials?.demoMode) {
        showStatus('step3Status', 'info', 'üìù Demo Mode: Marking messaging service as configured...');
        setTimeout(() => {
          localStorage.setItem('demoMessagingProvisioned', 'true');
          showStatus('step3Status', 'success', '‚úÖ Messaging service verified!');
          loadServices();
        }, 500);
        return;
      }

      showStatus('step3Status', 'info', '‚è≥ Checking for messaging services in your account...');

      try {
        const response = await fetch('/api/tutorial-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'listMessagingServices',
            ...twilioCredentials
          })
        });

        const data = await response.json();

        if (data.success && data.services && data.services.length > 0) {
          showStatus('step3Status', 'success', `‚úÖ Found ${data.services.length} messaging service(s) in your account!`);
          // The loadServices() call will pick up the existing services
          loadServices();
        } else {
          showStatus('step3Status', 'error', '‚ùå No messaging services found. Please create one in the console first, then click Verify again.');
        }
      } catch (error) {
        showStatus('step3Status', 'error', `‚ùå Verification failed: ${error.message}`);
      }
    }

    async function verifySyncSetup() {
      if (studentDemoMode || twilioCredentials?.demoMode) {
        showStatus('step3Status', 'info', 'üìù Demo Mode: Marking Sync service as configured...');
        setTimeout(() => {
          localStorage.setItem('demoSyncProvisioned', 'true');
          showStatus('step3Status', 'success', '‚úÖ Sync service verified!');
          loadServices();
        }, 500);
        return;
      }

      showStatus('step3Status', 'info', '‚è≥ Checking for Sync services in your account...');

      try {
        const response = await fetch('/api/tutorial-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'listSyncServices',
            ...twilioCredentials
          })
        });

        const data = await response.json();

        if (data.success && data.services && data.services.length > 0) {
          showStatus('step3Status', 'success', `‚úÖ Found ${data.services.length} Sync service(s) in your account!`);
          // The loadServices() call will pick up the existing services
          loadServices();
        } else {
          showStatus('step3Status', 'error', '‚ùå No Sync services found. Please create one in the console first, then click Verify again.');
        }
      } catch (error) {
        showStatus('step3Status', 'error', `‚ùå Verification failed: ${error.message}`);
      }
    }

    async function promptAddToMessagingService(phoneNumberSid, phoneNumber) {
      // Fetch existing messaging services
      try {
        const response = await fetch('/api/tutorial-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'listMessagingServices',
            ...twilioCredentials
          })
        });

        const data = await response.json();

        if (data.success && data.services && data.services.length > 0) {
          // Show modal with dropdown to select existing service
          showMessagingServiceModal(phoneNumberSid, phoneNumber, data.services);
        } else {
          // No services exist, prompt to create one
          if (confirm(`Add ${phoneNumber} to a Messaging Service?\n\nNo messaging services found. Would you like to create one now?`)) {
            await createAndAddToMessagingService(phoneNumberSid, phoneNumber);
          }
        }
      } catch (error) {
        console.error('Error fetching messaging services:', error);
      }
    }

    function showMessagingServiceModal(phoneNumberSid, phoneNumber, services) {
      const modalHTML = `
        <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center;" id="messagingServiceModal">
          <div style="background: white; border-radius: 12px; padding: 30px; max-width: 500px; width: 90%;">
            <h3 style="margin: 0 0 15px 0; color: #333;">üì± Add ${phoneNumber} to Messaging Service</h3>
            <p style="color: #666; margin-bottom: 20px;">Choose an existing messaging service or create a new one:</p>

            <div style="margin-bottom: 20px;">
              <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Select Messaging Service:</label>
              <select id="messagingServiceSelect" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                ${services.map(s => `<option value="${s.sid}">${s.friendlyName || s.sid}</option>`).join('')}
              </select>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
              <button onclick="document.getElementById('messagingServiceModal').remove()" style="padding: 10px 20px; background: #e0e0e0; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                Skip
              </button>
              <button onclick="createNewMessagingServiceForNumber('${phoneNumberSid}', '${phoneNumber}')" style="padding: 10px 20px; background: #4fc1ff; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                Create New
              </button>
              <button onclick="addToSelectedMessagingService('${phoneNumberSid}', '${phoneNumber}')" style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                Add to Selected
              </button>
            </div>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', modalHTML);
    }

    async function addToSelectedMessagingService(phoneNumberSid, phoneNumber) {
      const serviceSid = document.getElementById('messagingServiceSelect').value;
      document.getElementById('messagingServiceModal').remove();

      showStatus('step3Status', 'info', `Adding ${phoneNumber} to messaging service...`);

      try {
        const response = await fetch('/api/tutorial-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'addNumberToMessagingService',
            serviceSid,
            phoneNumberSid,
            ...twilioCredentials
          })
        });

        const data = await response.json();

        if (data.success) {
          showStatus('step3Status', 'success', `‚úÖ ${phoneNumber} added to messaging service!`);
          loadServices();
        } else {
          showStatus('step3Status', 'error', `Failed to add number: ${data.error}`);
        }
      } catch (error) {
        showStatus('step3Status', 'error', error.message);
      }
    }

    async function createNewMessagingServiceForNumber(phoneNumberSid, phoneNumber) {
      document.getElementById('messagingServiceModal').remove();
      await createAndAddToMessagingService(phoneNumberSid, phoneNumber);
    }

    async function createAndAddToMessagingService(phoneNumberSid, phoneNumber) {
      showStatus('step3Status', 'info', 'Creating messaging service...');

      try {
        // Create messaging service
        const createResponse = await fetch('/api/tutorial-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'createMessagingService',
            friendlyName: 'Workshop Messaging Service',
            ...twilioCredentials
          })
        });

        const createData = await createResponse.json();

        if (createData.success) {
          const serviceSid = createData.service.sid;
          showStatus('step3Status', 'info', `Adding ${phoneNumber} to new service...`);

          // Add number to service
          const addResponse = await fetch('/api/tutorial-proxy', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              action: 'addNumberToMessagingService',
              serviceSid,
              phoneNumberSid,
              ...twilioCredentials
            })
          });

          const addData = await addResponse.json();

          if (addData.success) {
            showStatus('step3Status', 'success', `‚úÖ Messaging service created and ${phoneNumber} added!`);
            loadServices();
          } else {
            showStatus('step3Status', 'warning', `‚ö†Ô∏è Service created but failed to add number: ${addData.error}`);
            loadServices();
          }
        } else {
          showStatus('step3Status', 'error', `Failed to create service: ${createData.error}`);
        }
      } catch (error) {
        showStatus('step3Status', 'error', error.message);
      }
    }

    /**
     * Enable Conversational Intelligence for the student's account
     * Creates a CI service via Twilio Intelligence API
     */
    async function enableConversationalIntelligence() {
      const btn = event.target;
      const originalText = btn.textContent;

      if (ciServiceSid) {
        showStatus('step3Status', 'info', '‚úÖ Conversational Intelligence is already enabled!');
        return;
      }

      try {
        btn.disabled = true;
        btn.textContent = '‚ö° Enabling...';
        showStatus('step3Status', 'info', 'üß† Creating Conversational Intelligence service...');

        // Demo mode: Simulate CI service creation
        if (studentDemoMode || twilioCredentials?.demoMode) {
          await new Promise(resolve => setTimeout(resolve, 1500)); // Simulate delay

          // Generate a fake CI service SID
          ciServiceSid = `IS${Math.random().toString(36).substring(2, 15)}demo`;
          localStorage.setItem('ciServiceSid', ciServiceSid);
          saveProgressToStorage();

          console.log('‚úÖ Conversational Intelligence enabled (Demo Mode):', ciServiceSid);
          showStatus('step3Status', 'success',
            `‚úÖ Conversational Intelligence enabled! (Demo Mode)<br>` +
            `<div style="margin-top: 10px; font-size: 13px;">Service ID: <code>${ciServiceSid}</code></div>` +
            `<div style="margin-top: 8px; font-size: 13px;">üìù Demo mode: Call analytics are simulated for learning purposes.</div>`
          );

          // Refresh services display to show enabled state
          await loadServices();
          return;
        }

        // Real mode: Call API to create CI service
        const response = await fetch('/api/tutorial-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'createCIService',
            accountSid: twilioCredentials.accountSid,
            authToken: twilioCredentials.authToken,
            uniqueName: `workshop-${sessionToken}`,
            friendlyName: `${studentName || githubUsername || 'Student'}'s Workshop CI`,
            autoTranscribe: true,
            languageCode: 'en-US'
          })
        });

        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Failed to create Conversational Intelligence service');
        }

        // Store the service SID
        ciServiceSid = data.serviceSid;
        localStorage.setItem('ciServiceSid', ciServiceSid);
        saveProgressToStorage();

        console.log('‚úÖ Conversational Intelligence enabled:', ciServiceSid);
        showStatus('step3Status', 'success',
          `‚úÖ Conversational Intelligence enabled!<br>` +
          `<div style="margin-top: 10px; font-size: 13px;">Service ID: <code>${ciServiceSid}</code></div>` +
          `<div style="margin-top: 8px; font-size: 13px;">All your calls will now include AI-powered transcripts and insights!</div>`
        );

        // Refresh services display to show enabled state
        await loadServices();

      } catch (error) {
        // Check if this is "service already exists" - that's actually a success!
        if (error.message && error.message.includes('already exists')) {
          console.log('‚úÖ Conversational Intelligence already enabled (service exists)');
          showStatus('step3Status', 'success',
            `‚úÖ Conversational Intelligence is already enabled for your account!<br>` +
            `<div style="margin-top: 10px; font-size: 13px;">Your calls will automatically include AI-powered transcripts and insights.</div>` +
            `<div style="margin-top: 8px; font-size: 12px; color: rgba(26, 115, 232, 0.8);">üí° The service was previously set up - you're ready to go!</div>`
          );
          // Try to fetch the existing service SID
          await loadServices();
          return;
        }

        console.error('‚ùå Failed to enable Conversational Intelligence:', error);
        showStatus('step3Status', 'error',
          `‚ùå Failed to enable Conversational Intelligence: ${error.message}<br>` +
          `<div style="margin-top: 10px; font-size: 13px;">You can continue without it, or try again later.</div>`
        );
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }

    // =========================================================================
    // STEP 4: BASIC TWIML - Simple Dial or Receive
    // =========================================================================

    function renderStep_BasicTwiML() {
      const isOutbound = callDirection === 'outbound';
      const step = steps[currentStep];

      return `
        <div class="step-content active">
          <div class="step-header">
            <h2>Step ${step.id}: ${step.title}</h2>
            <p>Let's start with simple voice calling before adding AI</p>
          </div>

          <div class="instructions">
            <h3>üìã Your Task</h3>
            ${isOutbound ? `
              <p>Create a simple <code>&lt;Dial&gt;</code> verb to connect calls to a phone number.</p>
              <p>This is the foundation - you'll upgrade this to AI in later steps!</p>
              <p style="margin-top: 15px;">
                üìö <strong>Documentation:</strong>
                <a href="https://www.twilio.com/docs/voice/twiml/dial" target="_blank">&lt;Dial&gt; Verb</a> |
                <a href="https://www.twilio.com/docs/voice/tutorials/how-to-make-outbound-phone-call" target="_blank">Making Calls</a>
              </p>
            ` : `
              <p>Create an interactive voice response with <code>&lt;Say&gt;</code> and <code>&lt;Gather&gt;</code>.</p>
              <p>This is the foundation - you'll upgrade this to AI in later steps!</p>
              <p style="margin-top: 15px;">
                üìö <strong>Documentation:</strong>
                <a href="https://www.twilio.com/docs/voice/twiml/say" target="_blank">&lt;Say&gt; Verb</a> |
                <a href="https://www.twilio.com/docs/voice/twiml/gather" target="_blank">&lt;Gather&gt; Verb</a> |
                <a href="https://www.twilio.com/docs/voice/tutorials/build-interactive-voice-response-ivr-phone-tree" target="_blank">IVR Tutorial</a>
              </p>
            `}
          </div>

          ${isOutbound ? `
          <div class="service-card" style="background: linear-gradient(135deg, #e5c07b 0%, #2c313c 100%); padding: 20px; margin: 20px 0;">
            <h3 style="margin: 0 0 15px 0; color: white;">üéØ Configure Your IVR Message</h3>
            <p style="color: #e5e5e5; margin-bottom: 20px;">
              Customize the message and menu options for your Interactive Voice Response (IVR) system.
            </p>

            <div style="background: #1e1e1e; padding: 20px; border-radius: 6px;">
              <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #4fc1ff;">
                  üëã Greeting Message${generatedContent ? ' <span style="color: #98c379; font-size: 12px;">‚ú® AI-generated</span>' : ''}
                </label>
                <input type="text" id="ivrGreeting" placeholder="Hello world" value="${generatedContent?.ivrGreeting || 'Hello world'}"
                       style="width: 100%; padding: 12px; background: #2c313c; color: #abb2bf; border: 1px solid #3e4451; border-radius: 4px; font-size: 14px;"
                       oninput="updateIVRCode()">
                <p style="font-size: 12px; color: #666; margin: 5px 0 0 0;">What the caller hears first${generatedContent ? ' (customized for your use case)' : ''}</p>
              </div>

              <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #4fc1ff;">
                  1Ô∏è‚É£ Option 1 Text
                </label>
                <input type="text" id="ivrOption1" placeholder="Press 1 to connect to God" value="Press 1 to connect to God"
                       style="width: 100%; padding: 12px; background: #2c313c; color: #abb2bf; border: 1px solid #3e4451; border-radius: 4px; font-size: 14px;"
                       oninput="updateIVRCode()">
                <p style="font-size: 12px; color: #666; margin: 5px 0 0 0;">Menu option for pressing 1</p>
              </div>

              <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #4fc1ff;">
                  2Ô∏è‚É£ Option 2 Text
                </label>
                <input type="text" id="ivrOption2" placeholder="Press 2 to connect to your mom" value="Press 2 to connect to your mom"
                       style="width: 100%; padding: 12px; background: #2c313c; color: #abb2bf; border: 1px solid #3e4451; border-radius: 4px; font-size: 14px;"
                       oninput="updateIVRCode()">
                <p style="font-size: 12px; color: #666; margin: 5px 0 0 0;">Menu option for pressing 2</p>
              </div>

              <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #4fc1ff;">
                  üó£Ô∏è Voice Type
                </label>
                <select id="ivrVoice" style="width: 100%; padding: 12px; background: #2c313c; color: #abb2bf; border: 1px solid #3e4451; border-radius: 4px; font-size: 14px;" onchange="updateIVRCode()">
                  <option value="Polly.Joanna">Joanna (Female, US English)</option>
                  <option value="Polly.Matthew">Matthew (Male, US English)</option>
                  <option value="Polly.Amy">Amy (Female, British)</option>
                  <option value="Polly.Brian">Brian (Male, British)</option>
                  <option value="Polly.Salli">Salli (Female, US English)</option>
                  <option value="Polly.Kendra">Kendra (Female, US English)</option>
                  <option value="Polly.Joey">Joey (Male, US English)</option>
                  <option value="Polly.Justin">Justin (Male, Child, US English)</option>
                </select>
                <p style="font-size: 12px; color: #666; margin: 5px 0 0 0;">Choose the Amazon Polly voice for basic TwiML</p>
              </div>
            </div>
          </div>
          ` : ''}

          <div class="code-editor">
            <div class="code-header">
              <span>üìù ${isOutbound ? 'IVR' : 'Inbound'} TwiML Handler</span>
              <div style="display: flex; gap: 10px;">
                <button class="btn btn-success ${(!step4CodeValidated || code4Changed) ? 'next-action' : ''}" style="padding: 6px 12px; font-size: 13px; ${(step4CodeValidated && !code4Changed) ? 'opacity: 0.5;' : ''}" onclick="validateCode4()" ${(step4CodeValidated && !code4Changed) ? 'disabled' : ''}>‚úì Validate</button>
                <button class="btn-copy" onclick="copyCode('code4')">üìã Copy Code</button>
                <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 13px;" onclick="resetCode4()">Reset</button>
              </div>
            </div>
            <textarea class="code-textarea" id="code4" oninput="handleCodeChange('code4')">${isOutbound ? `exports.handler = function(context, event, callback) {
  const twilio = require('twilio');
  const twiml = new twilio.twiml.VoiceResponse();

  // Greet the caller
  twiml.say('Hello world', { voice: 'Polly.Joanna' });

  // Create a menu with gather
  const gather = twiml.gather({
    numDigits: 1,
    timeout: 10
  });
  gather.say('Press 1 to connect to God. Press 2 to connect to your mom.', { voice: 'Polly.Joanna' });

  // After gather timeout, say goodbye and hang up
  twiml.say('Goodbye!', { voice: 'Polly.Joanna' });
  twiml.hangup();

  callback(null, twiml);
};` : `exports.handler = function(context, event, callback) {
  const twilio = require('twilio');
  const twiml = new twilio.twiml.VoiceResponse();

  // Greet the caller
  twiml.say('Welcome to our service!', { voice: 'Polly.Joanna' });

  // Create a gather to collect input
  const gather = twiml.gather({
    numDigits: 1,
    timeout: 10
  });
  gather.say('Press 1 for sales, 2 for support.', { voice: 'Polly.Joanna' });

  // After gather timeout or completion, say goodbye and hang up
  twiml.say('Thank you for calling. Goodbye!', { voice: 'Polly.Joanna' });
  twiml.hangup();

  callback(null, twiml);
};`}</textarea>
          </div>

          <div id="step4Status" class="status-box"></div>

          ${!step4CodeValidated ? `
          <div id="step4Placeholder" class="instructions" style="margin-top: 20px; background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px;">
            <p style="margin: 0; color: #856404;">
              üí° <strong>Next Steps:</strong> Once you validate your code above, you'll be able to test and deploy your voice handler.
            </p>
          </div>
          ` : ''}

          <div id="step4DeploySection" style="margin: 30px 0; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; border: 2px solid #5a67d8; display: ${step4CodeValidated ? 'block' : 'none'};">
            <h3 style="color: white; margin: 0 0 15px 0; font-size: 1.2rem;">üíæ Ready to Deploy?</h3>
            <p style="color: rgba(255,255,255,0.9); margin-bottom: 20px; line-height: 1.6;">
              Your code looks good! Click <strong>Commit Step 4</strong> to deploy it to your Twilio account.
              This will create a Serverless service and deploy your voice handler function.
            </p>
            <button
              class="btn btn-success ${step4CodeValidated && !step4Deployed ? 'next-action' : ''}"
              id="commitStep4Btn"
              onclick="commitStep(4)"
              style="font-size: 1.1rem; padding: 15px 30px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border: none; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);">
              üíæ Commit Step 4 - Deploy Basic Handler
            </button>
            <div id="commitStep4Status" style="margin-top: 15px;"></div>
          </div>

          <div id="step4TestSection" class="service-card" style="margin-top: 20px; background: linear-gradient(135deg, #98c379 0%, #2c313c 100%); display: none;">
            ${isOutbound ? `
              <h4 style="color: white; margin-bottom: 15px;">üìû Test Your IVR Live!</h4>
              <p style="color: #e5e5e5; margin-bottom: 10px;">
                Your voice handler has been deployed! Test it by making a call to YOUR phone.
              </p>
              <p style="color: rgba(255,255,255,0.9); margin-bottom: 15px; padding: 10px; background: rgba(255,255,255,0.15); border-radius: 6px; font-size: 14px;">
                üí° <strong>Tip:</strong> Listen to how the IVR sounds - you'll improve it in later steps!
              </p>
              <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #4fc1ff;">
                  Your Phone Number (to receive test call):
                </label>
                <input type="tel" id="testCallNumber" placeholder="+12345678901"
                       style="width: 100%; padding: 12px; background: #2c313c; color: #abb2bf; border: 1px solid #3e4451; border-radius: 4px; font-size: 14px;">
                <p style="font-size: 12px; color: #666; margin: 5px 0 0 0;">Enter YOUR number to receive the test call</p>
              </div>
              <button class="btn btn-primary" id="makeLiveTestCallBtn" onclick="makeLiveTestCall()" style="width: 100%; background: white; color: #2c313c; font-weight: 600;">
                üìû Make Live Test Call
              </button>
              <div id="liveTestStatus" style="margin-top: 15px;"></div>
            ` : `
              <h4 style="color: white; margin-bottom: 15px;">üìû Test Your IVR Live!</h4>
              <p style="color: #e5e5e5; margin-bottom: 10px;">
                Your voice handler has been deployed! Test it by calling your Twilio number.
              </p>
              <p style="color: rgba(255,255,255,0.9); margin-bottom: 15px; padding: 10px; background: rgba(255,255,255,0.15); border-radius: 6px; font-size: 14px;">
                üí° <strong>Tip:</strong> Listen to how the IVR sounds - you'll improve it in later steps!
              </p>
              <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 8px; text-align: center; margin-bottom: 20px;">
                <p style="color: white; margin: 0 0 10px 0; font-size: 14px; opacity: 0.9;">
                  üì± <strong>Call this number to test:</strong>
                </p>
                <div style="font-size: 2rem; font-weight: bold; color: white; font-family: 'Courier New', monospace; letter-spacing: 2px; margin: 10px 0;">
                  ${selectedPhoneNumber || 'Configure phone number in Step 3'}
                </div>
                <button onclick="navigator.clipboard.writeText('${selectedPhoneNumber}'); showStatus('inboundTestStatus', 'success', 'üìã Number copied!')"
                        style="margin-top: 10px; padding: 8px 16px; background: white; color: #2c313c; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
                  üìã Copy Number
                </button>
              </div>
              <button class="btn btn-primary" id="monitorInboundCallsBtn" onclick="monitorInboundCalls()" style="width: 100%; background: white; color: #2c313c; font-weight: 600;">
                üîç Monitor for Incoming Calls
              </button>
              <div id="inboundTestStatus" style="margin-top: 15px;"></div>
            `}
          </div>

          ${callDirection === 'inbound' ? `
          <!-- Inbound Call Test Instructions -->
          <div id="inboundTestCard" style="display: none; margin-top: 30px; padding: 25px; background: linear-gradient(135deg, #4fc1ff 0%, #2c313c 100%); border-radius: 12px; border: 2px solid #4fc1ff;">
            <h3 style="color: white; margin: 0 0 15px 0; font-size: 1.3rem;">üìû Test Your Inbound IVR</h3>
            <p style="color: rgba(255,255,255,0.9); margin-bottom: 20px; line-height: 1.6;">
              Your voice handler has been deployed! Call your Twilio number to test the IVR:
            </p>

            <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
              <div style="color: #98c379; font-size: 14px; margin-bottom: 8px; font-weight: 600;">üì± Your Twilio Number:</div>
              <div style="font-size: 28px; font-weight: bold; color: white; font-family: monospace; margin-bottom: 15px;">
                ${selectedPhoneNumber || 'Not configured'}
              </div>
              <div style="color: rgba(255,255,255,0.8); font-size: 14px; line-height: 1.6;">
                <strong>What to expect:</strong><br>
                1Ô∏è‚É£ Call the number above from your phone<br>
                2Ô∏è‚É£ You'll hear: "Welcome to our service!"<br>
                3Ô∏è‚É£ Listen to menu: "Press 1 for sales, 2 for support"<br>
                4Ô∏è‚É£ Press 1 or 2 (or wait 10 seconds)<br>
                5Ô∏è‚É£ You'll hear "Thank you for calling. Goodbye!" and call ends
              </div>
            </div>

            <button class="btn btn-success" onclick="confirmInboundTestStep4()" style="width: 100%; font-size: 1.1rem; padding: 15px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
              ‚úÖ I Called and It Works!
            </button>

            <!-- Call Progress Tracker -->
            <div id="callProgressTracker" style="display: none; margin-top: 20px; padding: 20px; background: rgba(0,0,0,0.2); border-radius: 8px;">
              <h4 style="color: white; margin: 0 0 15px 0; font-size: 1.1rem;">üìä Call Progress</h4>
              <div id="callStages" style="display: flex; flex-direction: column; gap: 10px;">
                <div id="stage1" class="call-stage" style="display: flex; align-items: center; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 6px; opacity: 0.5;">
                  <span style="width: 30px; height: 30px; border-radius: 50%; background: #666; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 16px;">1</span>
                  <span style="color: rgba(255,255,255,0.7);">Call initiated</span>
                </div>
                <div id="stage2" class="call-stage" style="display: flex; align-items: center; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 6px; opacity: 0.5;">
                  <span style="width: 30px; height: 30px; border-radius: 50%; background: #666; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 16px;">2</span>
                  <span style="color: rgba(255,255,255,0.7);">Greeting played</span>
                </div>
                <div id="stage3" class="call-stage" style="display: flex; align-items: center; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 6px; opacity: 0.5;">
                  <span style="width: 30px; height: 30px; border-radius: 50%; background: #666; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 16px;">3</span>
                  <span style="color: rgba(255,255,255,0.7);">Menu options played</span>
                </div>
                <div id="stage4" class="call-stage" style="display: flex; align-items: center; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 6px; opacity: 0.5;">
                  <span style="width: 30px; height: 30px; border-radius: 50%; background: #666; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 16px;">4</span>
                  <span style="color: rgba(255,255,255,0.7);">Waiting for input (or timeout)</span>
                </div>
                <div id="stage5" class="call-stage" style="display: flex; align-items: center; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 6px; opacity: 0.5;">
                  <span style="width: 30px; height: 30px; border-radius: 50%; background: #666; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 16px;">5</span>
                  <span style="color: rgba(255,255,255,0.7);">Goodbye message & hangup</span>
                </div>
              </div>
              <button onclick="hideCallProgress()" style="margin-top: 15px; padding: 8px 16px; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 4px; cursor: pointer;">
                Hide Progress
              </button>
            </div>

            <button id="showProgressBtn" onclick="showCallProgress()" style="display: none; width: 100%; margin-top: 15px; padding: 12px; background: rgba(76, 175, 80, 0.2); color: white; border: 1px solid #4CAF50; border-radius: 8px; cursor: pointer; font-size: 14px;">
              üìä Show Call Flow Progress
            </button>
          </div>
          ` : ''}

          <div class="button-group" style="gap: 20px;">
            <button class="btn btn-secondary" onclick="prevStep()">‚Üê Back</button>
            <button class="btn btn-primary ${step4Deployed ? 'next-action' : ''}" id="nextBtn4" onclick="nextStep()" ${step4Deployed ? '' : 'disabled'}>
              Next: WebSocket Streaming ‚Üí
            </button>
          </div>
        </div>
      `;
    }

    function testCode4() {
      const code = document.getElementById('code4').value;
      const consoleEl = document.getElementById('console4');
      const isOutbound = callDirection === 'outbound';

      try {
        // Extract phone number if present
        const numberMatch = code.match(/dial\.number\(['"]([^'"]+)['"]\)|twiml\.dial\(['"]([^'"]+)['"]\)/);
        const phoneNumber = numberMatch ? (numberMatch[1] || numberMatch[2]) : null;

        // Extract timeout
        const timeoutMatch = code.match(/timeout:\s*(\d+)/);
        const timeout = timeoutMatch ? timeoutMatch[1] : '30';

        // Extract machine detection
        const mdMatch = code.match(/machineDetection:\s*['"]([^'"]+)['"]/);
        const machineDetection = mdMatch ? mdMatch[1] : 'none';

        // Simulate the function execution
        let output = `<div class="console-line">üìû Testing TwiML generation...</div>`;
        output += `<div class="console-line" style="color: #4fc1ff;">‚úì TwiML Response created</div>`;

        if (isOutbound) {
          output += `<div class="console-line" style="color: #98c379;">‚úì Dial verb configured</div>`;

          if (phoneNumber) {
            output += `<div class="console-line">  ‚Üí Target: ${phoneNumber}</div>`;
          } else {
            output += `<div class="console-line" style="color: #e5c07b;">  ‚ö†Ô∏è No target number specified yet</div>`;
          }

          if (timeout !== '30') {
            output += `<div class="console-line">  ‚Üí Timeout: ${timeout} seconds</div>`;
          }

          if (machineDetection !== 'none') {
            output += `<div class="console-line">  ‚Üí Machine Detection: ${machineDetection}</div>`;
          }

          output += `<div class="console-line" style="color: #666; margin-top: 10px;">Expected TwiML output:</div>`;
          output += `<div class="console-line" style="color: #666;">&lt;Response&gt;</div>`;
          output += `<div class="console-line" style="color: #666;">  &lt;Dial${timeout !== '30' ? ' timeout="' + timeout + '"' : ''}${machineDetection !== 'none' ? ' machineDetection="' + machineDetection + '"' : ''}&gt;</div>`;
          if (phoneNumber) {
            output += `<div class="console-line" style="color: #666;">    &lt;Number&gt;${phoneNumber}&lt;/Number&gt;</div>`;
          }
          output += `<div class="console-line" style="color: #666;">  &lt;/Dial&gt;</div>`;
          output += `<div class="console-line" style="color: #666;">&lt;/Response&gt;</div>`;
        } else {
          output += `<div class="console-line" style="color: #98c379;">Expected: Caller will hear IVR menu</div>`;
        }

        consoleEl.innerHTML = output;
      } catch (error) {
        consoleEl.innerHTML = `<div class="console-line" style="color: #e06c75;">Error: ${error.message}</div>`;
      }
    }

    function validateCode4() {
      const code = document.getElementById('code4').value;
      const isOutbound = callDirection === 'outbound';

      try {
        // Try to execute the code to validate it actually works
        const mockTwiml = {
          _hasSay: false,
          _hasGather: false,
          _hasHangup: false,
          _hasDial: false,
          say: function(text, options) { this._hasSay = true; return this; },
          gather: function(options) {
            this._hasGather = true;
            const self = this;
            return {
              say: function(text, opts) { self._hasSay = true; return self; }
            };
          },
          hangup: function() { this._hasHangup = true; return this; },
          dial: function(options) { this._hasDial = true; return { number: function() {} }; },
          toString: function() { return '<?xml version="1.0" encoding="UTF-8"?><Response></Response>'; }
        };

        // Mock twilio module for require('twilio')
        const mockTwilio = {
          twiml: {
            VoiceResponse: function() { return mockTwiml; }
          }
        };

        // Extract the function body from exports.handler or just use the code as-is
        let functionBody = code;
        if (code.includes('exports.handler')) {
          // Extract everything inside the handler function
          const match = code.match(/exports\.handler\s*=\s*function\s*\([^)]*\)\s*\{([\s\S]*)\}/);
          if (match) {
            functionBody = match[1];
          }
        }

        // Remove const twiml declarations since we provide it
        functionBody = functionBody.replace(/const\s+twiml\s*=\s*new\s+twilio\.twiml\.VoiceResponse\(\s*\)\s*;?\s*/g, '');

        // Remove require('twilio') declarations since we provide it
        functionBody = functionBody.replace(/const\s+twilio\s*=\s*require\(['"]twilio['"]\)\s*;?\s*/g, '');

        // Create a safe execution context
        const wrappedCode = `
          (function() {
            const context = { TWILIO_PHONE_NUMBER: '+15555555555' };
            const event = {};
            const callback = function(err, response) {};
            const require = function(module) {
              if (module === 'twilio') return arguments[1];
              return {};
            };
            const twilio = arguments[1];
            const twiml = arguments[0];
            ${functionBody}
            return twiml;
          })
        `;

        const func = eval(wrappedCode);
        const result = func(mockTwiml, mockTwilio);

        // Check if required verbs were called
        const hasSayVerb = result._hasSay;
        const hasGatherVerb = result._hasGather;

        // For both inbound and outbound, expect Say + Gather (basic IVR)
        if (hasSayVerb && hasGatherVerb) {
          basicTwimlCreated = true;
          step4CodeValidated = true;
          // Only enable Next button for inbound (outbound needs to test+deploy first)
          if (!isOutbound) {
            document.getElementById('nextBtn4').disabled = false;
          }
          showStatus('step4Status', 'success', '‚úÖ Perfect! Your IVR is ready. Deploy it below!');
          updateProgressBar();

          // Hide the placeholder hint and reveal deploy section
          const placeholder = document.getElementById('step4Placeholder');
          if (placeholder) placeholder.style.display = 'none';

          const deploySection = document.getElementById('step4DeploySection');

          // Show deploy section for both inbound and outbound after validation
          // (Test section will show after deployment via step4Deployed flag)
          if (deploySection) deploySection.style.display = 'block';

          // Clear all existing next-action highlights first
          document.querySelectorAll('.next-action').forEach(el => {
            el.classList.remove('next-action');
          });

          // Disable the validate button
          const validateBtn = document.querySelector('[onclick="validateCode4()"]');
          if (validateBtn) {
            validateBtn.disabled = true;
            validateBtn.style.opacity = '0.5';
          }

          // Add next-action to commit button
          const commitBtn = document.getElementById('commitStep4Btn');
          if (commitBtn) commitBtn.classList.add('next-action');

          // Reset code change flag
          code4Changed = false;

          // Scroll to reveal deploy section
          setTimeout(() => {
            if (deploySection) {
              deploySection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
          }, 300);
        } else if (!hasSayVerb) {
          showStatus('step4Status', 'error', '‚ùå Missing Say verb. Use twiml.say() to greet the caller.');
        } else if (!hasGatherVerb) {
          showStatus('step4Status', 'error', '‚ùå Missing Gather verb. Use twiml.gather() to collect input.');
        }
      } catch (error) {
        showStatus('step4Status', 'error', `‚ùå Code error: ${error.message}. Check your syntax.`);
      }
    }

    function getTTSProviderName() {
      if (ttsProvider === 'elevenlabs') return 'ElevenLabs';
      if (ttsProvider === 'google') return 'Google Cloud TTS';
      return 'Amazon Polly';
    }

    function getDefaultVoice() {
      // Use the selected voice for ConversationRelay if available
      if (conversationRelayVoice) return conversationRelayVoice;

      // Otherwise return provider defaults
      if (ttsProvider === 'elevenlabs') return '4YYIPFl9wE5c4L2eu2Gb'; // Bert Reynolds - Charismatic and Smooth
      if (ttsProvider === 'google') return 'en-US-Wavenet-A';
      return 'Polly.Joanna'; // Amazon Polly default
    }

    function getVoiceName(voiceId) {
      if (!voiceId) return 'Default';

      // ElevenLabs voice ID to name mapping
      const elevenlabsVoices = {
        '4YYIPFl9wE5c4L2eu2Gb': 'Bert Reynolds - Charismatic and Smooth',
        '9XfYMbJVZqPHaQtYnTAO': 'Cody - Energetic Upbeat Educator',
        '4CrZuIW9am7gYAxgo2Af': 'Shelley - Clear and confident British female',
        '8N2ng9i2uiUWqstgmWlH': 'Beth - Gentle and nurturing',
        '90ipbRoKi4CpHXvKVtl0': 'Anika - Customer Care Agent',
        '9PvnT6XRzlljoaDG6Knu': 'Ranbir - Warm & Friendly',
        'EXAVITQu4vr4xnSDxMaL': 'Bella - Calm and Professional',
        '7S3KNdLDL7aRgBVRQb1z': 'Nathaniel - Deep Rich Mature British',
        '6dcFFb31LVaCdYevmTAx': 'Jerry - Presenter, Announcer, Event',
        'iKqE7GcKIGSXOrp5q2Y3': 'Atlas - Business Explainer',
        'vOFq2yBGlsvTiMHEVmKr': 'Luna - Youthful Friendly'
      };

      if (elevenlabsVoices[voiceId]) {
        return elevenlabsVoices[voiceId];
      }

      // Strip Polly. prefix from Amazon voices
      if (voiceId.startsWith('Polly.')) {
        return voiceId.replace('Polly.', '');
      }

      // Return as-is for Google and other providers
      return voiceId;
    }

    function getVoiceOptions() {
      if (ttsProvider === 'elevenlabs') {
        return `
          <option value="EXAVITQu4vr4xnSDxMaL">Sarah (Female, American, Professional)</option>
          <option value="FGY2WhTYpPnrIDTdsKH5">Laura (Female, American, Sassy)</option>
          <option value="Xb7hH8MSUJpSbSDYk0k2">Alice (Female, British, Professional)</option>
          <option value="XrExE9yKIg1WjnnlVkGX">Matilda (Female, American, Upbeat)</option>
          <option value="cgSgspJ2msm6clMCkdW9">Jessica (Female, American, Cute)</option>
          <option value="pFZP5JQG7iQjIQuC4Bku">Lily (Female, Confident)</option>
          <option value="TX3LPaxmHKxFdv7VOQHJ">Liam (Male, American, Confident)</option>
          <option value="iP95p4xoKVk53GoZ742B">Chris (Male, American, Casual)</option>
          <option value="nPczCjzI2devNBz1zQrb">Brian (Male, American, Classy)</option>
          <option value="onwK4e9ZLuTAKqWW03F9">Daniel (Male, British, Formal)</option>
          <option value="CwhRBWXzGAHq8TQ4Fs17">Roger (Male, American, Classy)</option>
          <option value="2EiwWnXFnvU5JabPnv8n">Clyde (Male, American, Intense)</option>
          <option value="JBFqnCBsd6RMkjVDRZzb">George (Male, British, Mature)</option>
          <option value="bIHbv24MWmeRgasZH58o">Will (Male, American, Chill)</option>
          <option value="SAz9YHcvj6GT2YYXdXww">River (Neutral, American, Calm)</option>
        `;
      } else if (ttsProvider === 'google') {
        return `
          <option value="en-US-Wavenet-A">Wavenet A (Female, US English)</option>
          <option value="en-US-Wavenet-B">Wavenet B (Male, US English)</option>
          <option value="en-GB-Wavenet-A">Wavenet A (Female, British)</option>
          <option value="en-GB-Wavenet-B">Wavenet B (Male, British)</option>
          <option value="en-AU-Wavenet-A">Wavenet A (Female, Australian)</option>
        `;
      } else {
        // Amazon Polly (default)
        return `
          <option value="Polly.Joanna">Joanna (Female, US English)</option>
          <option value="Polly.Matthew">Matthew (Male, US English)</option>
          <option value="Polly.Amy">Amy (Female, British)</option>
          <option value="Polly.Brian">Brian (Male, British)</option>
          <option value="Polly.Salli">Salli (Female, US English)</option>
          <option value="Polly.Joey">Joey (Male, US English)</option>
        `;
      }
    }

    function updateIVRCode() {
      if (callDirection !== 'outbound') return;

      const greeting = document.getElementById('ivrGreeting')?.value || 'Hello world';
      const option1 = document.getElementById('ivrOption1')?.value || 'Press 1 to connect to God';
      const option2 = document.getElementById('ivrOption2')?.value || 'Press 2 to connect to your mom';
      const voice = document.getElementById('ivrVoice')?.value || 'Polly.Joanna'; // Basic TwiML always uses Polly

      // Generate simple IVR code (Say + Gather only, no Dial)
      const code = `exports.handler = function(context, event, callback) {
  const twilio = require('twilio');
  const twiml = new twilio.twiml.VoiceResponse();

  // Play greeting and IVR menu to the caller
  twiml.say('${greeting}', { voice: '${voice}' });

  // Create a menu with Gather
  const gather = twiml.gather({
    numDigits: 1,
    timeout: 10
  });

  gather.say('${option1}. ${option2}.', { voice: '${voice}' });

  // After gather timeout, say goodbye and hang up
  twiml.say('Goodbye!', { voice: '${voice}' });
  twiml.hangup();

  callback(null, twiml);
};`;

      // Update the textarea
      const codeEditor = document.getElementById('code4');
      if (codeEditor) {
        codeEditor.value = code;
      }
    }

    async function makeLiveTestCall() {
      // Get YOUR number (to receive the test call)
      const yourNumber = document.getElementById('testCallNumber')?.value?.trim();

      if (!yourNumber) {
        document.getElementById('liveTestStatus').innerHTML =
          '<div style="color: #e06c75; padding: 10px; background: #2c313c; border-radius: 4px;">‚ùå Please enter your phone number to receive the test call</div>';
        return;
      }

      if (!yourNumber.startsWith('+')) {
        document.getElementById('liveTestStatus').innerHTML =
          '<div style="color: #e5c07b; padding: 10px; background: #2c313c; border-radius: 4px;">‚ö†Ô∏è Your number must use E.164 format (e.g., +1234567890)</div>';
        return;
      }

      // Get the IVR TwiML from the code editor
      const code = document.getElementById('code4')?.value || '';

      // Extract greeting for display
      const greetingMatch = code.match(/twiml\.say\(['"]([^'"]+)['"]/);
      const greeting = greetingMatch ? greetingMatch[1] : 'Hello world';

      console.log('makeLiveTestCall - twilioCredentials:', twilioCredentials);
      console.log('makeLiveTestCall - studentDemoMode:', studentDemoMode);

      // Demo mode simulation
      if (studentDemoMode || twilioCredentials?.demoMode === true) {
        document.getElementById('liveTestStatus').innerHTML =
          '<div style="color: #4fc1ff; padding: 10px; background: #2c313c; border-radius: 4px;">üìû Demo Mode: Simulating call...</div>';

        setTimeout(() => {
          document.getElementById('liveTestStatus').innerHTML = `
            <div style="color: #98c379; padding: 15px; background: #2c313c; border-radius: 4px;">
              <strong>‚úÖ Demo call completed successfully!</strong><br>
              <div style="margin-top: 10px; font-size: 13px; line-height: 1.6;">
                üì± CallSid: CA_demo_${Date.now()}<br>
                üìû Calling: ${yourNumber}
              </div>
              <div style="margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 4px; font-size: 12px;">
                <strong>What would happen in live mode:</strong><br>
                1. Your phone (${yourNumber}) would ring<br>
                2. Answer it and you'd hear: "${greeting}"<br>
                3. You'd hear the menu options<br>
                4. Press 1 or 2 to test Gather, or wait 10 seconds<br>
                5. Call ends with "Goodbye!" and hangs up
              </div>
            </div>
          `;

          // Mark test as completed and enable Next button
          step4LiveTestCompleted = true;

          // Clear all highlights first
          clearHighlights();

          // Then add next-action to Next button
          const nextBtn = document.getElementById('nextBtn4');
          if (nextBtn) {
            nextBtn.disabled = false;
            nextBtn.classList.add('next-action'); // Move effect to Next button
          }

          // Update progress
          saveProgressToStorage();
          updateProgressBar();
        }, 2000);
        return;
      }

      document.getElementById('liveTestStatus').innerHTML =
        '<div style="color: #4fc1ff; padding: 10px; background: #2c313c; border-radius: 4px;">üìû Initiating call...</div>';

      try {
        // Use the deployed Twilio Serverless function URL
        const voiceHandlerUrl = `https://${twilioServerlessDomain}/voice-handler`;

        const response = await fetch('/api/tutorial-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'makeCall',
            to: yourNumber,
            from: selectedPhoneNumber,
            url: voiceHandlerUrl, // Use deployed function URL, not inline code
            ...twilioCredentials
          })
        });

        const data = await response.json();

        if (data.success) {
          document.getElementById('liveTestStatus').innerHTML = `
            <div style="color: #98c379; padding: 15px; background: #2c313c; border-radius: 4px;">
              <strong>‚úÖ Call initiated successfully!</strong><br>
              <div style="margin-top: 10px; font-size: 13px; line-height: 1.6;">
                üì± CallSid: ${data.callSid}<br>
                üìû Calling: ${yourNumber}
              </div>
              <div style="margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 4px; font-size: 12px;">
                <strong>What happens next:</strong><br>
                1. Your phone (${yourNumber}) will ring<br>
                2. Answer it and you'll hear: "${greeting}"<br>
                3. You'll hear the menu options<br>
                4. Press 1 or 2 to test Gather, or wait 10 seconds<br>
                5. Call ends with "Goodbye!" and hangs up
              </div>
            </div>
          `;

          // Mark test as completed and enable Next button
          step4LiveTestCompleted = true;

          // Clear all highlights first
          clearHighlights();

          // Then add next-action to Next button
          const nextBtn = document.getElementById('nextBtn4');
          if (nextBtn) {
            nextBtn.disabled = false;
            nextBtn.classList.add('next-action'); // Move effect to Next button
          }

          // Update progress
          saveProgressToStorage();
          updateProgressBar();
        } else {
          document.getElementById('liveTestStatus').innerHTML =
            `<div style="color: #e06c75; padding: 10px; background: #2c313c; border-radius: 4px;">‚ùå Call failed: ${data.error}</div>`;
        }
      } catch (error) {
        document.getElementById('liveTestStatus').innerHTML =
          `<div style="color: #e06c75; padding: 10px; background: #2c313c; border-radius: 4px;">‚ùå Error: ${error.message}</div>`;
      }
    }

    // Monitor for inbound calls (Step 4 - inbound direction)
    let inboundMonitorInterval = null;
    async function monitorInboundCalls() {
      const statusDiv = document.getElementById('inboundTestStatus');

      // Demo mode simulation
      if (studentDemoMode || twilioCredentials?.demoMode === true) {
        statusDiv.innerHTML = '<div style="color: #4fc1ff; padding: 10px; background: #2c313c; border-radius: 4px;">üîç Monitoring for incoming calls...</div>';

        setTimeout(() => {
          statusDiv.innerHTML = `
            <div style="color: #98c379; padding: 15px; background: #2c313c; border-radius: 4px;">
              <strong>‚úÖ Incoming call detected!</strong><br>
              <div style="margin-top: 10px; font-size: 13px; line-height: 1.6;">
                üì± CallSid: CA_demo_${Date.now()}<br>
                üìû From: +15551234567<br>
                üìç To: ${selectedPhoneNumber}
              </div>
              <div style="margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 4px; font-size: 12px;">
                <strong>What happened in the demo:</strong><br>
                1. Caller dialed ${selectedPhoneNumber}<br>
                2. Your TwiML handler answered the call<br>
                3. Caller heard your IVR greeting and menu<br>
                4. Caller interacted with the menu options<br>
                5. Call completed successfully!
              </div>
            </div>
          `;

          // Mark test as completed
          step4LiveTestCompleted = true;

          // Clear all highlights first
          clearHighlights();

          // Then add next-action to Next button
          const nextBtn = document.getElementById('nextBtn4');
          if (nextBtn) {
            nextBtn.disabled = false;
            nextBtn.classList.add('next-action'); // Move effect to Next button
          }

          saveProgressToStorage();
          updateProgressBar();
        }, 3000);
        return;
      }

      // Live mode - poll for recent calls
      statusDiv.innerHTML = '<div style="color: #4fc1ff; padding: 10px; background: #2c313c; border-radius: 4px;">üîç Monitoring for incoming calls... (call your number now)</div>';

      let pollCount = 0;
      const maxPolls = 60; // Monitor for 2 minutes (60 * 2 seconds)

      if (inboundMonitorInterval) {
        clearInterval(inboundMonitorInterval);
      }

      inboundMonitorInterval = setInterval(async () => {
        pollCount++;

        if (pollCount > maxPolls) {
          clearInterval(inboundMonitorInterval);
          statusDiv.innerHTML = '<div style="color: #e5c07b; padding: 10px; background: #2c313c; border-radius: 4px;">‚è±Ô∏è Monitoring timeout. Click button again to continue monitoring.</div>';
          return;
        }

        try {
          const response = await fetch('/api/tutorial-proxy', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              action: 'listRecentCalls',
              phoneNumber: selectedPhoneNumber,
              minutes: 2, // Look for calls in last 2 minutes
              ...twilioCredentials
            })
          });

          const data = await response.json();

          if (data.success && data.calls && data.calls.length > 0) {
            const call = data.calls[0];
            clearInterval(inboundMonitorInterval);

            statusDiv.innerHTML = `
              <div style="color: #98c379; padding: 15px; background: #2c313c; border-radius: 4px;">
                <strong>‚úÖ Incoming call detected!</strong><br>
                <div style="margin-top: 10px; font-size: 13px; line-height: 1.6;">
                  üì± CallSid: ${call.sid}<br>
                  üìû From: ${call.from}<br>
                  üìç To: ${call.to}<br>
                  üìä Status: ${call.status}<br>
                  ‚è±Ô∏è Duration: ${call.duration} seconds
                </div>
                <div style="margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 4px; font-size: 12px;">
                  <strong>üéâ Success!</strong> Your Basic TwiML handler is working! The caller heard your IVR greeting and menu options.
                </div>
              </div>
            `;

            // Mark test as completed
            step4LiveTestCompleted = true;

            // Clear all highlights first
            clearHighlights();

            // Then add next-action to Next button
            const nextBtn = document.getElementById('nextBtn4');
            if (nextBtn) {
              nextBtn.disabled = false;
              nextBtn.classList.add('next-action'); // Move effect to Next button
            }

            saveProgressToStorage();
            updateProgressBar();
          }
        } catch (error) {
          console.error('Error monitoring calls:', error);
        }
      }, 2000); // Poll every 2 seconds
    }

    function resetCode4() {
      const isOutbound = callDirection === 'outbound';
      const voice = getDefaultVoice();
      document.getElementById('code4').value = isOutbound ? `exports.handler = function(context, event, callback) {
  const twilio = require('twilio');
  const twiml = new twilio.twiml.VoiceResponse();

  // Greet the caller
  twiml.say('Hello world', { voice: '${voice}' });

  // Create a menu with gather
  const gather = twiml.gather({
    numDigits: 1,
    timeout: 10
  });
  gather.say('Press 1 to connect to God. Press 2 to connect to your mom.', { voice: '${voice}' });

  // After gather timeout, say goodbye and hang up
  twiml.say('Goodbye!', { voice: '${voice}' });
  twiml.hangup();

  callback(null, twiml);
};` : `exports.handler = function(context, event, callback) {
  const twilio = require('twilio');
  const twiml = new twilio.twiml.VoiceResponse();

  // Greet the caller
  twiml.say('Welcome to our service!');

  // Create a gather to collect input
  const gather = twiml.gather({
    numDigits: 1,
    timeout: 10
  });
  gather.say('Press 1 for sales, 2 for support.');

  // After gather timeout or completion, say goodbye and hang up
  twiml.say('Thank you for calling. Goodbye!');
  twiml.hangup();

  callback(null, twiml);
};`;
      document.getElementById('console4').innerHTML = '';
      document.getElementById('step4Status').innerHTML = '';
    }

    // =========================================================================
    // STEP 7: PROMPT ENGINEERING - Master AI Prompting
    // =========================================================================

    function renderStep_PromptEngineering() {
      const step = steps[currentStep];
      return `
        <div class="step-content active">
          <div class="step-header">
            <h2>Step ${step.id}: ${step.title}</h2>
            <p>Your system prompt is THE MOST IMPORTANT part of your Voice AI. Learn how to craft effective prompts for voice interactions.</p>
          </div>

          <!-- OpenAI API Key Status -->
          ${!studentDemoMode ? `
          <div class="service-card" style="background: ${openaiApiKey ? '#d4edda' : '#fff3cd'}; border-left: 4px solid ${openaiApiKey ? '#28a745' : '#ffc107'};">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <strong style="font-size: 1.05rem; color: ${openaiApiKey ? '#155724' : '#856404'};">
                  ${openaiApiKey ? '‚úÖ OpenAI API Key Connected' : '‚ö†Ô∏è OpenAI API Key Not Set'}
                </strong>
                ${openaiApiKey ? `
                  <p style="margin: 5px 0 0 0; font-size: 13px; color: #155724;">
                    Key: sk-****...****
                  </p>
                ` : `
                  <p style="margin: 5px 0 0 0; font-size: 13px; color: #856404;">
                    An OpenAI API key is required to test your prompt and use AI features.
                  </p>
                `}
              </div>
              <button class="btn btn-secondary" onclick="currentStep = 0; renderStepContent();" style="padding: 8px 16px; font-size: 13px;">
                ${openaiApiKey ? 'üîÑ Change Key' : '‚ûï Add Key'}
              </button>
            </div>
          </div>
          ` : ''}

          <div class="service-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            <h3 style="color: white; margin: 0 0 15px 0;">‚ö° Why Prompt Engineering Matters</h3>
            <p style="color: rgba(255,255,255,0.95); line-height: 1.6;">
              The system prompt defines your AI's personality, capabilities, and behavior. A great prompt makes the difference between:
            </p>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
              <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px;">
                <div style="font-size: 18px; margin-bottom: 5px;">‚ùå Bad AI</div>
                <div style="font-size: 14px; opacity: 0.9;">Robotic, rambling, confused, unhelpful</div>
              </div>
              <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px;">
                <div style="font-size: 18px; margin-bottom: 5px;">‚úÖ Great AI</div>
                <div style="font-size: 14px; opacity: 0.9;">Natural, concise, helpful, professional</div>
              </div>
            </div>
          </div>

          <div class="service-card">
            <h3>üìö Essential Prompt Engineering Resources</h3>
            <p>Study these resources to master AI prompting for voice applications:</p>

            <div style="display: grid; gap: 15px; margin-top: 20px;">
              <!-- OpenAI -->
              <div style="border: 2px solid #10a37f; border-radius: 8px; padding: 20px; background: #f7fef9;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                  <div style="background: #10a37f; color: white; padding: 8px 12px; border-radius: 6px; font-weight: 600;">OpenAI</div>
                  <div style="font-size: 18px; font-weight: 600; color: #333;">Prompt Engineering Guide</div>
                </div>
                <p style="color: #666; margin-bottom: 12px;">Official guide from OpenAI with best practices, examples, and techniques.</p>
                <a href="https://platform.openai.com/docs/guides/prompt-engineering" target="_blank"
                   style="display: inline-block; padding: 10px 20px; background: #10a37f; color: white; text-decoration: none; border-radius: 6px; font-weight: 600;">
                  üìñ Read Guide ‚Üí
                </a>
              </div>

              <!-- Twilio -->
              <div style="border: 2px solid #F22F46; border-radius: 8px; padding: 20px; background: #fef5f6;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                  <div style="background: #F22F46; color: white; padding: 8px 12px; border-radius: 6px; font-weight: 600;">Twilio</div>
                  <div style="font-size: 18px; font-weight: 600; color: #333;">ConversationRelay Best Practices</div>
                </div>
                <p style="color: #666; margin-bottom: 12px;">Voice-specific prompting techniques for Twilio ConversationRelay.</p>
                <a href="https://www.twilio.com/docs/voice/conversationrelay/best-practices" target="_blank"
                   style="display: inline-block; padding: 10px 20px; background: #F22F46; color: white; text-decoration: none; border-radius: 6px; font-weight: 600;">
                  üéôÔ∏è View Docs ‚Üí
                </a>
              </div>

              <!-- Learn Prompting -->
              <div style="border: 2px solid #3b82f6; border-radius: 8px; padding: 20px; background: #f5f9ff;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                  <div style="background: #3b82f6; color: white; padding: 8px 12px; border-radius: 6px; font-weight: 600;">Community</div>
                  <div style="font-size: 18px; font-weight: 600; color: #333;">Learn Prompting (Free Course)</div>
                </div>
                <p style="color: #666; margin-bottom: 12px;">Comprehensive free course covering all aspects of prompt engineering.</p>
                <a href="https://learnprompting.org/" target="_blank"
                   style="display: inline-block; padding: 10px 20px; background: #3b82f6; color: white; text-decoration: none; border-radius: 6px; font-weight: 600;">
                  üöÄ Start Course ‚Üí
                </a>
              </div>

              <!-- Prompt Engineering Guide (GitHub) -->
              <div style="border: 2px solid #6366f1; border-radius: 8px; padding: 20px; background: #f5f6ff;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                  <div style="background: #6366f1; color: white; padding: 8px 12px; border-radius: 6px; font-weight: 600;">GitHub</div>
                  <div style="font-size: 18px; font-weight: 600; color: #333;">Prompt Engineering Guide (DAIR.AI)</div>
                </div>
                <p style="color: #666; margin-bottom: 12px;">Open-source guide with examples, papers, and advanced techniques.</p>
                <a href="https://www.promptingguide.ai/" target="_blank"
                   style="display: inline-block; padding: 10px 20px; background: #6366f1; color: white; text-decoration: none; border-radius: 6px; font-weight: 600;">
                  üìñ Explore Guide ‚Üí
                </a>
              </div>
            </div>
          </div>

          <div class="service-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
            <h3 style="color: white; margin: 0 0 15px 0;">üéØ Voice-Specific Prompting Tips</h3>
            <div style="background: rgba(0,0,0,0.2); padding: 20px; border-radius: 8px;">
              <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
                <li><strong>Keep responses SHORT</strong> - Max 2-3 sentences per turn. People can't process long responses in voice.</li>
                <li><strong>Use conversational language</strong> - Write like you talk. Avoid formal or robotic phrasing.</li>
                <li><strong>Set clear personality</strong> - Give your AI a name, role, and consistent tone.</li>
                <li><strong>Define boundaries</strong> - Tell the AI what it CAN'T do (as important as what it can do).</li>
                <li><strong>Provide examples</strong> - Show good/bad response examples in your prompt.</li>
                <li><strong>Handle edge cases</strong> - What if user is angry? Confused? Says "I don't know"?</li>
                <li><strong>Test with real scenarios</strong> - Try your prompt with difficult conversations.</li>
              </ul>
            </div>
          </div>

          <!-- Turn Detection & Semantic VAD Explanation -->
          <div class="service-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            <h3 style="color: white; margin: 0 0 15px 0;">üé§ Turn Detection & Semantic VAD</h3>
            <div style="background: rgba(0,0,0,0.2); padding: 20px; border-radius: 8px;">
              <p style="color: rgba(255,255,255,0.95); line-height: 1.6; margin-bottom: 15px;">
                <strong>Semantic Voice Activity Detection (VAD)</strong> is how the AI knows when the caller has finished speaking and it's time to respond. This is critical for natural conversations.
              </p>

              <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                <h4 style="color: white; margin: 0 0 10px 0;">üîç How It Works:</h4>
                <ul style="margin: 0; padding-left: 20px; line-height: 1.8; color: rgba(255,255,255,0.95);">
                  <li><strong>Traditional VAD:</strong> Detects silence (e.g., 500ms of no audio) ‚Üí Often interrupts mid-sentence</li>
                  <li><strong>Semantic VAD (OpenAI Realtime):</strong> Uses AI to detect <em>meaningful</em> pauses ‚Üí Understands when thought is complete</li>
                </ul>
              </div>

              <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                <h4 style="color: white; margin: 0 0 10px 0;">‚ú® Why Semantic VAD Matters:</h4>
                <p style="margin: 0; color: rgba(255,255,255,0.95); line-height: 1.6;">
                  Caller: "I need to... <em>[brief pause]</em> ...book an appointment for Tuesday"
                </p>
                <ul style="margin: 10px 0 0 0; padding-left: 20px; color: rgba(255,255,255,0.95);">
                  <li>‚ùå <strong>Traditional VAD:</strong> AI interrupts after "I need to..." (thinking silence = done)</li>
                  <li>‚úÖ <strong>Semantic VAD:</strong> AI waits for complete thought, responds after "Tuesday"</li>
                </ul>
              </div>

              <div style="background: rgba(255,212,59,0.2); padding: 15px; border-radius: 6px; border-left: 4px solid #ffd43b;">
                <p style="margin: 0; color: white; line-height: 1.6;">
                  <strong>üí° Pro Tip:</strong> You can influence turn-taking behavior in your system prompt! Add instructions like:
                  <em>"Wait for the caller to finish their complete thought before responding. Don't interrupt natural pauses."</em>
                </p>
              </div>
            </div>
          </div>

          <!-- Stateful Prompt Engineering -->
          <div class="service-card" style="background: linear-gradient(135deg, #61afef 0%, #2c313c 100%); color: white;">
            <h3 style="color: white; margin: 0 0 15px 0;">üß† Stateful Prompt Engineering (Conversation Memory)</h3>
            <div style="background: rgba(0,0,0,0.2); padding: 20px; border-radius: 8px;">
              <p style="color: rgba(255,255,255,0.95); line-height: 1.6; margin-bottom: 15px;">
                Your AI maintains <strong>conversation history</strong> throughout the entire call. Each exchange (caller + AI response) is added to an array and sent with every new request.
              </p>

              <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                <h4 style="color: white; margin: 0 0 10px 0;">üìö How Conversation Memory Works:</h4>
                <pre style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 6px; overflow-x: auto; color: #61afef; font-size: 13px; line-height: 1.6;">
// Every OpenAI API call includes full conversation history
messages: [
  { role: "system", content: "Your system prompt..." },
  { role: "user", content: "Hi, I need an appointment" },
  { role: "assistant", content: "I'd be happy to help! What day works for you?" },
  { role: "user", content: "How about Tuesday?" },
  { role: "assistant", content: "Perfect! What time on Tuesday?" },
  { role: "user", content: "2pm" },  // ‚Üê Current turn
  // AI can reference ALL previous messages when responding
]</pre>
              </div>

              <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                <h4 style="color: white; margin: 0 0 10px 0;">‚úÖ What This Enables:</h4>
                <ul style="margin: 0; padding-left: 20px; line-height: 1.8; color: rgba(255,255,255,0.95);">
                  <li><strong>Context awareness:</strong> AI remembers what was said 5 minutes ago</li>
                  <li><strong>Pronoun resolution:</strong> "Change it to Wednesday" ‚Üí AI knows "it" = appointment</li>
                  <li><strong>Progressive information gathering:</strong> Collect name, then date, then time across multiple turns</li>
                  <li><strong>Conversation repair:</strong> "Actually, I meant Thursday" ‚Üí AI can correct previous information</li>
                  <li><strong>Personalization:</strong> "Hi, I'm Sarah" ‚Üí AI can use "Sarah" for the rest of the call</li>
                </ul>
              </div>

              <div style="background: rgba(255,212,59,0.2); padding: 15px; border-radius: 6px; border-left: 4px solid #ffd43b;">
                <p style="margin: 0 0 10px 0; color: white; line-height: 1.6;">
                  <strong>‚ö†Ô∏è Important Considerations:</strong>
                </p>
                <ul style="margin: 0; padding-left: 20px; color: white; line-height: 1.8;">
                  <li><strong>Token limits:</strong> Very long conversations may exceed context window (~128K tokens for GPT-4o)</li>
                  <li><strong>Cost:</strong> You pay for all tokens in conversation history on every API call</li>
                  <li><strong>Privacy:</strong> Conversation history is stored in memory during the call, cleared when call ends</li>
                </ul>
              </div>

              <div style="background: rgba(152,195,121,0.2); padding: 15px; border-radius: 6px; border-left: 4px solid #98c379;">
                <p style="margin: 0; color: white; line-height: 1.6;">
                  <strong>üí° Pro Tip:</strong> Use your system prompt to tell the AI <em>how</em> to use conversation history effectively:
                  <br><br>
                  <em>"Remember key information from earlier in the conversation (name, dates, preferences). Reference previous statements naturally. If the caller changes their mind, update your understanding gracefully."</em>
                </p>
              </div>
            </div>
          </div>

          <div class="service-card">
            <h3>‚úçÔ∏è Craft Your System Prompt${generatedContent ? ' <span style="color: #98c379; font-size: 14px;">‚ú® AI-Generated for Your Use Case</span>' : ''}</h3>
            <p>${generatedContent ? 'Below is a custom system prompt generated based on your use case description. You can edit it or use it as-is.' : 'Edit the sample prompt below or write your own. This prompt will guide your AI\'s behavior.'}</p>

            <div class="code-editor" style="margin-top: 20px;">
              <div class="code-header">
                <span>üìù System Prompt</span>
                <div style="display: flex; gap: 10px;">
                  <button class="btn-copy" onclick="copySystemPrompt()">üìã Copy</button>
                  <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 13px;" onclick="resetSystemPrompt()">Reset to Sample</button>
                </div>
              </div>
              <textarea class="code-textarea" id="systemPrompt" rows="20" style="font-family: system-ui, -apple-system, sans-serif; font-size: 14px;">${generatedContent?.systemPrompt ? generatedContent.systemPrompt : `You are a helpful assistant.

# Voice Conversation Guidelines
- Keep responses BRIEF (1-2 sentences max)
- Be conversational and natural
- Avoid lists, bullet points, or structured formatting
- Don't say "as an AI" or mention you're artificial
- If you don't know something, say so briefly
- Respond quickly - every second matters in voice
- Use casual language, contractions, and natural speech patterns

# Response Style
- Short and direct
- Friendly but professional
- Natural and human-like

# Example Interactions

GOOD Response:
User: "What's the weather like?"
You: "It's sunny and 72 degrees right now. Perfect day to be outside!"

BAD Response (too long):
User: "What's the weather like?"
You: "Well, let me tell you about the weather today. Currently, the temperature is approximately 72 degrees Fahrenheit with clear, sunny skies. The humidity level is moderate at around 45%, and there's a gentle breeze from the southwest at about 5 miles per hour. Overall, it's a beautiful day with excellent visibility and comfortable conditions."

Remember: In voice conversations, brevity is key. Keep it natural and conversational.`}</textarea>
            </div>

            <div class="button-group" style="margin-top: 15px;">
              <button class="btn btn-success" onclick="saveSystemPrompt()">üíæ Save Prompt</button>
              <button class="btn btn-primary" onclick="scoreSystemPrompt()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">üìä Score This Prompt</button>
            </div>

            <div id="promptScoreDisplay" style="display: none; margin-top: 20px; padding: 25px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; color: white;"></div>
            <div id="systemPromptStatus" class="status-box"></div>
          </div>

          <!-- Welcome Greeting Configuration -->
          <div class="service-card" style="margin-top: 20px;">
            <h3>üëã Welcome Greeting Configuration</h3>
            <p>Control whether your AI greets callers first or waits for them to speak.</p>

            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 15px 0;">
              <label style="display: flex; align-items: center; cursor: pointer; font-size: 15px;">
                <input
                  type="checkbox"
                  id="enableWelcomeGreeting"
                  onchange="toggleWelcomeGreeting()"
                  style="width: 20px; height: 20px; margin-right: 12px; cursor: pointer;"
                />
                <span style="font-weight: 600; color: #0d122b;">Enable Welcome Greeting</span>
              </label>
              <p style="margin: 10px 0 0 32px; font-size: 13px; color: #666;">
                When enabled, the AI will greet callers first. When disabled, the AI waits for the caller to speak.
              </p>
            </div>

            <div id="greetingInputSection" style="margin-top: 15px; display: none;">
              <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #0d122b;">
                Greeting Message
              </label>
              <input
                type="text"
                id="customWelcomeGreeting"
                value="${generatedContent?.ivrGreeting || 'Hello! I am your AI assistant. How can I help you today?'}"
                placeholder="e.g., Hi! Thanks for calling. How can I help you?"
                style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;"
              />
              <p style="font-size: 12px; color: #666; margin-top: 5px;">
                The first message callers will hear when the AI answers the call.
              </p>
            </div>

            <div id="noGreetingNotice" style="margin-top: 15px; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">
              <p style="margin: 0; color: #856404; font-size: 14px;">
                <strong>‚ÑπÔ∏è No Greeting Mode:</strong> The AI will remain silent and wait for the caller to speak first. This is useful for inbound calls where the caller already knows why they're calling.
              </p>
            </div>
          </div>

          <!-- Interactive Test Section -->
          <div class="service-card" style="margin-top: 20px;">
            <h3>üß™ Test Your Prompt Interactively</h3>
            <p style="margin-bottom: 15px;">Try different scenarios to see how your AI responds. Type a message and click Test!</p>

            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 15px;">
              <div style="margin-bottom: 15px;">
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #0d122b;">üí¨ User Message</label>
                <input
                  type="text"
                  id="testMessage"
                  placeholder="${generatedContent?.exampleQuestions?.[0] || 'e.g., Hi, I need to schedule an appointment'}"
                  style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;"
                  onkeypress="if(event.key === 'Enter') testSingleMessage()"
                />
                <div style="margin-top: 8px; font-size: 12px; color: #666;">
                  ${generatedContent?.exampleQuestions ? '‚ú® AI-generated test scenarios based on your use case' : 'üí° Try: greetings, requests, edge cases, or emergencies'}
                </div>
              </div>

              <div style="margin: 0;">
                <button class="btn btn-test" onclick="testSingleMessage()" style="width: 100%;">
                  ‚ñ∂Ô∏è Test Message
                </button>
              </div>
            </div>

            <div class="console-output" id="promptTestConsole" style="display: none;"></div>
          </div>

          <div class="service-card">
            <h3>‚úÖ Quick Prompt Engineering Checklist</h3>
            <p>Before moving to the next step, make sure your system prompt has:</p>
            <div style="display: grid; gap: 10px; margin-top: 15px;">
              <label style="display: flex; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 6px; cursor: pointer;">
                <input type="checkbox" id="checkRole" style="margin-right: 12px; width: 20px; height: 20px;">
                <span>‚úÖ Clear role and name (e.g., "You are Sarah, a medical receptionist")</span>
              </label>
              <label style="display: flex; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 6px; cursor: pointer;">
                <input type="checkbox" id="checkPersonality" style="margin-right: 12px; width: 20px; height: 20px;">
                <span>‚úÖ Defined personality traits (friendly, professional, patient, etc.)</span>
              </label>
              <label style="display: flex; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 6px; cursor: pointer;">
                <input type="checkbox" id="checkResponseLength" style="margin-right: 12px; width: 20px; height: 20px;">
                <span>‚úÖ Response length guidelines (e.g., "under 3 sentences")</span>
              </label>
              <label style="display: flex; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 6px; cursor: pointer;">
                <input type="checkbox" id="checkCapabilities" style="margin-right: 12px; width: 20px; height: 20px;">
                <span>‚úÖ List of capabilities (what tools/actions the AI can perform)</span>
              </label>
              <label style="display: flex; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 6px; cursor: pointer;">
                <input type="checkbox" id="checkWorkflow" style="margin-right: 12px; width: 20px; height: 20px;">
                <span>‚úÖ Step-by-step workflow (numbered process for main tasks)</span>
              </label>
              <label style="display: flex; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 6px; cursor: pointer;">
                <input type="checkbox" id="checkExamples" style="margin-right: 12px; width: 20px; height: 20px;">
                <span>‚úÖ Good/bad examples (show desired vs. undesired responses)</span>
              </label>
              <label style="display: flex; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 6px; cursor: pointer;">
                <input type="checkbox" id="checkBoundaries" style="margin-right: 12px; width: 20px; height: 20px;">
                <span>‚úÖ Clear boundaries (what NOT to do, when to escalate, etc.)</span>
              </label>
            </div>

            <button onclick="completePromptEngineeringStep()" id="completePromptBtn" disabled
                    style="width: 100%; margin-top: 20px; padding: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 600; cursor: not-allowed; opacity: 0.5;">
              ‚úÖ I've Reviewed the Resources - Continue
            </button>
            <div id="promptEngineeringStatus" style="margin-top: 15px;"></div>
          </div>

          <!-- Deploy Custom Prompt - Shows after prompt is saved -->
          <div id="step7DeploySection" style="margin: 30px 0; padding: 25px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; border: 3px solid #5a67d8; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3); display: none;">
            <h3 style="color: white; margin: 0 0 15px 0; font-size: 1.3rem;">üíæ Deploy Your Custom Prompt</h3>
            <p style="color: rgba(255,255,255,0.95); margin-bottom: 20px; line-height: 1.6;">
              Your system prompt looks great! Now deploy it to your WebSocket handler so your AI uses it in conversations.
            </p>

            <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
              <p style="color: white; margin: 0 0 10px 0; font-weight: 600;">üìã What happens when you deploy:</p>
              <ul style="color: rgba(255,255,255,0.9); margin: 0; padding-left: 20px; line-height: 1.8;">
                <li>Updates your WebSocket handler (Step 5) with this system prompt</li>
                <li>Replaces the default prompt with your custom one</li>
                <li>Redeploys the WebSocket handler to ${studentDemoMode || twilioCredentials?.demoMode ? 'demo environment' : 'your Twilio account'}</li>
                <li>Your AI will use this prompt in all future conversations</li>
              </ul>
            </div>

            <button
              class="btn btn-success ${systemPromptSaved && !step7Deployed ? 'next-action' : ''}"
              id="commitStep7Btn"
              onclick="commitStep(7)"
              style="width: 100%; font-size: 1.1rem; padding: 15px 30px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border: none;">
              üíæ Commit Step 7 - Deploy Custom Prompt
            </button>
            <div id="commitStep7Status" style="margin-top: 15px;"></div>
          </div>

          <!-- Test Your AI Voice Bot - Shows after prompt is deployed -->
          <div id="step7VoiceTestSection" style="margin: 30px 0; padding: 25px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 12px; border: 3px solid #047857; box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3); display: ${step7Deployed ? 'block' : 'none'};">
            <h3 style="color: white; margin: 0 0 20px 0; font-size: 1.5rem; text-align: center;">üéâ Your AI Voice Assistant is Ready!</h3>

            <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 20px; border-radius: 8px; margin-bottom: 25px;">
              <h4 style="color: white; margin: 0 0 12px 0; font-size: 1.1rem;">ü§ñ What You'll Experience on This Call:</h4>
              <ul style="margin: 0; padding-left: 20px; color: rgba(255,255,255,0.95); line-height: 1.9;">
                <li><strong>ConversationRelay:</strong> Orchestrates the entire AI conversation flow</li>
                <li><strong>Speech-to-Text (STT):</strong> ${document.getElementById('crTranscriptionProvider')?.value === 'google' ? 'Google Cloud' : 'Deepgram'} transcribes your voice in real-time</li>
                <li><strong>AI Processing:</strong> OpenAI uses YOUR custom prompt to generate intelligent responses</li>
                <li><strong>Text-to-Speech (TTS):</strong> ${getTTSProviderName()} converts the AI's text into natural voice</li>
                <li><strong>Your Custom Personality:</strong> The AI will behave exactly as you defined in your prompt!</li>
              </ul>
            </div>

            <div style="text-align: center;">
              <h4 style="color: white; margin: 0 0 15px 0; font-size: 1.2rem;">üìû Test Your Custom AI Now</h4>
              <p style="color: rgba(255,255,255,0.95); margin-bottom: 20px; font-size: 1rem; line-height: 1.6;">
                ${callDirection === 'inbound' ? 'Call your Twilio number to have a conversation with your AI' : 'Click below to receive a call from your AI assistant'}
              </p>

              <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 20px; border-radius: 8px; margin: 20px 0;">
                ${callDirection === 'inbound' ? `
                  <p style="color: rgba(255,255,255,0.9); margin: 0 0 10px 0; font-size: 0.95rem;">
                    üì± <strong>Call this number to test:</strong>
                  </p>
                  <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-top: 10px;">
                    <div style="font-size: 2rem; font-weight: bold; color: white; font-family: 'Courier New', monospace; letter-spacing: 2px;">
                      ${selectedPhoneNumber || 'Configure phone number in Step 3'}
                    </div>
                    <button
                      onclick="copyPhoneNumber()"
                      style="padding: 10px 20px; background: white; color: #059669; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 1rem; transition: all 0.3s;"
                      onmouseover="this.style.background='#f0fdf4'; this.style.transform='scale(1.05)'"
                      onmouseout="this.style.background='white'; this.style.transform='scale(1)'">
                      üìã Copy
                    </button>
                  </div>
                ` : `
                  <p style="color: rgba(255,255,255,0.9); margin: 0 0 15px 0; font-size: 0.95rem;">
                    üìû <strong>Test your AI bot with an outbound call</strong>
                  </p>
                  <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: white;">
                      Your Phone Number (to receive AI call):
                    </label>
                    <input type="tel" id="testAICallNumber" placeholder="+12345678901" value="${window.savedTestPhoneNumber || ''}"
                           style="width: 100%; padding: 12px; background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.3); border-radius: 6px; font-size: 16px; font-family: 'Courier New', monospace;">
                    <p style="font-size: 12px; color: rgba(255,255,255,0.8); margin: 5px 0 0 0;">Enter YOUR number in E.164 format (e.g., +1234567890)</p>
                  </div>
                  <button onclick="makeAITestCall()" class="btn btn-primary" style="width: 100%; background: white; color: #059669; font-weight: 600; font-size: 1.1rem; padding: 15px;">
                    üìû Call Me Now with AI
                  </button>
                  <div id="aiTestCallStatus" style="margin-top: 15px;"></div>
                  <p style="color: rgba(255,255,255,0.8); margin: 15px 0 0 0; font-size: 0.9rem;">
                    Calling from: <strong style="color: white;">${selectedPhoneNumber || 'No number configured'}</strong>
                  </p>
                `}
              </div>

              <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin-top: 20px; text-align: left;">
                <p style="color: white; margin: 0 0 10px 0; font-weight: 600; font-size: 1rem;">
                  ‚úÖ What to expect:
                </p>
                <ul style="color: rgba(255,255,255,0.9); margin: 0; padding-left: 20px; line-height: 1.8;">
                  <li>AI will use your custom system prompt</li>
                  <li>Natural conversation powered by OpenAI</li>
                  <li>Voice: <strong>${getDefaultVoice()}</strong> (${getTTSProviderName()})</li>
                  <li>Real-time ConversationRelay streaming</li>
                </ul>
              </div>

              <p style="color: rgba(255,255,255,0.85); margin: 20px 0 0 0; font-size: 0.9rem; font-style: italic;">
                üí° Tip: Test the scenarios from your system prompt to verify the AI behaves correctly!
              </p>
            </div>
          </div>

          <div class="button-group">
            <button class="btn btn-secondary" onclick="prevStep()">‚Üê Back</button>
            <button class="btn btn-primary ${step7Deployed ? 'next-action' : ''}" id="nextBtn7" onclick="nextStep()" ${step7Deployed ? '' : 'disabled'}>
              Next: Tools & Functions ‚Üí
            </button>
          </div>
        </div>
      `;
    }

    // systemPromptSaved declared at top of file
    let customSystemPrompt = '';
    let customWelcomeGreeting = ''; // Custom greeting or empty to skip

    // Generate enhanced prompt based on use case when entering Step 7
    function generateEnhancedPrompt() {
      if (!useCaseDescription || !useCaseDescription.trim()) {
        return null; // Use default
      }

      // Create an enhanced prompt structure based on their use case
      const useCase = useCaseDescription.trim();

      return `You are a friendly and professional AI voice assistant.

## Your Role
${useCase}

## Personality & Tone
- Warm and conversational
- Professional but approachable
- Patient and empathetic
- Clear and concise

## Voice Response Style (CRITICAL)
- Keep responses under 2-3 sentences
- Use simple, everyday language
- Speak naturally - like a real person would talk
- Ask one question at a time
- Pause for user responses - don't ramble

## What You CAN Do
- Listen carefully and understand user needs
- Provide helpful, accurate information
- Guide users through simple processes
- Answer questions clearly and briefly
- Be proactive and helpful

## What You CANNOT Do
- Give advice outside your defined role
- Make decisions on behalf of the user
- Handle sensitive personal/medical/financial matters without proper context
- Provide extremely long explanations (remember: this is voice, not text!)

## Example Interactions

GOOD Response (Brief & Natural):
User: "Can you help me with this?"
You: "Of course! What do you need help with?"

BAD Response (Too Long):
User: "Can you help me with this?"
You: "Absolutely! I'd be more than happy to assist you with whatever you need help with today. I'm here to provide support and answer any questions you might have. Please feel free to tell me more about what you're looking for and I'll do my best to guide you through the process and make sure you get exactly what you need."

## Important Guidelines
- If unsure, ask for clarification rather than guessing
- Be honest if you can't help with something
- End conversations naturally when appropriate
- Always be respectful and patient`;
    }

    const defaultSystemPrompt = `You are a helpful assistant.

# Voice Conversation Guidelines
- Keep responses BRIEF (1-2 sentences max)
- Be conversational and natural
- Avoid lists, bullet points, or structured formatting
- Don't say "as an AI" or mention you're artificial
- If you don't know something, say so briefly
- Respond quickly - every second matters in voice
- Use casual language, contractions, and natural speech patterns

# Response Style
- Short and direct
- Friendly but professional
- Natural and human-like

# Example Interactions

GOOD Response:
User: "What's the weather like?"
You: "It's sunny and 72 degrees right now. Perfect day to be outside!"

BAD Response (too long):
User: "What's the weather like?"
You: "Well, let me tell you about the weather today. Currently, the temperature is approximately 72 degrees Fahrenheit with clear, sunny skies. The humidity level is moderate at around 45%, and there's a gentle breeze from the southwest at about 5 miles per hour. Overall, it's a beautiful day with excellent visibility and comfortable conditions."

Remember: In voice conversations, brevity is key. Keep it natural and conversational.`;

    function toggleWelcomeGreeting() {
      const enabled = document.getElementById('enableWelcomeGreeting')?.checked;
      const greetingSection = document.getElementById('greetingInputSection');
      const noGreetingNotice = document.getElementById('noGreetingNotice');

      if (enabled) {
        greetingSection.style.display = 'block';
        noGreetingNotice.style.display = 'none';
      } else {
        greetingSection.style.display = 'none';
        noGreetingNotice.style.display = 'block';
      }
    }

    function saveSystemPrompt() {
      const prompt = document.getElementById('systemPrompt')?.value || '';
      if (prompt.trim().length < 50) {
        showStatus('systemPromptStatus', 'error', '‚ùå Prompt is too short. Add more detail about your AI\'s role and behavior.');
        return;
      }

      customSystemPrompt = prompt;

      // Save welcome greeting settings
      const greetingEnabled = document.getElementById('enableWelcomeGreeting')?.checked;
      const greetingText = document.getElementById('customWelcomeGreeting')?.value || '';

      // Store greeting configuration
      if (greetingEnabled && greetingText.trim()) {
        customWelcomeGreeting = greetingText.trim();
      } else {
        customWelcomeGreeting = ''; // Empty = no greeting
      }

      systemPromptSaved = true;
      promptEngineeringComplete = true; // Mark prompt engineering as complete
      showStatus('systemPromptStatus', 'success', '‚úÖ System prompt and greeting settings saved!');
      saveProgressToStorage();
      updateProgressBar(); // Update progress bar immediately

      // Clear all existing next-action highlights first
      document.querySelectorAll('.next-action').forEach(el => {
        el.classList.remove('next-action');
      });

      // Enable Next button immediately - deployment is optional
      const nextBtn = document.getElementById('nextBtn7'); // Fixed: Step 7 uses nextBtn7, not nextBtn9
      if (nextBtn) {
        nextBtn.disabled = false;
        // Add next-action to Next button since it's the recommended next step
        nextBtn.classList.add('next-action');
      }

      // Show the deploy section (but don't highlight commit button - next button is better choice)
      const deploySection = document.getElementById('step7DeploySection');
      if (deploySection) {
        deploySection.style.display = 'block';

        setTimeout(() => {
          deploySection.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 300);
      }
    }

    async function scoreSystemPrompt() {
      const prompt = document.getElementById('systemPrompt')?.value || '';
      const scoreDisplay = document.getElementById('promptScoreDisplay');

      if (prompt.trim().length < 50) {
        showStatus('systemPromptStatus', 'error', '‚ùå Prompt is too short. Add more detail before scoring.');
        return;
      }

      if (!openaiApiKey && !studentDemoMode && !twilioCredentials?.demoMode) {
        showStatus('systemPromptStatus', 'error', '‚ùå OpenAI API key required. Please configure it in Step 5.');
        return;
      }

      // Show loading state
      scoreDisplay.style.display = 'block';
      scoreDisplay.innerHTML = `
        <div style="text-align: center;">
          <div style="font-size: 24px; margin-bottom: 10px;">‚è≥</div>
          <div style="font-size: 16px;">Analyzing your prompt...</div>
          <div style="font-size: 14px; opacity: 0.8; margin-top: 5px;">This may take 10-15 seconds</div>
        </div>
      `;
      showStatus('systemPromptStatus', 'info', '‚è≥ Analyzing prompt quality...');

      try {
        // DEMO MODE: Return fake score without calling OpenAI
        if (studentDemoMode || twilioCredentials?.demoMode) {
          await new Promise(resolve => setTimeout(resolve, 1500)); // Simulate delay

          const demoScoreData = {
            score: 82,
            grade: "Good",
            strengths: [
              "Clear role definition and personality traits",
              "Good use of conversational language for voice",
              "Well-structured with organized sections"
            ],
            improvements: [
              "Add more specific examples of ideal responses",
              "Include clearer boundaries for out-of-scope topics",
              "Consider adding response length guidelines"
            ],
            summary: "This is a solid prompt with good fundamentals. The AI's role and personality are well-defined, making it suitable for production use with minor refinements."
          };

          // Determine color based on score
          let scoreColor = '#3b82f6'; // blue for "Good"

          scoreDisplay.innerHTML = `
            <div style="text-align: center; margin-bottom: 25px;">
              <div style="font-size: 72px; font-weight: bold; margin-bottom: 10px; color: ${scoreColor}; text-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                ${demoScoreData.score}
              </div>
              <div style="font-size: 24px; font-weight: 600; margin-bottom: 5px;">
                ${demoScoreData.grade}
              </div>
              <div style="font-size: 14px; opacity: 0.9;">
                ${demoScoreData.summary}
              </div>
              <div style="font-size: 12px; opacity: 0.7; margin-top: 10px; font-style: italic;">
                üìù Demo Mode: Sample scoring result
              </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
              <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 20px; border-radius: 8px;">
                <div style="font-size: 18px; font-weight: 600; margin-bottom: 12px;">‚úÖ Strengths</div>
                <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
                  ${demoScoreData.strengths.map(s => `<li>${s}</li>`).join('')}
                </ul>
              </div>
              <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 20px; border-radius: 8px;">
                <div style="font-size: 18px; font-weight: 600; margin-bottom: 12px;">üí° Improvements</div>
                <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
                  ${demoScoreData.improvements.map(i => `<li>${i}</li>`).join('')}
                </ul>
              </div>
            </div>
          `;

          showStatus('systemPromptStatus', 'success', '‚úÖ Prompt scored successfully! (Demo Mode)');
          return;
        }

        // LIVE MODE: Create a scoring request using the criteria from the page
        const scoringPrompt = `You are an expert AI prompt engineer specializing in voice AI systems. Analyze the following system prompt for a voice AI assistant and provide:

1. An overall quality score from 1-100
2. Specific feedback on these criteria:
   - Role clarity (Does it clearly define the AI's name and role?)
   - Personality traits (Are personality traits well-defined?)
   - Response length guidelines (Are there clear instructions to keep responses short for voice?)
   - Capabilities (What the AI CAN do - are they clearly listed?)
   - Boundaries (What the AI CANNOT do - are limitations clear?)
   - Examples (Are there good/bad response examples?)
   - Voice-appropriate language (Is the language conversational and suitable for voice?)

Scoring rubric:
- 90-100: Excellent - Professional-grade prompt ready for production
- 75-89: Good - Solid prompt with minor improvements needed
- 60-74: Fair - Usable but needs significant improvements
- 40-59: Poor - Major gaps that will cause problems
- 0-39: Inadequate - Needs complete rewrite

Format your response EXACTLY as JSON:
{
  "score": <number 1-100>,
  "grade": "<Excellent|Good|Fair|Poor|Inadequate>",
  "strengths": ["<strength 1>", "<strength 2>", ...],
  "improvements": ["<improvement 1>", "<improvement 2>", ...],
  "summary": "<2-3 sentence overall assessment>"
}

System Prompt to Analyze:
${prompt}`;

        const response = await fetch('/api/tutorial-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'testOpenAI',
            systemPrompt: 'You are a helpful assistant that responds only with valid JSON.',
            message: scoringPrompt,
            openaiApiKey: openaiApiKey,
            demoMode: studentDemoMode || twilioCredentials?.demoMode
          })
        });

        const data = await response.json();

        if (data.success) {
          // Parse the JSON response from OpenAI
          let scoreData;
          try {
            // Extract JSON from response (in case it's wrapped in markdown code blocks or has extra text)
            let jsonText = data.response.trim();

            // Remove markdown code blocks
            if (jsonText.startsWith('```json')) {
              jsonText = jsonText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
            } else if (jsonText.startsWith('```')) {
              jsonText = jsonText.replace(/```\n?/g, '').trim();
            }

            // Try to extract JSON object if there's surrounding text
            const jsonMatch = jsonText.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
              jsonText = jsonMatch[0];
            }

            scoreData = JSON.parse(jsonText);

            // Validate that required fields exist
            if (!scoreData.score || !scoreData.grade || !scoreData.strengths || !scoreData.improvements || !scoreData.summary) {
              throw new Error('Missing required fields in response');
            }
          } catch (parseError) {
            console.error('Failed to parse OpenAI response:', data.response);
            console.error('Parse error:', parseError);
            showStatus('systemPromptStatus', 'error', '‚ùå Scoring failed: Unable to parse AI response. Please try again.');
            scoreDisplay.style.display = 'none';
            return;
          }

          // Determine color based on score
          let scoreColor = '#10b981'; // green
          if (scoreData.score < 60) scoreColor = '#ef4444'; // red
          else if (scoreData.score < 75) scoreColor = '#f59e0b'; // orange
          else if (scoreData.score < 90) scoreColor = '#3b82f6'; // blue

          // Display the score
          scoreDisplay.innerHTML = `
            <div style="text-align: center; margin-bottom: 25px;">
              <div style="font-size: 72px; font-weight: bold; margin-bottom: 10px; color: ${scoreColor}; text-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                ${scoreData.score}
              </div>
              <div style="font-size: 24px; font-weight: 600; margin-bottom: 5px;">
                ${scoreData.grade}
              </div>
              <div style="font-size: 14px; opacity: 0.9;">
                ${scoreData.summary}
              </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
              <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 20px; border-radius: 8px;">
                <div style="font-size: 18px; font-weight: 600; margin-bottom: 12px;">‚úÖ Strengths</div>
                <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
                  ${scoreData.strengths.map(s => `<li>${s}</li>`).join('')}
                </ul>
              </div>
              <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 20px; border-radius: 8px;">
                <div style="font-size: 18px; font-weight: 600; margin-bottom: 12px;">üí° Improvements</div>
                <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
                  ${scoreData.improvements.map(i => `<li>${i}</li>`).join('')}
                </ul>
              </div>
            </div>

            <div style="margin-top: 20px; text-align: center; font-size: 13px; opacity: 0.8;">
              üí° Tip: Aim for 90+ for production use. Revise your prompt and score again!
            </div>
          `;

          showStatus('systemPromptStatus', 'success', `‚úÖ Score: ${scoreData.score}/100 - ${scoreData.grade}`);
        } else {
          throw new Error(data.error || 'Unknown error');
        }

      } catch (error) {
        scoreDisplay.style.display = 'none';
        showStatus('systemPromptStatus', 'error', `‚ùå Scoring failed: ${error.message}`);
        console.error('Prompt scoring error:', error);
      }
    }

    function resetSystemPrompt() {
      document.getElementById('systemPrompt').value = defaultSystemPrompt;
      showStatus('systemPromptStatus', 'info', '‚ÑπÔ∏è Reset to sample prompt. Edit it to match your use case!');
    }

    function copySystemPrompt() {
      const prompt = document.getElementById('systemPrompt').value;
      navigator.clipboard.writeText(prompt).then(() => {
        showStatus('systemPromptStatus', 'success', '‚úÖ Prompt copied to clipboard!');
      }).catch(() => {
        showStatus('systemPromptStatus', 'error', '‚ùå Failed to copy. Please select and copy manually.');
      });
    }

    // Test with a single user message
    async function testSingleMessage() {
      const prompt = document.getElementById('systemPrompt')?.value || '';
      const userMessage = document.getElementById('testMessage')?.value.trim();
      const console = document.getElementById('promptTestConsole');

      if (!openaiApiKey && !studentDemoMode && !twilioCredentials?.demoMode) {
        showStatus('systemPromptStatus', 'error', '‚ùå OpenAI API key required. Please configure it in Step 5.');
        return;
      }

      if (prompt.trim().length < 50) {
        showStatus('systemPromptStatus', 'error', '‚ùå Prompt is too short. Save your prompt first.');
        return;
      }

      if (!userMessage) {
        showStatus('systemPromptStatus', 'error', '‚ùå Please enter a message to test.');
        return;
      }

      console.style.display = 'block';
      console.innerHTML = `<div class="console-line">üí¨ Testing: "${userMessage}"</div>`;
      showStatus('systemPromptStatus', 'info', '‚è≥ Sending to AI...');

      try {
        // DEMO MODE: Return fake response without calling OpenAI
        if (studentDemoMode || twilioCredentials?.demoMode) {
          await new Promise(resolve => setTimeout(resolve, 800)); // Simulate delay

          const demoResponses = [
            "Thank you for contacting us! I'd be happy to help you with that. Could you provide me with a bit more information?",
            "I understand your request. Let me assist you with that right away.",
            "That's a great question! Based on your needs, I recommend the following approach.",
            "I appreciate you reaching out. I'm here to help make this process as smooth as possible for you."
          ];

          const randomResponse = demoResponses[Math.floor(Math.random() * demoResponses.length)];

          console.innerHTML += `<div class="console-line success">ü§ñ AI Response: "${randomResponse}"</div>`;
          console.innerHTML += `<div class="console-line info" style="font-style: italic; opacity: 0.8;">üìù Demo Mode: Sample AI response</div>`;
          showStatus('systemPromptStatus', 'success', '‚úÖ Test complete! (Demo Mode)');

          // Clear input for next test
          document.getElementById('testMessage').value = '';
          return;
        }

        // LIVE MODE: Call OpenAI
        const response = await fetch('/api/tutorial-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'testOpenAI',
            systemPrompt: prompt,
            message: userMessage,
            openaiApiKey: openaiApiKey,
            demoMode: false
          })
        });

        const data = await response.json();

        if (data.success) {
          console.innerHTML += `<div class="console-line success">ü§ñ AI Response: "${data.response}"</div>`;
          showStatus('systemPromptStatus', 'success', '‚úÖ Test complete!');

          // Clear input for next test
          document.getElementById('testMessage').value = '';
        } else {
          console.innerHTML += `<div class="console-line error">‚ùå Error: ${data.error}</div>`;
          showStatus('systemPromptStatus', 'error', `‚ùå Test failed: ${data.error}`);
        }

      } catch (error) {
        console.innerHTML += `<div class="console-line error">‚ùå Test failed: ${error.message}</div>`;
        showStatus('systemPromptStatus', 'error', `‚ùå Test failed: ${error.message}`);
      }
    }

    // Run predefined test scenarios
    async function runPredefinedTests() {
      const prompt = document.getElementById('systemPrompt')?.value || '';
      const console = document.getElementById('promptTestConsole');

      if (!openaiApiKey && !studentDemoMode && !twilioCredentials?.demoMode) {
        showStatus('systemPromptStatus', 'error', '‚ùå OpenAI API key required. Please configure it in Step 5.');
        return;
      }

      if (prompt.trim().length < 50) {
        showStatus('systemPromptStatus', 'error', '‚ùå Prompt is too short. Add more detail first.');
        return;
      }

      console.style.display = 'block';
      console.innerHTML = '<div class="console-line">üß™ Running 3 preset test scenarios...</div>';
      showStatus('systemPromptStatus', 'info', '‚è≥ Testing...');

      // Use AI-generated example questions if available, otherwise use defaults
      const defaultTestScenarios = [
        { user: "Hi, I need to schedule an appointment.", expected: "Should be friendly, ask about type of visit, keep it short" },
        { user: "What are your hours?", expected: "Should provide hours concisely" },
        { user: "I am having chest pain right now!", expected: "Should recognize emergency and direct to 911" }
      ];

      const defaultDemoResponses = [
        "Hello! I'd be happy to help you schedule an appointment. What type of visit do you need - a general checkup or consultation for a specific concern?",
        "We're open Monday through Friday from 8am to 6pm, and Saturdays from 9am to 2pm. Would you like to schedule an appointment?",
        "This sounds like a medical emergency. Please hang up and call 911 immediately or go to your nearest emergency room. Your safety is the top priority."
      ];

      let testScenarios = defaultTestScenarios;
      let demoResponsesForScenarios = defaultDemoResponses;

      // If we have AI-generated example questions, use those instead
      if (generatedContent?.exampleQuestions && generatedContent.exampleQuestions.length >= 3) {
        testScenarios = generatedContent.exampleQuestions.slice(0, 3).map((question, idx) => ({
          user: question,
          expected: `AI-generated test scenario ${idx + 1} based on your use case`
        }));

        // For demo mode, we'll generate simple responses
        demoResponsesForScenarios = generatedContent.exampleQuestions.slice(0, 3).map(question =>
          `[Demo response for: "${question}"] I understand you're asking about ${question.toLowerCase()}. Let me help you with that.`
        );
      }

      try {
        for (let i = 0; i < testScenarios.length; i++) {
          const scenario = testScenarios[i];
          console.innerHTML += `<div class="console-line info">
üìù Test ${i + 1}: "${scenario.user}"
Expected: ${scenario.expected}</div>`;

          // DEMO MODE: Use fake responses
          if (studentDemoMode || twilioCredentials?.demoMode) {
            await new Promise(resolve => setTimeout(resolve, 600)); // Simulate delay
            const demoResponse = demoResponsesForScenarios[i];
            console.innerHTML += `<div class="console-line success">ü§ñ AI: "${demoResponse}"</div>`;
            continue;
          }

          // LIVE MODE: Call OpenAI
          const response = await fetch('/api/tutorial-proxy', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              action: 'testOpenAI',
              systemPrompt: prompt,
              message: scenario.user,
              openaiApiKey: openaiApiKey,
              demoMode: false
            })
          });

          const data = await response.json();

          if (data.success) {
            console.innerHTML += `<div class="console-line success">ü§ñ AI: "${data.response}"</div>`;
          } else {
            console.innerHTML += `<div class="console-line error">‚ùå Error: ${data.error}</div>`;
          }
        }

        const demoNote = (studentDemoMode || twilioCredentials?.demoMode) ? ' <span style="font-style: italic; opacity: 0.8;">(Demo Mode)</span>' : '';
        console.innerHTML += `<div class="console-line success">‚úÖ All tests complete!${demoNote} Review the responses above and refine your prompt if needed.</div>`;
        showStatus('systemPromptStatus', 'success', `‚úÖ Tests complete!${demoNote ? ' (Demo Mode)' : ''} Review the AI responses in the console above.`);

      } catch (error) {
        console.innerHTML += `<div class="console-line error">‚ùå Test failed: ${error.message}</div>`;
        showStatus('systemPromptStatus', 'error', `‚ùå Test failed: ${error.message}`);
      }
    }

    async function completePromptEngineeringStep() {
      if (!systemPromptSaved) {
        showStatus('promptEngineeringStatus', 'warning', '‚ö†Ô∏è Please save your system prompt before continuing.');
        return;
      }

      // Save student config to database for shared WebSocket server
      if (!studentDemoMode && !twilioCredentials?.demoMode) {
        try {
          showStatus('promptEngineeringStatus', 'info', 'üíæ Saving your AI configuration...');

          // Save to database
          const response = await fetch('/api/student-config-save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              sessionToken: sessionToken,
              studentName: studentName || githubUsername || 'Student',
              openaiApiKey: openaiApiKey,
              systemPrompt: customSystemPrompt,
              tools: [], // TODO: Add tools when Step 8 is implemented
              voiceSettings: {
                provider: ttsProvider,
                voice: conversationRelayVoice
              }
            })
          });

          const data = await response.json();

          if (!data.success) {
            console.error('Failed to save config:', data.error);
            showStatus('promptEngineeringStatus', 'warning', '‚ö†Ô∏è Config saved locally, but server sync failed. Your WebSocket will still work!');
          } else {
            console.log('‚úÖ Student config saved to database');
          }

          // Also update their GitHub repo with the system prompt
          if (githubToken && githubUsername && studentRepoName) {
            showStatus('promptEngineeringStatus', 'info', 'üì¶ Updating your GitHub code...');

            const updateResponse = await fetch('/api/github-update-prompt', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                githubToken: githubToken,
                githubUsername: githubUsername,
                repoName: studentRepoName,
                systemPrompt: customSystemPrompt
              })
            });

            const updateData = await updateResponse.json();

            if (updateData.success) {
              console.log('‚úÖ GitHub repo updated with system prompt');
            } else {
              console.warn('‚ö†Ô∏è GitHub update failed:', updateData.error);
            }
          }
        } catch (error) {
          console.error('Error saving config:', error);
          // Don't block the user - config will be saved on next attempt
        }
      }

      promptEngineeringComplete = true;
      showStatus('promptEngineeringStatus', 'success', '‚úÖ Perfect! Your AI is configured and ready. Test it with a real voice call below.');

      // Reveal the voice test section
      const voiceTestSection = document.getElementById('step7VoiceTestSection');
      if (voiceTestSection) {
        voiceTestSection.style.display = 'block';
        setTimeout(() => {
          voiceTestSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }, 300);
      }

      // Enable Next button
      document.getElementById('nextBtn7').disabled = false;
      saveProgressToStorage();
    }

    // Enable "Complete" button when at least 4 checkboxes are checked
    document.addEventListener('change', (e) => {
      if (e.target.type === 'checkbox' && e.target.id && e.target.id.startsWith('check')) {
        const checkboxes = document.querySelectorAll('input[type="checkbox"][id^="check"]');
        const checked = Array.from(checkboxes).filter(cb => cb.checked).length;
        const completeBtn = document.getElementById('completePromptBtn');
        if (completeBtn) {
          if (checked >= 4) {
            completeBtn.disabled = false;
            completeBtn.style.opacity = '1';
            completeBtn.style.cursor = 'pointer';
          } else {
            completeBtn.disabled = true;
            completeBtn.style.opacity = '0.5';
            completeBtn.style.cursor = 'not-allowed';
          }
        }
      }
    });

    // =========================================================================
    // STEP 8: TOOLING & KNOWLEDGE BASE - Add Functions and Context
    // =========================================================================

    function renderStep_Tooling() {
      const step = steps[currentStep];
      return `
        <div class="step-content active">
          <div class="step-header">
            <h2>Step ${step.id}: ${step.title}</h2>
            <p>Enhance your AI with custom functions and domain knowledge</p>
          </div>

          <div class="instructions">
            <h3>üõ†Ô∏è What This Step Covers</h3>
            <p>Before we move to AI-powered conversations, you can optionally add:</p>
            <ul style="margin-left: 20px; line-height: 1.8;">
              <li><strong>Tools/Functions</strong> - Let your AI take actions (check calendar, book appointments, look up data)</li>
              <li><strong>Knowledge Base</strong> - Give your AI context about your business, products, or services</li>
            </ul>
            <p style="margin-top: 15px;">
              üìö <strong>Documentation:</strong>
              <a href="https://platform.openai.com/docs/guides/function-calling" target="_blank">OpenAI Function Calling</a> |
              <a href="https://platform.openai.com/docs/guides/realtime" target="_blank">Realtime API</a>
            </p>
          </div>

          <!-- How Function Calling Works Section -->
          <div class="service-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-bottom: 30px;">
            <h3 style="color: white; margin-bottom: 20px;">üîÑ How Function Calling Works in Voice AI</h3>
            <p style="color: rgba(255,255,255,0.95); line-height: 1.6; margin-bottom: 20px;">
              Understanding the complete flow from caller speech to function execution:
            </p>

            <div style="background: rgba(0,0,0,0.2); padding: 25px; border-radius: 12px; font-family: monospace; font-size: 13px; line-height: 2;">
              <pre style="margin: 0; color: rgba(255,255,255,0.95); white-space: pre-wrap;">
<strong style="color: #ffd43b;">1. üìû Caller speaks:</strong> "I'd like to book an appointment for tomorrow at 2pm"

<strong style="color: #ffd43b;">2. üé§ ConversationRelay (Speech-to-Text):</strong>
   Twilio's STT converts audio ‚Üí text transcript
   ‚Üí Sends to your WebSocket handler

<strong style="color: #ffd43b;">3. üß† Your WebSocket receives transcript:</strong>
   {
     event: "media",
     transcript: "I'd like to book an appointment for tomorrow at 2pm"
   }

<strong style="color: #ffd43b;">4. üí¨ Send to OpenAI with tools defined:</strong>
   POST https://api.openai.com/v1/chat/completions
   {
     model: "gpt-4",
     messages: [
       { role: "system", content: "You are a helpful receptionist..." },
       { role: "user", content: "I'd like to book..." }
     ],
     tools: [
       { name: "check_availability", ... },
       { name: "book_appointment", ... },
       { name: "send_sms", ... }
     ]
   }

<strong style="color: #ffd43b;">5. ü§ñ OpenAI decides:</strong>
   AI analyzes the conversation and determines:
   - Does this require a function call?
   - Which function(s) to call?
   - What parameters to pass?

   <strong style="color: #98c379;">Response A (Text Only):</strong> If no function needed
   {
     choices: [{
       message: {
         role: "assistant",
         content: "Sure! What date works best for you?"
       }
     }]
   }
   ‚Üí Skip to step 7

   <strong style="color: #e5c07b;">Response B (Function Call):</strong> If function needed
   {
     choices: [{
       message: {
         role: "assistant",
         content: null,
         tool_calls: [{
           id: "call_abc123",
           type: "function",
           function: {
             name: "check_availability",
             arguments: '{"date": "2025-10-22"}'
           }
         }]
       }
     }]
   }
   ‚Üí Continue to step 6

<strong style="color: #ffd43b;">6. ‚öôÔ∏è Your code executes the function:</strong>
   const functionName = toolCall.function.name;
   const args = JSON.parse(toolCall.function.arguments);

   switch(functionName) {
     case 'check_availability':
       result = await checkAvailability(args);  // Your implementation
       break;
     case 'book_appointment':
       result = await bookAppointment(args);
       break;
     case 'send_sms':
       result = await sendSMS(args, twilioClient);
       break;
   }

   // Result example:
   {
     success: true,
     slots: ["9:00 AM", "11:00 AM", "2:00 PM"],
     message: "Found 3 available slots"
   }

<strong style="color: #ffd43b;">7. üîÅ Send function result back to OpenAI:</strong>
   POST https://api.openai.com/v1/chat/completions
   {
     messages: [
       ...previous messages...,
       { role: "assistant", tool_calls: [...] },
       {
         role: "tool",
         tool_call_id: "call_abc123",
         content: '{"success":true,"slots":["9:00 AM","11:00 AM","2:00 PM"]}'
       }
     ]
   }

<strong style="color: #ffd43b;">8. ü§ñ OpenAI generates natural response:</strong>
   AI converts function result into conversational response:
   {
     choices: [{
       message: {
         content: "Great! I have availability tomorrow at 9am, 11am,
                   and 2pm. Which time works best for you?"
       }
     }]
   }

<strong style="color: #ffd43b;">9. üîä Text-to-Speech (TTS):</strong>
   ConversationRelay converts text ‚Üí audio
   ‚Üí Plays to caller

<strong style="color: #ffd43b;">10. üîÑ Repeat:</strong>
   Caller responds ‚Üí Back to step 1
   (Loop continues until call ends)
              </pre>
            </div>

            <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 8px; margin-top: 20px;">
              <h4 style="color: white; margin-bottom: 15px;">üí° Key Insights</h4>
              <ul style="color: rgba(255,255,255,0.95); line-height: 1.8;">
                <li><strong>AI decides when to call functions</strong> - You don't write if/else logic; the AI determines based on conversation context</li>
                <li><strong>Multiple function calls possible</strong> - AI can chain calls: check_availability ‚Üí book_appointment ‚Üí send_sms</li>
                <li><strong>Functions return structured data</strong> - Always return JSON that the AI can understand</li>
                <li><strong>AI translates results to speech</strong> - Function returns data, AI makes it conversational</li>
                <li><strong>Conversation history is maintained</strong> - Each exchange is added to the message array</li>
              </ul>
            </div>
          </div>

          <div class="service-card" style="background: linear-gradient(135deg, #61afef 0%, #2c313c 100%);">
            <h3 style="color: white; margin-bottom: 15px;">üîß Production-Ready WebSocket Handler with Tools</h3>
            <p style="color: #e5e5e5;">Complete implementation with appointment booking, knowledge base, and SMS notifications:</p>
          </div>

          <div class="code-editor">
            <div class="code-header">
              <span>üìù WebSocket Handler with Tools & Knowledge Base</span>
              <div style="display: flex; gap: 10px;">
                <button class="btn btn-success ${toolsConfigured ? '' : 'next-action'}" style="padding: 6px 12px; font-size: 13px; ${toolsConfigured ? 'opacity: 0.5;' : ''}" onclick="validateCode9()" ${toolsConfigured ? 'disabled' : ''}>‚úì Validate</button>
                <button class="btn-copy" onclick="copyCode('code9')">üìã Copy Code</button>
                <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 13px;" onclick="resetCode9()">Reset</button>
              </div>
            </div>
            <textarea class="code-textarea" id="code9" rows="30" oninput="handleCodeChange('code9')">exports.handler = async function(context, event, callback) {
  const OpenAI = require('openai');
  const twilio = require('twilio');

  const openai = new OpenAI({ apiKey: context.OPENAI_API_KEY });
  const twilioClient = twilio(context.ACCOUNT_SID, context.AUTH_TOKEN);

  const response = new Twilio.Response();
  response.setStatusCode(200);

  // Knowledge Base - Customize for your business
  const knowledgeBase = '\\n' +
  '  Company: Acme Healthcare\\n' +
  '  Services: Primary care, vaccinations, annual checkups, lab work\\n' +
  '  Hours: Mon-Fri 9am-5pm, Sat 10am-2pm, Closed Sunday\\n' +
  '  Location: 123 Main St, San Francisco CA 94102\\n' +
  '  Phone: ' + (context.DEFAULT_TWILIO_NUMBER || '+1-555-0100') + '\\n' +
  '  Insurance: We accept Blue Cross, Aetna, UnitedHealthcare, Medicare\\n' +
  '  Parking: Free parking available in rear lot\\n';

  // Tool Definitions
  const tools = [
    {
      type: "function",
      name: "check_availability",
      description: "Check available appointment slots for a given date",
      parameters: {
        type: "object",
        properties: {
          date: { type: "string", description: "Date (YYYY-MM-DD)" }
        },
        required: ["date"]
      }
    },
    {
      type: "function",
      name: "book_appointment",
      description: "Book an appointment for a customer",
      parameters: {
        type: "object",
        properties: {
          date: { type: "string", description: "Date (YYYY-MM-DD)" },
          time: { type: "string", description: "Time (HH:MM 24hr)" },
          customerName: { type: "string", description: "Customer name" },
          phone: { type: "string", description: "Phone number" },
          service: { type: "string", description: "Service type" }
        },
        required: ["date", "time", "customerName", "phone"]
      }
    },
    {
      type: "function",
      name: "send_confirmation_sms",
      description: "Send appointment confirmation via SMS",
      parameters: {
        type: "object",
        properties: {
          phone: { type: "string", description: "Customer phone" },
          message: { type: "string", description: "Confirmation message" }
        },
        required: ["phone", "message"]
      }
    }
  ];

  // System Prompt - Critical for AI behavior!
  // Best practices: Be specific, set boundaries, define personality
  const systemPrompt = \`You are Sarah, a professional medical receptionist for Acme Healthcare.

ROLE & PERSONALITY:
- Friendly but professional tone
- Speak naturally, use conversational language
- Show empathy and patience
- Keep responses concise (under 3 sentences typically)

COMPANY INFORMATION:
\${knowledgeBase}

YOUR CAPABILITIES:
You have access to three tools:
1. check_availability - Check open appointment slots for a date
2. book_appointment - Book confirmed appointments
3. send_confirmation_sms - Send SMS confirmations

WORKFLOW FOR BOOKING:
1. Greet caller warmly and ask how you can help
2. If booking, collect: preferred date, time, name, phone, service type
3. Use check_availability to see open slots (say "Let me check that for you" first)
4. Confirm ALL details before booking
5. Use book_appointment once confirmed (say "I'm booking that for you now" first)
6. Use send_confirmation_sms to send confirmation
7. Provide appointment details verbally AND via SMS

IMPORTANT GUIDELINES:
- ALWAYS confirm date, time, name, and phone before booking
- Use interstitials before tool calls ("Let me check...", "One moment...")
- If caller is vague, ask clarifying questions
- If no slots available, offer alternative dates
- Keep HIPAA in mind - don't ask for sensitive medical info over phone
- If you can't help, offer to transfer or take a message
- End calls gracefully, ask if there's anything else

RESPONSE STYLE:
‚ùå DON'T: "I have checked the availability for the requested date and determined that..."
‚úÖ DO: "Let me check that for you... Great! We have openings at 9am, 11am, and 2pm. Which works best?"

Remember: You're having a natural conversation, not reading a script!\`;

  // Handle WebSocket upgrade
  if (!event.request || event.request.headers['upgrade'] !== 'websocket') {
    response.setBody('WebSocket connection required');
    return callback(null, response);
  }

  const ws = event.request;
  console.log('WebSocket connected');

  // STATE MANAGEMENT - Track where we are in the conversation
  let conversationState = {
    stage: 'greeting',           // greeting, collecting_info, confirming, booking, complete
    appointmentData: {},         // Store collected information
    lastPrompt: null,            // Track what we last asked
    attemptCount: 0              // How many times we've tried to collect info
  };

  // Store conversation history
  const conversationHistory = [{ role: 'system', content: systemPrompt }];

  // STATE-AWARE PROMPT INJECTION
  // This function adds context based on current state
  function getStateContext() {
    const statePrompts = {
      greeting: \`
        CURRENT STATE: Greeting/Initial Contact
        - You just answered the call
        - Ask how you can help today
        - Listen for booking requests or questions
      \`,
      collecting_info: \`
        CURRENT STATE: Collecting Appointment Information
        - You're gathering: date, time, name, phone, service type
        - Current data collected: \${JSON.stringify(conversationState.appointmentData)}
        - Still need: \${getMissingFields().join(', ') || 'nothing - ready to confirm!'}
        - Ask for ONE missing field at a time (don't overwhelm caller)
        - Attempt #\${conversationState.attemptCount} - if > 2, offer to have someone call them back
      \`,
      confirming: \`
        CURRENT STATE: Confirming Details
        - You have all information needed
        - Data to confirm: \${JSON.stringify(conversationState.appointmentData)}
        - Read back ALL details clearly
        - Ask "Does that sound correct?" or "Should I book this for you?"
        - If confirmed, proceed to booking
        - If changes needed, go back to collecting_info
      \`,
      booking: \`
        CURRENT STATE: Booking in Progress
        - You're actively booking the appointment
        - Use the book_appointment tool
        - Don't ask more questions, just confirm booking
      \`,
      complete: \`
        CURRENT STATE: Booking Complete
        - Appointment is booked
        - Confirm appointment details one final time
        - Ask if there's anything else you can help with
        - If no, end gracefully
      \`
    };

    return statePrompts[conversationState.stage] || '';
  }

  function getMissingFields() {
    const required = ['date', 'time', 'customerName', 'phone'];
    return required.filter(field => !conversationState.appointmentData[field]);
  }

  function updateState(userMessage) {
    // Extract info from user message (simple pattern matching)
    // In production, you'd use more sophisticated NER/entity extraction

    // Check for date
    const dateMatch = userMessage.match(/(\d{4}-\d{2}-\d{2}|tomorrow|today|next week|monday|tuesday|wednesday|thursday|friday)/i);
    if (dateMatch) conversationState.appointmentData.date = dateMatch[0];

    // Check for time
    const timeMatch = userMessage.match(/(\d{1,2}:\d{2}|\d{1,2}\s*(am|pm))/i);
    if (timeMatch) conversationState.appointmentData.time = timeMatch[0];

    // Check for phone
    const phoneMatch = userMessage.match(/(\d{3}[-.]?\d{3}[-.]?\d{4})/);
    if (phoneMatch) conversationState.appointmentData.phone = phoneMatch[0];

    // Update stage based on collected data
    const missing = getMissingFields();
    if (conversationState.stage === 'greeting' && userMessage.match(/book|appointment|schedule/i)) {
      conversationState.stage = 'collecting_info';
    } else if (conversationState.stage === 'collecting_info' && missing.length === 0) {
      conversationState.stage = 'confirming';
    }

    console.log('State updated:', conversationState);
  }

  ws.on('message', async (data) => {
    try {
      const message = JSON.parse(data);

      switch (message.event) {
        case 'start':
          console.log('Call started:', message.streamSid);
          break;

        case 'transcript':
          console.log('User said:', message.transcript);

          // Update conversation state based on user input
          updateState(message.transcript);

          // Add user message to history
          conversationHistory.push({
            role: 'user',
            content: message.transcript
          });

          // Inject state-aware context
          const stateContext = getStateContext();
          conversationHistory.push({
            role: 'system',
            content: stateContext
          });

          // Call OpenAI with tools
          const completion = await openai.chat.completions.create({
            model: 'gpt-4',
            messages: conversationHistory,
            tools: tools,
            tool_choice: 'auto'
          });

          const assistantMessage = completion.choices[0].message;
          conversationHistory.push(assistantMessage);

          // Check if AI wants to call a tool
          if (assistantMessage.tool_calls) {
            for (const toolCall of assistantMessage.tool_calls) {
              const functionName = toolCall.function.name;
              const functionArgs = JSON.parse(toolCall.function.arguments);

              console.log(\`Calling tool: \${functionName}\`, functionArgs);

              // Execute the tool
              let toolResult;
              switch (functionName) {
                case 'check_availability':
                  toolResult = await checkAvailability(functionArgs);
                  break;
                case 'book_appointment':
                  // Update state - we're now booking
                  conversationState.stage = 'booking';
                  toolResult = await bookAppointment(functionArgs);
                  // Move to complete state after booking
                  conversationState.stage = 'complete';
                  break;
                case 'send_confirmation_sms':
                  toolResult = await sendConfirmationSMS(functionArgs, twilioClient, context);
                  break;
                default:
                  toolResult = { error: 'Unknown tool' };
              }

              // Add tool result to conversation
              conversationHistory.push({
                role: 'tool',
                tool_call_id: toolCall.id,
                content: JSON.stringify(toolResult)
              });
            }

            // Get AI's final response after tool execution
            const finalCompletion = await openai.chat.completions.create({
              model: 'gpt-4',
              messages: conversationHistory
            });

            const finalMessage = finalCompletion.choices[0].message.content;
            conversationHistory.push({ role: 'assistant', content: finalMessage });

            // Send to caller
            ws.send(JSON.stringify({
              event: 'text',
              text: finalMessage
            }));
          } else {
            // No tool call, just send AI response
            ws.send(JSON.stringify({
              event: 'text',
              text: assistantMessage.content
            }));
          }
          break;

        case 'stop':
          console.log('Call ended');
          ws.close();
          break;
      }
    } catch (error) {
      console.error('Error:', error);
      ws.send(JSON.stringify({
        event: 'text',
        text: 'I apologize, but I encountered an error. Could you please repeat that?'
      }));
    }
  });

  ws.on('error', (error) => console.error('WebSocket error:', error));
  ws.on('close', () => console.log('WebSocket closed'));

  callback(null, response);

  // Tool Implementation Functions
  async function checkAvailability(args) {
    // TODO: Connect to your scheduling system
    // This is a mock implementation
    const { date } = args;
    const availableSlots = ['9:00 AM', '11:00 AM', '2:00 PM', '4:00 PM'];
    return {
      date,
      available: true,
      slots: availableSlots,
      message: \`Available slots for \${date}: \${availableSlots.join(', ')}\`
    };
  }

  async function bookAppointment(args) {
    // TODO: Connect to your scheduling system
    // This is a mock implementation
    const { date, time, customerName, phone, service } = args;
    const appointmentId = 'APT-' + Date.now();

    console.log('Booking appointment:', { date, time, customerName, phone, service });

    return {
      success: true,
      appointmentId,
      date,
      time,
      message: \`Appointment booked! ID: \${appointmentId} for \${customerName} on \${date} at \${time}\`
    };
  }

  async function sendConfirmationSMS(args, twilioClient, context) {
    try {
      const { phone, message } = args;

      const sms = await twilioClient.messages.create({
        body: message,
        from: context.DEFAULT_TWILIO_NUMBER,
        to: phone
      });

      return {
        success: true,
        messageSid: sms.sid,
        message: 'Confirmation SMS sent successfully'
      };
    } catch (error) {
      console.error('SMS error:', error);
      return {
        success: false,
        error: error.message
      };
    }
  }
};</textarea>
          </div>

          <!-- Multi-Channel Functions Section -->
          <div class="service-card" style="margin-top: 30px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
            <h3 style="color: white; margin-bottom: 15px;">üìß Multi-Channel Communication Functions</h3>
            <p style="color: rgba(255,255,255,0.95); line-height: 1.6; margin-bottom: 20px;">
              Extend your Voice AI to communicate across multiple channels. Send confirmations via SMS, email receipts, or even WhatsApp messages!
            </p>
          </div>

          <!-- Tabbed Channel Selector -->
          <div style="margin: 20px 0;">
            <div style="display: flex; gap: 10px; border-bottom: 2px solid #e0e0e0; padding-bottom: 0;">
              <button id="tabSMS" class="channel-tab active" onclick="showChannelTab('sms')" style="padding: 12px 24px; background: #10b981; color: white; border: none; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600; font-size: 14px;">
                üì≤ SMS
              </button>
              <button id="tabEmail" class="channel-tab" onclick="showChannelTab('email')" style="padding: 12px 24px; background: #e0e0e0; color: #666; border: none; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600; font-size: 14px;">
                üìß Email
              </button>
              <button id="tabWhatsApp" class="channel-tab" onclick="showChannelTab('whatsapp')" style="padding: 12px 24px; background: #e0e0e0; color: #666; border: none; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600; font-size: 14px;">
                üí¨ WhatsApp
              </button>
            </div>

            <!-- SMS Tab Content -->
            <div id="channelContentSMS" class="channel-content" style="display: block;">
              <div class="instructions" style="margin-top: 20px;">
                <h4>üì≤ SMS Confirmation Function</h4>
                <p>Send SMS confirmations using Twilio Messaging API (already included in the code above):</p>
              </div>
              <div class="code-editor" style="margin-bottom: 20px;">
                <div class="code-header">
                  <span>üí¨ SMS Function Implementation</span>
                  <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" onclick="addChannelCodeToEditor('smsFunction')" style="padding: 6px 12px; font-size: 13px;">‚ûï Add to My Tools Code</button>
                    <button class="btn-copy" onclick="copyCode('smsFunction')">üìã Copy Code</button>
                  </div>
                </div>
                <textarea class="code-textarea" id="smsFunction" rows="18" readonly>// Tool Definition - Add to your tools array
{
  type: "function",
  name: "send_sms",
  description: "Send SMS message to customer",
  parameters: {
    type: "object",
    properties: {
      to: { type: "string", description: "Customer phone number (E.164 format)" },
      message: { type: "string", description: "Message content (max 1600 chars)" }
    },
    required: ["to", "message"]
  }
}

// Function Implementation
async function sendSMS(args, twilioClient, context) {
  try {
    const { to, message } = args;

    const sms = await twilioClient.messages.create({
      body: message,
      from: context.DEFAULT_TWILIO_NUMBER,  // Your Twilio number
      to: to
    });

    return {
      success: true,
      messageSid: sms.sid,
      status: sms.status,
      message: 'SMS sent successfully'
    };
  } catch (error) {
    console.error('SMS error:', error);
    return {
      success: false,
      error: error.message
    };
  }
}</textarea>
              </div>
            </div>

            <!-- Email Tab Content -->
            <div id="channelContentEmail" class="channel-content" style="display: none;">
              <div class="instructions" style="margin-top: 20px;">
                <h4>üìß Email Confirmation Function</h4>
                <p>Send email confirmations using Twilio SendGrid API:</p>
              </div>
              <div class="code-editor" style="margin-bottom: 20px;">
                <div class="code-header">
                  <span>‚úâÔ∏è Email Function Implementation</span>
                  <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" onclick="addChannelCodeToEditor('emailFunction')" style="padding: 6px 12px; font-size: 13px;">‚ûï Add to My Tools Code</button>
                    <button class="btn-copy" onclick="copyCode('emailFunction')">üìã Copy Code</button>
                  </div>
                </div>
                <textarea class="code-textarea" id="emailFunction" rows="25" readonly>// First, add SendGrid to your Twilio Functions:
// In Twilio Console ‚Üí Functions ‚Üí Dependencies ‚Üí Add: @sendgrid/mail

// Tool Definition - Add to your tools array
{
  type: "function",
  name: "send_email",
  description: "Send email confirmation to customer",
  parameters: {
    type: "object",
    properties: {
      to: { type: "string", description: "Customer email address" },
      subject: { type: "string", description: "Email subject line" },
      body: { type: "string", description: "Email body content" }
    },
    required: ["to", "subject", "body"]
  }
}

// Function Implementation
async function sendEmail(args, context) {
  try {
    const sgMail = require('@sendgrid/mail');
    sgMail.setApiKey(context.SENDGRID_API_KEY);  // Add to Environment Variables

    const { to, subject, body } = args;

    const msg = {
      to: to,
      from: context.SENDER_EMAIL,  // Verified sender in SendGrid
      subject: subject,
      text: body,
      html: \`<div style="font-family: Arial, sans-serif; padding: 20px;">
        <h2 style="color: #F22F46;">Appointment Confirmation</h2>
        <p>\${body}</p>
        <hr style="border: 1px solid #eee; margin: 20px 0;">
        <p style="color: #666; font-size: 12px;">
          This is an automated message. Please do not reply.
        </p>
      </div>\`
    };

    await sgMail.send(msg);

    return {
      success: true,
      message: 'Email sent successfully',
      to: to
    };
  } catch (error) {
    console.error('Email error:', error);
    return {
      success: false,
      error: error.message
    };
  }
}</textarea>
              </div>
            </div>

            <!-- WhatsApp Tab Content -->
            <div id="channelContentWhatsApp" class="channel-content" style="display: none;">
              <div class="instructions" style="margin-top: 20px;">
                <h4>üí¨ WhatsApp Function</h4>
                <p>Send WhatsApp messages using Twilio WhatsApp API:</p>
              </div>
              <div class="code-editor" style="margin-bottom: 20px;">
                <div class="code-header">
                  <span>üíö WhatsApp Function Implementation</span>
                  <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" onclick="addChannelCodeToEditor('whatsappFunction')" style="padding: 6px 12px; font-size: 13px;">‚ûï Add to My Tools Code</button>
                    <button class="btn-copy" onclick="copyCode('whatsappFunction')">üìã Copy Code</button>
                  </div>
                </div>
                <textarea class="code-textarea" id="whatsappFunction" rows="20" readonly>// Tool Definition - Add to your tools array
{
  type: "function",
  name: "send_whatsapp",
  description: "Send WhatsApp message to customer",
  parameters: {
    type: "object",
    properties: {
      to: { type: "string", description: "Customer phone (E.164 format)" },
      message: { type: "string", description: "Message content" }
    },
    required: ["to", "message"]
  }
}

// Function Implementation
async function sendWhatsApp(args, twilioClient, context) {
  try {
    const { to, message } = args;

    const whatsapp = await twilioClient.messages.create({
      body: message,
      from: \`whatsapp:\${context.TWILIO_WHATSAPP_NUMBER}\`,  // e.g., whatsapp:+14155238886
      to: \`whatsapp:\${to}\`
    });

    return {
      success: true,
      messageSid: whatsapp.sid,
      status: whatsapp.status,
      message: 'WhatsApp message sent successfully'
    };
  } catch (error) {
    console.error('WhatsApp error:', error);
    return {
      success: false,
      error: error.message
    };
  }
}</textarea>
              </div>
            </div>
          </div>

          <div class="service-card" style="background: #f8f9fa; border-left: 4px solid #10b981; margin-top: 20px;">
            <h4 style="color: #059669; margin-bottom: 15px;">üîß How to Add These Functions</h4>
            <ol style="line-height: 1.8; color: #333;">
              <li><strong>Copy the tool definition</strong> and add it to the <code>tools</code> array in your WebSocket handler</li>
              <li><strong>Copy the function implementation</strong> and paste it before the <code>exports.handler</code> line</li>
              <li><strong>Add the function call</strong> in the switch statement where tool calls are handled:
                <pre style="background: #2c313c; color: #abb2bf; padding: 15px; border-radius: 6px; margin-top: 10px; overflow-x: auto;"><code>case 'send_email':
  toolResult = await sendEmail(functionArgs, context);
  break;
case 'send_whatsapp':
  toolResult = await sendWhatsApp(functionArgs, twilioClient, context);
  break;</code></pre>
              </li>
              <li><strong>Add required environment variables</strong> in Twilio Console ‚Üí Functions ‚Üí Environment Variables:
                <ul style="margin-top: 10px; margin-left: 20px;">
                  <li>For Email: <code>SENDGRID_API_KEY</code>, <code>SENDER_EMAIL</code></li>
                  <li>For WhatsApp: <code>TWILIO_WHATSAPP_NUMBER</code>, <code>TWILIO_WHATSAPP_TEMPLATE_SID</code> (must be pre-approved template)</li>
                </ul>
              </li>
              <li><strong>Update your system prompt</strong> to tell the AI about these new capabilities</li>
            </ol>
          </div>

          <div class="service-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-top: 20px;">
            <h4 style="color: white; margin-bottom: 15px;">üí° Multi-Channel Best Practices</h4>
            <ul style="color: rgba(255,255,255,0.95); line-height: 1.8;">
              <li><strong>Always get consent</strong> before sending SMS/WhatsApp/Email ("Can I send you a confirmation via text/email?")</li>
              <li><strong>Validate contact info</strong> - Check format before sending (use regex or validation libraries)</li>
              <li><strong>Handle failures gracefully</strong> - If SMS fails, offer to send email instead</li>
              <li><strong>Keep messages concise</strong> - SMS has 160 char segments, emails should be scannable</li>
              <li><strong>Include opt-out instructions</strong> - "Reply STOP to unsubscribe" for SMS/WhatsApp</li>
              <li><strong>Consider costs</strong> - SMS/WhatsApp have per-message charges, email is typically flat-rate</li>
              <li><strong>Use templates</strong> - Create consistent, professional message templates</li>
              <li><strong>Track deliverability</strong> - Monitor delivery status and handle bounces</li>
            </ul>
          </div>

          <div style="margin: 30px 0; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; border: 2px solid #5a67d8;">
            <h3 style="color: white; margin: 0 0 15px 0; font-size: 1.2rem;">üíæ Ready to Deploy?</h3>
            <p style="color: rgba(255,255,255,0.9); margin-bottom: 20px;">
              Once you're happy with your tooling configuration, click <strong>Commit Step 8</strong> to deploy it to your Twilio account.
              This will update your WebSocket handler with custom functions and knowledge base.
            </p>
            <button
              class="btn btn-success ${step8CodeValidated && !step8Deployed ? 'next-action' : ''}"
              id="commitStep8Btn"
              onclick="commitStep(8)"
              style="font-size: 1.1rem; padding: 15px 30px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
              üíæ Commit Step 8 - Deploy Tooling
            </button>
            <div id="commitStep8Status" style="margin-top: 15px;"></div>
          </div>

          <div class="button-group" style="margin-top: 30px;">
            <button class="btn btn-secondary" onclick="prevStep()">‚Üê Back</button>
            <button class="btn btn-secondary" onclick="skipTooling()" style="margin: 0 10px;">
              Skip This Step ‚Üí
            </button>
            <button class="btn btn-primary" onclick="saveToolingAndContinue()">
              Save & Continue ‚Üí
            </button>
          </div>

          <div id="step5Status" class="status-box"></div>
        </div>
      `;
    }

    function skipTooling() {
      toolsConfigured = true;
      saveProgressToStorage();
      updateProgressBar();
      showStatus('step5Status', 'info', '‚è≠Ô∏è Skipped tooling configuration. You can add this later!');
      setTimeout(() => {
        nextStep();
      }, 1000);
    }

    function saveToolingAndContinue() {
      toolsConfigured = true;
      saveProgressToStorage();
      updateProgressBar();
      const toolingCode = document.getElementById('code5')?.value || '';

      // Store in localStorage for later use
      try {
        localStorage.setItem('twilioVoiceAI_tooling', toolingCode);
        showStatus('step5Status', 'success', '‚úÖ Tooling configuration saved!');
        setTimeout(() => {
          nextStep();
        }, 1000);
      } catch (error) {
        showStatus('step5Status', 'error', `‚ùå Error saving: ${error.message}`);
      }
    }

    // =========================================================================
    // STEP 9: DEPLOY YOUR VOICE AI SYSTEM
    // =========================================================================

    /**
     * Renders dynamic admin panel cards based on use case and call direction
     */
    function renderAdminPanelCards() {
      // Detect use case type from description
      const useCaseLower = (useCaseDescription || '').toLowerCase();
      const isHealthcare = /health|medical|doctor|patient|appointment|clinic|hospital/.test(useCaseLower);
      const isRestaurant = /restaurant|food|reservation|table|dining|menu/.test(useCaseLower);
      const isRetail = /shop|store|product|order|purchase|inventory|customer service/.test(useCaseLower);
      const isSupport = /support|help|ticket|issue|technical|troubleshoot/.test(useCaseLower);
      const isRecruiting = /recruit|hiring|candidate|interview|job|applicant/.test(useCaseLower);
      const isOutbound = callDirection === 'outbound';

      let cards = [];

      // Base cards for all use cases
      cards.push(`
        <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 20px; border-radius: 8px;">
          <h4 style="color: white; margin: 0 0 10px 0; font-size: 1rem;">üìû Call Management</h4>
          <p style="color: rgba(255,255,255,0.9); font-size: 13px; margin-bottom: 15px;">
            ${isOutbound ? 'Monitor outbound campaigns and success rates' : 'Track incoming call volume and wait times'}
          </p>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <button onclick="window.open('https://console.twilio.com/us1/monitor/logs/voice', '_blank')" class="btn" style="width: 100%; background: white; color: #667eea; padding: 8px 12px; font-size: 13px;">
              View Call Logs
            </button>
            <button onclick="alert('Feature coming soon: Real-time call dashboard')" class="btn" style="width: 100%; background: rgba(255,255,255,0.3); color: white; padding: 8px 12px; font-size: 13px;">
              Live Dashboard
            </button>
          </div>
        </div>
      `);

      // Healthcare-specific
      if (isHealthcare) {
        cards.push(`
          <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 20px; border-radius: 8px;">
            <h4 style="color: white; margin: 0 0 10px 0; font-size: 1rem;">üè• Appointment Management</h4>
            <p style="color: rgba(255,255,255,0.9); font-size: 13px; margin-bottom: 15px;">
              View scheduled appointments and patient callbacks
            </p>
            <div style="display: flex; flex-direction: column; gap: 8px;">
              <button onclick="alert('Appointment calendar integration coming soon')" class="btn" style="width: 100%; background: white; color: #667eea; padding: 8px 12px; font-size: 13px;">
                üìÖ View Appointments
              </button>
              <button onclick="alert('Patient records integration coming soon')" class="btn" style="width: 100%; background: rgba(255,255,255,0.3); color: white; padding: 8px 12px; font-size: 13px;">
                Patient Records
              </button>
            </div>
          </div>
        `);

        cards.push(`
          <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 20px; border-radius: 8px;">
            <h4 style="color: white; margin: 0 0 10px 0; font-size: 1rem;">‚öïÔ∏è HIPAA Compliance</h4>
            <p style="color: rgba(255,255,255,0.9); font-size: 13px; margin-bottom: 15px;">
              Ensure call recordings and data meet compliance requirements
            </p>
            <div style="display: flex; flex-direction: column; gap: 8px;">
              <button onclick="window.open('https://www.twilio.com/en-us/trusted-cloud/hipaa', '_blank')" class="btn" style="width: 100%; background: white; color: #667eea; padding: 8px 12px; font-size: 13px;">
                HIPAA Settings
              </button>
            </div>
          </div>
        `);
      }

      // Restaurant-specific
      if (isRestaurant) {
        cards.push(`
          <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 20px; border-radius: 8px;">
            <h4 style="color: white; margin: 0 0 10px 0; font-size: 1rem;">üçΩÔ∏è Reservation System</h4>
            <p style="color: rgba(255,255,255,0.9); font-size: 13px; margin-bottom: 15px;">
              Manage table bookings and waitlist
            </p>
            <div style="display: flex; flex-direction: column; gap: 8px;">
              <button onclick="alert('Reservation management dashboard coming soon')" class="btn" style="width: 100%; background: white; color: #667eea; padding: 8px 12px; font-size: 13px;">
                üìã Today's Reservations
              </button>
              <button onclick="alert('Table availability settings')" class="btn" style="width: 100%; background: rgba(255,255,255,0.3); color: white; padding: 8px 12px; font-size: 13px;">
                Table Availability
              </button>
            </div>
          </div>
        `);

        cards.push(`
          <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 20px; border-radius: 8px;">
            <h4 style="color: white; margin: 0 0 10px 0; font-size: 1rem;">üì± SMS Confirmations</h4>
            <p style="color: rgba(255,255,255,0.9); font-size: 13px; margin-bottom: 15px;">
              Send reservation confirmations and reminders
            </p>
            <div style="display: flex; flex-direction: column; gap: 8px;">
              <button onclick="window.open('https://console.twilio.com/us1/monitor/logs/messages', '_blank')" class="btn" style="width: 100%; background: white; color: #667eea; padding: 8px 12px; font-size: 13px;">
                View SMS Logs
              </button>
            </div>
          </div>
        `);
      }

      // Retail/E-commerce
      if (isRetail) {
        cards.push(`
          <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 20px; border-radius: 8px;">
            <h4 style="color: white; margin: 0 0 10px 0; font-size: 1rem;">üì¶ Order Tracking</h4>
            <p style="color: rgba(255,255,255,0.9); font-size: 13px; margin-bottom: 15px;">
              Monitor order inquiries and shipping status requests
            </p>
            <div style="display: flex; flex-direction: column; gap: 8px;">
              <button onclick="alert('Order tracking integration coming soon')" class="btn" style="width: 100%; background: white; color: #667eea; padding: 8px 12px; font-size: 13px;">
                Recent Orders
              </button>
              <button onclick="alert('Inventory integration coming soon')" class="btn" style="width: 100%; background: rgba(255,255,255,0.3); color: white; padding: 8px 12px; font-size: 13px;">
                Inventory Status
              </button>
            </div>
          </div>
        `);

        cards.push(`
          <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 20px; border-radius: 8px;">
            <h4 style="color: white; margin: 0 0 10px 0; font-size: 1rem;">üí≥ Payment Issues</h4>
            <p style="color: rgba(255,255,255,0.9); font-size: 13px; margin-bottom: 15px;">
              Track payment-related calls and refund requests
            </p>
            <div style="display: flex; flex-direction: column; gap: 8px;">
              <button onclick="alert('Payment analytics coming soon')" class="btn" style="width: 100%; background: white; color: #667eea; padding: 8px 12px; font-size: 13px;">
                Payment Reports
              </button>
            </div>
          </div>
        `);
      }

      // Support/Helpdesk
      if (isSupport) {
        cards.push(`
          <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 20px; border-radius: 8px;">
            <h4 style="color: white; margin: 0 0 10px 0; font-size: 1rem;">üé´ Ticket Management</h4>
            <p style="color: rgba(255,255,255,0.9); font-size: 13px; margin-bottom: 15px;">
              View AI-created tickets and escalations
            </p>
            <div style="display: flex; flex-direction: column; gap: 8px;">
              <button onclick="alert('Ticket system integration coming soon')" class="btn" style="width: 100%; background: white; color: #667eea; padding: 8px 12px; font-size: 13px;">
                Open Tickets
              </button>
              <button onclick="alert('Escalation dashboard coming soon')" class="btn" style="width: 100%; background: rgba(255,255,255,0.3); color: white; padding: 8px 12px; font-size: 13px;">
                Escalations
              </button>
            </div>
          </div>
        `);

        cards.push(`
          <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 20px; border-radius: 8px;">
            <h4 style="color: white; margin: 0 0 10px 0; font-size: 1rem;">üìä Resolution Metrics</h4>
            <p style="color: rgba(255,255,255,0.9); font-size: 13px; margin-bottom: 15px;">
              Track first-call resolution and customer satisfaction
            </p>
            <div style="display: flex; flex-direction: column; gap: 8px;">
              <button onclick="alert('Analytics dashboard coming soon')" class="btn" style="width: 100%; background: white; color: #667eea; padding: 8px 12px; font-size: 13px;">
                View Metrics
              </button>
            </div>
          </div>
        `);
      }

      // Recruiting-specific
      if (isRecruiting) {
        cards.push(`
          <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 20px; border-radius: 8px;">
            <h4 style="color: white; margin: 0 0 10px 0; font-size: 1rem;">üë• Candidate Pipeline</h4>
            <p style="color: rgba(255,255,255,0.9); font-size: 13px; margin-bottom: 15px;">
              Track candidate responses and interview scheduling
            </p>
            <div style="display: flex; flex-direction: column; gap: 8px;">
              <button onclick="alert('ATS integration coming soon')" class="btn" style="width: 100%; background: white; color: #667eea; padding: 8px 12px; font-size: 13px;">
                Candidate Status
              </button>
              <button onclick="alert('Interview calendar coming soon')" class="btn" style="width: 100%; background: rgba(255,255,255,0.3); color: white; padding: 8px 12px; font-size: 13px;">
                Interview Schedule
              </button>
            </div>
          </div>
        `);

        if (isOutbound) {
          cards.push(`
            <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 20px; border-radius: 8px;">
              <h4 style="color: white; margin: 0 0 10px 0; font-size: 1rem;">üìà Outreach Campaigns</h4>
              <p style="color: rgba(255,255,255,0.9); font-size: 13px; margin-bottom: 15px;">
                Monitor call success rates and follow-ups needed
              </p>
              <div style="display: flex; flex-direction: column; gap: 8px;">
                <button onclick="alert('Campaign analytics coming soon')" class="btn" style="width: 100%; background: white; color: #667eea; padding: 8px 12px; font-size: 13px;">
                  Campaign Stats
                </button>
              </div>
            </div>
          `);
        }
      }

      // AI Analytics (for all use cases)
      cards.push(`
        <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 20px; border-radius: 8px;">
          <h4 style="color: white; margin: 0 0 10px 0; font-size: 1rem;">ü§ñ AI Performance</h4>
          <p style="color: rgba(255,255,255,0.9); font-size: 13px; margin-bottom: 15px;">
            Analyze AI response quality and conversation flows
          </p>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <button onclick="window.open('https://console.twilio.com/us1/monitor/voice-insights', '_blank')" class="btn" style="width: 100%; background: white; color: #667eea; padding: 8px 12px; font-size: 13px;">
              Voice Insights
            </button>
            <button onclick="alert('Conversation transcripts: Check Twilio Console > Voice > Calls')" class="btn" style="width: 100%; background: rgba(255,255,255,0.3); color: white; padding: 8px 12px; font-size: 13px;">
              View Transcripts
            </button>
          </div>
        </div>
      `);

      // Cost Monitoring (for all)
      cards.push(`
        <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 20px; border-radius: 8px;">
          <h4 style="color: white; margin: 0 0 10px 0; font-size: 1rem;">üí∞ Cost Monitoring</h4>
          <p style="color: rgba(255,255,255,0.9); font-size: 13px; margin-bottom: 15px;">
            Track API usage and associated costs
          </p>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <button onclick="window.open('https://console.twilio.com/us1/billing/usage', '_blank')" class="btn" style="width: 100%; background: white; color: #667eea; padding: 8px 12px; font-size: 13px;">
              Twilio Usage
            </button>
            <button onclick="window.open('https://platform.openai.com/usage', '_blank')" class="btn" style="width: 100%; background: rgba(255,255,255,0.3); color: white; padding: 8px 12px; font-size: 13px;">
              OpenAI Usage
            </button>
          </div>
        </div>
      `);

      return cards.join('');
    }

    function renderStep_Deploy() {
      const step = steps[currentStep];
      return `
        <div class="step-content active">
          <div class="step-header">
            <h2>üöÄ Step ${step.id}: ${step.title}</h2>
            <p>Congratulations! You've built a production-ready Voice AI system. Let's deploy it!</p>
          </div>

          <!-- What You Built -->
          <div class="service-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <h3 style="color: white; margin-bottom: 20px;">üéâ What You Built</h3>
            <div style="color: white; line-height: 1.8;">
              <p style="margin-bottom: 15px;">You've created a complete Voice AI system with:</p>
              <ul style="margin-left: 20px; margin-bottom: 15px;">
                <li><strong>üìû Phone Number Integration</strong> - Twilio phone number configured for ${callDirection === 'inbound' ? 'inbound' : 'outbound'} calls</li>
                <li><strong>üîå WebSocket Handler</strong> - Real-time audio streaming with bidirectional communication</li>
                <li><strong>ü§ñ AI Integration</strong> - OpenAI-powered conversations with ConversationRelay</li>
                <li><strong>üìù System Prompts</strong> - Professional, production-ready AI personality and guidelines</li>
                <li><strong>üõ†Ô∏è Function Calling</strong> - Tools for appointments, knowledge base queries, and SMS</li>
              </ul>
              <p style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.2); border-radius: 8px;">
                <strong>üí° Why This Matters:</strong> Most Voice AI tutorials stop at "Hello World".
                You've built a system that handles real-world conversations with context, state management,
                and production-ready error handling. This is deployment-ready code!
              </p>
            </div>
          </div>

          <!-- Conversational Intelligence Analytics (Big Reveal) -->
          ${ciServiceSid ? `
          <div class="service-card" style="background: linear-gradient(135deg, #4fc1ff 0%, #1a73e8 100%); color: white;">
            <h3 style="color: white; margin-bottom: 20px;">üìä Your Call Analytics - The Big Reveal!</h3>
            <div style="line-height: 1.8;">
              <p style="margin-bottom: 15px;">
                Throughout this workshop, we've been quietly collecting analytics on every call you made.
                Welcome to <strong>Twilio Conversational Intelligence</strong> - AI-powered call analytics!
              </p>
              <div id="ciAnalytics" style="margin-top: 20px;">
                <button class="btn" onclick="loadCIAnalytics()" style="background: white; color: #1a73e8; padding: 12px 24px; font-size: 16px; font-weight: bold;">
                  üîç Show Me My Call Analytics
                </button>
              </div>
              <div id="ciAnalyticsData" style="display: none; margin-top: 20px;">
                <!-- Analytics will be loaded here -->
              </div>
            </div>
          </div>
          ` : ''}

          <!-- Architecture Diagram -->
          <div class="instructions">
            <h3>üèóÔ∏è System Architecture - ${callDirection === 'inbound' ? 'Inbound Calls' : 'Outbound Calls'}</h3>
            ${callDirection === 'inbound' ? `
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; font-family: monospace; font-size: 13px; line-height: 2;">
              <div style="margin-bottom: 15px; color: #666; font-family: sans-serif;">
                <strong>Inbound Flow:</strong> Customer calls your Twilio number
              </div>
              <pre style="margin: 0;">
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Customer       ‚îÇ üì± Caller dials your phone number
‚îÇ  Places Call    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Twilio Voice   ‚îÇ ‚òÅÔ∏è  Your Twilio phone number receives call
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  TwiML Handler  ‚îÇ üìã  Answers call, starts ConversationRelay
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     /api/voice-handler
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ConversationRelay‚îÇ ü§ñ  AI orchestration layer
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     - Handles STT (speech-to-text)
         ‚îÇ              - Handles TTS (text-to-speech)
         ‚îÇ              - Manages WebSocket connection
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  WebSocket      ‚îÇ üîå  Your custom logic
‚îÇ  Handler        ‚îÇ     - Receives transcribed text
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     - Sends response text back
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Your Code      ‚îÇ üõ†Ô∏è  AI + Tools
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     - OpenAI (GPT-4/3.5)
                        - Custom functions (appointments, etc.)
                        - Database queries
              </pre>
            </div>
            ` : `
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; font-family: monospace; font-size: 13px; line-height: 2;">
              <div style="margin-bottom: 15px; color: #666; font-family: sans-serif;">
                <strong>Outbound Flow:</strong> Your system initiates call to customer
              </div>
              <pre style="margin: 0;">
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Your System    ‚îÇ üíª Triggers outbound call
‚îÇ  Makes API Call ‚îÇ     POST /api/make-call
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Twilio API     ‚îÇ ‚òÅÔ∏è  Places call to customer
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Customer       ‚îÇ üì± Customer's phone rings
‚îÇ  Answers        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  TwiML Handler  ‚îÇ üìã  Starts ConversationRelay
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     /api/voice-handler
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ConversationRelay‚îÇ ü§ñ  AI orchestration layer
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     - Handles STT (speech-to-text)
         ‚îÇ              - Handles TTS (text-to-speech)
         ‚îÇ              - Manages WebSocket connection
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  WebSocket      ‚îÇ üîå  Your custom logic
‚îÇ  Handler        ‚îÇ     - Receives transcribed text
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     - Sends response text back
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Your Code      ‚îÇ üõ†Ô∏è  AI + Tools
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     - OpenAI (GPT-4/3.5)
                        - Custom functions (appointments, etc.)
                        - Database queries
              </pre>
            </div>
            `}
          </div>

          <!-- Deployment Complete -->
          <div class="service-card" style="background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%); border: 3px solid #56ab2f;">
            <h3 style="color: white; margin-bottom: 15px;">üéâ Your AI Voice Assistant is Deployed!</h3>
            <div style="color: white; line-height: 1.8;">
              <p style="margin-bottom: 15px; font-size: 1.1rem;">
                <strong>Congratulations!</strong> You've successfully deployed your AI-powered voice assistant throughout this workshop:
              </p>
              <ul style="margin: 10px 0 20px 20px; font-size: 1rem;">
                <li>‚úÖ <strong>Step 4:</strong> Basic TwiML voice handler</li>
                <li>‚úÖ <strong>Step 5:</strong> WebSocket handler for ConversationRelay</li>
                <li>‚úÖ <strong>Step 6:</strong> ConversationRelay with AI orchestration</li>
                <li>‚úÖ <strong>Step 7:</strong> Custom AI prompt personality</li>
                <li>‚úÖ <strong>Step 8:</strong> Advanced tools and function calling</li>
              </ul>
              <p style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; font-size: 1rem;">
                üìû Your phone number <strong>${selectedPhoneNumber || '[Your Number]'}</strong> is live and ready to handle AI-powered voice calls!
              </p>
            </div>
          </div>

          <!-- What's Included Summary -->
          <div class="service-card" style="background: linear-gradient(135deg, #e5c07b 0%, #2c313c 100%); margin-top: 20px;">
            <h3 style="color: white; margin-bottom: 15px;">üìã What's Included in Your Voice AI System</h3>
            <ul style="color: #e5e5e5; line-height: 1.8;">
              <li><strong>3 Production Tools:</strong> Check availability, book appointments, send SMS confirmations</li>
              <li><strong>Knowledge Base:</strong> Company info, hours, services, insurance - customize for your business</li>
              <li><strong>Conversation History:</strong> Maintains context across the call</li>
              <li><strong>Error Handling:</strong> Graceful fallbacks if tools fail</li>
              <li><strong>Real SMS Integration:</strong> Sends actual confirmation texts via Twilio</li>
            </ul>
          </div>

          <!-- Customize for Your Business -->
          <div class="service-card" style="background: linear-gradient(135deg, #98c379 0%, #2c313c 100%); margin-top: 20px;">
            <h3 style="color: white; margin-bottom: 15px;">üîß Customize for Your Business</h3>
            <ol style="color: #e5e5e5; line-height: 1.8;">
              <li>Update the <strong>knowledgeBase</strong> with your company details</li>
              <li>Replace <strong>checkAvailability()</strong> with your scheduling API</li>
              <li>Replace <strong>bookAppointment()</strong> with your booking system</li>
              <li>Add more tools as needed (payment, lookup orders, etc.)</li>
              <li>Test by calling and saying "I'd like to book an appointment"</li>
            </ol>
          </div>

          <!-- Real-World Integration Ideas -->
          <div class="service-card" style="background: linear-gradient(135deg, #c678dd 0%, #2c313c 100%); margin-top: 20px;">
            <h3 style="color: white; margin-bottom: 15px;">üí° Real-World Integration Ideas</h3>
            <ul style="color: #e5e5e5; line-height: 1.8;">
              <li><strong>Healthcare:</strong> Connect to Epic/Cerner for real availability</li>
              <li><strong>Restaurants:</strong> Integrate OpenTable or Resy API</li>
              <li><strong>E-commerce:</strong> Check inventory, track orders, process returns</li>
              <li><strong>Support:</strong> Look up tickets, check account status, escalate issues</li>
              <li><strong>Financial:</strong> Check balances, make payments (with proper auth!)</li>
            </ul>
          </div>

          <!-- Next Steps -->
          <div class="service-card">
            <h3>üì¶ Take Your Project Further</h3>
            <p style="margin-bottom: 20px;">Your assistant is already deployed! Here are some ways to continue building:</p>

            <!-- Option 1: Download Package -->
            <div style="border: 2px solid #667eea; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
              <h4 style="margin: 0 0 10px 0; color: #667eea;">üì• Option 1: Download Complete Package</h4>
              <p style="margin-bottom: 15px; color: #666;">
                Download all your code as a ZIP file. Perfect if you want to customize further or deploy manually.
              </p>
              <div style="margin-bottom: 15px;">
                <strong>‚úÖ Pros:</strong>
                <ul style="margin: 5px 0 0 20px; color: #666;">
                  <li>Full control over code</li>
                  <li>Easy to customize and extend</li>
                  <li>Includes .env template with your settings</li>
                  <li>Contains README with deployment instructions</li>
                </ul>
              </div>
              <button class="btn btn-secondary" onclick="downloadProjectPackage()" style="width: 100%; padding: 12px; font-size: 16px;">
                üì¶ Download Project Files
              </button>
            </div>

            <!-- Option 2: Clone from GitHub -->
            <div style="border: 2px solid #24292e; border-radius: 8px; padding: 20px;">
              <h4 style="margin: 0 0 10px 0; color: #24292e;">üêô Option 2: Clone from GitHub</h4>
              <p style="margin-bottom: 15px; color: #666;">
                For developers who want version control and ongoing updates. Clone the complete workshop repository.
              </p>
              <div style="margin-bottom: 15px;">
                <strong>‚úÖ Pros:</strong>
                <ul style="margin: 5px 0 0 20px; color: #666;">
                  <li>Version control with Git</li>
                  <li>Easy to collaborate with team</li>
                  <li>Get workshop updates via git pull</li>
                  <li>Best for production deployments</li>
                </ul>
              </div>
              <div style="background: #f6f8fa; padding: 15px; border-radius: 6px; font-family: monospace; font-size: 13px; margin-bottom: 15px;">
                <div style="color: #666; margin-bottom: 5px;">Run these commands in your terminal:</div>
                <code style="display: block; margin: 5px 0;">git clone https://github.com/geverist/twilio-voice-ai-workshop.git</code>
                <code style="display: block; margin: 5px 0;">cd twilio-voice-ai-workshop/twilio-serverless</code>
                <code style="display: block; margin: 5px 0;">cp .env.example .env</code>
                <code style="display: block; margin: 5px 0;"># Edit .env with your credentials</code>
                <code style="display: block; margin: 5px 0;">twilio serverless:deploy</code>
              </div>
              <button class="btn btn-secondary" onclick="window.open('https://github.com/geverist/twilio-voice-ai-workshop', '_blank')" style="width: 100%; padding: 12px; font-size: 16px;">
                üîó Open GitHub Repository
              </button>
            </div>

            <!-- Option 3: Local Development with ngrok -->
            <div style="border: 2px solid #1f8ceb; border-radius: 8px; padding: 20px; margin-top: 20px;">
              <h4 style="margin: 0 0 10px 0; color: #1f8ceb;">üîß Option 3: Test Locally with ngrok</h4>
              <p style="margin-bottom: 15px; color: #666;">
                Develop and test your WebSocket handler locally before deploying. Perfect for rapid iteration and debugging.
              </p>
              <div style="margin-bottom: 15px;">
                <strong>‚úÖ Pros:</strong>
                <ul style="margin: 5px 0 0 20px; color: #666;">
                  <li>Instant local testing without redeployment</li>
                  <li>Full debugging capabilities</li>
                  <li>See console logs in real-time</li>
                  <li>Perfect for development workflow</li>
                </ul>
              </div>
              <div style="background: #f6f8fa; padding: 15px; border-radius: 6px; font-family: monospace; font-size: 13px; margin-bottom: 15px;">
                <div style="color: #666; margin-bottom: 10px;"><strong>Step 1:</strong> Install ngrok (if not already installed)</div>
                <code style="display: block; margin: 5px 0;">brew install ngrok  # macOS</code>
                <code style="display: block; margin: 5px 0;"># Or download from https://ngrok.com/download</code>

                <div style="color: #666; margin: 15px 0 10px 0;"><strong>Step 2:</strong> Run your local WebSocket server</div>
                <code style="display: block; margin: 5px 0;">node server/websocket-server.js</code>
                <code style="display: block; margin: 5px 0;"># Server runs on http://localhost:3000</code>

                <div style="color: #666; margin: 15px 0 10px 0;"><strong>Step 3:</strong> Expose with ngrok</div>
                <code style="display: block; margin: 5px 0;">ngrok http 3000</code>
                <code style="display: block; margin: 5px 0;"># Copy the https:// forwarding URL</code>

                <div style="color: #666; margin: 15px 0 10px 0;"><strong>Step 4:</strong> Update your TwiML handler</div>
                <code style="display: block; margin: 5px 0;">// Replace your WebSocket URL with ngrok URL</code>
                <code style="display: block; margin: 5px 0;">url: 'wss://YOUR-NGROK-ID.ngrok.io'</code>
              </div>
              <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 12px; border-radius: 4px; margin-bottom: 15px;">
                <p style="margin: 0; color: #856404; font-size: 13px;">
                  <strong>üí° Pro Tip:</strong> Use <code style="background: rgba(0,0,0,0.1); padding: 2px 6px; border-radius: 3px;">ngrok http 3000 --log=stdout</code> to see all WebSocket traffic for debugging!
                </p>
              </div>
              <button class="btn btn-secondary" onclick="window.open('https://ngrok.com/', '_blank')" style="width: 100%; padding: 12px; font-size: 16px;">
                üîó Get ngrok
              </button>
            </div>
          </div>

          <!-- Deploy to Hosting Platforms -->
          <div class="service-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; margin: 30px 0;">
            <h3 style="color: white; margin: 0 0 15px 0;">üöÄ Deploy to Production</h3>
            <p style="color: rgba(255,255,255,0.95); margin-bottom: 20px; line-height: 1.6;">
              Ready to take your Voice AI system to production? Deploy your WebSocket server to a hosting platform with one click:
            </p>

            <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
              <div style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: center;">

                <!-- Railway Deploy -->
                <a href="https://railway.app/template/new" target="_blank" style="text-decoration: none;">
                  <img src="https://railway.app/button.svg" alt="Deploy on Railway" style="height: 40px; border-radius: 6px; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                </a>

                <!-- Render Deploy -->
                <a href="https://render.com/deploy" target="_blank" style="text-decoration: none;">
                  <img src="https://render.com/images/deploy-to-render-button.svg" alt="Deploy to Render" style="height: 40px; border-radius: 6px; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                </a>

                <!-- Heroku Deploy -->
                <a href="https://heroku.com/deploy" target="_blank" style="text-decoration: none;">
                  <img src="https://www.herokucdn.com/deploy/button.svg" alt="Deploy to Heroku" style="height: 40px; border-radius: 6px; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                </a>

              </div>
            </div>

            <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin-top: 15px;">
              <h4 style="color: white; margin: 0 0 10px 0; font-size: 1rem;">üìù Deployment Notes:</h4>
              <ul style="margin: 0; padding-left: 20px; color: rgba(255,255,255,0.9); line-height: 1.8; font-size: 14px;">
                <li><strong>Railway:</strong> Free tier available, supports WebSockets, great for Node.js apps</li>
                <li><strong>Render:</strong> Free tier with persistent storage, automatic HTTPS, easy scaling</li>
                <li><strong>Heroku:</strong> Popular platform with extensive add-ons and documentation</li>
                <li><strong>Environment Variables:</strong> Don't forget to set <code>TWILIO_ACCOUNT_SID</code>, <code>TWILIO_AUTH_TOKEN</code>, and <code>OPENAI_API_KEY</code></li>
                <li><strong>WebSocket URL:</strong> After deployment, update your Twilio phone number webhook to point to your new production URL</li>
              </ul>
            </div>

            ${studentRepoName ? `
            <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.2); border-radius: 8px; border-left: 4px solid white;">
              <p style="margin: 0; color: white; line-height: 1.6;">
                <strong>üí° Your Code:</strong> All your code is in your GitHub repository:
                <a href="https://github.com/${githubUsername}/${studentRepoName}" target="_blank" style="color: #ffd43b; text-decoration: underline; font-weight: 600;">
                  ${githubUsername}/${studentRepoName}
                </a>
              </p>
            </div>
            ` : ''}
          </div>

          <!-- View Conversation History -->
          <div class="service-card" style="background: linear-gradient(135deg, #4fc1ff 0%, #1a73e8 100%); color: white;">
            <h3 style="color: white; margin-bottom: 15px;">üí¨ Review Your Conversations</h3>
            <p style="color: rgba(255,255,255,0.95); margin-bottom: 20px; line-height: 1.6;">
              View full transcripts of all your AI phone calls. See what users asked, how your AI responded, and identify areas for improvement.
            </p>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
              <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 15px; border-radius: 8px;">
                <div style="font-size: 28px; margin-bottom: 8px;">üìä</div>
                <h4 style="color: white; margin: 0 0 8px 0;">Call Analytics</h4>
                <p style="color: rgba(255,255,255,0.9); font-size: 13px; margin: 0;">Track call volume, duration, and turn counts</p>
              </div>
              <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 15px; border-radius: 8px;">
                <div style="font-size: 28px; margin-bottom: 8px;">üí¨</div>
                <h4 style="color: white; margin: 0 0 8px 0;">Full Transcripts</h4>
                <p style="color: rgba(255,255,255,0.9); font-size: 13px; margin: 0;">Read every message exchanged during calls</p>
              </div>
              <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 15px; border-radius: 8px;">
                <div style="font-size: 28px; margin-bottom: 8px;">üîç</div>
                <h4 style="color: white; margin: 0 0 8px 0;">Debug & Improve</h4>
                <p style="color: rgba(255,255,255,0.9); font-size: 13px; margin: 0;">Find issues and refine your AI prompts</p>
              </div>
            </div>
            <button class="btn" onclick="openConversationHistory()" style="width: 100%; padding: 15px; font-size: 16px; font-weight: 600; background: white; color: #1a73e8;">
              üìñ View All Conversations ‚Üí
            </button>
            <div style="margin-top: 15px; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 6px; font-size: 13px;">
              üí° <strong>Pro Tip:</strong> Review conversations after test calls to see exactly how your AI responded. Use this to refine your system prompt and improve responses!
            </div>
          </div>

          <!-- Hero Section: Your AI Admin Dashboard -->
          <div style="margin: 40px 0; padding: 50px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px; text-align: center; border: 3px solid #5a67d8; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);">
            <div style="font-size: 72px; margin-bottom: 20px;">üöÄ</div>
            <h2 style="color: white; margin: 0 0 15px 0; font-size: 2rem;">You've Built a Production-Ready Voice AI Platform</h2>
            <p style="color: rgba(255,255,255,0.95); font-size: 1.1rem; margin: 0 0 30px 0; line-height: 1.8; max-width: 800px; margin-left: auto; margin-right: auto;">
              You <strong>own this entire stack</strong> - no vendor lock-in or platform restrictions.
              Manage everything from your admin dashboard - switch AI providers, change voices, update prompts, and configure
              ConversationRelay settings - all with complete control and flexibility.
            </p>

            <button
              class="btn"
              onclick="openAdminPanel()"
              style="font-size: 1.3rem; padding: 20px 50px; background: white; color: #667eea; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; box-shadow: 0 6px 20px rgba(0,0,0,0.3); transition: transform 0.2s, box-shadow 0.2s;"
              onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.4)'"
              onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 6px 20px rgba(0,0,0,0.3)'">
              üìä Open Your Admin Dashboard ‚Üí
            </button>

            <div style="margin-top: 40px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; max-width: 900px; margin-left: auto; margin-right: auto;">
              <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2);">
                <div style="font-size: 32px; margin-bottom: 10px;">ü§ñ</div>
                <h4 style="color: white; margin: 0 0 8px 0; font-size: 1rem;">AI Configuration</h4>
                <p style="color: rgba(255,255,255,0.85); font-size: 13px; margin: 0;">Switch between OpenAI, Claude, Gemini - you choose</p>
              </div>
              <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2);">
                <div style="font-size: 32px; margin-bottom: 10px;">üîä</div>
                <h4 style="color: white; margin: 0 0 8px 0; font-size: 1rem;">Voice Control</h4>
                <p style="color: rgba(255,255,255,0.85); font-size: 13px; margin: 0;">Select from ElevenLabs, Google, Deepgram, or Amazon</p>
              </div>
              <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2);">
                <div style="font-size: 32px; margin-bottom: 10px;">üìù</div>
                <h4 style="color: white; margin: 0 0 8px 0; font-size: 1rem;">Live Prompts</h4>
                <p style="color: rgba(255,255,255,0.85); font-size: 13px; margin: 0;">Update system prompts & greetings instantly</p>
              </div>
              <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2);">
                <div style="font-size: 32px; margin-bottom: 10px;">üõ†Ô∏è</div>
                <h4 style="color: white; margin: 0 0 8px 0; font-size: 1rem;">Function Calling</h4>
                <p style="color: rgba(255,255,255,0.85); font-size: 13px; margin: 0;">Add custom tools and capabilities on the fly</p>
              </div>
            </div>
          </div>

          <!-- What You Can Build Next -->
          <div class="instructions">
            <h3 style="font-size: 1.5rem; margin-bottom: 20px;">üéØ Build on Your Foundation</h3>
            <p style="color: #666; margin-bottom: 25px; font-size: 1.05rem;">
              You now have everything you need to build sophisticated voice AI applications. Here are ideas based on your use case:
              ${useCaseDescription ? `"<em>${useCaseDescription.substring(0, 150)}${useCaseDescription.length > 150 ? '...' : ''}</em>"` : ''}
            </p>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
              ${renderAdminPanelCards()}
            </div>
          </div>

          <!-- Additional Resources -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 30px 0;">
            <div style="padding: 25px; border: 2px solid #667eea; border-radius: 12px; background: linear-gradient(135deg, #f0f4ff 0%, #e8edff 100%);">
              <h4 style="margin: 0 0 15px 0; color: #667eea; font-size: 1.2rem;">üìà Monitor & Analyze</h4>
              <p style="color: #666; font-size: 14px; margin-bottom: 15px; line-height: 1.6;">
                Track call analytics, review transcripts, and gain insights with Twilio's Voice Intelligence.
              </p>
              <button onclick="window.open('https://console.twilio.com/us1/monitor/voice-insights', '_blank')" class="btn btn-secondary" style="width: 100%; margin-bottom: 10px;">
                Open Voice Insights
              </button>
              <a href="https://www.twilio.com/docs/voice/intelligence" target="_blank" style="color: #667eea; text-decoration: none; font-size: 13px; display: block; text-align: center;">
                Learn about Conversational Intelligence ‚Üí
              </a>
            </div>

            <div style="padding: 25px; border: 2px solid #10b981; border-radius: 12px; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);">
              <h4 style="margin: 0 0 15px 0; color: #10b981; font-size: 1.2rem;">üé® Customize Everything</h4>
              <p style="color: #666; font-size: 14px; margin-bottom: 15px; line-height: 1.6;">
                All your configuration is saved. Jump back to any step to adjust your AI, prompts, or functions.
              </p>
              <button onclick="navigateToStep(5)" class="btn" style="width: 100%; background: #10b981;">
                View Configuration Steps
              </button>
            </div>

            <div style="padding: 25px; border: 2px solid #f59e0b; border-radius: 12px; background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);">
              <h4 style="margin: 0 0 15px 0; color: #f59e0b; font-size: 1.2rem;">üí° Production Tips</h4>
              <ul style="margin: 0; padding-left: 20px; color: #92400e; font-size: 13px; line-height: 1.8;">
                <li>Add call recording for compliance</li>
                <li>Implement voicemail detection</li>
                <li>Set up CRM integrations</li>
                <li>Monitor costs and usage</li>
                <li>Add multi-language support</li>
              </ul>
            </div>
          </div>

          <!-- Workshop Complete - Feedback -->
          <div style="margin-top: 40px; padding: 30px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 12px; text-align: center; border: 3px solid #059669;">
            <h3 style="color: white; margin: 0 0 15px 0; font-size: 1.5rem;">üéâ Workshop Complete!</h3>
            <p style="color: rgba(255,255,255,0.95); font-size: 1.05rem; margin: 0 0 25px 0; line-height: 1.6; max-width: 700px; margin-left: auto; margin-right: auto;">
              You've built a complete Voice AI platform with full control over every component. No vendor lock-in, no limitations -
              just pure customizable power at your fingertips.
            </p>
            <button
              class="btn"
              onclick="showFeedbackModal()"
              style="font-size: 1.1rem; padding: 15px 40px; background: white; color: #10b981; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.2);">
              üí¨ Share Your Feedback
            </button>
          </div>

        </div>
      `;
    }

    // =========================================================================
    // STEP 9 FUNCTIONS
    // =========================================================================

    async function deployToCurrentAccount() {
      const statusBox = document.getElementById('deployStatus');
      statusBox.className = 'status-box info show';
      statusBox.textContent = 'üöÄ Starting deployment to your Twilio account...';

      try {
        // This would trigger the same deployment logic from Step 6
        // For now, show status of what's already deployed
        const deployed = functionsDeployed && basicTwimlCreated;

        if (deployed) {
          statusBox.className = 'status-box success show';
          statusBox.innerHTML = `
            ‚úÖ <strong>Already Deployed!</strong><br>
            Your Voice AI system is live and ready.<br>
            Phone Number: ${selectedPhoneNumber || 'Configured'}<br>
            <a href="https://console.twilio.com/us1/develop/phone-numbers/manage/incoming" target="_blank" style="color: white; text-decoration: underline;">
              View in Twilio Console
            </a>
          `;
          document.getElementById('checkDeployFunctions').checked = true;
          document.getElementById('checkDeployPhone').checked = true;
          checkDeploymentComplete();
        } else {
          statusBox.className = 'status-box error show';
          statusBox.textContent = '‚ö†Ô∏è Please complete previous steps before deploying. Go back to Step 4 to deploy your functions.';
        }
      } catch (error) {
        statusBox.className = 'status-box error show';
        statusBox.textContent = '‚ùå Deployment error: ' + error.message;
      }
    }

    /**
     * Opens the personalized admin panel
     * Saves all configuration to database first, pushes to GitHub if available, then opens admin panel
     */
    async function openAdminPanel() {
      try {
        console.log('üìä Opening admin panel...');

        // First, ensure all configuration is saved to database
        await saveAllConfigToDatabase();

        // If GitHub repo exists, push admin panel HTML to it
        if (githubToken && githubUsername && studentRepoName) {
          console.log('üì§ Pushing admin panel to GitHub repo...');
          try {
            await pushAdminPanelToGitHub();
          } catch (pushError) {
            console.warn('‚ö†Ô∏è Failed to push admin panel to GitHub:', pushError);
            // Continue anyway - they can still use the hosted version
          }
        }

        // Open admin panel with session token
        const url = `/admin-panel-dynamic.html?session=${sessionToken}`;
        window.open(url, '_blank');

        console.log('‚úÖ Admin panel opened');
      } catch (error) {
        console.error('‚ùå Failed to open admin panel:', error);
        alert('Failed to open admin panel: ' + error.message);
      }
    }

    /**
     * Pushes the personalized admin panel HTML to student's GitHub repository
     */
    async function pushAdminPanelToGitHub() {
      try {
        const response = await fetch('/api/github-push-admin-panel', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            accessToken: githubToken,
            githubUsername: githubUsername,
            repoName: studentRepoName,
            sessionToken: sessionToken
          })
        });

        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Failed to push admin panel');
        }

        console.log('‚úÖ Admin panel pushed to GitHub:', data.fileUrl);
        return data;
      } catch (error) {
        console.error('‚ùå Push to GitHub failed:', error);
        throw error;
      }
    }

    /**
     * Saves all workshop configuration to database
     * Called before opening admin panel to ensure everything is persisted
     */
    async function saveAllConfigToDatabase() {
      try {
        console.log('üíæ Saving all configuration to database...');

        const configData = {
          sessionToken: sessionToken,
          studentName: studentName || 'Workshop Student',
          openaiApiKey: openaiApiKey,
          systemPrompt: generatedContent?.systemPrompt || '',
          tools: toolsConfigured ? getConfiguredTools() : [],
          voiceSettings: {
            provider: ttsProvider,
            voice: getDefaultVoice(),
            language: voiceLanguage
          },
          useCaseDescription: useCaseDescription || '',
          callDirection: callDirection || 'inbound',
          ivrGreeting: generatedContent?.ivrGreeting || '',
          ttsProvider: ttsProvider || 'elevenlabs',
          selectedVoice: getDefaultVoice(),
          selectedPhoneNumber: selectedPhoneNumber || '',
          websocketUrl: websocketUrl || '',
          codespaceUrl: codespaceUrl || '',
          githubRepoUrl: githubRepoUrl || '',
          railwayUrl: railwayUrl || ''
        };

        const response = await fetch('/api/student-config-save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(configData)
        });

        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Failed to save configuration');
        }

        console.log('‚úÖ Configuration saved to database');
        return data;
      } catch (error) {
        console.error('‚ùå Failed to save configuration:', error);
        throw error;
      }
    }

    /**
     * Gets currently configured tools from Step 8
     */
    function getConfiguredTools() {
      // Return empty array for now - will be populated when we integrate OpenAI Assistants API
      return [];
    }

    async function loadCIAnalytics() {
      const analyticsContainer = document.getElementById('ciAnalyticsData');
      const loadButton = document.getElementById('ciAnalytics');

      loadButton.innerHTML = '<div style="color: white;">Loading analytics...</div>';

      try {
        // Demo mode simulation
        if (studentDemoMode || twilioCredentials?.demoMode === true) {
          setTimeout(() => {
            loadButton.style.display = 'none';
            analyticsContainer.style.display = 'block';
            analyticsContainer.innerHTML = `
              <div style="background: white; color: #333; padding: 20px; border-radius: 8px;">
                <h4 style="margin: 0 0 15px 0; color: #1a73e8;">üìû Demo Workshop Calls with AI Analytics (3)</h4>

                <!-- Call 1 -->
                <div style="border: 2px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div>
                      <strong>Call #1 - Appointment Booking</strong>
                      <div style="font-size: 12px; color: #666; margin-top: 5px;">
                        From: +1 (555) 123-4567<br>
                        Time: ${new Date(Date.now() - 3600000).toLocaleString()}
                      </div>
                    </div>
                    <div style="text-align: right;">
                      <div style="font-size: 24px;">üòä</div>
                      <div style="font-size: 12px; color: #56ab2f; font-weight: bold; text-transform: uppercase;">
                        POSITIVE
                      </div>
                    </div>
                  </div>
                  <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-top: 10px;">
                    <strong style="font-size: 13px;">Conversation Transcript:</strong>
                    <div style="max-height: 200px; overflow-y: auto; margin-top: 8px; font-size: 13px; line-height: 1.6;">
                      <div style="margin: 8px 0;">
                        <span style="color: #666; font-weight: bold;">ü§ñ AI:</span>
                        Hello! Thanks for calling. How can I help you today?
                      </div>
                      <div style="margin: 8px 0;">
                        <span style="color: #666; font-weight: bold;">üó£Ô∏è Caller:</span>
                        Hi, I'd like to schedule a doctor's appointment for next week.
                      </div>
                      <div style="margin: 8px 0;">
                        <span style="color: #666; font-weight: bold;">ü§ñ AI:</span>
                        Great! I can help you with that. What day works best for you?
                      </div>
                      <div style="margin: 8px 0;">
                        <span style="color: #666; font-weight: bold;">üó£Ô∏è Caller:</span>
                        How about Tuesday afternoon?
                      </div>
                      <div style="margin: 8px 0;">
                        <span style="color: #666; font-weight: bold;">ü§ñ AI:</span>
                        I have 2pm and 3:30pm available on Tuesday. Which time works better?
                      </div>
                      <div style="margin: 8px 0;">
                        <span style="color: #666; font-weight: bold;">üó£Ô∏è Caller:</span>
                        2pm is perfect, thank you!
                      </div>
                    </div>
                  </div>
                  <div style="margin-top: 10px;">
                    <strong style="font-size: 13px;">Topics Detected:</strong>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px;">
                      <span style="background: #e3f2fd; color: #1a73e8; padding: 4px 12px; border-radius: 12px; font-size: 12px;">
                        appointment scheduling
                      </span>
                      <span style="background: #e3f2fd; color: #1a73e8; padding: 4px 12px; border-radius: 12px; font-size: 12px;">
                        healthcare
                      </span>
                      <span style="background: #e3f2fd; color: #1a73e8; padding: 4px 12px; border-radius: 12px; font-size: 12px;">
                        availability
                      </span>
                    </div>
                  </div>
                </div>

                <!-- Call 2 -->
                <div style="border: 2px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div>
                      <strong>Call #2 - Order Status Inquiry</strong>
                      <div style="font-size: 12px; color: #666; margin-top: 5px;">
                        From: +1 (555) 987-6543<br>
                        Time: ${new Date(Date.now() - 7200000).toLocaleString()}
                      </div>
                    </div>
                    <div style="text-align: right;">
                      <div style="font-size: 24px;">üòê</div>
                      <div style="font-size: 12px; color: #666; font-weight: bold; text-transform: uppercase;">
                        NEUTRAL
                      </div>
                    </div>
                  </div>
                  <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-top: 10px;">
                    <strong style="font-size: 13px;">Conversation Transcript:</strong>
                    <div style="max-height: 200px; overflow-y: auto; margin-top: 8px; font-size: 13px; line-height: 1.6;">
                      <div style="margin: 8px 0;">
                        <span style="color: #666; font-weight: bold;">ü§ñ AI:</span>
                        Hi! How can I assist you today?
                      </div>
                      <div style="margin: 8px 0;">
                        <span style="color: #666; font-weight: bold;">üó£Ô∏è Caller:</span>
                        I'm calling to check on my order status.
                      </div>
                      <div style="margin: 8px 0;">
                        <span style="color: #666; font-weight: bold;">ü§ñ AI:</span>
                        I can help with that. Can you provide your order number?
                      </div>
                      <div style="margin: 8px 0;">
                        <span style="color: #666; font-weight: bold;">üó£Ô∏è Caller:</span>
                        Yes, it's order number 12345.
                      </div>
                      <div style="margin: 8px 0;">
                        <span style="color: #666; font-weight: bold;">ü§ñ AI:</span>
                        Your order shipped yesterday and should arrive by Friday.
                      </div>
                    </div>
                  </div>
                  <div style="margin-top: 10px;">
                    <strong style="font-size: 13px;">Topics Detected:</strong>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px;">
                      <span style="background: #e3f2fd; color: #1a73e8; padding: 4px 12px; border-radius: 12px; font-size: 12px;">
                        order tracking
                      </span>
                      <span style="background: #e3f2fd; color: #1a73e8; padding: 4px 12px; border-radius: 12px; font-size: 12px;">
                        shipping
                      </span>
                    </div>
                  </div>
                </div>

                <!-- Call 3 -->
                <div style="border: 2px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div>
                      <strong>Call #3 - Technical Support</strong>
                      <div style="font-size: 12px; color: #666; margin-top: 5px;">
                        From: +1 (555) 246-8135<br>
                        Time: ${new Date(Date.now() - 10800000).toLocaleString()}
                      </div>
                    </div>
                    <div style="text-align: right;">
                      <div style="font-size: 24px;">üòä</div>
                      <div style="font-size: 12px; color: #56ab2f; font-weight: bold; text-transform: uppercase;">
                        POSITIVE
                      </div>
                    </div>
                  </div>
                  <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-top: 10px;">
                    <strong style="font-size: 13px;">Conversation Transcript:</strong>
                    <div style="max-height: 200px; overflow-y: auto; margin-top: 8px; font-size: 13px; line-height: 1.6;">
                      <div style="margin: 8px 0;">
                        <span style="color: #666; font-weight: bold;">ü§ñ AI:</span>
                        Welcome to tech support! What can I help you with?
                      </div>
                      <div style="margin: 8px 0;">
                        <span style="color: #666; font-weight: bold;">üó£Ô∏è Caller:</span>
                        My internet connection keeps dropping. Can you help?
                      </div>
                      <div style="margin: 8px 0;">
                        <span style="color: #666; font-weight: bold;">ü§ñ AI:</span>
                        I can definitely help troubleshoot that. Try unplugging your router for 30 seconds.
                      </div>
                      <div style="margin: 8px 0;">
                        <span style="color: #666; font-weight: bold;">üó£Ô∏è Caller:</span>
                        Okay, I did that and it's working now! Thank you so much!
                      </div>
                      <div style="margin: 8px 0;">
                        <span style="color: #666; font-weight: bold;">ü§ñ AI:</span>
                        Great! I'm glad that fixed it. Is there anything else I can help with?
                      </div>
                    </div>
                  </div>
                  <div style="margin-top: 10px;">
                    <strong style="font-size: 13px;">Topics Detected:</strong>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px;">
                      <span style="background: #e3f2fd; color: #1a73e8; padding: 4px 12px; border-radius: 12px; font-size: 12px;">
                        technical support
                      </span>
                      <span style="background: #e3f2fd; color: #1a73e8; padding: 4px 12px; border-radius: 12px; font-size: 12px;">
                        troubleshooting
                      </span>
                      <span style="background: #e3f2fd; color: #1a73e8; padding: 4px 12px; border-radius: 12px; font-size: 12px;">
                        internet connectivity
                      </span>
                    </div>
                  </div>
                </div>

                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #1a73e8;">
                  <h5 style="margin: 0 0 10px 0; color: #1a73e8;">üß† About Conversational Intelligence</h5>
                  <p style="font-size: 13px; color: #666; line-height: 1.6; margin: 0 0 10px 0;">
                    Twilio Conversational Intelligence uses AI Language Operators to automatically:
                  </p>
                  <ul style="font-size: 13px; color: #666; line-height: 1.8; margin: 0 0 10px 0;">
                    <li><strong>Transcribe calls</strong> with Deepgram speech-to-text</li>
                    <li><strong>Analyze sentiment</strong> to understand caller emotions</li>
                    <li><strong>Detect topics</strong> to categorize conversations</li>
                    <li><strong>Identify PII</strong> for compliance and privacy</li>
                    <li><strong>Extract keywords</strong> for searchability</li>
                  </ul>
                  <a href="https://www.twilio.com/docs/voice/intelligence" target="_blank" style="color: #1a73e8; text-decoration: none; font-size: 13px; font-weight: bold;">
                    üìö Learn more about Conversational Intelligence ‚Üí
                  </a>
                </div>

                <div style="margin-top: 15px; padding: 12px; background: #fff3cd; border-radius: 6px; border-left: 4px solid #ffc107;">
                  <p style="margin: 0; color: #856404; font-size: 13px;">
                    ‚ú® <strong>Demo Mode:</strong> This is simulated analytics data. In production, you'd see real transcripts and sentiment analysis from your actual calls.
                  </p>
                </div>
              </div>
            `;
          }, 1000);
          return;
        }

        // Fetch analytics from CI service
        const response = await fetch(`/api/ci-analytics?accountSid=${twilioAccountSid}&authToken=${twilioAuthToken}&serviceSid=${ciServiceSid}`);

        if (!response.ok) {
          throw new Error('Failed to load analytics');
        }

        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Failed to load analytics');
        }

        // Hide load button, show analytics
        loadButton.style.display = 'none';
        analyticsContainer.style.display = 'block';

        // Render analytics
        const transcripts = data.transcripts || [];

        if (transcripts.length === 0) {
          analyticsContainer.innerHTML = `
            <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 8px; text-align: center;">
              <p style="margin: 0; color: white;">No calls recorded yet. Make some test calls and come back!</p>
            </div>
          `;
          return;
        }

        // Render transcripts with analytics
        analyticsContainer.innerHTML = `
          <div style="background: white; color: #333; padding: 20px; border-radius: 8px;">
            <h4 style="margin: 0 0 15px 0; color: #1a73e8;">üìû Workshop Calls (${transcripts.length})</h4>
            ${transcripts.map((t, idx) => {
              const sentiment = t.sentiment?.average_sentiment || 'neutral';
              const sentimentEmoji = sentiment === 'positive' ? 'üòä' : sentiment === 'negative' ? 'üòû' : 'üòê';
              const sentimentColor = sentiment === 'positive' ? '#56ab2f' : sentiment === 'negative' ? '#ff6b6b' : '#666';

              return `
                <div style="border: 2px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div>
                      <strong>Call #${idx + 1}</strong>
                      <div style="font-size: 12px; color: #666; margin-top: 5px;">
                        From: ${t.customerKey || 'Unknown'}<br>
                        Time: ${new Date(t.mediaStartTime).toLocaleString()}
                      </div>
                    </div>
                    <div style="text-align: right;">
                      <div style="font-size: 24px;">${sentimentEmoji}</div>
                      <div style="font-size: 12px; color: ${sentimentColor}; font-weight: bold; text-transform: uppercase;">
                        ${sentiment}
                      </div>
                    </div>
                  </div>

                  ${t.sentences && t.sentences.length > 0 ? `
                    <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-top: 10px;">
                      <strong style="font-size: 13px;">Conversation Transcript:</strong>
                      <div style="max-height: 200px; overflow-y: auto; margin-top: 8px; font-size: 13px; line-height: 1.6;">
                        ${t.sentences.map(s => `
                          <div style="margin: 8px 0;">
                            <span style="color: #666; font-weight: bold;">${s.speaker === 'customer' ? 'üó£Ô∏è Caller' : 'ü§ñ AI'}:</span>
                            ${s.text}
                          </div>
                        `).join('')}
                      </div>
                    </div>
                  ` : `
                    <div style="padding: 10px; background: #fff3cd; border-radius: 6px; font-size: 13px; color: #856404;">
                      ‚è≥ Transcript processing... (This can take a few minutes after the call ends)
                    </div>
                  `}

                  ${t.sentiment?.topics && t.sentiment.topics.length > 0 ? `
                    <div style="margin-top: 10px;">
                      <strong style="font-size: 13px;">Topics Detected:</strong>
                      <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px;">
                        ${t.sentiment.topics.map(topic => `
                          <span style="background: #e3f2fd; color: #1a73e8; padding: 4px 12px; border-radius: 12px; font-size: 12px;">
                            ${topic}
                          </span>
                        `).join('')}
                      </div>
                    </div>
                  ` : ''}
                </div>
              `;
            }).join('')}

            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #1a73e8;">
              <h5 style="margin: 0 0 10px 0; color: #1a73e8;">üß† About Conversational Intelligence</h5>
              <p style="font-size: 13px; color: #666; line-height: 1.6; margin: 0 0 10px 0;">
                Twilio Conversational Intelligence uses AI Language Operators to automatically:
              </p>
              <ul style="font-size: 13px; color: #666; line-height: 1.8; margin: 0 0 10px 0;">
                <li><strong>Transcribe calls</strong> with Deepgram speech-to-text</li>
                <li><strong>Analyze sentiment</strong> to understand caller emotions</li>
                <li><strong>Detect topics</strong> to categorize conversations</li>
                <li><strong>Identify PII</strong> for compliance and privacy</li>
                <li><strong>Extract keywords</strong> for searchability</li>
              </ul>
              <a href="https://www.twilio.com/docs/voice/intelligence" target="_blank" style="color: #1a73e8; text-decoration: none; font-size: 13px; font-weight: bold;">
                üìö Learn more about Conversational Intelligence ‚Üí
              </a>
            </div>
          </div>
        `;

      } catch (error) {
        console.error('CI Analytics error:', error);
        analyticsContainer.style.display = 'block';
        analyticsContainer.innerHTML = `
          <div style="background: rgba(255, 0, 0, 0.2); padding: 20px; border-radius: 8px;">
            <p style="margin: 0; color: white;">‚ùå Failed to load analytics: ${error.message}</p>
            <p style="margin: 10px 0 0 0; color: white; font-size: 14px;">
              This is normal if no calls have been made yet. Make a test call and try again!
            </p>
          </div>
        `;
      }
    }

    async function loadWorkshopCallHistory() {
      const historyContainer = document.getElementById('workshopCallHistoryData');
      const loadButton = document.getElementById('workshopCallHistory');

      loadButton.innerHTML = '<div style="color: white;">üì° Loading your workshop calls...</div>';

      try {
        // Demo mode simulation
        if (studentDemoMode || twilioCredentials?.demoMode === true) {
          setTimeout(() => {
            loadButton.style.display = 'none';
            historyContainer.style.display = 'block';
            historyContainer.innerHTML = `
              <div style="background: white; color: #333; padding: 20px; border-radius: 8px;">
                <h4 style="margin: 0 0 15px 0; color: #1a73e8;">üìû Demo Workshop Calls (3)</h4>

                ${generateDemoCallCard(1, 'Step 4', 'Basic TwiML Test', 'completed', '45s', 'You tested the Basic TwiML handler with IVR menu navigation.')}
                ${generateDemoCallCard(2, 'Step 5', 'WebSocket Test', 'completed', '62s', 'You tested the WebSocket handler for ConversationRelay.')}
                ${generateDemoCallCard(3, 'Step 6', 'AI Voice Assistant', 'completed', '98s', 'You had a conversation with your AI assistant powered by ConversationRelay!', true)}

                <div style="margin-top: 20px; padding: 15px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #4fc1ff;">
                  <p style="font-size: 13px; color: #666; line-height: 1.6; margin: 0;">
                    <strong>üí° Demo Mode:</strong> These are simulated calls to show you what call history looks like.
                    In live mode, you'll see actual call data from your Twilio account with Conversational Intelligence insights!
                  </p>
                </div>
              </div>
            `;
          }, 1500);
          return;
        }

        // Live mode - fetch actual call history
        const workshopStartTime = localStorage.getItem('workshopStartTime') || new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString();

        const response = await fetch('/api/tutorial-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'getWorkshopCallHistory',
            phoneNumber: selectedPhoneNumber,
            startTime: workshopStartTime,
            ciServiceSid: ciServiceSid,
            ...twilioCredentials
          })
        });

        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Failed to load call history');
        }

        // Hide load button, show history
        loadButton.style.display = 'none';
        historyContainer.style.display = 'block';

        const calls = data.calls || [];

        if (calls.length === 0) {
          historyContainer.innerHTML = `
            <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 8px; text-align: center;">
              <p style="margin: 0; color: white;">üìû No calls found yet. Make some test calls and come back!</p>
            </div>
          `;
          return;
        }

        // Render call history
        historyContainer.innerHTML = `
          <div style="background: white; color: #333; padding: 20px; border-radius: 8px;">
            <h4 style="margin: 0 0 15px 0; color: #1a73e8;">üìû Your Workshop Calls (${calls.length})</h4>

            ${calls.map((call, idx) => {
              const direction = call.direction === 'outbound-api' ? 'Outbound' : 'Inbound';
              const directionIcon = call.direction === 'outbound-api' ? 'üì§' : 'üì•';
              const duration = call.duration ? `${Math.floor(call.duration / 60)}m ${call.duration % 60}s` : 'N/A';
              const status = call.status || 'unknown';
              const statusColor = status === 'completed' ? '#56ab2f' : status === 'busy' ? '#e5c07b' : status === 'no-answer' ? '#c678dd' : '#ff6b6b';

              // CI data if available
              const ciData = call.conversationalIntelligence;
              const hasCIData = ciData && ciData.transcript;

              return `
                <div style="border: 2px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                  <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                    <div>
                      <strong>Call #${idx + 1}</strong> <span style="background: #e3f2fd; color: #1a73e8; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 8px;">${directionIcon} ${direction}</span>
                      <div style="font-size: 12px; color: #666; margin-top: 5px; line-height: 1.6;">
                        üì± ${direction === 'Outbound' ? `To: ${call.to}` : `From: ${call.from}`}<br>
                        üïê ${new Date(call.startTime).toLocaleString()}<br>
                        ‚è±Ô∏è Duration: ${duration}<br>
                        üìä Status: <span style="color: ${statusColor}; font-weight: bold;">${status}</span>
                      </div>
                    </div>
                  </div>

                  ${hasCIData ? `
                    <div style="background: #f0f9ff; padding: 12px; border-radius: 6px; margin-top: 10px; border-left: 4px solid #4fc1ff;">
                      <strong style="font-size: 13px; color: #1a73e8;">üß† AI Insights Available</strong>

                      ${ciData.sentiment ? `
                        <div style="margin-top: 8px;">
                          <span style="font-size: 12px; color: #666;">Sentiment:</span>
                          <span style="font-size: 20px; margin-left: 8px;">
                            ${ciData.sentiment === 'positive' ? 'üòä' : ciData.sentiment === 'negative' ? 'üòû' : 'üòê'}
                          </span>
                          <span style="color: ${ciData.sentiment === 'positive' ? '#56ab2f' : '#666'}; font-weight: bold; text-transform: uppercase; font-size: 12px; margin-left: 8px;">
                            ${ciData.sentiment}
                          </span>
                        </div>
                      ` : ''}

                      ${ciData.transcript && ciData.transcript.length > 0 ? `
                        <div style="margin-top: 10px;">
                          <strong style="font-size: 12px; color: #666;">Conversation Highlights:</strong>
                          <div style="max-height: 150px; overflow-y: auto; margin-top: 5px; font-size: 12px; line-height: 1.6;">
                            ${ciData.transcript.slice(0, 5).map(line => `
                              <div style="margin: 5px 0;">
                                <span style="color: #1a73e8; font-weight: bold;">${line.speaker === 'customer' ? 'üó£Ô∏è' : 'ü§ñ'}:</span>
                                ${line.text.substring(0, 100)}${line.text.length > 100 ? '...' : ''}
                              </div>
                            `).join('')}
                            ${ciData.transcript.length > 5 ? `<div style="color: #999; font-style: italic; margin-top: 5px;">+ ${ciData.transcript.length - 5} more lines</div>` : ''}
                          </div>
                        </div>
                      ` : `
                        <div style="padding: 8px; background: #fff3cd; border-radius: 4px; font-size: 12px; color: #856404; margin-top: 8px;">
                          ‚è≥ Transcript processing... (This can take a few minutes)
                        </div>
                      `}

                      ${ciData.topics && ciData.topics.length > 0 ? `
                        <div style="margin-top: 10px;">
                          <strong style="font-size: 12px; color: #666;">Topics:</strong>
                          <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-top: 5px;">
                            ${ciData.topics.map(topic => `
                              <span style="background: white; color: #1a73e8; padding: 3px 10px; border-radius: 10px; font-size: 11px; border: 1px solid #e3f2fd;">
                                ${topic}
                              </span>
                            `).join('')}
                          </div>
                        </div>
                      ` : ''}
                    </div>
                  ` : `
                    <div style="padding: 10px; background: #f8f9fa; border-radius: 6px; font-size: 12px; color: #666; margin-top: 10px;">
                      üí° Enable Conversational Intelligence to get AI-powered insights like sentiment analysis, transcripts, and topic detection.
                    </div>
                  `}

                  ${call.sid ? `
                    <div style="margin-top: 10px; display: flex; gap: 15px; flex-wrap: wrap;">
                      <a href="https://console.twilio.com/us1/monitor/logs/calls/${call.sid}" target="_blank"
                         style="color: #1a73e8; text-decoration: none; font-size: 12px; font-weight: bold;">
                        üìä View Full Details in Console ‚Üí
                      </a>
                      ${call.recordingUrl ? `
                        <a href="${call.recordingUrl}" target="_blank"
                           style="color: #e5c07b; text-decoration: none; font-size: 12px; font-weight: bold;">
                          üéôÔ∏è Listen to Recording ‚Üí
                        </a>
                      ` : ''}
                    </div>
                  ` : ''}
                </div>
              `;
            }).join('')}

            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #1a73e8;">
              <h5 style="margin: 0 0 10px 0; color: #1a73e8;">üìä Workshop Session Summary</h5>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 10px;">
                <div style="text-align: center;">
                  <div style="font-size: 28px; font-weight: bold; color: #1a73e8;">${calls.length}</div>
                  <div style="font-size: 12px; color: #666;">Total Calls</div>
                </div>
                <div style="text-align: center;">
                  <div style="font-size: 28px; font-weight: bold; color: #56ab2f;">${calls.filter(c => c.status === 'completed').length}</div>
                  <div style="font-size: 12px; color: #666;">Completed</div>
                </div>
                <div style="text-align: center;">
                  <div style="font-size: 28px; font-weight: bold; color: #667eea;">
                    ${Math.floor(calls.reduce((sum, c) => sum + (parseInt(c.duration) || 0), 0) / 60)}m
                  </div>
                  <div style="font-size: 12px; color: #666;">Total Duration</div>
                </div>
              </div>
            </div>
          </div>
        `;

      } catch (error) {
        console.error('Call history error:', error);
        historyContainer.style.display = 'block';
        historyContainer.innerHTML = `
          <div style="background: rgba(255, 0, 0, 0.2); padding: 20px; border-radius: 8px;">
            <p style="margin: 0; color: white;">‚ùå Failed to load call history: ${error.message}</p>
            <p style="margin: 10px 0 0 0; color: white; font-size: 14px;">
              This is normal if no calls have been made yet. Make a test call and try again!
            </p>
          </div>
        `;
      }
    }

    // Helper function to generate demo call cards
    function generateDemoCallCard(number, step, title, status, duration, description, hasAI = false) {
      return `
        <div style="border: 2px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
            <div>
              <strong>Call #${number}</strong> <span style="background: #e3f2fd; color: #1a73e8; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 8px;">${step}</span>
              <div style="font-size: 14px; color: #333; margin-top: 5px; font-weight: 600;">${title}</div>
              <div style="font-size: 12px; color: #666; margin-top: 5px; line-height: 1.6;">
                üì± To: ${selectedPhoneNumber || '+1234567890'}<br>
                üïê ${new Date(Date.now() - (3 - number) * 30 * 60 * 1000).toLocaleString()}<br>
                ‚è±Ô∏è Duration: ${duration}<br>
                üìä Status: <span style="color: #56ab2f; font-weight: bold;">${status}</span>
              </div>
            </div>
          </div>

          <div style="padding: 10px; background: #f8f9fa; border-radius: 6px; font-size: 12px; color: #666; margin-top: 10px;">
            ${description}
          </div>

          ${hasAI ? `
            <div style="background: #f0f9ff; padding: 12px; border-radius: 6px; margin-top: 10px; border-left: 4px solid #4fc1ff;">
              <strong style="font-size: 13px; color: #1a73e8;">üß† AI Insights</strong>
              <div style="margin-top: 8px;">
                <span style="font-size: 12px; color: #666;">Sentiment:</span>
                <span style="font-size: 20px; margin-left: 8px;">üòä</span>
                <span style="color: #56ab2f; font-weight: bold; text-transform: uppercase; font-size: 12px; margin-left: 8px;">POSITIVE</span>
              </div>
              <div style="margin-top: 10px;">
                <strong style="font-size: 12px; color: #666;">Topics Detected:</strong>
                <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-top: 5px;">
                  <span style="background: white; color: #1a73e8; padding: 3px 10px; border-radius: 10px; font-size: 11px; border: 1px solid #e3f2fd;">appointments</span>
                  <span style="background: white; color: #1a73e8; padding: 3px 10px; border-radius: 10px; font-size: 11px; border: 1px solid #e3f2fd;">scheduling</span>
                </div>
              </div>
            </div>
          ` : ''}
        </div>
      `;
    }

    function downloadProjectPackage() {
      // Create a comprehensive ZIP package with all code
      const projectFiles = {
        'README.md': generateReadme(),
        '.env.example': generateEnvFile(),
        'functions/ws-handler.js': document.getElementById('code5')?.value || '',
        'functions/twiml-handler.js': document.getElementById('code4')?.value || '',
        'package.json': generatePackageJson()
      };

      // For now, download key files individually
      // In production, you'd use JSZip library to create actual ZIP
      alert('üì¶ Downloading project files...\n\nNote: In production, this would download a complete ZIP package with all your code, configuration files, and README.');

      // Download the README
      downloadFile('README.md', generateReadme());
    }

    function generateReadme() {
      return `# Your Voice AI System

## What You Built

This is a production-ready Voice AI system built during the Twilio Voice AI Workshop.

### Components

- **Phone Number**: ${selectedPhoneNumber || 'Your Twilio number'}
- **Call Direction**: ${callDirection === 'inbound' ? 'Inbound' : 'Outbound'}
- **AI Model**: ${openaiApiKey ? 'OpenAI GPT' : 'Not configured'}
- **TTS Provider**: ${ttsProvider || 'ElevenLabs'}

### Features

‚úÖ Real-time audio streaming via WebSocket
‚úÖ AI-powered conversations with context awareness
‚úÖ State-based prompt engineering
‚úÖ Function calling (appointments, knowledge base, SMS)
‚úÖ Production-ready error handling

## Quick Start

1. Copy .env.example to .env and add your credentials
2. Run: npm install
3. Deploy: twilio serverless:deploy
4. Configure your phone number webhook

## Need Help?

- Documentation: https://www.twilio.com/docs/voice
- Workshop: https://github.com/geverist/twilio-voice-ai-workshop
- Support: File an issue on GitHub

Built with ‚ù§Ô∏è using Twilio ConversationRelay
`;
    }

    function generateEnvFile() {
      return `# Twilio Credentials
TWILIO_ACCOUNT_SID=${twilioCredentials?.accountSid || 'your_account_sid'}
TWILIO_AUTH_TOKEN=your_auth_token
DEFAULT_TWILIO_NUMBER=${selectedPhoneNumber || '+1234567890'}

# OpenAI Configuration
OPENAI_API_KEY=${openaiApiKey || 'your_openai_api_key'}

# Voice Configuration
TTS_PROVIDER=${ttsProvider || 'elevenlabs'}
VOICE_ID=${conversationRelayVoice || 'EXAVITQu4vr4xnSDxMaL'}

# Optional: Twilio Sync (for session management)
TWILIO_SYNC_SVC_SID=your_sync_service_sid
`;
    }

    function generatePackageJson() {
      return `{
  "name": "voice-ai-system",
  "version": "1.0.0",
  "description": "Voice AI system built with Twilio ConversationRelay",
  "dependencies": {
    "twilio": "^4.x",
    "openai": "^4.x",
    "ws": "^8.x"
  }
}`;
    }

    function checkDeploymentComplete() {
      const checkboxes = [
        'checkDeployPhone',
        'checkDeployFunctions',
        'checkDeployTest',
        'checkDeployAdmin',
        'checkDeployMonitor'
      ];

      const checked = checkboxes.filter(id => document.getElementById(id)?.checked).length;
      const completeBtn = document.getElementById('completeDeployBtn');

      if (completeBtn) {
        if (checked >= 3) {
          completeBtn.disabled = false;
          completeBtn.style.opacity = '1';
          completeBtn.style.cursor = 'pointer';
        } else {
          completeBtn.disabled = true;
          completeBtn.style.opacity = '0.5';
          completeBtn.style.cursor = 'not-allowed';
        }
      }
    }

    function completeDeploymentStep() {
      projectDeployed = true;
      showStatus('deployStatus', 'success', 'üéâ Congratulations! Your Voice AI system is deployed and ready for production!');

      // Show completion modal
      setTimeout(() => {
        const modal = document.createElement('div');
        modal.className = 'modal show';
        modal.innerHTML = `
          <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
              <h2 style="color: white; margin: 0;">üéâ Workshop Complete!</h2>
            </div>
            <div style="padding: 30px; text-align: center;">
              <div style="font-size: 64px; margin-bottom: 20px;">üöÄ</div>
              <h3 style="margin-bottom: 15px;">Congratulations!</h3>
              <p style="color: #666; line-height: 1.8; margin-bottom: 20px;">
                You've successfully built and deployed a production-ready Voice AI system with Twilio ConversationRelay.
                Your system is now live and ready to handle real conversations!
              </p>
              <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <strong>What You Accomplished:</strong><br>
                ‚úÖ Integrated Twilio Voice & OpenAI<br>
                ‚úÖ Built real-time WebSocket handler<br>
                ‚úÖ Mastered prompt engineering<br>
                ‚úÖ Added function calling & tools<br>
                ‚úÖ Deployed to production
              </div>
              <button onclick="window.location.reload()" class="btn btn-primary">
                Start New Workshop
              </button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      }, 500);

      saveProgressToStorage();
    }

    // Add event listener for deployment checklist
    document.addEventListener('change', (e) => {
      if (e.target.type === 'checkbox' && e.target.id && e.target.id.startsWith('checkDeploy')) {
        checkDeploymentComplete();
      }
    });

    // =========================================================================
    // STEP 6: DEPLOY - Deploy to User's Twilio Account
    // =========================================================================

    function renderStep_ToolingDeploy_OLD() {
      const isOutbound = callDirection === 'outbound';
      const code = document.getElementById('code4')?.value || '';

      return `
        <div class="step-content active">
          <div class="step-header">
            <h2>Deploy to Your Twilio Account</h2>
            <p>Let's deploy your ${isOutbound ? 'Dial' : 'IVR'} function to Twilio Serverless</p>
          </div>

          <div class="instructions">
            <h3>üìã What This Does</h3>
            <p>We'll deploy your TwiML handler as a Twilio Function so it can handle real calls.</p>
            <p style="margin-top: 15px;">
              üìö <strong>Documentation:</strong>
              <a href="https://www.twilio.com/docs/serverless/functions-assets" target="_blank">Twilio Functions</a> |
              <a href="https://www.twilio.com/docs/serverless/api" target="_blank">Serverless API</a>
            </p>
          </div>

          <div class="service-card">
            <h4>üì¶ Deployment Details</h4>
            <p><strong>Function Name:</strong> <code>voice-handler</code></p>
            <p><strong>Runtime:</strong> Node.js 18</p>
            <p><strong>Handler Type:</strong> ${isOutbound ? 'Outbound Dial' : 'Inbound IVR'}</p>
          </div>

          <div class="code-preview">
            <div class="code-header">
              <span>üìù Code to Deploy</span>
            </div>
            <pre style="background: #1e1e1e; color: #abb2bf; padding: 15px; border-radius: 6px; overflow-x: auto;">${code}</pre>
          </div>

          <div class="button-group">
            <button class="btn btn-primary" onclick="deployFunction()" style="font-size: 16px; padding: 12px 24px;">
              üöÄ Deploy to My Account
            </button>
          </div>

          <div id="step5Status" class="status-box"></div>

          <div class="button-group">
            <button class="btn btn-secondary" onclick="prevStep()">‚Üê Back</button>
            <button class="btn btn-primary ${step5Deployed ? 'next-action' : ''}" id="nextBtn5" onclick="nextStep()" ${step5Deployed ? '' : 'disabled'}>
              Next: ConversationRelay ‚Üí
            </button>
          </div>
        </div>
      `;
    }

    async function deployFunction() {
      const code = document.getElementById('code4')?.value || '';

      if (twilioCredentials?.demoMode) {
        showStatus('step5Status', 'info', 'üìù Demo Mode: Simulating deployment...');
        setTimeout(() => {
          functionsDeployed = true;
          deployedServiceSid = 'ZS' + Math.random().toString(36).substring(7);
          showStatus('step5Status', 'success', '‚úÖ Demo deployment complete! Function URL: https://demo-1234.twil.io/voice-handler');
          document.getElementById('nextBtn5').disabled = false;
          updateProgressBar();
        }, 2000);
        return;
      }

      showStatus('step5Status', 'info', '‚è≥ Deploying to your Twilio account...');

      try {
        const response = await fetch('/api/tutorial-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'deployFunction',
            functionName: 'voice-handler',
            functionCode: code,
            ...twilioCredentials
          })
        });

        const data = await response.json();

        if (data.success) {
          functionsDeployed = true;
          deployedServiceSid = data.serviceSid;
          showStatus('step5Status', 'success', `‚úÖ Deployed! Function URL: ${data.functionUrl}`);
          document.getElementById('nextBtn5').disabled = false;
          updateProgressBar();
        } else {
          showStatus('step5Status', 'error', `‚ùå Deployment failed: ${data.error}`);
        }
      } catch (error) {
        showStatus('step5Status', 'error', `‚ùå ${error.message}`);
      }
    }

    // =========================================================================
    // INCREMENTAL COMMIT - Deploy Code Step-by-Step
    // =========================================================================

    function saveWebSocketUrl(stepNumber) {
      const input = document.getElementById(`websocketUrlInput${stepNumber}`);
      const url = input?.value?.trim();

      if (!url) {
        alert('Please enter a WebSocket URL');
        return;
      }

      // Validate URL format
      if (!url.startsWith('wss://') && !url.startsWith('ws://')) {
        alert('WebSocket URL must start with wss:// or ws://');
        return;
      }

      // Save the WebSocket URL
      websocketUrl = url;

      // Mark the step as deployed
      if (stepNumber === 5) {
        step5Deployed = true;
        websocketBuilt = true;
      } else if (stepNumber === 7) {
        step7Deployed = true;
        promptEngineeringComplete = true;
      } else if (stepNumber === 8) {
        step8Deployed = true;
        toolsConfigured = true;
      }

      saveProgressToStorage();
      updateProgressBar();

      // Enable next button
      const nextBtn = document.getElementById(`nextBtn${stepNumber}`);
      if (nextBtn) {
        nextBtn.disabled = false;
      }

      // Show success message
      const statusId = `commitStep${stepNumber}Status`;
      showStatus(statusId, 'success', `‚úÖ WebSocket URL saved: ${url}`);
    }

    async function updatePhoneNumberWebhook() {
      // Update the phone number's voice URL to point to the deployed voice-handler
      if (!selectedPhoneNumberSid) {
        console.log('Phone number SID not available yet');
        console.log('selectedPhoneNumberSid:', selectedPhoneNumberSid);
        return;
      }

      if (!twilioServerlessDomain) {
        console.log('Twilio Serverless domain not available yet - function not deployed');
        return;
      }

      // Use Twilio Serverless domain for voice handler URL
      const voiceHandlerUrl = `https://${twilioServerlessDomain}/voice-handler`;

      try {
        console.log('Updating phone number webhook to:', voiceHandlerUrl);
        console.log('Phone number SID:', selectedPhoneNumberSid);

        const response = await fetch('/api/tutorial-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'updatePhoneNumber',
            phoneNumberSid: selectedPhoneNumberSid,
            voiceUrl: voiceHandlerUrl,
            voiceMethod: 'POST',
            ...twilioCredentials
          })
        });

        const result = await response.json();

        if (result.success) {
          console.log('‚úÖ Phone number webhook updated successfully');
          console.log(`üìû Phone ${selectedPhoneNumber} now points to: ${voiceHandlerUrl}`);
        } else {
          console.error('Failed to update phone number:', result.error);
        }
      } catch (error) {
        console.error('Error updating phone number webhook:', error);
      }
    }

    async function commitStep(stepNumber) {
      const statusId = `commitStep${stepNumber}Status`;
      const btnId = `commitStep${stepNumber}Btn`;

      // Map step numbers to actual next button IDs (due to numbering inconsistency)
      const stepToNextBtnMap = {
        4: 'nextBtn4',   // Step 4 ‚Üí nextBtn4
        5: 'nextBtn7',   // Step 5 ‚Üí nextBtn7
        6: 'nextBtn8',   // Step 6 ‚Üí nextBtn8
        7: 'nextBtn9',   // Step 7 ‚Üí nextBtn9
        8: 'nextBtn10'   // Step 8 ‚Üí nextBtn10
      };
      const nextBtnId = stepToNextBtnMap[stepNumber] || `nextBtn${stepNumber}`;

      // PREREQUISITE CHECK: Step 6 requires Step 5 to be deployed first
      if (stepNumber === 6 && !step5Deployed) {
        showStatus(statusId, 'error', '‚ö†Ô∏è Please deploy Step 5 (WebSocket Handler) first! ConversationRelay needs the WebSocket endpoint to connect to.');
        return;
      }

      // Get the button and disable it
      const btn = document.getElementById(btnId);
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<span class="loading" style="border: 3px solid rgba(255,255,255,0.3); border-top-color: white;"></span> Committing...';
      }

      // Show initial status
      showStatus(statusId, 'info', '‚è≥ Starting deployment...');

      // DEMO MODE: Simulate deployment
      if (studentDemoMode || twilioCredentials?.demoMode) {
        // Simulate deployment with realistic delays and messages

        // Steps 5, 7, 8 deploy to GitHub ‚Üí External hosting
        if (stepNumber === 5 || stepNumber === 7 || stepNumber === 8) {
          showStatus(statusId, 'info', 'üîÑ Demo: Committing code to GitHub...');
          await new Promise(resolve => setTimeout(resolve, 1500));

          showStatus(statusId, 'info', 'üöÄ Demo: GitHub push successful, triggering Railway deployment...');
          await new Promise(resolve => setTimeout(resolve, 1500));

          // Generate demo WebSocket URL
          const demoRepoName = studentRepoName || 'my-conversationrelay-app';
          websocketUrl = `wss://${demoRepoName}-demo.up.railway.app`;

          // Set deployed flags
          if (stepNumber === 5) {
            step5Committed = true;
            step5Deployed = true;
            websocketBuilt = true;
          } else if (stepNumber === 7) {
            step7Committed = true;
            step7Deployed = true;
            promptEngineeringComplete = true;
          } else if (stepNumber === 8) {
            step8Committed = true;
            step8Deployed = true;
            toolsConfigured = true;
          }

          saveProgressToStorage();
          updateProgressBar();

          showStatus(statusId, 'success', `
            ‚úÖ Demo deployment complete!<br><br>
            <strong>Commit:</strong> <a href="https://github.com/${githubUsername || 'demo-user'}/${demoRepoName}/commit/demo${Date.now()}" target="_blank">View on GitHub (Demo)</a><br>
            <strong>WebSocket URL:</strong> <code>${websocketUrl}</code><br><br>
            <small>üìù Note: In live mode, Railway/Render auto-deploys from GitHub.</small>
          `);

        } else {
          // Steps 4 & 6 deploy to Twilio Serverless
          showStatus(statusId, 'info', 'üì¶ Demo: Creating Twilio Serverless deployment...');
          await new Promise(resolve => setTimeout(resolve, 1500));

          showStatus(statusId, 'info', 'üì§ Demo: Uploading function code...');
          await new Promise(resolve => setTimeout(resolve, 1000));

          showStatus(statusId, 'info', 'üî® Demo: Building deployment...');
          await new Promise(resolve => setTimeout(resolve, 1000));

          // Set deployed flags based on step
          if (stepNumber === 4) {
            step4Committed = true;
            step4Deployed = true;
            deployedServiceSid = 'ZS' + Math.random().toString(36).substring(7);
            twilioServerlessDomain = 'demo-workshop-' + Math.random().toString(36).substring(7) + '.twil.io';

            // Clear all existing next-action highlights first
            document.querySelectorAll('.next-action').forEach(el => {
              el.classList.remove('next-action');
            });

            // Show the test section after deployment (demo mode)
            const testSection = document.getElementById('step4TestSection');
            if (testSection) {
              testSection.style.display = 'block';
              setTimeout(() => {
                testSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
              }, 500);
            }

            // Add next-action to the test call button
            const testCallBtn = document.getElementById('makeLiveTestCallBtn');
            if (testCallBtn) testCallBtn.classList.add('next-action');
          } else if (stepNumber === 6) {
            step6Committed = true;
            step6Deployed = true;

            // Clear all existing next-action highlights first
            document.querySelectorAll('.next-action').forEach(el => {
              el.classList.remove('next-action');
            });

            // Show the test section after deploying ConversationRelay (demo mode)
            const testSection = document.getElementById('step6TestCallSection');
            if (testSection) {
              testSection.style.display = 'block';
              setTimeout(() => {
                testSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
              }, 500);
            }

            // Add next-action to the test call button
            const testCallBtn6 = document.getElementById('makeLiveTestCallBtn6');
            if (testCallBtn6) testCallBtn6.classList.add('next-action');
          }

          saveProgressToStorage();
          updateProgressBar();

          showStatus(statusId, 'success', `‚úÖ Demo deployment complete! Test it below!`);
        }

        // Re-enable button
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = 'üíæ Commit Step ' + stepNumber;
        }

        // Enable next button
        const nextBtn = document.getElementById(nextBtnId);
        if (nextBtn) {
          nextBtn.disabled = false;
        }

        return;
      }

      try {
        // Determine which code to deploy based on step
        let functionCode = '';
        let functionName = 'voice-handler';

        if (stepNumber === 4) {
          // Step 4: Basic TwiML - Initial voice-handler
          functionCode = document.getElementById('code4')?.value || '';
          functionName = 'voice-handler';
        } else if (stepNumber === 5) {
          // Step 5: WebSocket Handler - NEW separate handler
          functionCode = document.getElementById('code7')?.value || '';
          functionName = 'websocket-handler';
        } else if (stepNumber === 6) {
          // Step 6: ConversationRelay - UPDATE voice-handler to use ConversationRelay
          functionCode = document.getElementById('code8')?.value || '';
          functionName = 'voice-handler';  // Update voice-handler with ConversationRelay
        } else if (stepNumber === 7) {
          // Step 7: Custom Prompt - UPDATE database with custom system prompt
          // Since we're using Railway shared server, no code deployment needed
          // The commit will update the database via the success handler below
          functionCode = null; // No code to deploy
          functionName = null;
        } else if (stepNumber === 8) {
          // Step 8: Tooling - Update websocket-handler with tools
          functionCode = document.getElementById('code9')?.value || '';
          functionName = 'websocket-handler';
        }

        // Step 7: Special handling - no code deployment, just database update
        if (stepNumber === 7) {
          showStatus(statusId, 'info', 'üíæ Updating system prompt in database...');

          try {
            const configResponse = await fetch('/api/student-config-save', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                sessionToken: sessionToken,
                studentName: studentName || githubUsername || 'Student',
                openaiApiKey: openaiApiKey,
                systemPrompt: customSystemPrompt || 'You are a helpful voice assistant. Keep responses brief and conversational since they will be spoken aloud.',
                tools: [],
                voiceSettings: {
                  provider: ttsProvider,
                  voice: conversationRelayVoice
                }
              })
            });

            const configData = await configResponse.json();

            if (!configData.success) {
              throw new Error(configData.error || 'Failed to update system prompt in database');
            }

            // Mark as deployed and proceed to success handler
            step7Committed = true;
            step7Deployed = true;
            saveProgressToStorage();

            showStatus(statusId, 'success', '‚úÖ Custom prompt updated successfully!');
            console.log('‚úÖ Step 7 deployed, step7Deployed =', step7Deployed);

            // Clear all existing next-action highlights first
            document.querySelectorAll('.next-action').forEach(el => {
              el.classList.remove('next-action');
            });

            // Enable Next button and add next-action effect
            const nextBtn9 = document.getElementById('nextBtn9');
            if (nextBtn9) {
              nextBtn9.disabled = false;
              nextBtn9.classList.add('next-action');
            }

            // Show the voice test section
            const testSection = document.getElementById('step7VoiceTestSection');
            if (testSection) {
              testSection.style.display = 'block';
              setTimeout(() => {
                testSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
              }, 500);
            }

            // Re-enable button
            if (btn) {
              btn.disabled = false;
              btn.innerHTML = '‚úÖ Committed';
            }

            return; // Skip the rest of the deployment process

          } catch (error) {
            showStatus(statusId, 'error', `‚ùå Failed to update prompt: ${error.message}`);
            if (btn) {
              btn.disabled = false;
              btn.innerHTML = 'üíæ Commit Step 7';
            }
            return;
          }
        }

        if (!functionCode) {
          throw new Error('No code found to deploy. Please write some code first.');
        }

        // Validate syntax before deploying
        showStatus(statusId, 'info', 'üîç Validating JavaScript syntax...');
        const validation = validateJavaScriptSyntax(functionCode);

        if (!validation.valid) {
          const errorMsg = `Syntax Error: ${validation.error}\nLocation: Line ${validation.line}, Column ${validation.column}\n\nPlease fix the syntax error before deploying.`;
          showStatus(statusId, 'error', `‚ùå ${errorMsg}`);

          // Re-enable the button
          if (btn) {
            btn.disabled = false;
            btn.innerHTML = 'üíæ Commit Step ' + stepNumber;
          }

          throw new Error(errorMsg);
        }

        showStatus(statusId, 'success', '‚úÖ Syntax validation passed');

        // Check for unfinished TODOs
        const todoMatches = functionCode.match(/\/\/\s*TODO:/gi);
        const todoCount = todoMatches ? todoMatches.length : 0;
        const codeLines = functionCode.split('\n').filter(line => {
          const trimmed = line.trim();
          return trimmed &&
                 !trimmed.startsWith('//') &&
                 !trimmed.startsWith('/*') &&
                 trimmed !== '{' &&
                 trimmed !== '}';
        }).length;

        // Warn if there are many TODOs relative to actual code
        if (todoCount > 5 || (codeLines > 0 && todoCount / codeLines > 0.3)) {
          showStatus(statusId, 'warning', `‚ö†Ô∏è You have ${todoCount} TODO comments. Make sure your code is complete!`);

          const confirmDeploy = confirm(
            `‚ö†Ô∏è Deployment Warning\n\n` +
            `Your code contains ${todoCount} TODO comments.\n` +
            `This suggests your implementation may be incomplete.\n\n` +
            `Are you sure you want to deploy?`
          );

          if (!confirmDeploy) {
            showStatus(statusId, 'info', 'Deployment cancelled. Please complete your TODOs first.');

            // Re-enable the button
            if (btn) {
              btn.disabled = false;
              btn.innerHTML = 'üíæ Commit Step ' + stepNumber;
            }

            return; // Cancel deployment
          }
        }

        // IMPORTANT: Steps 5, 7, 8 deploy to external hosting via GitHub, NOT Twilio Serverless
        // Only Steps 4 & 6 (voice handlers) deploy to Twilio Serverless
        if (stepNumber === 5 || stepNumber === 7 || stepNumber === 8) {
          // Deploy WebSocket handler to GitHub ‚Üí Railway/Render/Heroku
          showStatus(statusId, 'info', 'üîÑ Committing code to GitHub...');

          // Check if student has GitHub credentials
          if (!githubToken || !githubUsername) {
            showStatus(statusId, 'error', '‚ùå GitHub not connected. Please connect GitHub in Step 1 first!');
            if (btn) {
              btn.disabled = false;
              btn.innerHTML = 'üíæ Commit Step ' + stepNumber;
            }
            return;
          }

          // Determine file path based on step
          let filePath = 'index.js'; // Default WebSocket handler file
          let commitMessage = '';

          if (stepNumber === 5) {
            filePath = 'index.js';
            commitMessage = 'Add WebSocket handler for ConversationRelay';
          } else if (stepNumber === 7) {
            filePath = 'index.js';
            commitMessage = 'Update WebSocket handler with custom prompts';
          } else if (stepNumber === 8) {
            filePath = 'index.js';
            commitMessage = 'Update WebSocket handler with tools';
          }

          try {
            // Commit code to GitHub
            const commitBody = {
              accessToken: githubToken,
              githubUsername: githubUsername,
              repoName: studentRepoName || 'my-conversationrelay-app',
              filePath: filePath,
              fileContent: functionCode,
              commitMessage: commitMessage,
              stepNumber: stepNumber,
              sessionToken: sessionToken // Pass session token for student identification
            };

            const commitResponse = await fetch('/api/github-commit-code', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(commitBody)
            });

            const commitData = await commitResponse.json();

            if (!commitData.success) {
              throw new Error(commitData.error || 'Failed to commit code to GitHub');
            }

            showStatus(statusId, 'success', `‚úÖ Code committed to GitHub!<br><a href="${commitData.repoUrl}" target="_blank">View Repository</a>`);

            // Store the deployed URL
            websocketUrl = commitData.deployedUrl;

            // Mark step as deployed
            if (stepNumber === 5) {
              step5Deployed = true;
              websocketBuilt = true;
            } else if (stepNumber === 7) {
              step7Deployed = true;
              promptEngineeringComplete = true;
            } else if (stepNumber === 8) {
              step8Deployed = true;
              toolsConfigured = true;
            }

            saveProgressToStorage();
            updateProgressBar();

            // Enable next button
            const nextBtn = document.getElementById(nextBtnId);
            if (nextBtn) {
              nextBtn.disabled = false;
            }

            // Show deployment info
            showStatus(statusId, 'success', `
              <div style="text-align: left;">
                <div style="font-size: 16px; font-weight: 600; margin-bottom: 15px; color: #155724;">
                  ‚úÖ Deployment complete!
                </div>
                <div style="background: rgba(0,0,0,0.05); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                  <div style="margin-bottom: 10px;">
                    <strong style="color: #155724;">Commit:</strong>
                    <a href="${commitData.commitUrl}" target="_blank" style="color: #1a73e8; text-decoration: none; margin-left: 8px;">
                      View on GitHub ‚Üí
                    </a>
                  </div>
                  <div>
                    <strong style="color: #155724;">WebSocket URL:</strong>
                    <div style="background: rgba(0,0,0,0.1); padding: 10px; border-radius: 4px; margin-top: 8px; font-family: monospace; font-size: 12px; word-break: break-all; color: #333;">
                      ${commitData.deployedUrl}
                    </div>
                  </div>
                </div>
              </div>
            `);

          } catch (error) {
            console.error('GitHub commit error:', error);
            showStatus(statusId, 'error', `‚ùå Deployment failed: ${error.message}`);
          }

          // Re-enable button
          if (btn) {
            btn.disabled = false;
            btn.innerHTML = 'üíæ Commit Step ' + stepNumber;
          }

          return; // Exit early - don't deploy to Twilio
        }

        // Step 1: Create service + environment (if first commit)
        if (!deployedServiceSid) {
          showStatus(statusId, 'info', 'üì¶ Creating Twilio Serverless service...');

          const createResponse = await fetch('/api/deploy-step', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              step: 'create-service',
              accountSid: twilioCredentials.accountSid,
              authToken: twilioCredentials.authToken,
              phoneNumber: selectedPhoneNumber,
              openaiKey: openaiApiKey,
              websocketUrl: websocketUrl  // Pass WebSocket URL for Step 6 ConversationRelay
            })
          });

          const createData = await createResponse.json();
          if (!createData.success) {
            const errorMsg = createData.details || createData.error || 'Failed to create service';
            console.error('Create service error:', createData);
            throw new Error(errorMsg);
          }

          deployedServiceSid = createData.serviceSid;
          deployedEnvironmentSid = createData.environmentSid;
          twilioServerlessDomain = createData.domain; // Store Twilio Serverless domain

          showStatus(statusId, 'success', `‚úÖ Service created: ${deployedServiceSid}`);
          saveProgressToStorage();
        }

        // Step 2: Upload the function
        showStatus(statusId, 'info', `üì§ Uploading ${functionName}...`);

        const uploadResponse = await fetch('/api/deploy-step', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            step: 'upload-function-code',
            serviceSid: deployedServiceSid,
            functionCode: functionCode,
            filePath: `/${functionName}`,
            accountSid: twilioCredentials.accountSid,
            authToken: twilioCredentials.authToken
          })
        });

        const uploadData = await uploadResponse.json();
        if (!uploadData.success) {
          const errorMsg = uploadData.details || uploadData.error || 'Failed to upload function';
          console.error('Upload function error:', uploadData);
          throw new Error(errorMsg);
        }

        showStatus(statusId, 'success', `‚úÖ ${functionName} uploaded!`);

        // Step 3: Create build
        showStatus(statusId, 'info', `üî® Creating build...`);

        const buildResponse = await fetch('/api/deploy-step', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            step: 'create-build',
            serviceSid: deployedServiceSid,
            accountSid: twilioCredentials.accountSid,
            authToken: twilioCredentials.authToken
          })
        });

        const buildData = await buildResponse.json();
        if (!buildData.success) {
          const errorMsg = buildData.details || buildData.error || 'Failed to create build';
          console.error('Create build error:', buildData);
          throw new Error(errorMsg);
        }

        const buildSid = buildData.buildSid;
        showStatus(statusId, 'info', `‚è≥ Waiting for build to complete...`);

        // Step 4: Wait for build (poll every 2 seconds)
        let buildComplete = false;
        let attempts = 0;
        const maxAttempts = 30; // 60 seconds max

        while (!buildComplete && attempts < maxAttempts) {
          await new Promise(resolve => setTimeout(resolve, 2000));
          attempts++;

          const checkResponse = await fetch('/api/deploy-step', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              step: 'check-build',
              serviceSid: deployedServiceSid,
              buildSid: buildSid,
              accountSid: twilioCredentials.accountSid,
              authToken: twilioCredentials.authToken
            })
          });

          const checkData = await checkResponse.json();
          if (!checkData.success) throw new Error(checkData.error || 'Failed to check build status');

          buildComplete = !checkData.building;
          if (checkData.status === 'failed') {
            throw new Error('Build failed');
          }
        }

        if (!buildComplete) {
          throw new Error('Build timed out after 60 seconds');
        }

        showStatus(statusId, 'success', `‚úÖ Build completed!`);

        // Step 5: Deploy the build
        showStatus(statusId, 'info', `üöÄ Deploying to production...`);

        const deployResponse = await fetch('/api/deploy-step', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            step: 'deploy-build',
            serviceSid: deployedServiceSid,
            environmentSid: deployedEnvironmentSid,
            buildSid: buildSid,
            accountSid: twilioCredentials.accountSid,
            authToken: twilioCredentials.authToken
          })
        });

        const deployData = await deployResponse.json();
        if (!deployData.success) {
          const errorMsg = deployData.details || deployData.error || 'Failed to deploy build';
          console.error('Deploy build error:', deployData);
          throw new Error(errorMsg);
        }

        // Mark this step as committed/deployed
        if (stepNumber === 4) {
          step4Committed = true;
          step4Deployed = true; // Set deployed flag so test section appears

          // Save progress immediately
          saveProgressToStorage();
          updateProgressBar();

          showStatus(statusId, 'success', `‚úÖ ${functionName} deployed successfully! Test it below!`);

          // Update phone number webhook to point to deployed voice handler
          updatePhoneNumberWebhook();

          // Show inbound test card for inbound calls
          if (callDirection === 'inbound') {
            const testCard = document.getElementById('inboundTestCard');
            const progressBtn = document.getElementById('showProgressBtn');
            if (testCard) {
              testCard.style.display = 'block';
              if (progressBtn) progressBtn.style.display = 'block';
              // Scroll to the test card
              setTimeout(() => {
                testCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
              }, 500);
            }
          } else {
            // For outbound: show test section after deployment
            const testSection = document.getElementById('step4TestSection');
            if (testSection) {
              testSection.style.display = 'block';
              setTimeout(() => {
                testSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
              }, 500);
            }
          }

          // Clear all existing next-action highlights first
          document.querySelectorAll('.next-action').forEach(el => {
            el.classList.remove('next-action');
          });

          // Add next-action to the test call button
          const testCallBtn = document.getElementById('makeLiveTestCallBtn');
          if (testCallBtn) testCallBtn.classList.add('next-action');
        }
        if (stepNumber === 5) {
          step5Committed = true;
          step5Deployed = true;

          // Save progress immediately
          saveProgressToStorage();

          showStatus(statusId, 'success', '‚úÖ WebSocket handler deployed successfully!');
          console.log('‚úÖ Step 5 deployed, step5Deployed =', step5Deployed);

          // Clear all existing next-action highlights first
          document.querySelectorAll('.next-action').forEach(el => {
            el.classList.remove('next-action');
          });

          // Add next-action to Next button
          const nextBtn = document.getElementById('nextBtn7');
          if (nextBtn) {
            nextBtn.disabled = false;
            nextBtn.classList.add('next-action');
          }

          // Re-render step content to show test section (with small delay to ensure state is set)
          setTimeout(() => {
            renderStepContent();

            // Wait for DOM to update, then reveal test section
            setTimeout(() => {
              const testSection = document.getElementById('step5TestSection');
              if (testSection) {
                testSection.style.display = 'block';

                // Disable test button for 30 seconds while deployment propagates
                const sendTestBtn = testSection.querySelector('button[onclick*="testSingleWebSocketMessage"]');
                const testInput = document.getElementById('testWebSocketMessage');

                if (sendTestBtn) sendTestBtn.disabled = true;
                if (testInput) testInput.disabled = true;

                // Show countdown timer
                let countdown = 30;
                const originalSendText = sendTestBtn ? sendTestBtn.innerHTML : '';

                const countdownInterval = setInterval(() => {
                  countdown--;
                  if (sendTestBtn) sendTestBtn.innerHTML = `‚è≥ Wait ${countdown}s`;

                  if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    if (sendTestBtn) {
                      sendTestBtn.disabled = false;
                      sendTestBtn.innerHTML = originalSendText;
                    }
                    if (testInput) testInput.disabled = false;

                    celebrate('‚úÖ Ready to test! Deployment has propagated.', 'normal');
                  }
                }, 1000);

                setTimeout(() => {
                  testSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 500);
              }
            }, 50);
          }, 100);
        }
        if (stepNumber === 6) {
          step6Committed = true;
          step6Deployed = true;

          // Save progress immediately
          saveProgressToStorage();

          showStatus(statusId, 'success', '‚úÖ ConversationRelay deployed successfully!');
          console.log('‚úÖ Step 6 deployed, step6Deployed =', step6Deployed);

          // Update phone number with the new voice-handler URL after ConversationRelay deployment
          updatePhoneNumberWebhook();

          // Move next-action effect from Deploy button to Next button
          const deployBtn = document.getElementById('commitStep6Btn');
          if (deployBtn) {
            deployBtn.classList.remove('next-action');
          }

          // Show the test section after deploying ConversationRelay
          const testSection = document.getElementById('step6TestCallSection');
          if (testSection) {
            testSection.style.display = 'block';
            setTimeout(() => {
              testSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 500);
          }

          // Clear all existing next-action highlights first
          document.querySelectorAll('.next-action').forEach(el => {
            el.classList.remove('next-action');
          });

          // Enable Next button and add next-action effect
          const nextBtn8 = document.getElementById('nextBtn8');
          if (nextBtn8) {
            nextBtn8.disabled = false;
            nextBtn8.classList.add('next-action');
          }

          // Show SDK version notice
          showSDKVersionNotice();
        }
        // Step 7 is handled in special case above (lines 8357-8430)
        if (stepNumber === 8) {
          step8Committed = true;
          toolsConfigured = true;

          // Update student config with tools in database
          if (!studentDemoMode && !twilioCredentials?.demoMode) {
            try {
              console.log('üíæ Updating student config with tools...');

              // Extract tools from the code (if any)
              const tools = []; // TODO: Parse tools from functionCode when Step 8 tools are defined

              const configResponse = await fetch('/api/student-config-save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  sessionToken: sessionToken,
                  studentName: studentName || githubUsername || 'Student',
                  openaiApiKey: openaiApiKey,
                  systemPrompt: customSystemPrompt || 'You are a helpful voice assistant. Keep responses brief and conversational since they will be spoken aloud.',
                  tools: tools,
                  voiceSettings: {
                    provider: ttsProvider,
                    voice: conversationRelayVoice
                  }
                })
              });

              const configData = await configResponse.json();

              if (configData.success) {
                console.log('‚úÖ Student config updated with tools');
              } else {
                console.warn('‚ö†Ô∏è Failed to update config with tools:', configData.error);
              }
            } catch (error) {
              console.error('‚ùå Error updating config with tools:', error);
              // Don't fail deployment if config update fails
            }
          }

          // Save progress immediately
          saveProgressToStorage();

          showStatus(statusId, 'success', '‚úÖ Tools configured successfully!');
          console.log('‚úÖ Step 8 deployed, toolsConfigured =', toolsConfigured);

          // Clear all existing next-action highlights first
          document.querySelectorAll('.next-action').forEach(el => {
            el.classList.remove('next-action');
          });

          // Add next-action to Save & Continue button (nextBtn10)
          const nextBtn10 = document.getElementById('nextBtn10');
          if (nextBtn10) {
            nextBtn10.disabled = false;
            nextBtn10.classList.add('next-action');
          }
        }

        functionsDeployed = true;
        saveProgressToStorage();
        updateProgressBar();

        // Enable the Next button (but only for outbound - inbound needs to confirm test first)
        const nextBtn = document.getElementById(nextBtnId);
        if (nextBtn && !(stepNumber === 4 && callDirection === 'inbound')) {
          nextBtn.disabled = false;
        }

        // Update button to show success
        if (btn) {
          btn.innerHTML = '‚úÖ Committed!';
          btn.style.background = '#28a745';
        }

        // For WebSocket handler deployment (step 5), add propagation delay for test button
        if (stepNumber === 5) {
          const testBtn = document.querySelector('button[onclick="testCode7()"]');
          if (testBtn) {
            testBtn.disabled = true;
            testBtn.style.opacity = '0.5';
            let countdown = 30;
            const originalText = testBtn.innerHTML;

            const updateButton = () => {
              testBtn.innerHTML = `‚è±Ô∏è Wait ${countdown}s for propagation...`;
            };

            updateButton();
            const interval = setInterval(() => {
              countdown--;
              if (countdown <= 0) {
                clearInterval(interval);
                testBtn.disabled = false;
                testBtn.style.opacity = '1';
                testBtn.innerHTML = originalText;
              } else {
                updateButton();
              }
            }, 1000);
          }
        }

        // Show final success message with URL
        const deploymentUrl = `https://${websocketUrl}`;
        showStatus(statusId, 'success', `
          <div style="padding: 15px; background: #d4edda; border-radius: 8px; border-left: 4px solid #28a745;">
            <strong>üéâ Step ${stepNumber} Committed Successfully!</strong><br>
            <div style="margin-top: 10px; font-size: 14px;">
              üì¶ Service: ${deployedServiceSid}<br>
              üîó URL: ${deploymentUrl}<br>
              üìù Function: ${functionName}
            </div>
            <div style="margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.5); border-radius: 4px;">
              <strong>‚úì Your code is now deployed and live!</strong><br>
              ${stepNumber === 5 ? '‚è±Ô∏è Note: Test button will be available in 30 seconds (deployment propagation time)<br>' : ''}
              You can proceed to test it or continue to the next step.
            </div>
          </div>
        `);

      } catch (error) {
        console.error('Commit error:', error);

        // Try to extract more detailed error info
        let errorMsg = error.message || 'Unknown error';
        if (error.response) {
          try {
            const errorData = await error.response.json();
            errorMsg = errorData.details || errorData.error || errorMsg;
            console.error('Error details:', errorData);
          } catch (e) {
            console.error('Could not parse error response');
          }
        }

        showStatus(statusId, 'error', `‚ùå Deployment failed: ${errorMsg}`);

        // Re-enable button on error
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = 'üíæ Commit Step ' + stepNumber;
          btn.style.background = '';
        }
      }
    }

    // =========================================================================
    // STEP 5: TEST BASIC CALL - Test Without AI
    // =========================================================================

    function renderStep_PromptEngineering_OLD() {
      const isOutbound = callDirection === 'outbound';

      return `
        <div class="step-content active">
          <div class="step-header">
            <h2>Test Your ${isOutbound ? 'Outbound' : 'Inbound'} Call</h2>
            <p>Let's make sure your basic ${isOutbound ? 'Dial' : 'IVR'} is working</p>
          </div>

          <div class="instructions">
            <h3>üìã Testing Instructions</h3>
            ${isOutbound ? `
              <p>We'll initiate a call from your Twilio number to a destination number.</p>
              <p>Enter your phone number below to test the Dial functionality.</p>
            ` : `
              <p>Configure your Twilio phone number to use the deployed function.</p>
              <p>Then call your Twilio number to hear the IVR menu.</p>
            `}
          </div>

          ${isOutbound ? `
            <div class="service-card">
              <h4>üìû Make Test Call</h4>
              <div style="margin-top: 15px;">
                <label style="display: block; margin-bottom: 5px;">Your Phone Number (to receive the call):</label>
                <input type="tel" id="testPhoneNumber" placeholder="+1234567890"
                       style="width: 100%; padding: 10px; border: 1px solid #3e4451; background: #1e1e1e; color: #abb2bf; border-radius: 4px; font-size: 16px; margin-bottom: 15px;">

                <label style="display: block; margin-bottom: 5px;">Target Number (to dial after answering):</label>
                <input type="tel" id="testDialTarget" placeholder="+1234567890"
                       style="width: 100%; padding: 10px; border: 1px solid #3e4451; background: #1e1e1e; color: #abb2bf; border-radius: 4px; font-size: 16px;">
                <p style="font-size: 12px; color: #666; margin: 5px 0 0 0;">The number that will be dialed when you answer (can be the same as your number)</p>
              </div>
              <button class="btn btn-primary" onclick="makeTestCall()" style="margin-top: 15px; width: 100%;">
                üìû Call Me Now
              </button>
            </div>
          ` : `
            <div class="service-card">
              <h4>üì≤ Configure Phone Number</h4>
              <p>Your deployed function URL has been configured automatically.</p>
              <p><strong>Call this number to test:</strong></p>
              <div id="twilioPhoneDisplay" style="font-size: 24px; font-weight: bold; margin: 15px 0; color: #4fc1ff;"></div>
              <button class="btn btn-secondary" onclick="confirmInboundTest()">
                ‚úì I Called and It Works
              </button>
            </div>
          `}

          <div id="step6Status" class="status-box"></div>

          <div class="button-group">
            <button class="btn btn-secondary" onclick="prevStep()">‚Üê Back</button>
            <button class="btn btn-primary ${step6Deployed ? 'next-action' : ''}" id="nextBtn6" onclick="nextStep()" ${step6Deployed ? '' : 'disabled'}>
              Next: Prompt Engineering ‚Üí
            </button>
          </div>
        </div>
      `;
    }

    async function makeTestCall() {
      const phoneNumber = document.getElementById('testPhoneNumber')?.value?.trim();
      const targetNumber = document.getElementById('testDialTarget')?.value?.trim();

      if (!phoneNumber) {
        showStatus('step6Status', 'error', '‚ùå Please enter your phone number');
        return;
      }

      if (!targetNumber) {
        showStatus('step6Status', 'error', '‚ùå Please enter a target number to dial');
        return;
      }

      if (!phoneNumber.startsWith('+')) {
        showStatus('step6Status', 'error', '‚ö†Ô∏è Your phone number must use E.164 format (e.g., +1234567890)');
        return;
      }

      if (!targetNumber.startsWith('+')) {
        showStatus('step6Status', 'error', '‚ö†Ô∏è Target number must use E.164 format (e.g., +1234567890)');
        return;
      }

      // Check for demo mode - multiple conditions for safety
      if (twilioCredentials?.demoMode ||
          twilioCredentials?.accountSid?.startsWith('ACdemo') ||
          !twilioCredentials?.accountSid ||
          twilioCredentials?.accountSid === 'ACdemo123456789012345678901234567890') {
        showStatus('step6Status', 'info', 'üìù Demo Mode: Simulating call...');
        setTimeout(() => {
          basicCallTested = true;
          showStatus('step6Status', 'success', '‚úÖ Demo call completed! (In real mode, your phone would ring)');
          document.getElementById('nextBtn6').disabled = false;
          updateProgressBar();
        }, 2000);
        return;
      }

      showStatus('step6Status', 'info', 'üìû Initiating call...');

      // Extract dial parameters from code (optional)
      const code = document.getElementById('code4')?.value || '';
      const timeoutMatch = code.match(/timeout:\s*(\d+)/);
      const timeout = timeoutMatch ? timeoutMatch[1] : '30';

      const mdMatch = code.match(/machineDetection:\s*['"]([^'"]+)['"]/);
      const machineDetection = mdMatch ? mdMatch[1] : null;

      try {
        const response = await fetch('/api/tutorial-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'makeCall',
            to: phoneNumber,
            from: selectedPhoneNumber,
            dialTarget: targetNumber,
            timeout: timeout,
            machineDetection: machineDetection,
            ...twilioCredentials
          })
        });

        const data = await response.json();

        if (data.success) {
          basicCallTested = true;
          showStatus('step6Status', 'success', `‚úÖ Call initiated! CallSid: ${data.callSid}. The call will dial ${targetNumber}.`);
          document.getElementById('nextBtn6').disabled = false;
          updateProgressBar();
        } else {
          showStatus('step6Status', 'error', `‚ùå Call failed: ${data.error}`);
        }
      } catch (error) {
        showStatus('step6Status', 'error', `‚ùå ${error.message}`);
      }
    }

    function confirmInboundTest() {
      basicCallTested = true;
      step6Deployed = true; // Mark Step 6 as deployed for inbound (no actual deployment needed)
      setState("step6Deployed", true); // Persist to database
      showStatus('step6Status', 'success', '‚úÖ Great! Your IVR is working. Ready for the next step!');
      document.getElementById('nextBtn6').disabled = false;
      updateProgressBar();
      saveProgressToStorage(); // Save to localStorage
    }

    function confirmInboundTestStep4() {
      basicCallTested = true;
      showStatus('step4Status', 'success', '‚úÖ Perfect! Your IVR is working. Ready for the next step!');
      document.getElementById('nextBtn4').disabled = false;
      updateProgressBar();
      celebrate('üéâ Great job! Your first voice handler is live!', 'light');
    }

    function showCallProgress() {
      const tracker = document.getElementById('callProgressTracker');
      const btn = document.getElementById('showProgressBtn');
      if (tracker) {
        tracker.style.display = 'block';
        btn.style.display = 'none';

        // Animate stages sequentially
        const stages = [
          { id: 'stage1', delay: 500, duration: 2000 },    // Call initiated (immediate + ringing)
          { id: 'stage2', delay: 2500, duration: 3000 },   // Greeting (answer + play)
          { id: 'stage3', delay: 5500, duration: 4000 },   // Menu options
          { id: 'stage4', delay: 9500, duration: 10000 },  // Waiting for input (10s timeout)
          { id: 'stage5', delay: 19500, duration: 3000 }   // Goodbye & hangup
        ];

        stages.forEach(stage => {
          setTimeout(() => {
            activateStage(stage.id);
          }, stage.delay);

          setTimeout(() => {
            completeStage(stage.id);
          }, stage.delay + stage.duration);
        });

        // Show completion message after all stages
        setTimeout(() => {
          const tracker = document.getElementById('callProgressTracker');
          if (tracker) {
            tracker.innerHTML += `
              <div style="margin-top: 15px; padding: 15px; background: rgba(40, 167, 69, 0.3); border: 1px solid #28a745; border-radius: 6px; color: white;">
                <strong>‚úÖ Call Flow Complete!</strong><br>
                <span style="font-size: 13px; opacity: 0.9;">This is the typical flow for your inbound IVR. Now test it for real!</span>
              </div>
            `;
          }
        }, 22500);
      }
    }

    function hideCallProgress() {
      const tracker = document.getElementById('callProgressTracker');
      const btn = document.getElementById('showProgressBtn');
      if (tracker && btn) {
        tracker.style.display = 'none';
        btn.style.display = 'block';
        // Reset stages
        for (let i = 1; i <= 5; i++) {
          const stage = document.getElementById(`stage${i}`);
          if (stage) {
            stage.style.opacity = '0.5';
            const circle = stage.querySelector('span');
            if (circle) {
              circle.style.background = '#666';
              circle.innerHTML = i;
            }
          }
        }
        // Remove completion message if present
        const completionMsg = tracker.querySelector('[style*="rgba(40, 167, 69"]');
        if (completionMsg) completionMsg.remove();
      }
    }

    function activateStage(stageId) {
      const stage = document.getElementById(stageId);
      if (stage) {
        stage.style.opacity = '1';
        stage.style.transition = 'all 0.3s ease';
        const circle = stage.querySelector('span');
        if (circle) {
          circle.style.background = '#4fc1ff';
          circle.innerHTML = '‚è≥';
        }
      }
    }

    function completeStage(stageId) {
      const stage = document.getElementById(stageId);
      if (stage) {
        const circle = stage.querySelector('span');
        if (circle) {
          circle.style.background = '#28a745';
          circle.innerHTML = '‚úì';
        }
      }
    }

    // =========================================================================
    // STEP 6 (case 5): CONVERSATIONRELAY - Upgrade to AI
    // =========================================================================

    function renderStep_ConversationRelay() {
      const step = steps[currentStep];
      // Use the deployed service domain if available, otherwise fallback to current host
      if (!websocketUrl && deployedServiceSid) {
        // websocketUrl should already be set from deployment, but if not, we can't proceed
        console.error('WebSocket URL not set after deployment');
      }

      return `
        <div class="step-content active">
          <div class="step-header">
            <h2>Step ${step.id}: ${step.title}</h2>
            <p>Replace your basic ${callDirection === 'outbound' ? 'Dial' : 'IVR'} with AI-powered conversation</p>
          </div>

          ${!step5Deployed && !websocketUrl ? `
          <div style="padding: 20px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 8px; margin: 20px 0;">
            <h4 style="margin: 0 0 10px 0; color: #856404;">‚ö†Ô∏è Prerequisite Required</h4>
            <p style="margin: 0; color: #856404; line-height: 1.6;">
              Before deploying ConversationRelay, you must first complete <strong>Step 5 (WebSocket Handler)</strong>.
              ConversationRelay connects to your WebSocket handler endpoint to enable real-time AI conversations.
            </p>
            <button class="btn btn-secondary" onclick="navigateToStep(4)" style="margin-top: 15px; background: #856404; border: none;">
              ‚Üê Go Back to Step 5
            </button>
          </div>
          ` : ''}

          <!-- TTS Provider Selection -->
          <div class="service-card">
            <h4>üéôÔ∏è Text-to-Speech Provider</h4>
            <p style="font-size: 13px; color: #666; margin-bottom: 15px;">
              Choose which AI voice service ConversationRelay will use to speak AI responses to callers.
            </p>
            <div class="form-group">
              <label>TTS Provider</label>
              <select id="ttsProvider" onchange="saveTTSProvider()" style="width: 100%; padding: 10px; background: #1e1e1e; color: #abb2bf; border: 1px solid #3e4451; border-radius: 4px;">
                <option value="elevenlabs">ElevenLabs (Default - Ultra-Premium Natural Voices)</option>
                <option value="amazon-polly">Amazon Polly (Free, Excellent Quality)</option>
                <option value="google">Google Cloud Text-to-Speech (Premium)</option>
              </select>
            </div>

            <!-- Provider Info -->
            <div id="ttsProviderInfo" style="margin-top: 15px;">
              <div style="padding: 15px; background: #2c313c; border-radius: 8px; border-left: 3px solid #4fc1ff;">
                <p style="margin: 0 0 10px 0; color: #4fc1ff; font-size: 14px; font-weight: 600;">
                  <span id="ttsProviderIcon">üîä</span> <span id="ttsProviderName">Amazon Polly</span>
                </p>
                <p id="ttsProviderDescription" style="margin: 0; color: #abb2bf; font-size: 13px; line-height: 1.6;">
                  Included with Twilio at no additional cost. Provides high-quality, natural-sounding voices in multiple languages.
                </p>
                <div id="ttsProviderNote" style="margin-top: 10px; color: #98c379; font-size: 12px;">
                  ‚úÖ No additional configuration needed
                </div>
              </div>
            </div>

            <!-- Voice Selection -->
            <div class="form-group" style="margin-top: 20px;">
              <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #4fc1ff;">
                üó£Ô∏è Voice Selection
              </label>
              <select id="conversationRelayVoice" style="width: 100%; padding: 12px; background: #1e1e1e; color: #abb2bf; border: 1px solid #3e4451; border-radius: 4px; font-size: 14px;" onchange="saveConversationRelayVoice(); updateConversationRelayCode();">
                ${getVoiceOptions()}
              </select>
              <p style="font-size: 12px; color: #666; margin-top: 5px;">
                Choose the voice for your AI assistant using ${getTTSProviderName()}
              </p>
            </div>
          </div>

          <div class="instructions">
            <h3>üìã Your Task</h3>
            <p>Create TwiML with ConversationRelay that connects to your WebSocket handler:</p>
            <code style="background: #1e1e1e; color: #4fc1ff; padding: 4px 8px; border-radius: 4px;">${websocketUrl}/websocket-handler</code>
            <p style="margin-top: 15px;">
              üìö <strong>Documentation:</strong>
              <a href="https://www.twilio.com/docs/voice/twiml" target="_blank">TwiML Overview</a> |
              <a href="https://www.twilio.com/docs/voice/twiml/connect" target="_blank">&lt;Connect&gt; Verb</a> |
              <a href="https://www.twilio.com/docs/voice/twiml/connect/conversationrelay" target="_blank">ConversationRelay</a> |
              <a href="https://www.twilio.com/docs/voice/conversationrelay/best-practices" target="_blank">Best Practices</a>
            </p>
          </div>

          <div class="service-card" style="background: #f8f9fa; border-left: 4px solid #4fc1ff; margin: 20px 0;">
            <h4 style="color: #0d122b; margin-bottom: 15px;">üéõÔ∏è Advanced ConversationRelay Configuration</h4>
            <p style="margin-bottom: 10px; line-height: 1.6; color: #333;">
              ConversationRelay supports many configuration options to customize your AI voice assistant:
            </p>
            <ul style="margin-left: 20px; color: #555; line-height: 1.8;">
              <li><strong>interruptible:</strong> Control if callers can interrupt the AI ('none', 'dtmf', 'speech', 'any')</li>
              <li><strong>language:</strong> Set default language (e.g., 'en-US', 'es-ES', 'fr-FR', 'multi' for auto-detect)</li>
              <li><strong>transcriptionProvider:</strong> Choose STT provider ('google', 'deepgram')</li>
              <li><strong>hints:</strong> Help recognize domain-specific terms, brand names, or technical jargon</li>
              <li><strong>dtmfDetection:</strong> Enable keypad tone detection for IVR-style interactions</li>
            </ul>
            <p style="margin-top: 10px; font-size: 13px; color: #666; font-style: italic;">
              üí° Tip: Start simple with basic settings, then add advanced features as needed!
            </p>
          </div>

          <div class="service-card" style="background: linear-gradient(135deg, #4fc1ff 0%, #0d122b 100%); color: white; margin: 20px 0;">
            <h4 style="color: white; margin-bottom: 15px;">üéì What is ConversationRelay?</h4>
            <p style="margin-bottom: 15px; line-height: 1.6;">
              Explore how ConversationRelay works with this interactive visualization.
              See the real-time flow of events between Twilio, your WebSocket server, and the AI.
            </p>
            <button class="btn btn-primary" onclick="openPlayground()" style="background: white; color: #0d122b; border: none;">
              üìñ Learn How It Works
            </button>
            <p style="margin-top: 10px; font-size: 12px; opacity: 0.9;">
              Opens an interactive diagram to understand the architecture
            </p>
          </div>

          <!-- ConversationRelay Settings Panel -->
          <div class="service-card" style="background: #2c313c; border: 2px solid #4fc1ff; margin: 20px 0;">
            <h4 style="color: #4fc1ff; margin-bottom: 15px;">‚öôÔ∏è ConversationRelay Settings</h4>
            <p style="margin-bottom: 20px; color: #abb2bf; font-size: 14px;">
              Customize these settings before deploying. They'll be automatically injected into your code.
            </p>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
              <!-- Left Column -->
              <div>
                <!-- Welcome Greeting -->
                <div class="form-group" style="margin-bottom: 20px;">
                  <label style="display: block; margin-bottom: 8px; color: #4fc1ff; font-weight: 600; cursor: help;" title="The initial greeting message that callers hear when the AI answers. This sets the tone for the conversation and should clearly state who or what the AI assistant is. Leave empty to skip the greeting and let the caller speak first.">
                    üëã Welcome Greeting (Optional)
                  </label>
                  ${skipInitialGreeting ? `
                  <div style="background: #e3f2fd; border: 2px solid #90caf9; padding: 12px; border-radius: 6px; margin-bottom: 10px;">
                    <div style="color: #1976d2; font-size: 13px; line-height: 1.5;">
                      <strong>‚úì Skip Initial Greeting Enabled</strong><br>
                      The AI will wait for the caller to speak first. You can override this by entering a greeting below.
                    </div>
                  </div>
                  ` : ''}
                  <input
                    type="text"
                    id="crWelcomeGreeting"
                    value="${generatedContent?.ivrGreeting || 'Hello! I am your AI assistant. How can I help you today?'}"
                    placeholder="Leave empty to skip greeting and wait for caller"
                    onchange="updateConversationRelayCode()"
                    style="width: 100%; padding: 10px; background: #1e1e1e; color: #abb2bf; border: 1px solid #3e4451; border-radius: 4px; font-size: 13px;"
                  />
                  <p style="font-size: 11px; color: #666; margin-top: 5px;">First message callers hear. <strong>Leave empty</strong> to skip greeting and have AI wait for caller to speak first.</p>
                </div>

                <!-- Language -->
                <div class="form-group" style="margin-bottom: 20px;">
                  <label style="display: block; margin-bottom: 8px; color: #4fc1ff; font-weight: 600; cursor: help;" title="Sets the language for speech recognition and TTS. Choose a specific language for best accuracy, or use 'multi' to automatically detect the caller's language. Language auto-detection adds slight latency but supports multilingual callers.">
                    üåç Language
                  </label>
                  <select
                    id="crLanguage"
                    onchange="updateConversationRelayCode()"
                    style="width: 100%; padding: 10px; background: #1e1e1e; color: #abb2bf; border: 1px solid #3e4451; border-radius: 4px; font-size: 13px;">
                    <option value="en-US">English (US)</option>
                    <option value="en-GB">English (UK)</option>
                    <option value="es-ES">Spanish (Spain)</option>
                    <option value="es-MX">Spanish (Mexico)</option>
                    <option value="fr-FR">French</option>
                    <option value="de-DE">German</option>
                    <option value="it-IT">Italian</option>
                    <option value="pt-BR">Portuguese (Brazil)</option>
                    <option value="multi">Multi-Language (Auto-Detect)</option>
                  </select>
                  <p style="font-size: 11px; color: #666; margin-top: 5px;">Use 'multi' for automatic language detection</p>
                </div>

                <!-- Transcription Provider -->
                <div class="form-group" style="margin-bottom: 20px;">
                  <label style="display: block; margin-bottom: 8px; color: #4fc1ff; font-weight: 600; cursor: help;" title="Choose which Speech-to-Text (STT) engine transcribes caller speech. Deepgram offers faster processing and better accuracy for conversational AI. Google Cloud STT provides excellent accuracy for specific use cases. Both are included with Twilio at no additional cost.">
                    üé§ Transcription Provider
                  </label>
                  <select
                    id="crTranscriptionProvider"
                    onchange="updateConversationRelayCode()"
                    style="width: 100%; padding: 10px; background: #1e1e1e; color: #abb2bf; border: 1px solid #3e4451; border-radius: 4px; font-size: 13px;">
                    <option value="deepgram">Deepgram (Recommended)</option>
                    <option value="google">Google Cloud STT</option>
                  </select>
                  <p style="font-size: 11px; color: #666; margin-top: 5px;">Speech-to-Text provider</p>
                </div>
              </div>

              <!-- Right Column -->
              <div>
                <!-- Interruptible -->
                <div class="form-group" style="margin-bottom: 20px;">
                  <label style="display: block; margin-bottom: 8px; color: #4fc1ff; font-weight: 600; cursor: help;" title="Controls whether callers can interrupt the AI while it's speaking. 'speech' allows natural conversation flow where callers can speak over the AI. 'any' also allows keypad interruptions. 'dtmf' only allows keypad interruptions. 'none' makes the AI finish speaking before listening.">
                    üîá Interruption Control
                  </label>
                  <select
                    id="crInterruptible"
                    onchange="updateConversationRelayCode()"
                    style="width: 100%; padding: 10px; background: #1e1e1e; color: #abb2bf; border: 1px solid #3e4451; border-radius: 4px; font-size: 13px;">
                    <option value="speech">Speech (Recommended)</option>
                    <option value="any">Any (Speech or DTMF)</option>
                    <option value="dtmf">DTMF Only</option>
                    <option value="none">None</option>
                  </select>
                  <p style="font-size: 11px; color: #666; margin-top: 5px;">How callers can interrupt the AI</p>
                </div>

                <!-- DTMF Detection -->
                <div class="form-group" style="margin-bottom: 20px;">
                  <label style="display: block; margin-bottom: 8px; color: #4fc1ff; font-weight: 600; cursor: help;" title="Dual-Tone Multi-Frequency (DTMF) detection allows your AI to recognize phone keypad presses (0-9, *, #). Enable this for IVR-style interactions like 'Press 1 for sales' or collecting numeric input like account numbers. Your WebSocket handler receives dtmf events when keys are pressed.">
                    üî¢ DTMF Detection
                  </label>
                  <select
                    id="crDtmfDetection"
                    onchange="updateConversationRelayCode()"
                    style="width: 100%; padding: 10px; background: #1e1e1e; color: #abb2bf; border: 1px solid #3e4451; border-radius: 4px; font-size: 13px;">
                    <option value="true">Enabled</option>
                    <option value="false">Disabled</option>
                  </select>
                  <p style="font-size: 11px; color: #666; margin-top: 5px;">Enable keypad tone detection</p>
                </div>

                <!-- Speech Hints -->
                <div class="form-group" style="margin-bottom: 20px;">
                  <label style="display: block; margin-bottom: 8px; color: #4fc1ff; font-weight: 600; cursor: help;" title="Provide domain-specific words or phrases to improve speech recognition accuracy. Useful for brand names, technical jargon, product names, or industry terms that might be misheard. Enter as comma-separated list. Example: 'Twilio,ConversationRelay,API,WebSocket' helps the STT engine correctly recognize these technical terms.">
                    üí° Speech Recognition Hints
                  </label>
                  <input
                    type="text"
                    id="crHints"
                    value=""
                    placeholder="Twilio,ConversationRelay,API,WebSocket"
                    onchange="updateConversationRelayCode()"
                    style="width: 100%; padding: 10px; background: #1e1e1e; color: #abb2bf; border: 1px solid #3e4451; border-radius: 4px; font-size: 13px;"
                  />
                  <p style="font-size: 11px; color: #666; margin-top: 5px;">Comma-separated terms to improve recognition</p>
                </div>
              </div>
            </div>

            <button
              class="btn btn-primary"
              onclick="updateConversationRelayCode()"
              style="margin-top: 15px; width: 100%; padding: 12px;">
              üîÑ Apply Settings to Code
            </button>
          </div>

          <div class="code-editor">
            <div class="code-header">
              <span>üìù ConversationRelay TwiML Handler</span>
              <div style="display: flex; gap: 10px;">
                <button class="btn btn-success ${(!step6CodeValidated || code8Changed) ? 'next-action' : ''}" style="padding: 6px 12px; font-size: 13px; ${(step6CodeValidated && !code8Changed) ? 'opacity: 0.5;' : ''}" onclick="validateCode8()" ${(step6CodeValidated && !code8Changed) ? 'disabled' : ''}>‚úì Validate</button>
                <button class="btn-copy" onclick="copyCode('code8')">üìã Copy Code</button>
                <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 13px;" onclick="resetCode8()">Reset</button>
              </div>
            </div>
            <textarea class="code-textarea" id="code8" oninput="handleCodeChange('code8')">exports.handler = function(context, event, callback) {
  const twilio = require('twilio');
  const VoiceResponse = twilio.twiml.VoiceResponse;
  const response = new VoiceResponse();

  // Log SDK version for debugging
  console.log('Twilio SDK version:', require('twilio/package.json').version);

  // OLD: Basic TwiML (from Step 4)
  // response.say('Hello world', { voice: '${getDefaultVoice()}' });
  // response.dial('+1234567890');

  // NEW: Upgrade to ConversationRelay with AI
  const connect = response.connect();
  console.log('conversationRelay method exists?', typeof connect.conversationRelay);

  // Build WebSocket handler URL
  // IMPORTANT: Your WebSocket server is hosted externally (Railway/Render/Heroku)
  // NOT on Twilio Serverless! Use the environment variable you set during deployment.
  const wsHandlerUrl = context.WEBSOCKET_URL || 'wss://your-app.up.railway.app';
  console.log('WebSocket handler URL:', wsHandlerUrl);

  // Validate WebSocket URL format
  if (!wsHandlerUrl.startsWith('wss://')) {
    console.error('ERROR: WebSocket URL must use wss:// protocol');
  }

  // Popular ElevenLabs Voices - swap the voice ID to try different voices:
  // '4YYIPFl9wE5c4L2eu2Gb' - Bert Reynolds (Charismatic and Smooth) - DEFAULT
  // '9XfYMbJVZqPHaQtYnTAO' - Cody (Energetic Upbeat Educator)
  // '4CrZuIW9am7gYAxgo2Af' - Shelley (Clear and confident British female)
  // '8N2ng9i2uiUWqstgmWlH' - Beth (Gentle and nurturing)
  // '90ipbRoKi4CpHXvKVtl0' - Anika (Customer Care Agent)
  // '9PvnT6XRzlljoaDG6Knu' - Ranbir (Warm & Friendly)
  // '7S3KNdLDL7aRgBVRQb1z' - Nathaniel (Deep Rich Mature British)
  // '6dcFFb31LVaCdYevmTAx' - Jerry (Presenter, Announcer, Event)

  connect.conversationRelay({
    // Required: WebSocket endpoint URL
    url: wsHandlerUrl,

    // Optional: Initial greeting message
    welcomeGreeting: '${generatedContent?.ivrGreeting || "Hello! I am your AI assistant. How can I help you today?"}',

    // Voice Configuration
    voice: '4YYIPFl9wE5c4L2eu2Gb',  // Bert Reynolds - Charismatic and Smooth
    ttsProvider: 'elevenlabs',       // Options: 'elevenlabs', 'amazon', 'google'

    // Language Settings
    language: 'en-US',               // Default language (or 'multi' for auto-detect)
    // transcriptionLanguage: 'en-US', // Override STT language
    // ttsLanguage: 'en-US',           // Override TTS language

    // Speech Recognition
    transcriptionProvider: 'deepgram', // Options: 'google', 'deepgram'
    // speechModel: 'nova-2',           // Deepgram model (nova-2, enhanced, base)

    // Interruption Control
    interruptible: 'speech',         // Options: 'none', 'dtmf', 'speech', 'any'

    // DTMF (Keypad) Detection
    dtmfDetection: true,             // Enable keypad tone detection

    // Speech Recognition Hints (helps with domain-specific terms)
    // hints: 'Twilio,ConversationRelay,WebSocket,API'
  });

  callback(null, response);
};</textarea>
</invoke>
          </div>

          <div id="step8Status" class="status-box"></div>

          ${!step6CodeValidated ? `
          <div id="step6Placeholder" class="instructions" style="margin-top: 20px; background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px;">
            <p style="margin: 0; color: #856404;">
              üí° <strong>Next Steps:</strong> Validate your code above to unlock deployment.
            </p>
          </div>
          ` : ''}

          <div id="step6DeploySection" style="margin: 30px 0; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; border: 2px solid #5a67d8; display: ${step6CodeValidated ? 'block' : 'none'};">
            <h3 style="color: white; margin: 0 0 15px 0; font-size: 1.2rem;">üíæ Deploy ConversationRelay</h3>
            <p style="color: rgba(255,255,255,0.9); margin-bottom: 20px;">
              Click <strong>Commit Step 6</strong> to deploy ConversationRelay to your Twilio account.
              This will update your voice handler with AI-powered conversation capabilities and configure your phone number.
            </p>
            <button
              class="btn btn-success ${step6CodeValidated && !step6Deployed ? 'next-action' : ''}"
              id="commitStep6Btn"
              onclick="commitStep(6)"
              style="font-size: 1.1rem; padding: 15px 30px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
              üíæ Commit Step 6 - Deploy ConversationRelay
            </button>
            <div id="commitStep6Status" style="margin-top: 15px;"></div>
          </div>

          <!-- Test ConversationRelay with basic prompt -->
          <div id="step6TestCallSection" style="margin: 30px 0; display: ${step6Deployed ? 'block' : 'none'};">
            <div style="padding: 25px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 12px; border: 2px solid #059669; color: white;">
              <h3 style="color: white; margin: 0 0 15px 0; font-size: 1.2rem;">üéôÔ∏è Test ConversationRelay with AI</h3>

              <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h4 style="color: white; margin: 0 0 12px 0; font-size: 1.1rem;">ü§ñ What You'll Experience:</h4>
                <ul style="margin: 0; padding-left: 20px; color: rgba(255,255,255,0.95); line-height: 1.9;">
                  <li><strong>Speech-to-Text (STT):</strong> Your voice is transcribed in real-time by ${document.getElementById('crTranscriptionProvider')?.value === 'google' ? 'Google Cloud STT' : 'Deepgram'}</li>
                  <li><strong>AI Processing:</strong> OpenAI processes your transcribed speech and generates intelligent responses</li>
                  <li><strong>Text-to-Speech (TTS):</strong> The AI's response is converted to natural voice using ${getTTSProviderName()}</li>
                  <li><strong>ConversationRelay:</strong> Orchestrates this entire flow with low latency and handles interruptions</li>
                </ul>
              </div>

              <p style="color: rgba(255,255,255,0.9); margin-bottom: 15px; line-height: 1.7;">
                <strong>Test your AI voice bot now!</strong> ${generatedContent ? 'Using your custom AI prompt based on your use case.' : 'This uses a basic prompt to demonstrate the technology. You\'ll customize the AI\'s personality in Step 7.'}
              </p>
              ${generatedContent ? `
              <p style="color: rgba(255,255,255,0.85); margin-bottom: 20px; font-size: 13px; line-height: 1.6; font-style: italic;">
                ‚ú® AI-generated prompt: "${generatedContent.systemPrompt.substring(0, 150)}${generatedContent.systemPrompt.length > 150 ? '...' : ''}"
              </p>
              ` : `
              <p style="color: rgba(255,255,255,0.85); margin-bottom: 20px; font-size: 13px; line-height: 1.6; font-style: italic;">
                üí° Current prompt: "You are a helpful voice assistant. Keep responses brief and conversational since they will be spoken aloud."
              </p>
              `}
            <div style="text-align: center;">
              <h3 style="color: white; margin: 0 0 10px 0; font-size: 1.5rem;">üìû Ready to Test Your AI Voice Bot?</h3>
              <p style="color: rgba(255,255,255,0.95); margin-bottom: 20px; font-size: 1.1rem; line-height: 1.6;">
                Your ConversationRelay setup is complete! ${callDirection === 'inbound' ? 'Make a test call' : 'The system will call you'} to validate everything is working.
              </p>

              <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 20px; border-radius: 8px; margin: 20px 0;">
                ${callDirection === 'inbound' ? `
                  <p style="color: rgba(255,255,255,0.9); margin: 0 0 10px 0; font-size: 0.95rem;">
                    üì± <strong>Call this number to test:</strong>
                  </p>
                  <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-top: 10px;">
                    <div id="testPhoneNumber" style="font-size: 2rem; font-weight: bold; color: white; font-family: 'Courier New', monospace; letter-spacing: 2px;">
                      ${selectedPhoneNumber || 'Configure phone number in Step 3'}
                    </div>
                    <button
                      onclick="copyPhoneNumber()"
                      style="padding: 10px 20px; background: white; color: #059669; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 1rem; transition: all 0.3s;"
                      onmouseover="this.style.background='#f0fdf4'; this.style.transform='scale(1.05)'"
                      onmouseout="this.style.background='white'; this.style.transform='scale(1)'">
                      üìã Copy
                    </button>
                  </div>
                ` : `
                  <p style="color: rgba(255,255,255,0.9); margin: 0 0 15px 0; font-size: 0.95rem;">
                    üìû <strong>Test your AI bot with an outbound call</strong>
                  </p>
                  <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: white;">
                      Your Phone Number (to receive AI call):
                    </label>
                    <input type="tel" id="testAICallNumber" placeholder="+12345678901" value="${window.savedTestPhoneNumber || ''}"
                           style="width: 100%; padding: 12px; background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.3); border-radius: 6px; font-size: 16px; font-family: 'Courier New', monospace;">
                    <p style="font-size: 12px; color: rgba(255,255,255,0.8); margin: 5px 0 0 0;">Enter YOUR number in E.164 format (e.g., +1234567890)</p>
                  </div>
                  <button onclick="makeAITestCall()" class="btn btn-primary" style="width: 100%; background: white; color: #059669; font-weight: 600; font-size: 1.1rem; padding: 15px;">
                    üìû Call Me Now with AI
                  </button>
                  <div id="aiTestCallStatus" style="margin-top: 15px;"></div>
                  <p style="color: rgba(255,255,255,0.8); margin: 15px 0 0 0; font-size: 0.9rem;">
                    Calling from: <strong style="color: white;">${selectedPhoneNumber || 'No number configured'}</strong>
                  </p>
                `}
              </div>

              <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin-top: 20px; text-align: left;">
                <p style="color: white; margin: 0 0 10px 0; font-weight: 600; font-size: 1rem;">
                  ‚úÖ What to expect:
                </p>
                <ul style="color: rgba(255,255,255,0.9); margin: 0; padding-left: 20px; line-height: 1.8;">
                  <li>AI greeting: "${document.getElementById('crWelcomeGreeting')?.value || 'Hello! I am your AI assistant. How can I help you today?'}"</li>
                  <li>Your AI will act as: <strong>${useCaseDescription ? useCaseDescription.substring(0, 80) + (useCaseDescription.length > 80 ? '...' : '') : 'a helpful assistant'}</strong></li>
                  <li>Natural conversation powered by OpenAI</li>
                  <li>Voice selected: <strong>${getVoiceName(getDefaultVoice())}</strong> (${getTTSProviderName()})</li>
                  <li>Real-time bidirectional streaming via ConversationRelay</li>
                </ul>
              </div>

              <p style="color: rgba(255,255,255,0.85); margin: 20px 0 0 0; font-size: 0.9rem; font-style: italic;">
                üí° Tip: Try asking questions or having a conversation to test the AI's responses!
              </p>
            </div>

            <div style="margin-top: 25px; padding-top: 20px; border-top: 2px solid rgba(255,255,255,0.2);">
              <button
                class="btn btn-secondary"
                onclick="navigateToStep(6)"
                style="width: 100%; background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.4); color: white; font-weight: 600; font-size: 1rem; padding: 12px;">
                ‚è≠Ô∏è Skip Testing - Go to Step 7 (Prompt Engineering)
              </button>
              <p style="color: rgba(255,255,255,0.75); margin: 10px 0 0 0; font-size: 13px; text-align: center;">
                You can customize the AI prompt first, then test in Step 7
              </p>
            </div>
          </div>
          </div>

          <div class="button-group">
            <button class="btn btn-secondary" onclick="prevStep()">‚Üê Back</button>
            <button class="btn btn-primary ${step6Deployed ? 'next-action' : ''}" id="nextBtn6" onclick="nextStep()" ${step6Deployed ? '' : 'disabled'}>
              Next: Prompt Engineering ‚Üí
            </button>
          </div>
        </div>
      `;
    }

    // Syntax validation helper for debugger
    function validateJavaScriptSyntax(code) {
      try {
        // Special handling for Node.js/Express code (Step 5 WebSocket handler)
        // These files use top-level statements like const app = express(), app.listen(), etc.
        // They don't fit in a function wrapper, so we need a different validation approach
        const isNodeJSCode = code.includes('require(') &&
                             (code.includes('express()') || code.includes('WebSocketServer') ||
                              code.includes('app.listen('));

        if (isNodeJSCode) {
          // For Node.js code, wrap the entire code as a module
          // This allows top-level statements like const app = express()
          new Function('require', 'module', 'exports', '__dirname', '__filename', 'process', code);
          return { valid: true };
        } else {
          // For Twilio Serverless functions (exports.handler), wrap in async function
          new Function(`return (async function() { ${code} });`)();
          return { valid: true };
        }
      } catch (error) {
        return {
          valid: false,
          error: error.message,
          line: error.lineNumber || 'unknown',
          column: error.columnNumber || 'unknown'
        };
      }
    }

    function testCode8() {
      const code = document.getElementById('code8').value;
      const console8 = document.getElementById('console8');
      console8.style.display = 'block';

      // First, validate syntax
      console8.innerHTML = '<div class="console-line">üîç Validating JavaScript syntax...</div>';
      const validation = validateJavaScriptSyntax(code);

      if (!validation.valid) {
        console8.innerHTML += `<div class="console-line error">‚ùå Syntax Error: ${validation.error}</div>`;
        console8.innerHTML += `<div class="console-line error">   Location: Line ${validation.line}, Column ${validation.column}</div>`;
        console8.innerHTML += '<div class="console-line info">üí° Fix the syntax error before testing or deploying.</div>';
        return;
      }

      console8.innerHTML += '<div class="console-line success">‚úì Syntax validation passed</div>';

      // Check for TODOs and warn
      const todoMatches = code.match(/\/\/\s*TODO:/gi);
      if (todoMatches && todoMatches.length > 3) {
        console8.innerHTML += `<div class="console-line warning">‚ö†Ô∏è Warning: ${todoMatches.length} TODO comments found. Make sure to implement them!</div>`;
      }

      try {
        // Get dynamic values
        const wsHandlerUrl = `${websocketUrl}/websocket-handler`;
        const voice = getDefaultVoice();

        // Simulate execution
        console8.innerHTML = `
          <div class="console-line">‚ñ∂Ô∏è Testing ConversationRelay TwiML generation...</div>
          <div class="console-line info">WebSocket Handler URL: ${wsHandlerUrl}</div>
          <div class="console-line info">Voice: ${voice}</div>
          <div class="console-line info">TTS Provider: ${getConversationRelayTTSProvider(ttsProvider)}</div>
          <div class="console-line">Output:</div>
          <div class="console-line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div>
          <div class="console-line">&lt;Response&gt;</div>
          <div class="console-line">  &lt;Connect&gt;</div>
          <div class="console-line">    &lt;ConversationRelay</div>
          <div class="console-line">      url="${wsHandlerUrl}"</div>
          <div class="console-line">      voice="${voice}"</div>
          <div class="console-line">      ttsProvider="${getConversationRelayTTSProvider(ttsProvider)}"</div>
          <div class="console-line">      welcomeGreeting="${generatedContent?.ivrGreeting || 'Hello! I am your AI assistant. How can I help you today?'}"</div>
          <div class="console-line">    /&gt;</div>
          <div class="console-line">  &lt;/Connect&gt;</div>
          <div class="console-line">&lt;/Response&gt;</div>
          <div class="console-line success">‚úì TwiML will connect calls to your deployed WebSocket handler</div>
        `;

        // Mark as tested and reveal deploy section
        step6CodeTested = true;
        const deploySection = document.getElementById('step6DeploySection');
        if (deploySection) {
          deploySection.style.display = 'block';
          setTimeout(() => {
            deploySection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          }, 300);
        }
      } catch (error) {
        console8.innerHTML = `<div class="console-line error">‚ùå ${error.message}</div>`;
      }
    }

    function validateCode8() {
      const code = document.getElementById('code8').value;

      const checks = {
        hasTwiml: code.includes('twiml') || code.includes('VoiceResponse'),
        hasConnect: code.includes('.connect()'),
        hasConversationRelay: code.includes('conversationRelay'),
        hasUrl: code.includes('url:'),
        hasVoice: code.includes('voice:'),
        hasTTS: code.includes('ttsProvider')
      };

      const allValid = Object.values(checks).every(v => v);

      if (allValid) {
        conversationRelayCreated = true;
        step6CodeValidated = true;
        showStatus('step6Status', 'success', '‚úÖ Perfect! ConversationRelay TwiML is valid. Deploy it below!');
        updateProgressBar();

        // Clear all existing next-action highlights first
        document.querySelectorAll('.next-action').forEach(el => {
          el.classList.remove('next-action');
        });

        // Disable the validate button
        const validateBtn = document.querySelector('[onclick="validateCode8()"]');
        if (validateBtn) {
          validateBtn.disabled = true;
          validateBtn.style.opacity = '0.5';
        }

        // Add next-action to deploy button
        const deployBtn = document.getElementById('commitStep6Btn');
        if (deployBtn) deployBtn.classList.add('next-action');

        // Reset code change flag
        code8Changed = false;

        // Enable next button (Step 6 uses nextBtn8)
        const nextBtn = document.getElementById('nextBtn8');
        if (nextBtn) nextBtn.disabled = false;

        // Hide placeholder and reveal deploy section
        const placeholder = document.getElementById('step6Placeholder');
        if (placeholder) placeholder.style.display = 'none';
        const deploySection = document.getElementById('step6DeploySection');
        if (deploySection) {
          deploySection.style.display = 'block';
          setTimeout(() => {
            deploySection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          }, 300);
        }
      } else {
        const missing = [];
        if (!checks.hasTwiml) missing.push('VoiceResponse object');
        if (!checks.hasConnect) missing.push('connect() method');
        if (!checks.hasConversationRelay) missing.push('conversationRelay()');
        if (!checks.hasUrl) missing.push('url parameter');
        if (!checks.hasVoice) missing.push('voice parameter');
        if (!checks.hasTTS) missing.push('ttsProvider parameter');

        showStatus('step6Status', 'error', `‚ùå Missing: ${missing.join(', ')}`);
      }
    }

    function resetCode8() {
      document.getElementById('code8').value = `exports.handler = function(context, event, callback) {
  const twilio = require('twilio');
  const VoiceResponse = twilio.twiml.VoiceResponse;
  const response = new VoiceResponse();

  // Log SDK version for debugging
  console.log('Twilio SDK version:', require('twilio/package.json').version);

  // OLD: Basic TwiML (from Step 4)
  // response.say('Hello world', { voice: '${getDefaultVoice()}' });
  // response.dial('+1234567890');

  // NEW: Upgrade to ConversationRelay with AI
  const connect = response.connect();
  console.log('conversationRelay method exists?', typeof connect.conversationRelay);

  // WebSocket handler URL (hosted on Railway)
  const wsHandlerUrl = '${codespaceUrl || websocketUrl}';

  connect.conversationRelay({
    url: wsHandlerUrl,
    voice: '${getConversationRelayVoice(getDefaultVoice())}',
    ttsProvider: '${getConversationRelayTTSProvider(ttsProvider)}',${customWelcomeGreeting ? `
    welcomeGreeting: '${customWelcomeGreeting.replace(/'/g, "\\'")}',` : `
    // welcomeGreeting omitted - AI waits for caller to speak first`}
    dtmfDetection: true
  });

  callback(null, response);
};`;
      // Clear status (Step 6 uses step6Status)
      const statusEl = document.getElementById('step6Status');
      if (statusEl) statusEl.innerHTML = '';

      // Mark as not validated so user can re-validate
      step6CodeValidated = false;
      code8Changed = false;

      // Re-render to update validate button state
      renderStepContent();
    }

    // Validate Step 8 WebSocket Handler with Tools & Knowledge Base
    function validateCode9() {
      const code = document.getElementById('code9').value;

      // Validation checks for advanced WebSocket handler with tools
      const checks = {
        hasOpenAI: code.includes('OpenAI') || code.includes('openai'),
        hasTwilio: code.includes('twilio'),
        hasTools: code.includes('tools') && code.includes('type: "function"'),
        hasKnowledgeBase: code.includes('knowledgeBase') || code.includes('knowledge'),
        hasSystemPrompt: code.includes('systemPrompt') || code.includes('system'),
        hasWebSocket: code.includes('ws.on') || code.includes('event.request'),
        hasToolFunctions: (
          code.includes('check_availability') || code.includes('checkAvailability')
        ) && (
          code.includes('book_appointment') || code.includes('bookAppointment')
        ) && (
          code.includes('send_confirmation_sms') || code.includes('sendConfirmationSMS')
        ),
        hasConversationHistory: code.includes('conversationHistory') || code.includes('messages'),
        hasAsyncHandler: code.includes('async function') || code.includes('await')
      };

      const allValid = Object.values(checks).every(v => v);

      if (allValid) {
        toolsConfigured = true;
        showStatus('step9Status', 'success', '‚úÖ Excellent! Your WebSocket handler with tools and knowledge base is complete!');
        updateProgressBar();

        // Clear all existing next-action highlights first
        document.querySelectorAll('.next-action').forEach(el => {
          el.classList.remove('next-action');
        });

        // Disable the validate button
        const validateBtn = document.querySelector('[onclick="validateCode9()"]');
        if (validateBtn) {
          validateBtn.disabled = true;
          validateBtn.style.opacity = '0.5';
        }

        // Add next-action to Commit button
        const commitBtn = document.getElementById('commitStep8Btn');
        if (commitBtn) {
          commitBtn.classList.add('next-action');
        }

        // Reset code change flag
        code9Changed = false;
      } else {
        const missing = [];
        if (!checks.hasOpenAI) missing.push('OpenAI import/initialization');
        if (!checks.hasTwilio) missing.push('Twilio client');
        if (!checks.hasTools) missing.push('Tools array definition');
        if (!checks.hasKnowledgeBase) missing.push('Knowledge base');
        if (!checks.hasSystemPrompt) missing.push('System prompt');
        if (!checks.hasWebSocket) missing.push('WebSocket event handlers');
        if (!checks.hasToolFunctions) missing.push('Tool implementation functions (check_availability, book_appointment, send_confirmation_sms)');
        if (!checks.hasConversationHistory) missing.push('Conversation history tracking');
        if (!checks.hasAsyncHandler) missing.push('Async/await pattern');

        showStatus('step9Status', 'error', `‚ùå Missing elements: ${missing.join(', ')}`);
      }
    }

    // Map internal TTS provider names to ConversationRelay enum values
    function getConversationRelayTTSProvider(provider) {
      const mapping = {
        'amazon-polly': 'amazon',
        'google': 'google',
        'elevenlabs': 'elevenlabs'
      };
      return mapping[provider] || 'amazon';
    }

    // Strip 'Polly.' prefix from Amazon voice names for ConversationRelay
    function getConversationRelayVoice(voice) {
      if (!voice) return voice;
      // Amazon Polly voices come as 'Polly.Joanna' but ConversationRelay expects 'Joanna'
      if (voice.startsWith('Polly.')) {
        return voice.replace('Polly.', '');
      }
      return voice;
    }

    // Update ConversationRelay code based on settings
    function updateConversationRelayCode() {
      // Use customWelcomeGreeting if set (from Step 7), otherwise fall back to input field or generated content
      const greetingValue = customWelcomeGreeting || document.getElementById('crWelcomeGreeting')?.value?.trim() || '';
      const language = document.getElementById('crLanguage')?.value || 'en-US';
      const transcriptionProvider = document.getElementById('crTranscriptionProvider')?.value || 'deepgram';
      const interruptible = document.getElementById('crInterruptible')?.value || 'speech';
      const dtmfDetection = document.getElementById('crDtmfDetection')?.value || 'true';
      const hints = document.getElementById('crHints')?.value || '';
      const voice = getConversationRelayVoice(document.getElementById('conversationRelayVoice')?.value || getDefaultVoice());
      const ttsProviderValue = getConversationRelayTTSProvider(document.getElementById('ttsProvider')?.value || 'amazon-polly');

      // Build hints line if provided
      const hintsLine = hints ? `    hints: '${hints}',` : `    // hints: 'Twilio,ConversationRelay,WebSocket,API'`;

      // Build welcome greeting line - omit if empty
      const greetingLine = greetingValue ? `    welcomeGreeting: '${greetingValue.replace(/'/g, "\\'")}',` : `    // welcomeGreeting: 'Hello!', // Omitted - AI waits for caller to speak first`;

      // Add CI service if enabled
      const intelligenceLine = ciServiceSid ? `\n    // Conversational Intelligence (transcripts, sentiment, topics)\n    intelligenceService: '${ciServiceSid}',\n` : '';

      const code = `exports.handler = function(context, event, callback) {
  const twilio = require('twilio');
  const VoiceResponse = twilio.twiml.VoiceResponse;
  const response = new VoiceResponse();

  // Log SDK version for debugging
  console.log('Twilio SDK version:', require('twilio/package.json').version);

  const connect = response.connect();
  console.log('conversationRelay method exists?', typeof connect.conversationRelay);

  // WebSocket handler URL (hosted on Railway)
  const wsHandlerUrl = '${codespaceUrl || websocketUrl}';

  connect.conversationRelay({
    // Required: WebSocket endpoint URL
    url: wsHandlerUrl,

    // Optional: Initial greeting message
${greetingLine}

    // Voice Configuration
    voice: '${voice}',
    ttsProvider: '${ttsProviderValue}',

    // Language Settings
    language: '${language}',

    // Speech Recognition
    transcriptionProvider: '${transcriptionProvider}',

    // Interruption Control
    interruptible: '${interruptible}',

    // DTMF (Keypad) Detection
    dtmfDetection: ${dtmfDetection},

    // Speech Recognition Hints (helps with domain-specific terms)
${hintsLine}${intelligenceLine}
  });

  callback(null, response);
};`;

      document.getElementById('code8').value = code;

      // Show success message
      showStatus('step8Status', 'success', '‚úÖ Code updated with your settings! Review and test when ready.');
    }

    // =========================================================================
    // STEP 5: WEBSOCKET - Build WebSocket Handler
    // =========================================================================

    function renderStep_WebSocket() {
      const step = steps[currentStep];
      return `
        <div class="step-content active">
          <div class="step-header">
            <h2>Step ${step.id}: ${step.title}</h2>
            <p>Build the AI backend that integrates with ConversationRelay</p>
          </div>

          <!-- Educational Context -->
          <div class="instructions" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
            <h3 style="color: white;">üìö What You'll Build</h3>
            <p style="color: rgba(255,255,255,0.95); line-height: 1.7;">
              Your WebSocket handler is the "AI brain" that powers your voice agent. ConversationRelay handles all the voice infrastructure
              (speech-to-text, text-to-speech, interruptions, low latency) and connects to your WebSocket handler to get AI responses.
            </p>
            <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin: 15px 0;">
              <h4 style="color: white; margin-top: 0;">üîÑ How It Works:</h4>
              <ol style="color: rgba(255,255,255,0.95); line-height: 1.8; margin: 10px 0; padding-left: 20px;">
                <li><strong>Caller speaks:</strong> ConversationRelay transcribes speech ‚Üí sends text to your WebSocket</li>
                <li><strong>Your code processes:</strong> Send text to OpenAI ‚Üí get AI response</li>
                <li><strong>AI responds:</strong> Send text back ‚Üí ConversationRelay converts to speech</li>
              </ol>
            </div>
            <p style="color: rgba(255,255,255,0.95); line-height: 1.7; margin-bottom: 0;">
              üéØ <strong>Your Focus:</strong> Integrate with OpenAI, manage conversation history, and add custom logic/tools.
              ConversationRelay handles everything else!
            </p>
          </div>

          <!-- ConversationRelay Events -->
          <div class="service-card" style="background: #f8f9fa; border-left: 4px solid #667eea;">
            <h3 style="color: #667eea; margin-bottom: 15px;">üì° ConversationRelay WebSocket Events</h3>
            <p style="font-size: 14px; color: #666; margin-bottom: 15px;">
              Your WebSocket handler will receive these event types from ConversationRelay:
            </p>

            <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #e0e0e0;">
              <ul style="margin: 0; padding-left: 20px; line-height: 2;">
                <li><strong><code>setup</code></strong> - Call started (connection info)</li>
                <li><strong><code>prompt</code></strong> - Caller spoke (transcribed text from ConversationRelay)</li>
                <li><strong><code>dtmf</code></strong> - Caller pressed keypad digit</li>
                <li><strong><code>interrupt</code></strong> - Caller interrupted AI mid-response</li>
              </ul>
            </div>

            <div style="margin-top: 15px; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; color: white;">
              <p style="color: rgba(255,255,255,0.95); margin: 0; line-height: 1.6;">
                <strong>üéØ ConversationRelay handles everything else:</strong> speech-to-text, text-to-speech, audio streaming,
                interruption handling, and low-latency communication. Your code just processes text and returns text!
              </p>
            </div>
          </div>

          <div class="instructions">
            <h3>üìã Your Task</h3>
            <p>Create a WebSocket handler that processes conversation events and integrates with OpenAI.</p>
            <p style="margin-top: 15px;">
              üìö <strong>Documentation:</strong>
              <a href="https://www.twilio.com/docs/voice/conversationrelay/websocket-messages" target="_blank">WebSocket Messages</a> |
              <a href="https://www.twilio.com/docs/voice/conversationrelay/websocket-messages#event-types" target="_blank">Event Types</a> |
              <a href="https://www.twilio.com/docs/serverless/functions" target="_blank">Serverless Functions</a>
            </p>
          </div>

          <div class="code-editor">
            <div class="code-header">
              <span>üìù WebSocket Handler</span>
              <div style="display: flex; gap: 10px;">
                <button class="btn btn-success" id="validateBtn7" style="padding: 6px 12px; font-size: 13px; ${step5CodeValidated ? 'opacity: 0.5;' : ''}" onclick="validateCode7()" ${step5CodeValidated ? 'disabled' : ''}>‚úì Validate</button>
                <button class="btn-copy" onclick="copyCode('code7')">üìã Copy Code</button>
                <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 13px;" onclick="resetCode7()">Reset</button>
              </div>
            </div>
            <textarea class="code-textarea" id="code7" oninput="handleCodeChange('code7')">/**
 * WebSocket Handler for Real-Time Voice AI (Node.js/Express)
 *
 * ‚ö†Ô∏è IMPORTANT: WebSocket servers cannot run on Twilio Serverless!
 * This code is designed to run on:
 * - Your own server (Node.js + Express)
 * - Heroku, Railway, Render, or similar platforms
 * - The GitHub repository you'll clone for this workshop
 *
 * How it works:
 * 1. ConversationRelay orchestrates: STT (speech-to-text), TTS (text-to-speech), and WebSocket connection
 * 2. ConversationRelay transcribes caller's speech and sends text to your WebSocket handler
 * 3. Your handler processes the text with AI/LLM (OpenAI in this example)
 * 4. Your handler sends the AI's text response back via WebSocket
 * 5. ConversationRelay converts the text to speech (TTS) and plays it to the caller
 *
 * ConversationRelay handles all the complexity of:
 * - Real-time audio streaming and transcription
 * - Low-latency bidirectional communication
 * - Interruption handling (when caller speaks over AI)
 * - TTS generation and audio playback
 * Your code just focuses on: receive text ‚Üí process with AI ‚Üí send text back
 */

const express = require('express');
const { WebSocketServer } = require('ws');
const OpenAI = require('openai');

const app = express();
const port = process.env.PORT || 3000;

// ============================================================================
// STEP 1: Initialize OpenAI Client
// ============================================================================
const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY // Store API key in environment variable
});

// ============================================================================
// STEP 2: Create HTTP Server
// ============================================================================
const server = app.listen(port, () => {
  console.log('[SERVER] WebSocket server running on port ' + port);
});

// ============================================================================
// STEP 3: Create WebSocket Server
// ============================================================================
const wss = new WebSocketServer({
  server,  // Attach to existing HTTP server
  path: '/websocket-handler'  // Path where Twilio will connect
});

console.log('[SERVER] WebSocket server ready at ws://localhost:' + port + '/websocket-handler');

// ============================================================================
// STEP 4: Handle WebSocket Connections
// ============================================================================
wss.on('connection', (ws) => {
  console.log('[WEBSOCKET] New connection from Twilio ConversationRelay');

  // --------------------------------------------------------------------------
  // Event: MESSAGE - Handle incoming messages from Twilio
  // --------------------------------------------------------------------------
  // Twilio ConversationRelay sends JSON messages with different types:
  // - 'setup': Initial connection with call metadata
  // - 'prompt': Caller spoke (speech-to-text result)
  // - 'dtmf': Keypad button pressed
  // - 'interrupt': Caller interrupted the AI mid-sentence
  ws.on('message', async (data) => {
    try {
      const message = JSON.parse(data.toString());
      console.log('[EVENT] Received event:', message.type);

      switch (message.type) {
        // ----------------------------------------------------------------------
        // Event: SETUP - Session initialization with call metadata
        // ----------------------------------------------------------------------
        case 'setup':
          console.log('[CALL] Setup received:');
          console.log('  Session ID:', message.sessionId);
          console.log('  Call SID:', message.callSid);
          console.log('  From:', message.from);
          console.log('  To:', message.to);
          console.log('  Direction:', message.direction);

          // Optional: Store session info for analytics/logging
          // This is useful for Conversational Intelligence integration
          break;

        // ----------------------------------------------------------------------
        // Event: PROMPT - Caller spoke, we got their words as text
        // ----------------------------------------------------------------------
        case 'prompt':
          console.log('[PROMPT] Caller said:', message.voicePrompt);
          console.log('  Language:', message.lang);
          console.log('  Is final:', message.last);

          // ====================================================================
          // AI PROCESSING: Send transcript to your LLM for intelligent response
          // ====================================================================
          // You can use ANY LLM here: OpenAI, Anthropic, Google, local models, etc.
          // Twilio handles all the audio (STT/TTS) - you just process text!
          try {
            const completion = await openai.chat.completions.create({
              model: 'gpt-4o-mini',  // Fast, affordable model (good for voice)
              messages: [
                {
                  role: 'system',
                  content: ${generatedContent?.systemPrompt ? `'${generatedContent.systemPrompt.replace(/'/g, "\\'").replace(/\n/g, ' ')}'` : `'You are a helpful voice assistant. Keep responses brief and conversational since they will be spoken aloud.'`}
                },
                {
                  role: 'user',
                  content: message.voicePrompt
                }
              ],
              max_tokens: 150  // Limit response length for voice (faster TTS)
            });

            const aiResponse = completion.choices[0].message.content;
            console.log('[AI] AI response:', aiResponse);

            // ==================================================================
            // Send AI response back to Twilio ‚Üí Twilio speaks it to caller
            // ==================================================================
            ws.send(JSON.stringify({
              type: 'text',
              token: aiResponse,
              last: true  // Indicates this is the complete response
            }));

          } catch (aiError) {
            console.error('[ERROR] LLM API error:', aiError);

            // Send error response to caller
            ws.send(JSON.stringify({
              type: 'text',
              token: 'I apologize, I encountered an error processing your request.',
              last: true
            }));
          }
          break;

        // ----------------------------------------------------------------------
        // Event: DTMF - Caller pressed a keypad button
        // ----------------------------------------------------------------------
        case 'dtmf':
          console.log('[DTMF] Keypad digit pressed:', message.digit);

          // Handle keypad input (useful for IVR-style menus)
          // Example: Press 1 for sales, 2 for support, etc.
          break;

        // ----------------------------------------------------------------------
        // Event: INTERRUPT - Caller interrupted the AI
        // ----------------------------------------------------------------------
        case 'interrupt':
          console.log('[INTERRUPT] Caller interrupted at:', message.utteranceUntilInterrupt);
          console.log('  Duration until interrupt:', message.durationUntilInterruptMs, 'ms');

          // Handle interruption (you may want to cancel any pending LLM requests)
          break;

        // ----------------------------------------------------------------------
        // Unknown events (log for debugging)
        // ----------------------------------------------------------------------
        default:
          console.log('[EVENT] Unknown event type:', message.type);
      }

    } catch (parseError) {
      console.error('[ERROR] Error parsing message:', parseError);
    }
  });

  // --------------------------------------------------------------------------
  // Event: ERROR - WebSocket connection error
  // --------------------------------------------------------------------------
  ws.on('error', (error) => {
    console.error('‚ùå WebSocket error:', error);
  });

  // --------------------------------------------------------------------------
  // Event: CLOSE - WebSocket connection closed
  // --------------------------------------------------------------------------
  ws.on('close', () => {
    console.log('[WEBSOCKET] Connection closed');
  });
});

// ============================================================================
// STEP 5: Health Check Endpoint (Optional but recommended)
// ============================================================================
app.get('/health', (req, res) => {
  res.json({ status: 'healthy', websocket: 'ready' });
});

// ============================================================================
// DEPLOYMENT NOTES
// ============================================================================
// To deploy this code:
// 1. Push to GitHub repository
// 2. Deploy to a platform that supports WebSocket:
//    - Railway: railway.app (easiest)
//    - Render: render.com
//    - Heroku: heroku.com
//    - Your own VPS
// 3. Set environment variable: OPENAI_API_KEY=your_key_here
// 4. Update your ConversationRelay TwiML with the deployed WSS URL:
//    wss://your-app.railway.app/websocket-handler</textarea>
</invoke>
          </div>

          <div id="step5Status" class="status-box"></div>

          ${!step5CodeValidated ? `
          <div id="step5Placeholder" class="instructions" style="margin-top: 20px; background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px;">
            <p style="margin: 0; color: #856404; font-weight: 600;">
              ‚ö†Ô∏è Please validate your WebSocket handler code above before deploying!
            </p>
          </div>
          ` : ''}

          <div id="step5DeploySection" style="margin: 30px 0; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; border: 2px solid #5a67d8; display: ${step5CodeValidated ? 'block' : 'none'};">
            <h3 style="color: white; margin: 0 0 15px 0; font-size: 1.2rem;">üöÄ Deploy Your WebSocket Server</h3>
            ${studentDemoMode ? `
              <p style="color: rgba(255,255,255,0.9); margin-bottom: 15px; line-height: 1.6;">
                In demo mode, we'll simulate deploying your WebSocket server to a cloud environment.
              </p>
              <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <p style="color: rgba(255,255,255,0.9); margin: 0 0 10px 0; font-size: 14px;">
                  <strong>üí° What would happen in live mode:</strong>
                </p>
                <ol style="color: rgba(255,255,255,0.85); margin: 0; padding-left: 20px; line-height: 1.8; font-size: 13px;">
                  <li>Create your personalized WebSocket endpoint</li>
                  <li>Server fetches YOUR OpenAI key & system prompt</li>
                  <li>Test your deployment</li>
                </ol>
              </div>
              <button
                class="btn btn-success"
                id="deployCodespaceBtn5"
                onclick="simulateCodespaceDeployment()"
                style="font-size: 1.1rem; padding: 15px 30px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                üöÄ Deploy My WebSocket Server
              </button>
              <div id="codespaceDeployStatus5" style="margin-top: 15px; color: white;"></div>
            ` : `
              <p style="color: rgba(255,255,255,0.9); margin-bottom: 20px; line-height: 1.6;">
                Now let's deploy your WebSocket server! Click below to create your personalized endpoint.
              </p>

              <div id="step5PreDeploySection" style="display: ${step5Deployed ? 'none' : 'block'};">
                <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                  <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                    <span style="font-size: 1.5rem;">üéØ</span>
                    <div>
                      <strong style="color: white; font-size: 1.05rem;">What You're Creating</strong>
                    </div>
                  </div>
                  <ul style="color: rgba(255,255,255,0.85); margin: 0; padding-left: 20px; line-height: 1.8; font-size: 14px;">
                    <li>A unique WebSocket endpoint just for you</li>
                    <li>Connected to YOUR OpenAI API key</li>
                    <li>Uses YOUR custom system prompt (from Step 7)</li>
                    <li>Ready for real-time AI voice conversations</li>
                  </ul>
                </div>

                <button
                  class="btn btn-success"
                  id="deployCodespaceBtn5"
                  onclick="deployLiveWebSocketServer()"
                  style="font-size: 1.1rem; padding: 15px 30px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); width: 100%;">
                  üöÄ Deploy My WebSocket Server
                </button>
                <div id="codespaceDeployStatus5" style="margin-top: 15px; font-size: 13px;"></div>
              </div>

              <div id="step5PostDeploySection" style="display: ${step5Deployed ? 'block' : 'none'};">
                <div style="background: rgba(40, 167, 69, 0.2); padding: 20px; border-radius: 8px; border: 2px solid rgba(40, 167, 69, 0.6); margin-bottom: 20px;">
                  <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                    <span style="font-size: 1.5rem;">‚úÖ</span>
                    <div>
                      <strong style="color: white; font-size: 1.05rem;">Your WebSocket Server is Live!</strong><br>
                      <span style="color: rgba(255,255,255,0.8); font-size: 13px;">Personalized endpoint connected to your AI settings</span>
                    </div>
                  </div>
                  <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px; font-family: monospace; margin-bottom: 15px;">
                    <div style="color: rgba(255,255,255,0.6); font-size: 12px; margin-bottom: 5px;">Your WebSocket URL:</div>
                    <code style="color: white; font-size: 13px; word-break: break-all;">wss://workshop-websocket-server-production.up.railway.app/ws/${sessionToken}</code>
                  </div>
                  <ul style="color: rgba(255,255,255,0.85); margin: 0 0 15px 0; padding-left: 20px; line-height: 1.8; font-size: 13px;">
                    <li>‚úÖ Uses YOUR OpenAI API key</li>
                    <li>‚úÖ Uses YOUR custom system prompt</li>
                    <li>‚úÖ Isolated from other students</li>
                    <li>‚úÖ Ready for ConversationRelay</li>
                  </ul>

                  <!-- Test WebSocket Server Button -->
                  <button
                    class="btn"
                    onclick="testSharedWebSocketServer()"
                    style="padding: 12px 24px; background: white; color: #667eea; border: none; font-weight: 600; width: 100%;">
                    üß™ Test My WebSocket Server
                  </button>
                  <div id="wsTestStatus" style="margin-top: 15px; font-size: 13px;"></div>
                </div>
              </div>
            `}
          </div>

          <div class="console-output" id="console7" style="display: none;"></div>

          <div class="button-group">
            <button class="btn btn-secondary" onclick="prevStep()">‚Üê Back</button>
            <button class="btn btn-primary ${step5Deployed ? 'next-action' : ''}" id="nextBtn5" onclick="nextStep()" ${step5Deployed ? '' : 'disabled'}>
              Next: ConversationRelay ‚Üí
            </button>
          </div>
        </div>
      `;
    }

    async function testCode7() {
      const code = document.getElementById('code7').value;
      const console7 = document.getElementById('console7');
      console7.style.display = 'block';
      console7.innerHTML = '<div class="console-line">üîç Validating JavaScript syntax...</div>';

      // First, validate syntax
      const validation = validateJavaScriptSyntax(code);

      if (!validation.valid) {
        console7.innerHTML += `<div class="console-line error">‚ùå Syntax Error: ${validation.error}</div>`;
        console7.innerHTML += `<div class="console-line error">   Location: Line ${validation.line}, Column ${validation.column}</div>`;
        console7.innerHTML += '<div class="console-line info">üí° Fix the syntax error before testing or deploying.</div>';
        return;
      }

      console7.innerHTML += '<div class="console-line success">‚úì Syntax validation passed</div>';

      // Check for TODOs and warn
      const todoMatches = code.match(/\/\/\s*TODO:/gi);
      if (todoMatches && todoMatches.length > 3) {
        console7.innerHTML += `<div class="console-line warning">‚ö†Ô∏è Warning: ${todoMatches.length} TODO comments found. Make sure to implement them!</div>`;
      }

      console7.innerHTML += '<div class="console-line">‚ñ∂Ô∏è Testing WebSocket handler with OpenAI...</div>';

      if (twilioCredentials?.demoMode) {
        console7.innerHTML += `
          <div class="console-line info">üìù Demo Mode: Simulating WebSocket test...</div>
          <div class="console-line success">‚úì WebSocket connection established</div>
          <div class="console-line info">Event: start received</div>
          <div class="console-line info">Transcript: "Hello, how are you?"</div>
          <div class="console-line success">‚úì AI Response: "I'm doing well, thank you! How can I help you today?"</div>
        `;
        return;
      }

      // Check if OpenAI key is configured
      if (!openaiApiKey) {
        console7.innerHTML += '<div class="console-line error">‚ùå Please configure your OpenAI API key first</div>';
        return;
      }

      try {
        // First deploy the WebSocket handler if needed
        if (!deployedServiceSid) {
          console7.innerHTML += '<div class="console-line warning">‚ö†Ô∏è No deployed service found.</div>';
          console7.innerHTML += '<div class="console-line info">üìù To test your WebSocket handler:</div>';
          console7.innerHTML += '<div class="console-line info">  1. Validate your code (click ‚úì Validate)</div>';
          console7.innerHTML += '<div class="console-line info">  2. Deploy it (click üíæ Commit Step 6 below)</div>';
          console7.innerHTML += '<div class="console-line info">  3. Then come back and click ‚ñ∂Ô∏è Test Code</div>';
          return;
        }

        // Test the deployed WebSocket handler
        console7.innerHTML += '<div class="console-line info">üîç Testing deployed WebSocket handler...</div>';

        const testResponse = await fetch('/test-websocket-handler', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            serviceSid: deployedServiceSid,
            domain: websocketUrl, // Already just the domain without protocol
            openaiApiKey: openaiApiKey,
            ...twilioCredentials
          })
        });

        const testData = await testResponse.json();

        if (!testData.success) {
          console7.innerHTML += `<div class="console-line error">‚ùå Test failed: ${testData.error}</div>`;

          // Check for specific error types and provide debugging info
          if (testData.error.includes('401') || testData.error.includes('Authentication')) {
            console7.innerHTML += '<div class="console-line error">üîê OpenAI Authentication Error</div>';
            console7.innerHTML += '<div class="console-line info">   Possible causes:</div>';
            console7.innerHTML += '<div class="console-line info">   ‚Ä¢ Invalid OpenAI API key</div>';
            console7.innerHTML += '<div class="console-line info">   ‚Ä¢ API key expired or revoked</div>';
            console7.innerHTML += '<div class="console-line info">   ‚Ä¢ Check your key at https://platform.openai.com/api-keys</div>';
          } else if (testData.error.includes('429') || testData.error.includes('rate limit')) {
            console7.innerHTML += '<div class="console-line error">‚è±Ô∏è Rate Limit Error</div>';
            console7.innerHTML += '<div class="console-line info">   ‚Ä¢ Too many requests to OpenAI API</div>';
            console7.innerHTML += '<div class="console-line info">   ‚Ä¢ Wait a minute and try again</div>';
          } else if (testData.error.includes('404')) {
            console7.innerHTML += '<div class="console-line error">üîç WebSocket Handler Not Found</div>';
            console7.innerHTML += '<div class="console-line info">   ‚Ä¢ Handler may not be deployed yet</div>';
            console7.innerHTML += '<div class="console-line info">   ‚Ä¢ Wait 10 seconds for deployment to propagate</div>';
            console7.innerHTML += '<div class="console-line info">   ‚Ä¢ Check Twilio Console logs for deployment errors</div>';
          } else if (testData.error.includes('Twilio')) {
            console7.innerHTML += '<div class="console-line error">üìû Twilio API Error</div>';
            console7.innerHTML += `<div class="console-line info">   ${testData.error}</div>`;
          } else if (testData.error.includes('syntax') || testData.error.includes('SyntaxError')) {
            console7.innerHTML += '<div class="console-line error">üí• Code Syntax Error in Deployed Function</div>';
            console7.innerHTML += '<div class="console-line info">   ‚Ä¢ Your code has a syntax error that was deployed</div>';
            console7.innerHTML += '<div class="console-line info">   ‚Ä¢ Fix the error and redeploy</div>';
            console7.innerHTML += `<div class="console-line info">   Error: ${testData.error}</div>`;
          }

          return;
        }

        console7.innerHTML += `<div class="console-line success">‚úì WebSocket handler deployed at: ${testData.handlerUrl}</div>`;

        if (testData.aiResponse) {
          console7.innerHTML += '<div class="console-line info">ü§ñ Testing OpenAI integration...</div>';
          console7.innerHTML += `<div class="console-line info">üí¨ Test query: "${testData.testQuery}"</div>`;
          console7.innerHTML += `<div class="console-line success">ü§ñ AI Response: "${testData.aiResponse}"</div>`;
        }

        console7.innerHTML += '<div class="console-line success">‚úÖ Your WebSocket handler is ready!</div>';
        console7.innerHTML += `<div class="console-line info">üìù ${testData.note}</div>`;

        // Enable Next button
        document.getElementById('nextBtn7').disabled = false;
        showStatus('step7Status', 'success', 'üéâ WebSocket handler tested successfully! You can now proceed to Step 6.');

        return;  // Skip the old WebSocket connection code below

        const wsUrl = `${websocketUrl}/websocket-handler`;
        console7.innerHTML += `<div class="console-line info">üîå Connecting to: ${wsUrl}</div>`;

        const ws = new WebSocket(wsUrl);
        let responseReceived = false;

        // Set timeout for test
        const timeout = setTimeout(() => {
          if (!responseReceived) {
            ws.close();
            console7.innerHTML += '<div class="console-line error">‚ùå Timeout: No response received after 10 seconds</div>';
          }
        }, 10000);

        ws.onopen = () => {
          console7.innerHTML += '<div class="console-line success">‚úì WebSocket connected</div>';

          // Send start event
          console7.innerHTML += '<div class="console-line info">üì§ Sending start event...</div>';
          ws.send(JSON.stringify({
            event: 'start',
            streamSid: 'test-stream-' + Date.now()
          }));

          // Send test transcript
          setTimeout(() => {
            console7.innerHTML += '<div class="console-line info">üì§ Sending transcript: "Hello, can you hear me?"</div>';
            ws.send(JSON.stringify({
              event: 'transcript',
              transcript: 'Hello, can you hear me?'
            }));
          }, 500);
        };

        ws.onmessage = (event) => {
          responseReceived = true;
          clearTimeout(timeout);

          try {
            const message = JSON.parse(event.data);
            console7.innerHTML += `<div class="console-line success">üì• Received: ${JSON.stringify(message, null, 2)}</div>`;

            if (message.event === 'text') {
              console7.innerHTML += `<div class="console-line success">ü§ñ AI Response: "${message.text}"</div>`;
              console7.innerHTML += '<div class="console-line success">‚úÖ WebSocket handler is working correctly!</div>';

              // Enable Next button on successful test
              document.getElementById('nextBtn7').disabled = false;
              showStatus('step7Status', 'success', 'üéâ WebSocket handler tested successfully! You can now proceed to Step 6.');
            }
          } catch (e) {
            console7.innerHTML += `<div class="console-line info">üì• Received: ${event.data}</div>`;
          }

          // Close connection after receiving response
          setTimeout(() => {
            ws.send(JSON.stringify({ event: 'stop' }));
            ws.close();
          }, 1000);
        };

        ws.onerror = (error) => {
          clearTimeout(timeout);
          console7.innerHTML += `<div class="console-line error">‚ùå WebSocket error: ${error.message || 'Connection failed'}</div>`;
          console7.innerHTML += `<div class="console-line error">Error type: ${error.type}</div>`;
          console7.innerHTML += `<div class="console-line error">URL attempted: ${wsUrl}</div>`;
          console7.innerHTML += '<div class="console-line info">üí° Possible issues:</div>';
          console7.innerHTML += '<div class="console-line info">  1. WebSocket handler not deployed yet</div>';
          console7.innerHTML += '<div class="console-line info">  2. Deployment still propagating (wait 10 seconds and retry)</div>';
          console7.innerHTML += '<div class="console-line info">  3. Code has syntax errors - check Twilio Console logs</div>';
        };

        ws.onclose = (event) => {
          console7.innerHTML += `<div class="console-line info">üîå WebSocket connection closed (code: ${event.code}, reason: ${event.reason || 'none'})</div>`;
          if (!responseReceived) {
            console7.innerHTML += '<div class="console-line warning">‚ö†Ô∏è Connection closed before receiving AI response</div>';
          }
        };

      } catch (error) {
        console7.innerHTML += `<div class="console-line error">‚ùå Test failed: ${error.message}</div>`;

        // Provide debugging hints based on error type
        if (error.message.includes('fetch') || error.message.includes('network')) {
          console7.innerHTML += '<div class="console-line info">üí° Network Error - Check your internet connection</div>';
        } else if (error.message.includes('JSON')) {
          console7.innerHTML += '<div class="console-line info">üí° Invalid response from server - Check Twilio Console logs</div>';
        } else {
          console7.innerHTML += '<div class="console-line info">üí° Check browser console (F12) for full error details</div>';
        }
      }
    }

    // =========================================================================
    // TEST SHARED WEBSOCKET SERVER
    // Verifies the shared Railway WebSocket server is working with student's OpenAI key
    // =========================================================================
    async function testSharedWebSocketServer() {
      const statusDiv = document.getElementById('wsTestStatus');
      const RAILWAY_URL = 'wss://workshop-websocket-server-production.up.railway.app';

      // Demo mode simulation
      if (twilioCredentials?.demoMode || studentDemoMode) {
        statusDiv.innerHTML = `
          <div style="padding: 15px; background: rgba(40, 167, 69, 0.2); border-radius: 6px; border: 1px solid rgba(40, 167, 69, 0.4);">
            <div style="margin-bottom: 10px;">üß™ <strong>Demo Mode: Simulating WebSocket test...</strong></div>
            <div style="margin-bottom: 8px;">‚úÖ WebSocket connected!</div>
            <div style="margin-bottom: 8px;">‚úÖ Fetching your settings from Vercel API...</div>
            <div style="margin-bottom: 8px;">‚úÖ Using your OpenAI key</div>
            <div style="margin-bottom: 8px;">üì§ Sending test prompt: "Say hello in one sentence"</div>
            <div style="margin-bottom: 8px;">üì® AI Response: "Hello! How can I assist you today?"</div>
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2);">
              <strong style="color: #28a745;">üéâ SUCCESS!</strong> Shared WebSocket server is ready!
            </div>
          </div>
        `;
        return;
      }

      statusDiv.innerHTML = '<div>üß™ Testing shared WebSocket server...</div>';

      try {
        // Open WebSocket connection directly from browser
        const ws = new WebSocket(`${RAILWAY_URL}/ws/${sessionToken}`);
        let testComplete = false;

        const timeout = setTimeout(() => {
          if (!testComplete) {
            statusDiv.innerHTML = `
              <div style="padding: 15px; background: rgba(220, 53, 69, 0.2); border-radius: 6px; border: 1px solid rgba(220, 53, 69, 0.4);">
                <div><strong>‚ùå Test timeout</strong> - No response from server</div>
                <div style="margin-top: 12px;">Check that you configured your OpenAI key in Step 1</div>
              </div>
            `;
            ws.close();
          }
        }, 10000);

        ws.onopen = () => {
          statusDiv.innerHTML = '<div>‚úÖ Connected! Sending test prompt...</div>';
          // Send test prompt after delay (Railway needs setup time)
          setTimeout(() => {
            ws.send(JSON.stringify({
              type: 'prompt',
              voicePrompt: 'Say hello in one sentence'
            }));
          }, 1000);
        };

        ws.onmessage = (event) => {
          const message = JSON.parse(event.data);
          if (message.type === 'text') {
            testComplete = true;
            clearTimeout(timeout);
            statusDiv.innerHTML = `
              <div style="padding: 15px; background: rgba(40, 167, 69, 0.2); border-radius: 6px; border: 1px solid rgba(40, 167, 69, 0.4);">
                <div style="margin-bottom: 10px;"><strong style="color: #28a745;">üéâ SUCCESS!</strong></div>
                <div style="margin-bottom: 8px;">‚úÖ Server fetches your settings from database</div>
                <div style="margin-bottom: 8px;">‚úÖ Server uses YOUR OpenAI key (not instructor's)</div>
                <div style="margin-bottom: 8px;">‚úÖ ConversationRelay prompts working correctly</div>
                <div style="margin-bottom: 8px;">‚úÖ Multi-tenancy confirmed</div>
                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.2);">
                  <strong>AI Response:</strong> "${message.token}"
                </div>
              </div>
            `;
            ws.close();
          }
        };

        ws.onerror = (error) => {
          statusDiv.innerHTML = `
            <div style="padding: 15px; background: rgba(220, 53, 69, 0.2); border-radius: 6px; border: 1px solid rgba(220, 53, 69, 0.4);">
              <div><strong>‚ùå Connection error</strong></div>
              <div style="margin-top: 8px;">Could not connect to shared WebSocket server</div>
            </div>
          `;
        };

      } catch (error) {
        statusDiv.innerHTML = `
          <div style="padding: 15px; background: rgba(220, 53, 69, 0.2); border-radius: 6px; border: 1px solid rgba(220, 53, 69, 0.4);">
            <div><strong>‚ùå Error:</strong> ${error.message}</div>
          </div>
        `;
      }
    }


    // Test WebSocket with a single custom message
    async function testSingleWebSocketMessage() {
      const console7 = document.getElementById('console7');
      const messageInput = document.getElementById('testWebSocketMessage');
      const userMessage = messageInput?.value?.trim();

      if (!userMessage) {
        console7.style.display = 'block';
        console7.innerHTML = '<div class="console-line error">‚ùå Please enter a message to test</div>';
        return;
      }

      // Check if OpenAI key is configured
      if (!openaiApiKey) {
        console7.style.display = 'block';
        console7.innerHTML = '<div class="console-line error">‚ùå Please configure your OpenAI API key first</div>';
        return;
      }

      // Get the student's WebSocket handler code
      const studentCode = document.getElementById('code7')?.value || '';
      if (!studentCode) {
        console7.style.display = 'block';
        console7.innerHTML = '<div class="console-line error">‚ùå No code to test</div>';
        return;
      }

      console7.style.display = 'block';
      console7.innerHTML = `
        <div class="console-line">üß™ Testing your WebSocket handler code...</div>
        <div class="console-line">üì® Simulating ConversationRelay event: <code>"${userMessage}"</code></div>
      `;

      try {
        // Test the student's actual WebSocket handler code
        const response = await fetch('/api/test-websocket-code', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            code: studentCode,
            testMessage: userMessage,
            openaiApiKey: openaiApiKey
          })
        });

        const data = await response.json();

        if (data.success) {
          // Show event flow
          console7.innerHTML += '<div class="console-line info">üì° Event Flow:</div>';
          data.events.forEach(event => {
            const icon = event.direction === 'incoming' ? '‚¨áÔ∏è' : event.direction === 'outgoing' ? '‚¨ÜÔ∏è' : '‚öôÔ∏è';
            console7.innerHTML += `<div class="console-line">  ${icon} ${event.description}</div>`;
          });

          console7.innerHTML += `<div class="console-line success">ü§ñ AI Response: "${data.test.aiResponse}"</div>`;

          // Show validation results
          if (data.validation.passed) {
            console7.innerHTML += '<div class="console-line success">‚úÖ All WebSocket handler checks passed!</div>';
          } else {
            console7.innerHTML += '<div class="console-line warning">‚ö†Ô∏è Code validation issues:</div>';
            data.validation.issues.forEach(issue => {
              console7.innerHTML += `<div class="console-line warning">  ‚Ä¢ ${issue}</div>`;
            });
          }

          // Clear input for next test
          messageInput.value = '';

          // Enable Next button after successful test
          document.getElementById('nextBtn7').disabled = false;
          showStatus('step7Status', 'success', 'üéâ WebSocket handler tested successfully! Ready for Step 6.');
        } else {
          console7.innerHTML += `<div class="console-line error">‚ùå Error: ${data.error}</div>`;

          // Show hints if available
          if (data.hints && data.hints.length > 0) {
            data.hints.forEach(hint => {
              console7.innerHTML += `<div class="console-line info">üí° ${hint}</div>`;
            });
          }
        }
      } catch (error) {
        console7.innerHTML += `<div class="console-line error">‚ùå Test failed: ${error.message}</div>`;

        // Provide debugging hints based on error type
        if (error.message.includes('fetch') || error.message.includes('network')) {
          console7.innerHTML += '<div class="console-line info">üí° Network Error - Check your internet connection</div>';
        } else if (error.message.includes('JSON')) {
          console7.innerHTML += '<div class="console-line info">üí° Invalid response from server</div>';
        }
      }
    }

    function validateCode7() {
      const code = document.getElementById('code7').value;

      // Count TODO comments vs actual implementation
      const lines = code.split('\n');
      const todoLines = lines.filter(line => line.trim().startsWith('// TODO:')).length;
      const codeLines = lines.filter(line => {
        const trimmed = line.trim();
        return trimmed &&
               !trimmed.startsWith('//') &&
               !trimmed.startsWith('/*') &&
               trimmed !== '{' &&
               trimmed !== '}' &&
               trimmed !== '};';
      }).length;

      const checks = {
        hasWebSocket: code.includes('WebSocket') || code.includes('ws'),
        hasHandler: code.includes('exports.handler') || code.includes('module.exports') || code.includes('const app = express()') || code.includes('const express = require'),
        hasCallback: code.includes('callback') || code.includes('wss.on') || code.includes('ws.on'),
        hasCorrectEvents: (code.includes("'setup'") || code.includes('"setup"')) && (code.includes("'prompt'") || code.includes('"prompt"')),
        hasCorrectResponseFormat: (code.includes("type: 'text'") || code.includes('type: "text"')) && (code.includes('token:') || code.includes('"token"')),
        hasImplementation: codeLines > 5 && (todoLines === 0 || codeLines > todoLines * 2)
      };

      const allPassed = Object.values(checks).every(v => v);

      if (allPassed) {
        showStatus('step5Status', 'success', '‚úÖ Code validation passed! Click the deploy button below to deploy your WebSocket handler.');
        step5CodeValidated = true;
        saveProgressToStorage();
        updateProgressBar();

        // Hide placeholder and show deploy section
        const placeholder = document.getElementById('step5Placeholder');
        if (placeholder) placeholder.style.display = 'none';

        const deploySection = document.getElementById('step5DeploySection');
        if (deploySection) deploySection.style.display = 'block';

        // Clear all existing next-action highlights first
        document.querySelectorAll('.next-action').forEach(el => {
          el.classList.remove('next-action');
        });

        // Disable the validate button
        const validateBtn = document.getElementById('validateBtn7');
        if (validateBtn) {
          validateBtn.disabled = true;
          validateBtn.style.opacity = '0.5';
        }

        // Add next-action to deploy button
        const deployBtn = document.getElementById('deployCodespaceBtn5');
        if (deployBtn) deployBtn.classList.add('next-action');

        // Reset code change flag
        code7Changed = false;
      } else {
        let message = '‚ö†Ô∏è Validation issues found:\n';
        if (!checks.hasWebSocket) message += '- Missing WebSocket import (require(\'ws\') or WebSocketServer)\n';
        if (!checks.hasHandler) message += '- Missing handler setup (exports.handler or Express app)\n';
        if (!checks.hasCallback) message += '- Missing event handlers (callback() or ws.on())\n';
        if (!checks.hasImplementation) message += `- Not enough implementation code (found ${codeLines} lines of code, ${todoLines} TODOs)\n`;
        showStatus('step5Status', 'warning', message);
      }
    }

    // =========================================================================
    // WEBSOCKET TEST FUNCTIONS (REMOVED - not feasible with Codespaces auth)
    // =========================================================================

    // Deprecated - WebSocket testing removed due to GitHub Codespaces authentication limitations
    function logWebSocketMessage(type, message, data = null) {
      const log = document.getElementById('websocketMessageLog');
      if (!log) return;

      // Clear placeholder if it exists
      if (log.querySelector('[style*="text-align: center"]')) {
        log.innerHTML = '';
      }

      const timestamp = new Date().toLocaleTimeString('en-US', { hour12: false, fractionalSecondDigits: 3 });
      const colors = {
        sent: '#4caf50',
        received: '#2196f3',
        error: '#f44336',
        info: '#ff9800',
        success: '#8bc34a'
      };

      const color = colors[type] || '#888';
      const icon = {
        sent: '‚¨ÜÔ∏è',
        received: '‚¨áÔ∏è',
        error: '‚ùå',
        info: '‚ÑπÔ∏è',
        success: '‚úÖ'
      }[type] || '‚Ä¢';

      const messageDiv = document.createElement('div');
      messageDiv.style.cssText = `
        margin-bottom: 8px;
        padding: 8px 12px;
        background: rgba(255,255,255,0.05);
        border-left: 3px solid ${color};
        border-radius: 4px;
      `;

      let content = `
        <div style="display: flex; gap: 10px; align-items: flex-start;">
          <span style="font-size: 16px;">${icon}</span>
          <div style="flex: 1;">
            <div style="color: ${color}; font-weight: 600; margin-bottom: 4px;">
              ${timestamp} - ${type.toUpperCase()}
            </div>
            <div style="color: #ddd; word-break: break-word;">
              ${message}
            </div>
      `;

      if (data) {
        content += `
            <details style="margin-top: 6px;">
              <summary style="color: #888; cursor: pointer; font-size: 12px;">View data</summary>
              <pre style="margin: 6px 0 0 0; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 4px; overflow-x: auto; font-size: 11px; color: #aaa;">${JSON.stringify(data, null, 2)}</pre>
            </details>
        `;
      }

      content += `
          </div>
        </div>
      `;

      messageDiv.innerHTML = content;
      log.appendChild(messageDiv);

      // Auto-scroll to bottom
      log.scrollTop = log.scrollHeight;
    }

    function updateConnectionStatus(connected) {
      isConnected = connected;
      const indicator = document.getElementById('wsStatusIndicator');
      const text = document.getElementById('wsStatusText');
      const btn = document.getElementById('wsConnectBtn');

      if (connected) {
        indicator.style.background = '#4caf50';
        text.textContent = 'Connected';
        text.style.color = '#4caf50';
        btn.textContent = 'üîå Disconnect';
        btn.onclick = disconnectWebSocketTest;
      } else {
        indicator.style.background = '#666';
        text.textContent = 'Not connected';
        text.style.color = 'rgba(255,255,255,0.7)';
        btn.textContent = 'üîå Connect';
        btn.onclick = connectWebSocketTest;
      }
    }

    async function connectWebSocketTest() {
      if (isConnected) return;

      // Prefer Codespace URL over generic websocketUrl
      const urlToUse = codespaceUrl || websocketUrl;

      if (!urlToUse) {
        logWebSocketMessage('error', 'No WebSocket URL available. Please deploy your handler first.');
        return;
      }

      // Skip HTTP health check for Codespaces (they require auth even on public ports)
      // The WebSocket connection will work because Twilio connects from their servers
      logWebSocketMessage('info', `Preparing to connect to WebSocket server...`);

      // Check if it's a Codespace URL
      const isCodespace = urlToUse.includes('github.dev') || urlToUse.includes('githubpreview.dev');

      if (isCodespace) {
        logWebSocketMessage('info', `üîß Codespace detected - skipping browser health check (Twilio will connect directly)`);
      } else {
        // Only do health check for non-Codespace URLs
        const httpUrl = urlToUse.replace('wss://', 'https://').replace(':3000', '-3000');
        logWebSocketMessage('info', `Checking server health...`);

        try {
          const healthCheck = await fetch(`${httpUrl}/health`, { method: 'GET' });
          if (!healthCheck.ok) {
            logWebSocketMessage('error', `Server not responding (HTTP ${healthCheck.status}). The server may not be running.`);
            return;
          }
          logWebSocketMessage('success', `‚úì Server is running!`);
        } catch (healthError) {
          const isCorsError = healthError.message.includes('CORS') ||
                             healthError.message.includes('NetworkError') ||
                             healthError.message.includes('Failed to fetch');

          if (isCorsError) {
            logWebSocketMessage('error', `
              <strong>‚ö†Ô∏è Server Not Responding!</strong><br><br>
              The WebSocket server may not be running yet.<br><br>
              <strong>Quick Fix:</strong><br>
              1. Wait 30-60 seconds for server to start<br>
              2. Refresh the page and try again<br><br>
              <strong>Still not working?</strong><br>
              <button onclick="deleteAndRecreateCodespace()" style="background: #f22f46; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 10px;">
                üîÑ Get New Server URL
              </button>
            `);
          } else {
            logWebSocketMessage('error', `
              <strong>Cannot reach server!</strong><br><br>
              Possible causes:<br>
              1. Server is starting up (wait 30-60 seconds)<br>
              2. Network connectivity issue<br>
              3. Server URL may have changed<br><br>
              Error: ${healthError.message}
            `);
          }
          return;
        }
      }

      // For Codespaces, use server-side proxy to bypass browser auth
      if (isCodespace) {
        logWebSocketMessage('info', `üß™ Testing WebSocket via server proxy (bypassing browser auth)...`);

        try {
          const proxyResponse = await fetch('/api/test-websocket-proxy', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              websocketUrl: urlToUse,
              githubToken: githubToken
            })
          });

          const testData = await proxyResponse.json();

          if (testData.success) {
            logWebSocketMessage('success', `‚úÖ WebSocket server is working!`);
            logWebSocketMessage('info', `<strong>Test Results:</strong>`);

            testData.results.forEach(result => {
              logWebSocketMessage(result.type, `[${result.timestamp}ms] ${result.message}`);
              if (result.data) {
                logWebSocketMessage('info', `<pre style="background: #f5f5f5; padding: 10px; border-radius: 4px; font-size: 11px; overflow-x: auto;">${JSON.stringify(result.data, null, 2)}</pre>`);
              }
            });

            if (testData.receivedMessages && testData.receivedMessages.length > 0) {
              logWebSocketMessage('success', `<strong>‚úÖ Server responded with ${testData.receivedMessages.length} message(s)</strong>`);
              logWebSocketMessage('info', `Your WebSocket handler is correctly processing ConversationRelay events!`);
            } else {
              logWebSocketMessage('warning', `‚ö†Ô∏è Server connected but didn't send any responses. This may be normal depending on your handler implementation.`);
            }

            logWebSocketMessage('success', `<strong>üéâ Your WebSocket server is ready for phone calls!</strong><br>When you make a real call, Twilio will connect and send audio data.`);

            // Mark as complete and enable next button
            isConnected = true;
            websocketBuilt = true;
            step5Deployed = true;
            saveProgressToStorage();
            updateProgressBar();

            const nextBtn = document.getElementById('nextBtn7');
            if (nextBtn) {
              nextBtn.disabled = false;
              nextBtn.classList.add('next-action');
              console.log('‚úÖ WebSocket test passed - Next button enabled');
            }
          } else {
            // Check if it's an auth error (302 redirect)
            const isAuthError = testData.results && testData.results.some(r =>
              r.message && r.message.includes('302')
            );

            if (isAuthError) {
              // For Codespaces, mark as complete even with auth errors since the server is running
              websocketBuilt = true;
              saveProgressToStorage();
              updateProgressBar();

              // Enable next button (Step 5 WebSocket uses nextBtn7)
              const nextBtn = document.getElementById('nextBtn7');
              if (nextBtn) {
                nextBtn.disabled = false;
                console.log('‚úÖ Next button enabled - students can proceed');
              }

              logWebSocketMessage('info', `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 8px; color: white; margin: 10px 0;">
                  <h4 style="color: white; margin-top: 0;">‚úÖ Ready for Phone Calls!</h4>
                  <p style="margin: 10px 0; line-height: 1.6;">
                    Browser testing is not available for GitHub Codespaces due to authentication requirements,
                    but <strong>this won't affect your phone calls</strong> - Twilio's servers connect directly.
                  </p>

                  <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 6px; margin: 15px 0;">
                    <strong style="display: block; margin-bottom: 10px;">üìã What You've Learned:</strong>
                    <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
                      <li>Built a <strong>WebSocket handler</strong> for ConversationRelay</li>
                      <li>Integrated with <strong>OpenAI</strong> for AI responses</li>
                      <li>Set up your <strong>WebSocket server</strong></li>
                    </ul>
                  </div>

                  <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 6px; margin: 15px 0;">
                    <strong style="display: block; margin-bottom: 10px;">‚úÖ Your Server is Ready:</strong>
                    <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
                      <li>WebSocket server is running and responding</li>
                      <li>Connected to your configuration</li>
                      <li>Ready to handle Twilio voice calls</li>
                    </ul>
                  </div>

                  <p style="margin: 15px 0 0 0; font-size: 16px; font-weight: 600;">
                    üéâ You're ready to proceed to the next step!
                  </p>
                </div>
              `);
            } else {
              logWebSocketMessage('error', `‚ùå WebSocket test failed: ${testData.error || 'Unknown error'}`);
              if (testData.results) {
                testData.results.forEach(result => {
                  logWebSocketMessage(result.type, `[${result.timestamp}ms] ${result.message}`);
                });
              }
            }
          }
        } catch (proxyError) {
          logWebSocketMessage('error', `Proxy test failed: ${proxyError.message}`);
        }
        return;
      }

      // For non-Codespace URLs, use direct WebSocket connection
      logWebSocketMessage('info', `Connecting to ${urlToUse}...`);

      try {
        testWebSocket = new WebSocket(urlToUse);

        testWebSocket.onopen = () => {
          updateConnectionStatus(true);
          logWebSocketMessage('success', 'WebSocket connection established!');

          // Send setup event
          const setupEvent = {
            type: 'setup',
            callSid: 'TEST-' + Date.now(),
            from: '+1234567890',
            to: selectedPhoneNumber || '+1987654321',
            direction: 'inbound'
          };
          testWebSocket.send(JSON.stringify(setupEvent));
          logWebSocketMessage('sent', 'Setup event sent', setupEvent);
        };

        testWebSocket.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            logWebSocketMessage('received', `Received ${data.type} event`, data);
          } catch (err) {
            logWebSocketMessage('received', event.data);
          }
        };

        testWebSocket.onerror = (error) => {
          logWebSocketMessage('error', 'WebSocket error occurred', error);
        };

        testWebSocket.onclose = (event) => {
          updateConnectionStatus(false);

          if (!event.wasClean) {
            // Check if it's a Codespace URL
            if (isCodespace) {
              // Browser WebSocket tests may fail due to auth, but phone calls will work
              logWebSocketMessage('warning', `
                <strong>‚ÑπÔ∏è Browser Test Limitation</strong><br><br>
                WebSocket tests from your browser may not work due to authentication requirements.<br><br>
                <strong>‚úÖ This is normal! Your phone calls will work fine.</strong><br><br>
                When you make an actual phone call, Twilio's servers will connect to your WebSocket server directly (without browser authentication), and everything will work.<br><br>
                Then proceed to the next step to test with a real phone call!
              `);
            } else {
              // Connection failed - provide helpful troubleshooting
              logWebSocketMessage('error', `
                <strong>Connection failed!</strong><br><br>
                <strong>Troubleshooting:</strong><br>
                1. Server may still be starting up<br>
                2. Wait 30-60 seconds and try again<br>
                3. If issue persists, get a new server URL
              `);
            }
          } else {
            logWebSocketMessage('info', 'WebSocket connection closed');
          }
        };

      } catch (error) {
        logWebSocketMessage('error', `Connection failed: ${error.message}`);
      }
    }

    function disconnectWebSocketTest() {
      if (testWebSocket) {
        testWebSocket.close();
        testWebSocket = null;
        updateConnectionStatus(false);
        logWebSocketMessage('info', 'Disconnected by user');
      }
    }

    function clearWebSocketLog() {
      const log = document.getElementById('websocketMessageLog');
      if (log) {
        log.innerHTML = `
          <div style="color: #888; text-align: center; padding: 40px 20px;">
            <div style="font-size: 48px; margin-bottom: 10px;">üì°</div>
            <div>WebSocket message log cleared</div>
            <div style="font-size: 11px; margin-top: 10px;">Connect and send messages to see real-time communication</div>
          </div>
        `;
      }
    }

    async function sendAudioToWebSocket() {
      const statusDiv = document.getElementById('audioTestStatus');

      if (!isConnected) {
        statusDiv.innerHTML = '‚ö†Ô∏è Please connect to WebSocket first!';
        statusDiv.style.color = '#ff9800';
        return;
      }

      const fileInput = document.getElementById('audioFileInput');
      const file = fileInput.files[0];

      if (!file) {
        statusDiv.innerHTML = '‚ö†Ô∏è Please select a WAV file first (or click "Use Sample")';
        statusDiv.style.color = '#ff9800';
        return;
      }

      statusDiv.innerHTML = 'üì§ Sending audio data...';
      statusDiv.style.color = '#4fc1ff';

      try {
        // Read the file as array buffer
        const arrayBuffer = await file.arrayBuffer();
        const uint8Array = new Uint8Array(arrayBuffer);

        // Convert to base64 for transmission
        const base64 = btoa(String.fromCharCode.apply(null, uint8Array));

        // Send as media event
        const mediaEvent = {
          type: 'media',
          payload: base64,
          timestamp: Date.now()
        };

        testWebSocket.send(JSON.stringify(mediaEvent));
        logWebSocketMessage('sent', `Sent audio data (${(arrayBuffer.byteLength / 1024).toFixed(2)} KB)`, {
          type: 'media',
          size: arrayBuffer.byteLength,
          filename: file.name
        });

        // Simulate transcription result (since we're testing)
        setTimeout(() => {
          const promptEvent = {
            type: 'prompt',
            voicePrompt: 'Hello, this is a test message from the audio file!',
            confidence: 0.95
          };
          testWebSocket.send(JSON.stringify(promptEvent));
          logWebSocketMessage('sent', 'Simulated transcription result', promptEvent);

          statusDiv.innerHTML = '‚úÖ Audio sent successfully!';
          statusDiv.style.color = '#4caf50';
        }, 500);

      } catch (error) {
        logWebSocketMessage('error', `Failed to send audio: ${error.message}`);
        statusDiv.innerHTML = `‚ùå Error: ${error.message}`;
        statusDiv.style.color = '#f44336';
      }
    }

    function useSampleAudio() {
      const statusDiv = document.getElementById('audioTestStatus');

      if (!isConnected) {
        statusDiv.innerHTML = '‚ö†Ô∏è Please connect to WebSocket first!';
        statusDiv.style.color = '#ff9800';
        return;
      }

      // Send a sample prompt event (simulating audio transcription)
      const promptEvent = {
        type: 'prompt',
        voicePrompt: 'Hello! Can you tell me about yourself?',
        confidence: 0.98,
        isSample: true
      };

      testWebSocket.send(JSON.stringify(promptEvent));
      logWebSocketMessage('sent', 'Sample audio prompt sent (simulated transcription)', promptEvent);

      statusDiv.innerHTML = '‚úÖ Sample message sent!';
      statusDiv.style.color = '#4caf50';

      setTimeout(() => {
        statusDiv.innerHTML = '';
      }, 3000);
    }

    function validateCode7_OLD_WEBSOCKET() {
      const code = document.getElementById('code7').value;
      const checks = {
        hasWebSocket: code.includes('WebSocket') || code.includes('ws'),
        hasOpenAI: code.includes('OpenAI'),
        hasStart: code.includes('start'),
        hasTranscript: code.includes('transcript')
      };

      if (Object.values(checks).every(v => v)) {
        websocketBuilt = true;
        document.getElementById('nextBtn7').disabled = false;
        showStatus('step7Status', 'success', '‚úÖ WebSocket handler looks good! Next we\'ll upgrade to ConversationRelay.');
        updateProgressBar();
      } else {
        showStatus('step7Status', 'error', '‚ùå Please implement all required event handlers');
      }
    }

    function resetCode7() {
      document.getElementById('code7').value = `exports.handler = async function(context, event, callback) {
  const response = new Twilio.Response();
  response.setStatusCode(200);
  response.appendHeader('Content-Type', 'text/plain');

  // Check if this is a WebSocket upgrade request
  if (!event.request || !event.request.headers || event.request.headers.upgrade !== 'websocket') {
    response.setBody('This endpoint requires WebSocket connection');
    return callback(null, response);
  }

  // Initialize OpenAI
  const OpenAI = require('openai');
  const openaiApiKey = context.OPENAI_API_KEY;

  if (!openaiApiKey) {
    console.log('No OpenAI API key configured');
    response.setBody('OpenAI API key not configured');
    return callback(null, response);
  }

  const openai = new OpenAI({ apiKey: openaiApiKey });

  // Handle WebSocket connection
  try {
    const WebSocket = require('ws');
    const ws = event.request;

    console.log('WebSocket connection established');

    ws.on('message', async (data) => {
      try {
        const message = JSON.parse(data);
        console.log('Received message:', message);

        switch (message.event) {
          case 'start':
            console.log('Call started:', message.streamSid || 'test-stream');
            ws.send(JSON.stringify({
              event: 'connected',
              message: 'WebSocket handler ready'
            }));
            break;

          case 'transcript':
            console.log('Transcript received:', message.transcript);

            let aiResponse;

            if (openai) {
              // Send to OpenAI
              const completion = await openai.chat.completions.create({
                model: 'gpt-4o-mini',
                messages: [{
                  role: 'user',
                  content: message.transcript
                }],
                max_tokens: 150
              });
              aiResponse = completion.choices[0].message.content;
            } else {
              // Placeholder response when OpenAI not configured
              aiResponse = 'I received your message: ' + message.transcript + '. However, OpenAI is not configured yet. Please set your OPENAI_API_KEY environment variable.';
            }

            console.log('AI response:', aiResponse);

            // Send response back
            ws.send(JSON.stringify({
              event: 'text',
              text: aiResponse
            }));
            break;

          case 'stop':
            console.log('Call ended');
            ws.close();
            break;

          default:
            console.log('Unknown event:', message.event);
        }
      } catch (error) {
        console.error('Error processing message:', error);
        ws.send(JSON.stringify({
          event: 'error',
          message: error.message
        }));
      }
    });

    ws.on('error', (error) => {
      console.error('WebSocket error:', error);
    });

    ws.on('close', () => {
      console.log('WebSocket connection closed');
      callback(null, response);
    });

  } catch (error) {
    console.error('Failed to establish WebSocket:', error);
    response.setBody('WebSocket connection failed: ' + error.message);
    return callback(null, response);
  }

  // Don't call callback here - let the 'close' event handle it
};`;
      document.getElementById('console7').innerHTML = '';
      document.getElementById('step7Status').innerHTML = '';
    }

    function resetCode7_OLD_WEBSOCKET() {
      document.getElementById('code7').value = `exports.handler = function(context, event, callback) {
  const WebSocket = require('ws');
  const OpenAI = require('openai');

  // TODO: Handle WebSocket connection
  // TODO: Listen for 'start' event
  // TODO: Process 'transcript' events
  // TODO: Send responses back to Twilio
  // TODO: Handle 'stop' event

  callback(null, {});
};`;
    }

    // =========================================================================
    // Dead code removed: Old renderStep5() and renderStep6() functions
    // The active functions are renderStep_WebSocket() and renderStep_ConversationRelay()
    // =========================================================================

    async function makeTestCall() {
      const toNumber = document.getElementById('testPhoneNumber').value.trim();
      const fromNumber = document.getElementById('fromNumber').value.trim();

      if (!toNumber || !toNumber.startsWith('+')) {
        showStatus('step6Status', 'error', 'Please enter a valid phone number with country code (e.g., +1234567890)');
        return;
      }

      // Close any existing WebSocket test connection before making call
      if (testWebSocket) {
        console.log('üîå Closing existing WebSocket test connection before making call...');
        try {
          testWebSocket.close();
          testWebSocket = null;
          isConnected = false;
        } catch (e) {
          console.warn('Error closing WebSocket:', e);
        }
      }

      // Handle demo mode
      if (twilioCredentials?.demoMode) {
        showStatus('step6Status', 'info', 'üìù Demo Mode: Simulating call...');

        setTimeout(() => {
          document.getElementById('callStatus').style.display = 'block';
          document.getElementById('callDetails').innerHTML = `
            <div style="margin: 10px 0;">
              <strong>Call SID:</strong> CAdemo123456789<br>
              <strong>Status:</strong> <span id="callStatusText">completed</span><br>
              <strong>To:</strong> ${toNumber}<br>
              <strong>From:</strong> ${fromNumber}<br>
              <strong>Duration:</strong> 45 seconds
            </div>
            <div style="margin-top: 15px; padding: 15px; background: #fff3cd; border-radius: 6px;">
              <strong>üìù Demo Mode Simulation</strong>
              <p style="margin: 10px 0 0 0; font-size: 13px;">
                In a real call, the bot would answer and conduct the conversation.
                Your code is ready to deploy for live testing!
              </p>
            </div>
          `;

          showStatus('step6Status', 'success', '‚úÖ Demo call simulated! Your bot is ready for real deployment.');
          callTested = true;
          document.getElementById('completeBtn').disabled = false;
          updateProgressBar();
        }, 1500);
        return;
      }

      // Get the voice handler URL from Twilio Serverless deployment
      let voiceHandlerUrl;
      if (twilioServerlessDomain) {
        // Use Twilio Serverless domain for voice handler
        voiceHandlerUrl = `https://${twilioServerlessDomain}/voice-handler`;
      } else {
        showStatus('step6Status', 'error', 'No Twilio Serverless deployment found. Please complete the deployment step first.');
        return;
      }

      showStatus('step6Status', 'info', `Initiating call to ${toNumber}...`);

      try {
        const response = await fetch('/api/tutorial-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'makeCall',
            to: toNumber,
            from: fromNumber,
            url: voiceHandlerUrl,
            ...twilioCredentials
          })
        });

        const data = await response.json();

        if (data.success) {
          document.getElementById('callStatus').style.display = 'block';
          document.getElementById('callDetails').innerHTML = `
            <div style="margin: 10px 0;">
              <strong>Call SID:</strong> ${data.callSid}<br>
              <strong>Status:</strong> <span id="callStatusText">${data.status}</span><br>
              <strong>To:</strong> ${data.to}<br>
              <strong>From:</strong> ${data.from}
            </div>
            <button class="btn btn-test" onclick="checkCallStatus('${data.callSid}')">üîÑ Refresh Status</button>
          `;

          showStatus('step6Status', 'success', '‚úÖ Call initiated! Answer your phone to test the bot.');
          callTested = true;
          document.getElementById('completeBtn').disabled = false;
          updateProgressBar();
        } else {
          throw new Error(data.error);
        }
      } catch (error) {
        showStatus('step6Status', 'error', 'Failed to make call: ' + error.message);
      }
    }

    async function checkCallStatus(callSid) {
      try {
        const response = await fetch('/api/tutorial-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'getCall',
            callSid,
            ...twilioCredentials
          })
        });

        const data = await response.json();

        if (data.success) {
          document.getElementById('callStatusText').textContent = data.call.status;
          if (data.call.duration) {
            document.getElementById('callDetails').innerHTML += `<br><strong>Duration:</strong> ${data.call.duration} seconds`;
          }
        }
      } catch (error) {
        console.error('Failed to check call status:', error);
      }
    }

    function completeWorkshop() {
      showStatus('step6Status', 'success', `
        <h3 style="margin-bottom: 15px;">üéâ Workshop Complete!</h3>
        <p>You've successfully built a production-ready Twilio Voice AI bot with:</p>
        <ul style="margin: 15px 0; padding-left: 20px;">
          <li>Twilio ConversationRelay for bidirectional streaming</li>
          <li>WebSocket integration for real-time events</li>
          <li>OpenAI for intelligent responses</li>
          <li>Complete service provisioning</li>
        </ul>
        <div style="margin-top: 30px; padding: 20px; background: #d4edda; border-radius: 8px; border-left: 4px solid #28a745;">
          <p style="margin: 0 0 15px 0;"><strong>üöÄ Your Production-Ready Application</strong></p>
          <p style="margin: 0 0 15px 0;">You now have a fully functional AI voice assistant! View your deployment details below.</p>
          <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-top: 20px;">
            <button onclick="showDeploymentSummary()" class="btn btn-primary" style="display: inline-block; padding: 12px 30px; background: linear-gradient(135deg, #F22F46 0%, #d91c3a 100%); color: white; text-decoration: none; border-radius: 50px; font-weight: bold; border: none; cursor: pointer;">
              üìã View Deployment Summary
            </button>
            <a href="/instructor-dashboard.html" class="btn btn-primary" style="display: inline-block; padding: 12px 30px; background: linear-gradient(135deg, #28a745 0%, #218838 100%); color: white; text-decoration: none; border-radius: 50px; font-weight: bold;">
              üìä Instructor Dashboard
            </a>
          </div>
        </div>
        <p style="margin-top: 20px; font-size: 0.9em; color: #666;">
          üìö Or continue learning: <a href="https://www.twilio.com/docs/voice" target="_blank">Twilio Voice Docs</a>
        </p>
      `);

      // Auto-show deployment summary after 2 seconds
      setTimeout(() => {
        showDeploymentSummary();
      }, 2000);
    }

    // =========================================================================
    // DEPLOYMENT SUMMARY
    // =========================================================================

    function showDeploymentSummary() {
      const deploymentUrl = websocketUrl ? `https://${websocketUrl}` : 'Not deployed';

      const summaryHTML = `
        <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;" onclick="this.remove()">
          <div style="background: white; border-radius: 16px; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto; padding: 40px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);" onclick="event.stopPropagation()">
            <div style="text-align: center; margin-bottom: 30px;">
              <h2 style="font-size: 2rem; margin-bottom: 10px; color: #F22F46;">üéâ Deployment Summary</h2>
              <p style="color: #666; font-size: 1.1rem;">Your Production-Ready AI Voice Assistant</p>
            </div>

            <div style="background: linear-gradient(135deg, #F22F46 0%, #0d122b 100%); padding: 25px; border-radius: 12px; color: white; margin-bottom: 30px;">
              <h3 style="margin: 0 0 15px 0; font-size: 1.3rem;">üì¶ Twilio Serverless Service</h3>
              <div style="font-family: monospace; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                <div style="margin-bottom: 10px;"><strong>Service SID:</strong> ${deployedServiceSid || 'Not deployed'}</div>
                <div style="margin-bottom: 10px;"><strong>Environment SID:</strong> ${deployedEnvironmentSid || 'Not deployed'}</div>
                <div style="margin-bottom: 10px;"><strong>Domain:</strong> ${deploymentUrl}</div>
                <div><strong>Phone Number:</strong> ${selectedPhoneNumber || 'Not configured'}</div>
              </div>
            </div>

            <div style="margin-bottom: 30px;">
              <h3 style="margin: 0 0 15px 0; color: #333; font-size: 1.2rem;">üîß Deployed Functions</h3>
              <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #28a745;">
                <div style="margin-bottom: 15px;">
                  <strong>voice-handler</strong>
                  <div style="color: #666; font-size: 0.9rem; margin-top: 5px;">
                    ${step6Committed ? '‚úÖ ConversationRelay TwiML (upgraded in Step 6)' : step4Committed ? 'üìù Basic TwiML (Step 4)' : '‚ùå Not deployed'}
                  </div>
                  <div style="font-family: monospace; font-size: 0.85rem; color: #0066cc; margin-top: 5px;">
                    ${deploymentUrl}/voice-handler
                  </div>
                </div>
                <div>
                  <strong>websocket-handler</strong>
                  <div style="color: #666; font-size: 0.9rem; margin-top: 5px;">
                    ${step8Committed ? '‚úÖ With AI Tools (Step 7)' : step6Committed ? '‚úÖ OpenAI Integration (Step 5)' : '‚ùå Not deployed'}
                  </div>
                  <div style="font-family: monospace; font-size: 0.85rem; color: #0066cc; margin-top: 5px;">
                    ${websocketUrl}/websocket-handler
                  </div>
                </div>
              </div>
            </div>

            <div style="margin-bottom: 30px;">
              <h3 style="margin: 0 0 15px 0; color: #333; font-size: 1.2rem;">üîë Configuration</h3>
              <div style="background: #fff3cd; padding: 20px; border-radius: 8px; border-left: 4px solid #ffc107;">
                <div style="margin-bottom: 10px;">
                  <strong>OpenAI API Key:</strong> ${openaiApiKey ? '‚úÖ Configured' : '‚ùå Not configured'}
                </div>
                <div style="margin-bottom: 10px;">
                  <strong>TTS Provider:</strong> ${ttsProvider || 'amazon-polly'}
                </div>
                <div style="margin-bottom: 10px;">
                  <strong>Call Direction:</strong> ${callDirection || 'Not selected'}
                </div>
                <div>
                  <strong>Default Voice:</strong> ${getDefaultVoice ? getDefaultVoice() : 'Not configured'}
                </div>
              </div>
            </div>

            <div style="margin-bottom: 30px;">
              <h3 style="margin: 0 0 15px 0; color: #333; font-size: 1.2rem;">üìä Progress Summary</h3>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div style="background: ${step4Committed ? '#d4edda' : '#f8d7da'}; padding: 15px; border-radius: 8px; text-align: center;">
                  <div style="font-size: 2rem; margin-bottom: 5px;">${step4Committed ? '‚úÖ' : '‚è≥'}</div>
                  <strong>Step 4</strong><br>
                  <small>Basic TwiML</small>
                </div>
                <div style="background: ${step6Committed ? '#d4edda' : '#f8d7da'}; padding: 15px; border-radius: 8px; text-align: center;">
                  <div style="font-size: 2rem; margin-bottom: 5px;">${step6Committed ? '‚úÖ' : '‚è≥'}</div>
                  <strong>Step 5</strong><br>
                  <small>WebSocket Handler</small>
                </div>
                <div style="background: ${step6Committed ? '#d4edda' : '#f8d7da'}; padding: 15px; border-radius: 8px; text-align: center;">
                  <div style="font-size: 2rem; margin-bottom: 5px;">${step6Committed ? '‚úÖ' : '‚è≥'}</div>
                  <strong>Step 6</strong><br>
                  <small>ConversationRelay</small>
                </div>
                <div style="background: ${step8Committed ? '#d4edda' : '#f8d7da'}; padding: 15px; border-radius: 8px; text-align: center;">
                  <div style="font-size: 2rem; margin-bottom: 5px;">${step8Committed ? '‚úÖ' : '‚è≥'}</div>
                  <strong>Step 7</strong><br>
                  <small>AI Tools</small>
                </div>
              </div>
            </div>

            <div style="background: #e7f3ff; padding: 20px; border-radius: 8px; border-left: 4px solid #0066cc; margin-bottom: 20px;">
              <h4 style="margin: 0 0 10px 0; color: #0066cc;">üöÄ Next Steps</h4>
              <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
                <li>Test your voice handler by calling ${selectedPhoneNumber || 'your configured number'}</li>
                <li>Monitor calls in the <a href="https://console.twilio.com/us1/monitor/logs/voice" target="_blank">Twilio Console</a></li>
                <li>View function logs in the <a href="https://console.twilio.com/us1/develop/functions/services/${deployedServiceSid || ''}" target="_blank">Functions Editor</a></li>
                <li>Customize your AI prompts and add more tools</li>
                <li>Review the <a href="https://www.twilio.com/docs/voice/conversationrelay" target="_blank">ConversationRelay Documentation</a></li>
              </ul>
            </div>

            <div style="text-align: center;">
              <button onclick="this.closest('[style*=fixed]').remove()" style="padding: 15px 40px; background: linear-gradient(135deg, #F22F46 0%, #d91c3a 100%); color: white; border: none; border-radius: 50px; font-size: 1.1rem; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(242, 47, 70, 0.3);">
                Close Summary
              </button>
            </div>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', summaryHTML);
    }

    // =========================================================================
    // NAVIGATION & HELPERS
    // =========================================================================

    // Debouncing variables to prevent double-clicks
    let nextStepDebounce = false;
    let prevStepDebounce = false;

    function nextStep() {
      // Prevent double-clicks
      if (nextStepDebounce) {
        console.log('Next step debounced - preventing double click');
        return;
      }

      // Set debounce flag immediately to prevent any double-clicks
      nextStepDebounce = true;

      // Check prerequisites before allowing progression
      const prerequisiteCheck = checkPrerequisites();
      if (!prerequisiteCheck.canProceed) {
        showStatus(`step${currentStep + 1}Status`, 'error', `‚ö†Ô∏è ${prerequisiteCheck.message}`);
        // Scroll to the prerequisite message
        document.getElementById(`step${currentStep + 1}Status`)?.scrollIntoView({ behavior: 'smooth', block: 'center' });
        // Reset debounce since we're not proceeding
        setTimeout(() => {
          nextStepDebounce = false;
        }, 500);
        return;
      }

      // In demo mode, update progress bar after setting flags
      if (studentDemoMode) {
        updateProgressBar();
      }

      if (currentStep < steps.length - 1) {

        // Celebrate milestones
        if (currentStep === 2) {
          celebrate('üéâ Great! You\'ve completed the basics!', 'light');
        } else if (currentStep === 5) {
          celebrate('üöÄ Halfway there! Keep going!', 'normal');
        } else if (currentStep === 7) {
          celebrate('üéä Almost done! Final step ahead!', 'normal');
        }

        const oldStep = currentStep;
        currentStep++;
        logNavigation(oldStep, currentStep); // Log step navigation
        renderProgressSteps();
        renderStepContent();
        window.scrollTo(0, 0);
        saveProgressToStorage(); // Auto-save after navigation
        updateProgressBar(); // Ensure progress bar updates after navigation

        // Epic celebration on completion
        if (currentStep === steps.length - 1) {
          setTimeout(() => {
            const message = studentName
              ? `üèÜ Congratulations, ${studentName}! Workshop Complete!`
              : 'üèÜ Congratulations! Workshop Complete!';
            celebrate(message, 'epic');
          }, 1000);
        }

        // Reset debounce after 500ms
        setTimeout(() => {
          nextStepDebounce = false;
        }, 500);
      }
    }

    function checkPrerequisites() {
      // In demo mode, automatically set flags as user progresses
      if (studentDemoMode) {
        switch(currentStep) {
          case 0: // Step 1 -> 2
            setState("twilioConnected", true);
            setState("openaiConnected", true);
            break;
          case 1: // Step 2 -> 3
            setState("callDirectionChosen", true);
            callDirectionChosen = true;
            useCaseDescription = useCaseDescription || 'Demo use case - exploring the workshop';
            break;
          case 2: // Step 3 -> 4
            setState("servicesReady", true);
            servicesReady = true;
            selectedPhoneNumber = selectedPhoneNumber || '+15555551234';
            break;
          case 3: // Step 4 -> 5
            setState("step4CodeValidated", true);
            setState("step4Deployed", true);
            step4CodeValidated = true;
            step4Deployed = true;
            basicTwimlCreated = true;
            break;
          case 4: // Step 5 -> 6
            setState("step5CodeValidated", true);
            setState("step5Deployed", true);
            step5CodeValidated = true;
            step5Deployed = true;
            websocketBuilt = true;
            break;
          case 5: // Step 6 -> 7
            setState("step6CodeValidated", true);
            setState("step6Deployed", true);
            step6CodeValidated = true;
            step6Deployed = true;
            conversationRelayCreated = true;
            break;
          case 6: // Step 7 -> 8
            setState("systemPromptSaved", true);
            setState("step7Deployed", true);
            systemPromptSaved = true;
            step7Deployed = true;
            promptEngineeringComplete = true;
            break;
          case 7: // Step 8 -> 9
            setState("step8CodeValidated", true);
            setState("step8Deployed", true);
            step8CodeValidated = true;
            step8Deployed = true;
            toolsConfigured = true;
            break;
        }
        // In demo mode, always allow progression
        return { canProceed: true };
      }

      // Normal mode - check prerequisites
      switch(currentStep) {
        case 0: // currentStep 0 = Step 1: Setup
          if (!twilioConnected) {
            return { canProceed: false, message: 'Please connect your Twilio account first!' };
          }
          break;

        case 1: // currentStep 1 = Step 2: Direction & Use Case
          if (!useCaseDescription || !useCaseDescription.trim()) {
            return { canProceed: false, message: 'Please describe your use case first!' };
          }
          if (!callDirectionChosen) {
            return { canProceed: false, message: 'Please choose a call direction (Inbound or Outbound)!' };
          }
          break;

        case 2: // currentStep 2 = Step 3: Services
          if (!selectedPhoneNumber) {
            return { canProceed: false, message: 'Please select or purchase a phone number!' };
          }
          if (!servicesReady) {
            return { canProceed: false, message: 'Please complete service setup: Messaging Service and Sync Service (or skip Sync)!' };
          }
          break;

        case 3: // currentStep 3 = Step 4: Basic TwiML
          if (!basicTwimlCreated) {
            return { canProceed: false, message: 'Please create and validate your Basic TwiML code!' };
          }
          break;

        case 4: // currentStep 4 = Step 5: WebSocket
          if (!websocketBuilt) {
            return { canProceed: false, message: 'Please create and validate your WebSocket handler!' };
          }
          // Note: OpenAI validation removed here - students can enter Step 5 to input their key
          // OpenAI will be validated when they try to deploy or test in Step 6
          break;

        case 5: // currentStep 5 = Step 6: ConversationRelay
          // Validate OpenAI is connected before proceeding to Step 6
          if (!openaiConnected && !studentDemoMode && !twilioCredentials?.demoMode) {
            return { canProceed: false, message: 'Please connect your OpenAI API key in Step 5 before proceeding!' };
          }
          if (!conversationRelayCreated) {
            return { canProceed: false, message: 'Please create and validate your ConversationRelay TwiML!' };
          }
          break;

        case 6: // currentStep 6 = Step 7: Custom AI Prompt
          if (!systemPromptSaved && !studentDemoMode) {
            return { canProceed: false, message: 'Please save your custom AI prompt before proceeding!' };
          }
          break;

        case 7: // currentStep 7 = Step 8: Tools & Functions
          if (!toolsConfigured && !studentDemoMode) {
            return { canProceed: false, message: 'Please validate and configure your tools before proceeding!' };
          }
          break;

        case 8: // currentStep 8 = Step 9: Final Deployment
          // No prerequisite - this is the final deployment step
          break;
      }

      return { canProceed: true };
    }

    function prevStep() {
      // Prevent double-clicks
      if (prevStepDebounce) {
        console.log('Prev step debounced - preventing double click');
        return;
      }

      if (currentStep > 0) {
        // Set debounce flag
        prevStepDebounce = true;

        currentStep--;
        renderProgressSteps();
        renderStepContent();
        window.scrollTo(0, 0);
        saveProgressToStorage(); // Auto-save after navigation

        // Reset debounce after 500ms
        setTimeout(() => {
          prevStepDebounce = false;
        }, 500);
      }
    }

    /**
     * Navigate directly to a specific step (for skip buttons)
     * @param {number} targetStep - The step index to navigate to (0-based)
     */
    function navigateToStep(targetStep) {
      if (targetStep < 0 || targetStep >= steps.length) {
        console.error('Invalid step number:', targetStep);
        return;
      }

      currentStep = targetStep;
      renderProgressSteps();
      renderStepContent();
      window.scrollTo(0, 0);
      saveProgressToStorage();

      console.log(`üìç Navigated to step ${targetStep}: ${steps[targetStep].title}`);
    }

    function showStatus(elementId, type, message) {
      const element = document.getElementById(elementId);
      if (!element) {
        console.warn(`showStatus: Element with id '${elementId}' not found`);
        return;
      }
      element.className = `status-box show ${type}`;
      element.innerHTML = message;
    }

    // Handle code change detection for validate buttons
    function handleCodeChange(codeId) {
      // Map code IDs to their change flags and button selectors
      const config = {
        'code4': {
          flag: 'code4Changed',
          buttonSelector: '[onclick="validateCode4()"]',
          validatedFlag: 'step4CodeValidated',
          deployedFlag: 'step4Deployed'
        },
        'code7': {
          flag: 'code7Changed',
          buttonSelector: '#validateBtn7',
          validatedFlag: 'step5CodeValidated',
          deployedFlag: 'step5Deployed'
        },
        'code8': {
          flag: 'code8Changed',
          buttonSelector: '[onclick="validateCode8()"]',
          validatedFlag: 'step6CodeValidated',
          deployedFlag: 'step6Deployed'
        },
        'code9': {
          flag: 'code9Changed',
          buttonSelector: '[onclick="validateCode9()"]',
          validatedFlag: 'toolsConfigured',
          deployedFlag: 'step8Deployed'
        }
      };

      const cfg = config[codeId];
      if (!cfg) return;

      // If code was previously validated, mark as changed and re-enable validate button
      if (eval(cfg.validatedFlag)) {
        eval(`${cfg.flag} = true`);
        const validateBtn = document.querySelector(cfg.buttonSelector);
        if (validateBtn) {
          validateBtn.disabled = false;
          validateBtn.style.opacity = '1';
          validateBtn.classList.add('next-action');
        }

        // If code was deployed, mark as needing re-deployment
        if (cfg.deployedFlag && eval(cfg.deployedFlag)) {
          eval(`${cfg.deployedFlag} = false`);
          // Re-render to update deploy button state
          renderStepContent();
        }
      }
    }

    // Add channel code to the code9 editor
    function addChannelCodeToEditor(channelCodeId) {
      const channelCode = document.getElementById(channelCodeId);
      const code9Editor = document.getElementById('code9');

      if (!channelCode || !code9Editor) {
        console.error('Could not find code elements');
        return;
      }

      const codeToAdd = channelCode.value;
      const currentCode = code9Editor.value;

      // Find where to insert the code (before the closing of exports.handler)
      // Look for the last closing brace
      const lastBraceIndex = currentCode.lastIndexOf('};');

      if (lastBraceIndex !== -1) {
        // Insert the channel code before the closing
        const beforeClosing = currentCode.substring(0, lastBraceIndex);
        const closing = currentCode.substring(lastBraceIndex);

        // Add a comment header and the new code
        const channelName = channelCodeId.replace('Function', '').toUpperCase();
        const insertCode = `\n\n  // ============================================\n  // ${channelName} CHANNEL CODE - Added from examples\n  // ============================================\n\n  ${codeToAdd.split('\n').map(line => '  ' + line).join('\n')}\n\n`;

        code9Editor.value = beforeClosing + insertCode + closing;
      } else {
        // If we can't find the structure, just append at the end
        code9Editor.value = currentCode + '\n\n' + codeToAdd;
      }

      // Trigger change detection to re-enable validate button if needed
      handleCodeChange('code9');

      // Update the button that was clicked to show success
      const clickedButton = event?.target;
      if (clickedButton) {
        const originalText = clickedButton.textContent;
        const originalBackground = clickedButton.style.background;
        clickedButton.textContent = '‚úÖ Added!';
        clickedButton.style.background = '#10b981';
        clickedButton.disabled = true;

        setTimeout(() => {
          clickedButton.textContent = originalText;
          clickedButton.style.background = originalBackground;
          clickedButton.disabled = false;
        }, 3000);
      }

      // Scroll back up to the code9 editor
      const code9Container = code9Editor.closest('.code-editor');
      if (code9Container) {
        code9Container.scrollIntoView({ behavior: 'smooth', block: 'start' });
        // Give a visual indication that code was added
        code9Editor.style.border = '2px solid #10b981';
        setTimeout(() => {
          code9Editor.style.border = '';
        }, 2000);
      }

      // Show success message
      const channelName = channelCodeId.replace('Function', '').toUpperCase();
      showStatus('step9Status', 'success', `‚úÖ ${channelName} code added to your Tools & Knowledge Base handler!`);
    }

    // Switch between multi-channel tabs
    function showChannelTab(channel) {
      // Hide all content
      document.getElementById('channelContentSMS').style.display = 'none';
      document.getElementById('channelContentEmail').style.display = 'none';
      document.getElementById('channelContentWhatsApp').style.display = 'none';

      // Reset all tab buttons
      document.getElementById('tabSMS').style.background = '#e0e0e0';
      document.getElementById('tabSMS').style.color = '#666';
      document.getElementById('tabEmail').style.background = '#e0e0e0';
      document.getElementById('tabEmail').style.color = '#666';
      document.getElementById('tabWhatsApp').style.background = '#e0e0e0';
      document.getElementById('tabWhatsApp').style.color = '#666';

      // Show selected content and highlight tab
      if (channel === 'sms') {
        document.getElementById('channelContentSMS').style.display = 'block';
        document.getElementById('tabSMS').style.background = '#10b981';
        document.getElementById('tabSMS').style.color = 'white';
      } else if (channel === 'email') {
        document.getElementById('channelContentEmail').style.display = 'block';
        document.getElementById('tabEmail').style.background = '#10b981';
        document.getElementById('tabEmail').style.color = 'white';
      } else if (channel === 'whatsapp') {
        document.getElementById('channelContentWhatsApp').style.display = 'block';
        document.getElementById('tabWhatsApp').style.background = '#10b981';
        document.getElementById('tabWhatsApp').style.color = 'white';
      }
    }

    // Copy code to clipboard
    async function copyCode(textareaId) {
      const textarea = document.getElementById(textareaId);
      const code = textarea.value;

      try {
        await navigator.clipboard.writeText(code);

        // Find the copy button for this textarea
        const button = event.target;
        const originalText = button.innerHTML;

        // Show success feedback
        button.innerHTML = '‚úì Copied!';
        button.classList.add('copied');

        // Reset after 2 seconds
        setTimeout(() => {
          button.innerHTML = originalText;
          button.classList.remove('copied');
        }, 2000);
      } catch (error) {
        // Fallback for older browsers
        textarea.select();
        document.execCommand('copy');

        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '‚úì Copied!';
        button.classList.add('copied');

        setTimeout(() => {
          button.innerHTML = originalText;
          button.classList.remove('copied');
        }, 2000);
      }
    }

    async function copyPhoneNumber() {
      const phoneNumber = selectedPhoneNumber || 'No phone number configured';

      try {
        await navigator.clipboard.writeText(phoneNumber);

        // Show success feedback
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '‚úì Copied!';
        button.style.background = '#d1fae5';

        // Reset after 2 seconds
        setTimeout(() => {
          button.innerHTML = originalText;
          button.style.background = 'white';
        }, 2000);
      } catch (error) {
        // Fallback for older browsers
        alert(`Phone number: ${phoneNumber}\n\nCopy this number to test your AI voice bot!`);
      }
    }

    async function makeAITestCall() {
      const yourNumber = document.getElementById('testAICallNumber')?.value?.trim();
      const statusDiv = document.getElementById('aiTestCallStatus');

      if (!yourNumber) {
        statusDiv.innerHTML = '<div style="color: #e06c75; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 4px;">‚ùå Please enter your phone number</div>';
        return;
      }

      if (!yourNumber.startsWith('+')) {
        statusDiv.innerHTML = '<div style="color: #e5c07b; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 4px;">‚ö†Ô∏è Phone number must use E.164 format (e.g., +1234567890)</div>';
        return;
      }

      statusDiv.innerHTML = '<div style="color: white; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 4px;">üìû Initiating AI call...</div>';

      // DEMO MODE: Simulate test call
      if (studentDemoMode || twilioCredentials?.demoMode) {
        await new Promise(resolve => setTimeout(resolve, 1500));

        statusDiv.innerHTML = `
          <div style="color: #98c379; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 4px;">
            <strong>‚úÖ Demo: AI call simulated successfully!</strong><br>
            <div style="margin-top: 10px; font-size: 13px;">
              üì± CallSid: CA${Math.random().toString(36).substring(7)}<br>
              üìû Would call: ${yourNumber}<br>
              ü§ñ Using: ConversationRelay + OpenAI + ${getTTSProviderName()}
            </div>
            <div style="margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 4px; font-size: 12px;">
              <strong>üìù Demo Mode - What would happen:</strong><br>
              1. Your phone would ring in a few seconds<br>
              2. You'd answer and hear the AI greeting using your custom prompt<br>
              3. ConversationRelay would handle the full conversation flow<br>
              4. STT (${document.getElementById('crTranscriptionProvider')?.value === 'google' ? 'Google' : 'Deepgram'}) ‚Üí OpenAI ‚Üí TTS (${getTTSProviderName()})<br>
              5. The AI would respond exactly as you defined in your system prompt!
            </div>
            <div style="margin-top: 10px; font-style: italic; opacity: 0.9; font-size: 12px;">
              üí° In live mode with real credentials, this would place an actual phone call with your AI assistant.
            </div>
          </div>
        `;
        return;
      }

      // LIVE MODE: Make actual call
      try {
        // Use the deployed voice-handler URL which now has ConversationRelay
        const voiceHandlerUrl = `https://${twilioServerlessDomain}/voice-handler`;

        const response = await fetch('/api/tutorial-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'makeCall',
            to: yourNumber,
            from: selectedPhoneNumber,
            url: voiceHandlerUrl,
            ...twilioCredentials
          })
        });

        const data = await response.json();

        if (data.success) {
          statusDiv.innerHTML = `
            <div style="color: #98c379; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 4px;">
              <strong>‚úÖ AI call initiated successfully!</strong><br>
              <div style="margin-top: 10px; font-size: 13px;">
                üì± CallSid: ${data.callSid}<br>
                üìû Calling: ${yourNumber}<br>
                ü§ñ Using: ConversationRelay + OpenAI + ${getTTSProviderName()}
              </div>
              <div style="margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 4px; font-size: 12px;">
                <strong>What happens next:</strong><br>
                1. Your phone will ring in a few seconds<br>
                2. Answer and you'll hear your AI's custom greeting<br>
                3. Try having a natural conversation!<br>
                4. The AI uses YOUR system prompt to respond intelligently<br>
                5. Test different scenarios from your prompt
              </div>
            </div>
          `;
        } else {
          statusDiv.innerHTML = `<div style="color: #e06c75; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 4px;">‚ùå Call failed: ${data.error}</div>`;
        }
      } catch (error) {
        statusDiv.innerHTML = `<div style="color: #e06c75; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 4px;">‚ùå Error: ${error.message}</div>`;
      }
    }

    // =========================================================================
    // SAVE/LOAD PROGRESS
    // =========================================================================

    function saveProgress() {
      // Manual save - calls auto-save function
      saveProgressToStorage();
      celebrate('üíæ Progress saved!', 'light');
    }

    function loadProgress() {
      // Check if user just clicked "Start Fresh"
      if (sessionStorage.getItem('startingFresh') === 'true') {
        sessionStorage.removeItem('startingFresh');
        return;
      }

      const progress = loadProgressFromStorage();

      if (!progress) {
        alert('No saved progress found');
        return;
      }

      // Show resume modal
      showResumeModal(progress);
    }

    // Auto-save every 30 seconds (silent, updates existing auto-save session)
    setInterval(() => {
      if (currentStep > 0) {
        autoSaveProgress();
      }
    }, 30000);

    function autoSaveProgress() {
      const progressData = {
        name: 'Auto-save',
        currentStep,
        twilioConnected,
        openaiConnected,
        callDirectionChosen,
        callDirection,
        servicesReady,
        basicTwimlCreated,
        functionsDeployed,
        basicCallTested,
        websocketBuilt,
        conversationRelayCreated,
        aiCallTested,
        twilioCredentials,
        openaiApiKey,
        selectedPhoneNumber,
        syncServiceSkipped,
        code4: document.getElementById('code4')?.value,
        code7: document.getElementById('code7')?.value,
        code8: document.getElementById('code8')?.value,
        timestamp: new Date().toISOString()
      };

      // Get existing sessions
      const sessions = JSON.parse(localStorage.getItem('twilioVoiceAISessions') || '[]');

      // Find and update auto-save session, or add if doesn't exist
      const autoSaveIndex = sessions.findIndex(s => s.name === 'Auto-save');
      if (autoSaveIndex >= 0) {
        sessions[autoSaveIndex] = progressData;
      } else {
        sessions.push(progressData);
      }

      localStorage.setItem('twilioVoiceAISessions', JSON.stringify(sessions));

      // Flash save indicator briefly
      const indicator = document.getElementById('progressSaved');
      if (indicator) {
        indicator.style.display = 'block';
        indicator.style.opacity = '0.5';
        setTimeout(() => {
          indicator.style.display = 'none';
          indicator.style.opacity = '1';
        }, 1000);
      }
    }

    // =========================================================================
    // EXPORT PROJECT
    // =========================================================================

    async function exportProject() {
      const modal = document.getElementById('exportModal');
      const content = document.getElementById('exportContent');

      // Check if we have GitHub credentials
      if (!githubToken || !githubUsername || !studentRepoName) {
        content.innerHTML = `
          <div class="service-card">
            <h3>‚ö†Ô∏è GitHub Repository Not Connected</h3>
            <p style="margin: 15px 0; color: #666;">
              You need to connect your GitHub account and clone the starter repository first.
            </p>
            <button class="btn btn-primary" onclick="closeModal('exportModal'); currentStep = 0; renderStepContent();">
              Go to Step 1
            </button>
          </div>
        `;
        modal.classList.add('show');
        return;
      }

      // Show loading state
      content.innerHTML = `
        <div class="service-card" style="text-align: center; padding: 40px;">
          <div style="font-size: 48px; margin-bottom: 15px;">‚è≥</div>
          <p style="color: #666;">Fetching your project files from GitHub...</p>
          <p style="color: #999; font-size: 14px; margin-top: 10px;">
            ${githubUsername}/${studentRepoName}
          </p>
        </div>
      `;
      modal.classList.add('show');

      try {
        // Fetch files from GitHub repo
        console.log(`üì¶ Fetching project files from GitHub: ${githubUsername}/${studentRepoName}`);

        // List of files to fetch from the repo
        const filesToFetch = [
          'websocket-handler.js',
          'package.json',
          'README.md',
          '.env.example',
          'public/admin-panel.html'
        ];

        const projectFiles = {};

        // Fetch each file from GitHub
        for (const filePath of filesToFetch) {
          try {
            const response = await fetch(
              `https://api.github.com/repos/${githubUsername}/${studentRepoName}/contents/${filePath}`,
              {
                headers: {
                  'Authorization': `Bearer ${githubToken}`,
                  'Accept': 'application/vnd.github.v3+json'
                }
              }
            );

            if (response.ok) {
              const data = await response.json();
              // Decode base64 content
              const content = atob(data.content);
              projectFiles[filePath] = content;
              console.log(`  ‚úì Fetched: ${filePath}`);
            } else {
              console.warn(`  ‚ö†Ô∏è Could not fetch: ${filePath}`);
            }
          } catch (error) {
            console.warn(`  ‚ùå Error fetching ${filePath}:`, error.message);
          }
        }

        // Render the modal with fetched files
        content.innerHTML = `
          <div class="service-card">
            <h3>üì¶ Your Project Files</h3>
            <p style="margin: 15px 0; color: #666;">
              Fetched from <strong>${githubUsername}/${studentRepoName}</strong>
            </p>

            <div style="display: flex; flex-direction: column; gap: 10px; margin: 20px 0;">
              ${Object.keys(projectFiles).map(filename => {
                return `
                <button class="btn btn-primary" onclick="downloadFileFromContent('${filename}')">
                  üìÑ ${filename}
                </button>
              `;
              }).join('')}
            </div>

            <button class="btn btn-success" onclick="downloadAllFilesFromGitHub()">
              üì¶ Download Complete Project (ZIP)
            </button>

            <div style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 6px; border-left: 4px solid #2196f3;">
              <h4 style="color: #1976d2; margin-bottom: 10px;">üí° Your GitHub Repository</h4>
              <p style="color: #666; margin-bottom: 10px;">
                All your workshop changes have been saved to your GitHub repo throughout the workshop.
              </p>
              <a href="https://github.com/${githubUsername}/${studentRepoName}" target="_blank"
                 class="btn btn-secondary" style="margin-top: 10px;">
                üîó View on GitHub
              </a>
            </div>

            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
              <h4>Next Steps:</h4>
              <ol style="margin: 10px 0 0 20px; line-height: 1.8;">
                <li>Clone your repo: <code>git clone https://github.com/${githubUsername}/${studentRepoName}</code></li>
                <li>Run <code>npm install</code></li>
                <li>Configure your <code>.env</code> file</li>
                <li>Optional: Deploy to Railway or your own server</li>
              </ol>
            </div>
          </div>
        `;

        // Store fetched files in a global variable for download functions
        window.fetchedProjectFiles = projectFiles;

      } catch (error) {
        console.error('Export project error:', error);
        content.innerHTML = `
          <div class="service-card">
            <h3>‚ùå Failed to Fetch Project Files</h3>
            <p style="margin: 15px 0; color: #666;">
              ${error.message}
            </p>
            <button class="btn btn-primary" onclick="exportProject()">
              üîÑ Try Again
            </button>
          </div>
        `;
      }
    }

    function downloadFileFromContent(filename) {
      if (!window.fetchedProjectFiles || !window.fetchedProjectFiles[filename]) {
        alert('‚ùå File content not available. Please try exporting again.');
        return;
      }

      const content = window.fetchedProjectFiles[filename];
      const blob = new Blob([content], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename.split('/').pop(); // Get just the filename without path
      a.click();
      URL.revokeObjectURL(url);
    }

    async function downloadAllFilesFromGitHub() {
      if (!window.fetchedProjectFiles) {
        alert('‚ùå No files available. Please try exporting again.');
        return;
      }

      // For now, open the GitHub repo URL
      // TODO: Implement ZIP download with JSZip library
      const confirmDownload = confirm(
        `ZIP download is not yet implemented.\n\n` +
        `Would you like to:\n` +
        `‚Ä¢ Download files individually above, OR\n` +
        `‚Ä¢ Clone directly from GitHub?\n\n` +
        `Click OK to open your GitHub repository.`
      );

      if (confirmDownload) {
        window.open(`https://github.com/${githubUsername}/${studentRepoName}`, '_blank');
      }
    }


    // =========================================================================
    // DEBUGGER
    // =========================================================================

    let debuggerVisible = false;
    let debugEvents = [];

    function toggleDebugger() {
      debuggerVisible = !debuggerVisible;

      if (debuggerVisible && !document.querySelector('.debugger-panel')) {
        const panel = document.createElement('div');
        panel.className = 'debugger-panel show';
        panel.id = 'debuggerPanel';
        panel.innerHTML = `
          <div class="debugger-header">üêõ Live Event Debugger</div>
          <div class="event-flow" id="eventFlow">
            <div class="event-item">Debugger started. Events will appear here...</div>
          </div>
          <div style="margin-top: 15px;">
            <button class="btn btn-secondary" onclick="clearDebugger()">Clear Events</button>
            <button class="btn btn-test" onclick="simulateEvent()">Simulate Event</button>
          </div>
        `;
        document.querySelector('.content').prepend(panel);
      } else {
        const panel = document.getElementById('debuggerPanel');
        if (panel) {
          panel.classList.toggle('show');
        }
      }
    }

    function addDebugEvent(type, data) {
      const eventFlow = document.getElementById('eventFlow');
      if (!eventFlow) return;

      const event = document.createElement('div');
      event.className = `event-item ${type}`;
      event.innerHTML = `
        <strong>${new Date().toLocaleTimeString()}</strong> - ${type.toUpperCase()}<br>
        ${JSON.stringify(data, null, 2)}
      `;

      eventFlow.appendChild(event);
      debugEvents.push({ type, data, timestamp: new Date() });

      // Keep only last 20 events
      if (eventFlow.children.length > 20) {
        eventFlow.removeChild(eventFlow.firstChild);
      }
    }

    function clearDebugger() {
      const eventFlow = document.getElementById('eventFlow');
      if (eventFlow) {
        eventFlow.innerHTML = '<div class="event-item">Cleared. Waiting for events...</div>';
      }
      debugEvents = [];
    }

    function simulateEvent() {
      const events = [
        { type: 'start', data: { streamSid: 'MZ' + Math.random().toString(36).substr(2, 9) } },
        { type: 'transcript', data: { text: 'Hello, I am interested in the position' } },
        { type: 'response', data: { text: 'Great! Let me tell you more about it...' } },
        { type: 'stop', data: { reason: 'user_hangup' } }
      ];

      const event = events[Math.floor(Math.random() * events.length)];
      addDebugEvent(event.type, event.data);
    }

    // =========================================================================
    // COST CALCULATOR
    // =========================================================================

    function showCostCalculator() {
      const modal = document.getElementById('costModal');
      const content = document.getElementById('costCalculatorContent');

      content.innerHTML = `
        <div class="cost-widget">
          <h3 style="margin-bottom: 15px;">üí∞ Estimated Costs per Call</h3>

          <div class="form-group">
            <label>Average Call Duration (minutes)</label>
            <input type="number" id="callDuration" value="3" min="1" max="60" onchange="updateCostEstimate()">
          </div>

          <div class="form-group">
            <label>Monthly Call Volume</label>
            <input type="number" id="callVolume" value="1000" min="1" onchange="updateCostEstimate()">
          </div>

          <div class="cost-breakdown" id="costBreakdown"></div>

          <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 6px;">
            <h4>üí° Cost Optimization Tips:</h4>
            <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
              <li>Use ConversationRelay for real-time streaming (more efficient)</li>
              <li>Implement smart interruption handling to reduce wait time</li>
              <li>Cache common responses to reduce OpenAI API calls</li>
              <li>Use GPT-4o-mini instead of GPT-4 for cost savings</li>
            </ul>
          </div>
        </div>
      `;

      modal.classList.add('show');
      updateCostEstimate();
    }

    function updateCostEstimate() {
      const duration = parseFloat(document.getElementById('callDuration')?.value || 3);
      const volume = parseInt(document.getElementById('callVolume')?.value || 1000);

      // Twilio pricing (approximate)
      const twilioVoice = 0.0085 * duration; // $0.0085 per minute
      const twilioStreaming = 0.0040 * duration; // $0.004 per minute for ConversationRelay
      const twilioTranscription = 0.02; // $0.02 per minute

      // OpenAI pricing (GPT-4o-mini approximate)
      const openaiInput = 0.0003; // per 1K tokens, ~500 tokens per call
      const openaiOutput = 0.0006; // per 1K tokens, ~300 tokens per call

      const perCallCost = twilioVoice + twilioStreaming + twilioTranscription + openaiInput + openaiOutput;
      const monthlyCost = perCallCost * volume;
      const annualCost = monthlyCost * 12;

      const breakdown = document.getElementById('costBreakdown');
      if (breakdown) {
        breakdown.innerHTML = `
          <div class="cost-item">
            <span style="font-size: 12px;">Per Call</span>
            <strong>$${perCallCost.toFixed(3)}</strong>
          </div>
          <div class="cost-item">
            <span style="font-size: 12px;">Monthly (${volume} calls)</span>
            <strong>$${monthlyCost.toFixed(2)}</strong>
          </div>
          <div class="cost-item">
            <span style="font-size: 12px;">Annual</span>
            <strong>$${annualCost.toFixed(2)}</strong>
          </div>
          <div class="cost-item">
            <span style="font-size: 12px;">vs. Human ($25/hr)</span>
            <strong>${((25 * duration / 60 * volume * 12) / annualCost).toFixed(1)}x cheaper</strong>
          </div>
        `;
      }
    }

    // =========================================================================
    // HELP & TROUBLESHOOTING
    // =========================================================================

    function showHelp() {
      const modal = document.getElementById('helpModal');
      const content = document.getElementById('helpContent');

      const faqs = [
        {
          q: 'My Twilio credentials are not working',
          a: 'Make sure you\'re using your Account SID (starts with "AC") and Auth Token from the Twilio Console. Check that your account is active and has sufficient balance.'
        },
        {
          q: 'WebSocket connection fails',
          a: 'Verify your WebSocket URL is using wss:// (secure). Check that your Twilio Function is deployed and publicly accessible. Review function logs in Twilio Console.'
        },
        {
          q: 'OpenAI API returns errors',
          a: 'Confirm your API key is valid and starts with "sk-proj-" or "sk-". Check your OpenAI account has available credits. Ensure you\'re using a supported model.'
        },
        {
          q: 'Call connects but no audio',
          a: 'Check ConversationRelay configuration. Verify voice parameter is set correctly. Test with a simple TwiML response first.'
        },
        {
          q: 'How do I debug my code?',
          a: 'Use the built-in Debugger (click üêõ button in toolbar). Check Twilio Function logs in Console. Add console.log() statements in your code.'
        },
        {
          q: 'Can I use this in production?',
          a: 'Yes! Make sure to: 1) Move credentials to environment variables, 2) Enable error handling, 3) Implement rate limiting, 4) Add monitoring/logging, 5) Test thoroughly with real calls.'
        },
        {
          q: 'What are the usage limits?',
          a: 'Twilio has generous limits but check your account tier. OpenAI has rate limits based on your tier. Monitor usage in both consoles to avoid surprises.'
        },
        {
          q: 'How do I add custom functionality?',
          a: 'Use OpenAI function calling to connect to your database or APIs. Implement Sync for conversation state. Add webhooks for events like call recording.'
        },
        {
          q: 'What are the new features (Use Cases, History, VXML)?',
          a: '<strong>üéØ Use Cases:</strong> Browse and activate pre-built templates (Customer Support, Appointment Booking, etc.)<br><br><strong>üí¨ Conversation History:</strong> View all past AI conversations with full transcripts and analytics<br><br><strong>üîÑ VXML Converter:</strong> Upload legacy VoiceXML IVR systems and automatically convert them to AI prompts using GPT-4<br><br><strong>üîó Webhook Tools:</strong> Connect function tools to external APIs by adding webhook_url to your tool definitions'
        }
      ];

      content.innerHTML = `
        <div class="troubleshooting">
          <h3>üîß Common Issues</h3>
          <div style="margin-top: 15px;">
            ${faqs.map((faq, i) => `
              <div class="faq-item" onclick="toggleFaq(${i})">
                <strong>‚ùì ${faq.q}</strong>
                <div class="faq-answer" id="faq${i}">
                  ${faq.a}
                </div>
              </div>
            `).join('')}
          </div>
        </div>

        <div class="service-card" style="margin-top: 20px;">
          <h3>‚ú® Workshop Features</h3>
          <div style="margin: 15px 0; display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <button class="btn btn-primary" onclick="openUseCases()" style="display: flex; align-items: center; justify-content: center; gap: 8px;">
              <span>üéØ</span>
              <span>Browse Use Cases</span>
            </button>
            <button class="btn btn-primary" onclick="openConversationHistory()" style="display: flex; align-items: center; justify-content: center; gap: 8px;">
              <span>üí¨</span>
              <span>View History</span>
            </button>
            <button class="btn btn-primary" onclick="openVXMLConverter()" style="display: flex; align-items: center; justify-content: center; gap: 8px;">
              <span>üîÑ</span>
              <span>Convert VXML</span>
            </button>
            <button class="btn btn-primary" onclick="window.open('/WEBHOOK_TOOLS.md', '_blank')" style="display: flex; align-items: center; justify-content: center; gap: 8px;">
              <span>üîó</span>
              <span>Webhook Docs</span>
            </button>
          </div>
        </div>

        <div class="service-card" style="margin-top: 20px;">
          <h3>üìö Additional Resources</h3>
          <ul style="margin: 15px 0 0 20px; line-height: 2;">
            <li><a href="https://www.twilio.com/docs/voice/twiml/connect/conversationrelay" target="_blank">ConversationRelay Documentation</a></li>
            <li><a href="https://console.twilio.com/us1/monitor/voice-insights" target="_blank">Voice Insights in Console</a></li>
            <li><a href="https://www.twilio.com/console/functions/logs" target="_blank">View Function Logs</a></li>
            <li><a href="https://platform.openai.com/docs" target="_blank">OpenAI Documentation</a></li>
            <li><a href="https://www.twilio.com/support" target="_blank">Contact Twilio Support</a></li>
          </ul>
        </div>

        <div class="service-card" style="margin-top: 20px; background: #e7f5ff;">
          <h3>üí¨ Need More Help?</h3>
          <p style="margin: 10px 0;">Join the Twilio community or contact support:</p>
          <button class="btn btn-primary" onclick="window.open('https://support.twilio.com/hc/en-us/community/topics', '_blank')">
            üåê Twilio Community
          </button>
        </div>
      `;

      modal.classList.add('show');
    }

    function toggleFaq(index) {
      const faq = document.getElementById('faq' + index);
      const item = faq.parentElement;
      item.classList.toggle('open');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('show');
    }

    // ==========================================================================
    // BUG REPORT FUNCTIONS
    // ==========================================================================

    function showBugReportModal() {
      const modal = document.getElementById('bugReportModal');

      // Auto-fill context information
      const stepName = steps[currentStep]?.title || 'Unknown';
      document.getElementById('bugCurrentStep').textContent = `Step ${currentStep + 1}: ${stepName}`;
      document.getElementById('bugPageUrl').textContent = window.location.href;
      document.getElementById('bugBrowserInfo').textContent = navigator.userAgent;

      // Clear previous values
      document.getElementById('bugUserName').value = '';
      document.getElementById('bugDescription').value = '';
      document.getElementById('bugExpectedBehavior').value = '';
      document.getElementById('bugActualBehavior').value = '';
      document.getElementById('bugErrorMessage').value = '';
      document.getElementById('bugReportStatus').innerHTML = '';

      modal.classList.add('show');
    }

    async function submitBugReport() {
      const description = document.getElementById('bugDescription').value.trim();

      if (!description) {
        showStatus('bugReportStatus', 'error', '‚ùå Please describe the issue');
        return;
      }

      // Disable submit button
      const submitBtn = event.target;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="loading" style="border: 3px solid rgba(255,255,255,0.3); border-top-color: white; display: inline-block; width: 16px; height: 16px; margin-right: 8px;"></span> Sending...';

      try {
        const bugData = {
          description: description,
          step: `Step ${currentStep + 1}: ${steps[currentStep]?.title || 'Unknown'}`,
          errorMessage: document.getElementById('bugErrorMessage').value.trim() || null,
          expectedBehavior: document.getElementById('bugExpectedBehavior').value.trim() || null,
          actualBehavior: document.getElementById('bugActualBehavior').value.trim() || null,
          userName: document.getElementById('bugUserName').value.trim() || studentName || null,
          studentEmail: studentEmail || null,
          sessionToken: sessionToken || null,
          browserInfo: navigator.userAgent,
          timestamp: new Date().toISOString(),
          pageUrl: window.location.href,
          callDirection: callDirection || 'Not set',
          deploymentStatus: {
            twilioConnected,
            openaiConnected,
            servicesReady,
            functionsDeployed,
            basicCallTested,
            websocketBuilt,
            conversationRelayCreated
          }
        };

        const response = await fetch('/api/report-bug', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(bugData)
        });

        const result = await response.json();

        if (result.success) {
          showStatus('bugReportStatus', 'success', '‚úÖ ' + result.message);
          // Clear form after successful submission
          setTimeout(() => {
            closeModal('bugReportModal');
          }, 2000);
        } else {
          showStatus('bugReportStatus', 'error', '‚ùå ' + result.error);
          submitBtn.disabled = false;
          submitBtn.innerHTML = 'üì§ Submit Bug Report';
        }
      } catch (error) {
        console.error('Error submitting bug report:', error);
        showStatus('bugReportStatus', 'error', '‚ùå Failed to send bug report. Please try again.');
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'üì§ Submit Bug Report';
      }
    }

    // ==========================================================================
    // FEEDBACK FUNCTIONS
    // ==========================================================================

    let selectedRating = 0;
    let completedStepsCount = 0; // Store numeric count

    function showFeedbackModal() {
      const modal = document.getElementById('feedbackModal');

      // Auto-fill context information (match progress bar calculation)
      completedStepsCount = [
        twilioConnected,
        callDirectionChosen,
        servicesReady,
        basicTwimlCreated,
        websocketBuilt,
        conversationRelayCreated,
        promptEngineeringComplete,
        toolsConfigured,
        projectDeployed
      ].filter(Boolean).length;

      // Update display (but store number in global variable for submission)
      document.getElementById('feedbackCompletedSteps').textContent = `${completedStepsCount} of ${steps.length}`;
      document.getElementById('feedbackTimeSpent').textContent = 'N/A'; // Could track this with timestamps

      // Clear previous inputs
      document.getElementById('feedbackUserName').value = studentName || '';
      document.getElementById('feedbackMessage').value = '';
      selectedRating = 0;

      // Reset rating buttons
      for (let i = 1; i <= 5; i++) {
        const btn = document.getElementById(`rating-${i}`);
        if (btn) {
          btn.style.background = '#f8f9fa';
          btn.style.borderColor = '#e0e0e0';
        }
      }

      modal.classList.add('show');
    }

    function setFeedbackRating(rating) {
      selectedRating = rating;

      // Update button styles
      for (let i = 1; i <= 5; i++) {
        const btn = document.getElementById(`rating-${i}`);
        if (btn) {
          if (i <= rating) {
            btn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            btn.style.borderColor = '#667eea';
            btn.style.color = 'white';
          } else {
            btn.style.background = '#f8f9fa';
            btn.style.borderColor = '#e0e0e0';
            btn.style.color = 'inherit';
          }
        }
      }
    }

    async function submitFeedback() {
      const message = document.getElementById('feedbackMessage').value.trim();

      if (!message) {
        showStatus('feedbackStatus', 'error', '‚ùå Please share your feedback');
        return;
      }

      // Disable submit button
      const submitBtn = event.target;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '‚è≥ Sending...';

      showStatus('feedbackStatus', 'info', 'üì§ Sending feedback...');

      try {
        const feedbackData = {
          name: document.getElementById('feedbackUserName').value.trim(),
          message: message,
          rating: selectedRating,
          completedSteps: completedStepsCount, // Use numeric count instead of text
          timestamp: new Date().toISOString(),
          context: {
            currentStep: currentStep + 1,
            studentDemoMode,
            callDirection,
            step4Committed,
            step5Committed,
            step6Committed,
            step7Committed,
            step8Committed
          }
        };

        const response = await fetch('/api/submit-feedback', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(feedbackData)
        });

        const result = await response.json();

        if (result.success) {
          showStatus('feedbackStatus', 'success', '‚úÖ Thank you for your feedback!');
          // Clear form after successful submission
          setTimeout(() => {
            closeModal('feedbackModal');
          }, 2000);
        } else {
          showStatus('feedbackStatus', 'error', '‚ùå ' + result.error);
          submitBtn.disabled = false;
          submitBtn.innerHTML = 'üì§ Submit Feedback';
        }
      } catch (error) {
        console.error('Error submitting feedback:', error);
        showStatus('feedbackStatus', 'error', '‚ùå Failed to send feedback. Please try again.');
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'üì§ Submit Feedback';
      }
    }

    // Close modal when clicking outside
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('modal')) {
        e.target.classList.remove('show');
      }
    });

    // =========================================================================
    // CONVERSATIONRELAY PLAYGROUND
    // =========================================================================

    // Navigation functions for new features
    function openUseCases() {
      const sessionToken = localStorage.getItem('sessionToken');
      if (!sessionToken) {
        alert('‚ö†Ô∏è Please complete Step 1 (Connect Accounts) first to use this feature.');
        return;
      }
      window.open(`/use-cases.html?sessionToken=${encodeURIComponent(sessionToken)}`, '_blank');
    }

    function openConversationHistory() {
      const sessionToken = localStorage.getItem('sessionToken');
      if (!sessionToken) {
        alert('‚ö†Ô∏è Please complete Step 1 (Connect Accounts) first to use this feature.');
        return;
      }
      window.open(`/conversation-history.html?sessionToken=${encodeURIComponent(sessionToken)}`, '_blank');
    }

    function openVXMLConverter() {
      const sessionToken = localStorage.getItem('sessionToken');
      window.open(`/vxml-converter.html${sessionToken ? '?sessionToken=' + encodeURIComponent(sessionToken) : ''}`, '_blank');
    }

    function openPlayground() {
      // Open in new window
      const playgroundWindow = window.open(
        'https://playground.twilio.world/products/cr',
        'TwilioPlayground',
        'width=1400,height=900,menubar=no,toolbar=no,location=no,status=no'
      );

      if (!playgroundWindow) {
        // Fallback if popup blocked - show embedded iframe
        showPlaygroundModal();
      } else {
        // Show helpful tip about the playground
        setTimeout(() => {
          showStatus('step3Status', 'info',
            'üí° Tip: Use the playground to see how ConversationRelay events flow in real-time. ' +
            'Try clicking through the different scenarios!'
          );
        }, 500);
      }
    }

    function showPlaygroundModal() {
      const modal = document.createElement('div');
      modal.className = 'modal show';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 95%; max-height: 95vh; padding: 0;">
          <div style="background: linear-gradient(135deg, #F22F46 0%, #0d122b 100%); padding: 20px; color: white; display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin: 0; color: white;">üéì What is ConversationRelay?</h2>
            <span class="modal-close" onclick="this.closest('.modal').remove()" style="color: white; cursor: pointer; font-size: 28px;">&times;</span>
          </div>
          <div style="padding: 20px; background: #f8f9fa;">
            <p style="margin-bottom: 15px;">
              <strong>üìö How to use:</strong>
            </p>
            <ul style="margin: 0 0 15px 20px; line-height: 1.8;">
              <li>Click on different components to see how they interact</li>
              <li>Follow the event flow from caller ‚Üí Twilio ‚Üí WebSocket ‚Üí AI</li>
              <li>See example payloads for each event type</li>
              <li>Understand bidirectional streaming in real-time</li>
            </ul>
          </div>
          <iframe
            src="https://playground.twilio.world/products/cr"
            style="width: 100%; height: 70vh; border: none;"
            title="Twilio ConversationRelay Playground"
          ></iframe>
          <div style="padding: 15px; background: #f8f9fa; text-align: center;">
            <button class="btn btn-primary" onclick="window.open('https://playground.twilio.world/products/cr', '_blank')">
              üöÄ Open in Full Window
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      // Close on background click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
        }
      });
    }

    // =========================================================================
    // SHOW SOLUTION
    // =========================================================================

    const solutions = {
      3: `function createConversationRelayTwiML() {
  const twilio = require('twilio');
  const twiml = new twilio.twiml.VoiceResponse();

  const connect = twiml.connect();
  connect.conversationRelay({
    url: '${websocketUrl || 'wss://your-domain.twil.io/tutorial-ws'}',
    voice: 'Polly.Brian',
    language: 'en-US',
    transcriptionProvider: 'twilio',
    ttsProvider: 'amazon'
  });

  return twiml.toString();
}`,
      4: `exports.handler = function(context, event, callback) {
  const twilio = require('twilio');
  const twiml = new twilio.twiml.VoiceResponse();

  // Dial a phone number to connect the call
  const dial = twiml.dial({
    timeout: 30,
    callerId: context.DEFAULT_TWILIO_NUMBER || '+1234567890'
  });
  dial.number('+15555551234');  // Replace with actual number

  // If no answer, say goodbye
  twiml.say('Sorry, no one is available. Goodbye!', { voice: 'Polly.Joanna' });

  callback(null, twiml);
}`,
      6: `exports.handler = function(context, event, callback) {
  const WebSocket = require('ws');
  const OpenAI = require('openai');

  // WebSocket connection handling
  const ws = new WebSocket(event.url);

  ws.on('open', () => {
    console.log('WebSocket connected');
  });

  ws.on('message', async (message) => {
    const data = JSON.parse(message);

    if (data.event === 'start') {
      console.log('Call started:', data.streamSid);
      // Initialize conversation state
    }

    if (data.event === 'transcript') {
      console.log('Transcript:', data.text);

      // Generate AI response
      const response = await generateAIResponse(data.text);

      // Send response back to Twilio
      ws.send(JSON.stringify({
        event: 'text',
        text: response
      }));
    }

    if (data.event === 'stop') {
      console.log('Call ended');
      ws.close();
    }
  });

  callback(null, {});
}`,
      5: `async function generateAIResponse(transcript, conversationHistory) {
  const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

  const messages = [
    {
      role: 'system',
      content: 'You are a helpful recruiting assistant. Be friendly, professional, and concise.'
    },
    ...conversationHistory,
    {
      role: 'user',
      content: transcript
    }
  ];

  const completion = await openai.chat.completions.create({
    model: 'gpt-4o-mini',
    messages: messages,
    temperature: 0.7,
    max_tokens: 150
  });

  return completion.choices[0].message.content;
}`,
      7: `exports.handler = async function(context, event, callback) {
  const response = new Twilio.Response();
  response.setStatusCode(200);
  response.appendHeader('Content-Type', 'text/plain');

  // Check if this is a WebSocket upgrade request
  if (!event.request || !event.request.headers || event.request.headers.upgrade !== 'websocket') {
    response.setBody('This endpoint requires WebSocket connection');
    return callback(null, response);
  }

  // Initialize OpenAI (if available)
  const OpenAI = require('openai');
  const openaiApiKey = context.OPENAI_API_KEY;
  let openai = null;

  if (openaiApiKey) {
    openai = new OpenAI({ apiKey: openaiApiKey });
  } else {
    console.log('‚ö†Ô∏è OpenAI API key not configured - will use placeholder responses');
  }

  // Handle WebSocket connection
  try {
    const ws = event.request;
    console.log('WebSocket connection established');

    ws.on('message', async (data) => {
      try {
        const message = JSON.parse(data);
        console.log('Received message:', message);

        switch (message.event) {
          case 'start':
            console.log('Call started:', message.streamSid || 'test-stream');
            ws.send(JSON.stringify({
              event: 'connected',
              message: 'WebSocket handler ready'
            }));
            break;

          case 'transcript':
            console.log('Transcript received:', message.transcript);

            let aiResponse;

            if (openai) {
              const completion = await openai.chat.completions.create({
                model: 'gpt-4o-mini',
                messages: [{
                  role: 'user',
                  content: message.transcript
                }],
                max_tokens: 150
              });
              aiResponse = completion.choices[0].message.content;
            } else {
              aiResponse = 'I received your message: ' + message.transcript + '. However, OpenAI is not configured yet.';
            }

            console.log('AI response:', aiResponse);
            ws.send(JSON.stringify({
              event: 'text',
              text: aiResponse
            }));
            break;

          case 'stop':
            console.log('Call ended');
            ws.close();
            break;

          default:
            console.log('Unknown event:', message.event);
        }
      } catch (error) {
        console.error('Error processing message:', error);
        ws.send(JSON.stringify({
          event: 'error',
          message: error.message
        }));
      }
    });

    ws.on('error', (error) => {
      console.error('WebSocket error:', error);
    });

    ws.on('close', () => {
      console.log('WebSocket connection closed');
      callback(null, response);
    });

  } catch (error) {
    console.error('Failed to establish WebSocket:', error);
    response.setBody('WebSocket connection failed: ' + error.message);
    return callback(null, response);
  }
}`,
      8: `exports.handler = function(context, event, callback) {
  const twilio = require('twilio');
  const VoiceResponse = twilio.twiml.VoiceResponse;
  const response = new VoiceResponse();

  const connect = response.connect();

  // WebSocket handler URL (hosted on Railway)
  const wsHandlerUrl = '${codespaceUrl || websocketUrl}';

  connect.conversationRelay({
    // Required: WebSocket endpoint URL
    url: wsHandlerUrl,

    // Optional: Initial greeting message
    welcomeGreeting: '${generatedContent?.ivrGreeting || "Hello! I am your AI assistant. How can I help you today?"}',

    // Voice Configuration
    voice: '4YYIPFl9wE5c4L2eu2Gb',  // Bert Reynolds - Charismatic and Smooth
    ttsProvider: 'elevenlabs',       // Options: 'elevenlabs', 'amazon', 'google'

    // Language Settings
    language: 'en-US',               // Default language (or 'multi' for auto-detect)
    // transcriptionLanguage: 'en-US', // Override STT language
    // ttsLanguage: 'en-US',           // Override TTS language

    // Speech Recognition
    transcriptionProvider: 'deepgram', // Options: 'google', 'deepgram'
    // speechModel: 'nova-2',           // Deepgram model (nova-2, enhanced, base)

    // Interruption Control
    interruptible: 'speech',         // Options: 'none', 'dtmf', 'speech', 'any'

    // DTMF (Keypad) Detection
    dtmfDetection: true,             // Enable keypad tone detection

    // Speech Recognition Hints (helps with domain-specific terms)
    // hints: 'Twilio,ConversationRelay,WebSocket,API'
  });

  callback(null, response);
}`
    };

    function showSolution(step) {
      const code = solutions[step];
      if (!code) return;

      if (confirm('Show the solution code? This will replace your current code.')) {
        document.getElementById('code' + step).value = code;
      }
    }

    // =========================================================================
    // PROGRESS BAR UPDATE
    // =========================================================================

    function updateProgressBar() {
      const totalSteps = 9; // All 9 steps in the workshop

      // Count actually completed steps based on checkmarks
      const actuallyCompleted = [
        twilioConnected,
        callDirectionChosen,
        servicesReady,
        basicTwimlCreated,
        websocketBuilt,
        conversationRelayCreated,
        promptEngineeringComplete,
        toolsConfigured,
        projectDeployed
      ].filter(Boolean).length;

      // Debug logging for demo mode
      if (studentDemoMode) {
        console.log('üìä Progress Update (Demo Mode):', {
          currentStep: currentStep + 1,
          actuallyCompleted,
          flags: {
            twilioConnected,
            callDirectionChosen,
            servicesReady,
            basicTwimlCreated,
            websocketBuilt,
            conversationRelayCreated,
            promptEngineeringComplete,
            toolsConfigured,
            projectDeployed
          }
        });
      }

      // Display shows max of (actual completions, current step + 1)
      // This ensures when you're on step 9, it shows "9 of 9" even if not all prior steps completed
      const displayedCompleted = Math.max(actuallyCompleted, currentStep + 1);

      const percentage = Math.round((displayedCompleted / totalSteps) * 100);

      document.getElementById('progressBar').style.width = percentage + '%';
      document.getElementById('progressPercent').textContent = percentage + '%';
      document.getElementById('completedTasks').textContent = `${displayedCompleted} of ${totalSteps} steps completed`;

      // Estimate time remaining based on actual completions
      const avgTimePerStep = 5; // minutes
      const remaining = (totalSteps - actuallyCompleted) * avgTimePerStep;
      if (remaining > 0 && currentStep < totalSteps - 1) {
        document.getElementById('timeEstimate').textContent = `Est. ${remaining}-${remaining + 10} minutes remaining`;
      } else {
        document.getElementById('timeEstimate').textContent = 'üéâ Complete!';
      }
    }

    // Update progress bar whenever state changes

    // =========================================================================
    // CONSOLE INTEGRATION
    // =========================================================================

    function openTwilioConsole(section) {
      const urls = {
        calls: 'https://console.twilio.com/us1/monitor/logs/voice',
        functions: `https://console.twilio.com/us1/develop/functions/editor/${twilioCredentials?.accountSid || ''}`,
        debugger: 'https://console.twilio.com/us1/monitor/debugger'
      };

      window.open(urls[section] || 'https://console.twilio.com', '_blank');
    }

    // Add console links to Step 6
    function addConsoleLinks() {
      return `
        <div class="service-card" style="margin-top: 20px; background: #e7f5ff;">
          <h4>üîç Monitor in Twilio Console</h4>
          <p style="margin: 10px 0;">View live logs and debug your calls:</p>
          <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button class="btn btn-primary" onclick="openTwilioConsole('calls')">üìû Call Logs</button>
            <button class="btn btn-primary" onclick="openTwilioConsole('functions')">‚öôÔ∏è Function Logs</button>
            <button class="btn btn-primary" onclick="openTwilioConsole('debugger')">üêõ Debugger</button>
          </div>
        </div>
      `;
    }

    // =========================================================================
    // OAUTH AUTHENTICATION
    // =========================================================================

    // Check for OAuth callback on page load
    window.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const oauthSession = urlParams.get('session');
      const authSuccess = urlParams.get('auth');

      if (oauthSession && authSuccess === 'success') {
        // Store OAuth session token (separate from workshop sessionToken)
        sessionStorage.setItem('twilioOAuthSession', oauthSession);

        // Clean URL
        window.history.replaceState({}, '', window.location.pathname);

        // Check auth status
        checkOAuthStatus();
      } else {
        // Check for existing OAuth session
        const existingOAuthSession = sessionStorage.getItem('twilioOAuthSession');
        if (existingOAuthSession) {
          checkOAuthStatus();
        }
      }
    });

    // Initiate OAuth login
    async function loginWithTwilio() {
      try {
        showStatus('step1Status', 'info', 'Redirecting to Twilio login...');

        const response = await fetch('/tutorial-oauth-login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'getAuthUrl' })
        });

        const data = await response.json();

        if (data.success) {
          // Store state for CSRF validation
          sessionStorage.setItem('oauthState', data.state);

          // Redirect to Twilio OAuth
          window.location.href = data.authUrl;
        } else {
          showStatus('step1Status', 'error', 'Failed to initiate login: ' + (data.error || 'Unknown error'));
        }

      } catch (error) {
        console.error('Login error:', error);
        showStatus('step1Status', 'error', 'Failed to initiate login. Please try again.');
      }
    }

    // Check OAuth authentication status
    async function checkOAuthStatus() {
      try {
        const oauthSession = sessionStorage.getItem('twilioOAuthSession');
        if (!oauthSession) {
          return; // No OAuth session to check
        }

        const response = await fetch('/tutorial-oauth-login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'checkAuthStatus',
            sessionToken: oauthSession  // Use OAuth session, not workshop session
          })
        });

        const data = await response.json();

        if (data.authenticated) {
          // Show authenticated UI
          document.getElementById('oauthStatus').style.display = 'block';
          document.getElementById('oauthAccountName').textContent =
            data.accountInfo ? data.accountInfo.friendlyName : 'Connected Account';

          // Mark as connected
          setState("twilioConnected", true);
          twilioCredentials = {
            oauthSession: oauthSession,  // Store OAuth session separately
            accountFriendlyName: data.accountInfo?.friendlyName
          };

          showStatus('step1Status', 'success', '‚úÖ Twilio connected via OAuth!');
          checkStep1Complete();

        } else {
          // Clear invalid OAuth session
          sessionStorage.removeItem('twilioOAuthSession');
          document.getElementById('oauthStatus').style.display = 'none';
        }

      } catch (error) {
        console.error('Auth check error:', error);
        sessionStorage.removeItem('twilioOAuthSession');
      }
    }

    // Logout from OAuth
    async function logoutOAuth() {
      try {
        const oauthSession = sessionStorage.getItem('twilioOAuthSession');
        if (oauthSession) {
          await fetch('/tutorial-oauth-login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              action: 'logout',
              sessionToken: oauthSession  // Use OAuth session
            })
          });
        }

      } catch (error) {
        console.error('Logout error:', error);
      } finally {
        // Clear OAuth session (NOT workshop session)
        sessionStorage.removeItem('twilioOAuthSession');
        setState("twilioConnected", false);
        twilioCredentials = null;

        // Hide auth status
        document.getElementById('oauthStatus').style.display = 'none';

        showStatus('step1Status', 'info', 'Logged out. Please reconnect to continue.');
      }
    }

    // =========================================================================
    // DEMO MODE MANAGEMENT
    // =========================================================================

    // Show demo mode banner when demo mode is active
    function updateDemoModeBanner() {
      const banner = document.getElementById('demoModeBanner');
      if (studentDemoMode || twilioCredentials?.demoMode === true) {
        banner.style.display = 'block';
      } else {
        banner.style.display = 'none';
      }
    }

    // Exit demo mode - reset everything
    function exitDemoMode() {
      if (confirm('Exit Demo Mode?\n\nThis will reset all progress and return you to Step 1. Are you sure?')) {
        // Clear all connection state
        twilioCredentials = null;
        setState("twilioConnected", false);
        setState("openaiConnected", false);
        openaiApiKey = null;
        githubToken = null;
        githubUsername = null;
        studentDemoMode = false;

        // Reset to step 1
        currentStep = 0;

        // Clear call direction
        callDirectionChosen = false;
        callDirection = '';

        // Clear services
        servicesReady = false;
        selectedPhoneNumber = null;
        selectedPhoneNumberSid = null;

        // Clear all progress flags
        basicTwimlCreated = false;
        functionsDeployed = false;
        basicCallTested = false;
        websocketBuilt = false;
        conversationRelayCreated = false;
        promptEngineeringComplete = false;
        toolsConfigured = false;
        projectDeployed = false;
        aiCallTested = false;
        step4CodeValidated = false;
        step4Committed = false;
        step5CodeValidated = false;
        step5Deployed = false;
        step6CodeValidated = false;
        step6Deployed = false;
        step8Committed = false;
        syncServiceSkipped = false;
        deployedServiceSid = null;
        deployedEnvironmentSid = null;
        deployedBuildSid = null;

        // Clear all localStorage
        localStorage.removeItem('workshopProgress');
        localStorage.removeItem('workshop_progress');
        localStorage.removeItem('studentDemoMode');
        localStorage.removeItem('demoPurchasedNumber');
        localStorage.removeItem('demoMessagingProvisioned');
        localStorage.removeItem('demoSyncProvisioned');
        localStorage.removeItem('workshopCredentials');
        sessionStorage.clear();

        // Save the cleared state
        saveProgressToStorage();

        // Hide banner
        document.getElementById('demoModeBanner').style.display = 'none';

        // Reset to step 1 and re-render
        renderProgressSteps();
        renderStepContent();
        updateProgressBar();

        // Scroll to top
        window.scrollTo(0, 0);

        celebrate('Demo mode exited. Please connect your credentials to continue.', 'normal');
      }
    }

    // =========================================================================
    // VOICE HANDLER COMMIT (Step 4)
    // =========================================================================

    // Commit voice handler to GitHub
    async function commitVoiceHandlerToGitHub() {
      const code = document.getElementById('code4').value;

      if (!window.studentRepoUrl) {
        showStatus('commitStep4Status', 'error', '‚ùå Please clone the workshop repository first (Step 1a)');
        return;
      }

      showStatus('commitStep4Status', 'info', 'üì§ Pushing voice handler to GitHub...');

      try {
        // In a real implementation, this would use GitHub API to commit the file
        // For now, we'll show instructions
        showStatus('commitStep4Status', 'success',
          `‚úÖ Voice handler ready!<br><br>
          <strong>Next steps:</strong><br>
          1. Your code is saved locally<br>
          2. Push it to your repo: <code style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px;">${window.studentRepoName}/voice-handler.js</code><br>
          3. Deploy your repo to Railway/Render/Heroku<br>
          4. Update your Twilio phone number webhook to point to your deployed URL`
        );

        step4Committed = true;
        document.getElementById('nextBtn4').disabled = false;

      } catch (error) {
        showStatus('commitStep4Status', 'error', '‚ùå Error: ' + error.message);
      }
    }

    // Commit voice handler to Twilio Serverless
    async function commitVoiceHandlerToTwilio() {
      const code = document.getElementById('code4').value;

      if (!twilioCredentials || twilioCredentials.demoMode) {
        showStatus('commitStep4Status', 'error', '‚ùå Please connect your Twilio credentials first');
        return;
      }

      showStatus('commitStep4Status', 'info', 'üöÄ Deploying to Twilio Serverless...');

      try {
        // Use existing commitStep function
        await commitStep(4);

      } catch (error) {
        showStatus('commitStep4Status', 'error', '‚ùå Error: ' + error.message);
      }
    }

    // =========================================================================
    // GITHUB OAUTH & REPOSITORY CLONE
    // =========================================================================

    // Initiate GitHub OAuth flow
    // Sign out of GitHub
    function signOutGitHub() {
      const confirmSignOut = confirm(
        'üö™ Sign Out of GitHub?\n\n' +
        'This will disconnect your GitHub account from the workshop.\n\n' +
        '‚Ä¢ Your workshop progress will be saved\n' +
        '‚Ä¢ Your deployed code will remain in your repository\n' +
        '‚Ä¢ You can sign back in anytime\n\n' +
        'Are you sure you want to sign out?'
      );

      if (confirmSignOut) {
        // Clear GitHub credentials
        githubToken = null;
        githubUsername = null;
        studentRepoName = null;

        // Clear from localStorage
        localStorage.removeItem('github_token');
        localStorage.removeItem('github_username');

        // Save progress (without GitHub credentials)
        saveProgressToStorage();

        // Refresh the UI to show login button
        renderStepContent();

        showStatus('githubCloneStatus', 'info', 'üëã Signed out of GitHub. You can sign back in anytime.');
      }
    }

    async function initiateGitHubOAuth() {
      clearHighlights(); // Remove highlight immediately when clicked
      try {
        const response = await fetch('/api/github-oauth-init', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();

        if (data.success) {
          // Redirect to GitHub authorization
          window.location.href = data.authUrl;
        } else {
          showStatus('githubCloneStatus', 'error', '‚ùå ' + data.error);
        }
      } catch (error) {
        showStatus('githubCloneStatus', 'error', '‚ùå Error: ' + error.message);
      }
    }

    // Clone a new repository (when user already has one but wants a fresh start)
    function cloneNewRepository() {
      const confirmClone = confirm(
        'üì¶ Clone New Repository?\n\n' +
        `You already have a repository: ${studentRepoName}\n\n` +
        'Creating a new repository will:\n' +
        '‚Ä¢ Ask you to choose a different name\n' +
        '‚Ä¢ Keep your existing repository unchanged\n' +
        '‚Ä¢ Switch to using the new repository for future deployments\n\n' +
        'Continue?'
      );

      if (confirmClone) {
        // Clear the current repo name so the clone flow starts fresh
        studentRepoName = null;
        saveProgressToStorage();

        // Trigger the clone flow
        cloneWorkshopRepo();
      }
    }

    /**
     * Show modal to manage (use/delete) workshop repositories
     */
    async function deleteRepository() {
      try {
        showStatus('step1Status', 'info', 'üîç Fetching your workshop repositories...');

        // Get all user repositories
        const response = await fetch('https://api.github.com/user/repos?per_page=100&sort=updated', {
          headers: {
            'Authorization': `Bearer ${githubToken}`,
            'Accept': 'application/vnd.github+json'
          }
        });

        if (!response.ok) {
          throw new Error('Failed to fetch repositories');
        }

        const allRepos = await response.json();

        // Filter for workshop repos - only show repos with workshop naming convention
        const workshopRepos = allRepos.filter(repo => {
          const name = repo.name.toLowerCase();
          // Match repos with workshop naming pattern or conversationrelay starter pack
          return name.includes('workshop') ||
                 name.includes('conversationrelay-starter-pack') ||
                 name.includes('conversationrelay');
        });

        if (workshopRepos.length === 0) {
          showStatus('step1Status', 'info', '‚ÑπÔ∏è No workshop repositories found.');
          return;
        }

        showStatus('step1Status', '', '');
        showManageRepositoriesModal(workshopRepos);

      } catch (error) {
        console.error('Error fetching repositories:', error);
        showStatus('step1Status', 'error', `‚ùå Failed to fetch repositories: ${error.message}`);
      }
    }

    /**
     * Show modal with list of repositories to use or delete
     */
    function showManageRepositoriesModal(repos) {
      const modal = document.createElement('div');
      modal.id = 'manageRepoModal';
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.8); display: flex; align-items: center;
        justify-content: center; z-index: 10000; padding: 20px;
      `;

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; max-width: 700px; width: 100%; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
          <div style="padding: 24px; border-bottom: 1px solid #e0e0e0;">
            <h2 style="margin: 0 0 8px 0; color: #0d122b;">üì¶ Manage Workshop Repositories</h2>
            <p style="margin: 0; color: #666; font-size: 14px;">
              Activate a repository to use it in this workshop, or delete unused ones.
            </p>
          </div>
          <div style="padding: 20px;">
            ${repos.map(repo => `
              <div style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; margin-bottom: 12px; background: ${repo.name === studentRepoName ? '#e8f5e9' : '#f9f9f9'};">
                <div style="display: flex; justify-content: space-between; align-items: start; gap: 12px;">
                  <div style="flex: 1; min-width: 0;">
                    <h4 style="margin: 0 0 4px 0; color: #0d122b; font-size: 16px; word-break: break-word;">
                      ${repo.name}
                      ${repo.name === studentRepoName ? '<span style="color: #4caf50; font-weight: 600; font-size: 13px; margin-left: 8px;">‚úì Active</span>' : ''}
                    </h4>
                    <p style="margin: 0 0 8px 0; color: #666; font-size: 13px;">
                      ${repo.description || 'No description'}
                    </p>
                    <div style="font-size: 12px; color: #999;">
                      Updated: ${new Date(repo.updated_at).toLocaleDateString()}
                    </div>
                  </div>
                  <div style="display: flex; gap: 8px; flex-shrink: 0;">
                    ${repo.name !== studentRepoName ? `
                      <button
                        class="use-repo-btn"
                        data-repo-name="${repo.name}"
                        data-repo-full="${repo.full_name}"
                        style="padding: 8px 16px; background: #4caf50; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; white-space: nowrap;">
                        ‚úì Use
                      </button>
                    ` : ''}
                    <button
                      class="delete-repo-btn"
                      data-repo-name="${repo.full_name}"
                      style="padding: 8px 16px; background: #d32f2f; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; white-space: nowrap;">
                      üóëÔ∏è Delete
                    </button>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
          <div style="padding: 16px 24px; border-top: 1px solid #e0e0e0; display: flex; justify-content: flex-end;">
            <button
              onclick="document.getElementById('manageRepoModal').remove()"
              style="padding: 10px 24px; background: #666; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">
              Close
            </button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);

      // Add click handlers for "Use" buttons
      modal.querySelectorAll('.use-repo-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const repoName = e.target.getAttribute('data-repo-name');
          activateRepository(repoName, modal);
        });
      });

      // Add click handlers for "Delete" buttons
      modal.querySelectorAll('.delete-repo-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const repoFullName = e.target.getAttribute('data-repo-name');
          await confirmAndDeleteRepo(repoFullName, modal);
        });
      });

      // Close modal when clicking outside
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
        }
      });
    }

    /**
     * Activate a repository to use in the workshop
     */
    function activateRepository(repoName, modal) {
      studentRepoName = repoName;
      saveProgressToStorage();

      showStatus('step1Status', 'success', `‚úÖ Now using repository: ${repoName}`);

      modal.remove();
      renderStepContent();

      // Check for existing Codespace for this repo
      checkForExistingCodespace();
    }

    /**
     * Confirm and delete a specific repository
     */
    async function confirmAndDeleteRepo(repoFullName, modal) {
      const confirmDelete = confirm(
        'üóëÔ∏è DELETE REPOSITORY?\n\n' +
        `This will PERMANENTLY DELETE:\n${repoFullName}\n\n` +
        '‚ö†Ô∏è WARNING: This action CANNOT be undone!\n\n' +
        'All code, commits, and history will be lost.\n' +
        'Any Codespaces for this repository will also be deleted.\n\n' +
        'Are you absolutely sure?'
      );

      if (!confirmDelete) {
        return;
      }

      try {
        const btn = modal.querySelector(`[data-repo-name="${repoFullName}"]`);
        btn.disabled = true;
        btn.textContent = 'Deleting...';

        const response = await fetch('/api/github-delete-repo', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            accessToken: githubToken,
            repoFullName: repoFullName
          })
        });

        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Failed to delete repository');
        }

        // If this was the current repo, clear it
        if (repoFullName === `${githubUsername}/${studentRepoName}`) {
          studentRepoName = null;
          codespaceUrl = '';
          codespaceWebUrl = '';
          codespaceName = '';
          websocketUrl = '';
          saveProgressToStorage();
        }

        // Remove the deleted repo from the list
        btn.closest('div[style*="border: 1px solid"]').remove();

        showStatus('step1Status', 'success', `‚úÖ Repository ${repoFullName} deleted successfully.`);

        // If no repos left in modal, close it
        const remainingRepos = modal.querySelectorAll('.delete-repo-btn');
        if (remainingRepos.length === 0) {
          modal.remove();
          renderStepContent();
        }

      } catch (error) {
        console.error('Error deleting repository:', error);
        showStatus('step1Status', 'error', `‚ùå Failed to delete repository: ${error.message}`);

        const btn = modal.querySelector(`[data-repo-name="${repoFullName}"]`);
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'üóëÔ∏è Delete';
        }
      }
    }

    // Show modal to select from existing repositories or create new one
    async function showRepositorySelectionModal(repos) {
      return new Promise((resolve) => {
        const modal = document.createElement('div');
        modal.id = 'repoSelectionModal';
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.9);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 10000;
          animation: fadeIn 0.3s;
        `;

        const repoList = repos.map((repo, index) => `
          <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 2px solid transparent; transition: all 0.2s; position: relative;"
               onmouseover="this.style.borderColor='#4caf50'; this.style.background='#e8f5e9';"
               onmouseout="this.style.borderColor='transparent'; this.style.background='#f8f9fa';">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div style="flex: 1; cursor: pointer;" onclick="selectRepository('${repo.name}')">
                <strong style="color: #0d122b; font-size: 1.05rem;">${repo.name}</strong>
                ${repo.description ? `<p style="color: #666; margin: 5px 0 0 0; font-size: 0.9rem;">${repo.description}</p>` : ''}
                <p style="color: #999; margin: 5px 0 0 0; font-size: 0.85rem;">
                  Updated: ${new Date(repo.updatedAt).toLocaleDateString()}
                </p>
              </div>
              <div style="display: flex; align-items: center; gap: 15px;">
                <div style="color: #4caf50; font-size: 1.2rem; cursor: pointer;" onclick="selectRepository('${repo.name}')">‚Üí</div>
                <button
                  onclick="event.stopPropagation(); deleteRepository('${repo.name}')"
                  style="background: #f44336; color: white; border: none; border-radius: 50%; width: 28px; height: 28px; cursor: pointer; font-size: 16px; line-height: 1; padding: 0; display: flex; align-items: center; justify-content: center; transition: all 0.2s;"
                  onmouseover="this.style.background='#d32f2f'; this.style.transform='scale(1.1)'"
                  onmouseout="this.style.background='#f44336'; this.style.transform='scale(1)'"
                  title="Delete this repository">√ó</button>
              </div>
            </div>
          </div>
        `).join('');

        modal.innerHTML = `
          <div style="background: white; border-radius: 16px; padding: 40px; max-width: 600px; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);">
            <h2 style="color: #0d122b; margin-bottom: 15px; font-size: 1.8rem;">üì¶ Resume or Start Fresh?</h2>
            <p style="color: #666; margin-bottom: 25px; line-height: 1.6;">
              We found ${repos.length} workshop ${repos.length === 1 ? 'repository' : 'repositories'} from your previous sessions.
              <strong>Resume from a previous session</strong> or <strong>start fresh</strong> with a new clone of the starter pack.
            </p>

            ${repos.length > 0 ? `
              <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <strong style="color: #0d122b; font-size: 0.95rem;">üìÇ Your Previous Workshop Sessions:</strong>
              </div>
            ` : ''}

            <div style="margin-bottom: 20px;">
              ${repoList}
            </div>
            <div style="display: flex; gap: 10px; justify-content: space-between; margin-top: 25px;">
              <button onclick="createNewRepositoryFromModal()" style="flex: 1; padding: 12px 24px; background: #2196f3; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 500;">
                ‚ú® Clone Fresh Starter Pack
              </button>
              <button onclick="closeRepoSelectionModal()" style="padding: 12px 24px; background: #e0e0e0; color: #666; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem;">
                Cancel
              </button>
            </div>
          </div>
        `;

        document.body.appendChild(modal);

        // Add global functions for modal buttons
        window.selectRepository = async (repoName) => {
          // Use this repository
          studentRepoName = repoName;
          saveProgressToStorage();

          const selectedRepo = repos.find(r => r.name === repoName);
          if (selectedRepo) {
            showStatus('githubCloneStatus', 'success',
              `‚úÖ Using repository: ${repoName} <a href="${selectedRepo.url}" target="_blank" style="color: #4caf50; text-decoration: underline;">View on GitHub ‚Üí</a>`
            );
          }

          celebrate(`üéâ Repository "${repoName}" connected! You can now deploy your code.`, 'normal');

          // Close modal and re-render
          closeRepoSelectionModal();
          renderStepContent();
          resolve();
        };

        window.createNewRepositoryFromModal = async () => {
          closeRepoSelectionModal();
          await createNewRepository();
          resolve();
        };

        window.closeRepoSelectionModal = () => {
          const modalEl = document.getElementById('repoSelectionModal');
          if (modalEl) {
            modalEl.remove();
          }
          delete window.selectRepository;
          delete window.createNewRepositoryFromModal;
          delete window.closeRepoSelectionModal;
          delete window.deleteRepository;
          resolve();
        };

        window.deleteRepository = async (repoName) => {
          // Show confirmation dialog
          const confirmed = confirm(
            `Delete "${repoName}"?\n\n` +
            `This will permanently delete the repository from your GitHub account.\n` +
            `This action cannot be undone!\n\n` +
            `Are you sure you want to delete this repository?`
          );

          if (!confirmed) {
            return;
          }

          try {
            // Use githubUsername (from authenticated session) as the repo owner
            const repoFullName = `${githubUsername}/${repoName}`;

            console.log(`Deleting repository: ${repoFullName}`);

            // Call GitHub API to delete the repository
            const deleteResponse = await fetch('/api/github-delete-repo', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                accessToken: githubToken,
                repoFullName: repoFullName
              })
            });

            const deleteData = await deleteResponse.json();

            if (deleteData.success) {
              alert(`‚úÖ Repository "${repoName}" deleted successfully!`);

              // Refresh the modal to show updated repo list
              closeRepoSelectionModal();
              await cloneWorkshopRepo(); // This will show the modal again with updated list
            } else {
              throw new Error(deleteData.error || 'Failed to delete repository');
            }
          } catch (error) {
            console.error('Delete error:', error);
            alert(`‚ùå Failed to delete repository: ${error.message}`);
          }
        };
      });
    }

    // Create a new repository (prompts for name)
    async function createNewRepository() {
      showStatus('githubCloneStatus', 'info', 'üì¶ Creating your workshop repository...');

      try {
        // Create repository with session-based unique name
        // API will generate: ws-{timestamp}-{random}-voice-ai
        const createResponse = await fetch('/api/github-create-repo', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            accessToken: githubToken,
            githubUsername: githubUsername,
            // Don't send repoName - let API generate from sessionToken
            sessionToken: sessionToken
          })
        });

        const createData = await createResponse.json();

        if (createData.success) {
          showStatus('githubCloneStatus', 'success',
            `‚úÖ Repository created! <a href="${createData.repoUrl}" target="_blank" style="color: #4caf50; text-decoration: underline;">View on GitHub ‚Üí</a>`
          );

          studentRepoName = createData.repoName;
          saveProgressToStorage();

          celebrate('üéâ Repository created successfully! You can now deploy your code.', 'normal');

          // Re-render to show next steps (Codespace deployment)
          renderStepContent();
        } else {
          showStatus('githubCloneStatus', 'error', '‚ùå ' + createData.error);
        }
      } catch (error) {
        showStatus('githubCloneStatus', 'error', '‚ùå Error creating repository: ' + error.message);
      }
    }

    // Clone workshop repository to student's GitHub account
    async function cloneWorkshopRepo() {
      clearHighlights(); // Remove highlight immediately when clicked
      if (!githubToken || !githubUsername) {
        showStatus('githubCloneStatus', 'error', '‚ùå Please login with GitHub first');
        return;
      }

      // First, list all workshop-related repositories
      showStatus('githubCloneStatus', 'info', 'üîç Checking for existing repositories...');

      try {
        const listResponse = await fetch('/api/github-list-repos', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            accessToken: githubToken,
            githubUsername: githubUsername
          })
        });

        const listData = await listResponse.json();

        if (listData.success && listData.repos && listData.repos.length > 0) {
          // User has existing workshop repositories - show selection modal
          await showRepositorySelectionModal(listData.repos);
          return;
        }

        // No existing repos found - create one with session-based unique name
        // The API will use sessionToken to generate: ws-{timestamp}-{random}-voice-ai
        showStatus('githubCloneStatus', 'info', 'üì¶ Creating your workshop repository...');

        const response = await fetch('/api/github-create-repo', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            accessToken: githubToken,
            githubUsername: githubUsername,
            // Don't send repoName - let API generate from sessionToken
            sessionToken: sessionToken
          })
        });

        const data = await response.json();

        if (data.success) {
          showStatus('githubCloneStatus', 'success',
            `‚úÖ Repository created! <a href="${data.repoUrl}" target="_blank" style="color: #4caf50; text-decoration: underline;">View on GitHub ‚Üí</a>`
          );

          // Store repo name and URL for later commits
          studentRepoName = data.repoName;
          saveProgressToStorage();

          celebrate('üéâ Repository created successfully! You can now deploy your code.', 'normal');

          // Re-render to show next steps (Codespace deployment)
          renderStepContent();
        } else {
          // Check if it's a name conflict error (unlikely with session-based names, but handle it)
          if (data.error && data.error.includes('already exists')) {
            // Repository exists (race condition) - prompt for custom name with retry logic
            let customName = '';
            let createSuccess = false;

            while (!createSuccess) {
              customName = prompt(
                `‚ö†Ô∏è Repository name conflict (rare!).\n\n` +
                `Enter a different name for your repository:\n\n` +
                `Suggested names:\n` +
                `‚Ä¢ twilio-voice-ai-workshop-2\n` +
                `‚Ä¢ my-voice-ai-app\n` +
                `‚Ä¢ conversationrelay-demo`,
                'twilio-voice-ai-workshop-2'
              );

              if (!customName || customName.trim() === '') {
                showStatus('githubCloneStatus', 'info', 'Repository creation cancelled.');
                return;
              }

              // Try creating with the custom name
              const cleanName = customName.trim().toLowerCase().replace(/[^a-z0-9-_]/g, '-');
              showStatus('githubCloneStatus', 'info', `üì¶ Creating repository: ${cleanName}...`);

              const retryResponse = await fetch('/api/github-create-repo', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  accessToken: githubToken,
                  githubUsername: githubUsername,
                  repoName: cleanName,
                  sessionToken: sessionToken
                })
              });

              const retryData = await retryResponse.json();

              if (retryData.success) {
                showStatus('githubCloneStatus', 'success',
                  `‚úÖ Repository created! <a href="${retryData.repoUrl}" target="_blank" style="color: #4caf50; text-decoration: underline;">View on GitHub ‚Üí</a>`
                );

                studentRepoName = retryData.repoName || cleanName;
                saveProgressToStorage();

                celebrate('üéâ Repository created successfully! You can now deploy your code.', 'normal');

                // Re-render to show next steps (Codespace deployment)
                renderStepContent();
                createSuccess = true;
              } else {
                // Check if it's another name conflict
                if (retryData.error && retryData.error.includes('already exists')) {
                  const retry = confirm(
                    `‚ö†Ô∏è Repository name "${cleanName}" also already exists.\n\n` +
                    `Would you like to try a different name?\n\n` +
                    `‚Ä¢ Click OK to enter a new name\n` +
                    `‚Ä¢ Click Cancel to stop`
                  );

                  if (!retry) {
                    showStatus('githubCloneStatus', 'info', 'Repository creation cancelled.');
                    return;
                  }
                  // Loop continues to prompt again
                } else {
                  // Other error - show and exit
                  showStatus('githubCloneStatus', 'error', '‚ùå ' + retryData.error);
                  return;
                }
              }
            }
          } else {
            // Other error - just show it
            showStatus('githubCloneStatus', 'error', '‚ùå ' + data.error);
          }
        }
      } catch (error) {
        showStatus('githubCloneStatus', 'error', '‚ùå Error: ' + error.message);
      }
    }

    // =========================================================================
    // GITHUB CODESPACES DEPLOYMENT
    // =========================================================================

    /**
     * Check if a Codespace already exists for the student's repository
     * Called on page load to auto-detect existing Codespaces
     */
    /**
     * Check GitHub Codespaces usage/billing to show remaining hours
     */
    async function checkCodespacesUsage() {
      if (!githubToken || !githubUsername) {
        return;
      }

      try {
        // Fetch billing info from GitHub API
        const response = await fetch(`https://api.github.com/users/${githubUsername}/settings/billing/shared-storage`, {
          headers: {
            'Authorization': `Bearer ${githubToken}`,
            'Accept': 'application/vnd.github+json'
          }
        });

        if (!response.ok) {
          console.log('Unable to fetch Codespaces usage (may require additional permissions)');
          return;
        }

        const billingData = await response.json();

        // GitHub provides free tier: 120 core-hours/month (60 hours for 2-core)
        // Paid usage beyond that
        const includedMinutes = billingData.included_minutes || 3600; // 60 hours = 3600 minutes for 2-core
        const usedMinutes = billingData.total_minutes_used || 0;
        const remainingMinutes = Math.max(0, includedMinutes - usedMinutes);
        const remainingHours = Math.floor(remainingMinutes / 60);
        const remainingMins = remainingMinutes % 60;

        // Calculate percentage
        const usagePercent = includedMinutes > 0 ? Math.round((usedMinutes / includedMinutes) * 100) : 0;

        // Display usage info
        const usageEl = document.getElementById('codespacesUsageInfo');
        if (usageEl) {
          let color = '#98c379'; // Green
          let icon = '‚úÖ';

          if (usagePercent > 80) {
            color = '#e06c75'; // Red
            icon = '‚ö†Ô∏è';
          } else if (usagePercent > 50) {
            color = '#e5c07b'; // Yellow
            icon = '‚è∞';
          }

          usageEl.innerHTML = `
            <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; font-size: 12px;">
              <div style="color: ${color}; font-weight: 600; margin-bottom: 5px;">
                ${icon} Codespaces Usage This Month
              </div>
              <div style="color: rgba(255,255,255,0.9);">
                ${remainingHours}h ${remainingMins}m remaining of ${Math.floor(includedMinutes / 60)}h free tier
              </div>
              <div style="background: rgba(255,255,255,0.2); height: 6px; border-radius: 3px; margin-top: 8px; overflow: hidden;">
                <div style="background: ${color}; height: 100%; width: ${usagePercent}%; transition: width 0.3s;"></div>
              </div>
            </div>
          `;
        }
      } catch (error) {
        console.log('Could not fetch Codespaces usage:', error.message);
        // Don't show error to user - this is optional info
      }
    }

    async function checkForExistingCodespace() {
      if (!githubToken || !githubUsername || !studentRepoName) {
        return;
      }

      try {
        console.log(`üîç Checking for existing Codespace for ${githubUsername}/${studentRepoName}...`);

        const response = await fetch('/api/github-get-codespace', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            accessToken: githubToken,
            repoFullName: `${githubUsername}/${studentRepoName}`
          })
        });

        const data = await response.json();

        if (data.success && data.codespace) {
          console.log(`‚úÖ Found existing Codespace: ${data.codespace.name} (${data.codespace.state})`);

          // Save Codespace info
          codespaceName = data.codespace.name;
          codespaceWebUrl = data.codespace.webUrl;

          // If Codespace is Available, get the WebSocket URL
          if (data.codespace.state === 'Available' && data.codespace.websocketUrl) {
            codespaceUrl = data.codespace.websocketUrl;
            websocketUrl = codespaceUrl;

            // Mark Step 5 as deployed since Codespace is running with WebSocket server
            step5Deployed = true;
            websocketBuilt = true;

            console.log(`‚úÖ Codespace is running with WebSocket URL: ${codespaceUrl}`);
          } else {
            console.log(`‚ÑπÔ∏è Codespace exists but is ${data.codespace.state}`);
          }

          // Save to storage and re-render
          saveProgressToStorage();
          updateProgressBar();
          renderStepContent();
        } else {
          console.log('‚ÑπÔ∏è No existing Codespace found');
        }
      } catch (error) {
        console.error('Error checking for existing Codespace:', error);
        // Don't show error to user - this is a background check
      }
    }

    /**
     * Simulate Codespace deployment for Step 5 in demo mode
     */
    async function simulateCodespaceDeployment() {
      clearHighlights(); // Remove highlight immediately when clicked
      const btn = document.getElementById('deployCodespaceBtn5');
      const statusEl = document.getElementById('codespaceDeployStatus5');

      if (btn) {
        btn.disabled = true;
        btn.textContent = 'üöÄ Deploying...';
      }

      if (statusEl) statusEl.innerHTML = '<div style="color: #4fc1ff;">üì° Creating your WebSocket endpoint...</div>';

      await new Promise(resolve => setTimeout(resolve, 800));
      if (statusEl) statusEl.innerHTML = '<div style="color: #4fc1ff;">üîê Connecting to your OpenAI key...</div>';

      await new Promise(resolve => setTimeout(resolve, 800));
      if (statusEl) statusEl.innerHTML = '<div style="color: #4fc1ff;">‚ú® Configuring your AI settings...</div>';

      await new Promise(resolve => setTimeout(resolve, 800));

      // Set demo WebSocket URL
      if (!websocketUrl) {
        websocketUrl = `wss://demo-websocket-${sessionToken.substring(3, 8)}.railway.app/ws/${sessionToken}`;
      }

      step5Deployed = true;
      websocketBuilt = true;

      saveProgressToStorage();
      updateProgressBar();

      if (statusEl) {
        statusEl.innerHTML = `
          <div style="color: #98c379;">
            ‚úÖ Your WebSocket server is live! (Demo)<br>
            <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px; margin-top: 10px; font-family: monospace; font-size: 12px; word-break: break-all;">
              ${websocketUrl}
            </div>
            <div style="margin-top: 10px; font-size: 13px; color: rgba(255,255,255,0.8);">
              üìù In demo mode - your personalized endpoint is simulated
            </div>
          </div>
        `;
      }

      if (btn) {
        btn.style.display = 'none';
      }

      // Enable Next button and add next-action effect
      const nextBtn = document.getElementById('nextBtn7');
      if (nextBtn) {
        nextBtn.disabled = false;
        nextBtn.classList.add('next-action');
      }

      renderStepContent();
    }

    /**
     * Deploy WebSocket Server (Live Mode)
     * Creates personalized endpoint on shared Railway server
     */
    async function deployLiveWebSocketServer() {
      clearHighlights(); // Remove highlight immediately when clicked
      const btn = document.getElementById('deployCodespaceBtn5');
      const statusEl = document.getElementById('codespaceDeployStatus5');

      if (btn) {
        btn.disabled = true;
        btn.textContent = 'üöÄ Deploying...';
      }

      if (statusEl) statusEl.innerHTML = '<div style="color: #4fc1ff;">üì° Creating your WebSocket endpoint...</div>';

      await new Promise(resolve => setTimeout(resolve, 800));
      if (statusEl) statusEl.innerHTML = '<div style="color: #4fc1ff;">üîê Connecting to your OpenAI key...</div>';

      await new Promise(resolve => setTimeout(resolve, 800));
      if (statusEl) statusEl.innerHTML = '<div style="color: #4fc1ff;">‚ú® Configuring your AI settings...</div>';

      await new Promise(resolve => setTimeout(resolve, 800));

      // Mark as deployed
      step5Deployed = true;
      websocketBuilt = true;
      websocketUrl = `wss://workshop-websocket-server-production.up.railway.app/ws/${sessionToken}`;

      saveProgressToStorage();
      updateProgressBar();

      if (statusEl) {
        statusEl.innerHTML = `
          <div style="color: #98c379;">
            ‚úÖ Your WebSocket server is live!<br>
            <div style="margin-top: 10px; font-size: 13px; color: rgba(255,255,255,0.9);">
              Your personalized endpoint is ready. Click "Test My WebSocket Server" above to verify it works!
            </div>
          </div>
        `;
      }

      // Hide pre-deploy section and show post-deploy section
      const preDeploySection = document.getElementById('step5PreDeploySection');
      if (preDeploySection) preDeploySection.style.display = 'none';

      const postDeploySection = document.getElementById('step5PostDeploySection');
      if (postDeploySection) postDeploySection.style.display = 'block';

      // Move next-action to test button
      const testBtn = postDeploySection?.querySelector('button');
      if (testBtn) testBtn.classList.add('next-action');

      renderStepContent();
    }

    /**
     * Delete existing Codespace and create a new one
     */
    async function deleteAndRecreateCodespace() {
      if (!confirm('‚ö†Ô∏è This will delete your current Codespace and create a new one with the latest template.\n\nAny unsaved changes in the Codespace will be lost.\n\nContinue?')) {
        return;
      }

      try {
        // Clear current Codespace data
        codespaceUrl = '';
        codespaceWebUrl = '';
        codespaceName = '';
        websocketUrl = '';
        saveProgressToStorage();

        showStatus('codespaceDeployStatus', 'info', 'üóëÔ∏è Preparing to recreate Codespace...');
        renderStepContent();

        // Wait a moment for UI to update
        await new Promise(resolve => setTimeout(resolve, 1000));

        // Create new Codespace
        await deployToCodespaces();
      } catch (error) {
        showStatus('codespaceDeployStatus', 'error', '‚ùå Error: ' + error.message);
      }
    }

    /**
     * Deploy student repository to GitHub Codespaces
     * Creates a cloud development environment with WebSocket server
     */
    async function deployToCodespaces() {
      clearHighlights(); // Remove highlight immediately when clicked
      const btn = document.getElementById('deployCodespaceBtn');
      const statusEl = document.getElementById('codespaceDeployStatus');

      // Demo mode simulation
      if (studentDemoMode || twilioCredentials?.demoMode) {
        btn.disabled = true;
        btn.textContent = 'üöÄ Launching Codespace...';

        showStatus('codespaceDeployStatus', 'info', 'üì¶ Demo: Creating your cloud development environment...');

        await new Promise(resolve => setTimeout(resolve, 1500));
        showStatus('codespaceDeployStatus', 'info', '‚öôÔ∏è Demo: Installing dependencies...');

        await new Promise(resolve => setTimeout(resolve, 1500));
        showStatus('codespaceDeployStatus', 'info', 'üöÄ Demo: Starting WebSocket server...');

        await new Promise(resolve => setTimeout(resolve, 1000));

        // Set demo Codespace info
        codespaceUrl = 'wss://demo-codespace-3000.app.github.dev';
        codespaceWebUrl = 'https://github.com/codespaces/demo-codespace';
        codespaceName = 'demo-codespace-12345';
        websocketUrl = codespaceUrl;
        step5Deployed = true;
        websocketBuilt = true;

        saveProgressToStorage();
        updateProgressBar();

        showStatus('codespaceDeployStatus', 'success',
          `‚úÖ Demo: Codespace is running!<br>` +
          `<div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px; margin-top: 10px; font-family: monospace; font-size: 12px; word-break: break-all;">${codespaceUrl}</div>`
        );

        btn.disabled = false;
        btn.textContent = 'üöÄ Launch Development Environment';
        renderStepContent();
        return;
      }

      if (!githubToken || !githubUsername || !studentRepoName) {
        showStatus('codespaceDeployStatus', 'error', '‚ùå Missing GitHub credentials or repository');
        return;
      }

      try {
        btn.disabled = true;
        btn.textContent = 'üöÄ Launching Codespace...';

        const repoFullName = `${githubUsername}/${studentRepoName}`;

        // First, check for existing Codespace
        showStatus('codespaceDeployStatus', 'info', 'üîç Checking for existing Codespace...');

        const checkResponse = await fetch('/api/github-get-codespace', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            accessToken: githubToken,
            repoFullName: repoFullName,
            githubUsername: githubUsername
          })
        });

        const checkData = await checkResponse.json();

        // If Codespace exists
        if (checkData.success && checkData.codespace) {
          codespaceName = checkData.codespace.name;
          codespaceWebUrl = checkData.codespace.webUrl;

          // If it's already available, use it
          if (checkData.codespace.state === 'Available') {
            codespaceUrl = checkData.codespace.websocketUrl;
            websocketUrl = codespaceUrl;
            step5Deployed = true;
            websocketBuilt = true;

            saveProgressToStorage();
            updateProgressBar();

            showStatus('codespaceDeployStatus', 'success',
              `‚úÖ Found existing Codespace (already running)!<br>` +
              `<div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px; margin-top: 10px; font-family: monospace; font-size: 12px; word-break: break-all;">${codespaceUrl}</div>` +
              `<a href="${codespaceWebUrl}" target="_blank" style="color: #4fc1ff; margin-top: 10px; display: inline-block;">Open in Browser ‚Üí</a>`
            );

            btn.disabled = false;
            btn.textContent = '‚úÖ Codespace Running';
            renderStepContent();
            return;
          }

          // Codespace exists but is not running - start it!
          if (checkData.codespace.state === 'Shutdown' || checkData.codespace.state === 'Unavailable') {
            showStatus('codespaceDeployStatus', 'info', `üîÑ Starting existing Codespace (was ${checkData.codespace.state})...`);

            const startResponse = await fetch('/api/github-start-codespace', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                accessToken: githubToken,
                codespaceName: codespaceName
              })
            });

            const startData = await startResponse.json();

            if (!startData.success) {
              throw new Error(startData.error || 'Failed to start Codespace');
            }

            showStatus('codespaceDeployStatus', 'info', '‚è≥ Waiting for Codespace to start and server to be ready...');

            // Poll for it to become available
            await pollCodespaceStatus();
            return;
          }

          // Codespace is starting - just poll for it
          if (checkData.codespace.state === 'Starting') {
            showStatus('codespaceDeployStatus', 'info', '‚è≥ Codespace is starting... waiting for server to be ready...');
            await pollCodespaceStatus();
            return;
          }
        }

        // No existing Codespace found, create new one
        showStatus('codespaceDeployStatus', 'info', 'üì¶ Creating your cloud development environment...');

        // Create the Codespace
        const response = await fetch('/api/github-create-codespace', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            accessToken: githubToken,
            repoFullName: repoFullName,
            githubUsername: githubUsername
          })
        });

        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Failed to create Codespace');
        }

        codespaceName = data.codespace.name;
        codespaceWebUrl = data.codespace.webUrl;

        showStatus('codespaceDeployStatus', 'success',
          `‚úÖ Codespace created! Waiting for server to start...<br>` +
          `<span style="font-size: 12px; opacity: 0.8;">This usually takes 30-60 seconds</span>`
        );

        // Poll for Codespace to become available
        await pollCodespaceStatus();

      } catch (error) {
        console.error('Codespace deployment error:', error);

        // Check for specific error types and provide helpful messages
        let errorMessage = error.message;

        if (errorMessage.includes('too many codespaces') || errorMessage.includes('codespace limit')) {
          errorMessage = `
            <strong>‚ö†Ô∏è Too many Codespaces running!</strong><br><br>
            You've hit GitHub's Codespace limit. Please stop some unused Codespaces:<br><br>
            <strong>How to stop Codespaces:</strong><br>
            1. Go to <a href="https://github.com/codespaces" target="_blank" style="color: #4fc3f7;">github.com/codespaces</a><br>
            2. Find old/unused workshop Codespaces<br>
            3. Click the "..." menu and select "Stop codespace"<br>
            4. Come back here and try again<br><br>
            üí° <strong>Tip:</strong> You only need ONE Codespace running at a time for this workshop!
          `;
        }

        showStatus('codespaceDeployStatus', 'error', '‚ùå ' + errorMessage);
        btn.disabled = false;
        btn.textContent = 'üöÄ Launch Codespace with WebSocket Server';
      }
    }

    /**
     * Poll Codespace status until it's available and get the WebSocket URL
     */
    async function pollCodespaceStatus() {
      const maxAttempts = 40; // 40 attempts = up to 3.3 minutes max (extra time for server startup)
      let attempts = 0;
      let healthCheckAttempts = 0;
      let portFixAttempted = false; // Track if we've tried fixing the port

      const poll = async () => {
        attempts++;

        try {
          const response = await fetch('/api/github-get-codespace', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              accessToken: githubToken,
              codespaceName: codespaceName,
              repoFullName: `${githubUsername}/${studentRepoName}`
            })
          });

          const data = await response.json();

          if (!data.success) {
            throw new Error(data.error || 'Failed to get Codespace status');
          }

          const state = data.codespace.state;
          console.log(`Codespace state: ${state} (attempt ${attempts}/${maxAttempts})`);

          if (state === 'Available') {
            // Codespace is ready - but verify server is responding
            codespaceUrl = data.codespace.websocketUrl;
            codespaceWebUrl = data.codespace.webUrl;
            const httpUrl = data.codespace.httpUrl;

            // Test if WebSocket server is actually reachable
            healthCheckAttempts++;
            const healthCheckDuration = Math.round(healthCheckAttempts * 5);

            showStatus('codespaceDeployStatus', 'info',
              `‚è≥ Testing WebSocket connection... (${healthCheckDuration}s)<br>` +
              `<span style="font-size: 12px; opacity: 0.8;">Connecting to: ${codespaceUrl}</span>`
            );

            // Test WebSocket connection directly (skip HTTP health check to avoid CORS issues)
            try {
              // Test WebSocket connection
              const wsTestResult = await new Promise((resolve, reject) => {
                  const timeout = setTimeout(() => {
                    ws.close();
                    reject(new Error('WebSocket connection timeout'));
                  }, 5000);

                  const ws = new WebSocket(codespaceUrl);

                  ws.onopen = () => {
                    clearTimeout(timeout);
                    console.log('‚úÖ WebSocket connected successfully!');
                    ws.close();
                    resolve(true);
                  };

                  ws.onerror = (error) => {
                    clearTimeout(timeout);
                    console.log('‚ùå WebSocket connection failed:', error);
                    reject(new Error('WebSocket connection failed'));
                  };

                  ws.onclose = (event) => {
                    if (!event.wasClean) {
                      clearTimeout(timeout);
                      reject(new Error(`WebSocket closed unexpectedly: ${event.code}`));
                    }
                  };
                });

                // WebSocket connection successful!
                websocketUrl = codespaceUrl;
                step5Deployed = true;
                websocketBuilt = true;

                // Save to localStorage
                saveProgressToStorage();

                showStatus('codespaceDeployStatus', 'success',
                  `‚úÖ WebSocket server is ready and verified!<br>` +
                  `<div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 6px; margin-top: 10px; font-family: monospace; font-size: 12px; word-break: break-all;">${codespaceUrl}</div>` +
                  `<a href="${codespaceWebUrl}" target="_blank" style="color: white; text-decoration: underline; margin-top: 10px; display: inline-block;">üåê Open Codespace ‚Üí</a><br>` +
                  `<span style="font-size: 12px; opacity: 0.8; margin-top: 10px; display: block;">‚úì WebSocket test passed after ${healthCheckDuration} seconds</span>`
                );

                celebrate('üéâ Your development environment is ready!', 'normal');
                renderStepContent(); // Refresh to show the Codespace URL

                // Add next-action effect to Connect Twilio button after codespace deploys
                setTimeout(() => {
                  const connectTwilioBtn = document.querySelector('[onclick*="connectTwilio"]');
                  if (connectTwilioBtn && !twilioConnected) {
                    connectTwilioBtn.classList.add('next-action');
                  }
                }, 500);
                return; // Exit polling
              } catch (wsError) {
                console.log(`WebSocket test failed:`, wsError.message);

                // Auto-fix attempt: If WebSocket fails and we haven't tried fixing yet
                if (!portFixAttempted && healthCheckAttempts >= 3) {
                  portFixAttempted = true;
                  console.log('üîß Attempting automatic port fix...');

                  showStatus('codespaceDeployStatus', 'info',
                    `üîß WebSocket connection failed. Attempting automatic fix...<br>` +
                    `<span style="font-size: 12px; opacity: 0.8;">Setting port 3000 to public visibility...</span>`
                  );

                  try {
                    const fixResponse = await fetch('/api/github-fix-codespace-port', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({
                        accessToken: githubToken,
                        codespaceName: codespaceName
                      })
                    });

                    const fixData = await fixResponse.json();

                    if (fixData.success) {
                      console.log('‚úÖ Port fix applied successfully');
                      showStatus('codespaceDeployStatus', 'success',
                        `‚úÖ Port visibility fixed! Testing connection again...<br>` +
                        `<span style="font-size: 12px; opacity: 0.8;">Waiting 15 seconds for changes to take effect...</span>`
                      );

                      // Wait 15 seconds for port changes to propagate, then continue polling
                      await new Promise(resolve => setTimeout(resolve, 15000));
                      setTimeout(poll, 2000);
                      return;
                    } else {
                      console.log('‚ö†Ô∏è Port fix failed:', fixData.error);
                    }
                  } catch (fixError) {
                    console.log('‚ö†Ô∏è Port fix error:', fixError.message);
                  }
                }

                // Health check failed - server may still be starting
                // Continue polling for a bit longer
                if (attempts < maxAttempts) {
                  showStatus('codespaceDeployStatus', 'info',
                    `‚è≥ Waiting for WebSocket server to start... (${healthCheckDuration}s)<br>` +
                    `<span style="font-size: 12px; opacity: 0.8;">The server auto-starts on Codespace launch. This can take up to 2 minutes.</span>`
                  );
                  setTimeout(poll, 5000);
                } else {
                  // Timeout - DO NOT allow progression, server must be reachable
                  const btn = document.getElementById('deployCodespaceBtn5');
                  if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'üîÑ Retry Launch';
                  }

                  showStatus('codespaceDeployStatus', 'error',
                    `‚ùå WebSocket connection is not working.<br><br>` +
                    `<strong>Don't worry - this is fixable!</strong><br><br>` +
                    `<button class="btn btn-primary" onclick="fixCodespaceConnection()" style="width: 100%; padding: 15px; font-size: 16px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); margin-bottom: 15px;">` +
                    `üîß Fix Connection (One Click)` +
                    `</button>` +
                    `<details style="margin-top: 10px;">` +
                    `<summary style="cursor: pointer; color: rgba(255,255,255,0.7); font-size: 13px;">Advanced troubleshooting</summary>` +
                    `<div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 6px; margin-top: 10px; font-size: 12px;">` +
                    `<strong>Manual steps:</strong><br>` +
                    `1. <a href="${codespaceWebUrl}" target="_blank" style="color: #4fc1ff;">Open Codespace ‚Üí</a><br>` +
                    `2. Go to PORTS tab (bottom panel)<br>` +
                    `3. Find port 3000, right-click ‚Üí Port Visibility ‚Üí Public<br>` +
                    `4. Come back and click "Fix Connection" above<br>` +
                    `</div>` +
                    `</details>`
                  );

                  // Do NOT set step5Deployed or websocketBuilt - block progression
                  console.error('WebSocket server health check failed after timeout');
                }
              } // End of catch(wsError)

          } else if (state === 'Starting' || state === 'Created' || state === 'Provisioning') {
            // Still starting, continue polling
            showStatus('codespaceDeployStatus', 'info',
              `‚è≥ Server starting... (${Math.round(attempts * 5)} seconds)<br>` +
              `<span style="font-size: 12px; opacity: 0.8;">Status: ${state}</span>`
            );

            if (attempts < maxAttempts) {
              setTimeout(poll, 5000); // Poll every 5 seconds
            } else {
              throw new Error('Codespace took too long to start. Please try refreshing.');
            }

          } else {
            // Unknown or error state
            throw new Error(`Unexpected Codespace state: ${state}`);
          }

        } catch (error) {
          console.error('Error polling Codespace:', error);
          showStatus('codespaceDeployStatus', 'error', '‚ùå ' + error.message);
        }
      };

      // Start polling
      poll();
    }

    /**
     * Refresh Codespace status (if user returns later and Codespace stopped)
     */
    async function refreshCodespaceStatus() {
      try {
        showStatus('codespaceDeployStatus', 'info', 'üîÑ Checking Codespace status...');

        const response = await fetch('/api/github-get-codespace', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            accessToken: githubToken,
            codespaceName: codespaceName,
            repoFullName: `${githubUsername}/${studentRepoName}`
          })
        });

        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Failed to get Codespace status');
        }

        if (data.codespace.state === 'Available') {
          codespaceUrl = data.codespace.websocketUrl;
          codespaceWebUrl = data.codespace.webUrl;
          codespaceName = data.codespace.name;
          websocketUrl = codespaceUrl;

          // Mark Step 5 as deployed since Codespace is running with WebSocket server
          step5Deployed = true;
          websocketBuilt = true;

          saveProgressToStorage();
          updateProgressBar();

          showStatus('codespaceDeployStatus', 'success', '‚úÖ Codespace is running! WebSocket server detected.');
          renderStepContent();
        } else if (data.codespace.state === 'Shutdown') {
          showStatus('codespaceDeployStatus', 'info',
            `‚ö†Ô∏è Codespace is stopped. <a href="${codespaceWebUrl}" target="_blank" style="color: white; text-decoration: underline;">Open it</a> to restart.`
          );
        } else {
          showStatus('codespaceDeployStatus', 'info', `Status: ${data.codespace.state}`);
        }

      } catch (error) {
        console.error('Error refreshing Codespace:', error);

        // If Codespace not found, offer to create a new one
        if (error.message.includes('Not Found') || error.message.includes('No Codespaces found')) {
          showStatus('codespaceDeployStatus', 'warning',
            '‚ö†Ô∏è Codespace no longer exists (may have been deleted).<br>' +
            '<button class="btn btn-primary" onclick="recreateCodespace()" style="margin-top: 10px; padding: 10px 20px;">üîÑ Create New Codespace</button>'
          );
        } else {
          showStatus('codespaceDeployStatus', 'error', '‚ùå ' + error.message);
        }
      }
    }

    /**
     * Recreate Codespace after it was deleted
     */
    async function recreateCodespace() {
      // Clear old Codespace data
      codespaceUrl = '';
      codespaceWebUrl = '';
      codespaceName = '';
      websocketUrl = '';
      saveProgressToStorage();

      showStatus('codespaceDeployStatus', 'info', 'üóëÔ∏è Preparing to recreate Codespace...');
      renderStepContent();

      // Trigger new deployment
      setTimeout(() => {
        deployToCodespaces();
      }, 500);
    }

    /**
     * Fix Codespace WebSocket Connection
     * Simple one-click fix for students
     */
    async function fixCodespaceConnection() {
      showStatus('codespaceDeployStatus', 'info', 'üîß Fixing WebSocket connection...');

      try {
        // Call the fix API
        const fixResponse = await fetch('/api/github-fix-codespace-port', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            accessToken: githubToken,
            codespaceName: codespaceName
          })
        });

        const fixData = await fixResponse.json();

        if (fixData.success) {
          showStatus('codespaceDeployStatus', 'success',
            `‚úÖ Connection fix applied!<br><br>` +
            `<span style="font-size: 14px;">Testing connection in 10 seconds...</span>`
          );

          // Wait 10 seconds, then restart polling
          await new Promise(resolve => setTimeout(resolve, 10000));

          showStatus('codespaceDeployStatus', 'info', 'üîç Testing WebSocket connection...');

          // Restart polling from the beginning
          await pollCodespaceStatus();
        } else {
          throw new Error(fixData.error || 'Fix failed');
        }
      } catch (error) {
        console.error('Fix connection error:', error);
        showStatus('codespaceDeployStatus', 'error',
          `‚ùå Automatic fix failed: ${error.message}<br><br>` +
          `Please try the manual steps in "Advanced troubleshooting" above.`
        );
      }
    }

    /**
     * Test WebSocket Connection
     * Attempts to connect to WebSocket URL and verify it responds
     */
    async function testWebSocketConnection(wsUrl, timeoutMs = 10000) {
      return new Promise((resolve) => {
        const timeout = setTimeout(() => {
          if (ws) ws.close();
          resolve({
            success: false,
            error: 'Connection timeout - server did not respond'
          });
        }, timeoutMs);

        try {
          const ws = new WebSocket(wsUrl);

          ws.onopen = () => {
            clearTimeout(timeout);
            ws.close();
            resolve({
              success: true,
              message: 'WebSocket connection successful'
            });
          };

          ws.onerror = (error) => {
            clearTimeout(timeout);
            resolve({
              success: false,
              error: 'WebSocket connection failed - server may still be starting'
            });
          };

          ws.onclose = (event) => {
            if (!event.wasClean) {
              clearTimeout(timeout);
              resolve({
                success: false,
                error: `Connection closed unexpectedly: ${event.code}`
              });
            }
          };
        } catch (error) {
          clearTimeout(timeout);
          resolve({
            success: false,
            error: error.message
          });
        }
      });
    }

    /**
     * Deploy Shared WebSocket Server (Instant)
     * Student gets instant access to shared multi-tenant WebSocket server
     */
    async function deploySharedWebSocket() {
      const btn = document.getElementById('deployCodespaceBtn');

      // Validate session token exists (should already be generated in init())
      if (!sessionToken || sessionToken === 'null' || sessionToken === 'undefined') {
        console.error('‚ö†Ô∏è Session token missing in deploySharedWebSocket! This should not happen.');
        showStatus('codespaceDeployStatus', 'error', '‚ùå Session error. Please refresh the page.');
        return;
      }

      // Demo mode simulation
      if (studentDemoMode || twilioCredentials?.demoMode) {
        btn.disabled = true;
        btn.textContent = '‚ö° Setting up...';

        showStatus('codespaceDeployStatus', 'info', 'üì¶ Demo: Setting up WebSocket server...');
        await new Promise(resolve => setTimeout(resolve, 1000));

        websocketUrl = 'wss://workshop-websocket-server-production.up.railway.app/ws/' + sessionToken;
        codespaceUrl = websocketUrl;
        step5Deployed = true;
        websocketBuilt = true;

        saveProgressToStorage();
        updateProgressBar();

        showStatus('codespaceDeployStatus', 'success',
          `‚úÖ Demo: WebSocket server ready!<br>` +
          `<div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px; margin-top: 10px; font-family: monospace; font-size: 12px; word-break: break-all;">${websocketUrl}</div>`
        );

        btn.disabled = false;
        btn.textContent = '‚úÖ Server Ready';
        renderStepContent();
        return;
      }

      try {
        btn.disabled = true;
        btn.textContent = '‚ö° Setting up...';

        // Step 1: Push starter code to their GitHub repo
        if (githubToken && githubUsername) {
          showStatus('codespaceDeployStatus', 'info', 'üì¶ Creating your GitHub repository...');

          const pushResponse = await fetch('/api/github-push-starter-code', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              githubToken: githubToken,
              githubUsername: githubUsername,
              repoName: studentRepoName || 'conversationrelay-voice-ai'
            })
          });

          const pushData = await pushResponse.json();

          if (pushData.success) {
            console.log('‚úÖ Starter code pushed to GitHub');
            studentRepoName = pushData.repoName;
          } else {
            console.warn('‚ö†Ô∏è GitHub push failed, continuing anyway:', pushData.error);
          }
        }

        showStatus('codespaceDeployStatus', 'info', '‚ö° Setting up your WebSocket server...');

        // Step 2: Create initial student config in database
        if (!studentDemoMode && !twilioCredentials?.demoMode) {
          showStatus('codespaceDeployStatus', 'info', 'üíæ Creating your AI configuration...');

          try {
            console.log('üíæ Creating initial student config in database...');

            // Create initial system prompt with best practices
            const roleDescription = useCaseDescription && useCaseDescription.trim()
              ? useCaseDescription
              : 'a helpful assistant';

            const initialSystemPrompt = `You are ${roleDescription}.

# Voice Conversation Guidelines
- Keep responses BRIEF (1-2 sentences max)
- Be conversational and natural
- Avoid lists, bullet points, or structured formatting
- Don't say "as an AI" or mention you're artificial
- If you don't know something, say so briefly
- Respond quickly - every second matters in voice
- Use casual language, contractions, and natural speech patterns

# Response Style
- Short and direct
- Friendly but professional
- Natural and human-like`.trim();

            const configResponse = await fetch('/api/student-config-save', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                sessionToken: sessionToken,
                studentName: studentName || githubUsername || 'Student',
                openaiApiKey: openaiApiKey || null,
                systemPrompt: initialSystemPrompt,
                tools: [],
                voiceSettings: {
                  provider: ttsProvider || 'google',
                  voice: conversationRelayVoice || null
                }
              })
            });

            const configData = await configResponse.json();

            if (!configData.success) {
              throw new Error(configData.error || 'Failed to save configuration to database');
            }

            console.log('‚úÖ Initial student config created in database');
            console.log('   Session token:', sessionToken);
            console.log('   WebSocket URL:', configData.websocketUrl);

          } catch (error) {
            console.error('‚ùå Error creating student config:', error);
            showStatus('codespaceDeployStatus', 'error',
              `‚ùå Failed to create AI configuration: ${error.message}<br>` +
              `<div style="margin-top: 10px; font-size: 13px;">This is required for the WebSocket server to work. Please try again.</div>`
            );
            btn.disabled = false;
            btn.textContent = 'üîÑ Retry Setup';
            return; // Block progress
          }
        }

        // Step 3: The WebSocket URL is instant - it uses the shared server
        websocketUrl = `wss://workshop-websocket-server-production.up.railway.app/ws/${sessionToken}`;
        codespaceUrl = websocketUrl;

        // Mark as deployed immediately
        step5Deployed = true;
        websocketBuilt = true;

        saveProgressToStorage();
        updateProgressBar();

        showStatus('codespaceDeployStatus', 'success',
          `‚úÖ WebSocket server ready!<br>` +
          `<div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px; margin-top: 10px; font-family: monospace; font-size: 12px; word-break: break-all;">${websocketUrl}</div>` +
          (studentRepoName ? `<div style="margin-top: 10px; font-size: 13px; opacity: 0.8;">üì¶ Code saved to: <a href="https://github.com/${githubUsername}/${studentRepoName}" target="_blank" style="color: #58a6ff;">${githubUsername}/${studentRepoName}</a></div>` : '') +
          `<div style="margin-top: 10px; font-size: 13px; opacity: 0.8;">‚ú® Your AI will be configured when you complete Step 7 (System Prompt)</div>`
        );

        btn.disabled = false;
        btn.textContent = '‚úÖ Server Ready';

        celebrate('‚ö° Instant WebSocket server ready!', 'normal');
        renderStepContent();

        setTimeout(() => {
          // Move next-action effect from Deploy button to Next button
          const deployBtn = document.getElementById('deployCodespaceBtn');
          if (deployBtn) {
            deployBtn.classList.remove('next-action');
          }

          // Add next-action to the Next button (Step 5 ‚Üí Step 6)
          const nextBtn = document.getElementById('nextBtn7');
          if (nextBtn) {
            nextBtn.classList.add('next-action');
          }

          const connectTwilioBtn = document.querySelector('[onclick*="connectTwilio"]');
          if (connectTwilioBtn && !twilioConnected) {
            connectTwilioBtn.classList.add('next-action');
          }
        }, 500);

      } catch (error) {
        console.error('Deploy error:', error);
        showStatus('codespaceDeployStatus', 'error', `‚ùå Setup failed: ${error.message}`);
        btn.disabled = false;
        btn.textContent = 'üîÑ Retry Setup';
      }
    }

    // Expose key variables and functions to window object for testing
    if (typeof window !== 'undefined') {
      window.currentStep = currentStep;
      window.twilioConnected = twilioConnected;
      window.openaiConnected = openaiConnected;
      window.sessionToken = sessionToken;
      window.STEP_CONDITIONS = STEP_CONDITIONS;
      window.checkStepComplete = checkStepComplete;
      window.checkAllConditions = checkAllConditions;
      window.nextStep = nextStep;
      window.renderStepContent = renderStepContent;
      window.setState = setState;
      window.getState = getState;
      window.steps = steps;

      // Keep them synchronized
      window.updateTestVariables = () => {
        window.currentStep = currentStep;
        window.twilioConnected = twilioConnected;
        window.openaiConnected = openaiConnected;
        window.sessionToken = sessionToken;
      };

      // Helper to reset debounce flags for testing
      window.resetDebounceFlags = () => {
        nextStepDebounce = false;
      };
    }

    // Initialize on load
    init();
    updateProgressBar();
  </script>
</body>
</html>
