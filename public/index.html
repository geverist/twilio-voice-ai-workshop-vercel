<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Twilio Voice AI Workshop - Interactive Tutorial</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #F22F46 0%, #0d122b 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .workshop-container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #F22F46 0%, #0d122b 100%);
      padding: 30px;
      color: white;
      text-align: center;
    }

    .header h1 {
      font-size: 2rem;
      margin-bottom: 10px;
    }

    /* Progress Steps */
    .progress-steps {
      display: flex;
      justify-content: space-between;
      padding: 30px;
      background: #f8f9fa;
      border-bottom: 2px solid #e0e0e0;
      overflow-x: auto;
    }

    .step-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
      position: relative;
      min-width: 120px;
    }

    .step-item:not(:last-child)::after {
      content: '';
      position: absolute;
      top: 20px;
      left: 60%;
      width: 80%;
      height: 3px;
      background: #e0e0e0;
      z-index: 0;
    }

    .step-item.completed:not(:last-child)::after {
      background: #28a745;
    }

    .step-number {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #e0e0e0;
      color: #666;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      margin-bottom: 8px;
      position: relative;
      z-index: 1;
    }

    .step-item.active .step-number {
      background: #F22F46;
      color: white;
      box-shadow: 0 0 0 4px rgba(242, 47, 70, 0.2);
    }

    .step-item.completed .step-number {
      background: #28a745;
      color: white;
    }

    .step-item.completed .step-number::before {
      content: '‚úì';
    }

    .step-title {
      font-size: 12px;
      text-align: center;
      color: #666;
      font-weight: 500;
    }

    .step-item.active .step-title {
      color: #F22F46;
      font-weight: 600;
    }

    /* Main Content */
    .content {
      padding: 40px;
    }

    .step-content {
      display: none;
    }

    .step-content.active {
      display: block;
      animation: fadeIn 0.5s;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .step-header {
      margin-bottom: 30px;
    }

    .step-header h2 {
      font-size: 1.8rem;
      color: #0d122b;
      margin-bottom: 10px;
    }

    .step-header p {
      color: #666;
      font-size: 1.1rem;
    }

    .instructions {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 20px;
      margin: 20px 0;
      border-radius: 4px;
    }

    .instructions h3 {
      color: #856404;
      margin-bottom: 15px;
    }

    .form-group {
      margin: 20px 0;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #333;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #F22F46;
    }

    .code-editor {
      background: #1e1e1e;
      border: 1px solid #333;
      border-radius: 8px;
      overflow: hidden;
      margin: 20px 0;
    }

    .code-header {
      background: #2d2d2d;
      color: white;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .btn-copy {
      background: #0d122b;
      color: white;
      padding: 6px 12px;
      font-size: 13px;
      border: 1px solid #4fc1ff;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-copy:hover {
      background: #4fc1ff;
      color: #0d122b;
    }

    .btn-copy.copied {
      background: #28a745;
      border-color: #28a745;
    }

    .code-textarea {
      width: 100%;
      min-height: 300px;
      background: #1e1e1e;
      color: #d4d4d4;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 14px;
      line-height: 1.6;
      padding: 20px;
      border: none;
      resize: vertical;
      outline: none;
    }

    .console-output {
      background: #1e1e1e;
      color: #d4d4d4;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 13px;
      padding: 15px;
      min-height: 150px;
      max-height: 300px;
      overflow-y: auto;
      border-radius: 8px;
      margin: 20px 0;
    }

    .console-line {
      margin-bottom: 5px;
    }

    .console-line.success { color: #4ec9b0; }
    .console-line.error { color: #f48771; }
    .console-line.info { color: #4fc1ff; }

    .status-box {
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      display: none;
    }

    .status-box.show {
      display: block;
    }

    .status-box.success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }

    .status-box.error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }

    .status-box.info {
      background: #e7f5ff;
      border: 1px solid #b8daff;
      color: #004085;
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin: 30px 0;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
    }

    .btn-primary {
      background: #F22F46;
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: #d1283d;
      transform: translateY(-2px);
    }

    .btn-primary:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-test {
      background: #17a2b8;
      color: white;
    }

    .live-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #28a745;
      margin-right: 8px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .connection-status {
      padding: 10px 15px;
      background: #f8f9fa;
      border-radius: 6px;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      margin: 10px 0;
    }

    .service-card {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
    }

    .service-card h4 {
      margin-bottom: 10px;
      color: #0d122b;
    }

    .service-status {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
    }

    /* Toolbar */
    .toolbar {
      background: #f8f9fa;
      border-bottom: 1px solid #e0e0e0;
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }

    .toolbar-left, .toolbar-right {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .btn-icon {
      padding: 8px 16px;
      border: 1px solid #e0e0e0;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .btn-icon:hover {
      background: #f8f9fa;
      border-color: #F22F46;
    }

    /* Debugger Panel */
    .debugger-panel {
      background: #1e1e1e;
      border-radius: 8px;
      padding: 15px;
      margin: 20px 0;
      display: none;
    }

    .debugger-panel.show {
      display: block;
    }

    .debugger-header {
      color: #4fc1ff;
      font-weight: 600;
      margin-bottom: 10px;
      font-size: 14px;
    }

    .event-flow {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .event-item {
      background: #2d2d2d;
      padding: 10px;
      border-radius: 4px;
      border-left: 3px solid #4fc1ff;
      font-family: monospace;
      font-size: 12px;
      color: #d4d4d4;
    }

    .event-item.start { border-left-color: #28a745; }
    .event-item.transcript { border-left-color: #ffc107; }
    .event-item.response { border-left-color: #4fc1ff; }
    .event-item.stop { border-left-color: #dc3545; }

    /* WebSocket Tester */
    .ws-tester {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }

    .ws-controls {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }


    /* Video Section */
    .video-section {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }

    .video-container {
      position: relative;
      padding-bottom: 56.25%;
      height: 0;
      overflow: hidden;
      border-radius: 8px;
      background: #000;
      margin-top: 10px;
    }

    .video-container iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    /* Troubleshooting Panel */
    .troubleshooting {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 15px;
      border-radius: 4px;
      margin: 20px 0;
    }

    .faq-item {
      margin: 10px 0;
      cursor: pointer;
      padding: 10px;
      background: white;
      border-radius: 4px;
    }

    .faq-item:hover {
      background: #f8f9fa;
    }

    .faq-answer {
      display: none;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #e0e0e0;
      color: #666;
    }

    .faq-item.open .faq-answer {
      display: block;
    }

    /* Autocomplete */
    .autocomplete-suggestions {
      position: absolute;
      background: #2d2d2d;
      border: 1px solid #4fc1ff;
      border-radius: 4px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
    }

    .autocomplete-item {
      padding: 8px 12px;
      cursor: pointer;
      color: #d4d4d4;
      font-family: monospace;
      font-size: 13px;
    }

    .autocomplete-item:hover {
      background: #4fc1ff;
      color: #0d122b;
    }

    /* Progress Indicator */
    .progress-saved {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #28a745;
      color: white;
      padding: 10px 20px;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      display: none;
      animation: slideIn 0.3s;
    }

    @keyframes slideIn {
      from { transform: translateY(100px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-close {
      cursor: pointer;
      font-size: 24px;
      color: #666;
    }

    /* Tooltip styles */
    .tooltip-trigger {
      display: inline-block;
      color: #F22F46;
      cursor: help;
      border-bottom: 1px dashed #F22F46;
      position: relative;
    }

    .tooltip-content {
      display: none;
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      border: 2px solid #F22F46;
      border-radius: 12px;
      padding: 20px;
      width: 300px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      margin-bottom: 10px;
    }

    .tooltip-trigger:hover .tooltip-content {
      display: block;
      animation: fadeIn 0.3s;
    }

    .tooltip-content h4 {
      color: #0d122b;
      margin-bottom: 10px;
      font-size: 1.1rem;
    }

    .tooltip-content p {
      color: #666;
      line-height: 1.5;
      margin-bottom: 10px;
      font-size: 0.9rem;
    }

    .tooltip-content a {
      color: #F22F46;
      text-decoration: none;
      font-weight: 600;
    }

    .tooltip-content a:hover {
      text-decoration: underline;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }
  </style>
  <script src="/python-examples.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>
<body>
  <div class="workshop-container">
    <div class="header">
      <h1>üéôÔ∏è Twilio Voice AI Workshop</h1>
      <p>Build a Production-Ready Voice AI with ConversationRelay & OpenAI</p>
    </div>

    <!-- Demo Mode Banner -->
    <div id="demoModeBanner" style="display: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 30px; text-align: center; border-bottom: 3px solid #5a67d8; font-weight: 600; font-size: 0.95rem;">
      <span style="font-size: 1.2rem;">üëÄ</span>
      <strong>DEMO MODE ACTIVE</strong> - All authentication is stubbed out. Explore freely!
      <button onclick="exitDemoMode()" style="margin-left: 15px; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 6px 16px; border-radius: 4px; cursor: pointer; font-size: 0.85rem; font-weight: 600;">
        Exit Demo Mode
      </button>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
      <div class="toolbar-left">
        <button class="btn-icon" onclick="saveProgress()">üíæ Save Progress</button>
        <button class="btn-icon" onclick="loadProgress()">üìÇ Load Progress</button>
        <button class="btn-icon" onclick="exportProject()">üì¶ Export Project</button>
      </div>
      <div class="toolbar-right">
        <button class="btn-icon" onclick="openPlayground()">üéì What is CR?</button>
        <button class="btn-icon" onclick="toggleDebugger()">üêõ Debugger</button>
        <button class="btn-icon" onclick="showHelp()">‚ùì Help</button>
      </div>
    </div>

    <!-- Overall Progress Bar -->
    <div style="background: white; padding: 20px 30px; border-bottom: 2px solid #e0e0e0;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <h3 style="margin: 0; font-size: 16px; color: #0d122b;">Workshop Progress</h3>
        <span id="progressPercent" style="font-weight: 600; color: #F22F46;">0%</span>
      </div>
      <div style="width: 100%; height: 12px; background: #e0e0e0; border-radius: 6px; overflow: hidden;">
        <div id="progressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #F22F46 0%, #0d122b 100%); transition: width 0.5s ease;"></div>
      </div>
      <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 12px; color: #666;">
        <span id="completedTasks">0 of 6 steps completed</span>
        <span id="timeEstimate">Est. 30-45 minutes</span>
      </div>
    </div>

    <!-- Progress Steps -->
    <div class="progress-steps" id="progressSteps">
      <!-- Populated by JavaScript -->
    </div>

    <!-- Main Content -->
    <div class="content" id="mainContent">
      <!-- Step content populated by JavaScript -->
    </div>
  </div>

  <!-- Progress Saved Indicator -->
  <div class="progress-saved" id="progressSaved">‚úì Progress Saved</div>

  <!-- GitHub Login Modal -->
  <div class="modal" id="githubLoginModal" style="background: rgba(0, 0, 0, 0.85);">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2 style="color: #F22F46; margin: 0;">üöÄ Welcome to Voice AI Workshop</h2>
        <span class="modal-close" onclick="dismissGitHubModal()" style="cursor: pointer; color: #666; font-size: 28px;">&times;</span>
      </div>

      <div style="margin: 25px 0;">
        <div style="font-size: 3rem; text-align: center; margin-bottom: 15px;">üéôÔ∏è</div>
        <p style="color: #666; font-size: 1.1rem; line-height: 1.6; text-align: center; margin-bottom: 25px;">
          Build an AI-powered voice assistant with real-time conversations, OpenAI integration, and function calling!
        </p>
      </div>

      <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #28a745; margin-bottom: 20px;">
        <h4 style="margin: 0 0 12px 0; color: #155724; font-size: 0.95rem;">üìö What You'll Build:</h4>
        <ul style="margin: 0; padding-left: 20px; color: #666; line-height: 1.8; font-size: 0.9rem;">
          <li>AI-powered voice assistant with OpenAI</li>
          <li>Real-time conversation with ConversationRelay</li>
          <li>Function calling and tool integration</li>
          <li>Your own GitHub repository to keep!</li>
        </ul>
      </div>

      <div style="background: #e7f3ff; padding: 25px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #0066cc;">
        <h3 style="color: #0066cc; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
          <span>üîó Connect with GitHub</span>
        </h3>
        <p style="color: #333; margin-bottom: 20px; line-height: 1.6; font-size: 0.95rem;">
          Sign in with GitHub to create your own voice AI repository. We'll set up a project in your account automatically.
        </p>

        <div id="githubErrorMessage" style="display: none; color: #dc3545; background: #f8d7da; padding: 12px; border-radius: 6px; margin-bottom: 15px; font-size: 0.9rem;"></div>

        <button onclick="startGitHubLoginFromModal()" class="btn btn-primary" id="githubLoginBtnModal" style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px; padding: 15px; font-size: 1.05rem;">
          <svg height="24" width="24" viewBox="0 0 16 16" fill="currentColor">
            <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
          </svg>
          Continue with GitHub
        </button>

        <p style="color: #999; font-size: 0.8rem; text-align: center; margin-top: 15px;">
          üîí We only request repository creation permissions
        </p>
      </div>

      <div style="background: #fff3cd; padding: 20px; border-radius: 8px; border-left: 4px solid #856404; margin-bottom: 20px;">
        <h4 style="margin: 0 0 12px 0; color: #856404; font-size: 0.95rem;">üëÄ Just Want to Explore?</h4>
        <p style="color: #666; font-size: 0.9rem; margin-bottom: 15px; line-height: 1.6;">
          Try Demo Mode to explore the workshop with simulated authentication. No credentials needed!
        </p>
        <button onclick="startDemoMode()" class="btn" style="width: 100%; background: #856404; color: white; padding: 12px 24px; font-size: 0.95rem;">
          üëÄ Start Demo Mode
        </button>
      </div>

      <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
        <p style="color: #666; font-size: 0.9rem; margin-bottom: 12px;">Don't have a GitHub account?</p>
        <a href="https://github.com/signup" target="_blank"
           style="display: inline-block; padding: 10px 24px; background: #24292e; color: white;
                  text-decoration: none; border-radius: 6px; font-weight: 600; transition: all 0.3s; font-size: 0.9rem; margin-bottom: 12px;">
          Create GitHub Account ‚Üí
        </a>
        <p style="color: #999; font-size: 0.8rem;">It's free and takes less than 2 minutes</p>

        <div style="margin-top: 20px;">
          <button onclick="dismissGitHubModal()" style="background: none; border: none; color: #999; cursor: pointer; text-decoration: underline; font-size: 0.9rem;">
            Skip for now
          </button>
        </div>
      </div>
    </div>
  </div>


  <!-- Help Modal -->
  <div class="modal" id="helpModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>‚ùì Help & Troubleshooting</h2>
        <span class="modal-close" onclick="closeModal('helpModal')">&times;</span>
      </div>
      <div id="helpContent"></div>
    </div>
  </div>

  <!-- Export Project Modal -->
  <div class="modal" id="exportModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üì¶ Export Your Project</h2>
        <span class="modal-close" onclick="closeModal('exportModal')">&times;</span>
      </div>
      <div id="exportContent"></div>
    </div>
  </div>

  <script>
    // Workshop Steps Configuration
    const steps = [
      {
        id: 1,
        title: 'Setup',
        description: 'Connect your accounts',
        validate: () => twilioConnected && openaiConnected
      },
      {
        id: 2,
        title: 'Direction',
        description: 'Choose call direction',
        validate: () => callDirectionChosen
      },
      {
        id: 3,
        title: 'Services',
        description: 'Provision Twilio services',
        validate: () => servicesReady
      },
      {
        id: 4,
        title: 'Basic TwiML',
        description: 'Simple Dial/Receive',
        validate: () => basicTwimlCreated
      },
      {
        id: 5,
        title: 'Deploy',
        description: 'Deploy to your account',
        validate: () => functionsDeployed
      },
      {
        id: 6,
        title: 'Test Basic',
        description: 'Test basic call',
        validate: () => basicCallTested
      },
      {
        id: 7,
        title: 'WebSocket',
        description: 'Build WebSocket handler',
        validate: () => websocketBuilt
      },
      {
        id: 8,
        title: 'ConversationRelay',
        description: 'Upgrade to AI',
        validate: () => conversationRelayCreated
      },
      {
        id: 9,
        title: 'Test AI',
        description: 'Test AI voice bot',
        validate: () => aiCallTested
      }
    ];

    // State
    let currentStep = 0;
    let twilioConnected = false;
    let openaiConnected = false;
    let callDirectionChosen = false;
    let callDirection = ''; // 'outbound' or 'inbound'
    let servicesReady = false;
    let basicTwimlCreated = false;
    let functionsDeployed = false;
    let basicCallTested = false;
    let websocketBuilt = false;
    let conversationRelayCreated = false;
    let aiCallTested = false;

    let twilioCredentials = null;
    let openaiApiKey = null;
    let selectedPhoneNumber = null;
    let websocketUrl = '';
    let syncServiceSkipped = false;
    let deployedServiceSid = null;

    // GitHub integration variables
    let githubSessionToken = null;
    let githubUsername = null;
    let studentRepoFullName = null;
    let studentRepoUrl = null;
    let githubConnected = false;


    // =========================================================================
    // PROGRESS PERSISTENCE
    // =========================================================================

    function saveProgressToStorage() {
      const progress = {
        currentStep,
        twilioConnected,
        openaiConnected,
        callDirectionChosen,
        callDirection,
        servicesReady,
        basicTwimlCreated,
        functionsDeployed,
        basicCallTested,
        websocketBuilt,
        conversationRelayCreated,
        aiCallTested,
        twilioCredentials,
        openaiApiKey,
        selectedPhoneNumber,
        websocketUrl,
        syncServiceSkipped,
        deployedServiceSid,
        githubSessionToken,
        githubUsername,
        studentRepoFullName,
        studentRepoUrl,
        githubConnected,
        timestamp: new Date().toISOString(),
        completedSteps: steps.slice(0, currentStep).map(s => s.title)
      };
      localStorage.setItem('workshop_progress', JSON.stringify(progress));
      console.log('Progress auto-saved:', progress);
    }

    function loadProgressFromStorage() {
      try {
        const saved = localStorage.getItem('workshop_progress');
        if (saved) {
          const progress = JSON.parse(saved);
          const savedDate = new Date(progress.timestamp);
          const daysSince = (Date.now() - savedDate.getTime()) / (1000 * 60 * 60 * 24);

          if (daysSince < 7) {
            return progress;
          } else {
            localStorage.removeItem('workshop_progress');
          }
        }
      } catch (error) {
        console.error('Error loading progress:', error);
      }
      return null;
    }

    function showSetupRequiredModal() {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        animation: fadeIn 0.3s;
      `;

      modal.innerHTML = `
        <div style="background: white; border-radius: 16px; padding: 50px; max-width: 600px; text-align: center; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);">
          <div style="font-size: 4rem; margin-bottom: 20px;">üöÄ</div>
          <h2 style="color: #0d122b; margin-bottom: 20px; font-size: 2rem;">Welcome to the Workshop!</h2>
          <p style="color: #666; margin-bottom: 30px; line-height: 1.6; font-size: 1.1rem;">
            Before you can start building, you'll need to connect your Twilio account and configure your workshop environment.
          </p>
          <div style="background: #f8f9fa; padding: 25px; border-radius: 12px; margin-bottom: 30px; text-align: left; border-left: 4px solid #F22F46;">
            <strong style="color: #0d122b; display: block; margin-bottom: 15px; font-size: 1.1rem;">The setup wizard will help you:</strong>
            <ul style="margin-left: 20px; color: #666; line-height: 2;">
              <li>‚úÖ Connect your Twilio account (OAuth or API Key)</li>
              <li>‚úÖ Deploy workshop code to your account</li>
              <li>‚úÖ Configure phone numbers and services</li>
              <li>‚úÖ Get ready to build AI voice agents!</li>
            </ul>
          </div>
          <p style="color: #666; margin-bottom: 30px; font-size: 0.95rem;">
            <strong>Don't worry!</strong> Setup takes less than 5 minutes and is completely guided.
          </p>
          <div style="display: flex; gap: 15px; justify-content: center;">
            <a href="/setup-wizard.html" style="flex: 1; max-width: 250px; padding: 18px 30px; background: linear-gradient(135deg, #F22F46 0%, #ff6b6b 100%); color: white; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 1.1rem; display: inline-block; transition: transform 0.2s;">
              Start Setup Wizard ‚Üí
            </a>
            <button onclick="this.closest('div').closest('div').closest('div').remove(); init();" style="flex: 1; max-width: 200px; padding: 18px 30px; background: white; color: #666; border: 2px solid #ddd; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem;">
              Continue Anyway
            </button>
          </div>
          <p style="color: #999; margin-top: 20px; font-size: 0.85rem;">
            Clicking "Continue Anyway" means you'll need to manually enter credentials in each step
          </p>
        </div>
      `;

      document.body.appendChild(modal);
    }

    function showResumeModal(progress) {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        animation: fadeIn 0.3s;
      `;

      modal.innerHTML = `
        <div style="background: white; border-radius: 16px; padding: 40px; max-width: 500px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);">
          <h2 style="color: #0d122b; margin-bottom: 20px;">üëã Welcome Back!</h2>
          <p style="color: #666; margin-bottom: 20px; line-height: 1.6;">
            We found your saved progress from ${new Date(progress.timestamp).toLocaleDateString()}.
          </p>
          <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
            <strong style="color: #0d122b; display: block; margin-bottom: 10px;">Your Progress:</strong>
            <ul style="margin-left: 20px; color: #666; line-height: 1.8;">
              <li>Current Step: <strong>${progress.currentStep + 1} of ${steps.length}</strong> - ${steps[progress.currentStep].title}</li>
              <li>Completed: ${progress.completedSteps.join(', ') || 'Just getting started'}</li>
              ${progress.selectedPhoneNumber ? `<li>Phone: ${progress.selectedPhoneNumber}</li>` : ''}
            </ul>
          </div>
          <div style="display: flex; gap: 10px;">
            <button onclick="resumeProgress()" style="flex: 1; padding: 15px; background: linear-gradient(135deg, #F22F46 0%, #ff6b6b 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem;">
              Resume ‚Üí
            </button>
            <button onclick="startFresh()" style="flex: 1; padding: 15px; background: white; color: #F22F46; border: 2px solid #F22F46; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem;">
              Start Fresh
            </button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
      window.resumeModal = modal;
      window.savedProgress = progress;
    }

    function resumeProgress() {
      const progress = window.savedProgress;

      // Restore all state
      currentStep = progress.currentStep || 0;
      twilioConnected = progress.twilioConnected || false;
      openaiConnected = progress.openaiConnected || false;
      callDirectionChosen = progress.callDirectionChosen || false;
      callDirection = progress.callDirection || '';
      servicesReady = progress.servicesReady || false;
      basicTwimlCreated = progress.basicTwimlCreated || false;
      functionsDeployed = progress.functionsDeployed || false;
      basicCallTested = progress.basicCallTested || false;
      websocketBuilt = progress.websocketBuilt || false;
      conversationRelayCreated = progress.conversationRelayCreated || false;
      aiCallTested = progress.aiCallTested || false;
      twilioCredentials = progress.twilioCredentials || null;
      openaiApiKey = progress.openaiApiKey || null;
      selectedPhoneNumber = progress.selectedPhoneNumber || null;
      websocketUrl = progress.websocketUrl || '';
      syncServiceSkipped = progress.syncServiceSkipped || false;
      deployedServiceSid = progress.deployedServiceSid || null;

      // Close modal
      if (window.resumeModal) {
        window.resumeModal.remove();
      }

      // Re-render
      renderProgressSteps();
      renderStepContent();

      celebrate('‚úÖ Progress restored! Continue where you left off.', 'light');
    }

    function startFresh() {
      localStorage.removeItem('workshop_progress');
      if (window.resumeModal) {
        window.resumeModal.remove();
      }
      alert('üîÑ Starting fresh! Your old progress has been cleared.');
    }

    // =========================================================================
    // CELEBRATIONS
    // =========================================================================

    function celebrate(message, intensity = 'normal') {
      const configs = {
        light: { particleCount: 50, spread: 50 },
        normal: { particleCount: 100, spread: 70 },
        epic: { particleCount: 200, spread: 90, startVelocity: 45 }
      };

      const config = configs[intensity] || configs.normal;

      confetti({
        ...config,
        origin: { y: 0.6 },
        colors: ['#F22F46', '#ff6b6b', '#667eea', '#764ba2', '#ffc107']
      });

      // Show toast
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #F22F46 0%, #ff6b6b 100%);
        color: white;
        padding: 20px 30px;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        z-index: 9999;
        font-weight: 600;
        font-size: 1.1rem;
        animation: slideIn 0.5s ease-out;
      `;
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.animation = 'slideOut 0.5s ease-in';
        setTimeout(() => toast.remove(), 500);
      }, 3000);
    }

    // =========================================================================
    // TOOLTIPS
    // =========================================================================

    const tooltips = {
      'conversationrelay': {
        title: 'ConversationRelay',
        content: 'Twilio\'s WebSocket-based API for bidirectional voice streaming. It allows real-time audio exchange between calls and your application.',
        link: 'https://www.twilio.com/docs/voice/api/conversation-relay'
      },
      'sync': {
        title: 'Twilio Sync',
        content: 'Real-time data synchronization service. We use it to securely store OAuth sessions server-side with auto-expiration.',
        link: 'https://www.twilio.com/docs/sync'
      },
      'serverless': {
        title: 'Twilio Serverless',
        content: 'Zero-configuration hosting for Functions and Assets. Deploy your code without managing servers, scaling automatically.',
        link: 'https://www.twilio.com/docs/serverless'
      },
      'twiml': {
        title: 'TwiML',
        content: 'Twilio Markup Language - XML instructions that tell Twilio how to handle calls and messages. Simple, declarative voice programming.',
        link: 'https://www.twilio.com/docs/voice/twiml'
      },
      'websocket': {
        title: 'WebSockets',
        content: 'Protocol for real-time bidirectional communication over a single TCP connection. Enables instant audio streaming.',
        link: 'https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API'
      }
    };

    function createTooltip(term, text = null) {
      const data = tooltips[term.toLowerCase()];
      if (!data) return text || term;

      return `<span class="tooltip-trigger">${text || term}
        <span class="tooltip-content">
          <h4>${data.title}</h4>
          <p>${data.content}</p>
          <a href="${data.link}" target="_blank">Learn More ‚Üí</a>
        </span>
      </span>`;
    }

    // =========================================================================
    // Initialize
    function init() {
      // Check for GitHub OAuth session in URL
      const urlParams = new URLSearchParams(window.location.search);
      const githubToken = urlParams.get('github_token');
      const githubUser = urlParams.get('github_user');

      if (githubToken && githubUser) {
        // Generate student ID and store GitHub session
        const studentId = 'student_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        const studentInfo = {
          studentId: studentId,
          studentName: githubUser, // Use GitHub username as name
          githubUsername: githubUser,
          githubToken: githubToken,
          startedAt: new Date().toISOString()
        };

        localStorage.setItem('workshop_student_info', JSON.stringify(studentInfo));

        // Track workshop start
        if (typeof trackWorkshopStart === 'function') {
          trackWorkshopStart();
        }

        // Clean URL (remove parameters)
        window.history.replaceState({}, document.title, window.location.pathname);

        // Show welcome message
        celebrate(`üéâ Welcome, ${githubUser}! Let's build your AI voice assistant.`, 'normal');

        // Hide GitHub login modal if it's showing
        const githubModal = document.getElementById('githubLoginModal');
        if (githubModal) {
          githubModal.classList.remove('show');
        }

        // Show GitHub repo section in Step 1
        setTimeout(() => {
          const repoSection = document.getElementById('githubRepoSection');
          if (repoSection) {
            repoSection.style.display = 'block';
            // Pre-fill repo name
            const repoNameInput = document.getElementById('repoName');
            if (repoNameInput) {
              repoNameInput.value = `${githubUser}-voice-ai-workshop`;
            }
          }
        }, 100);
      }

      // Check if coming from setup wizard
      const setupComplete = localStorage.getItem('workshop_setup_complete');
      const savedProgress = loadProgressFromStorage();
      const hasWorkshopCredentials = localStorage.getItem('workshopCredentials');
      const hasStudentInfo = localStorage.getItem('workshop_student_info');

      // Show GitHub login modal if user is new (no setup, no progress, no student info)
      const modalDismissed = localStorage.getItem('github_modal_dismissed');
      const forceModal = urlParams.get('force_modal');

      // Check for saved progress first - if exists, show resume modal instead of GitHub modal
      if (savedProgress && !setupComplete) {
        // Show resume modal, NOT GitHub modal
        showResumeModal(savedProgress);
      } else if (forceModal || (!setupComplete && !savedProgress && !hasWorkshopCredentials && !hasStudentInfo && !modalDismissed)) {
        // Show GitHub login modal for new users only
        const githubModal = document.getElementById('githubLoginModal');
        if (githubModal) {
          githubModal.classList.add('show');
        }
      } else {
        // Hide the modal for returning users or those who dismissed it
        const githubModal = document.getElementById('githubLoginModal');
        if (githubModal) {
          githubModal.classList.remove('show');
        }
      }

      if (setupComplete) {
        const setupData = JSON.parse(setupComplete);

        // Auto-populate credentials from setup wizard
        if (setupData.credentials) {
          twilioCredentials = setupData.credentials;
          twilioConnected = true;
          selectedPhoneNumber = setupData.phoneNumber;

          // Show success message
          celebrate('‚úÖ Setup complete! Your credentials are loaded.', 'normal');
        }

        // Clear the setup flag (one-time use)
        localStorage.removeItem('workshop_setup_complete');
      }

      renderProgressSteps();
      renderStepContent();

      // Check if demo mode is active and show banner
      if (twilioCredentials?.demoMode) {
        showDemoModeBanner();
      }
    }

    // Render progress indicator
    function renderProgressSteps() {
      const container = document.getElementById('progressSteps');
      container.innerHTML = steps.map((step, index) => `
        <div class="step-item ${index === currentStep ? 'active' : ''} ${index < currentStep ? 'completed' : ''}">
          <div class="step-number">${index < currentStep ? '' : step.id}</div>
          <div class="step-title">${step.title}</div>
        </div>
      `).join('');
    }

    // Render step content
    function renderStepContent() {
      const container = document.getElementById('mainContent');

      switch(currentStep) {
        case 0:
          container.innerHTML = renderStep1_Setup();
          break;
        case 1:
          container.innerHTML = renderStep2_Direction();
          break;
        case 2:
          container.innerHTML = renderStep3_Services();
          loadServices();
          break;
        case 3:
          container.innerHTML = renderStep4_BasicTwiML();
          break;
        case 4:
          container.innerHTML = renderStep6_WebSocket();
          break;
        case 5:
          container.innerHTML = renderStep9_ConversationRelay();
          break;
        case 6:
          container.innerHTML = renderStep5();
          break;
        case 7:
          container.innerHTML = renderStep8_Tooling();
          break;
        case 8:
          container.innerHTML = renderStep6_Deploy();
          break;
      }
    }

    // =========================================================================
    // STEP 1: SETUP - Connect Accounts
    // =========================================================================

    function renderStep1_Setup() {
      return `
        <div class="step-content active">
          <div class="step-header">
            <h2>Step 1: Connect Your Accounts</h2>
            <p>Let's connect your Twilio and OpenAI accounts to get started</p>
          </div>

          <div class="instructions">
            <h3>üìã What You'll Need</h3>
            <ul>
              <li><strong>Twilio Account SID & Auth Token</strong> - Get from <a href="https://console.twilio.com" target="_blank">Twilio Console</a></li>
              <li><strong>OpenAI API Key</strong> - Get from <a href="https://platform.openai.com/api-keys" target="_blank">OpenAI Platform</a></li>
            </ul>
            <p style="margin-top: 15px;">
              üìö <strong>Documentation:</strong>
              <a href="https://www.twilio.com/docs/voice/api" target="_blank">Twilio Voice API</a> |
              <a href="https://www.twilio.com/docs/iam/api-keys" target="_blank">API Authentication</a>
            </p>
          </div>

          <!-- GitHub Repository Creation -->
          <div id="githubRepoSection" style="display: none;">
            <div class="service-card" style="background: linear-gradient(135deg, #24292e 0%, #1a1e24 100%); color: white;">
              <h4 style="color: white; display: flex; align-items: center; gap: 10px;">
                <svg height="24" width="24" viewBox="0 0 16 16" fill="white">
                  <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
                </svg>
                Create Your Repository
              </h4>
              <p style="color: #e5e5e5; margin: 15px 0;">
                Create a copy of the workshop code in your GitHub account. This will be your personal project to keep!
              </p>

              <div class="form-group">
                <label style="color: white;">Repository Name</label>
                <input type="text" id="repoName" placeholder="my-voice-ai-workshop" value=""
                       style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 6px;">
                <small style="color: #b5bac1;">This will create a public repository in your GitHub account</small>
              </div>

              <button class="btn btn-primary" onclick="createGitHubRepo()" id="createRepoBtn" style="width: 100%; background: white; color: #24292e; font-weight: 600;">
                üì¶ Create Repository
              </button>

              <div id="repoStatus" style="margin-top: 15px; display: none;"></div>
            </div>
          </div>

          <!-- Twilio Credentials -->
          <div class="service-card">
            <h4>üî¥ Twilio Account</h4>

            <!-- Auth Method Selection -->
            <div class="form-group">
              <label>Authentication Method</label>
              <select id="authMethod" onchange="toggleAuthMethod()" style="width: 100%; padding: 10px;">
                <option value="apikey">üîë API Key (Recommended - Most Secure)</option>
                <option value="token">Account SID + Auth Token</option>
                <option value="demo">Demo Mode (No credentials needed)</option>
              </select>
            </div>

            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #ffc107;">
              <strong>üí° Why API Keys?</strong>
              <ul style="margin: 10px 0 0 20px; font-size: 14px;">
                <li>Can be deleted after the workshop</li>
                <li>More secure than Auth Tokens</li>
                <li>Your credentials are only used to create a session</li>
                <li>Takes 30 seconds to set up</li>
              </ul>
            </div>

            <!-- Self-Hosted Auth -->
            <div id="selfhostedAuth">
              <div style="background: #d4edda; padding: 20px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #c3e6cb;">
                <h5 style="margin: 0 0 10px 0; color: #155724;">üè† Self-Hosted Mode</h5>
                <p style="margin: 0 0 10px 0; color: #155724; font-size: 14px;">
                  You deployed this tutorial to YOUR Twilio account. No credentials needed!
                </p>
                <p style="margin: 0; color: #666; font-size: 13px;">
                  <strong>How it works:</strong> Since you deployed this via <code>twilio serverless:deploy</code>,
                  all API calls automatically use your account. Your credentials never leave Twilio's servers.
                </p>
              </div>
              <button class="btn btn-primary" onclick="connectSelfHosted()" style="width: 100%; padding: 15px; font-size: 16px;">
                ‚úÖ Verify Connection
              </button>
              <div id="selfHostedStatus" style="margin-top: 15px; display: none;">
                <div style="background: #d4edda; padding: 15px; border-radius: 8px; border: 1px solid #c3e6cb;">
                  <div>
                    <div style="color: #155724; font-weight: bold;">‚úÖ Connected to Your Account:</div>
                    <div id="selfHostedAccountName" style="color: #155724; margin-top: 5px;"></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Token Auth -->
            <div id="tokenAuth" style="display: none;">
              <div class="form-group">
                <label>Account SID</label>
                <input type="text" id="twilioAccountSid" placeholder="ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" />
              </div>
              <div class="form-group">
                <label>Auth Token</label>
                <input type="password" id="twilioAuthToken" placeholder="********************************" />
              </div>
              <button class="btn btn-primary" onclick="connectTwilio()">Connect Twilio</button>
            </div>

            <!-- API Key Auth -->
            <div id="apiKeyAuth">
              <div style="background: #e7f5ff; padding: 20px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #0066cc;">
                <h5 style="margin: 0 0 10px 0; color: #0066cc;">üìù Quick Setup (30 seconds)</h5>
                <ol style="margin: 0; padding-left: 20px; color: #555; font-size: 14px; line-height: 1.8;">
                  <li>Go to <a href="https://console.twilio.com/us1/develop/api-keys/create?friendlyName=Voice AI Workshop" target="_blank" style="color: #0066cc; text-decoration: none; font-weight: bold;">Create API Key</a> (opens in new tab)</li>
                  <li>Click <strong>"Create API Key"</strong></li>
                  <li>Copy the <strong>SID</strong> and <strong>Secret</strong> and paste below ‚¨áÔ∏è</li>
                </ol>
                <p style="margin: 10px 0 0 0; color: #666; font-size: 13px;">
                  üí° <strong>Tip:</strong> Delete this API Key after the workshop at <a href="https://console.twilio.com/us1/account/keys-credentials/api-keys" target="_blank">console.twilio.com/keys</a>
                </p>
              </div>

              <div class="form-group">
                <label>Account SID</label>
                <input type="text" id="twilioAccountSidKey" placeholder="ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" />
                <small style="display: block; margin-top: 5px; color: #666;">
                  Find at: <a href="https://console.twilio.com" target="_blank">console.twilio.com</a> (top of page)
                </small>
              </div>
              <div class="form-group">
                <label>API Key SID</label>
                <input type="text" id="twilioApiKeySid" placeholder="SKxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" />
                <small style="display: block; margin-top: 5px; color: #666;">
                  From step 2 above (starts with "SK")
                </small>
              </div>
              <div class="form-group">
                <label>API Key Secret</label>
                <input type="password" id="twilioApiKeySecret" placeholder="********************************" />
                <small style="display: block; margin-top: 5px; color: #666;">
                  ‚ö†Ô∏è Only shown once after creation - copy it now!
                </small>
              </div>
              <button class="btn btn-primary" onclick="connectTwilioWithApiKey()" style="width: 100%; padding: 12px; font-size: 16px;">
                üîê Connect Securely
              </button>
              <div style="background: #d4edda; padding: 10px; border-radius: 4px; margin-top: 10px; font-size: 13px; color: #155724;">
                üîí <strong>Your credentials are secure:</strong> They're only used once to create a session token, never stored
              </div>
            </div>

            <!-- Demo Mode -->
            <div id="demoAuth" style="display: none;">
              <div style="background: #fff3cd; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                <strong>üìù Demo Mode</strong>
                <p style="margin: 10px 0 0 0; font-size: 13px;">
                  Explore the workshop with simulated data. You won't be able to make real calls,
                  but you can see how everything works and export your code.
                </p>
              </div>
              <button class="btn btn-primary" onclick="connectDemoMode()">Start Demo Mode</button>
            </div>

            <div id="twilioStatus" class="connection-status" style="display: none; margin-top: 10px;"></div>
          </div>

          <!-- OpenAI Credentials -->
          <div class="service-card">
            <h4>ü§ñ OpenAI Account</h4>
            <div class="form-group">
              <label>API Key</label>
              <input type="password" id="openaiKey" placeholder="sk-proj-********************************" />
            </div>
            <button class="btn btn-primary" onclick="connectOpenAI()">Connect OpenAI</button>
            <div id="openaiStatus" class="connection-status" style="display: none; margin-top: 10px;"></div>
          </div>

          <div id="step1Status" class="status-box"></div>

          <div class="button-group">
            <button class="btn btn-primary" id="nextBtn1" onclick="nextStep()" disabled>
              Next: Provision Services ‚Üí
            </button>
          </div>
        </div>
      `;
    }

    function toggleAuthMethod() {
      const method = document.getElementById('authMethod').value;

      document.getElementById('selfhostedAuth').style.display = method === 'selfhosted' ? 'block' : 'none';
      document.getElementById('tokenAuth').style.display = method === 'token' ? 'block' : 'none';
      document.getElementById('apiKeyAuth').style.display = method === 'apikey' ? 'block' : 'none';
      document.getElementById('demoAuth').style.display = method === 'demo' ? 'block' : 'none';
    }

    // Self-Hosted Authentication (No credentials needed!)
    async function connectSelfHosted() {
      try {
        showStatus('step1Status', 'info', 'Verifying connection to your account...');

        // Call the self-hosted proxy (uses context.getTwilioClient())
        const response = await fetch('/tutorial-proxy-selfhosted', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'getAccountInfo'
          })
        });

        const data = await response.json();

        if (data.success) {
          // Show success status
          document.getElementById('selfHostedStatus').style.display = 'block';
          document.getElementById('selfHostedAccountName').textContent =
            data.account.friendlyName || data.account.sid;

          // Mark as connected
          twilioConnected = true;
          twilioCredentials = {
            accountSid: data.account.sid,
            friendlyName: data.account.friendlyName,
            selfHosted: true
          };

          showStatus('step1Status', 'success', '‚úÖ Connected to your Twilio account!');
          checkStep1Complete();

        } else {
          showStatus('step1Status', 'error', 'Failed to connect: ' + (data.error || 'Unknown error'));
        }

      } catch (error) {
        console.error('Connection error:', error);
        showStatus('step1Status', 'error',
          'Failed to connect. Make sure you deployed this tutorial to your Twilio account via: twilio serverless:deploy'
        );
      }
    }

    async function connectTwilio() {
      const accountSid = document.getElementById('twilioAccountSid').value.trim();
      const authToken = document.getElementById('twilioAuthToken').value.trim();
      const status = document.getElementById('twilioStatus');

      if (!accountSid || !authToken) {
        showStatus('step1Status', 'error', 'Please enter both Account SID and Auth Token');
        return;
      }

      if (!accountSid.startsWith('AC')) {
        showStatus('step1Status', 'error', 'Account SID must start with "AC"');
        return;
      }

      status.innerHTML = 'Connecting...';
      status.style.display = 'inline-flex';

      try {
        const response = await fetch('/api/tutorial-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'validateCredentials',
            accountSid,
            authToken
          })
        });

        const data = await response.json();

        if (data.success) {
          twilioCredentials = { accountSid, authToken };
          twilioConnected = true;

          status.innerHTML = `<span class="live-indicator"></span> Connected: ${data.account.friendlyName}`;
          status.style.background = '#d4edda';
          status.style.color = '#155724';

          showStatus('step1Status', 'success', '‚úÖ Twilio account connected successfully!');
          checkStep1Complete();
        } else {
          throw new Error(data.error);
        }
      } catch (error) {
        status.innerHTML = '‚ùå Connection failed';
        status.style.background = '#f8d7da';
        status.style.color = '#721c24';

        let errorMsg = error.message;
        if (errorMsg.includes('authenticate')) {
          errorMsg += '<br><br>üí° <strong>Try these solutions:</strong><br>' +
                      '‚Ä¢ Double-check your Account SID and Auth Token<br>' +
                      '‚Ä¢ Copy credentials directly from <a href="https://console.twilio.com" target="_blank">Twilio Console</a><br>' +
                      '‚Ä¢ Try using API Key instead (select from dropdown)<br>' +
                      '‚Ä¢ Use Demo Mode to explore without credentials';
        }

        showStatus('step1Status', 'error', 'Failed to connect: ' + errorMsg);
      }
    }

    async function connectTwilioWithApiKey() {
      const accountSid = document.getElementById('twilioAccountSidKey').value.trim();
      const apiKeySid = document.getElementById('twilioApiKeySid').value.trim();
      const apiKeySecret = document.getElementById('twilioApiKeySecret').value.trim();
      const status = document.getElementById('twilioStatus');

      if (!accountSid || !apiKeySid || !apiKeySecret) {
        showStatus('step1Status', 'error', 'Please enter Account SID, API Key SID, and API Key Secret');
        return;
      }

      if (!accountSid.startsWith('AC')) {
        showStatus('step1Status', 'error', 'Account SID must start with "AC"');
        return;
      }

      if (!apiKeySid.startsWith('SK')) {
        showStatus('step1Status', 'error', 'API Key SID must start with "SK"');
        return;
      }

      status.innerHTML = 'Connecting with API Key...';
      status.style.display = 'inline-flex';

      try {
        const response = await fetch('/api/tutorial-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'validateCredentials',
            accountSid,
            authToken: apiKeySecret,  // API Key Secret used as auth token
            apiKey: apiKeySid
          })
        });

        const data = await response.json();

        if (data.success) {
          twilioCredentials = { accountSid, authToken: apiKeySecret, apiKey: apiKeySid };
          twilioConnected = true;

          status.innerHTML = `<span class="live-indicator"></span> Connected with API Key: ${data.account.friendlyName}`;
          status.style.background = '#d4edda';
          status.style.color = '#155724';

          showStatus('step1Status', 'success', '‚úÖ Twilio account connected with API Key (more secure)!');
          checkStep1Complete();
        } else {
          throw new Error(data.error);
        }
      } catch (error) {
        status.innerHTML = '‚ùå Connection failed';
        status.style.background = '#f8d7da';
        status.style.color = '#721c24';
        showStatus('step1Status', 'error', 'Failed to connect: ' + error.message + '<br><br>Make sure your API Key is active and has the correct permissions.');
      }
    }

    function connectDemoMode() {
      const status = document.getElementById('twilioStatus');

      status.innerHTML = '<span class="live-indicator"></span> Demo Mode Active';
      status.style.background = '#fff3cd';
      status.style.color = '#856404';
      status.style.display = 'inline-flex';

      // Set demo credentials
      twilioCredentials = {
        accountSid: 'ACdemo123456789012345678901234567890',
        authToken: 'demo_token',
        demoMode: true
      };
      twilioConnected = true;

      // Auto-connect OpenAI in demo mode
      connectOpenAI();

      // Show demo mode banner
      showDemoModeBanner();

      showStatus('step1Status', 'success', '‚úÖ Demo Mode activated! You can explore the workshop with simulated data.');
    }

    async function connectOpenAI() {
      const apiKey = document.getElementById('openaiKey').value.trim();
      const status = document.getElementById('openaiStatus');

      // Handle demo mode
      if (twilioCredentials?.demoMode) {
        openaiApiKey = 'sk-demo-key-for-workshop';
        openaiConnected = true;

        status.innerHTML = '<span class="live-indicator"></span> Demo API Key Active';
        status.style.display = 'inline-flex';
        status.style.background = '#d4edda';
        status.style.color = '#155724';

        showStatus('step1Status', 'success', '‚úÖ Demo OpenAI API key configured!');
        checkStep1Complete();
        return;
      }

      if (!apiKey) {
        showStatus('step1Status', 'error', 'Please enter your OpenAI API key');
        return;
      }

      if (!apiKey.startsWith('sk-')) {
        showStatus('step1Status', 'error', 'Invalid OpenAI API key format');
        return;
      }

      status.innerHTML = 'Validating...';
      status.style.display = 'inline-flex';

      // Store API key (would validate in production)
      openaiApiKey = apiKey;
      openaiConnected = true;

      status.innerHTML = '<span class="live-indicator"></span> API Key Saved';
      status.style.background = '#d4edda';
      status.style.color = '#155724';

      showStatus('step1Status', 'success', '‚úÖ OpenAI API key configured!');
      checkStep1Complete();
    }

    function checkStep1Complete() {
      if (twilioConnected && openaiConnected) {
        document.getElementById('nextBtn1').disabled = false;
        showStatus('step1Status', 'success', 'üéâ All accounts connected! Click Next to continue.');
      }
    }

    // =========================================================================
    // STEP 2: DIRECTION - Choose Call Direction
    // =========================================================================

    function renderStep2_Direction() {
      return `
        <div class="step-content active">
          <div class="step-header">
            <h2>Step 2: Choose Your Call Direction</h2>
            <p>Will you be making outbound calls or receiving inbound calls?</p>
          </div>

          <div class="instructions">
            <h3>üìã Choose Your Path</h3>
            <p>Select how you want to use your Voice AI bot. We'll start simple, then add AI capabilities!</p>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 30px 0;">
            <!-- Outbound Calls -->
            <div class="service-card" onclick="selectCallDirection('outbound')" style="cursor: pointer; border: 3px solid transparent; transition: all 0.3s;" id="outboundCard">
              <div style="text-align: center; margin-bottom: 15px;">
                <div style="font-size: 64px;">üìû</div>
                <h3 style="margin: 10px 0; color: #0d122b;">Outbound Calls</h3>
              </div>
              <p style="margin-bottom: 15px; line-height: 1.6;">
                <strong>You initiate the call</strong> - Perfect for:
              </p>
              <ul style="margin: 0 0 15px 20px; line-height: 1.8; font-size: 14px;">
                <li>Recruiting candidate outreach</li>
                <li>Customer follow-ups</li>
                <li>Survey campaigns</li>
                <li>Appointment reminders</li>
              </ul>
              <div style="background: #e7f5ff; padding: 10px; border-radius: 4px; margin-top: 15px;">
                <strong>You'll use:</strong> <code>&lt;Dial&gt;</code> TwiML verb
              </div>
            </div>

            <!-- Inbound Calls -->
            <div class="service-card" onclick="selectCallDirection('inbound')" style="cursor: pointer; border: 3px solid transparent; transition: all 0.3s;" id="inboundCard">
              <div style="text-align: center; margin-bottom: 15px;">
                <div style="font-size: 64px;">üì≤</div>
                <h3 style="margin: 10px 0; color: #0d122b;">Inbound Calls</h3>
              </div>
              <p style="margin-bottom: 15px; line-height: 1.6;">
                <strong>Customers call you</strong> - Perfect for:
              </p>
              <ul style="margin: 0 0 15px 20px; line-height: 1.8; font-size: 14px;">
                <li>Phone support hotline</li>
                <li>Lead qualification</li>
                <li>Order status inquiries</li>
                <li>24/7 virtual assistant</li>
              </ul>
              <div style="background: #e7f5ff; padding: 10px; border-radius: 4px; margin-top: 15px;">
                <strong>You'll use:</strong> <code>&lt;Say&gt;</code> + <code>&lt;Gather&gt;</code> TwiML
              </div>
            </div>
          </div>

          <div id="step2Status" class="status-box"></div>

          <div class="button-group">
            <button class="btn btn-secondary" onclick="prevStep()">‚Üê Back</button>
            <button class="btn btn-primary" id="nextBtn2" onclick="nextStep()" disabled>
              Next: Provision Services ‚Üí
            </button>
          </div>
        </div>
      `;
    }

    function selectCallDirection(direction) {
      callDirection = direction;
      callDirectionChosen = true;

      // Visual feedback
      document.getElementById('outboundCard').style.border = direction === 'outbound' ? '3px solid #F22F46' : '3px solid transparent';
      document.getElementById('outboundCard').style.transform = direction === 'outbound' ? 'scale(1.02)' : 'scale(1)';
      document.getElementById('inboundCard').style.border = direction === 'inbound' ? '3px solid #F22F46' : '3px solid transparent';
      document.getElementById('inboundCard').style.transform = direction === 'inbound' ? 'scale(1.02)' : 'scale(1)';

      document.getElementById('nextBtn2').disabled = false;

      const directionText = direction === 'outbound' ? 'outbound calls (you call them)' : 'inbound calls (they call you)';
      showStatus('step2Status', 'success', `‚úÖ Great! You'll build a bot for ${directionText}. Click Next to continue.`);
      updateProgressBar();
    }

    // =========================================================================
    // STEP 3: SERVICES - Provision Twilio Services
    // =========================================================================

    function renderStep3_Services() {
      return `
        <div class="step-content active">
          <div class="step-header">
            <h2>Step 3: Provision Required Services</h2>
            <p>Let's set up the Twilio services you need for Voice ${callDirection === 'outbound' ? 'Outbound' : 'Inbound'}</p>
          </div>

          <div class="instructions">
            <h3>üìã Required Services</h3>
            <p>We'll check your account and provision any missing services automatically.</p>
            <p style="margin-top: 15px;">
              üìö <strong>Documentation:</strong>
              <a href="https://www.twilio.com/docs/phone-numbers" target="_blank">Phone Numbers</a> |
              <a href="https://www.twilio.com/docs/messaging/services" target="_blank">Messaging Services</a> |
              <a href="https://www.twilio.com/docs/sync" target="_blank">Sync</a> |
              <a href="https://www.twilio.com/docs/voice/intelligence" target="_blank">Conversational Intelligence</a>
            </p>
          </div>

          <div id="servicesContainer">
            <div style="text-align: center; padding: 40px;">
              <div style="font-size: 48px; margin-bottom: 20px;">‚è≥</div>
              <p>Checking your Twilio account...</p>
            </div>
          </div>

          <div id="step3Status" class="status-box"></div>

          <div class="button-group">
            <button class="btn btn-secondary" onclick="prevStep()">‚Üê Back</button>
            <button class="btn btn-primary" id="nextBtn3" onclick="nextStep()" disabled>
              Next: Create Basic TwiML ‚Üí
            </button>
          </div>
        </div>
      `;
    }

    async function loadServices() {
      // Handle demo mode
      if (twilioCredentials?.demoMode) {
        displayServices({
          phoneNumbers: [{ phoneNumber: '+1 (555) 123-4567', sid: 'PNdemo', friendlyName: 'Demo Number' }],
          messagingService: { sid: 'MGdemo', friendlyName: 'Demo Messaging Service' },
          syncService: { sid: 'ISdemo', friendlyName: 'Demo Sync Service' },
          conversationalIntelligence: true
        });
        return;
      }

      try {
        const response = await fetch('/api/tutorial-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'setupComplete',
            ...twilioCredentials
          })
        });

        const data = await response.json();

        if (data.success) {
          displayServices(data.setup);
        }
      } catch (error) {
        showStatus('step2Status', 'error', 'Failed to load services: ' + error.message);
      }
    }

    function displayServices(setup) {
      const container = document.getElementById('servicesContainer');

      const hasPhone = setup.phoneNumbers && setup.phoneNumbers.length > 0;
      const hasMessaging = !!setup.messagingService;
      const hasSync = !!setup.syncService;
      const hasCI = setup.conversationalIntelligence;

      container.innerHTML = `
        <div class="service-card">
          <h4>üìû Phone Number</h4>
          <p style="font-size: 13px; color: #666; margin-bottom: 10px;">
            Required for making and receiving voice calls
          </p>
          ${hasPhone ? `
            <div style="margin-bottom: 15px;">
              <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #4fc1ff;">
                Select a phone number for this project:
              </label>
              <select id="phoneNumberSelect" style="width: 100%; padding: 10px; background: #1e1e1e; color: #abb2bf; border: 1px solid #3e4451; border-radius: 4px; font-size: 14px;" onchange="selectPhoneNumber()">
                <option value="">-- Select a phone number --</option>
                ${setup.phoneNumbers.map(num => `
                  <option value="${num.sid}" data-number="${num.phoneNumber}">
                    ${num.phoneNumber} ${num.friendlyName ? '(' + num.friendlyName + ')' : ''}
                  </option>
                `).join('')}
              </select>
            </div>
            <div style="text-align: center; margin: 10px 0;">
              <span style="color: #666;">OR</span>
            </div>
          ` : ''}
          <button class="btn btn-${hasPhone ? 'secondary' : 'primary'}" onclick="provisionPhone()">
            ${hasPhone ? 'üìû Purchase New Number' : 'üìû Purchase Number'}
          </button>
          <div id="selectedNumberDisplay" style="margin-top: 15px; padding: 10px; background: #2c313c; border-radius: 4px; display: none;">
            <strong style="color: #4fc1ff;">Selected:</strong>
            <span id="selectedNumberText" style="color: #98c379; margin-left: 10px;"></span>
          </div>
        </div>

        <div class="service-card">
          <h4>üí¨ Messaging Service</h4>
          <p style="font-size: 13px; color: #666; margin-bottom: 10px;">
            Required for SMS notifications and multi-channel communication
          </p>
          <div class="service-status">
            <span>${hasMessaging ? '‚úÖ Configured' : '‚ùå Required'}</span>
            ${!hasMessaging ? '<button class="btn btn-primary" onclick="provisionMessaging()">Create Service</button>' : ''}
          </div>
        </div>

        <div class="service-card">
          <h4>üîÑ Sync Service (Optional)</h4>
          <p style="font-size: 13px; color: #666; margin-bottom: 10px;">
            Do you want to add Twilio Sync services to persist state during the conversation with the AI bot?
          </p>
          <div class="service-status">
            <span>${hasSync ? '‚úÖ Configured' : (syncServiceSkipped ? '‚ö™ Skipped' : '‚ö†Ô∏è Optional')}</span>
            ${!hasSync && !syncServiceSkipped ? `
              <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="provisionSync()">Yes, Enable Sync</button>
                <button class="btn btn-secondary" onclick="skipSync()">No, Skip This</button>
              </div>
            ` : ''}
          </div>
        </div>

        <div class="service-card">
          <h4>üß† Conversational Intelligence</h4>
          <p style="font-size: 13px; color: #666; margin-bottom: 10px;">
            Advanced AI analytics and insights (contact Twilio Sales to enable)
          </p>
          <div class="service-status">
            <span>${hasCI ? '‚úÖ Available' : '‚ö†Ô∏è Optional'}</span>
          </div>
        </div>
      `;

      // Store phone numbers for selection
      window.availablePhoneNumbers = setup.phoneNumbers || [];

      // Check if minimum services are ready (Sync is now optional)
      // Note: Phone number must be explicitly selected by user
      if (hasMessaging && (hasSync || syncServiceSkipped)) {
        if (selectedPhoneNumber) {
          servicesReady = true;
          document.getElementById('nextBtn3').disabled = false;
          showStatus('step3Status', 'success', 'üéâ All required services are ready!');
          updateProgressBar();
        } else if (hasPhone) {
          showStatus('step3Status', 'info', '‚ÑπÔ∏è Please select a phone number or purchase a new one to continue.');
        }
      }
    }

    function selectPhoneNumber() {
      const select = document.getElementById('phoneNumberSelect');
      const selectedOption = select.options[select.selectedIndex];

      if (selectedOption.value) {
        selectedPhoneNumber = selectedOption.getAttribute('data-number');

        // Show selected number
        document.getElementById('selectedNumberDisplay').style.display = 'block';
        document.getElementById('selectedNumberText').textContent = selectedPhoneNumber;

        // Re-check if all services are ready
        const hasMessaging = document.querySelector('.service-card:nth-child(2) .service-status span').textContent.includes('‚úÖ');
        const hasSync = document.querySelector('.service-card:nth-child(3) .service-status span').textContent.includes('‚úÖ');

        if (hasMessaging && (hasSync || syncServiceSkipped)) {
          servicesReady = true;
          document.getElementById('nextBtn3').disabled = false;
          showStatus('step3Status', 'success', 'üéâ All required services are ready!');
          updateProgressBar();
        }
      } else {
        selectedPhoneNumber = null;
        document.getElementById('selectedNumberDisplay').style.display = 'none';
        servicesReady = false;
        document.getElementById('nextBtn3').disabled = true;
      }
    }

    function skipSync() {
      syncServiceSkipped = true;
      showStatus('step3Status', 'info', '‚ÑπÔ∏è Sync service skipped. You can continue without state persistence.');
      loadServices();
    }

    async function provisionPhone() {
      if (twilioCredentials?.demoMode) {
        showStatus('step3Status', 'info', 'üìù Demo Mode: Simulating phone number provisioning...');
        setTimeout(() => {
          showStatus('step3Status', 'success', '‚úÖ Demo phone number provisioned!');
          loadServices();
        }, 1000);
        return;
      }

      const areaCode = prompt('Enter area code (e.g., 415, 212, 310):');
      if (!areaCode) return;

      showStatus('step3Status', 'info', 'Purchasing phone number...');

      try {
        const response = await fetch('/api/tutorial-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'provisionPhoneNumber',
            areaCode,
            ...twilioCredentials
          })
        });

        const data = await response.json();

        if (data.success) {
          const newNumber = data.phoneNumber.phoneNumber;
          showStatus('step3Status', 'success', `‚úÖ Purchased ${newNumber}!`);

          // Store the new number to auto-select it after reload
          window.newlyPurchasedNumber = newNumber;
          window.newlyPurchasedSid = data.phoneNumber.sid;

          await loadServices();

          // Auto-select the newly purchased number
          setTimeout(() => {
            const select = document.getElementById('phoneNumberSelect');
            if (select && window.newlyPurchasedSid) {
              select.value = window.newlyPurchasedSid;
              selectPhoneNumber();
              delete window.newlyPurchasedNumber;
              delete window.newlyPurchasedSid;
            }
          }, 500);
        } else {
          showStatus('step3Status', 'error', data.error);
        }
      } catch (error) {
        showStatus('step3Status', 'error', error.message);
      }
    }

    async function provisionMessaging() {
      if (twilioCredentials?.demoMode) {
        showStatus('step3Status', 'info', 'üìù Demo Mode: Simulating messaging service creation...');
        setTimeout(() => {
          showStatus('step3Status', 'success', '‚úÖ Demo messaging service created!');
          loadServices();
        }, 1000);
        return;
      }

      showStatus('step3Status', 'info', 'Creating messaging service...');

      try {
        const response = await fetch('/api/tutorial-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'createMessagingService',
            ...twilioCredentials
          })
        });

        const data = await response.json();

        if (data.success) {
          showStatus('step3Status', 'success', '‚úÖ Messaging service created!');
          loadServices();
        }
      } catch (error) {
        showStatus('step3Status', 'error', error.message);
      }
    }

    async function provisionSync() {
      if (twilioCredentials?.demoMode) {
        showStatus('step3Status', 'info', 'üìù Demo Mode: Simulating Sync service creation...');
        setTimeout(() => {
          showStatus('step3Status', 'success', '‚úÖ Demo Sync service created!');
          loadServices();
        }, 1000);
        return;
      }

      showStatus('step3Status', 'info', 'Creating Sync service...');

      try {
        const response = await fetch('/api/tutorial-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'createSyncService',
            ...twilioCredentials
          })
        });

        const data = await response.json();

        if (data.success) {
          showStatus('step3Status', 'success', '‚úÖ Sync service created!');
          loadServices();
        }
      } catch (error) {
        showStatus('step3Status', 'error', error.message);
      }
    }

    // =========================================================================
    // STEP 4: BASIC TWIML - Simple Dial or Receive
    // =========================================================================

    function renderStep4_BasicTwiML() {
      const isOutbound = callDirection === 'outbound';

      return `
        <div class="step-content active">
          <div class="step-header">
            <h2>Step 4: Create Basic ${isOutbound ? 'Dial' : 'Inbound'} TwiML</h2>
            <p>Let's start with simple voice calling before adding AI</p>
          </div>

          <div class="instructions">
            <h3>üìã Your Task</h3>
            ${isOutbound ? `
              <p>Create a simple <code>&lt;Dial&gt;</code> verb to connect calls to a phone number.</p>
              <p>This is the foundation - you'll upgrade this to AI in later steps!</p>
              <p style="margin-top: 15px;">
                üìö <strong>Documentation:</strong>
                <a href="https://www.twilio.com/docs/voice/twiml/dial" target="_blank">&lt;Dial&gt; Verb</a> |
                <a href="https://www.twilio.com/docs/voice/tutorials/how-to-make-outbound-phone-call" target="_blank">Making Calls</a>
              </p>
            ` : `
              <p>Create an interactive voice response with <code>&lt;Say&gt;</code> and <code>&lt;Gather&gt;</code>.</p>
              <p>This is the foundation - you'll upgrade this to AI in later steps!</p>
              <p style="margin-top: 15px;">
                üìö <strong>Documentation:</strong>
                <a href="https://www.twilio.com/docs/voice/twiml/say" target="_blank">&lt;Say&gt; Verb</a> |
                <a href="https://www.twilio.com/docs/voice/twiml/gather" target="_blank">&lt;Gather&gt; Verb</a> |
                <a href="https://www.twilio.com/docs/voice/tutorials/ivr-phone-tree-python" target="_blank">IVR Tutorial</a>
              </p>
            `}
          </div>

          ${isOutbound ? `
          <div class="service-card" style="background: linear-gradient(135deg, #e5c07b 0%, #2c313c 100%); padding: 20px; margin: 20px 0;">
            <h3 style="margin: 0 0 15px 0; color: white;">üéØ Configure Your IVR Message</h3>
            <p style="color: #e5e5e5; margin-bottom: 20px;">
              Customize the message and menu options for your Interactive Voice Response (IVR) system.
            </p>

            <div style="background: #1e1e1e; padding: 20px; border-radius: 6px;">
              <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #4fc1ff;">
                  üëã Greeting Message
                </label>
                <input type="text" id="ivrGreeting" placeholder="Hello world" value="Hello world"
                       style="width: 100%; padding: 12px; background: #2c313c; color: #abb2bf; border: 1px solid #3e4451; border-radius: 4px; font-size: 14px;"
                       oninput="updateIVRCode()">
                <p style="font-size: 12px; color: #666; margin: 5px 0 0 0;">What the caller hears first</p>
              </div>

              <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #4fc1ff;">
                  1Ô∏è‚É£ Option 1 Text
                </label>
                <input type="text" id="ivrOption1" placeholder="Press 1 to connect to God" value="Press 1 to connect to God"
                       style="width: 100%; padding: 12px; background: #2c313c; color: #abb2bf; border: 1px solid #3e4451; border-radius: 4px; font-size: 14px;"
                       oninput="updateIVRCode()">
                <p style="font-size: 12px; color: #666; margin: 5px 0 0 0;">Menu option for pressing 1</p>
              </div>

              <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #4fc1ff;">
                  2Ô∏è‚É£ Option 2 Text
                </label>
                <input type="text" id="ivrOption2" placeholder="Press 2 to connect to your mom" value="Press 2 to connect to your mom"
                       style="width: 100%; padding: 12px; background: #2c313c; color: #abb2bf; border: 1px solid #3e4451; border-radius: 4px; font-size: 14px;"
                       oninput="updateIVRCode()">
                <p style="font-size: 12px; color: #666; margin: 5px 0 0 0;">Menu option for pressing 2</p>
              </div>

              <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #4fc1ff;">
                  üó£Ô∏è Voice Type
                </label>
                <select id="ivrVoice" style="width: 100%; padding: 12px; background: #2c313c; color: #abb2bf; border: 1px solid #3e4451; border-radius: 4px; font-size: 14px;" onchange="updateIVRCode()">
                  <option value="Polly.Joanna">Joanna (Female, US English)</option>
                  <option value="Polly.Matthew">Matthew (Male, US English)</option>
                  <option value="Polly.Amy">Amy (Female, British)</option>
                  <option value="Polly.Brian">Brian (Male, British)</option>
                </select>
                <p style="font-size: 12px; color: #666; margin: 5px 0 0 0;">Choose the voice for text-to-speech</p>
              </div>
            </div>
          </div>
          ` : ''}

          <div class="code-editor">
            <div class="code-header">
              <span>üìù ${isOutbound ? 'IVR' : 'Inbound'} TwiML Handler</span>
              <div style="display: flex; gap: 10px;">
                <button class="btn-copy" onclick="copyCode('code4')">üìã Copy Code</button>
                <button class="btn btn-success" onclick="validateCode4()">‚úì Validate</button>
                <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 13px;" onclick="resetCode4()">Reset</button>
              </div>
            </div>

            <div style="margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 6px;">
              <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 13px;">Insert TwiML Snippet:</label>
              <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="insertTwiMLSnippet('say')">Say</button>
                <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="insertTwiMLSnippet('gather')">Gather</button>
                <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="insertTwiMLSnippet('dial')">Dial</button>
                <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="insertTwiMLSnippet('play')">Play</button>
                <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="insertTwiMLSnippet('record')">Record</button>
                <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="insertTwiMLSnippet('pause')">Pause</button>
                <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="insertTwiMLSnippet('redirect')">Redirect</button>
                <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="insertTwiMLSnippet('hangup')">Hangup</button>
              </div>
            </div>

            <textarea class="code-textarea" id="code4">${isOutbound ? `exports.handler = function(context, event, callback) {
  const twilio = require('twilio');
  const twiml = new twilio.twiml.VoiceResponse();

  // Dial a phone number to connect the call
  const dial = twiml.dial({
    timeout: 30,
    callerId: context.DEFAULT_TWILIO_NUMBER || '+1234567890'
  });
  dial.number('+15555551234');  // Replace with actual number

  // If no answer, say goodbye
  twiml.say('Sorry, no one is available. Goodbye!');

  callback(null, twiml);
};` : `exports.handler = function(context, event, callback) {
  const twilio = require('twilio');
  const twiml = new twilio.twiml.VoiceResponse();

  // Greet the caller
  twiml.say('Welcome to our service!');

  // Create a gather to collect input
  const gather = twiml.gather({
    numDigits: 1,
    action: '/handle-choice'
  });
  gather.say('Press 1 for sales, 2 for support.');

  callback(null, twiml);
};`}</textarea>
          </div>

          ${isOutbound ? `
          <div class="service-card" style="margin-top: 20px; background: linear-gradient(135deg, #98c379 0%, #2c313c 100%);">
            <h4 style="color: white; margin-bottom: 15px;">üìû Test Your IVR Live!</h4>
            <p style="color: #e5e5e5; margin-bottom: 15px;">
              Test your IVR by calling YOUR phone. You'll hear the greeting and menu, then it will dial the target number.
            </p>
            <div style="margin-bottom: 15px;">
              <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #4fc1ff;">
                Your Phone Number (to receive test call):
              </label>
              <input type="tel" id="testCallNumber" placeholder="+12345678901"
                     style="width: 100%; padding: 12px; background: #2c313c; color: #abb2bf; border: 1px solid #3e4451; border-radius: 4px; font-size: 14px;">
              <p style="font-size: 12px; color: #666; margin: 5px 0 0 0;">Enter YOUR number to receive the test call</p>
            </div>
            <button class="btn btn-primary" onclick="makeLiveTestCall()" style="width: 100%; background: white; color: #2c313c; font-weight: 600;">
              üìû Make Live Test Call
            </button>
            <div id="liveTestStatus" style="margin-top: 15px;"></div>
          </div>
          ` : ''}

          <div id="step4Status" class="status-box"></div>

          <div class="button-group">
            <button class="btn btn-secondary" onclick="prevStep()">‚Üê Back</button>
            <button class="btn btn-primary" id="nextBtn4" onclick="nextStep()" disabled>
              Next: Deploy to Your Account ‚Üí
            </button>
          </div>
        </div>
      `;
    }

    function testCode4() {
      const code = document.getElementById('code4').value;
      const consoleEl = document.getElementById('console4');
      const isOutbound = callDirection === 'outbound';

      try {
        // Extract phone number if present
        const numberMatch = code.match(/dial\.number\(['"]([^'"]+)['"]\)|twiml\.dial\(['"]([^'"]+)['"]\)/);
        const phoneNumber = numberMatch ? (numberMatch[1] || numberMatch[2]) : null;

        // Extract timeout
        const timeoutMatch = code.match(/timeout:\s*(\d+)/);
        const timeout = timeoutMatch ? timeoutMatch[1] : '30';

        // Extract machine detection
        const mdMatch = code.match(/machineDetection:\s*['"]([^'"]+)['"]/);
        const machineDetection = mdMatch ? mdMatch[1] : 'none';

        // Simulate the function execution
        let output = `<div class="console-line">üìû Testing TwiML generation...</div>`;
        output += `<div class="console-line" style="color: #4fc1ff;">‚úì TwiML Response created</div>`;

        if (isOutbound) {
          output += `<div class="console-line" style="color: #98c379;">‚úì Dial verb configured</div>`;

          if (phoneNumber) {
            output += `<div class="console-line">  ‚Üí Target: ${phoneNumber}</div>`;
          } else {
            output += `<div class="console-line" style="color: #e5c07b;">  ‚ö†Ô∏è No target number specified yet</div>`;
          }

          if (timeout !== '30') {
            output += `<div class="console-line">  ‚Üí Timeout: ${timeout} seconds</div>`;
          }

          if (machineDetection !== 'none') {
            output += `<div class="console-line">  ‚Üí Machine Detection: ${machineDetection}</div>`;
          }

          output += `<div class="console-line" style="color: #666; margin-top: 10px;">Expected TwiML output:</div>`;
          output += `<div class="console-line" style="color: #666;">&lt;Response&gt;</div>`;
          output += `<div class="console-line" style="color: #666;">  &lt;Dial${timeout !== '30' ? ' timeout="' + timeout + '"' : ''}${machineDetection !== 'none' ? ' machineDetection="' + machineDetection + '"' : ''}&gt;</div>`;
          if (phoneNumber) {
            output += `<div class="console-line" style="color: #666;">    &lt;Number&gt;${phoneNumber}&lt;/Number&gt;</div>`;
          }
          output += `<div class="console-line" style="color: #666;">  &lt;/Dial&gt;</div>`;
          output += `<div class="console-line" style="color: #666;">&lt;/Response&gt;</div>`;
        } else {
          output += `<div class="console-line" style="color: #98c379;">Expected: Caller will hear IVR menu</div>`;
        }

        consoleEl.innerHTML = output;
      } catch (error) {
        consoleEl.innerHTML = `<div class="console-line" style="color: #e06c75;">Error: ${error.message}</div>`;
      }
    }

    function insertTwiMLSnippet(type) {
      const textarea = document.getElementById('code4');
      const cursorPos = textarea.selectionStart;
      const textBefore = textarea.value.substring(0, cursorPos);
      const textAfter = textarea.value.substring(cursorPos);

      const snippets = {
        say: `twiml.say('Your message here');`,
        gather: `const gather = twiml.gather({
    numDigits: 1,
    action: '/handle-input'
  });
  gather.say('Press 1 for sales, 2 for support.');`,
        dial: `const dial = twiml.dial({
    timeout: 30,
    callerId: context.DEFAULT_TWILIO_NUMBER
  });
  dial.number('+15555551234');`,
        play: `twiml.play('https://example.com/audio.mp3');`,
        record: `twiml.record({
    maxLength: 30,
    action: '/handle-recording',
    transcribe: true
  });`,
        pause: `twiml.pause({ length: 2 });`,
        redirect: `twiml.redirect('/another-handler');`,
        hangup: `twiml.hangup();`
      };

      const snippet = snippets[type];
      if (snippet) {
        // Insert snippet at cursor
        textarea.value = textBefore + '\n  ' + snippet + '\n' + textAfter;

        // Move cursor to end of inserted snippet
        const newCursorPos = cursorPos + snippet.length + 3;
        textarea.setSelectionRange(newCursorPos, newCursorPos);
        textarea.focus();
      }
    }

    function validateCode4() {
      const code = document.getElementById('code4').value;
      const isOutbound = callDirection === 'outbound';
      const isDemoMode = twilioCredentials?.demoMode === true;

      const hasSayVerb = code.includes('twiml.say(') || code.includes('.say(');
      const hasGatherVerb = code.includes('twiml.gather(') || code.includes('.gather(');
      const hasHangupVerb = code.includes('twiml.hangup(') || code.includes('.hangup(');

      // In demo mode, validate code syntax but be more lenient
      if (isDemoMode) {
        // Check for basic syntax errors only
        if (code.includes('exports.handler') && code.includes('callback')) {
          basicTwimlCreated = true;
          document.getElementById('nextBtn4').disabled = false;
          if (hasSayVerb && hasGatherVerb) {
            showStatus('step4Status', 'success', '‚úÖ Perfect! Your IVR code looks good.');
          } else if (!hasSayVerb) {
            showStatus('step4Status', 'warning', '‚ö†Ô∏è Consider adding twiml.say() to greet the caller. Click Next to continue anyway.');
          } else if (!hasGatherVerb) {
            showStatus('step4Status', 'warning', '‚ö†Ô∏è Consider adding twiml.gather() to collect input. Click Next to continue anyway.');
          }
          updateProgressBar();
        } else {
          showStatus('step4Status', 'error', '‚ùå Code structure invalid. Check for exports.handler and callback.');
        }
      } else {
        // Live mode: strict validation
        if (hasSayVerb && hasGatherVerb) {
          basicTwimlCreated = true;
          document.getElementById('nextBtn4').disabled = false;
          showStatus('step4Status', 'success', '‚úÖ Perfect! Your IVR is ready. Click "Test Your IVR Live!" to try it!');
          updateProgressBar();
        } else if (!hasSayVerb) {
          showStatus('step4Status', 'error', '‚ùå Missing Say verb. Use twiml.say() to greet the caller.');
        } else if (!hasGatherVerb) {
          showStatus('step4Status', 'error', '‚ùå Missing Gather verb. Use twiml.gather() to collect input.');
        }
      }
    }

    function updateIVRCode() {
      if (callDirection !== 'outbound') return;

      const greeting = document.getElementById('ivrGreeting')?.value || 'Hello world';
      const option1 = document.getElementById('ivrOption1')?.value || 'Press 1 to connect to God';
      const option2 = document.getElementById('ivrOption2')?.value || 'Press 2 to connect to your mom';
      const voice = document.getElementById('ivrVoice')?.value || 'Polly.Joanna';

      // Generate simple IVR code (Say + Gather only, no Dial)
      const code = `exports.handler = function(context, event, callback) {
  const twilio = require('twilio');
  const twiml = new twilio.twiml.VoiceResponse();

  // Play greeting and IVR menu to the caller
  twiml.say('${greeting}', { voice: '${voice}' });

  // Create a menu with Gather
  const gather = twiml.gather({
    numDigits: 1,
    timeout: 10
  });

  gather.say('${option1}. ${option2}.', { voice: '${voice}' });

  // After gather timeout, say goodbye and hang up
  twiml.say('Goodbye!', { voice: '${voice}' });
  twiml.hangup();

  callback(null, twiml);
};`;

      // Update the textarea
      const codeEditor = document.getElementById('code4');
      if (codeEditor) {
        codeEditor.value = code;
      }
    }

    async function makeLiveTestCall() {
      // Get YOUR number (to receive the test call)
      const yourNumber = document.getElementById('testCallNumber')?.value?.trim();

      if (!yourNumber) {
        document.getElementById('liveTestStatus').innerHTML =
          '<div style="color: #e06c75; padding: 10px; background: #2c313c; border-radius: 4px;">‚ùå Please enter your phone number to receive the test call</div>';
        return;
      }

      if (!yourNumber.startsWith('+')) {
        document.getElementById('liveTestStatus').innerHTML =
          '<div style="color: #e5c07b; padding: 10px; background: #2c313c; border-radius: 4px;">‚ö†Ô∏è Your number must use E.164 format (e.g., +1234567890)</div>';
        return;
      }

      // Get the IVR TwiML from the code editor
      const code = document.getElementById('code4')?.value || '';

      // Extract greeting for display
      const greetingMatch = code.match(/twiml\.say\(['"]([^'"]+)['"]/);
      const greeting = greetingMatch ? greetingMatch[1] : 'Hello world';

      console.log('makeLiveTestCall - twilioCredentials:', twilioCredentials);
      console.log('makeLiveTestCall - demoMode:', twilioCredentials?.demoMode);

      // Demo mode simulation
      if (twilioCredentials?.demoMode === true) {
        document.getElementById('liveTestStatus').innerHTML =
          '<div style="color: #4fc1ff; padding: 10px; background: #2c313c; border-radius: 4px;">üìû Demo Mode: Simulating call...</div>';

        setTimeout(() => {
          document.getElementById('liveTestStatus').innerHTML = `
            <div style="color: #98c379; padding: 15px; background: #2c313c; border-radius: 4px;">
              <strong>‚úÖ Demo call completed successfully!</strong><br>
              <div style="margin-top: 10px; font-size: 13px; line-height: 1.6;">
                üì± CallSid: CA_demo_${Date.now()}<br>
                üìû Calling: ${yourNumber}
              </div>
              <div style="margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 4px; font-size: 12px;">
                <strong>What would happen in live mode:</strong><br>
                1. Your phone (${yourNumber}) would ring<br>
                2. Answer it and you'd hear: "${greeting}"<br>
                3. You'd hear the menu options<br>
                4. Press 1 or 2 to test Gather, or wait 10 seconds<br>
                5. Call ends with "Goodbye!" and hangs up
              </div>
            </div>
          `;
        }, 2000);
        return;
      }

      document.getElementById('liveTestStatus').innerHTML =
        '<div style="color: #4fc1ff; padding: 10px; background: #2c313c; border-radius: 4px;">üìû Initiating call...</div>';

      try {
        const response = await fetch('/api/tutorial-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'makeCall',
            to: yourNumber,
            from: selectedPhoneNumber,
            ivrTwiml: code, // TwiML will play greeting, gather, then hangup
            ...twilioCredentials
          })
        });

        const data = await response.json();

        if (data.success) {
          document.getElementById('liveTestStatus').innerHTML = `
            <div style="color: #98c379; padding: 15px; background: #2c313c; border-radius: 4px;">
              <strong>‚úÖ Call initiated successfully!</strong><br>
              <div style="margin-top: 10px; font-size: 13px; line-height: 1.6;">
                üì± CallSid: ${data.callSid}<br>
                üìû Calling: ${yourNumber}
              </div>
              <div style="margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 4px; font-size: 12px;">
                <strong>What happens next:</strong><br>
                1. Your phone (${yourNumber}) will ring<br>
                2. Answer it and you'll hear: "${greeting}"<br>
                3. You'll hear the menu options<br>
                4. Press 1 or 2 to test Gather, or wait 10 seconds<br>
                5. Call ends with "Goodbye!" and hangs up
              </div>
            </div>
          `;
        } else {
          document.getElementById('liveTestStatus').innerHTML =
            `<div style="color: #e06c75; padding: 10px; background: #2c313c; border-radius: 4px;">‚ùå Call failed: ${data.error}</div>`;
        }
      } catch (error) {
        document.getElementById('liveTestStatus').innerHTML =
          `<div style="color: #e06c75; padding: 10px; background: #2c313c; border-radius: 4px;">‚ùå Error: ${error.message}</div>`;
      }
    }

    function resetCode4() {
      const isOutbound = callDirection === 'outbound';
      document.getElementById('code4').value = isOutbound ? `exports.handler = function(context, event, callback) {
  const twilio = require('twilio');
  const twiml = new twilio.twiml.VoiceResponse();

  // Dial a phone number to connect the call
  const dial = twiml.dial({
    timeout: 30,
    callerId: context.DEFAULT_TWILIO_NUMBER || '+1234567890'
  });
  dial.number('+15555551234');  // Replace with actual number

  // If no answer, say goodbye
  twiml.say('Sorry, no one is available. Goodbye!');

  callback(null, twiml);
};` : `exports.handler = function(context, event, callback) {
  const twilio = require('twilio');
  const twiml = new twilio.twiml.VoiceResponse();

  // Greet the caller
  twiml.say('Welcome to our service!');

  // Create a gather to collect input
  const gather = twiml.gather({
    numDigits: 1,
    action: '/handle-choice'
  });
  gather.say('Press 1 for sales, 2 for support.');

  callback(null, twiml);
};`;
      document.getElementById('console4').innerHTML = '';
      document.getElementById('step4Status').innerHTML = '';
    }

    // =========================================================================
    // STEP 8: TOOLING & KNOWLEDGE BASE - Add Functions and Context
    // =========================================================================

    function renderStep8_Tooling() {
      return `
        <div class="step-content active">
          <div class="step-header">
            <h2>Step 8: Add Tooling & Knowledge Base (Optional)</h2>
            <p>Enhance your AI with custom functions and domain knowledge</p>
          </div>

          <div class="instructions">
            <h3>üõ†Ô∏è What This Step Covers</h3>
            <p>Before we move to AI-powered conversations, you can optionally add:</p>
            <ul style="margin-left: 20px; line-height: 1.8;">
              <li><strong>Tools/Functions</strong> - Let your AI take actions (check calendar, book appointments, look up data)</li>
              <li><strong>Knowledge Base</strong> - Give your AI context about your business, products, or services</li>
            </ul>
            <p style="margin-top: 15px;">
              üìö <strong>Documentation:</strong>
              <a href="https://platform.openai.com/docs/guides/function-calling" target="_blank">OpenAI Function Calling</a> |
              <a href="https://platform.openai.com/docs/assistants/tools" target="_blank">AI Tools</a>
            </p>
          </div>

          <div class="service-card" style="background: linear-gradient(135deg, #61afef 0%, #2c313c 100%);">
            <h3 style="color: white; margin-bottom: 15px;">üîß Example: Booking Tool</h3>
            <p style="color: #e5e5e5;">Here's starter code for a simple appointment booking function:</p>
          </div>

          <div class="code-editor">
            <div class="code-header">
              <span>üìù Example Tool Definition</span>
              <div style="display: flex; gap: 10px;">
                <button class="btn-copy" onclick="copyCode('code5')">üìã Copy Code</button>
              </div>
            </div>
            <textarea class="code-textarea" id="code5" rows="20">const tools = [
  {
    type: "function",
    name: "check_availability",
    description: "Check available appointment slots for a given date",
    parameters: {
      type: "object",
      properties: {
        date: {
          type: "string",
          description: "Date to check (YYYY-MM-DD format)"
        },
        duration: {
          type: "number",
          description: "Appointment duration in minutes"
        }
      },
      required: ["date"]
    }
  },
  {
    type: "function",
    name: "book_appointment",
    description: "Book an appointment for a customer",
    parameters: {
      type: "object",
      properties: {
        date: {
          type: "string",
          description: "Appointment date (YYYY-MM-DD)"
        },
        time: {
          type: "string",
          description: "Appointment time (HH:MM format)"
        },
        customerName: {
          type: "string",
          description: "Customer's name"
        },
        phone: {
          type: "string",
          description: "Customer's phone number"
        }
      },
      required: ["date", "time", "customerName", "phone"]
    }
  }
];

// Example knowledge base context
const knowledgeBase = \`
Company: Acme Healthcare
Services: Primary care, vaccinations, annual checkups
Hours: Mon-Fri 9am-5pm, Sat 10am-2pm
Location: 123 Main St, San Francisco CA
Insurance: We accept Blue Cross, Aetna, UnitedHealthcare
\`;

// You'll use these in your AI configuration
const systemPrompt = \`You are a helpful medical receptionist for Acme Healthcare.
Use the tools available to check availability and book appointments.

\${knowledgeBase}

Be friendly, professional, and efficient.\`;</textarea>
          </div>

          <div class="service-card" style="background: linear-gradient(135deg, #98c379 0%, #2c313c 100%); margin-top: 20px;">
            <h4 style="color: white;">üí° Pro Tips</h4>
            <ul style="color: #e5e5e5; line-height: 1.8;">
              <li>Start simple - add 1-2 tools max to begin</li>
              <li>Test each tool function separately before integrating</li>
              <li>Use descriptive names and clear parameter descriptions</li>
              <li>Keep knowledge base concise and focused</li>
            </ul>
          </div>

          <div class="button-group" style="margin-top: 30px;">
            <button class="btn btn-secondary" onclick="prevStep()">‚Üê Back</button>
            <button class="btn btn-secondary" onclick="skipTooling()" style="margin: 0 10px;">
              Skip This Step ‚Üí
            </button>
            <button class="btn btn-primary" onclick="saveToolingAndContinue()">
              Save & Continue ‚Üí
            </button>
          </div>

          <div id="step5Status" class="status-box"></div>
        </div>
      `;
    }

    function skipTooling() {
      showStatus('step5Status', 'info', '‚è≠Ô∏è Skipped tooling configuration. You can add this later!');
      setTimeout(() => {
        nextStep();
      }, 1000);
    }

    function saveToolingAndContinue() {
      const toolingCode = document.getElementById('code5')?.value || '';

      // Store in localStorage for later use
      try {
        localStorage.setItem('twilioVoiceAI_tooling', toolingCode);
        showStatus('step5Status', 'success', '‚úÖ Tooling configuration saved!');
        setTimeout(() => {
          nextStep();
        }, 1000);
      } catch (error) {
        showStatus('step5Status', 'error', `‚ùå Error saving: ${error.message}`);
      }
    }

    // =========================================================================
    // STEP 6: DEPLOY - Deploy to User's Twilio Account
    // =========================================================================

    function renderStep6_Deploy() {
      const isOutbound = callDirection === 'outbound';
      const code = document.getElementById('code4')?.value || '';

      return `
        <div class="step-content active">
          <div class="step-header">
            <h2>Step 5: Deploy to Your Twilio Account</h2>
            <p>Let's deploy your ${isOutbound ? 'Dial' : 'IVR'} function to Twilio Serverless</p>
          </div>

          <div class="instructions">
            <h3>üìã What This Does</h3>
            <p>We'll deploy your TwiML handler as a Twilio Function so it can handle real calls.</p>
            <p style="margin-top: 15px;">
              üìö <strong>Documentation:</strong>
              <a href="https://www.twilio.com/docs/serverless/functions-assets" target="_blank">Twilio Functions</a> |
              <a href="https://www.twilio.com/docs/serverless/api" target="_blank">Serverless API</a>
            </p>
          </div>

          <div class="service-card">
            <h4>üì¶ Deployment Details</h4>
            <p><strong>Function Name:</strong> <code>voice-handler</code></p>
            <p><strong>Runtime:</strong> Node.js 18</p>
            <p><strong>Handler Type:</strong> ${isOutbound ? 'Outbound Dial' : 'Inbound IVR'}</p>
          </div>

          <div class="code-preview">
            <div class="code-header">
              <span>üìù Code to Deploy</span>
            </div>
            <pre style="background: #1e1e1e; color: #abb2bf; padding: 15px; border-radius: 6px; overflow-x: auto;">${code}</pre>
          </div>

          <div class="button-group">
            <button class="btn btn-primary" onclick="deployFunction()" style="font-size: 16px; padding: 12px 24px;">
              üöÄ Deploy to My Account
            </button>
          </div>

          <div id="step5Status" class="status-box"></div>

          <div class="button-group">
            <button class="btn btn-secondary" onclick="prevStep()">‚Üê Back</button>
            <button class="btn btn-primary" id="nextBtn5" onclick="nextStep()" disabled>
              Next: Test Your Call ‚Üí
            </button>
          </div>
        </div>
      `;
    }

    async function deployFunction() {
      const code = document.getElementById('code4')?.value || '';

      if (twilioCredentials?.demoMode) {
        showStatus('step5Status', 'info', 'üìù Demo Mode: Simulating deployment...');
        setTimeout(() => {
          functionsDeployed = true;
          deployedServiceSid = 'ZS' + Math.random().toString(36).substring(7);
          showStatus('step5Status', 'success', '‚úÖ Demo deployment complete! Function URL: https://demo-1234.twil.io/voice-handler');
          document.getElementById('nextBtn5').disabled = false;
          updateProgressBar();
        }, 2000);
        return;
      }

      showStatus('step5Status', 'info', '‚è≥ Deploying to your Twilio account...');

      try {
        const response = await fetch('/api/tutorial-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'deployFunction',
            functionName: 'voice-handler',
            functionCode: code,
            ...twilioCredentials
          })
        });

        const data = await response.json();

        if (data.success) {
          functionsDeployed = true;
          deployedServiceSid = data.serviceSid;
          showStatus('step5Status', 'success', `‚úÖ Deployed! Function URL: ${data.functionUrl}`);
          document.getElementById('nextBtn5').disabled = false;
          updateProgressBar();
        } else {
          showStatus('step5Status', 'error', `‚ùå Deployment failed: ${data.error}`);
        }
      } catch (error) {
        showStatus('step5Status', 'error', `‚ùå ${error.message}`);
      }
    }

    // =========================================================================
    // STEP 5: TEST BASIC CALL - Test Without AI
    // =========================================================================

    function renderStep5_TestBasic() {
      const isOutbound = callDirection === 'outbound';

      return `
        <div class="step-content active">
          <div class="step-header">
            <h2>Step 6: Test Your ${isOutbound ? 'Outbound' : 'Inbound'} Call</h2>
            <p>Let's make sure your basic ${isOutbound ? 'Dial' : 'IVR'} is working</p>
          </div>

          <div class="instructions">
            <h3>üìã Testing Instructions</h3>
            ${isOutbound ? `
              <p>We'll initiate a call from your Twilio number to a destination number.</p>
              <p>Enter your phone number below to test the Dial functionality.</p>
            ` : `
              <p>Configure your Twilio phone number to use the deployed function.</p>
              <p>Then call your Twilio number to hear the IVR menu.</p>
            `}
          </div>

          ${isOutbound ? `
            <div class="service-card">
              <h4>üìû Make Test Call</h4>
              <div style="margin-top: 15px;">
                <label style="display: block; margin-bottom: 5px;">Your Phone Number:</label>
                <input type="tel" id="testPhoneNumber" placeholder="+1234567890"
                       style="width: 100%; padding: 10px; border: 1px solid #3e4451; background: #1e1e1e; color: #abb2bf; border-radius: 4px; font-size: 16px;">
              </div>
              <button class="btn btn-primary" onclick="makeTestCallStep6()" style="margin-top: 15px; width: 100%;">
                üìû Call Me Now
              </button>
            </div>
          ` : `
            <div class="service-card">
              <h4>üì≤ Configure Phone Number</h4>
              <p>Your deployed function URL has been configured automatically.</p>
              <p><strong>Call this number to test:</strong></p>
              <div id="twilioPhoneDisplay" style="font-size: 24px; font-weight: bold; margin: 15px 0; color: #4fc1ff;"></div>
              <button class="btn btn-secondary" onclick="confirmInboundTest()">
                ‚úì I Called and It Works
              </button>
            </div>
          `}

          <div id="step6Status" class="status-box"></div>

          <div class="button-group">
            <button class="btn btn-secondary" onclick="prevStep()">‚Üê Back</button>
            <button class="btn btn-primary" id="nextBtn6" onclick="nextStep()" disabled>
              Next: Build WebSocket Handler ‚Üí
            </button>
          </div>
        </div>
      `;
    }

    async function makeTestCallStep6() {
      const phoneNumber = document.getElementById('testPhoneNumber').value;

      if (!phoneNumber) {
        showStatus('step6Status', 'error', '‚ùå Please enter a phone number');
        return;
      }

      console.log('makeTestCallStep6 - twilioCredentials:', twilioCredentials);
      console.log('makeTestCallStep6 - demoMode:', twilioCredentials?.demoMode);

      if (twilioCredentials?.demoMode === true) {
        showStatus('step6Status', 'info', 'üìù Demo Mode: Simulating call...');
        setTimeout(() => {
          basicCallTested = true;
          showStatus('step6Status', 'success', '‚úÖ Demo call completed! (In real mode, your phone would ring)');
          document.getElementById('nextBtn6').disabled = false;
          updateProgressBar();
        }, 2000);
        return;
      }

      showStatus('step6Status', 'info', 'üìû Initiating call...');

      // Get the target number from Step 4 code
      const code = document.getElementById('code4')?.value || '';
      const targetMatch = code.match(/dial\.number\(['"]([^'"]+)['"]\)/);
      const targetNumber = targetMatch ? targetMatch[1] : null;

      if (!targetNumber) {
        showStatus('step6Status', 'error', '‚ùå No target number found in your code. Go back to Step 4 and set a target number.');
        return;
      }

      // Extract dial parameters from code
      const timeoutMatch = code.match(/timeout:\s*(\d+)/);
      const timeout = timeoutMatch ? timeoutMatch[1] : '30';

      const mdMatch = code.match(/machineDetection:\s*['"]([^'"]+)['"]/);
      const machineDetection = mdMatch ? mdMatch[1] : null;

      try {
        const response = await fetch('/api/tutorial-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'makeCall',
            to: phoneNumber,
            from: selectedPhoneNumber || twilioPhoneNumber,
            dialTarget: targetNumber,
            timeout: timeout,
            machineDetection: machineDetection,
            ...twilioCredentials
          })
        });

        const data = await response.json();

        if (data.success) {
          basicCallTested = true;
          showStatus('step6Status', 'success', `‚úÖ Call initiated! CallSid: ${data.callSid}. The call will dial ${targetNumber}.`);
          document.getElementById('nextBtn6').disabled = false;
          updateProgressBar();
        } else {
          showStatus('step6Status', 'error', `‚ùå Call failed: ${data.error}`);
        }
      } catch (error) {
        showStatus('step6Status', 'error', `‚ùå ${error.message}`);
      }
    }

    function confirmInboundTest() {
      basicCallTested = true;
      showStatus('step6Status', 'success', '‚úÖ Great! Your IVR is working. Ready for the next step!');
      document.getElementById('nextBtn6').disabled = false;
      updateProgressBar();
    }

    // =========================================================================
    // STEP 9: CONVERSATIONRELAY - Upgrade to AI (OLD STEP 3)
    // =========================================================================

    function renderStep9_ConversationRelay() {
      websocketUrl = `wss://${window.location.host}/tutorial-ws`;

      return `
        <div class="step-content active">
          <div class="step-header">
            <h2>Step 8: Upgrade to ConversationRelay (AI)</h2>
            <p>Replace your basic ${callDirection === 'outbound' ? 'Dial' : 'IVR'} with AI-powered conversation</p>
          </div>

          <div class="instructions">
            <h3>üìã Your Task</h3>
            <p>Complete the code below to create TwiML with ConversationRelay that connects to:</p>
            <code style="background: #1e1e1e; color: #4fc1ff; padding: 4px 8px; border-radius: 4px;">${websocketUrl}</code>
            <p style="margin-top: 15px;">
              üìö <strong>Documentation:</strong>
              <a href="https://www.twilio.com/docs/voice/twiml" target="_blank">TwiML Overview</a> |
              <a href="https://www.twilio.com/docs/voice/twiml/connect" target="_blank">&lt;Connect&gt; Verb</a> |
              <a href="https://www.twilio.com/docs/voice/twiml/connect/conversationrelay" target="_blank">ConversationRelay</a>
            </p>
          </div>

          <div class="service-card" style="background: linear-gradient(135deg, #4fc1ff 0%, #0d122b 100%); color: white; margin: 20px 0;">
            <h4 style="color: white; margin-bottom: 15px;">üéì What is ConversationRelay?</h4>
            <p style="margin-bottom: 15px; line-height: 1.6;">
              Explore how ConversationRelay works with this interactive visualization.
              See the real-time flow of events between Twilio, your WebSocket server, and the AI.
            </p>
            <button class="btn btn-primary" onclick="openPlayground()" style="background: white; color: #0d122b; border: none;">
              üìñ Learn How It Works
            </button>
            <p style="margin-top: 10px; font-size: 12px; opacity: 0.9;">
              Opens an interactive diagram to understand the architecture
            </p>
          </div>

          <div class="video-section">
            <h4>üì∫ Video Walkthrough</h4>
            <p>Watch a 2-minute walkthrough of building TwiML with ConversationRelay</p>
            <div class="video-container">
              <iframe src="https://www.youtube.com/embed/dQw4w9WgXcQ" frameborder="0" allowfullscreen></iframe>
            </div>
            <p style="margin-top: 10px; font-size: 12px; color: #666;">
              <em>Note: Replace with actual workshop video URL</em>
            </p>
          </div>

          <div class="code-editor">
            <div class="code-header">
              <span>üìù ConversationRelay TwiML Handler</span>
              <div style="display: flex; gap: 10px;">
                <button class="btn-copy" onclick="copyCode('code8')">üìã Copy Code</button>
                <button class="btn btn-test" onclick="testCode8()">‚ñ∂Ô∏è Test Code</button>
                <button class="btn btn-success" onclick="validateCode8()">‚úì Validate</button>
                <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 13px;" onclick="resetCode8()">Reset</button>
              </div>
            </div>
            <textarea class="code-textarea" id="code8">function createConversationRelayTwiML() {
  const twilio = require('twilio');
  const twiml = new twilio.twiml.VoiceResponse();

  // Create connect verb
  const connect = twiml.connect();

  // Add conversationRelay
  connect.conversationRelay({
    url: '${websocketUrl}',
    voice: 'Polly.Brian',
    language: 'en-US',
    transcriptionProvider: 'twilio',
    ttsProvider: 'amazon-polly'
  });

  return twiml.toString();
}</textarea>
          </div>

          <div class="console-output" id="console8"></div>

          <div id="step8Status" class="status-box"></div>

          <div class="button-group">
            <button class="btn btn-secondary" onclick="prevStep()">‚Üê Back</button>
            <button class="btn btn-primary" id="nextBtn8" onclick="nextStep()" disabled>
              Next: Test AI Voice Bot ‚Üí
            </button>
          </div>
        </div>
      `;
    }

    function testCode8() {
      const code = document.getElementById('code8').value;
      const console8 = document.getElementById('console8');

      try {
        // Simulate execution
        console8.innerHTML = `
          <div class="console-line">‚ñ∂Ô∏è Testing ConversationRelay TwiML generation...</div>
          <div class="console-line info">Expected WebSocket URL: ${websocketUrl}</div>
          <div class="console-line">Output:</div>
          <div class="console-line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div>
          <div class="console-line">&lt;Response&gt;</div>
          <div class="console-line">  &lt;Connect&gt;</div>
          <div class="console-line">    &lt;ConversationRelay</div>
          <div class="console-line">      url="${websocketUrl}"</div>
          <div class="console-line">      voice="Polly.Brian"</div>
          <div class="console-line">      transcriptionProvider="twilio"</div>
          <div class="console-line">      ttsProvider="amazon-polly"</div>
          <div class="console-line">    /&gt;</div>
          <div class="console-line">  &lt;/Connect&gt;</div>
          <div class="console-line">&lt;/Response&gt;</div>
        `;
      } catch (error) {
        console8.innerHTML = `<div class="console-line error">‚ùå ${error.message}</div>`;
      }
    }

    function validateCode8() {
      const code = document.getElementById('code8').value;

      const checks = {
        hasConnect: code.includes('.connect()'),
        hasConversationRelay: code.includes('conversationRelay'),
        hasUrl: code.includes(websocketUrl) || code.includes('url:'),
        hasVoice: code.includes('voice:') || code.includes('Polly'),
        hasTranscription: code.includes('transcriptionProvider'),
        hasTTS: code.includes('ttsProvider')
      };

      const allValid = Object.values(checks).every(v => v);

      if (allValid) {
        conversationRelayCreated = true;
        document.getElementById('nextBtn8').disabled = false;
        showStatus('step8Status', 'success', '‚úÖ Perfect! ConversationRelay TwiML is ready. Next we\'ll test it!');
        updateProgressBar();
      } else {
        const missing = [];
        if (!checks.hasConnect) missing.push('connect() method');
        if (!checks.hasConversationRelay) missing.push('conversationRelay()');
        if (!checks.hasUrl) missing.push('WebSocket URL');
        if (!checks.hasVoice) missing.push('voice parameter');
        if (!checks.hasTranscription) missing.push('transcriptionProvider');
        if (!checks.hasTTS) missing.push('ttsProvider');

        showStatus('step8Status', 'error', `‚ùå Missing: ${missing.join(', ')}`);
      }
    }

    function resetCode8() {
      document.getElementById('code8').value = `function createConversationRelayTwiML() {
  const twilio = require('twilio');
  const twiml = new twilio.twiml.VoiceResponse();

  // TODO: Create connect verb
  // const connect = twiml.connect();

  // TODO: Add conversationRelay with:
  // - url: '${websocketUrl}'
  // - voice: 'Polly.Brian'
  // - language: 'en-US'
  // - transcriptionProvider: 'twilio'
  // - ttsProvider: 'amazon-polly'

  return twiml.toString();
}`;
      document.getElementById('console8').innerHTML = '';
      document.getElementById('step8Status').innerHTML = '';
    }

    // =========================================================================
    // STEP 6: WEBSOCKET - Build WebSocket Handler (OLD STEP 4)
    // =========================================================================

    function renderStep6_WebSocket() {
      return `
        <div class="step-content active">
          <div class="step-header">
            <h2>Step 6: Build WebSocket Handler</h2>
            <p>Handle real-time conversation events from Twilio</p>
          </div>

          <div class="instructions">
            <h3>üìã Your Task</h3>
            <p>Create a WebSocket handler that processes conversation events and integrates with OpenAI.</p>
            <p style="margin-top: 15px;">
              üìö <strong>Documentation:</strong>
              <a href="https://www.twilio.com/docs/voice/twiml/connect/conversationrelay#websocket-messages" target="_blank">WebSocket Messages</a> |
              <a href="https://www.twilio.com/docs/voice/twiml/connect/conversationrelay#events" target="_blank">Event Types</a> |
              <a href="https://www.twilio.com/docs/serverless/functions" target="_blank">Serverless Functions</a>
            </p>
          </div>

          <div class="service-card" style="background: linear-gradient(135deg, #4fc1ff 0%, #0d122b 100%); color: white; margin: 20px 0;">
            <h4 style="color: white; margin-bottom: 15px;">üéì What is ConversationRelay?</h4>
            <p style="margin-bottom: 15px; line-height: 1.6;">
              See exactly how WebSocket events flow in real-time. This interactive guide shows you:
            </p>
            <ul style="margin: 10px 0 15px 20px; line-height: 1.8;">
              <li>Start event (call begins)</li>
              <li>Transcript events (speech-to-text)</li>
              <li>Text events (AI responses)</li>
              <li>Interrupt events (barge-in handling)</li>
            </ul>
            <button class="btn btn-primary" onclick="openPlayground()" style="background: white; color: #0d122b; border: none;">
              üìñ Learn How It Works
            </button>
          </div>

          <div class="video-section">
            <h4>üì∫ Video Walkthrough</h4>
            <p>Learn how to handle WebSocket events and process transcripts</p>
            <div class="video-container">
              <iframe src="https://www.youtube.com/embed/dQw4w9WgXcQ" frameborder="0" allowfullscreen></iframe>
            </div>
          </div>

          <div class="code-editor">
            <div class="code-header">
              <span>üìù WebSocket Handler</span>
              <div style="display: flex; gap: 10px;">
                <button class="btn-copy" onclick="copyCode('code7')">üìã Copy Code</button>
                <button class="btn btn-test" onclick="testCode7()">‚ñ∂Ô∏è Test Code</button>
                <button class="btn btn-success" onclick="validateCode7()">‚úì Validate</button>
                <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 13px;" onclick="resetCode7()">Reset</button>
              </div>
            </div>
            <textarea class="code-textarea" id="code7">exports.handler = function(context, event, callback) {
  const WebSocket = require('ws');
  const OpenAI = require('openai');

  const ws = new WebSocket.Server({ noServer: true });

  ws.on('connection', (connection) => {
    console.log('WebSocket connected');

    connection.on('message', async (message) => {
      const data = JSON.parse(message);

      if (data.event === 'start') {
        console.log('Call started');
      }

      if (data.event === 'transcript' && data.transcript) {
        console.log('Transcript:', data.transcript.text);

        // Send response back to Twilio
        connection.send(JSON.stringify({
          type: 'text',
          text: 'I received your message: ' + data.transcript.text
        }));
      }

      if (data.event === 'stop') {
        console.log('Call ended');
      }
    });
  });

  callback(null, {});
};</textarea>
          </div>

          <div class="console-output" id="console7"></div>

          <div id="step7Status" class="status-box"></div>

          <div class="button-group">
            <button class="btn btn-secondary" onclick="prevStep()">‚Üê Back</button>
            <button class="btn btn-primary" id="nextBtn7" onclick="nextStep()" disabled>
              Next: Upgrade to ConversationRelay ‚Üí
            </button>
          </div>
        </div>
      `;
    }

    function testCode7() {
      const console7 = document.getElementById('console7');
      console7.innerHTML = `
        <div class="console-line">‚ñ∂Ô∏è Testing WebSocket handler...</div>
        <div class="console-line success">‚úì WebSocket connection established</div>
        <div class="console-line info">Event: start received</div>
        <div class="console-line info">Event: transcript - "Hello, I'm calling about..."</div>
        <div class="console-line success">‚úì Response sent to Twilio</div>
      `;
    }

    function validateCode7_OLD_WEBSOCKET() {
      const code = document.getElementById('code7').value;
      const checks = {
        hasWebSocket: code.includes('WebSocket') || code.includes('ws'),
        hasOpenAI: code.includes('OpenAI'),
        hasStart: code.includes('start'),
        hasTranscript: code.includes('transcript')
      };

      if (Object.values(checks).every(v => v)) {
        websocketBuilt = true;
        document.getElementById('nextBtn7').disabled = false;
        showStatus('step7Status', 'success', '‚úÖ WebSocket handler looks good! Next we\'ll upgrade to ConversationRelay.');
        updateProgressBar();
      } else {
        showStatus('step7Status', 'error', '‚ùå Please implement all required event handlers');
      }
    }

    function resetCode7_OLD_WEBSOCKET() {
      document.getElementById('code7').value = `exports.handler = function(context, event, callback) {
  const WebSocket = require('ws');
  const OpenAI = require('openai');

  // TODO: Handle WebSocket connection
  // TODO: Listen for 'start' event
  // TODO: Process 'transcript' events
  // TODO: Send responses back to Twilio
  // TODO: Handle 'stop' event

  callback(null, {});
};`;
    }

    // =========================================================================
    // STEP 5: OPENAI - Integrate AI Responses
    // =========================================================================

    function renderStep5() {
      return `
        <div class="step-content active">
          <div class="step-header">
            <h2>Step 5: Integrate OpenAI</h2>
            <p>Generate dynamic AI responses for your voice bot</p>
          </div>

          <div class="instructions">
            <h3>üìã Your Task</h3>
            <p>Configure OpenAI to generate contextual responses based on conversation transcripts.</p>
            <p style="margin-top: 15px;">
              üìö <strong>Documentation:</strong>
              <a href="https://platform.openai.com/docs/api-reference/chat" target="_blank">OpenAI Chat API</a> |
              <a href="https://platform.openai.com/docs/guides/function-calling" target="_blank">Function Calling</a> |
              <a href="https://www.twilio.com/docs/voice/twiml/connect/conversationrelay#sending-messages" target="_blank">Sending Messages</a>
            </p>
          </div>

          <div class="video-section">
            <h4>üì∫ Video Walkthrough</h4>
            <p>Integrate OpenAI for intelligent voice responses</p>
            <div class="video-container">
              <iframe src="https://www.youtube.com/embed/dQw4w9WgXcQ" frameborder="0" allowfullscreen></iframe>
            </div>
          </div>

          <div class="code-editor">
            <div class="code-header">
              <span>üìù OpenAI Integration</span>
              <div style="display: flex; gap: 10px;">
                <button class="btn-copy" onclick="copyCode('code5')">üìã Copy Code</button>
                <button class="btn btn-test" onclick="testCode5()">‚ñ∂Ô∏è Test Code</button>
                <button class="btn btn-success" onclick="validateCode5()">‚úì Validate</button>
                <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 13px;" onclick="resetCode5()">Reset</button>
              </div>
            </div>
            <textarea class="code-textarea" id="code5">async function generateAIResponse(transcript, conversationHistory) {
  const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

  // Build messages array with system prompt
  const messages = [
    {
      role: 'system',
      content: 'You are a helpful voice assistant. Keep responses brief and conversational.'
    }
  ];

  // Add conversation history
  conversationHistory.forEach(msg => {
    messages.push(msg);
  });

  // Add current transcript
  messages.push({
    role: 'user',
    content: transcript
  });

  // Call OpenAI API
  const response = await openai.chat.completions.create({
    model: 'gpt-4',
    messages: messages,
    temperature: 0.7,
    max_tokens: 150
  });

  // Return assistant response
  return response.choices[0].message.content;
}</textarea>
          </div>

          <div class="console-output" id="console5"></div>

          <div id="step5Status" class="status-box"></div>

          <div class="button-group">
            <button class="btn btn-secondary" onclick="prevStep()">‚Üê Back</button>
            <button class="btn btn-primary" id="nextBtn5" onclick="nextStep()" disabled>
              Next: Test Your Bot ‚Üí
            </button>
          </div>
        </div>
      `;
    }

    function testCode5() {
      const console5 = document.getElementById('console5');
      console5.innerHTML = `
        <div class="console-line">‚ñ∂Ô∏è Testing OpenAI integration...</div>
        <div class="console-line info">Input: "Hi, I'm interested in the position"</div>
        <div class="console-line success">‚úì OpenAI response generated</div>
        <div class="console-line">Output: "Great! I'd be happy to help you learn more..."</div>
      `;
    }

    function validateCode5() {
      const code = document.getElementById('code5').value;

      const checks = {
        hasOpenAI: code.includes('openai') || code.includes('OpenAI'),
        hasMessages: code.includes('messages'),
        hasSystemPrompt: code.includes('system') || code.includes('role'),
        hasAPICall: code.includes('chat.completions') || code.includes('create')
      };

      if (Object.values(checks).every(v => v)) {
        openaiIntegrated = true;
        document.getElementById('nextBtn5').disabled = false;
        showStatus('step5Status', 'success', '‚úÖ OpenAI integration complete! Ready to test.');
        updateProgressBar();
      } else {
        showStatus('step5Status', 'error', '‚ùå Please implement all OpenAI integration components');
      }
    }

    function resetCode5() {
      document.getElementById('code5').value = `async function generateAIResponse(transcript, conversationHistory) {
  const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

  // TODO: Build messages array with system prompt
  // TODO: Add conversation history
  // TODO: Add current transcript
  // TODO: Call OpenAI API
  // TODO: Return assistant response

  return "AI response here";
}`;
    }

    // =========================================================================
    // STEP 6: TEST - Make a Live Call
    // =========================================================================

    function renderStep6() {
      return `
        <div class="step-content active">
          <div class="step-header">
            <h2>Step 6: Test Your Voice AI Bot</h2>
            <p>Make a live call and see your bot in action!</p>
          </div>

          <div class="instructions">
            <h3>üéâ You're Ready!</h3>
            <p>Your Voice AI bot is now configured. Let's make a test call to see it work.</p>
            <p style="margin-top: 15px;">
              üìö <strong>Documentation:</strong>
              <a href="https://www.twilio.com/docs/voice/api/call-resource" target="_blank">Call Resource</a> |
              <a href="https://www.twilio.com/docs/voice/tutorials/how-to-make-outbound-phone-calls" target="_blank">Outbound Calls</a> |
              <a href="https://www.twilio.com/docs/usage/monitor-debugger" target="_blank">Debugging</a>
            </p>
          </div>

          <div class="service-card">
            <h4>üìû Test Configuration</h4>
            <div class="form-group">
              <label>Your Phone Number (to receive test call)</label>
              <input type="tel" id="testPhoneNumber" placeholder="+1234567890" />
            </div>
            <div class="form-group">
              <label>From Number</label>
              <input type="tel" id="fromNumber" value="${selectedPhoneNumber || ''}" readonly />
            </div>
            <button class="btn btn-primary" onclick="makeFinalTestCall()">üìû Start Test Call</button>
          </div>

          <div id="callStatus" class="service-card" style="display: none;">
            <h4>üìä Call Status</h4>
            <div id="callDetails"></div>
          </div>

          <div id="step6Status" class="status-box"></div>

          <div class="service-card" style="margin-top: 20px; background: #e7f5ff;">
            <h4>üîç Monitor in Twilio Console</h4>
            <p style="margin: 10px 0;">View live logs and debug your calls:</p>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
              <button class="btn btn-primary" onclick="openTwilioConsole('calls')">üìû Call Logs</button>
              <button class="btn btn-primary" onclick="openTwilioConsole('functions')">‚öôÔ∏è Function Logs</button>
              <button class="btn btn-primary" onclick="openTwilioConsole('debugger')">üêõ Debugger</button>
            </div>
          </div>

          <div class="button-group">
            <button class="btn btn-secondary" onclick="prevStep()">‚Üê Back</button>
            <button class="btn btn-success" id="completeBtn" onclick="completeWorkshop()" disabled>
              üéâ Complete Workshop
            </button>
          </div>
        </div>
      `;
    }

    async function makeFinalTestCall() {
      const toNumber = document.getElementById('testPhoneNumber').value.trim();
      const fromNumber = document.getElementById('fromNumber').value.trim();

      if (!toNumber || !toNumber.startsWith('+')) {
        showStatus('step6Status', 'error', 'Please enter a valid phone number with country code (e.g., +1234567890)');
        return;
      }

      console.log('makeFinalTestCall - twilioCredentials:', twilioCredentials);
      console.log('makeFinalTestCall - demoMode:', twilioCredentials?.demoMode);

      // Handle demo mode
      if (twilioCredentials?.demoMode === true) {
        showStatus('step6Status', 'info', 'üìù Demo Mode: Simulating call...');

        setTimeout(() => {
          document.getElementById('callStatus').style.display = 'block';
          document.getElementById('callDetails').innerHTML = `
            <div style="margin: 10px 0;">
              <strong>Call SID:</strong> CAdemo123456789<br>
              <strong>Status:</strong> <span id="callStatusText">completed</span><br>
              <strong>To:</strong> ${toNumber}<br>
              <strong>From:</strong> ${fromNumber}<br>
              <strong>Duration:</strong> 45 seconds
            </div>
            <div style="margin-top: 15px; padding: 15px; background: #fff3cd; border-radius: 6px;">
              <strong>üìù Demo Mode Simulation</strong>
              <p style="margin: 10px 0 0 0; font-size: 13px;">
                In a real call, the bot would answer and conduct the conversation.
                Your code is ready to deploy for live testing!
              </p>
            </div>
          `;

          showStatus('step6Status', 'success', '‚úÖ Demo call simulated! Your bot is ready for real deployment.');
          callTested = true;
          document.getElementById('completeBtn').disabled = false;
          updateProgressBar();
        }, 1500);
        return;
      }

      showStatus('step6Status', 'info', 'Initiating call...');

      try {
        const response = await fetch('/api/tutorial-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'makeCall',
            to: toNumber,
            from: fromNumber,
            url: `https://${window.location.host}/voice-handler`,
            ...twilioCredentials
          })
        });

        const data = await response.json();

        if (data.success) {
          document.getElementById('callStatus').style.display = 'block';
          document.getElementById('callDetails').innerHTML = `
            <div style="margin: 10px 0;">
              <strong>Call SID:</strong> ${data.callSid}<br>
              <strong>Status:</strong> <span id="callStatusText">${data.status}</span><br>
              <strong>To:</strong> ${data.to}<br>
              <strong>From:</strong> ${data.from}
            </div>
            <button class="btn btn-test" onclick="checkCallStatus('${data.callSid}')">üîÑ Refresh Status</button>
          `;

          showStatus('step6Status', 'success', '‚úÖ Call initiated! Answer your phone to test the bot.');
          callTested = true;
          document.getElementById('completeBtn').disabled = false;
          updateProgressBar();
        } else {
          throw new Error(data.error);
        }
      } catch (error) {
        showStatus('step6Status', 'error', 'Failed to make call: ' + error.message);
      }
    }

    async function checkCallStatus(callSid) {
      try {
        const response = await fetch('/api/tutorial-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'getCall',
            callSid,
            ...twilioCredentials
          })
        });

        const data = await response.json();

        if (data.success) {
          document.getElementById('callStatusText').textContent = data.call.status;
          if (data.call.duration) {
            document.getElementById('callDetails').innerHTML += `<br><strong>Duration:</strong> ${data.call.duration} seconds`;
          }
        }
      } catch (error) {
        console.error('Failed to check call status:', error);
      }
    }

    function completeWorkshop() {
      showStatus('step6Status', 'success', `
        <h3 style="margin-bottom: 15px;">üéâ Workshop Complete!</h3>
        <p>You've successfully built a production-ready Twilio Voice AI bot with:</p>
        <ul style="margin: 15px 0; padding-left: 20px;">
          <li>Twilio ConversationRelay for bidirectional streaming</li>
          <li>WebSocket integration for real-time events</li>
          <li>OpenAI for intelligent responses</li>
          <li>Complete service provisioning</li>
        </ul>
        <div style="margin-top: 30px; padding: 25px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);">
          <p style="margin: 0 0 15px 0; color: white; font-size: 1.3em;"><strong>üéâ Next Step: Test Your AI Voice Assistant!</strong></p>
          <p style="margin: 0 0 20px 0; color: rgba(255,255,255,0.95);">Your AI is deployed and ready! Open the admin panel to configure voices, test your assistant, and make outbound calls.</p>
          <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-top: 20px;">
            <a href="/index.html" target="_blank" class="btn btn-primary" style="display: inline-flex; align-items: center; gap: 10px; padding: 15px 35px; background: white; color: #667eea; text-decoration: none; border-radius: 50px; font-weight: bold; font-size: 1.1em; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
              üöÄ Launch Admin Panel & Test AI
            </a>
          </div>
        </div>
        <div style="margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #0066cc;">
          <p style="margin: 0 0 10px 0;"><strong>üìö Additional Resources:</strong></p>
          <div style="display: flex; gap: 15px; flex-wrap: wrap;">
            <a href="/production-deploy.html" style="color: #0066cc; text-decoration: none; font-weight: 600;">
              üìã Production Deployment Guide
            </a>
            <a href="https://www.twilio.com/docs/voice" target="_blank" style="color: #0066cc; text-decoration: none; font-weight: 600;">
              üìñ Twilio Voice Docs
            </a>
          </div>
        </div>
        <p style="margin-top: 20px; font-size: 0.9em; color: #666;">
          üìö Or continue learning: <a href="https://www.twilio.com/docs/voice" target="_blank">Twilio Voice Docs</a>
        </p>
      `);

      // Track workshop completion
      if (typeof trackWorkshopComplete === 'function') {
        trackWorkshopComplete();
      }

      // Auto-open admin panel after 3 seconds
      setTimeout(() => {
        if (confirm('üéâ Congratulations! Your AI Voice Assistant is ready!\n\nWould you like to open the Admin Panel now to test it?')) {
          window.open('/index.html', '_blank');
        }
      }, 2000);
    }

    // =========================================================================
    // NAVIGATION & HELPERS
    // =========================================================================

    function nextStep() {
      if (currentStep < steps.length - 1) {
        // Celebrate milestones
        if (currentStep === 2) {
          celebrate('üéâ Great! You\'ve completed the basics!', 'light');
        } else if (currentStep === 5) {
          celebrate('üöÄ Halfway there! Keep going!', 'normal');
        } else if (currentStep === 7) {
          celebrate('üéä Almost done! Final step ahead!', 'normal');
        }

        currentStep++;
        renderProgressSteps();
        renderStepContent();
        window.scrollTo(0, 0);
        saveProgressToStorage(); // Auto-save after navigation

        // Epic celebration on completion
        if (currentStep === steps.length - 1) {
          setTimeout(() => {
            celebrate('üèÜ Congratulations! Workshop Complete!', 'epic');
          }, 1000);
        }
      }
    }

    function prevStep() {
      if (currentStep > 0) {
        currentStep--;
        renderProgressSteps();
        renderStepContent();
        window.scrollTo(0, 0);
        saveProgressToStorage(); // Auto-save after navigation
      }
    }

    function showStatus(elementId, type, message) {
      const element = document.getElementById(elementId);
      element.className = `status-box show ${type}`;
      element.innerHTML = message;
    }

    // Copy code to clipboard
    async function copyCode(textareaId) {
      const textarea = document.getElementById(textareaId);
      const code = textarea.value;

      try {
        await navigator.clipboard.writeText(code);

        // Find the copy button for this textarea
        const button = event.target;
        const originalText = button.innerHTML;

        // Show success feedback
        button.innerHTML = '‚úì Copied!';
        button.classList.add('copied');

        // Reset after 2 seconds
        setTimeout(() => {
          button.innerHTML = originalText;
          button.classList.remove('copied');
        }, 2000);
      } catch (error) {
        // Fallback for older browsers
        textarea.select();
        document.execCommand('copy');

        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '‚úì Copied!';
        button.classList.add('copied');

        setTimeout(() => {
          button.innerHTML = originalText;
          button.classList.remove('copied');
        }, 2000);
      }
    }

    // =========================================================================
    // SAVE/LOAD PROGRESS
    // =========================================================================

    function saveProgress() {
      // Manual save - calls auto-save function
      saveProgressToStorage();
      celebrate('üíæ Progress saved!', 'light');
    }

    function loadProgress() {
      const progress = loadProgressFromStorage();

      if (!progress) {
        alert('No saved progress found');
        return;
      }

      // Show resume modal
      showResumeModal(progress);
    }

    // Auto-save every 30 seconds (silent, updates existing auto-save session)
    setInterval(() => {
      if (currentStep > 0) {
        autoSaveProgress();
      }
    }, 30000);

    function autoSaveProgress() {
      const progressData = {
        name: 'Auto-save',
        currentStep,
        twilioConnected,
        openaiConnected,
        callDirectionChosen,
        callDirection,
        servicesReady,
        basicTwimlCreated,
        functionsDeployed,
        basicCallTested,
        websocketBuilt,
        conversationRelayCreated,
        aiCallTested,
        twilioCredentials,
        openaiApiKey,
        selectedPhoneNumber,
        syncServiceSkipped,
        code4: document.getElementById('code4')?.value,
        code7: document.getElementById('code7')?.value,
        code8: document.getElementById('code8')?.value,
        timestamp: new Date().toISOString()
      };

      // Get existing sessions
      const sessions = JSON.parse(localStorage.getItem('twilioVoiceAISessions') || '[]');

      // Find and update auto-save session, or add if doesn't exist
      const autoSaveIndex = sessions.findIndex(s => s.name === 'Auto-save');
      if (autoSaveIndex >= 0) {
        sessions[autoSaveIndex] = progressData;
      } else {
        sessions.push(progressData);
      }

      localStorage.setItem('twilioVoiceAISessions', JSON.stringify(sessions));

      // Flash save indicator briefly
      const indicator = document.getElementById('progressSaved');
      if (indicator) {
        indicator.style.display = 'block';
        indicator.style.opacity = '0.5';
        setTimeout(() => {
          indicator.style.display = 'none';
          indicator.style.opacity = '1';
        }, 1000);
      }
    }

    // =========================================================================
    // EXPORT PROJECT
    // =========================================================================

    function exportProject() {
      const code3 = document.getElementById('code3')?.value || '';
      const code4 = document.getElementById('code4')?.value || '';
      const code5 = document.getElementById('code5')?.value || '';

      const projectFiles = {
        'functions/voice-handler.js': code3,
        'functions/websocket-handler.js': code4,
        'functions/ai-integration.js': code5,
        '.env.example': `# Twilio Configuration
TWILIO_ACCOUNT_SID=ACxxxxxx
TWILIO_AUTH_TOKEN=xxxxxx
TWILIO_PHONE_NUMBER=+1234567890

# OpenAI Configuration
OPENAI_API_KEY=sk-proj-xxxxxx

# Optional: Sync Service
TWILIO_SYNC_SERVICE_SID=ISxxxxxx`,
        'package.json': JSON.stringify({
          name: 'twilio-voice-ai-bot',
          version: '1.0.0',
          description: 'Voice AI Bot built with Twilio ConversationRelay and OpenAI',
          dependencies: {
            'twilio': '^5.0.0',
            'openai': '^4.0.0',
            'ws': '^8.0.0'
          }
        }, null, 2),
        'README.md': `# Twilio Voice AI Bot

Built during the Twilio Voice AI Workshop

## Setup

1. Install dependencies:
\`\`\`bash
npm install
\`\`\`

2. Copy \`.env.example\` to \`.env\` and fill in your credentials

3. Deploy to Twilio Serverless:
\`\`\`bash
twilio serverless:deploy
\`\`\`

## Documentation

- [ConversationRelay Docs](https://www.twilio.com/docs/voice/twiml/connect/conversationrelay)
- [Twilio Functions](https://www.twilio.com/docs/serverless/functions)
- [OpenAI API](https://platform.openai.com/docs)

## Support

- Workshop URL: ${window.location.href}
- Twilio Console: https://console.twilio.com
`
      };

      const modal = document.getElementById('exportModal');
      const content = document.getElementById('exportContent');

      content.innerHTML = `
        <div class="service-card">
          <h3>üì¶ Your Project Files</h3>
          <p style="margin: 15px 0;">Download individual files or the complete project as a ZIP.</p>

          <div style="display: flex; flex-direction: column; gap: 10px; margin: 20px 0;">
            ${Object.keys(projectFiles).map(filename => `
              <button class="btn btn-primary" onclick="downloadFile('${filename}', \`${projectFiles[filename].replace(/`/g, '\\`')}\`)">
                üìÑ ${filename}
              </button>
            `).join('')}
          </div>

          <button class="btn btn-success" onclick="downloadAllFiles()">
            üì¶ Download Complete Project (ZIP)
          </button>

          <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
            <h4>Next Steps:</h4>
            <ol style="margin: 10px 0 0 20px; line-height: 1.8;">
              <li>Extract the ZIP file</li>
              <li>Run <code>npm install</code></li>
              <li>Configure your <code>.env</code> file</li>
              <li>Deploy with <code>twilio serverless:deploy</code></li>
            </ol>
          </div>
        </div>
      `;

      modal.classList.add('show');
    }

    function downloadFile(filename, content) {
      const blob = new Blob([content], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    function downloadAllFiles() {
      alert('ZIP download functionality requires a library like JSZip. For now, download files individually.');
    }

    // =========================================================================
    // DEBUGGER
    // =========================================================================

    let debuggerVisible = false;
    let debugEvents = [];

    function toggleDebugger() {
      debuggerVisible = !debuggerVisible;

      if (debuggerVisible && !document.querySelector('.debugger-panel')) {
        const panel = document.createElement('div');
        panel.className = 'debugger-panel show';
        panel.id = 'debuggerPanel';
        panel.innerHTML = `
          <div class="debugger-header">üêõ Live Event Debugger</div>
          <div class="event-flow" id="eventFlow">
            <div class="event-item">Debugger started. Events will appear here...</div>
          </div>
          <div style="margin-top: 15px;">
            <button class="btn btn-secondary" onclick="clearDebugger()">Clear Events</button>
            <button class="btn btn-test" onclick="simulateEvent()">Simulate Event</button>
          </div>
        `;
        document.querySelector('.content').prepend(panel);
      } else {
        const panel = document.getElementById('debuggerPanel');
        if (panel) {
          panel.classList.toggle('show');
        }
      }
    }

    function addDebugEvent(type, data) {
      const eventFlow = document.getElementById('eventFlow');
      if (!eventFlow) return;

      const event = document.createElement('div');
      event.className = `event-item ${type}`;
      event.innerHTML = `
        <strong>${new Date().toLocaleTimeString()}</strong> - ${type.toUpperCase()}<br>
        ${JSON.stringify(data, null, 2)}
      `;

      eventFlow.appendChild(event);
      debugEvents.push({ type, data, timestamp: new Date() });

      // Keep only last 20 events
      if (eventFlow.children.length > 20) {
        eventFlow.removeChild(eventFlow.firstChild);
      }
    }

    function clearDebugger() {
      const eventFlow = document.getElementById('eventFlow');
      if (eventFlow) {
        eventFlow.innerHTML = '<div class="event-item">Cleared. Waiting for events...</div>';
      }
      debugEvents = [];
    }

    function simulateEvent() {
      const events = [
        { type: 'start', data: { streamSid: 'MZ' + Math.random().toString(36).substr(2, 9) } },
        { type: 'transcript', data: { text: 'Hello, I am interested in the position' } },
        { type: 'response', data: { text: 'Great! Let me tell you more about it...' } },
        { type: 'stop', data: { reason: 'user_hangup' } }
      ];

      const event = events[Math.floor(Math.random() * events.length)];
      addDebugEvent(event.type, event.data);
    }

    // =========================================================================
    // HELP & TROUBLESHOOTING
    // =========================================================================

    function showHelp() {
      const modal = document.getElementById('helpModal');
      const content = document.getElementById('helpContent');

      const faqs = [
        {
          q: 'My Twilio credentials are not working',
          a: 'Make sure you\'re using your Account SID (starts with "AC") and Auth Token from the Twilio Console. Check that your account is active and has sufficient balance.'
        },
        {
          q: 'WebSocket connection fails',
          a: 'Verify your WebSocket URL is using wss:// (secure). Check that your Twilio Function is deployed and publicly accessible. Review function logs in Twilio Console.'
        },
        {
          q: 'OpenAI API returns errors',
          a: 'Confirm your API key is valid and starts with "sk-proj-" or "sk-". Check your OpenAI account has available credits. Ensure you\'re using a supported model.'
        },
        {
          q: 'Call connects but no audio',
          a: 'Check ConversationRelay configuration. Verify voice parameter is set correctly. Test with a simple TwiML response first.'
        },
        {
          q: 'How do I debug my code?',
          a: 'Use the built-in Debugger (click üêõ button in toolbar). Check Twilio Function logs in Console. Add console.log() statements in your code.'
        },
        {
          q: 'Can I use this in production?',
          a: 'Yes! Make sure to: 1) Move credentials to environment variables, 2) Enable error handling, 3) Implement rate limiting, 4) Add monitoring/logging, 5) Test thoroughly with real calls.'
        },
        {
          q: 'What are the usage limits?',
          a: 'Twilio has generous limits but check your account tier. OpenAI has rate limits based on your tier. Monitor usage in both consoles to avoid surprises.'
        },
        {
          q: 'How do I add custom functionality?',
          a: 'Use OpenAI function calling to connect to your database or APIs. Implement Sync for conversation state. Add webhooks for events like call recording.'
        }
      ];

      content.innerHTML = `
        <div class="troubleshooting">
          <h3>üîß Common Issues</h3>
          <div style="margin-top: 15px;">
            ${faqs.map((faq, i) => `
              <div class="faq-item" onclick="toggleFaq(${i})">
                <strong>‚ùì ${faq.q}</strong>
                <div class="faq-answer" id="faq${i}">
                  ${faq.a}
                </div>
              </div>
            `).join('')}
          </div>
        </div>

        <div class="service-card" style="margin-top: 20px;">
          <h3>üìö Additional Resources</h3>
          <ul style="margin: 15px 0 0 20px; line-height: 2;">
            <li><a href="https://www.twilio.com/docs/voice/twiml/connect/conversationrelay" target="_blank">ConversationRelay Documentation</a></li>
            <li><a href="https://www.twilio.com/console/voice/logs" target="_blank">View Call Logs in Console</a></li>
            <li><a href="https://www.twilio.com/console/functions/logs" target="_blank">View Function Logs</a></li>
            <li><a href="https://platform.openai.com/docs" target="_blank">OpenAI Documentation</a></li>
            <li><a href="https://www.twilio.com/support" target="_blank">Contact Twilio Support</a></li>
          </ul>
        </div>

        <div class="service-card" style="margin-top: 20px; background: #e7f5ff;">
          <h3>üí¨ Need More Help?</h3>
          <p style="margin: 10px 0;">Join the Twilio community or contact support:</p>
          <button class="btn btn-primary" onclick="window.open('https://support.twilio.com/hc/en-us/community/topics', '_blank')">
            üåê Twilio Community
          </button>
        </div>
      `;

      modal.classList.add('show');
    }

    function toggleFaq(index) {
      const faq = document.getElementById('faq' + index);
      const item = faq.parentElement;
      item.classList.toggle('open');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('show');
    }

    // Close modal when clicking outside
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('modal')) {
        e.target.classList.remove('show');
      }
    });

    // =========================================================================
    // CONVERSATIONRELAY PLAYGROUND
    // =========================================================================

    function openPlayground() {
      // Open in new window
      const playgroundWindow = window.open(
        'https://playground.twilio.world/products/cr',
        'TwilioPlayground',
        'width=1400,height=900,menubar=no,toolbar=no,location=no,status=no'
      );

      if (!playgroundWindow) {
        // Fallback if popup blocked - show embedded iframe
        showPlaygroundModal();
      } else {
        // Show helpful tip about the playground
        setTimeout(() => {
          showStatus('step3Status', 'info',
            'üí° Tip: Use the playground to see how ConversationRelay events flow in real-time. ' +
            'Try clicking through the different scenarios!'
          );
        }, 500);
      }
    }

    function showPlaygroundModal() {
      const modal = document.createElement('div');
      modal.className = 'modal show';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 95%; max-height: 95vh; padding: 0;">
          <div style="background: linear-gradient(135deg, #F22F46 0%, #0d122b 100%); padding: 20px; color: white; display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin: 0; color: white;">üéì What is ConversationRelay?</h2>
            <span class="modal-close" onclick="this.closest('.modal').remove()" style="color: white; cursor: pointer; font-size: 28px;">&times;</span>
          </div>
          <div style="padding: 20px; background: #f8f9fa;">
            <p style="margin-bottom: 15px;">
              <strong>üìö How to use:</strong>
            </p>
            <ul style="margin: 0 0 15px 20px; line-height: 1.8;">
              <li>Click on different components to see how they interact</li>
              <li>Follow the event flow from caller ‚Üí Twilio ‚Üí WebSocket ‚Üí AI</li>
              <li>See example payloads for each event type</li>
              <li>Understand bidirectional streaming in real-time</li>
            </ul>
          </div>
          <iframe
            src="https://playground.twilio.world/products/cr"
            style="width: 100%; height: 70vh; border: none;"
            title="Twilio ConversationRelay Playground"
          ></iframe>
          <div style="padding: 15px; background: #f8f9fa; text-align: center;">
            <button class="btn btn-primary" onclick="window.open('https://playground.twilio.world/products/cr', '_blank')">
              üöÄ Open in Full Window
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      // Close on background click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
        }
      });
    }

    // =========================================================================
    // SHOW SOLUTION
    // =========================================================================

    const solutions = {
      3: `function createConversationRelayTwiML() {
  const twilio = require('twilio');
  const twiml = new twilio.twiml.VoiceResponse();

  const connect = twiml.connect();
  connect.conversationRelay({
    url: '${websocketUrl || 'wss://your-domain.twil.io/tutorial-ws'}',
    voice: 'Polly.Brian',
    language: 'en-US',
    transcriptionProvider: 'twilio',
    ttsProvider: 'amazon-polly'
  });

  return twiml.toString();
}`,
      4: `exports.handler = function(context, event, callback) {
  const twilio = require('twilio');
  const twiml = new twilio.twiml.VoiceResponse();

  // Dial a phone number to connect the call
  const dial = twiml.dial({
    timeout: 30,
    callerId: context.DEFAULT_TWILIO_NUMBER || '+1234567890'
  });
  dial.number('+15555551234');  // Replace with actual number

  // If no answer, say goodbye
  twiml.say('Sorry, no one is available. Goodbye!', { voice: 'Polly.Joanna' });

  callback(null, twiml);
}`,
      6: `exports.handler = function(context, event, callback) {
  const WebSocket = require('ws');
  const OpenAI = require('openai');

  // WebSocket connection handling
  const ws = new WebSocket(event.url);

  ws.on('open', () => {
    console.log('WebSocket connected');
  });

  ws.on('message', async (message) => {
    const data = JSON.parse(message);

    if (data.event === 'start') {
      console.log('Call started:', data.streamSid);
      // Initialize conversation state
    }

    if (data.event === 'transcript') {
      console.log('Transcript:', data.text);

      // Generate AI response
      const response = await generateAIResponse(data.text);

      // Send response back to Twilio
      ws.send(JSON.stringify({
        event: 'text',
        text: response
      }));
    }

    if (data.event === 'stop') {
      console.log('Call ended');
      ws.close();
    }
  });

  callback(null, {});
}`,
      5: `async function generateAIResponse(transcript, conversationHistory) {
  const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

  const messages = [
    {
      role: 'system',
      content: 'You are a helpful recruiting assistant. Be friendly, professional, and concise.'
    },
    ...conversationHistory,
    {
      role: 'user',
      content: transcript
    }
  ];

  const completion = await openai.chat.completions.create({
    model: 'gpt-4o-mini',
    messages: messages,
    temperature: 0.7,
    max_tokens: 150
  });

  return completion.choices[0].message.content;
}`
    };

    function showSolution(step) {
      const code = solutions[step];
      if (!code) return;

      if (confirm('Show the solution code? This will replace your current code.')) {
        document.getElementById('code' + step).value = code;
      }
    }

    // =========================================================================
    // PROGRESS BAR UPDATE
    // =========================================================================

    function updateProgressBar() {
      const totalSteps = 9;
      const completedSteps = [
        twilioConnected && openaiConnected,
        callDirectionChosen,
        servicesReady,
        basicTwimlCreated,
        functionsDeployed,
        basicCallTested,
        websocketBuilt,
        conversationRelayCreated,
        aiCallTested
      ].filter(Boolean).length;

      const percentage = Math.round((completedSteps / totalSteps) * 100);

      document.getElementById('progressBar').style.width = percentage + '%';
      document.getElementById('progressPercent').textContent = percentage + '%';
      document.getElementById('completedTasks').textContent = `${completedSteps} of ${totalSteps} steps completed`;

      // Estimate time remaining
      const avgTimePerStep = 5; // minutes
      const remaining = (totalSteps - completedSteps) * avgTimePerStep;
      if (remaining > 0) {
        document.getElementById('timeEstimate').textContent = `Est. ${remaining}-${remaining + 10} minutes remaining`;
      } else {
        document.getElementById('timeEstimate').textContent = 'üéâ Complete!';
      }
    }

    // Update progress bar whenever state changes
    function checkStep1Complete() {
      if (twilioConnected && openaiConnected) {
        document.getElementById('nextBtn1').disabled = false;
        showStatus('step1Status', 'success', 'üéâ All accounts connected! Click Next to continue.');
        updateProgressBar();
      }
    }

    // =========================================================================
    // CONSOLE INTEGRATION
    // =========================================================================

    function openTwilioConsole(section) {
      const urls = {
        calls: 'https://console.twilio.com/us1/monitor/logs/calls',
        functions: `https://console.twilio.com/us1/develop/functions/editor/${twilioCredentials?.accountSid || ''}`,
        debugger: 'https://console.twilio.com/us1/monitor/debugger'
      };

      window.open(urls[section] || 'https://console.twilio.com', '_blank');
    }

    // Add console links to Step 6
    function addConsoleLinks() {
      return `
        <div class="service-card" style="margin-top: 20px; background: #e7f5ff;">
          <h4>üîç Monitor in Twilio Console</h4>
          <p style="margin: 10px 0;">View live logs and debug your calls:</p>
          <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button class="btn btn-primary" onclick="openTwilioConsole('calls')">üìû Call Logs</button>
            <button class="btn btn-primary" onclick="openTwilioConsole('functions')">‚öôÔ∏è Function Logs</button>
            <button class="btn btn-primary" onclick="openTwilioConsole('debugger')">üêõ Debugger</button>
          </div>
        </div>
      `;
    }

    // =========================================================================
    // OAUTH AUTHENTICATION
    // =========================================================================

    let sessionToken = null;

    // Check for OAuth callback on page load
    window.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const session = urlParams.get('session');
      const authSuccess = urlParams.get('auth');

      if (session && authSuccess === 'success') {
        // Store session token
        sessionStorage.setItem('twilioSession', session);
        sessionToken = session;

        // Clean URL
        window.history.replaceState({}, '', window.location.pathname);

        // Check auth status
        checkOAuthStatus();
      } else {
        // Check for existing session
        sessionToken = sessionStorage.getItem('twilioSession');
        if (sessionToken) {
          checkOAuthStatus();
        }
      }
    });

    // Initiate OAuth login
    async function loginWithTwilio() {
      try {
        showStatus('step1Status', 'info', 'Redirecting to Twilio login...');

        const response = await fetch('/tutorial-oauth-login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'getAuthUrl' })
        });

        const data = await response.json();

        if (data.success) {
          // Store state for CSRF validation
          sessionStorage.setItem('oauthState', data.state);

          // Redirect to Twilio OAuth
          window.location.href = data.authUrl;
        } else {
          showStatus('step1Status', 'error', 'Failed to initiate login: ' + (data.error || 'Unknown error'));
        }

      } catch (error) {
        console.error('Login error:', error);
        showStatus('step1Status', 'error', 'Failed to initiate login. Please try again.');
      }
    }

    // Check OAuth authentication status
    async function checkOAuthStatus() {
      try {
        const response = await fetch('/tutorial-oauth-login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'checkAuthStatus',
            sessionToken: sessionToken
          })
        });

        const data = await response.json();

        if (data.authenticated) {
          // Show authenticated UI
          document.getElementById('oauthStatus').style.display = 'block';
          document.getElementById('oauthAccountName').textContent =
            data.accountInfo ? data.accountInfo.friendlyName : 'Connected Account';

          // Mark as connected
          twilioConnected = true;
          twilioCredentials = {
            sessionToken: sessionToken,
            accountFriendlyName: data.accountInfo?.friendlyName
          };

          showStatus('step1Status', 'success', '‚úÖ Twilio connected via OAuth!');
          checkStep1Complete();

        } else {
          // Clear invalid session
          sessionStorage.removeItem('twilioSession');
          sessionToken = null;
          document.getElementById('oauthStatus').style.display = 'none';
        }

      } catch (error) {
        console.error('Auth check error:', error);
        sessionStorage.removeItem('twilioSession');
        sessionToken = null;
      }
    }

    // Logout from OAuth
    async function logoutOAuth() {
      try {
        await fetch('/tutorial-oauth-login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'logout',
            sessionToken: sessionToken
          })
        });

      } catch (error) {
        console.error('Logout error:', error);
      } finally {
        // Clear local session
        sessionStorage.removeItem('twilioSession');
        sessionToken = null;
        twilioConnected = false;
        twilioCredentials = null;

        // Hide auth status
        document.getElementById('oauthStatus').style.display = 'none';

        showStatus('step1Status', 'info', 'Logged out. Please reconnect to continue.');
      }
    }

    // GitHub Repository Creation
    async function createGitHubRepo() {
      const createRepoBtn = document.getElementById('createRepoBtn');
      const repoStatus = document.getElementById('repoStatus');
      const repoNameInput = document.getElementById('repoName');
      const repoName = repoNameInput.value.trim() || 'my-voice-ai-workshop';

      createRepoBtn.disabled = true;
      createRepoBtn.textContent = '‚è≥ Creating repository...';
      repoStatus.style.display = 'none';

      try {
        // Get student info with GitHub token
        const studentInfo = JSON.parse(localStorage.getItem('workshop_student_info') || '{}');
        const githubToken = studentInfo.githubToken;

        if (!githubToken) {
          throw new Error('No GitHub session found. Please login with GitHub first.');
        }

        // Call the create repo endpoint
        const response = await fetch('/api/github-create-repo', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sessionToken: githubToken,
            repoName: repoName
          })
        });

        const data = await response.json();

        if (data.success) {
          // Success!
          repoStatus.innerHTML = `
            <div style="background: #d4edda; padding: 15px; border-radius: 8px; border: 1px solid #c3e6cb;">
              <div style="color: #155724; font-weight: bold; margin-bottom: 10px;">‚úÖ Repository Created Successfully!</div>
              <div style="color: #155724; margin-bottom: 10px;">
                <strong>Repository:</strong> <a href="${data.repoUrl}" target="_blank" style="color: #0066cc; text-decoration: none;">${data.repoFullName}</a>
              </div>
              <div style="color: #666; font-size: 13px; margin-top: 10px;">
                üí° You can clone this repository later and deploy your code to it throughout the workshop.
              </div>
            </div>
          `;
          repoStatus.style.display = 'block';
          createRepoBtn.textContent = '‚úì Repository Created';
          createRepoBtn.style.background = '#28a745';
          createRepoBtn.style.color = 'white';

          // Save repo info
          studentInfo.repoUrl = data.repoUrl;
          studentInfo.repoName = data.repoName;
          localStorage.setItem('workshop_student_info', JSON.stringify(studentInfo));

          celebrate('üéâ Your repository is ready!', 'success');
        } else {
          throw new Error(data.error || 'Failed to create repository');
        }

      } catch (error) {
        console.error('Error creating repo:', error);
        repoStatus.innerHTML = `
          <div style="background: #f8d7da; padding: 15px; border-radius: 8px; border: 1px solid #f5c6cb;">
            <div style="color: #721c24; font-weight: bold;">‚ùå Error Creating Repository</div>
            <div style="color: #721c24; margin-top: 5px; font-size: 14px;">${error.message}</div>
          </div>
        `;
        repoStatus.style.display = 'block';
        createRepoBtn.disabled = false;
        createRepoBtn.textContent = 'üì¶ Retry';
      }
    }

    // GitHub Login Modal Functions
    async function startGitHubLoginFromModal() {
      const githubLoginBtn = document.getElementById('githubLoginBtnModal');
      const errorMessage = document.getElementById('githubErrorMessage');

      githubLoginBtn.disabled = true;
      githubLoginBtn.innerHTML = '‚è≥ Connecting to GitHub...';
      errorMessage.style.display = 'none';

      try {
        // Initialize GitHub OAuth flow
        const response = await fetch('/api/github-oauth-init');
        const data = await response.json();

        if (data.success && data.authUrl) {
          // Store state for verification
          sessionStorage.setItem('github_oauth_state', data.state);

          // Redirect to GitHub OAuth
          window.location.href = data.authUrl;
        } else {
          throw new Error(data.error || 'Failed to initialize GitHub login');
        }

      } catch (error) {
        console.error('Error starting GitHub login:', error);
        errorMessage.textContent = 'Error connecting to GitHub. Please try again.';
        errorMessage.style.display = 'block';
        githubLoginBtn.disabled = false;
        githubLoginBtn.innerHTML = `
          <svg height="24" width="24" viewBox="0 0 16 16" fill="currentColor">
            <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
          </svg>
          Continue with GitHub
        `;
      }
    }

    function dismissGitHubModal() {
      const githubModal = document.getElementById('githubLoginModal');
      if (githubModal) {
        githubModal.classList.remove('show');
      }

      // Track that user dismissed the modal
      localStorage.setItem('github_modal_dismissed', 'true');

      // Show a subtle notification that they can still use the tutorial
      celebrate('You can complete the tutorial without GitHub. Connect later to save your work!', 'normal');
    }

    function startDemoMode() {
      const githubModal = document.getElementById('githubLoginModal');
      if (githubModal) {
        githubModal.classList.remove('show');
      }

      // Create a demo student info for analytics
      const demoStudentInfo = {
        studentId: 'demo_' + Date.now(),
        studentName: 'Demo User',
        demoMode: true,
        startedAt: new Date().toISOString()
      };

      localStorage.setItem('workshop_student_info', JSON.stringify(demoStudentInfo));
      localStorage.setItem('github_modal_dismissed', 'true');

      // Track demo mode start
      if (typeof trackWorkshopStart === 'function') {
        trackWorkshopStart();
      }

      // Call the existing connectDemoMode function to set up demo credentials
      connectDemoMode();

      // Show demo mode banner
      showDemoModeBanner();
    }

    function showDemoModeBanner() {
      const banner = document.getElementById('demoModeBanner');
      if (banner && twilioCredentials?.demoMode) {
        banner.style.display = 'block';
      }
    }

    function hideDemoModeBanner() {
      const banner = document.getElementById('demoModeBanner');
      if (banner) {
        banner.style.display = 'none';
      }
    }

    function exitDemoMode() {
      if (confirm('Exit Demo Mode? This will reset your progress and you\'ll need to authenticate with real Twilio credentials.')) {
        // Clear demo credentials
        twilioCredentials = null;
        twilioConnected = false;
        openaiApiKey = null;
        openaiConnected = false;

        // Hide banner
        hideDemoModeBanner();

        // Clear all progress data
        localStorage.removeItem('workshop_student_info');
        localStorage.removeItem('workshop_progress');

        // Clear Twilio status
        const twilioStatus = document.getElementById('twilioStatus');
        if (twilioStatus) {
          twilioStatus.style.display = 'none';
        }

        // Clear OpenAI status
        const openaiStatus = document.getElementById('openaiStatus');
        if (openaiStatus) {
          openaiStatus.style.display = 'none';
        }

        // Reset all step completion flags
        setupComplete = false;
        basicTwimlCreated = false;
        openaiIntegrated = false;
        basicCallTested = false;
        websocketCreated = false;
        conversationRelayCreated = false;
        callTested = false;

        // Reset to step 1
        currentStep = 1;

        // Update progress bar
        updateProgressBar();

        // Render step 1
        renderCurrentStep();

        celebrate('‚úÖ Demo Mode exited. Please connect your Twilio account in Step 1.', 'normal');
      }
    }

    // Initialize on load
    init();
    updateProgressBar();
  </script>

  <!-- Workshop Analytics Tracking -->
  <script src="/workshop-analytics-tracker.js"></script>
</body>
</html>
