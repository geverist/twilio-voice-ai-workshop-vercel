<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Voice AI Admin Panel</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container { max-width: 1400px; margin: 0 auto; }

    .header {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .header h1 {
      color: #333;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }

    .status-badge {
      display: inline-block;
      padding: 6px 16px;
      background: #10b981;
      color: white;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .tabs {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin-bottom: 20px;
    }

    .tab {
      background: rgba(255,255,255,0.9);
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      color: #667eea;
      transition: all 0.3s;
    }

    .tab:hover { background: white; transform: translateY(-2px); }
    .tab.active { background: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .panel {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .panel h2 {
      color: #333;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #e0e0e0;
    }

    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .setting-card {
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 20px;
    }

    .setting-card h3 {
      color: #667eea;
      margin-bottom: 10px;
      font-size: 16px;
    }

    .setting-value {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 6px;
      font-family: monospace;
      font-size: 13px;
      color: #333;
      word-break: break-all;
    }

    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      margin-top: 10px;
      transition: transform 0.2s;
    }

    .btn:hover { transform: scale(1.05); }
    .btn-secondary { background: #6c757d; }

    .metric-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }

    .metric-value {
      font-size: 36px;
      font-weight: bold;
      margin: 10px 0;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .code-block {
      background: #2c313c;
      color: #abb2bf;
      padding: 20px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
      overflow-x: auto;
      margin-top: 15px;
      white-space: pre-wrap;
    }

    textarea {
      width: 100%;
      min-height: 200px;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-family: monospace;
      font-size: 13px;
      margin-top: 10px;
    }

    input[type="text"], input[type="number"] {
      width: 100%;
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
      margin-top: 10px;
    }

    .config-select {
      width: 100%;
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
      background: white;
      cursor: pointer;
      margin-top: 5px;
    }

    .config-select:hover {
      border-color: #667eea;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .error {
      background: #fee;
      color: #c00;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>
        ü§ñ Voice AI Admin Panel
        <span class="status-badge">‚óè LIVE</span>
      </h1>
      <p id="useCaseDisplay">Loading your configuration...</p>
    </div>

    <div id="loadingState" class="panel loading">
      <div style="font-size: 48px; margin-bottom: 15px;">‚è≥</div>
      <p>Loading your Voice AI configuration...</p>
    </div>

    <div id="errorState" style="display: none;">
      <div class="panel">
        <div class="error">
          <h3 style="margin-bottom: 10px;">‚ùå Failed to Load Configuration</h3>
          <p id="errorMessage"></p>
        </div>
      </div>
    </div>

    <div id="mainContent" style="display: none;">
      <div class="tabs">
        <button class="tab active" onclick="showTab('overview')">üìä Overview</button>
        <button class="tab" onclick="showTab('ai-config')">ü§ñ AI Configuration</button>
        <button class="tab" onclick="showTab('conversationrelay')">‚òéÔ∏è ConversationRelay</button>
        <button class="tab" onclick="showTab('prompts')">üìù Prompts</button>
        <button class="tab" onclick="showTab('functions')">üõ†Ô∏è Functions</button>
        <button class="tab" onclick="showTab('analytics')">üìà Analytics</button>
        <button class="tab" onclick="showTab('logs')">üìã Session Logs</button>
      </div>

      <div id="overview" class="tab-content active">
        <div class="panel">
          <h2>System Overview</h2>

          <div class="stats-grid">
            <div class="metric-card">
              <div class="metric-label">Session Token</div>
              <div class="metric-value" style="font-size: 14px; font-family: monospace;" id="sessionTokenDisplay"></div>
            </div>
            <div class="metric-card">
              <div class="metric-label">Call Direction</div>
              <div class="metric-value" style="font-size: 20px;" id="callDirectionMetric">--</div>
            </div>
            <div class="metric-card">
              <div class="metric-label">TTS Provider</div>
              <div class="metric-value" style="font-size: 20px;" id="ttsProviderMetric">--</div>
            </div>
            <div class="metric-card">
              <div class="metric-label">Status</div>
              <div class="metric-value" style="font-size: 20px;">üü¢ Active</div>
            </div>
          </div>

          <h3 style="margin-top: 30px; color: #333;">Quick Actions</h3>
          <div class="settings-grid">
            <div class="setting-card">
              <h3>üìû Test Your Voice AI</h3>
              <p>Call your Twilio number to test</p>
              <button class="btn" onclick="alert('Call: ' + (config.selectedPhoneNumber || 'Not configured'))">View Phone Number</button>
            </div>
            <div class="setting-card">
              <h3>üìä View Logs</h3>
              <p>Check Twilio Console</p>
              <button class="btn" onclick="window.open('https://console.twilio.com/us1/monitor/logs/calls', '_blank')">Open Logs</button>
            </div>
          </div>
        </div>
      </div>

      <div id="ai-config" class="tab-content">
        <div class="panel">
          <h2>ü§ñ AI Configuration</h2>
          <p style="color: #666; margin-bottom: 30px;">
            Control every aspect of your AI voice assistant - no third-party platforms needed. You own the entire stack.
          </p>

          <div class="settings-grid">
            <!-- AI Provider Selection -->
            <div class="setting-card">
              <h3>üß† AI Provider</h3>
              <p style="color: #666; font-size: 13px; margin: 10px 0;">Choose your large language model provider</p>
              <select id="aiProviderSelect" class="config-select" onchange="updateAIProvider()">
                <option value="openai">OpenAI (GPT-4, GPT-3.5)</option>
                <option value="anthropic">Anthropic (Claude)</option>
                <option value="google">Google (Gemini)</option>
                <option value="azure">Azure OpenAI</option>
              </select>
              <div style="margin-top: 10px; padding: 10px; background: #f0f9ff; border-radius: 6px; font-size: 12px; color: #0369a1;">
                üí° Currently using: <strong id="currentAIProvider">OpenAI</strong>
              </div>
            </div>

            <!-- TTS Provider Selection -->
            <div class="setting-card">
              <h3>üîä Text-to-Speech Provider</h3>
              <p style="color: #666; font-size: 13px; margin: 10px 0;">Select your voice synthesis provider</p>
              <select id="ttsProviderSelect" class="config-select" onchange="updateTTSProvider()">
                <option value="elevenlabs">ElevenLabs (Ultra-realistic)</option>
                <option value="google">Google TTS (Reliable)</option>
                <option value="deepgram">Deepgram Aura (Low-latency)</option>
                <option value="amazon">Amazon Polly (Cost-effective)</option>
              </select>
              <div style="margin-top: 10px; padding: 10px; background: #f0f9ff; border-radius: 6px; font-size: 12px; color: #0369a1;">
                üí° Current: <strong id="currentTTSProvider">--</strong>
              </div>
            </div>

            <!-- Voice Selection -->
            <div class="setting-card">
              <h3>üéôÔ∏è Voice Selection</h3>
              <p style="color: #666; font-size: 13px; margin: 10px 0;">Choose the voice personality</p>
              <select id="voiceSelect" class="config-select" onchange="updateVoice()">
                <!-- Dynamically populated based on TTS provider -->
              </select>
              <button class="btn" onclick="previewVoice()" style="width: 100%; margin-top: 10px;">
                üîä Preview Voice
              </button>
            </div>

            <!-- AI Model Selection -->
            <div class="setting-card">
              <h3>‚ö° AI Model</h3>
              <p style="color: #666; font-size: 13px; margin: 10px 0;">Select the specific model version</p>
              <select id="aiModelSelect" class="config-select" onchange="updateAIModel()">
                <!-- Dynamically populated based on AI provider -->
              </select>
            </div>

            <!-- Temperature Control -->
            <div class="setting-card">
              <h3>üå°Ô∏è AI Temperature</h3>
              <p style="color: #666; font-size: 13px; margin: 10px 0;">Control response creativity (0 = focused, 2 = creative)</p>
              <input type="range" id="temperatureSlider" min="0" max="2" step="0.1" value="0.7"
                     style="width: 100%; margin: 10px 0;" oninput="updateTemperature(this.value)">
              <div style="display: flex; justify-content: space-between; font-size: 12px; color: #666;">
                <span>Focused (0)</span>
                <span id="temperatureValue" style="font-weight: bold; color: #667eea;">0.7</span>
                <span>Creative (2)</span>
              </div>
              <button class="btn" onclick="saveTemperature()" style="width: 100%; margin-top: 10px;">
                üíæ Save Temperature
              </button>
            </div>

            <!-- Max Response Length -->
            <div class="setting-card">
              <h3>üìè Max Response Tokens</h3>
              <p style="color: #666; font-size: 13px; margin: 10px 0;">Limit AI response length (for voice, keep under 150)</p>
              <input type="number" id="maxTokensInput" min="50" max="500" value="150"
                     style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px;">
              <button class="btn" onclick="saveMaxTokens()" style="width: 100%; margin-top: 10px;">
                üíæ Save Max Tokens
              </button>
            </div>
          </div>

          <div style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 12px; color: white;">
            <h3 style="color: white; margin: 0 0 10px 0;">‚ú® Why This Matters</h3>
            <p style="color: rgba(255,255,255,0.95); font-size: 14px; line-height: 1.6; margin: 0;">
              YOU control every aspect of your AI stack - no vendor lock-in or platform restrictions. Switch providers, adjust settings, and optimize costs with complete flexibility. This is your foundation to build upon.
            </p>
          </div>
        </div>
      </div>

      <div id="conversationrelay" class="tab-content">
        <div class="panel">
          <h2>‚òéÔ∏è ConversationRelay Configuration</h2>
          <p style="color: #666; margin-bottom: 30px;">
            Twilio's ConversationRelay connects your AI to phone calls. Fine-tune these settings for optimal performance.
          </p>

          <div class="settings-grid">
            <!-- Voice Activity Detection -->
            <div class="setting-card">
              <h3>üé§ Voice Activity Detection</h3>
              <p style="color: #666; font-size: 13px; margin: 10px 0;">Detect when caller stops speaking</p>
              <select id="vadSelect" class="config-select" onchange="updateVAD()">
                <option value="auto">Auto (Recommended)</option>
                <option value="aggressive">Aggressive (Fast response)</option>
                <option value="conservative">Conservative (Less interruption)</option>
              </select>
            </div>

            <!-- Interruption Handling -->
            <div class="setting-card">
              <h3>‚ö° Interruption Handling</h3>
              <p style="color: #666; font-size: 13px; margin: 10px 0;">Allow callers to interrupt AI mid-sentence</p>
              <label style="display: flex; align-items: center; gap: 10px; margin: 15px 0; cursor: pointer;">
                <input type="checkbox" id="interruptibleCheckbox" onchange="updateInterruptible()"
                       style="width: 20px; height: 20px; cursor: pointer;">
                <span style="font-size: 14px;">Enable Interruptions (Natural conversations)</span>
              </label>
            </div>

            <!-- STT Provider -->
            <div class="setting-card">
              <h3>üéß Speech-to-Text Provider</h3>
              <p style="color: #666; font-size: 13px; margin: 10px 0;">How caller speech is transcribed</p>
              <select id="sttProviderSelect" class="config-select" onchange="updateSTTProvider()">
                <option value="google">Google STT (High accuracy)</option>
                <option value="deepgram">Deepgram (Low latency)</option>
                <option value="amazon">Amazon Transcribe</option>
                <option value="azure">Azure Speech</option>
              </select>
            </div>

            <!-- Barge-in Sensitivity -->
            <div class="setting-card">
              <h3>‚ö° Barge-in Sensitivity</h3>
              <p style="color: #666; font-size: 13px; margin: 10px 0;">How easily caller can interrupt (0-100)</p>
              <input type="range" id="bargeInSlider" min="0" max="100" step="5" value="50"
                     style="width: 100%; margin: 10px 0;" oninput="updateBargeInDisplay(this.value)">
              <div style="display: flex; justify-content: space-between; font-size: 12px; color: #666;">
                <span>Low</span>
                <span id="bargeInValue" style="font-weight: bold; color: #667eea;">50</span>
                <span>High</span>
              </div>
              <button class="btn" onclick="saveBargeInSensitivity()" style="width: 100%; margin-top: 10px;">
                üíæ Save Sensitivity
              </button>
            </div>
          </div>

          <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #667eea;">
            <h4 style="color: #333; margin: 0 0 10px 0;">üìö Learn More</h4>
            <p style="color: #666; font-size: 14px; margin: 0 0 10px 0;">
              These settings control how Twilio's ConversationRelay manages real-time voice conversations with your AI.
            </p>
            <button class="btn btn-secondary" onclick="window.open('https://www.twilio.com/docs/voice/twiml/stream', '_blank')">
              View ConversationRelay Docs
            </button>
          </div>
        </div>
      </div>

      <div id="settings" class="tab-content">
        <div class="panel">
          <h2>System Settings</h2>
          <div class="settings-grid" id="settingsContent"></div>
        </div>
      </div>

      <div id="prompts" class="tab-content">
        <div class="panel">
          <h2>System Prompts</h2>

          <div class="setting-card">
            <h3>Current System Prompt</h3>
            <textarea id="systemPromptEditor"></textarea>
            <button class="btn" onclick="updateSystemPrompt()">üíæ Save Prompt</button>
          </div>

          <div class="setting-card" style="margin-top: 20px;">
            <h3>IVR Greeting</h3>
            <input type="text" id="ivrGreetingEditor" placeholder="Enter greeting...">
            <button class="btn" onclick="updateIvrGreeting()">üíæ Save Greeting</button>
          </div>
        </div>
      </div>

      <div id="functions" class="tab-content">
        <div class="panel">
          <h2>AI Functions & Tools</h2>
          <p style="color: #666; margin-bottom: 20px;">
            Add custom functions that your AI can call during conversations. Functions let your AI take actions like checking availability, booking appointments, or querying databases.
          </p>

          <!-- Add New Function Form -->
          <div class="setting-card" style="background: #f8f9fa; border: 2px dashed #667eea;">
            <h3>‚ûï Add New Function</h3>
            <div style="margin-top: 15px;">
              <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Function Name</label>
              <input type="text" id="newFunctionName" placeholder="e.g., check_availability" style="margin-top: 0;">

              <label style="display: block; margin-top: 15px; margin-bottom: 5px; font-weight: 600; color: #333;">Description</label>
              <textarea id="newFunctionDescription" placeholder="What does this function do? Be specific so the AI knows when to use it." style="min-height: 80px;"></textarea>

              <label style="display: block; margin-top: 15px; margin-bottom: 5px; font-weight: 600; color: #333;">Webhook URL (Optional)</label>
              <input type="text" id="newFunctionWebhookUrl" placeholder="https://your-api.com/webhooks/your-function (leave empty for simulated mode)" style="margin-top: 0;">

              <label style="display: block; margin-top: 15px; margin-bottom: 5px; font-weight: 600; color: #333;">Parameters (JSON Schema)</label>
              <textarea id="newFunctionParameters" placeholder='{
  "type": "object",
  "properties": {
    "date": {
      "type": "string",
      "description": "Date in YYYY-MM-DD format"
    },
    "time": {
      "type": "string",
      "description": "Time in HH:MM format (24-hour)"
    },
    "name": {
      "type": "string",
      "description": "Customer full name"
    }
  },
  "required": ["date", "name"]
}' style="min-height: 120px; font-family: monospace;"></textarea>

              <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 6px; font-size: 13px; color: #856404;">
                üí° <strong>Tip:</strong> Parameters use JSON Schema format. Define what inputs your function needs.
              </div>
              <div style="margin-top: 10px; padding: 10px; background: #e0f2fe; border-radius: 6px; font-size: 13px; color: #075985;">
                üîó <strong>Webhook URL:</strong> Optional HTTPS endpoint for external tool execution. See <a href="/WEBHOOK_TOOLS.md" target="_blank" style="color: #0369a1; text-decoration: underline;">WEBHOOK_TOOLS.md</a> for details.
              </div>

              <button class="btn" onclick="addFunction()" style="margin-top: 15px; margin-right: 10px;">
                ‚úÖ Add Function
              </button>
              <button class="btn btn-secondary" onclick="clearFunctionForm()" style="margin-top: 15px;">
                Clear Form
              </button>
            </div>
          </div>

          <!-- Existing Functions List -->
          <div style="margin-top: 30px;">
            <h3 style="color: #333; margin-bottom: 15px;">Configured Functions</h3>
            <div id="functionsList">
              <!-- Dynamically populated -->
            </div>
          </div>
        </div>
      </div>

      <div id="analytics" class="tab-content">
        <div class="panel">
          <h2>üìà Call Analytics</h2>
          <p style="color: #666; margin-bottom: 20px;">Real-time call metrics and history from Twilio</p>

          <button class="btn" onclick="loadCallAnalytics()" id="loadAnalyticsBtn">
            üîÑ Load Call Data
          </button>
          <button class="btn btn-secondary" onclick="window.open('https://console.twilio.com/us1/monitor/logs/calls', '_blank')" style="margin-left: 10px;">
            View in Twilio Console
          </button>

          <div id="analyticsLoading" style="display: none; text-align: center; padding: 40px; color: #666;">
            <div style="font-size: 48px; margin-bottom: 15px;">‚è≥</div>
            <p>Loading call analytics from Twilio...</p>
          </div>

          <div id="analyticsError" style="display: none;"></div>

          <div id="analyticsContent" style="display: none;">
            <!-- Metrics Grid -->
            <div class="stats-grid" style="margin-top: 30px;">
              <div class="metric-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                <div class="metric-label">Total Calls</div>
                <div class="metric-value" id="metricTotalCalls">0</div>
              </div>
              <div class="metric-card" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                <div class="metric-label">Answered</div>
                <div class="metric-value" id="metricAnswered">0</div>
              </div>
              <div class="metric-card" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                <div class="metric-label">Failed</div>
                <div class="metric-value" id="metricFailed">0</div>
              </div>
              <div class="metric-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                <div class="metric-label">Avg Duration</div>
                <div class="metric-value" id="metricAvgDuration">0s</div>
              </div>
              <div class="metric-card" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                <div class="metric-label">Total Duration</div>
                <div class="metric-value" id="metricTotalDuration">0m</div>
              </div>
            </div>

            <!-- Date Range Info -->
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 20px 0; text-align: center; color: #666; font-size: 14px;">
              üìÖ Showing calls from <strong id="dateRangeFrom">--</strong> to <strong id="dateRangeTo">--</strong>
              for phone number <strong id="phoneNumberDisplay">--</strong>
            </div>

            <!-- Call History Table -->
            <div style="margin-top: 30px;">
              <h3 style="color: #333; margin-bottom: 15px;">Recent Call History</h3>
              <div style="overflow-x: auto;">
                <table id="callHistoryTable" style="width: 100%; border-collapse: collapse; background: white;">
                  <thead>
                    <tr style="background: #f8f9fa; border-bottom: 2px solid #e0e0e0;">
                      <th style="padding: 12px; text-align: left; font-weight: 600; color: #333;">Date & Time</th>
                      <th style="padding: 12px; text-align: left; font-weight: 600; color: #333;">From</th>
                      <th style="padding: 12px; text-align: left; font-weight: 600; color: #333;">Direction</th>
                      <th style="padding: 12px; text-align: left; font-weight: 600; color: #333;">Status</th>
                      <th style="padding: 12px; text-align: right; font-weight: 600; color: #333;">Duration</th>
                      <th style="padding: 12px; text-align: left; font-weight: 600; color: #333;">Call SID</th>
                    </tr>
                  </thead>
                  <tbody id="callHistoryBody">
                    <!-- Dynamically populated -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div id="analyticsEmpty" style="display: none; background: #f8f9fa; padding: 40px; border-radius: 8px; text-align: center; margin-top: 20px;">
            <div style="font-size: 64px; margin-bottom: 15px;">üìû</div>
            <p style="color: #666; font-size: 16px; margin-bottom: 10px;">No calls found</p>
            <p style="color: #999; font-size: 14px;">Make a test call to see analytics appear here!</p>
          </div>
        </div>
      </div>

      <div id="logs" class="tab-content">
        <div class="panel">
          <h2>üìã Session Logs</h2>
          <p style="color: #666; margin-bottom: 20px;">View detailed session events for troubleshooting errors, navigation patterns, and API call issues</p>

          <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
            <select id="logEventTypeFilter" class="config-select" style="flex: 0 0 200px;" onchange="applyLogFilters()">
              <option value="">All Event Types</option>
              <option value="navigation">üß≠ Navigation</option>
              <option value="error">‚ùå Errors</option>
              <option value="action">‚úÖ Actions</option>
              <option value="api_call">üîó API Calls</option>
              <option value="state_change">üîÑ State Changes</option>
            </select>
            <input type="number" id="logLimitInput" class="config-select" placeholder="Limit (default 100)" min="10" max="500" style="flex: 0 0 150px;" />
            <button class="btn" onclick="loadSessionLogs()" id="loadLogsBtn">
              üîÑ Load Logs
            </button>
            <button class="btn btn-secondary" onclick="clearLogFilters()">
              Clear Filters
            </button>
          </div>

          <div id="logsLoading" style="display: none; text-align: center; padding: 40px; color: #666;">
            <div style="font-size: 48px; margin-bottom: 15px;">‚è≥</div>
            <p>Loading session logs...</p>
          </div>

          <div id="logsError" style="display: none;"></div>

          <div id="logsContent" style="display: none;">
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
              <strong id="logsCount">0</strong> events found
            </div>

            <div id="logsList" style="max-height: 700px; overflow-y: auto;">
              <!-- Dynamically populated -->
            </div>
          </div>

          <div id="logsEmpty" style="display: none; background: #f8f9fa; padding: 40px; border-radius: 8px; text-align: center; margin-top: 20px;">
            <div style="font-size: 64px; margin-bottom: 15px;">üìã</div>
            <p style="color: #666; font-size: 16px; margin-bottom: 10px;">No logs found</p>
            <p style="color: #999; font-size: 14px;">Session logs will appear as you use the workshop!</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let config = {};
    let SESSION_TOKEN = '';
    const API_BASE = window.location.origin;

    // Get session token from URL param or localStorage
    function getSessionToken() {
      const urlParams = new URLSearchParams(window.location.search);
      const tokenFromUrl = urlParams.get('session');
      const tokenFromStorage = localStorage.getItem('sessionToken');
      return tokenFromUrl || tokenFromStorage || '';
    }

    async function loadConfig() {
      try {
        SESSION_TOKEN = getSessionToken();

        if (!SESSION_TOKEN) {
          throw new Error('No session token found. Please access this page from the workshop.');
        }

        const response = await fetch(`${API_BASE}/api/student-config-get?sessionToken=${SESSION_TOKEN}`);
        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Failed to load configuration');
        }

        config = data.config;
        renderConfig();

        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
      } catch (error) {
        console.error('Load error:', error);
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('errorState').style.display = 'block';
        document.getElementById('errorMessage').textContent = error.message;
      }
    }

    function renderConfig() {
      document.getElementById('useCaseDisplay').textContent = config.useCaseDescription || 'Voice AI Assistant';
      document.getElementById('sessionTokenDisplay').textContent = SESSION_TOKEN.substring(0, 30) + '...';
      document.getElementById('callDirectionMetric').textContent =
        (config.callDirection || 'inbound') === 'inbound' ? 'üì• Inbound' : 'üì§ Outbound';
      document.getElementById('ttsProviderMetric').textContent = getTTSProviderName(config.ttsProvider);

      const settingsContent = document.getElementById('settingsContent');
      settingsContent.innerHTML = `
        <div class="setting-card">
          <h3>üìû Phone Number</h3>
          <div class="setting-value">${config.selectedPhoneNumber || 'Not configured'}</div>
        </div>
        <div class="setting-card">
          <h3>üîä TTS Provider</h3>
          <div class="setting-value">${getTTSProviderName(config.ttsProvider)}</div>
        </div>
        <div class="setting-card">
          <h3>üéôÔ∏è Voice</h3>
          <div class="setting-value">${config.selectedVoice || 'Default'}</div>
        </div>
        <div class="setting-card">
          <h3>üåê WebSocket URL</h3>
          <div class="setting-value">${config.websocketUrl || 'Not deployed'}</div>
        </div>
        <div class="setting-card">
          <h3>üë§ Student Name</h3>
          <div class="setting-value">${config.studentName || 'Anonymous'}</div>
        </div>
      `;

      document.getElementById('systemPromptEditor').value = config.systemPrompt || '';
      document.getElementById('ivrGreetingEditor').value = config.ivrGreeting || '';

      // Initialize AI Configuration controls
      const aiProvider = config.aiProvider || 'openai';
      const ttsProvider = config.ttsProvider || 'elevenlabs';

      document.getElementById('aiProviderSelect').value = aiProvider;
      document.getElementById('ttsProviderSelect').value = ttsProvider;
      document.getElementById('currentTTSProvider').textContent = getTTSProviderName(ttsProvider);

      populateAIModels(aiProvider);
      populateVoices(ttsProvider);

      if (config.aiModel) document.getElementById('aiModelSelect').value = config.aiModel;
      if (config.selectedVoice) document.getElementById('voiceSelect').value = config.selectedVoice;
      if (config.aiTemperature) {
        document.getElementById('temperatureSlider').value = config.aiTemperature;
        document.getElementById('temperatureValue').textContent = config.aiTemperature;
      }
      if (config.aiMaxTokens) document.getElementById('maxTokensInput').value = config.aiMaxTokens;

      // Initialize ConversationRelay controls
      if (config.vadMode) document.getElementById('vadSelect').value = config.vadMode;
      if (config.interruptible !== undefined) document.getElementById('interruptibleCheckbox').checked = config.interruptible;
      if (config.sttProvider) document.getElementById('sttProviderSelect').value = config.sttProvider;
      if (config.bargeInSensitivity) {
        document.getElementById('bargeInSlider').value = config.bargeInSensitivity;
        document.getElementById('bargeInValue').textContent = config.bargeInSensitivity;
      }

      // Render functions list
      renderFunctions();
    }

    function getTTSProviderName(provider) {
      const providers = {
        'elevenlabs': 'ElevenLabs',
        'google': 'Google TTS',
        'deepgram': 'Deepgram Aura',
        'amazon': 'Amazon Polly'
      };
      return providers[provider] || 'Unknown';
    }

    async function updateSystemPrompt() {
      const newPrompt = document.getElementById('systemPromptEditor').value;

      try {
        const response = await fetch(`${API_BASE}/api/student-config-update`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sessionToken: SESSION_TOKEN,
            systemPrompt: newPrompt
          })
        });

        const data = await response.json();

        if (data.success) {
          alert('‚úÖ System prompt updated successfully!');
          config.systemPrompt = newPrompt;
        } else {
          alert('‚ùå Failed to update: ' + data.error);
        }
      } catch (error) {
        alert('‚ùå Error: ' + error.message);
      }
    }

    async function updateIvrGreeting() {
      const newGreeting = document.getElementById('ivrGreetingEditor').value;

      try {
        const response = await fetch(`${API_BASE}/api/student-config-update`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sessionToken: SESSION_TOKEN,
            ivrGreeting: newGreeting
          })
        });

        const data = await response.json();

        if (data.success) {
          alert('‚úÖ IVR greeting updated successfully!');
          config.ivrGreeting = newGreeting;
        } else {
          alert('‚ùå Failed to update: ' + data.error);
        }
      } catch (error) {
        alert('‚ùå Error: ' + error.message);
      }
    }

    function showTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(btn => btn.classList.remove('active'));
      document.getElementById(tabName).classList.add('active');
      event.target.classList.add('active');
    }

    // =========================================================================
    // FUNCTIONS TAB - Function Management
    // =========================================================================

    function renderFunctions() {
      const functionsList = document.getElementById('functionsList');

      // Ensure tools is always an array
      let tools = config.tools || [];
      if (typeof tools === 'string') {
        try {
          tools = JSON.parse(tools);
        } catch (e) {
          console.error('Failed to parse tools:', e);
          tools = [];
        }
      }
      if (!Array.isArray(tools)) {
        console.error('tools is not an array:', typeof tools, tools);
        tools = [];
      }

      if (tools.length === 0) {
        functionsList.innerHTML = `
          <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 8px; color: #666;">
            <div style="font-size: 48px; margin-bottom: 15px;">üõ†Ô∏è</div>
            <p style="font-size: 16px; margin-bottom: 10px;">No functions configured yet</p>
            <p style="font-size: 14px;">Add your first function above to extend your AI's capabilities!</p>
          </div>
        `;
        return;
      }

      functionsList.innerHTML = tools.map((tool, index) => {
        const func = tool.function || tool; // Support both formats
        return `
        <div class="setting-card" style="margin-bottom: 15px;">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
            <div style="flex: 1;">
              <h3 style="margin: 0 0 5px 0; color: #667eea;">${func.name || 'Unnamed Function'}</h3>
              <p style="color: #666; font-size: 13px; margin: 0;">${func.description || 'No description'}</p>
              ${func.webhook_url ? `
                <div style="margin-top: 8px; padding: 8px; background: #e0f2fe; border-radius: 4px; border-left: 3px solid #0369a1;">
                  <div style="font-size: 11px; color: #075985; font-weight: 600; margin-bottom: 3px;">üîó WEBHOOK URL</div>
                  <div style="font-size: 11px; color: #0c4a6e; font-family: monospace; word-break: break-all;">${func.webhook_url}</div>
                </div>
              ` : `
                <div style="margin-top: 8px; padding: 6px; background: #fef3c7; border-radius: 4px; font-size: 11px; color: #92400e;">
                  ‚ö†Ô∏è Simulated mode (no webhook configured)
                </div>
              `}
            </div>
            <div style="display: flex; gap: 10px;">
              <button class="btn-secondary" onclick="editFunction(${index})" style="padding: 6px 12px; font-size: 12px; cursor: pointer; background: #667eea; color: white; border: none; border-radius: 4px;">
                ‚úèÔ∏è Edit
              </button>
              <button class="btn-secondary" onclick="deleteFunction(${index})" style="padding: 6px 12px; font-size: 12px; cursor: pointer; background: #ef4444; color: white; border: none; border-radius: 4px;">
                üóëÔ∏è Delete
              </button>
            </div>
          </div>
          ${func.parameters ? `
            <details style="margin-top: 10px;">
              <summary style="cursor: pointer; color: #667eea; font-size: 13px; font-weight: 600;">View Parameters</summary>
              <pre style="background: #2c313c; color: #abb2bf; padding: 10px; border-radius: 6px; font-size: 12px; overflow-x: auto; margin-top: 10px;">${JSON.stringify(func.parameters, null, 2)}</pre>
            </details>
          ` : ''}
        </div>
      `;
      }).join('');
    }

    async function addFunction() {
      const name = document.getElementById('newFunctionName').value.trim();
      const description = document.getElementById('newFunctionDescription').value.trim();
      const webhookUrl = document.getElementById('newFunctionWebhookUrl').value.trim();
      const parametersText = document.getElementById('newFunctionParameters').value.trim();

      // Validation
      if (!name) {
        alert('‚ùå Function name is required');
        return;
      }

      if (!description) {
        alert('‚ùå Function description is required');
        return;
      }

      // Parse parameters JSON
      let parameters;
      if (parametersText) {
        try {
          parameters = JSON.parse(parametersText);
        } catch (error) {
          alert('‚ùå Invalid JSON in parameters. Please check your syntax.');
          return;
        }
      }

      // Create new function object
      const newFunction = {
        type: 'function',
        function: {
          name: name,
          description: description,
          parameters: parameters || {
            type: 'object',
            properties: {},
            required: []
          }
        }
      };

      // Add webhook_url if provided
      if (webhookUrl) {
        newFunction.function.webhook_url = webhookUrl;
      }

      // Add to tools array
      const updatedTools = [...(config.tools || []), newFunction];

      try {
        // Save to database
        const response = await fetch(`${API_BASE}/api/student-config-update`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sessionToken: SESSION_TOKEN,
            tools: updatedTools
          })
        });

        const data = await response.json();

        if (data.success) {
          alert('‚úÖ Function added successfully!');
          config.tools = updatedTools;
          renderFunctions();
          clearFunctionForm();

          // Sync to OpenAI Assistant (if OpenAI key available)
          syncToOpenAIAssistant();
        } else {
          alert('‚ùå Failed to add function: ' + data.error);
        }
      } catch (error) {
        alert('‚ùå Error: ' + error.message);
      }
    }

    async function deleteFunction(index) {
      if (!confirm('Are you sure you want to delete this function?')) {
        return;
      }

      const updatedTools = [...(config.tools || [])];
      updatedTools.splice(index, 1);

      try {
        const response = await fetch(`${API_BASE}/api/student-config-update`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sessionToken: SESSION_TOKEN,
            tools: updatedTools
          })
        });

        const data = await response.json();

        if (data.success) {
          alert('‚úÖ Function deleted successfully!');
          config.tools = updatedTools;
          renderFunctions();

          // Sync to OpenAI Assistant (if OpenAI key available)
          syncToOpenAIAssistant();
        } else {
          alert('‚ùå Failed to delete function: ' + data.error);
        }
      } catch (error) {
        alert('‚ùå Error: ' + error.message);
      }
    }

    function editFunction(index) {
      const tool = config.tools[index];
      if (!tool || !tool.function) return;

      // Populate form with existing values
      document.getElementById('newFunctionName').value = tool.function.name || '';
      document.getElementById('newFunctionDescription').value = tool.function.description || '';
      document.getElementById('newFunctionWebhookUrl').value = tool.function.webhook_url || '';
      document.getElementById('newFunctionParameters').value = JSON.stringify(tool.function.parameters, null, 2);

      // Delete the old one (will be re-added when they save)
      deleteFunction(index);

      // Scroll to form
      document.querySelector('#functions .setting-card').scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function clearFunctionForm() {
      document.getElementById('newFunctionName').value = '';
      document.getElementById('newFunctionDescription').value = '';
      document.getElementById('newFunctionWebhookUrl').value = '';
      document.getElementById('newFunctionParameters').value = '';
    }

    /**
     * Syncs tools to OpenAI Assistant
     * Creates or updates the Assistant with current tool configuration
     */
    async function syncToOpenAIAssistant() {
      // Check if we have an OpenAI key (from localStorage)
      const openaiKey = localStorage.getItem('openaiApiKey');

      if (!openaiKey) {
        console.log('‚ö†Ô∏è No OpenAI API key found in localStorage - skipping Assistant sync');
        return;
      }

      try {
        console.log('üîÑ Syncing tools to OpenAI Assistant...');

        const response = await fetch(`${API_BASE}/api/openai-create-assistant`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sessionToken: SESSION_TOKEN,
            openaiApiKey: openaiKey,
            systemPrompt: config.systemPrompt || '',
            tools: config.tools || [],
            assistantName: `${config.studentName || 'Voice AI'} Assistant`
          })
        });

        const data = await response.json();

        if (data.success) {
          console.log(`‚úÖ OpenAI Assistant ${data.action}:`, data.assistantId);
          console.log(`   Tools synced: ${data.toolsCount}`);
        } else {
          console.warn('‚ö†Ô∏è Failed to sync to OpenAI:', data.error);
        }
      } catch (error) {
        console.error('‚ùå OpenAI sync error:', error);
      }
    }

    // =========================================================================
    // CALL ANALYTICS TAB
    // =========================================================================

    async function loadCallAnalytics() {
      const btn = document.getElementById('loadAnalyticsBtn');
      btn.disabled = true;
      btn.textContent = '‚è≥ Loading...';

      // Hide all states
      document.getElementById('analyticsLoading').style.display = 'block';
      document.getElementById('analyticsError').style.display = 'none';
      document.getElementById('analyticsContent').style.display = 'none';
      document.getElementById('analyticsEmpty').style.display = 'none';

      try {
        // Get Twilio credentials from workshop progress
        let accountSid = null;
        let authToken = null;

        // First try: Get from workshop progress (stored as object)
        try {
          const storageKey = `workshop_progress_${SESSION_TOKEN}`;
          const progressData = localStorage.getItem(storageKey);
          if (progressData) {
            const progress = JSON.parse(progressData);
            if (progress.twilioCredentials) {
              accountSid = progress.twilioCredentials.accountSid;
              authToken = progress.twilioCredentials.authToken;
              console.log('‚úÖ Loaded Twilio credentials from workshop progress');
            }
          }
        } catch (parseError) {
          console.warn('Could not parse workshop progress:', parseError);
        }

        // Second try: Get from separate localStorage keys (legacy/fallback)
        if (!accountSid || !authToken) {
          accountSid = localStorage.getItem('twilioAccountSid');
          authToken = localStorage.getItem('twilioAuthToken');
          if (accountSid && authToken) {
            console.log('‚úÖ Loaded Twilio credentials from localStorage keys');
          }
        }

        if (!accountSid || !authToken) {
          throw new Error('Twilio credentials not found. Please connect your Twilio account in the workshop first.');
        }

        console.log('üìä Fetching call analytics...');

        const response = await fetch(`${API_BASE}/api/twilio-call-analytics`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sessionToken: SESSION_TOKEN,
            accountSid: accountSid,
            authToken: authToken
          })
        });

        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Failed to load call analytics');
        }

        console.log('‚úÖ Call analytics loaded:', data);

        // Hide loading
        document.getElementById('analyticsLoading').style.display = 'none';

        // Show results or empty state
        if (data.calls.length === 0) {
          document.getElementById('analyticsEmpty').style.display = 'block';
        } else {
          renderCallAnalytics(data);
          document.getElementById('analyticsContent').style.display = 'block';
        }

      } catch (error) {
        console.error('Analytics error:', error);
        document.getElementById('analyticsLoading').style.display = 'none';
        document.getElementById('analyticsError').style.display = 'block';
        document.getElementById('analyticsError').innerHTML = `
          <div class="error">
            <h3 style="margin-bottom: 10px;">‚ùå Failed to Load Call Analytics</h3>
            <p>${error.message}</p>
          </div>
        `;
      } finally {
        btn.disabled = false;
        btn.textContent = 'üîÑ Reload Call Data';
      }
    }

    function renderCallAnalytics(data) {
      const { calls, metrics, phoneNumber, dateRange } = data;

      // Update metrics
      document.getElementById('metricTotalCalls').textContent = metrics.totalCalls;
      document.getElementById('metricAnswered').textContent = metrics.answeredCalls;
      document.getElementById('metricFailed').textContent = metrics.failedCalls;
      document.getElementById('metricAvgDuration').textContent = formatDuration(metrics.averageDuration);
      document.getElementById('metricTotalDuration').textContent = formatDuration(metrics.totalDuration);

      // Update date range
      document.getElementById('dateRangeFrom').textContent = new Date(dateRange.from).toLocaleDateString();
      document.getElementById('dateRangeTo').textContent = new Date(dateRange.to).toLocaleDateString();
      document.getElementById('phoneNumberDisplay').textContent = phoneNumber;

      // Render call history table
      const tbody = document.getElementById('callHistoryBody');
      tbody.innerHTML = calls.map(call => {
        const statusColor = getStatusColor(call.status);
        const statusEmoji = getStatusEmoji(call.status);

        return `
          <tr style="border-bottom: 1px solid #e0e0e0;">
            <td style="padding: 12px;">${formatDateTime(call.startTime)}</td>
            <td style="padding: 12px; font-family: monospace; font-size: 13px;">${call.from}</td>
            <td style="padding: 12px;">
              <span style="color: ${call.direction === 'inbound' ? '#3b82f6' : '#10b981'};">
                ${call.direction === 'inbound' ? 'üì•' : 'üì§'} ${call.direction}
              </span>
            </td>
            <td style="padding: 12px;">
              <span style="padding: 4px 10px; background: ${statusColor}20; color: ${statusColor}; border-radius: 12px; font-size: 12px; font-weight: 600;">
                ${statusEmoji} ${call.status}
              </span>
            </td>
            <td style="padding: 12px; text-align: right; font-weight: 600;">${formatDuration(call.duration)}</td>
            <td style="padding: 12px; font-family: monospace; font-size: 11px; color: #666;">
              ${call.sid.substring(0, 20)}...
            </td>
          </tr>
        `;
      }).join('');
    }

    function formatDuration(seconds) {
      if (seconds === 0) return '0s';
      if (seconds < 60) return `${seconds}s`;
      const minutes = Math.floor(seconds / 60);
      const remainingSeconds = seconds % 60;
      return remainingSeconds > 0 ? `${minutes}m ${remainingSeconds}s` : `${minutes}m`;
    }

    function formatDateTime(dateString) {
      const date = new Date(dateString);
      return date.toLocaleString('en-US', {
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function getStatusColor(status) {
      const colors = {
        'completed': '#10b981',
        'in-progress': '#f59e0b',
        'ringing': '#f59e0b',
        'failed': '#ef4444',
        'busy': '#ef4444',
        'no-answer': '#ef4444',
        'canceled': '#6c757d'
      };
      return colors[status] || '#6c757d';
    }

    function getStatusEmoji(status) {
      const emojis = {
        'completed': '‚úÖ',
        'in-progress': '‚è≥',
        'ringing': 'üìû',
        'failed': '‚ùå',
        'busy': 'üö´',
        'no-answer': 'üìµ',
        'canceled': 'üõë'
      };
      return emojis[status] || '‚ùì';
    }

    // =========================================================================
    // AI CONFIGURATION TAB
    // =========================================================================

    function updateAIProvider() {
      const provider = document.getElementById('aiProviderSelect').value;
      document.getElementById('currentAIProvider').textContent =
        provider === 'openai' ? 'OpenAI' :
        provider === 'anthropic' ? 'Anthropic (Claude)' :
        provider === 'google' ? 'Google (Gemini)' :
        provider === 'azure' ? 'Azure OpenAI' : provider;

      // Update available models based on provider
      populateAIModels(provider);

      // Save to database
      saveConfigField('aiProvider', provider);
    }

    function populateAIModels(provider) {
      const modelSelect = document.getElementById('aiModelSelect');
      const models = {
        'openai': [
          { value: 'gpt-4-turbo', label: 'GPT-4 Turbo (Recommended)' },
          { value: 'gpt-4', label: 'GPT-4 (Most capable)' },
          { value: 'gpt-3.5-turbo', label: 'GPT-3.5 Turbo (Fastest)' }
        ],
        'anthropic': [
          { value: 'claude-3-opus', label: 'Claude 3 Opus (Most capable)' },
          { value: 'claude-3-sonnet', label: 'Claude 3 Sonnet (Balanced)' },
          { value: 'claude-3-haiku', label: 'Claude 3 Haiku (Fastest)' }
        ],
        'google': [
          { value: 'gemini-pro', label: 'Gemini Pro' },
          { value: 'gemini-pro-vision', label: 'Gemini Pro Vision' }
        ],
        'azure': [
          { value: 'gpt-4-turbo', label: 'GPT-4 Turbo' },
          { value: 'gpt-35-turbo', label: 'GPT-3.5 Turbo' }
        ]
      };

      modelSelect.innerHTML = (models[provider] || []).map(m =>
        `<option value="${m.value}">${m.label}</option>`
      ).join('');
    }

    function updateAIModel() {
      const model = document.getElementById('aiModelSelect').value;
      saveConfigField('aiModel', model);
    }

    function updateTTSProvider() {
      const provider = document.getElementById('ttsProviderSelect').value;
      document.getElementById('currentTTSProvider').textContent = getTTSProviderName(provider);

      // Update available voices based on provider
      populateVoices(provider);

      // Save to database
      saveConfigField('ttsProvider', provider);
    }

    function populateVoices(provider) {
      const voiceSelect = document.getElementById('voiceSelect');
      const voices = {
        'elevenlabs': [
          { value: 'rachel', label: 'Rachel (Warm, friendly)' },
          { value: 'domi', label: 'Domi (Professional)' },
          { value: 'bella', label: 'Bella (Soft, calm)' },
          { value: 'antoni', label: 'Antoni (Deep, authoritative)' }
        ],
        'google': [
          { value: 'en-US-Neural2-A', label: 'Neural2-A (Male)' },
          { value: 'en-US-Neural2-C', label: 'Neural2-C (Female)' },
          { value: 'en-US-Neural2-D', label: 'Neural2-D (Male)' },
          { value: 'en-US-Neural2-F', label: 'Neural2-F (Female)' }
        ],
        'deepgram': [
          { value: 'aura-asteria-en', label: 'Asteria (Warm)' },
          { value: 'aura-luna-en', label: 'Luna (Professional)' },
          { value: 'aura-stella-en', label: 'Stella (Friendly)' },
          { value: 'aura-athena-en', label: 'Athena (Authoritative)' }
        ],
        'amazon': [
          { value: 'Joanna', label: 'Joanna (Female, US)' },
          { value: 'Matthew', label: 'Matthew (Male, US)' },
          { value: 'Salli', label: 'Salli (Female, US)' },
          { value: 'Joey', label: 'Joey (Male, US)' }
        ]
      };

      voiceSelect.innerHTML = (voices[provider] || []).map(v =>
        `<option value="${v.value}">${v.label}</option>`
      ).join('');
    }

    function updateVoice() {
      const voice = document.getElementById('voiceSelect').value;
      saveConfigField('selectedVoice', voice);
    }

    function previewVoice() {
      alert('üîä Voice preview feature coming soon! For now, make a test call to hear your selected voice.');
    }

    function updateTemperature(value) {
      document.getElementById('temperatureValue').textContent = value;
    }

    function saveTemperature() {
      const temperature = parseFloat(document.getElementById('temperatureSlider').value);
      saveConfigField('aiTemperature', temperature);
      alert(`‚úÖ AI temperature set to ${temperature}`);
    }

    function saveMaxTokens() {
      const maxTokens = parseInt(document.getElementById('maxTokensInput').value);
      saveConfigField('aiMaxTokens', maxTokens);
      alert(`‚úÖ Max response tokens set to ${maxTokens}`);
    }

    // =========================================================================
    // CONVERSATIONRELAY CONFIGURATION TAB
    // =========================================================================

    function updateVAD() {
      const vad = document.getElementById('vadSelect').value;
      saveConfigField('vadMode', vad);
      alert(`‚úÖ Voice Activity Detection set to: ${vad}`);
    }

    function updateInterruptible() {
      const interruptible = document.getElementById('interruptibleCheckbox').checked;
      saveConfigField('interruptible', interruptible);
      alert(`‚úÖ Interruptions ${interruptible ? 'enabled' : 'disabled'}`);
    }

    function updateSTTProvider() {
      const sttProvider = document.getElementById('sttProviderSelect').value;
      saveConfigField('sttProvider', sttProvider);
      alert(`‚úÖ Speech-to-Text provider set to: ${sttProvider}`);
    }

    function updateBargeInDisplay(value) {
      document.getElementById('bargeInValue').textContent = value;
    }

    function saveBargeInSensitivity() {
      const sensitivity = parseInt(document.getElementById('bargeInSlider').value);
      saveConfigField('bargeInSensitivity', sensitivity);
      alert(`‚úÖ Barge-in sensitivity set to: ${sensitivity}`);
    }

    // =========================================================================
    // HELPER FUNCTIONS
    // =========================================================================

    async function saveConfigField(fieldName, value) {
      try {
        const response = await fetch(`${API_BASE}/api/student-config-update`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sessionToken: SESSION_TOKEN,
            [fieldName]: value
          })
        });

        const data = await response.json();

        if (data.success) {
          config[fieldName] = value;
          console.log(`‚úÖ Saved ${fieldName}:`, value);
        } else {
          console.error(`‚ùå Failed to save ${fieldName}:`, data.error);
        }
      } catch (error) {
        console.error(`‚ùå Error saving ${fieldName}:`, error);
      }
    }

    // =========================================================================
    // SESSION LOGS TAB
    // =========================================================================

    async function loadSessionLogs() {
      const btn = document.getElementById('loadLogsBtn');
      btn.disabled = true;
      btn.textContent = '‚è≥ Loading...';

      document.getElementById('logsLoading').style.display = 'block';
      document.getElementById('logsError').style.display = 'none';
      document.getElementById('logsContent').style.display = 'none';
      document.getElementById('logsEmpty').style.display = 'none';

      try {
        const eventType = document.getElementById('logEventTypeFilter').value;
        const limit = document.getElementById('logLimitInput').value || 100;

        let url = `${API_BASE}/api/session-log?sessionToken=${SESSION_TOKEN}&limit=${limit}`;
        if (eventType) {
          url += `&eventType=${eventType}`;
        }

        const response = await fetch(url);
        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Failed to load session logs');
        }

        document.getElementById('logsLoading').style.display = 'none';

        if (data.events.length === 0) {
          document.getElementById('logsEmpty').style.display = 'block';
        } else {
          renderSessionLogs(data.events);
          document.getElementById('logsCount').textContent = data.events.length;
          document.getElementById('logsContent').style.display = 'block';
        }

      } catch (error) {
        console.error('Logs error:', error);
        document.getElementById('logsLoading').style.display = 'none';
        document.getElementById('logsError').style.display = 'block';
        document.getElementById('logsError').innerHTML = `
          <div class="error">
            <h3 style="margin-bottom: 10px;">‚ùå Failed to Load Session Logs</h3>
            <p>${error.message}</p>
          </div>
        `;
      } finally {
        btn.disabled = false;
        btn.textContent = 'üîÑ Load Logs';
      }
    }

    function renderSessionLogs(events) {
      const logsList = document.getElementById('logsList');

      logsList.innerHTML = events.map(event => {
        const eventData = typeof event.event_data === 'string' ? JSON.parse(event.event_data) : event.event_data;
        const timestamp = new Date(event.created_at).toLocaleString();

        const typeConfig = {
          'navigation': { emoji: 'üß≠', color: '#3b82f6', label: 'Navigation' },
          'error': { emoji: '‚ùå', color: '#ef4444', label: 'Error' },
          'action': { emoji: '‚úÖ', color: '#10b981', label: 'Action' },
          'api_call': { emoji: 'üîó', color: '#8b5cf6', label: 'API Call' },
          'state_change': { emoji: 'üîÑ', color: '#f59e0b', label: 'State Change' }
        };

        const config = typeConfig[event.event_type] || { emoji: 'üìã', color: '#6c757d', label: event.event_type };

        return `
          <div class="setting-card" style="margin-bottom: 15px; border-left: 4px solid ${config.color};">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
              <div style="display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 24px;">${config.emoji}</span>
                <div>
                  <div style="font-weight: 600; color: ${config.color};">${config.label}</div>
                  <div style="font-size: 0.85rem; color: #666; margin-top: 3px;">${timestamp}</div>
                </div>
              </div>
            </div>

            ${eventData.errorMessage ? `
              <div style="padding: 10px; background: #fee; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid #ef4444;">
                <strong style="color: #991b1b;">Error:</strong> ${eventData.errorMessage}
                ${eventData.errorType ? `<div style="font-size: 0.85rem; color: #666; margin-top: 5px;">Type: ${eventData.errorType}</div>` : ''}
              </div>
            ` : ''}

            <details style="margin-top: 10px;">
              <summary style="cursor: pointer; color: #667eea; font-size: 13px; font-weight: 600;">View Event Data</summary>
              <pre style="background: #2c313c; color: #abb2bf; padding: 15px; border-radius: 6px; font-size: 12px; overflow-x: auto; margin-top: 10px; line-height: 1.5;">${JSON.stringify(eventData, null, 2)}</pre>
            </details>
          </div>
        `;
      }).join('');
    }

    function applyLogFilters() {
      // Auto-load when filter changes
      loadSessionLogs();
    }

    function clearLogFilters() {
      document.getElementById('logEventTypeFilter').value = '';
      document.getElementById('logLimitInput').value = '';
      loadSessionLogs();
    }

    loadConfig();
  </script>
</body>
</html>
