<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Voice AI Admin Panel</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container { max-width: 1400px; margin: 0 auto; }

    .header {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .header h1 {
      color: #333;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }

    .status-badge {
      display: inline-block;
      padding: 6px 16px;
      background: #10b981;
      color: white;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .tabs {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin-bottom: 20px;
    }

    .tab {
      background: rgba(255,255,255,0.9);
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      color: #667eea;
      transition: all 0.3s;
    }

    .tab:hover { background: white; transform: translateY(-2px); }
    .tab.active { background: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .panel {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .panel h2 {
      color: #333;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #e0e0e0;
    }

    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .setting-card {
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 20px;
    }

    .setting-card h3 {
      color: #667eea;
      margin-bottom: 10px;
      font-size: 16px;
    }

    .setting-value {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 6px;
      font-family: monospace;
      font-size: 13px;
      color: #333;
      word-break: break-all;
    }

    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      margin-top: 10px;
      transition: transform 0.2s;
    }

    .btn:hover { transform: scale(1.05); }
    .btn-secondary { background: #6c757d; }

    .metric-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }

    .metric-value {
      font-size: 36px;
      font-weight: bold;
      margin: 10px 0;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .code-block {
      background: #2c313c;
      color: #abb2bf;
      padding: 20px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
      overflow-x: auto;
      margin-top: 15px;
      white-space: pre-wrap;
    }

    textarea {
      width: 100%;
      min-height: 200px;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-family: monospace;
      font-size: 13px;
      margin-top: 10px;
    }

    input[type="text"], input[type="number"], input[type="password"] {
      width: 100%;
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
      margin-top: 10px;
    }

    .config-select {
      width: 100%;
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
      background: white;
      cursor: pointer;
      margin-top: 5px;
    }

    .config-select:hover {
      border-color: #667eea;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .error {
      background: #fee;
      color: #c00;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>
        ü§ñ Voice AI Admin Panel
        <span class="status-badge">‚óè LIVE</span>
      </h1>
      <p id="useCaseDisplay">Loading your configuration...</p>
    </div>

    <div id="loadingState" class="panel loading">
      <div style="font-size: 48px; margin-bottom: 15px;">‚è≥</div>
      <p>Loading your Voice AI configuration...</p>
    </div>

    <div id="errorState" style="display: none;">
      <div class="panel">
        <div class="error">
          <h3 style="margin-bottom: 10px;">‚ùå Failed to Load Configuration</h3>
          <p id="errorMessage"></p>
        </div>
      </div>
    </div>

    <div id="mainContent" style="display: none;">
      <div class="tabs">
        <button class="tab active" onclick="showTab('overview')">üìä Overview</button>
        <button class="tab" onclick="showTab('settings')">üîê Settings</button>
        <button class="tab" onclick="showTab('ai-config')">ü§ñ AI Configuration</button>
        <button class="tab" onclick="showTab('conversationrelay')">‚òéÔ∏è ConversationRelay</button>
        <button class="tab" onclick="showTab('prompts')">üìù Prompts</button>
        <button class="tab" onclick="showTab('functions')">üõ†Ô∏è Functions</button>
        <button class="tab" onclick="showTab('memory')">üß† Memory</button>
        <button class="tab" onclick="showTab('analytics')">üìà Analytics</button>
      </div>

      <div id="overview" class="tab-content active">
        <div class="panel">
          <h2>System Overview</h2>

          <!-- Service Connection Status -->
          <div id="setupPrompt" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; gap: 20px; flex-wrap: wrap;">
              <div style="flex: 1; min-width: 200px;">
                <h3 style="margin: 0 0 10px 0; color: white;">üîå Connect Your Services</h3>
                <p style="margin: 0; opacity: 0.9; font-size: 14px;">Connect Twilio and OpenAI to start building your Voice AI</p>
              </div>
              <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button onclick="showTab('settings')" style="padding: 12px 24px; background: white; color: #667eea; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                  üìû Connect Twilio
                </button>
                <button onclick="showTab('settings'); setTimeout(() => document.getElementById('openaiApiKey').focus(), 300)" style="padding: 12px 24px; background: rgba(255,255,255,0.2); color: white; border: 2px solid white; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.2s;" onmouseover="this.style.background='white'; this.style.color='#667eea'" onmouseout="this.style.background='rgba(255,255,255,0.2)'; this.style.color='white'">
                  üß† Add OpenAI Key
                </button>
              </div>
            </div>
          </div>

          <div class="stats-grid">
            <div class="metric-card">
              <div class="metric-label">STT Provider</div>
              <div class="metric-value" style="font-size: 20px;" id="sttProviderMetric">--</div>
            </div>
            <div class="metric-card">
              <div class="metric-label">Call Direction</div>
              <div class="metric-value" style="font-size: 20px;" id="callDirectionMetric">--</div>
            </div>
            <div class="metric-card">
              <div class="metric-label">TTS Provider</div>
              <div class="metric-value" style="font-size: 20px;" id="ttsProviderMetric">--</div>
            </div>
            <div class="metric-card">
              <div class="metric-label">Status</div>
              <div class="metric-value" style="font-size: 20px;">üü¢ Active</div>
            </div>
          </div>

          <h3 style="margin-top: 30px; color: #333;">Use Case</h3>
          <div class="setting-card">
            <h3>üìã Use Case Description</h3>
            <p style="color: #666; font-size: 13px; margin: 10px 0;">Describe what your Voice AI does. Update this to regenerate all prompts.</p>
            <textarea id="useCaseEditor" style="min-height: 120px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;"></textarea>
            <button class="btn" onclick="updateUseCase()" style="margin-right: 10px;">üíæ Save Use Case</button>
            <button class="btn btn-secondary" onclick="regeneratePrompts()">‚ú® Regenerate AI Prompts</button>
          </div>

          <h3 style="margin-top: 30px; color: #333;">Quick Actions</h3>
          <div class="settings-grid">
            <div class="setting-card">
              <h3>üìû Test Your Voice AI</h3>
              <p id="callStatusText" style="margin-bottom: 15px;">
                Call <strong id="phoneNumberDisplay">your configured number</strong> from any phone to test
              </p>
              <div style="background: #f0f9ff; padding: 12px; border-radius: 6px; margin-bottom: 10px; border-left: 4px solid #0284c7;">
                <div style="font-size: 13px; color: #0c4a6e; margin-bottom: 5px;">
                  <strong>üéØ To test:</strong>
                </div>
                <ol style="margin: 0; padding-left: 20px; font-size: 13px; color: #075985;">
                  <li>Call <span id="phoneNumberToCall" style="font-weight: 600;">--</span> from your phone</li>
                  <li>The AI will answer and interact with you</li>
                  <li>Check Analytics tab to see call details</li>
                </ol>
              </div>
              <button class="btn" id="callButton" onclick="makeTestCall()" style="display: none;">üìû Browser Call (Advanced)</button>
              <button class="btn btn-secondary" id="hangupButton" onclick="hangupCall()" style="display: none; margin-left: 10px;">‚ùå Hang Up</button>
            </div>
            <div class="setting-card">
              <h3>üìä View Logs</h3>
              <p>Check Twilio Console</p>
              <button class="btn" onclick="window.open('https://console.twilio.com/us1/monitor/logs/calls?frameUrl=%2Fconsole%2Fvoice%2Fcalls%2Flogs%3Fx-target-region%3Dus1', '_blank')">Open Logs</button>
            </div>
          </div>
        </div>
      </div>

      <div id="ai-config" class="tab-content">
        <div class="panel">
          <h2>ü§ñ AI Configuration</h2>
          <p style="color: #666; margin-bottom: 30px;">
            Control every aspect of your AI voice assistant - no third-party platforms needed. You own the entire stack.
          </p>

          <div class="settings-grid">
            <!-- AI Provider Selection -->
            <div class="setting-card">
              <h3>üß† AI Provider</h3>
              <p style="color: #666; font-size: 13px; margin: 10px 0;">Choose your large language model provider</p>
              <select id="aiProviderSelect" class="config-select" onchange="updateAIProvider()">
                <option value="openai">OpenAI (GPT-4, GPT-3.5)</option>
                <option value="anthropic">Anthropic (Claude)</option>
                <option value="google">Google (Gemini)</option>
                <option value="azure">Azure OpenAI</option>
              </select>
              <div style="margin-top: 10px; padding: 10px; background: #f0f9ff; border-radius: 6px; font-size: 12px; color: #0369a1;">
                üí° Currently using: <strong id="currentAIProvider">OpenAI</strong>
              </div>
            </div>

            <!-- TTS Provider Selection -->
            <div class="setting-card">
              <h3>üîä Text-to-Speech Provider</h3>
              <p style="color: #666; font-size: 13px; margin: 10px 0;">Select your voice synthesis provider</p>
              <select id="ttsProviderSelect" class="config-select" onchange="updateTTSProvider()">
                <option value="elevenlabs">ElevenLabs (Ultra-realistic)</option>
                <option value="google">Google TTS (Reliable)</option>
                <option value="deepgram">Deepgram Aura (Low-latency)</option>
                <option value="amazon">Amazon Polly (Cost-effective)</option>
              </select>
              <div style="margin-top: 10px; padding: 10px; background: #f0f9ff; border-radius: 6px; font-size: 12px; color: #0369a1;">
                üí° Current: <strong id="currentTTSProvider">--</strong>
              </div>
            </div>

            <!-- Voice Selection -->
            <div class="setting-card">
              <h3>üéôÔ∏è Voice Selection</h3>
              <p style="color: #666; font-size: 13px; margin: 10px 0;">Choose the voice personality</p>
              <select id="voiceSelect" class="config-select" onchange="updateVoice()">
                <!-- Dynamically populated based on TTS provider -->
              </select>
            </div>

            <!-- AI Model Selection -->
            <div class="setting-card">
              <h3>‚ö° AI Model</h3>
              <p style="color: #666; font-size: 13px; margin: 10px 0;">Select the specific model version</p>
              <select id="aiModelSelect" class="config-select" onchange="updateAIModel()">
                <!-- Dynamically populated based on AI provider -->
              </select>
            </div>

            <!-- Temperature Control -->
            <div class="setting-card">
              <h3>üå°Ô∏è AI Temperature</h3>
              <p style="color: #666; font-size: 13px; margin: 10px 0;">Control response creativity (0 = focused, 2 = creative)</p>
              <input type="range" id="temperatureSlider" min="0" max="2" step="0.1" value="0.7"
                     style="width: 100%; margin: 10px 0;" oninput="updateTemperature(this.value)">
              <div style="display: flex; justify-content: space-between; font-size: 12px; color: #666;">
                <span>Focused (0)</span>
                <span id="temperatureValue" style="font-weight: bold; color: #667eea;">0.7</span>
                <span>Creative (2)</span>
              </div>
              <button class="btn" onclick="saveTemperature()" style="width: 100%; margin-top: 10px;">
                üíæ Save Temperature
              </button>
            </div>

            <!-- Max Response Length -->
            <div class="setting-card">
              <h3>üìè Max Response Tokens</h3>
              <p style="color: #666; font-size: 13px; margin: 10px 0;">Limit AI response length (for voice, keep under 150)</p>
              <input type="number" id="maxTokensInput" min="50" max="500" value="150"
                     style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px;">
              <button class="btn" onclick="saveMaxTokens()" style="width: 100%; margin-top: 10px;">
                üíæ Save Max Tokens
              </button>
            </div>
          </div>

          <div style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 12px; color: white;">
            <h3 style="color: white; margin: 0 0 10px 0;">‚ú® Why This Matters</h3>
            <p style="color: rgba(255,255,255,0.95); font-size: 14px; line-height: 1.6; margin: 0;">
              YOU control every aspect of your AI stack - no vendor lock-in or platform restrictions. Switch providers, adjust settings, and optimize costs with complete flexibility. This is your foundation to build upon.
            </p>
          </div>
        </div>
      </div>

      <div id="conversationrelay" class="tab-content">
        <div class="panel">
          <h2>‚òéÔ∏è ConversationRelay Configuration</h2>
          <p style="color: #666; margin-bottom: 30px;">
            Twilio's ConversationRelay connects your AI to phone calls. Fine-tune these settings for optimal performance.
          </p>

          <div class="settings-grid">
            <!-- Voice Activity Detection -->
            <div class="setting-card">
              <h3>üé§ Voice Activity Detection</h3>
              <p style="color: #666; font-size: 13px; margin: 10px 0;">Detect when caller stops speaking</p>
              <select id="vadSelect" class="config-select" onchange="updateVAD()">
                <option value="auto">Auto (Recommended)</option>
                <option value="aggressive">Aggressive (Fast response)</option>
                <option value="conservative">Conservative (Less interruption)</option>
              </select>
            </div>

            <!-- Interruption Handling -->
            <div class="setting-card">
              <h3>‚ö° Interruption Handling</h3>
              <p style="color: #666; font-size: 13px; margin: 10px 0;">Allow callers to interrupt AI mid-sentence</p>
              <label style="display: flex; align-items: center; gap: 10px; margin: 15px 0; cursor: pointer;">
                <input type="checkbox" id="interruptibleCheckbox" onchange="updateInterruptible()"
                       style="width: 20px; height: 20px; cursor: pointer;" checked>
                <span style="font-size: 14px;">Enable Interruptions (Natural conversations)</span>
              </label>
            </div>

            <!-- Skip Initial Greeting -->
            <div class="setting-card">
              <h3>üëã Initial Greeting</h3>
              <p style="color: #666; font-size: 13px; margin: 10px 0;">Control whether AI greets first or waits for caller</p>
              <label style="display: flex; align-items: center; gap: 10px; margin: 15px 0; cursor: pointer;">
                <input type="checkbox" id="skipInitialGreetingCheckbox" onchange="updateSkipInitialGreeting()"
                       style="width: 20px; height: 20px; cursor: pointer;">
                <span style="font-size: 14px;">Skip Initial Greeting (AI waits for caller)</span>
              </label>
            </div>

            <!-- STT Provider -->
            <div class="setting-card">
              <h3>üéß Speech-to-Text Provider</h3>
              <p style="color: #666; font-size: 13px; margin: 10px 0;">How caller speech is transcribed</p>
              <select id="sttProviderSelect" class="config-select" onchange="updateSTTProvider()">
                <option value="deepgram">Deepgram (Low latency)</option>
                <option value="google">Google STT (High accuracy)</option>
                <option value="amazon">Amazon Transcribe</option>
                <option value="azure">Azure Speech</option>
              </select>
            </div>

            <!-- Barge-in Sensitivity -->
            <div class="setting-card">
              <h3>‚ö° Barge-in Sensitivity</h3>
              <p style="color: #666; font-size: 13px; margin: 10px 0;">How easily caller can interrupt (0-100)</p>
              <input type="range" id="bargeInSlider" min="0" max="100" step="5" value="50"
                     style="width: 100%; margin: 10px 0;" oninput="updateBargeInDisplay(this.value)">
              <div style="display: flex; justify-content: space-between; font-size: 12px; color: #666;">
                <span>Low</span>
                <span id="bargeInValue" style="font-weight: bold; color: #667eea;">50</span>
                <span>High</span>
              </div>
              <button class="btn" onclick="saveBargeInSensitivity()" style="width: 100%; margin-top: 10px;">
                üíæ Save Sensitivity
              </button>
            </div>
          </div>

          <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #667eea;">
            <h4 style="color: #333; margin: 0 0 10px 0;">üìö Learn More</h4>
            <p style="color: #666; font-size: 14px; margin: 0 0 10px 0;">
              These settings control how Twilio's ConversationRelay manages real-time voice conversations with your AI.
            </p>
            <button class="btn btn-secondary" onclick="window.open('https://www.twilio.com/docs/voice/twiml/stream', '_blank')">
              View ConversationRelay Docs
            </button>
          </div>
        </div>
      </div>

      <div id="settings" class="tab-content">
        <div class="panel">
          <h2>üîê API Credentials & Configuration</h2>
          <p style="color: #666; margin-bottom: 30px;">
            Manage your Twilio and AI provider credentials. All credentials are encrypted and stored securely.
          </p>

          <!-- Twilio Credentials -->
          <div class="setting-card" style="border-left: 4px solid #ef4444; margin-bottom: 30px;">
            <h3>üìû Twilio Credentials</h3>
            <p style="color: #666; font-size: 13px; margin: 10px 0;">
              Connect your Twilio account to enable voice calling. Find these in your <a href="https://console.twilio.com" target="_blank" style="color: #667eea;">Twilio Console</a>.
            </p>

            <!-- Show status when configured -->
            <div id="twilioConfiguredStatus" style="display: none;">
              <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; border-left: 4px solid #22c55e; margin: 15px 0;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                  <span style="font-size: 24px;">‚úÖ</span>
                  <h4 style="margin: 0; color: #166534;">Twilio Connected</h4>
                </div>
                <div style="color: #15803d; font-size: 13px; margin-top: 10px;">
                  <div>Account SID: <strong style="font-family: monospace;" id="twilioSidDisplay">--</strong></div>
                  <div style="margin-top: 5px;">Phone Number: <strong style="font-family: monospace;" id="twilioPhoneDisplay">--</strong></div>
                </div>
              </div>
              <button class="btn btn-secondary" onclick="showTwilioEditForm()" style="margin-top: 10px;">
                ‚úèÔ∏è Update Credentials
              </button>
            </div>

            <!-- Show form when not configured or editing -->
            <div id="twilioEditForm" style="display: none;">
              <label style="display: block; margin-top: 15px; margin-bottom: 5px; font-weight: 600; color: #333;">Account SID</label>
              <input type="text" id="twilioAccountSid" placeholder="AC..." style="margin-top: 0;">

              <label style="display: block; margin-top: 15px; margin-bottom: 5px; font-weight: 600; color: #333;">Auth Token</label>
              <input type="password" id="twilioAuthToken" placeholder="Enter your Twilio Auth Token" style="margin-top: 0;">

              <label style="display: block; margin-top: 15px; margin-bottom: 5px; font-weight: 600; color: #333;">Phone Number</label>
              <input type="text" id="twilioPhoneNumber" placeholder="+1..." style="margin-top: 0;">

              <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 6px; font-size: 13px; color: #856404;">
                üí° <strong>Tip:</strong> Your Auth Token will be encrypted before storage. You can find these credentials at <a href="https://console.twilio.com" target="_blank" style="color: #856404; text-decoration: underline;">console.twilio.com</a>
              </div>

              <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="btn" onclick="saveTwilioCredentials()">
                  üíæ Save Twilio Credentials
                </button>
                <button class="btn btn-secondary" onclick="cancelTwilioEdit()" id="cancelTwilioBtn" style="display: none;">
                  Cancel
                </button>
              </div>
            </div>
          </div>

          <!-- OpenAI API Key -->
          <div class="setting-card" style="border-left: 4px solid #10b981; margin-bottom: 30px;">
            <h3>üß† OpenAI API Key</h3>
            <p style="color: #666; font-size: 13px; margin: 10px 0;">
              Your OpenAI API key powers the AI conversations. Get your key from <a href="https://platform.openai.com/api-keys" target="_blank" style="color: #667eea;">platform.openai.com</a>.
            </p>

            <!-- Show status when configured -->
            <div id="openaiConfiguredStatus" style="display: none;">
              <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; border-left: 4px solid #22c55e; margin: 15px 0;">
                <div style="display: flex; align-items: center; gap: 10px;">
                  <span style="font-size: 24px;">‚úÖ</span>
                  <h4 style="margin: 0; color: #166534;">OpenAI Key Configured</h4>
                </div>
                <p style="color: #15803d; font-size: 13px; margin-top: 10px; margin-bottom: 0;">
                  Your API key is securely encrypted and stored.
                </p>
              </div>
              <button class="btn btn-secondary" onclick="showOpenAIEditForm()" style="margin-top: 10px;">
                ‚úèÔ∏è Update API Key
              </button>
            </div>

            <!-- Show form when not configured or editing -->
            <div id="openaiEditForm" style="display: none;">
              <label style="display: block; margin-top: 15px; margin-bottom: 5px; font-weight: 600; color: #333;">API Key</label>
              <input type="password" id="openaiApiKey" placeholder="sk-..." style="margin-top: 0;">

              <div style="margin-top: 15px; padding: 10px; background: #e0f2fe; border-radius: 6px; font-size: 13px; color: #075985;">
                üîí <strong>Security:</strong> Your API key is encrypted before being stored in the database and never exposed in logs or analytics.
              </div>

              <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="btn" onclick="saveOpenAIKey()">
                  üíæ Save OpenAI API Key
                </button>
                <button class="btn btn-secondary" onclick="cancelOpenAIEdit()" id="cancelOpenAIBtn" style="display: none;">
                  Cancel
                </button>
              </div>
            </div>
          </div>

          <!-- Phone Number Selection -->
          <div style="margin-top: 30px;">
            <h3 style="color: #333; margin-bottom: 15px;">üìû Phone Number Configuration</h3>
            <div class="setting-card" style="border-left: 4px solid #3b82f6;">
              <h3>Select Your Twilio Phone Number</h3>
              <p style="margin-bottom: 15px;">Choose which phone number to use for your Voice AI</p>

              <div id="phoneNumberLoading" style="display: none; padding: 20px; text-align: center; color: #666;">
                <div style="font-size: 24px; margin-bottom: 10px;">‚è≥</div>
                <p>Loading phone numbers...</p>
              </div>

              <div id="phoneNumberError" style="display: none; padding: 15px; background: #fee; border-radius: 6px; color: #c00; margin-bottom: 15px;"></div>

              <div id="phoneNumberSelector" style="display: none;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Phone Number</label>
                <select id="phoneNumberSelect" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; margin-bottom: 10px;">
                  <option value="">-- Select a phone number --</option>
                </select>

                <div id="selectedNumberInfo" style="display: none; background: #f0fdf4; padding: 12px; border-radius: 6px; margin-top: 10px; border-left: 4px solid #10b981;">
                  <div style="font-size: 13px; color: #15803d;">
                    <div><strong>Selected:</strong> <span id="selectedNumberDisplay"></span></div>
                    <div style="margin-top: 5px;"><strong>Name:</strong> <span id="selectedNumberName"></span></div>
                  </div>
                </div>

                <button class="btn" onclick="savePhoneNumber()" style="margin-top: 15px;">
                  üíæ Save Phone Number
                </button>
                <button class="btn btn-secondary" onclick="loadPhoneNumbers()" style="margin-top: 15px; margin-left: 10px;">
                  üîÑ Refresh List
                </button>
              </div>

              <button class="btn" onclick="loadPhoneNumbers()" id="loadPhoneNumbersBtn">
                üì± Load Phone Numbers
              </button>
            </div>
          </div>

          <!-- Current Configuration Summary -->
          <div style="margin-top: 30px;">
            <h3 style="color: #333; margin-bottom: 15px;">üìã Current Configuration</h3>
            <div class="settings-grid" id="settingsContent"></div>
          </div>
        </div>
      </div>

      <div id="prompts" class="tab-content">
        <div class="panel">
          <h2>üîÑ Stateful Conversation Flow</h2>
          <p style="color: #666; margin-bottom: 20px;">
            Design multi-state conversations with branching logic. Each state has its own prompt and transition rules.
          </p>

          <!-- Mode Toggle -->
          <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #667eea;">
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
              <input type="checkbox" id="statefulModeCheckbox" onchange="toggleStatefulMode()"
                     style="width: 20px; height: 20px; cursor: pointer;">
              <div>
                <strong style="color: #333;">Enable Stateful Prompts (Advanced)</strong>
                <div style="font-size: 13px; color: #666; margin-top: 5px;">
                  Use a state machine for complex conversation flows. When disabled, uses a single system prompt.
                </div>
              </div>
            </label>
          </div>

          <!-- Simple Mode (Single Prompt) -->
          <div id="simplePromptMode" style="display: none;">
            <div class="setting-card">
              <h3>System Prompt</h3>
              <textarea id="systemPromptEditor" style="min-height: 250px;"></textarea>
              <button class="btn" onclick="updateSystemPrompt()">üíæ Save Prompt</button>
            </div>

            <div class="setting-card" style="margin-top: 20px;">
              <h3>IVR Greeting</h3>
              <input type="text" id="ivrGreetingEditor" placeholder="Enter greeting...">
              <button class="btn" onclick="updateIvrGreeting()">üíæ Save Greeting</button>
            </div>
          </div>

          <!-- Stateful Mode (State Machine) -->
          <div id="statefulPromptMode" style="display: none;">

            <!-- Add New State Button -->
            <div style="margin-bottom: 20px;">
              <button class="btn" onclick="addNewState()" style="font-size: 16px; padding: 12px 24px;">
                ‚ûï Add New State
              </button>
              <button class="btn btn-secondary" onclick="saveAllStates()" style="margin-left: 10px;">
                üíæ Save All States
              </button>
            </div>

            <!-- State Flow Visualization -->
            <div id="stateFlowViz" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px; border: 2px dashed #667eea; min-height: 150px;">
              <h3 style="color: #333; margin: 0 0 15px 0; font-size: 14px;">üìä Conversation Flow</h3>
              <div id="flowDiagram" style="display: flex; flex-wrap: wrap; gap: 15px; align-items: center;">
                <!-- Dynamically populated -->
              </div>
            </div>

            <!-- States List -->
            <div id="statesList">
              <!-- Dynamically populated state cards -->
            </div>

            <!-- Empty State -->
            <div id="statesEmpty" style="display: none; text-align: center; padding: 60px 20px; background: #f8f9fa; border-radius: 8px;">
              <div style="font-size: 64px; margin-bottom: 15px;">üîÑ</div>
              <p style="color: #666; font-size: 16px; margin-bottom: 10px;">No conversation states defined</p>
              <p style="color: #999; font-size: 14px; margin-bottom: 20px;">Click "Add New State" to create your first conversation state!</p>
              <button class="btn" onclick="addNewState()">‚ûï Create First State</button>
            </div>
          </div>
        </div>
      </div>

      <div id="functions" class="tab-content">
        <div class="panel">
          <h2>AI Functions & Tools</h2>
          <p style="color: #666; margin-bottom: 20px;">
            Add custom functions that your AI can call during conversations. Functions let your AI take actions like checking availability, booking appointments, or querying databases.
          </p>

          <!-- Add New Function Form -->
          <div class="setting-card" style="background: #f8f9fa; border: 2px dashed #667eea;">
            <h3>‚ûï Add New Function</h3>
            <div style="margin-top: 15px;">
              <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Function Name</label>
              <input type="text" id="newFunctionName" placeholder="e.g., check_availability" style="margin-top: 0;">

              <label style="display: block; margin-top: 15px; margin-bottom: 5px; font-weight: 600; color: #333;">Description</label>
              <textarea id="newFunctionDescription" placeholder="What does this function do? Be specific so the AI knows when to use it." style="min-height: 80px;"></textarea>

              <label style="display: block; margin-top: 15px; margin-bottom: 5px; font-weight: 600; color: #333;">Webhook URL (Optional)</label>
              <input type="text" id="newFunctionWebhookUrl" placeholder="https://your-api.com/webhooks/your-function (leave empty for simulated mode)" style="margin-top: 0;">

              <label style="display: block; margin-top: 15px; margin-bottom: 5px; font-weight: 600; color: #333;">Parameters (JSON Schema)</label>
              <textarea id="newFunctionParameters" placeholder='{
  "type": "object",
  "properties": {
    "date": {
      "type": "string",
      "description": "Date in YYYY-MM-DD format"
    },
    "time": {
      "type": "string",
      "description": "Time in HH:MM format (24-hour)"
    },
    "name": {
      "type": "string",
      "description": "Customer full name"
    }
  },
  "required": ["date", "name"]
}' style="min-height: 120px; font-family: monospace;"></textarea>

              <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 6px; font-size: 13px; color: #856404;">
                üí° <strong>Tip:</strong> Parameters use JSON Schema format. Define what inputs your function needs.
              </div>
              <div style="margin-top: 10px; padding: 10px; background: #e0f2fe; border-radius: 6px; font-size: 13px; color: #075985;">
                üîó <strong>Webhook URL:</strong> Optional HTTPS endpoint for external tool execution. See <a href="/WEBHOOK_TOOLS.md" target="_blank" style="color: #0369a1; text-decoration: underline;">WEBHOOK_TOOLS.md</a> for details.
              </div>

              <button class="btn" onclick="addFunction()" style="margin-top: 15px; margin-right: 10px;">
                ‚úÖ Add Function
              </button>
              <button class="btn btn-secondary" onclick="clearFunctionForm()" style="margin-top: 15px;">
                Clear Form
              </button>
            </div>
          </div>

          <!-- Existing Functions List -->
          <div style="margin-top: 30px;">
            <h3 style="color: #333; margin-bottom: 15px;">Configured Functions</h3>
            <div id="functionsList">
              <!-- Dynamically populated -->
            </div>
          </div>
        </div>
      </div>

      <div id="memory" class="tab-content">
        <div class="panel">
          <h2>üß† Persistent Memory (OpenAI Assistants)</h2>
          <p style="color: #666; margin-bottom: 30px;">
            Enable conversation memory across calls. Each phone number gets its own OpenAI thread that remembers previous conversations.
          </p>

          <!-- Memory Settings -->
          <div class="settings-grid">
            <div class="setting-card">
              <h3>‚ö° Enable Memory</h3>
              <p style="color: #666; font-size: 13px; margin: 10px 0;">Turn on persistent conversation memory</p>
              <label style="display: flex; align-items: center; gap: 10px; margin: 15px 0; cursor: pointer;">
                <input type="checkbox" id="enableMemoryCheckbox" onchange="togglePersistentMemory()"
                       style="width: 20px; height: 20px; cursor: pointer;">
                <span style="font-size: 14px;">Enable Persistent Memory</span>
              </label>
            </div>

            <div class="setting-card">
              <h3>üìÖ Retention Period</h3>
              <p style="color: #666; font-size: 13px; margin: 10px 0;">How long to keep conversation history</p>
              <input type="number" id="memoryRetentionDays" min="1" max="365" value="30" placeholder="Days">
              <button class="btn" onclick="updateMemoryRetention()" style="width: 100%;">üíæ Save Retention</button>
            </div>
          </div>

          <!-- Memory Threads -->
          <div style="margin-top: 40px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <h3 style="color: #333; margin: 0;">Active Conversation Threads</h3>
              <div>
                <button class="btn" onclick="loadMemoryThreads()" id="loadThreadsBtn">üîÑ Load Threads</button>
                <button class="btn btn-secondary" onclick="clearAllMemory()" style="margin-left: 10px;">üóëÔ∏è Clear All Memory</button>
              </div>
            </div>

            <div id="threadsLoading" style="display: none; text-align: center; padding: 40px; color: #666;">
              <div style="font-size: 48px; margin-bottom: 15px;">‚è≥</div>
              <p>Loading memory threads...</p>
            </div>

            <div id="threadsContent" style="display: none;">
              <div class="stats-grid" style="margin-bottom: 20px;">
                <div class="metric-card" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                  <div class="metric-label">Total Threads</div>
                  <div class="metric-value" id="totalThreadsCount">0</div>
                </div>
                <div class="metric-card" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                  <div class="metric-label">Total Messages</div>
                  <div class="metric-value" id="totalMessagesCount">0</div>
                </div>
              </div>

              <div id="threadsList"></div>
            </div>

            <div id="threadsEmpty" style="display: none; background: #f8f9fa; padding: 40px; border-radius: 8px; text-align: center;">
              <div style="font-size: 64px; margin-bottom: 15px;">üß†</div>
              <p style="color: #666; font-size: 16px; margin-bottom: 10px;">No conversation threads yet</p>
              <p style="color: #999; font-size: 14px;">Memory threads are created automatically when callers interact with your Voice AI!</p>
            </div>
          </div>

          <div style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); border-radius: 12px; color: white;">
            <h3 style="color: white; margin: 0 0 10px 0;">‚ú® How It Works</h3>
            <p style="color: rgba(255,255,255,0.95); font-size: 14px; line-height: 1.6; margin: 0;">
              Each phone number gets a unique OpenAI Assistant thread. When someone calls back, the AI automatically has full context from previous conversations. This enables truly personalized experiences where the AI remembers customer preferences, previous orders, and conversation history.
            </p>
          </div>
        </div>
      </div>

      <div id="analytics" class="tab-content">
        <div class="panel">
          <h2>üìà Call Analytics</h2>
          <p style="color: #666; margin-bottom: 20px;">Real-time call metrics and history from Twilio</p>

          <button class="btn" onclick="loadCallAnalytics()" id="loadAnalyticsBtn">
            üîÑ Load Call Data
          </button>
          <button class="btn btn-secondary" onclick="window.open('https://console.twilio.com/us1/monitor/logs/calls?frameUrl=%2Fconsole%2Fvoice%2Fcalls%2Flogs%3Fx-target-region%3Dus1', '_blank')" style="margin-left: 10px;">
            View in Twilio Console
          </button>

          <div id="analyticsLoading" style="display: none; text-align: center; padding: 40px; color: #666;">
            <div style="font-size: 48px; margin-bottom: 15px;">‚è≥</div>
            <p>Loading call analytics from Twilio...</p>
          </div>

          <div id="analyticsError" style="display: none;"></div>

          <div id="analyticsContent" style="display: none;">
            <!-- Metrics Grid -->
            <div class="stats-grid" style="margin-top: 30px;">
              <div class="metric-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                <div class="metric-label">Total Calls</div>
                <div class="metric-value" id="metricTotalCalls">0</div>
              </div>
              <div class="metric-card" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                <div class="metric-label">Answered</div>
                <div class="metric-value" id="metricAnswered">0</div>
              </div>
              <div class="metric-card" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                <div class="metric-label">Failed</div>
                <div class="metric-value" id="metricFailed">0</div>
              </div>
              <div class="metric-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                <div class="metric-label">Avg Duration</div>
                <div class="metric-value" id="metricAvgDuration">0s</div>
              </div>
              <div class="metric-card" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                <div class="metric-label">Total Duration</div>
                <div class="metric-value" id="metricTotalDuration">0m</div>
              </div>
            </div>

            <!-- Date Range Info -->
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 20px 0; text-align: center; color: #666; font-size: 14px;">
              üìÖ Showing calls from <strong id="dateRangeFrom">--</strong> to <strong id="dateRangeTo">--</strong>
              for phone number <strong id="phoneNumberDisplay">--</strong>
            </div>

            <!-- Call History with Intelligence -->
            <div style="margin-top: 30px;">
              <h3 style="color: #333; margin-bottom: 15px;">üìû Call History & Intelligence</h3>
              <div id="callHistoryList">
                <!-- Dynamically populated with expandable call cards -->
              </div>
            </div>
          </div>

          <div id="analyticsEmpty" style="display: none; background: #f8f9fa; padding: 40px; border-radius: 8px; text-align: center; margin-top: 20px;">
            <div style="font-size: 64px; margin-bottom: 15px;">üìû</div>
            <p style="color: #666; font-size: 16px; margin-bottom: 10px;">No calls found</p>
            <p style="color: #999; font-size: 14px;">Make a test call to see analytics appear here!</p>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    let config = {};
    let SESSION_TOKEN = '';
    const API_BASE = window.location.origin;

    // Get session token from URL param or localStorage
    function getSessionToken() {
      const urlParams = new URLSearchParams(window.location.search);
      const tokenFromUrl = urlParams.get('session');
      const tokenFromStorage = localStorage.getItem('sessionToken');
      return tokenFromUrl || tokenFromStorage || '';
    }

    async function loadConfig() {
      try {
        SESSION_TOKEN = getSessionToken();

        if (!SESSION_TOKEN) {
          throw new Error('No session token found. Please access this page from the workshop.');
        }

        const response = await fetch(`${API_BASE}/api/student-config-get?sessionToken=${SESSION_TOKEN}`);
        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Failed to load configuration');
        }

        config = data.config;
        renderConfig();

        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
      } catch (error) {
        console.error('Load error:', error);
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('errorState').style.display = 'block';
        document.getElementById('errorMessage').textContent = error.message;
      }
    }

    function renderConfig() {
      document.getElementById('useCaseDisplay').textContent = config.useCaseDescription || 'Voice AI Assistant';
      document.getElementById('sttProviderMetric').textContent = getSTTProviderName(config.sttProvider);
      document.getElementById('callDirectionMetric').textContent =
        (config.callDirection || 'inbound') === 'inbound' ? 'üì• Inbound' : 'üì§ Outbound';
      document.getElementById('ttsProviderMetric').textContent = getTTSProviderName(config.ttsProvider);

      // Update phone number displays
      const phoneNumber = config.selectedPhoneNumber || 'Not configured';
      const phoneNumberDisplay = document.getElementById('phoneNumberDisplay');
      const phoneNumberToCall = document.getElementById('phoneNumberToCall');
      if (phoneNumberDisplay) phoneNumberDisplay.textContent = phoneNumber;
      if (phoneNumberToCall) phoneNumberToCall.textContent = phoneNumber;

      // Hide setup prompt if credentials are configured
      const hasCredentials = config.twilioAccountSid && config.twilioAuthToken && config.openaiApiKey;
      const setupPrompt = document.getElementById('setupPrompt');
      if (setupPrompt) {
        setupPrompt.style.display = hasCredentials ? 'none' : 'block';
      }

      // Show/hide Twilio credentials based on configuration
      const hasTwilioCredentials = config.twilioAccountSid && config.twilioAuthToken;
      const twilioStatusDiv = document.getElementById('twilioConfiguredStatus');
      const twilioFormDiv = document.getElementById('twilioEditForm');

      if (twilioStatusDiv && twilioFormDiv) {
        if (hasTwilioCredentials) {
          twilioStatusDiv.style.display = 'block';
          twilioFormDiv.style.display = 'none';

          // Populate display fields
          const sidDisplay = document.getElementById('twilioSidDisplay');
          const phoneDisplay = document.getElementById('twilioPhoneDisplay');
          if (sidDisplay) sidDisplay.textContent = config.twilioAccountSid;
          if (phoneDisplay) phoneDisplay.textContent = config.selectedPhoneNumber || 'Not set';

          // Hide cancel button on initial load
          const cancelBtn = document.getElementById('cancelTwilioBtn');
          if (cancelBtn) cancelBtn.style.display = 'none';
        } else {
          twilioStatusDiv.style.display = 'none';
          twilioFormDiv.style.display = 'block';
        }
      }

      // Show/hide OpenAI credentials based on configuration
      const hasOpenAIKey = config.openaiApiKey;
      const openaiStatusDiv = document.getElementById('openaiConfiguredStatus');
      const openaiFormDiv = document.getElementById('openaiEditForm');

      if (openaiStatusDiv && openaiFormDiv) {
        if (hasOpenAIKey) {
          openaiStatusDiv.style.display = 'block';
          openaiFormDiv.style.display = 'none';

          // Hide cancel button on initial load
          const cancelBtn = document.getElementById('cancelOpenAIBtn');
          if (cancelBtn) cancelBtn.style.display = 'none';
        } else {
          openaiStatusDiv.style.display = 'none';
          openaiFormDiv.style.display = 'block';
        }
      }

      const settingsContent = document.getElementById('settingsContent');
      settingsContent.innerHTML = `
        <div class="setting-card">
          <h3>üìû Phone Number</h3>
          <div class="setting-value">${config.selectedPhoneNumber || 'Not configured'}</div>
        </div>
        <div class="setting-card">
          <h3>üîä TTS Provider</h3>
          <div class="setting-value" id="ttsProviderDisplay">${getTTSProviderName(config.ttsProvider)}</div>
        </div>
        <div class="setting-card">
          <h3>üéß STT Provider</h3>
          <div class="setting-value" id="sttProviderDisplay">${getSTTProviderName(config.sttProvider)}</div>
        </div>
        <div class="setting-card">
          <h3>üéôÔ∏è Voice</h3>
          <div class="setting-value" id="voiceDisplay">${config.selectedVoice || 'Default'}</div>
        </div>
        <div class="setting-card">
          <h3>üåê WebSocket URL</h3>
          <div class="setting-value">${config.websocketUrl || 'Not deployed'}</div>
        </div>
        <div class="setting-card">
          <h3>üë§ Student Name</h3>
          <div class="setting-value">${config.studentName || 'Anonymous'}</div>
        </div>
      `;

      document.getElementById('systemPromptEditor').value = config.systemPrompt || '';
      document.getElementById('ivrGreetingEditor').value = config.ivrGreeting || '';
      document.getElementById('useCaseEditor').value = config.useCaseDescription || '';

      // Initialize stateful mode
      initializeStatefulPrompts();

      // Initialize memory settings
      initializeMemorySettings();

      // Initialize AI Configuration controls
      const aiProvider = config.aiProvider || 'openai';
      const ttsProvider = config.ttsProvider || 'elevenlabs';

      document.getElementById('aiProviderSelect').value = aiProvider;
      document.getElementById('ttsProviderSelect').value = ttsProvider;
      document.getElementById('currentTTSProvider').textContent = getTTSProviderName(ttsProvider);

      populateAIModels(aiProvider);
      populateVoices(ttsProvider);

      if (config.aiModel) document.getElementById('aiModelSelect').value = config.aiModel;
      if (config.selectedVoice) document.getElementById('voiceSelect').value = config.selectedVoice;
      if (config.aiTemperature) {
        document.getElementById('temperatureSlider').value = config.aiTemperature;
        document.getElementById('temperatureValue').textContent = config.aiTemperature;
      }
      if (config.aiMaxTokens) document.getElementById('maxTokensInput').value = config.aiMaxTokens;

      // Initialize ConversationRelay controls
      if (config.vadMode) document.getElementById('vadSelect').value = config.vadMode;

      // Set interruptible - default to true if not explicitly set
      document.getElementById('interruptibleCheckbox').checked = config.interruptible !== undefined ? config.interruptible : true;

      // Set skip initial greeting checkbox
      if (config.skipInitialGreeting !== undefined) document.getElementById('skipInitialGreetingCheckbox').checked = config.skipInitialGreeting;

      // Set STT provider - default to deepgram if not set
      document.getElementById('sttProviderSelect').value = config.sttProvider || 'deepgram';

      if (config.bargeInSensitivity) {
        document.getElementById('bargeInSlider').value = config.bargeInSensitivity;
        document.getElementById('bargeInValue').textContent = config.bargeInSensitivity;
      }

      // Render functions list
      renderFunctions();
    }

    function getTTSProviderName(provider) {
      const providers = {
        'elevenlabs': 'ElevenLabs',
        'google': 'Google TTS',
        'deepgram': 'Deepgram Aura',
        'amazon': 'Amazon Polly'
      };
      return providers[provider] || providers['elevenlabs']; // Default to ElevenLabs
    }

    function getSTTProviderName(provider) {
      const providers = {
        'deepgram': 'Deepgram',
        'google': 'Google STT',
        'amazon': 'Amazon Transcribe',
        'azure': 'Azure Speech'
      };
      return providers[provider] || providers['deepgram']; // Default to Deepgram
    }

    async function updateSystemPrompt() {
      const newPrompt = document.getElementById('systemPromptEditor').value;

      try {
        const response = await fetch(`${API_BASE}/api/student-config-update`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sessionToken: SESSION_TOKEN,
            systemPrompt: newPrompt
          })
        });

        const data = await response.json();

        if (data.success) {
          alert('‚úÖ System prompt updated successfully!');
          config.systemPrompt = newPrompt;
        } else {
          alert('‚ùå Failed to update: ' + data.error);
        }
      } catch (error) {
        alert('‚ùå Error: ' + error.message);
      }
    }

    async function updateIvrGreeting() {
      const newGreeting = document.getElementById('ivrGreetingEditor').value;

      try {
        const response = await fetch(`${API_BASE}/api/student-config-update`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sessionToken: SESSION_TOKEN,
            ivrGreeting: newGreeting
          })
        });

        const data = await response.json();

        if (data.success) {
          alert('‚úÖ IVR greeting updated successfully!');
          config.ivrGreeting = newGreeting;
        } else {
          alert('‚ùå Failed to update: ' + data.error);
        }
      } catch (error) {
        alert('‚ùå Error: ' + error.message);
      }
    }

    async function regeneratePrompts() {
      const useCaseDescription = document.getElementById('useCaseEditor').value.trim();
      const callDirection = config.callDirection || 'inbound';
      const skipInitialGreeting = config.skipInitialGreeting || false;

      if (!useCaseDescription) {
        alert('‚ùå Please enter a use case description first');
        return;
      }

      // Show loading state
      const btn = event.target;
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = '‚è≥ Regenerating...';

      try {
        const response = await fetch(`${API_BASE}/api/generate-use-case-content`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sessionToken: SESSION_TOKEN,
            useCaseDescription: useCaseDescription,
            callDirection: callDirection,
            skipInitialGreeting: skipInitialGreeting
          })
        });

        const data = await response.json();

        if (data.success) {
          // Update the prompts in the UI
          document.getElementById('systemPromptEditor').value = data.content.systemPrompt;
          document.getElementById('ivrGreetingEditor').value = data.content.ivrGreeting;

          // Save the regenerated prompts to the database
          const updateResponse = await fetch(`${API_BASE}/api/student-config-update`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              sessionToken: SESSION_TOKEN,
              systemPrompt: data.content.systemPrompt,
              ivrGreeting: data.content.ivrGreeting
            })
          });

          const updateData = await updateResponse.json();

          if (updateData.success) {
            config.systemPrompt = data.content.systemPrompt;
            config.ivrGreeting = data.content.ivrGreeting;
            alert('‚úÖ AI prompts regenerated and saved successfully!');
          } else {
            alert('‚ö†Ô∏è Prompts regenerated but failed to save: ' + updateData.error);
          }
        } else {
          alert('‚ùå Failed to regenerate: ' + data.error);
        }
      } catch (error) {
        alert('‚ùå Error: ' + error.message);
      } finally {
        // Restore button state
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }

    function showTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(btn => btn.classList.remove('active'));
      document.getElementById(tabName).classList.add('active');
      event.target.classList.add('active');
    }

    // =========================================================================
    // FUNCTIONS TAB - Function Management
    // =========================================================================

    function renderFunctions() {
      const functionsList = document.getElementById('functionsList');

      // Ensure tools is always an array
      let tools = config.tools || [];
      if (typeof tools === 'string') {
        try {
          tools = JSON.parse(tools);
        } catch (e) {
          console.error('Failed to parse tools:', e);
          tools = [];
        }
      }
      if (!Array.isArray(tools)) {
        console.error('tools is not an array:', typeof tools, tools);
        tools = [];
      }

      if (tools.length === 0) {
        functionsList.innerHTML = `
          <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 8px; color: #666;">
            <div style="font-size: 48px; margin-bottom: 15px;">üõ†Ô∏è</div>
            <p style="font-size: 16px; margin-bottom: 10px;">No functions configured yet</p>
            <p style="font-size: 14px;">Add your first function above to extend your AI's capabilities!</p>
          </div>
        `;
        return;
      }

      functionsList.innerHTML = tools.map((tool, index) => {
        const func = tool.function || tool; // Support both formats
        return `
        <div class="setting-card" style="margin-bottom: 15px;">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
            <div style="flex: 1;">
              <h3 style="margin: 0 0 5px 0; color: #667eea;">${func.name || 'Unnamed Function'}</h3>
              <p style="color: #666; font-size: 13px; margin: 0;">${func.description || 'No description'}</p>
              ${func.webhook_url ? `
                <div style="margin-top: 8px; padding: 8px; background: #e0f2fe; border-radius: 4px; border-left: 3px solid #0369a1;">
                  <div style="font-size: 11px; color: #075985; font-weight: 600; margin-bottom: 3px;">üîó WEBHOOK URL</div>
                  <div style="font-size: 11px; color: #0c4a6e; font-family: monospace; word-break: break-all;">${func.webhook_url}</div>
                </div>
              ` : `
                <div style="margin-top: 8px; padding: 6px; background: #fef3c7; border-radius: 4px; font-size: 11px; color: #92400e;">
                  ‚ö†Ô∏è Simulated mode (no webhook configured)
                </div>
              `}
            </div>
            <div style="display: flex; gap: 10px;">
              <button class="btn-secondary" onclick="editFunction(${index})" style="padding: 6px 12px; font-size: 12px; cursor: pointer; background: #667eea; color: white; border: none; border-radius: 4px;">
                ‚úèÔ∏è Edit
              </button>
              <button class="btn-secondary" onclick="deleteFunction(${index})" style="padding: 6px 12px; font-size: 12px; cursor: pointer; background: #ef4444; color: white; border: none; border-radius: 4px;">
                üóëÔ∏è Delete
              </button>
            </div>
          </div>
          ${func.parameters ? `
            <details style="margin-top: 10px;">
              <summary style="cursor: pointer; color: #667eea; font-size: 13px; font-weight: 600;">View Parameters</summary>
              <pre style="background: #2c313c; color: #abb2bf; padding: 10px; border-radius: 6px; font-size: 12px; overflow-x: auto; margin-top: 10px;">${JSON.stringify(func.parameters, null, 2)}</pre>
            </details>
          ` : ''}
        </div>
      `;
      }).join('');
    }

    async function addFunction() {
      const name = document.getElementById('newFunctionName').value.trim();
      const description = document.getElementById('newFunctionDescription').value.trim();
      const webhookUrl = document.getElementById('newFunctionWebhookUrl').value.trim();
      const parametersText = document.getElementById('newFunctionParameters').value.trim();

      // Validation
      if (!name) {
        alert('‚ùå Function name is required');
        return;
      }

      if (!description) {
        alert('‚ùå Function description is required');
        return;
      }

      // Parse parameters JSON
      let parameters;
      if (parametersText) {
        try {
          parameters = JSON.parse(parametersText);
        } catch (error) {
          alert('‚ùå Invalid JSON in parameters. Please check your syntax.');
          return;
        }
      }

      // Create new function object
      const newFunction = {
        type: 'function',
        function: {
          name: name,
          description: description,
          parameters: parameters || {
            type: 'object',
            properties: {},
            required: []
          }
        }
      };

      // Add webhook_url if provided
      if (webhookUrl) {
        newFunction.function.webhook_url = webhookUrl;
      }

      // Add to tools array
      const updatedTools = [...(config.tools || []), newFunction];

      try {
        // Save to database
        const response = await fetch(`${API_BASE}/api/student-config-update`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sessionToken: SESSION_TOKEN,
            tools: updatedTools
          })
        });

        const data = await response.json();

        if (data.success) {
          alert('‚úÖ Function added successfully!');
          config.tools = updatedTools;
          renderFunctions();
          clearFunctionForm();

          // Sync to OpenAI Assistant (if OpenAI key available)
          syncToOpenAIAssistant();
        } else {
          alert('‚ùå Failed to add function: ' + data.error);
        }
      } catch (error) {
        alert('‚ùå Error: ' + error.message);
      }
    }

    async function deleteFunction(index) {
      if (!confirm('Are you sure you want to delete this function?')) {
        return;
      }

      const updatedTools = [...(config.tools || [])];
      updatedTools.splice(index, 1);

      try {
        const response = await fetch(`${API_BASE}/api/student-config-update`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sessionToken: SESSION_TOKEN,
            tools: updatedTools
          })
        });

        const data = await response.json();

        if (data.success) {
          alert('‚úÖ Function deleted successfully!');
          config.tools = updatedTools;
          renderFunctions();

          // Sync to OpenAI Assistant (if OpenAI key available)
          syncToOpenAIAssistant();
        } else {
          alert('‚ùå Failed to delete function: ' + data.error);
        }
      } catch (error) {
        alert('‚ùå Error: ' + error.message);
      }
    }

    function editFunction(index) {
      const tool = config.tools[index];
      if (!tool || !tool.function) return;

      // Populate form with existing values
      document.getElementById('newFunctionName').value = tool.function.name || '';
      document.getElementById('newFunctionDescription').value = tool.function.description || '';
      document.getElementById('newFunctionWebhookUrl').value = tool.function.webhook_url || '';
      document.getElementById('newFunctionParameters').value = JSON.stringify(tool.function.parameters, null, 2);

      // Delete the old one (will be re-added when they save)
      deleteFunction(index);

      // Scroll to form
      document.querySelector('#functions .setting-card').scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function clearFunctionForm() {
      document.getElementById('newFunctionName').value = '';
      document.getElementById('newFunctionDescription').value = '';
      document.getElementById('newFunctionWebhookUrl').value = '';
      document.getElementById('newFunctionParameters').value = '';
    }

    /**
     * Syncs tools to OpenAI Assistant
     * Creates or updates the Assistant with current tool configuration
     */
    async function syncToOpenAIAssistant() {
      // Check if we have an OpenAI key (from localStorage)
      const openaiKey = localStorage.getItem('openaiApiKey');

      if (!openaiKey) {
        console.log('‚ö†Ô∏è No OpenAI API key found in localStorage - skipping Assistant sync');
        return;
      }

      try {
        console.log('üîÑ Syncing tools to OpenAI Assistant...');

        const response = await fetch(`${API_BASE}/api/openai-create-assistant`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sessionToken: SESSION_TOKEN,
            openaiApiKey: openaiKey,
            systemPrompt: config.systemPrompt || '',
            tools: config.tools || [],
            assistantName: `${config.studentName || 'Voice AI'} Assistant`
          })
        });

        const data = await response.json();

        if (data.success) {
          console.log(`‚úÖ OpenAI Assistant ${data.action}:`, data.assistantId);
          console.log(`   Tools synced: ${data.toolsCount}`);
        } else {
          console.warn('‚ö†Ô∏è Failed to sync to OpenAI:', data.error);
        }
      } catch (error) {
        console.error('‚ùå OpenAI sync error:', error);
      }
    }

    // =========================================================================
    // CALL ANALYTICS TAB
    // =========================================================================

    async function loadCallAnalytics() {
      const btn = document.getElementById('loadAnalyticsBtn');
      btn.disabled = true;
      btn.textContent = '‚è≥ Loading...';

      // Hide all states
      document.getElementById('analyticsLoading').style.display = 'block';
      document.getElementById('analyticsError').style.display = 'none';
      document.getElementById('analyticsContent').style.display = 'none';
      document.getElementById('analyticsEmpty').style.display = 'none';

      try {
        // Get Twilio credentials from workshop progress
        let accountSid = null;
        let authToken = null;

        // First try: Get from workshop progress (stored as object)
        try {
          const storageKey = `workshop_progress_${SESSION_TOKEN}`;
          const progressData = localStorage.getItem(storageKey);
          if (progressData) {
            const progress = JSON.parse(progressData);
            if (progress.twilioCredentials) {
              accountSid = progress.twilioCredentials.accountSid;
              authToken = progress.twilioCredentials.authToken;
              console.log('‚úÖ Loaded Twilio credentials from workshop progress');
            }
          }
        } catch (parseError) {
          console.warn('Could not parse workshop progress:', parseError);
        }

        // Second try: Get from separate localStorage keys (legacy/fallback)
        if (!accountSid || !authToken) {
          accountSid = localStorage.getItem('twilioAccountSid');
          authToken = localStorage.getItem('twilioAuthToken');
          if (accountSid && authToken) {
            console.log('‚úÖ Loaded Twilio credentials from localStorage keys');
          }
        }

        if (!accountSid || !authToken) {
          throw new Error('Twilio credentials not found. Please connect your Twilio account in the workshop first.');
        }

        console.log('üìä Fetching call analytics...');

        const response = await fetch(`${API_BASE}/api/twilio-call-analytics`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sessionToken: SESSION_TOKEN,
            accountSid: accountSid,
            authToken: authToken
          })
        });

        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Failed to load call analytics');
        }

        console.log('‚úÖ Call analytics loaded:', data);

        // Hide loading
        document.getElementById('analyticsLoading').style.display = 'none';

        // Show results or empty state
        if (data.calls.length === 0) {
          document.getElementById('analyticsEmpty').style.display = 'block';
        } else {
          renderCallAnalytics(data);
          document.getElementById('analyticsContent').style.display = 'block';
        }

      } catch (error) {
        console.error('Analytics error:', error);
        document.getElementById('analyticsLoading').style.display = 'none';
        document.getElementById('analyticsError').style.display = 'block';
        document.getElementById('analyticsError').innerHTML = `
          <div class="error">
            <h3 style="margin-bottom: 10px;">‚ùå Failed to Load Call Analytics</h3>
            <p>${error.message}</p>
          </div>
        `;
      } finally {
        btn.disabled = false;
        btn.textContent = 'üîÑ Reload Call Data';
      }
    }

    async function renderCallAnalytics(data) {
      const { calls, metrics, phoneNumber, dateRange } = data;

      // Update metrics
      document.getElementById('metricTotalCalls').textContent = metrics.totalCalls;
      document.getElementById('metricAnswered').textContent = metrics.answeredCalls;
      document.getElementById('metricFailed').textContent = metrics.failedCalls;
      document.getElementById('metricAvgDuration').textContent = formatDuration(metrics.averageDuration);
      document.getElementById('metricTotalDuration').textContent = formatDuration(metrics.totalDuration);

      // Update date range
      document.getElementById('dateRangeFrom').textContent = new Date(dateRange.from).toLocaleDateString();
      document.getElementById('dateRangeTo').textContent = new Date(dateRange.to).toLocaleDateString();
      document.getElementById('phoneNumberDisplay').textContent = phoneNumber;

      // Render expandable call cards with Intelligence
      const callHistoryList = document.getElementById('callHistoryList');
      callHistoryList.innerHTML = calls.map((call, index) => {
        const statusColor = getStatusColor(call.status);
        const statusEmoji = getStatusEmoji(call.status);
        const callId = `call-${index}`;

        return `
          <div class="setting-card" style="margin-bottom: 15px; border-left: 4px solid ${statusColor};">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; cursor: pointer;" onclick="toggleCallDetails('${callId}')">
              <div style="flex: 1;">
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 5px; flex-wrap: wrap;">
                  <h4 style="margin: 0; color: #333;">${formatDateTime(call.startTime)}</h4>
                  <span style="padding: 4px 10px; background: ${statusColor}20; color: ${statusColor}; border-radius: 12px; font-size: 11px; font-weight: 600;">
                    ${statusEmoji} ${call.status}
                  </span>
                  <span style="color: ${call.direction === 'inbound' ? '#3b82f6' : '#10b981'}; font-size: 13px; font-weight: 600;">
                    ${call.direction === 'inbound' ? 'üì• Inbound' : 'üì§ Outbound'}
                  </span>
                  <span style="color: #666; font-size: 13px; font-weight: 600;">‚è±Ô∏è ${formatDuration(call.duration)}</span>
                </div>
                <div style="display: flex; gap: 20px; font-size: 13px; color: #666; flex-wrap: wrap;">
                  <span>From: <strong style="font-family: monospace;">${call.from}</strong></span>
                  <span>SID: <strong style="font-family: monospace; font-size: 11px;">${call.sid.substring(0, 25)}...</strong></span>
                </div>
              </div>
              <div style="color: #667eea; font-size: 24px; transition: transform 0.3s;" id="${callId}-icon">‚ñº</div>
            </div>

            <!-- Expandable Intelligence Section -->
            <div id="${callId}-details" style="display: none; margin-top: 20px; border-top: 2px solid #f0f0f0; padding-top: 20px;">
              <div style="text-align: center; padding: 20px; color: #666;">
                <div style="font-size: 32px; margin-bottom: 10px;">‚è≥</div>
                <p>Loading conversational intelligence...</p>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function toggleCallDetails(callId) {
      const detailsDiv = document.getElementById(`${callId}-details`);
      const icon = document.getElementById(`${callId}-icon`);

      if (detailsDiv.style.display === 'none') {
        detailsDiv.style.display = 'block';
        icon.style.transform = 'rotate(180deg)';
        icon.textContent = '‚ñ≤';

        // Load intelligence data for this call
        const callSid = callId; // Extract from the card data
        loadCallIntelligence(callId);
      } else {
        detailsDiv.style.display = 'none';
        icon.style.transform = 'rotate(0deg)';
        icon.textContent = '‚ñº';
      }
    }

    async function loadCallIntelligence(callId) {
      const detailsDiv = document.getElementById(`${callId}-details`);

      try {
        // For now, show placeholder data
        // TODO: Call Intelligence API endpoint
        detailsDiv.innerHTML = `
          <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #0284c7;">
            <h4 style="color: #0c4a6e; margin-bottom: 10px;">üìä Conversational Intelligence</h4>
            <p style="color: #075985; font-size: 13px; margin: 0;">
              ‚ÑπÔ∏è Intelligence data will be available here once the Twilio Intelligence API is integrated.
              This will include transcripts, summaries, sentiment analysis, and language operators.
            </p>
          </div>

          <div class="settings-grid">
            <div class="setting-card" style="background: #f0fdf4; border-left: 4px solid #22c55e;">
              <h4 style="color: #166534; margin-bottom: 5px;">üòä Sentiment</h4>
              <p style="color: #15803d; font-size: 24px; font-weight: 600; margin: 0;">Positive</p>
            </div>

            <div class="setting-card" style="background: #fef3c7; border-left: 4px solid #f59e0b;">
              <h4 style="color: #92400e; margin-bottom: 5px;">üó£Ô∏è Language</h4>
              <p style="color: #b45309; font-size: 18px; font-weight: 600; margin: 0;">English</p>
            </div>
          </div>

          <div class="setting-card" style="margin-top: 15px;">
            <h4 style="color: #333; margin-bottom: 10px;">üìù Summary</h4>
            <p style="color: #666; font-size: 14px; line-height: 1.6;">
              Summary will be generated from the call transcript using Twilio's AI-powered intelligence features.
            </p>
          </div>

          <div class="setting-card" style="margin-top: 15px;">
            <h4 style="color: #333; margin-bottom: 10px;">üí¨ Full Transcript</h4>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; max-height: 400px; overflow-y: auto;">
              <p style="color: #999; font-size: 13px; font-style: italic;">Transcript will appear here...</p>
            </div>
          </div>

          <div class="setting-card" style="margin-top: 15px;">
            <h4 style="color: #333; margin-bottom: 10px;">üéß Recording</h4>
            <audio controls style="width: 100%; margin-top: 10px;">
              <source src="#" type="audio/mpeg">
              Your browser does not support the audio element.
            </audio>
            <p style="color: #999; font-size: 12px; margin-top: 10px;">Recording URL will be available when call completes</p>
          </div>
        `;
      } catch (error) {
        console.error('Error loading intelligence:', error);
        detailsDiv.innerHTML = `
          <div style="background: #fee2e2; padding: 15px; border-radius: 8px; border-left: 4px solid #ef4444;">
            <h4 style="color: #991b1b; margin-bottom: 5px;">‚ùå Error</h4>
            <p style="color: #b91c1c; font-size: 13px; margin: 0;">${error.message}</p>
          </div>
        `;
      }
    }

    function formatDuration(seconds) {
      if (seconds === 0) return '0s';
      if (seconds < 60) return `${seconds}s`;
      const minutes = Math.floor(seconds / 60);
      const remainingSeconds = seconds % 60;
      return remainingSeconds > 0 ? `${minutes}m ${remainingSeconds}s` : `${minutes}m`;
    }

    function formatDateTime(dateString) {
      const date = new Date(dateString);
      return date.toLocaleString('en-US', {
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function getStatusColor(status) {
      const colors = {
        'completed': '#10b981',
        'in-progress': '#f59e0b',
        'ringing': '#f59e0b',
        'failed': '#ef4444',
        'busy': '#ef4444',
        'no-answer': '#ef4444',
        'canceled': '#6c757d'
      };
      return colors[status] || '#6c757d';
    }

    function getStatusEmoji(status) {
      const emojis = {
        'completed': '‚úÖ',
        'in-progress': '‚è≥',
        'ringing': 'üìû',
        'failed': '‚ùå',
        'busy': 'üö´',
        'no-answer': 'üìµ',
        'canceled': 'üõë'
      };
      return emojis[status] || '‚ùì';
    }

    // =========================================================================
    // AI CONFIGURATION TAB
    // =========================================================================

    function updateAIProvider() {
      const provider = document.getElementById('aiProviderSelect').value;
      document.getElementById('currentAIProvider').textContent =
        provider === 'openai' ? 'OpenAI' :
        provider === 'anthropic' ? 'Anthropic (Claude)' :
        provider === 'google' ? 'Google (Gemini)' :
        provider === 'azure' ? 'Azure OpenAI' : provider;

      // Update available models based on provider
      populateAIModels(provider);

      // Save to database
      saveConfigField('aiProvider', provider);
    }

    function populateAIModels(provider) {
      const modelSelect = document.getElementById('aiModelSelect');
      const models = {
        'openai': [
          { value: 'gpt-4-turbo', label: 'GPT-4 Turbo (Recommended)' },
          { value: 'gpt-4', label: 'GPT-4 (Most capable)' },
          { value: 'gpt-3.5-turbo', label: 'GPT-3.5 Turbo (Fastest)' }
        ],
        'anthropic': [
          { value: 'claude-3-opus', label: 'Claude 3 Opus (Most capable)' },
          { value: 'claude-3-sonnet', label: 'Claude 3 Sonnet (Balanced)' },
          { value: 'claude-3-haiku', label: 'Claude 3 Haiku (Fastest)' }
        ],
        'google': [
          { value: 'gemini-pro', label: 'Gemini Pro' },
          { value: 'gemini-pro-vision', label: 'Gemini Pro Vision' }
        ],
        'azure': [
          { value: 'gpt-4-turbo', label: 'GPT-4 Turbo' },
          { value: 'gpt-35-turbo', label: 'GPT-3.5 Turbo' }
        ]
      };

      modelSelect.innerHTML = (models[provider] || []).map(m =>
        `<option value="${m.value}">${m.label}</option>`
      ).join('');
    }

    function updateAIModel() {
      const model = document.getElementById('aiModelSelect').value;
      saveConfigField('aiModel', model);
    }

    function updateTTSProvider() {
      const provider = document.getElementById('ttsProviderSelect').value;
      document.getElementById('currentTTSProvider').textContent = getTTSProviderName(provider);

      // Update overview display dynamically
      const overviewDisplay = document.getElementById('ttsProviderDisplay');
      if (overviewDisplay) {
        overviewDisplay.textContent = getTTSProviderName(provider);
      }

      // Update top metric card
      document.getElementById('ttsProviderMetric').textContent = getTTSProviderName(provider);

      // Update available voices based on provider
      populateVoices(provider);

      // Save to database
      saveConfigField('ttsProvider', provider);
    }

    function populateVoices(provider) {
      const voiceSelect = document.getElementById('voiceSelect');
      const voices = {
        'elevenlabs': [
          { value: 'EXAVITQu4vr4xnSDxMaL', label: 'Sarah (Female, American, Professional)' },
          { value: 'FGY2WhTYpPnrIDTdsKH5', label: 'Laura (Female, American, Sassy)' },
          { value: 'Xb7hH8MSUJpSbSDYk0k2', label: 'Alice (Female, British, Professional)' },
          { value: 'XrExE9yKIg1WjnnlVkGX', label: 'Matilda (Female, American, Upbeat)' },
          { value: 'cgSgspJ2msm6clMCkdW9', label: 'Jessica (Female, American, Cute)' },
          { value: 'pFZP5JQG7iQjIQuC4Bku', label: 'Lily (Female, Confident)' },
          { value: 'TX3LPaxmHKxFdv7VOQHJ', label: 'Liam (Male, American, Confident)' },
          { value: 'iP95p4xoKVk53GoZ742B', label: 'Chris (Male, American, Casual)' },
          { value: 'nPczCjzI2devNBz1zQrb', label: 'Brian (Male, American, Classy)' },
          { value: 'onwK4e9ZLuTAKqWW03F9', label: 'Daniel (Male, British, Formal)' },
          { value: 'CwhRBWXzGAHq8TQ4Fs17', label: 'Roger (Male, American, Classy)' },
          { value: '2EiwWnXFnvU5JabPnv8n', label: 'Clyde (Male, American, Intense)' },
          { value: 'JBFqnCBsd6RMkjVDRZzb', label: 'George (Male, British, Mature)' },
          { value: 'bIHbv24MWmeRgasZH58o', label: 'Will (Male, American, Chill)' },
          { value: 'SAz9YHcvj6GT2YYXdXww', label: 'River (Neutral, American, Calm)' }
        ],
        'google': [
          { value: 'en-US-Neural2-A', label: 'Neural2-A (Male)' },
          { value: 'en-US-Neural2-C', label: 'Neural2-C (Female)' },
          { value: 'en-US-Neural2-D', label: 'Neural2-D (Male)' },
          { value: 'en-US-Neural2-F', label: 'Neural2-F (Female)' }
        ],
        'deepgram': [
          { value: 'aura-asteria-en', label: 'Asteria (Warm)' },
          { value: 'aura-luna-en', label: 'Luna (Professional)' },
          { value: 'aura-stella-en', label: 'Stella (Friendly)' },
          { value: 'aura-athena-en', label: 'Athena (Authoritative)' },
          { value: 'aura-orion-en', label: 'Orion (Deep Male)' },
          { value: 'aura-arcas-en', label: 'Arcas (Confident Male)' },
          { value: 'aura-perseus-en', label: 'Perseus (Strong Male)' },
          { value: 'aura-angus-en', label: 'Angus (Raspy Male)' },
          { value: 'aura-orpheus-en', label: 'Orpheus (Smooth Male)' },
          { value: 'aura-helios-en', label: 'Helios (Energetic Male)' },
          { value: 'aura-zeus-en', label: 'Zeus (Powerful Male)' }
        ],
        'amazon': [
          { value: 'Joanna', label: 'Joanna (Female, US)' },
          { value: 'Matthew', label: 'Matthew (Male, US)' },
          { value: 'Salli', label: 'Salli (Female, US)' },
          { value: 'Joey', label: 'Joey (Male, US)' }
        ]
      };

      voiceSelect.innerHTML = (voices[provider] || []).map(v =>
        `<option value="${v.value}">${v.label}</option>`
      ).join('');
    }

    async function updateVoice() {
      const voice = document.getElementById('voiceSelect').value;
      const voiceLabel = document.getElementById('voiceSelect').selectedOptions[0].text;

      // Update overview display dynamically
      const overviewDisplay = document.getElementById('voiceDisplay');
      if (overviewDisplay) {
        overviewDisplay.textContent = voice;
      }

      try {
        await saveConfigField('selectedVoice', voice);
        alert(`‚úÖ Voice updated to: ${voiceLabel}`);
      } catch (error) {
        alert(`‚ùå Failed to save voice: ${error.message}`);
      }
    }

    function updateTemperature(value) {
      document.getElementById('temperatureValue').textContent = value;
    }

    function saveTemperature() {
      const temperature = parseFloat(document.getElementById('temperatureSlider').value);
      saveConfigField('aiTemperature', temperature);
      alert(`‚úÖ AI temperature set to ${temperature}`);
    }

    function saveMaxTokens() {
      const maxTokens = parseInt(document.getElementById('maxTokensInput').value);
      saveConfigField('aiMaxTokens', maxTokens);
      alert(`‚úÖ Max response tokens set to ${maxTokens}`);
    }

    // =========================================================================
    // CONVERSATIONRELAY CONFIGURATION TAB
    // =========================================================================

    function updateVAD() {
      const vad = document.getElementById('vadSelect').value;
      saveConfigField('vadMode', vad);
      alert(`‚úÖ Voice Activity Detection set to: ${vad}`);
    }

    function updateInterruptible() {
      const interruptible = document.getElementById('interruptibleCheckbox').checked;
      saveConfigField('interruptible', interruptible);
      alert(`‚úÖ Interruptions ${interruptible ? 'enabled' : 'disabled'}`);
    }

    function updateSkipInitialGreeting() {
      const skipInitialGreeting = document.getElementById('skipInitialGreetingCheckbox').checked;
      saveConfigField('skipInitialGreeting', skipInitialGreeting);
      alert(`‚úÖ Initial greeting ${skipInitialGreeting ? 'will be skipped (AI waits for caller)' : 'enabled (AI greets first)'}`);
    }

    function updateSTTProvider() {
      const sttProvider = document.getElementById('sttProviderSelect').value;

      // Update overview display dynamically
      const overviewDisplay = document.getElementById('sttProviderDisplay');
      if (overviewDisplay) {
        overviewDisplay.textContent = getSTTProviderName(sttProvider);
      }

      // Update top metric card
      document.getElementById('sttProviderMetric').textContent = getSTTProviderName(sttProvider);

      saveConfigField('sttProvider', sttProvider);
      alert(`‚úÖ Speech-to-Text provider set to: ${getSTTProviderName(sttProvider)}`);
    }

    function updateBargeInDisplay(value) {
      document.getElementById('bargeInValue').textContent = value;
    }

    function saveBargeInSensitivity() {
      const sensitivity = parseInt(document.getElementById('bargeInSlider').value);
      saveConfigField('bargeInSensitivity', sensitivity);
      alert(`‚úÖ Barge-in sensitivity set to: ${sensitivity}`);
    }

    // =========================================================================
    // HELPER FUNCTIONS
    // =========================================================================

    async function saveConfigField(fieldName, value) {
      try {
        const response = await fetch(`${API_BASE}/api/student-config-update`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sessionToken: SESSION_TOKEN,
            [fieldName]: value
          })
        });

        const data = await response.json();

        if (data.success) {
          config[fieldName] = value;
          console.log(`‚úÖ Saved ${fieldName}:`, value);
        } else {
          console.error(`‚ùå Failed to save ${fieldName}:`, data.error);
        }
      } catch (error) {
        console.error(`‚ùå Error saving ${fieldName}:`, error);
      }
    }

    // =========================================================================
    // SETTINGS TAB - CREDENTIALS MANAGEMENT
    // =========================================================================

    async function saveTwilioCredentials() {
      const accountSid = document.getElementById('twilioAccountSid').value.trim();
      const authToken = document.getElementById('twilioAuthToken').value.trim();
      const phoneNumber = document.getElementById('twilioPhoneNumber').value.trim();

      if (!accountSid || !authToken || !phoneNumber) {
        alert('‚ùå Please fill in all Twilio fields');
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/api/student-config-update`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sessionToken: SESSION_TOKEN,
            twilioAccountSid: accountSid,
            twilioAuthToken: authToken,
            selectedPhoneNumber: phoneNumber
          })
        });

        const data = await response.json();

        if (data.success) {
          alert('‚úÖ Twilio credentials saved successfully!');
          config.twilioAccountSid = accountSid;
          config.twilioAuthToken = authToken;
          config.selectedPhoneNumber = phoneNumber;

          // Clear password field for security
          document.getElementById('twilioAuthToken').value = '';

          // Update UI to hide setup prompt if all credentials are now set
          renderConfig();
        } else {
          alert('‚ùå Failed to save: ' + data.error);
        }
      } catch (error) {
        alert('‚ùå Error: ' + error.message);
      }
    }

    async function saveOpenAIKey() {
      const apiKey = document.getElementById('openaiApiKey').value.trim();

      if (!apiKey) {
        alert('‚ùå Please enter an OpenAI API key');
        return;
      }

      if (!apiKey.startsWith('sk-')) {
        alert('‚ùå OpenAI API keys should start with "sk-"');
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/api/student-config-update`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sessionToken: SESSION_TOKEN,
            openaiApiKey: apiKey
          })
        });

        const data = await response.json();

        if (data.success) {
          alert('‚úÖ OpenAI API key saved successfully!');
          config.openaiApiKey = apiKey;

          // Store in localStorage too for other features that need it
          localStorage.setItem('openaiApiKey', apiKey);

          // Clear password field for security
          document.getElementById('openaiApiKey').value = '';

          // Update UI to hide setup prompt and switch to status view
          renderConfig();
        } else {
          alert('‚ùå Failed to save: ' + data.error);
        }
      } catch (error) {
        alert('‚ùå Error: ' + error.message);
      }
    }

    // =========================================================================
    // PHONE NUMBER SELECTION
    // =========================================================================

    async function loadPhoneNumbers() {
      const loadBtn = document.getElementById('loadPhoneNumbersBtn');
      const loadingDiv = document.getElementById('phoneNumberLoading');
      const errorDiv = document.getElementById('phoneNumberError');
      const selectorDiv = document.getElementById('phoneNumberSelector');
      const phoneNumberSelect = document.getElementById('phoneNumberSelect');

      // Hide button, show loading
      loadBtn.style.display = 'none';
      loadingDiv.style.display = 'block';
      errorDiv.style.display = 'none';
      selectorDiv.style.display = 'none';

      try {
        const response = await fetch(`${API_BASE}/api/twilio-list-numbers?sessionToken=${SESSION_TOKEN}`);
        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Failed to load phone numbers');
        }

        // Populate dropdown
        phoneNumberSelect.innerHTML = '<option value="">-- Select a phone number --</option>';

        data.phoneNumbers.forEach(number => {
          const option = document.createElement('option');
          option.value = number.phoneNumber;
          option.textContent = `${number.phoneNumber} ${number.friendlyName ? `(${number.friendlyName})` : ''}`;
          option.dataset.friendlyName = number.friendlyName || '';
          phoneNumberSelect.appendChild(option);
        });

        // Pre-select current phone number if it exists
        if (config.selectedPhoneNumber) {
          phoneNumberSelect.value = config.selectedPhoneNumber;
          updateSelectedNumberInfo();
        }

        // Show selector
        loadingDiv.style.display = 'none';
        selectorDiv.style.display = 'block';

        console.log(`‚úÖ Loaded ${data.phoneNumbers.length} phone numbers`);

      } catch (error) {
        console.error('Error loading phone numbers:', error);
        loadingDiv.style.display = 'none';
        errorDiv.textContent = `‚ùå ${error.message}`;
        errorDiv.style.display = 'block';
        loadBtn.style.display = 'inline-block';
      }
    }

    function updateSelectedNumberInfo() {
      const phoneNumberSelect = document.getElementById('phoneNumberSelect');
      const selectedNumberInfo = document.getElementById('selectedNumberInfo');
      const selectedNumberDisplay = document.getElementById('selectedNumberDisplay');
      const selectedNumberName = document.getElementById('selectedNumberName');

      const selectedOption = phoneNumberSelect.options[phoneNumberSelect.selectedIndex];

      if (selectedOption && selectedOption.value) {
        selectedNumberDisplay.textContent = selectedOption.value;
        selectedNumberName.textContent = selectedOption.dataset.friendlyName || 'No name set';
        selectedNumberInfo.style.display = 'block';
      } else {
        selectedNumberInfo.style.display = 'none';
      }
    }

    // Add event listener for phone number selection changes
    document.addEventListener('DOMContentLoaded', () => {
      const phoneNumberSelect = document.getElementById('phoneNumberSelect');
      if (phoneNumberSelect) {
        phoneNumberSelect.addEventListener('change', updateSelectedNumberInfo);
      }
    });

    async function savePhoneNumber() {
      const phoneNumberSelect = document.getElementById('phoneNumberSelect');
      const selectedNumber = phoneNumberSelect.value;

      if (!selectedNumber) {
        alert('‚ùå Please select a phone number');
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/api/student-config-update`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sessionToken: SESSION_TOKEN,
            selectedPhoneNumber: selectedNumber
          })
        });

        const data = await response.json();

        if (data.success) {
          alert(`‚úÖ Phone number updated to: ${selectedNumber}`);
          config.selectedPhoneNumber = selectedNumber;

          // Update displays
          renderConfig();
        } else {
          alert('‚ùå Failed to save: ' + data.error);
        }
      } catch (error) {
        alert('‚ùå Error: ' + error.message);
      }
    }

    // Toggle functions for credential display
    function showTwilioEditForm() {
      document.getElementById('twilioConfiguredStatus').style.display = 'none';
      document.getElementById('twilioEditForm').style.display = 'block';
      document.getElementById('cancelTwilioBtn').style.display = 'inline-block';

      // Pre-fill current values (except auth token for security)
      if (config.twilioAccountSid) {
        document.getElementById('twilioAccountSid').value = config.twilioAccountSid;
      }
      if (config.selectedPhoneNumber) {
        document.getElementById('twilioPhoneNumber').value = config.selectedPhoneNumber;
      }
    }

    function cancelTwilioEdit() {
      document.getElementById('twilioEditForm').style.display = 'none';
      document.getElementById('twilioConfiguredStatus').style.display = 'block';
      // Clear form fields
      document.getElementById('twilioAccountSid').value = '';
      document.getElementById('twilioAuthToken').value = '';
      document.getElementById('twilioPhoneNumber').value = '';
    }

    function showOpenAIEditForm() {
      document.getElementById('openaiConfiguredStatus').style.display = 'none';
      document.getElementById('openaiEditForm').style.display = 'block';
      document.getElementById('cancelOpenAIBtn').style.display = 'inline-block';
    }

    function cancelOpenAIEdit() {
      document.getElementById('openaiEditForm').style.display = 'none';
      document.getElementById('openaiConfiguredStatus').style.display = 'block';
      document.getElementById('openaiApiKey').value = '';
    }

    // =========================================================================
    // SESSION LOGS TAB
    // =========================================================================

    async function loadSessionLogs() {
      const btn = document.getElementById('loadLogsBtn');
      btn.disabled = true;
      btn.textContent = '‚è≥ Loading...';

      document.getElementById('logsLoading').style.display = 'block';
      document.getElementById('logsError').style.display = 'none';
      document.getElementById('logsContent').style.display = 'none';
      document.getElementById('logsEmpty').style.display = 'none';

      try {
        const eventType = document.getElementById('logEventTypeFilter').value;
        const limit = document.getElementById('logLimitInput').value || 100;

        let url = `${API_BASE}/api/session-log?sessionToken=${SESSION_TOKEN}&limit=${limit}`;
        if (eventType) {
          url += `&eventType=${eventType}`;
        }

        const response = await fetch(url);
        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Failed to load session logs');
        }

        document.getElementById('logsLoading').style.display = 'none';

        if (data.events.length === 0) {
          document.getElementById('logsEmpty').style.display = 'block';
        } else {
          renderSessionLogs(data.events);
          document.getElementById('logsCount').textContent = data.events.length;
          document.getElementById('logsContent').style.display = 'block';
        }

      } catch (error) {
        console.error('Logs error:', error);
        document.getElementById('logsLoading').style.display = 'none';
        document.getElementById('logsError').style.display = 'block';
        document.getElementById('logsError').innerHTML = `
          <div class="error">
            <h3 style="margin-bottom: 10px;">‚ùå Failed to Load Session Logs</h3>
            <p>${error.message}</p>
          </div>
        `;
      } finally {
        btn.disabled = false;
        btn.textContent = 'üîÑ Load Logs';
      }
    }

    function renderSessionLogs(events) {
      const logsList = document.getElementById('logsList');

      logsList.innerHTML = events.map(event => {
        const eventData = typeof event.event_data === 'string' ? JSON.parse(event.event_data) : event.event_data;
        const timestamp = new Date(event.created_at).toLocaleString();

        const typeConfig = {
          'navigation': { emoji: 'üß≠', color: '#3b82f6', label: 'Navigation' },
          'error': { emoji: '‚ùå', color: '#ef4444', label: 'Error' },
          'action': { emoji: '‚úÖ', color: '#10b981', label: 'Action' },
          'api_call': { emoji: 'üîó', color: '#8b5cf6', label: 'API Call' },
          'state_change': { emoji: 'üîÑ', color: '#f59e0b', label: 'State Change' }
        };

        const config = typeConfig[event.event_type] || { emoji: 'üìã', color: '#6c757d', label: event.event_type };

        return `
          <div class="setting-card" style="margin-bottom: 15px; border-left: 4px solid ${config.color};">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
              <div style="display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 24px;">${config.emoji}</span>
                <div>
                  <div style="font-weight: 600; color: ${config.color};">${config.label}</div>
                  <div style="font-size: 0.85rem; color: #666; margin-top: 3px;">${timestamp}</div>
                </div>
              </div>
            </div>

            ${eventData.errorMessage ? `
              <div style="padding: 10px; background: #fee; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid #ef4444;">
                <strong style="color: #991b1b;">Error:</strong> ${eventData.errorMessage}
                ${eventData.errorType ? `<div style="font-size: 0.85rem; color: #666; margin-top: 5px;">Type: ${eventData.errorType}</div>` : ''}
              </div>
            ` : ''}

            <details style="margin-top: 10px;">
              <summary style="cursor: pointer; color: #667eea; font-size: 13px; font-weight: 600;">View Event Data</summary>
              <pre style="background: #2c313c; color: #abb2bf; padding: 15px; border-radius: 6px; font-size: 12px; overflow-x: auto; margin-top: 10px; line-height: 1.5;">${JSON.stringify(eventData, null, 2)}</pre>
            </details>
          </div>
        `;
      }).join('');
    }

    function applyLogFilters() {
      // Auto-load when filter changes
      loadSessionLogs();
    }

    function clearLogFilters() {
      document.getElementById('logEventTypeFilter').value = '';
      document.getElementById('logLimitInput').value = '';
      loadSessionLogs();
    }

    loadConfig();
  </script>

  <!-- Stateful Prompts Management -->
  <script src="/stateful-prompts-functions.js"></script>

  <!-- Memory Management -->
  <script src="/memory-functions.js"></script>

  <!-- Twilio Client SDK for Browser Calling -->
  <script src="https://sdk.twilio.com/js/client/v1.14/twilio.min.js"></script>

  <!-- Browser Calling Functions -->
  <script>
    // Twilio Device for browser calling
    let twilioDevice = null;
    let currentCall = null;

    /**
     * Initialize Twilio Device with access token
     */
    async function initializeTwilioDevice() {
      try {
        // Get access token from API
        const response = await fetch(`${API_BASE}/api/twilio-token`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sessionToken: SESSION_TOKEN
          })
        });

        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Failed to get access token');
        }

        console.log('‚úÖ Twilio access token obtained');

        // Initialize Twilio Device
        twilioDevice = new Twilio.Device(data.token, {
          codecPreferences: ['opus', 'pcmu'],
          fakeLocalDTMF: true,
          enableRingingState: true
        });

        // Setup event handlers
        twilioDevice.on('ready', () => {
          console.log('‚úÖ Twilio Device is ready');
        });

        twilioDevice.on('error', (error) => {
          console.error('‚ùå Twilio Device error:', error);
          updateCallStatus('Error: ' + error.message);
        });

        twilioDevice.on('connect', (conn) => {
          console.log('‚úÖ Call connected');
          currentCall = conn;
          updateCallStatus('üü¢ Connected - Speaking...');
          document.getElementById('callButton').style.display = 'none';
          document.getElementById('hangupButton').style.display = 'inline-block';
        });

        twilioDevice.on('disconnect', () => {
          console.log('üìû Call disconnected');
          currentCall = null;
          updateCallStatus('Click to call from your browser');
          document.getElementById('callButton').style.display = 'inline-block';
          document.getElementById('hangupButton').style.display = 'none';
        });

        twilioDevice.on('incoming', (conn) => {
          console.log('üìû Incoming call');
          conn.accept();
        });

        return twilioDevice;

      } catch (error) {
        console.error('‚ùå Failed to initialize Twilio Device:', error);
        throw error;
      }
    }

    /**
     * Make a test call to the Voice AI
     */
    async function makeTestCall() {
      const callButton = document.getElementById('callButton');
      const originalText = callButton.textContent;

      try {
        callButton.disabled = true;
        callButton.textContent = '‚è≥ Connecting...';
        updateCallStatus('‚è≥ Initializing...');

        // Initialize device if not already done
        if (!twilioDevice) {
          await initializeTwilioDevice();
        }

        // Get the phone number to call
        const phoneNumber = config.selectedPhoneNumber;

        if (!phoneNumber) {
          throw new Error('No phone number configured. Please configure your Twilio phone number first.');
        }

        updateCallStatus('üìû Calling ' + phoneNumber + '...');

        // Make the call
        const params = {
          To: phoneNumber
        };

        currentCall = await twilioDevice.connect(params);

        console.log('üìû Calling:', phoneNumber);

      } catch (error) {
        console.error('‚ùå Call failed:', error);
        alert('‚ùå Failed to make call: ' + error.message);
        updateCallStatus('Click to call from your browser');
        callButton.disabled = false;
        callButton.textContent = originalText;
      }
    }

    /**
     * Hang up the current call
     */
    function hangupCall() {
      if (currentCall) {
        console.log('üìû Hanging up...');
        currentCall.disconnect();
        currentCall = null;
      }

      if (twilioDevice) {
        twilioDevice.disconnectAll();
      }

      updateCallStatus('Click to call from your browser');
      document.getElementById('callButton').style.display = 'inline-block';
      document.getElementById('callButton').disabled = false;
      document.getElementById('callButton').textContent = 'üìû Call Now';
      document.getElementById('hangupButton').style.display = 'none';
    }

    /**
     * Update call status text
     */
    function updateCallStatus(status) {
      const statusElement = document.getElementById('callStatusText');
      if (statusElement) {
        statusElement.textContent = status;
      }
    }
  </script>
</body>
</html>
