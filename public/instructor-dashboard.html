<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Workshop Instructor Dashboard | Send Student Invitations</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #F22F46 0%, #0d122b 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #F22F46 0%, #0d122b 100%);
      padding: 40px;
      color: white;
      text-align: center;
    }

    .header h1 {
      font-size: 2rem;
      margin-bottom: 10px;
    }

    .header p {
      opacity: 0.95;
      font-size: 1.1rem;
    }

    .content {
      padding: 40px;
    }

    .tabs {
      display: flex;
      border-bottom: 2px solid #e0e0e0;
      margin-bottom: 30px;
    }

    .tab {
      padding: 15px 30px;
      cursor: pointer;
      border: none;
      background: none;
      font-size: 1rem;
      color: #666;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
    }

    .tab.active {
      color: #F22F46;
      border-bottom-color: #F22F46;
      font-weight: 600;
    }

    .tab:hover {
      color: #F22F46;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .form-section {
      background: #f8f9fa;
      padding: 30px;
      border-radius: 12px;
      margin-bottom: 30px;
    }

    .form-section h2 {
      color: #0d122b;
      margin-bottom: 20px;
      font-size: 1.5rem;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 600;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #F22F46;
    }

    .form-group textarea {
      min-height: 120px;
      resize: vertical;
      font-family: inherit;
    }

    .hint {
      font-size: 0.9rem;
      color: #666;
      margin-top: 5px;
    }

    .button {
      background: #F22F46;
      color: white;
      padding: 15px 30px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .button:hover {
      background: #d11f3a;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(242, 47, 70, 0.3);
    }

    .button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .button.secondary {
      background: #6c757d;
    }

    .button.secondary:hover {
      background: #5a6268;
    }

    .alert {
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }

    .alert.success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }

    .alert.error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }

    .alert.info {
      background: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
    }

    .invitation-list {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid #e0e0e0;
    }

    .invitation-item {
      padding: 15px 20px;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .invitation-item:last-child {
      border-bottom: none;
    }

    .invitation-info {
      flex: 1;
    }

    .invitation-info .name {
      font-weight: 600;
      color: #0d122b;
      margin-bottom: 5px;
    }

    .invitation-info .email {
      color: #666;
      font-size: 0.9rem;
    }

    .invitation-status {
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .invitation-status.sent {
      background: #d4edda;
      color: #155724;
    }

    .invitation-status.pending {
      background: #fff3cd;
      color: #856404;
    }

    .invitation-status.failed {
      background: #f8d7da;
      color: #721c24;
    }

    .bulk-section {
      background: #e9ecef;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
    }

    .bulk-section h3 {
      margin-bottom: 15px;
      color: #0d122b;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .stat-card .number {
      font-size: 2.5rem;
      font-weight: bold;
      color: #F22F46;
      margin-bottom: 5px;
    }

    .stat-card .label {
      color: #666;
      font-size: 0.9rem;
    }

    .info-box {
      background: #d1ecf1;
      border-left: 4px solid #0c5460;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
    }

    .info-box h3 {
      color: #0c5460;
      margin-bottom: 10px;
    }

    .info-box p {
      color: #0c5460;
      line-height: 1.6;
      margin: 5px 0;
    }

    .info-box code {
      background: #bee5eb;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: monospace;
    }

    @media (max-width: 768px) {
      .content {
        padding: 20px;
      }

      .tabs {
        overflow-x: auto;
      }

      .tab {
        white-space: nowrap;
      }

      .invitation-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üë®‚Äçüè´ Workshop Instructor Dashboard</h1>
      <p>Send workshop invitations and manage student access</p>
    </div>

    <div class="content">
      <!-- Configuration Check -->
      <div class="info-box" id="configInfo">
        <h3>‚öôÔ∏è Configuration Required</h3>
        <p>To use this dashboard, you need to configure the following environment variables in your <code>.env</code> file:</p>
        <ul style="margin: 10px 0; padding-left: 20px;">
          <li><code>SENDGRID_API_KEY</code> - Your SendGrid API key (<a href="https://app.sendgrid.com/settings/api_keys" target="_blank">Get one here</a>)</li>
          <li><code>WORKSHOP_URL</code> - Your deployed workshop URL (e.g., https://your-service-dev.twil.io)</li>
          <li><code>INSTRUCTOR_EMAIL</code> - Email address invitations should come from</li>
          <li><code>INSTRUCTOR_NAME</code> - Your name (optional)</li>
          <li><code>GITHUB_REPO_URL</code> - Workshop repository URL (optional)</li>
        </ul>
        <p style="margin-top: 15px;"><strong>After adding these variables, redeploy your Twilio Serverless project:</strong></p>
        <p><code>twilio serverless:deploy</code></p>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab active" onclick="switchTab('progress')">Student Progress</button>
        <button class="tab" onclick="switchTab('single')">Send Single Invitation</button>
        <button class="tab" onclick="switchTab('bulk')">Bulk Send</button>
        <button class="tab" onclick="switchTab('history')">Invitation History</button>
        <button class="tab" onclick="switchTab('cleanup')">üßπ Cleanup</button>
      </div>

      <!-- Alert Messages -->
      <div id="alertSuccess" class="alert success"></div>
      <div id="alertError" class="alert error"></div>

      <!-- Student Progress Tab -->
      <div id="progressTab" class="tab-content active">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="number" id="totalStudents">0</div>
            <div class="label">Total Students</div>
          </div>
          <div class="stat-card">
            <div class="number" id="avgCompletion">0%</div>
            <div class="label">Avg Completion</div>
          </div>
          <div class="stat-card">
            <div class="number" id="activeStudents">0</div>
            <div class="label">Active (24h)</div>
          </div>
          <div class="stat-card">
            <div class="number" id="completedStudents">0</div>
            <div class="label">Completed 100%</div>
          </div>
        </div>

        <div class="form-section">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin: 0;">üìä Student Progress Dashboard</h2>
            <button class="button secondary" onclick="refreshProgressData()">üîÑ Refresh</button>
          </div>

          <div id="studentProgressList" class="invitation-list">
            <div class="invitation-item">
              <div class="invitation-info">
                <div class="email" style="color: #999;">Loading student progress...</div>
              </div>
            </div>
          </div>
        </div>

        <div class="form-section" style="margin-top: 30px;">
          <h2>üìà Exercise Completion Stats</h2>
          <div id="exerciseStats" style="margin-top: 20px;">
            <!-- Exercise stats will be populated here -->
          </div>
        </div>
      </div>

      <!-- Single Invitation Tab -->
      <div id="singleTab" class="tab-content">
        <div class="form-section">
          <h2>üìß Send Workshop Invitation</h2>

          <form id="invitationForm" onsubmit="sendInvitation(event)">
            <div class="form-group">
              <label for="studentEmail">Student Email Address *</label>
              <input
                type="email"
                id="studentEmail"
                required
                placeholder="student@example.com"
              />
              <div class="hint">The email address where the invitation will be sent</div>
            </div>

            <div class="form-group">
              <label for="studentName">Student Name</label>
              <input
                type="text"
                id="studentName"
                placeholder="John Doe"
              />
              <div class="hint">Optional - used to personalize the email</div>
            </div>

            <div class="form-group">
              <label for="workshopDate">Workshop Date & Time</label>
              <input
                type="text"
                id="workshopDate"
                placeholder="January 15, 2025 at 2:00 PM EST"
              />
              <div class="hint">Optional - when the workshop will take place</div>
            </div>

            <div class="form-group">
              <label for="additionalNotes">Additional Notes</label>
              <textarea
                id="additionalNotes"
                placeholder="Any additional information for the student (Zoom link, special instructions, etc.)"
              ></textarea>
              <div class="hint">Optional - additional information included in the email</div>
            </div>

            <button type="submit" class="button" id="sendButton">
              Send Invitation
            </button>
          </form>
        </div>
      </div>

      <!-- Bulk Invitation Tab -->
      <div id="bulkTab" class="tab-content">
        <div class="form-section">
          <h2>üì® Bulk Send Invitations</h2>
          <p style="margin-bottom: 20px;">Send invitations to multiple students at once.</p>

          <div class="bulk-section">
            <h3>CSV Format</h3>
            <p>Upload a CSV file with the following columns:</p>
            <pre style="background: white; padding: 15px; border-radius: 8px; margin: 10px 0;">email,name
student1@example.com,John Doe
student2@example.com,Jane Smith</pre>
          </div>

          <form id="bulkForm" onsubmit="sendBulkInvitations(event)">
            <div class="form-group">
              <label for="csvFile">CSV File</label>
              <input
                type="file"
                id="csvFile"
                accept=".csv"
                onchange="previewCSV(event)"
              />
              <div class="hint">Upload a CSV file with student emails and names</div>
            </div>

            <div class="form-group">
              <label for="bulkWorkshopDate">Workshop Date & Time</label>
              <input
                type="text"
                id="bulkWorkshopDate"
                placeholder="January 15, 2025 at 2:00 PM EST"
              />
            </div>

            <div class="form-group">
              <label for="bulkNotes">Additional Notes</label>
              <textarea
                id="bulkNotes"
                placeholder="Additional information for all students"
              ></textarea>
            </div>

            <div id="csvPreview" style="display: none; margin: 20px 0;">
              <h3>Preview (first 5 students):</h3>
              <div id="csvPreviewList" class="invitation-list"></div>
            </div>

            <button type="submit" class="button" id="bulkSendButton" disabled>
              Send All Invitations
            </button>
          </form>
        </div>
      </div>

      <!-- History Tab -->
      <div id="historyTab" class="tab-content">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="number" id="totalSent">0</div>
            <div class="label">Total Sent</div>
          </div>
          <div class="stat-card">
            <div class="number" id="totalPending">0</div>
            <div class="label">Pending</div>
          </div>
          <div class="stat-card">
            <div class="number" id="totalFailed">0</div>
            <div class="label">Failed</div>
          </div>
        </div>

        <div class="form-section">
          <h2>üìã Recent Invitations</h2>
          <div id="invitationHistory" class="invitation-list">
            <div class="invitation-item">
              <div class="invitation-info">
                <div class="email" style="color: #999;">No invitations sent yet</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Cleanup Tab -->
      <div id="cleanupTab" class="tab-content">
        <div class="info-box" style="background: #fff3cd; border-left-color: #856404;">
          <h3 style="color: #856404;">‚ö†Ô∏è Post-Workshop Cleanup</h3>
          <p style="color: #856404;">
            Manage student sessions after your workshop. You can delete API keys only (preserving all other data) or completely remove sessions.
          </p>
        </div>

        <div class="form-section">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin: 0;">üóÑÔ∏è Student Sessions</h2>
            <button class="button secondary" onclick="loadCleanupSessions()">üîÑ Refresh</button>
          </div>

          <div class="form-group">
            <label for="cleanupAdminPassword">Admin Password *</label>
            <input
              type="password"
              id="cleanupAdminPassword"
              placeholder="Enter ADMIN_PASSWORD from environment"
              required
            />
            <div class="hint">Required to view and manage sessions</div>
          </div>

          <button class="button" onclick="loadCleanupSessions()" style="margin-bottom: 20px;">
            üîì Load Sessions
          </button>

          <div id="cleanupSessionsContainer" style="display: none;">
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
              <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                <div>
                  <label style="display: inline-flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="selectAllSessions" onchange="toggleSelectAll()" />
                    <span style="font-weight: 600;">Select All (<span id="sessionCount">0</span> sessions)</span>
                  </label>
                </div>
                <div style="display: flex; gap: 10px;">
                  <button class="button secondary" onclick="deleteSelectedKeys()" id="deleteKeysBtn" disabled>
                    üîë Delete API Keys Only
                  </button>
                  <button class="button" onclick="deleteSelectedSessions()" id="deleteSessionsBtn" disabled style="background: #dc3545;">
                    üóëÔ∏è Delete Complete Sessions
                  </button>
                </div>
              </div>
            </div>

            <div id="sessionsList" class="invitation-list" style="max-height: 600px; overflow-y: auto;">
              <!-- Populated dynamically -->
            </div>
          </div>

          <div id="cleanupResults" style="display: none; margin-top: 30px;">
            <div class="form-section" style="background: #d4edda; border: 2px solid #c3e6cb;">
              <h3 style="color: #155724; margin-bottom: 15px;">‚úÖ Cleanup Complete</h3>
              <div id="cleanupResultsContent"></div>
            </div>
          </div>
        </div>

        <div class="form-section" style="background: #e3f2fd; border: 2px solid #90caf9;">
          <h3 style="color: #1976d2; margin-bottom: 15px;">üí° Cleanup Options</h3>
          <ul style="color: #1976d2; line-height: 1.8; padding-left: 20px;">
            <li><strong>Delete API Keys Only:</strong> Removes OpenAI keys but preserves all other data (names, prompts, tools, phone numbers)</li>
            <li><strong>Delete Complete Sessions:</strong> Permanently removes all data for selected sessions</li>
            <li><strong>Best Practice:</strong> Delete API keys for security and cost control after workshop ends</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Store invitation history in localStorage
    const STORAGE_KEY = 'workshop_invitations';

    // Switch between tabs
    function switchTab(tabName) {
      // Hide all tab contents
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });

      // Remove active class from all tabs
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });

      // Show selected tab
      document.getElementById(tabName + 'Tab').classList.add('active');

      // Set active tab
      event.target.classList.add('active');

      // Load history if switching to history tab
      if (tabName === 'history') {
        loadInvitationHistory();
      }
    }

    // Show alert message
    function showAlert(type, message) {
      const alertElement = type === 'success' ?
        document.getElementById('alertSuccess') :
        document.getElementById('alertError');

      alertElement.textContent = message;
      alertElement.style.display = 'block';

      // Hide after 5 seconds
      setTimeout(() => {
        alertElement.style.display = 'none';
      }, 5000);
    }

    // Send single invitation
    async function sendInvitation(event) {
      event.preventDefault();

      const button = document.getElementById('sendButton');
      button.disabled = true;
      button.textContent = 'Sending...';

      const studentEmail = document.getElementById('studentEmail').value;
      const studentName = document.getElementById('studentName').value;
      const workshopDate = document.getElementById('workshopDate').value;
      const additionalNotes = document.getElementById('additionalNotes').value;

      try {
        const response = await fetch('/api/send-workshop-invitation', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: new URLSearchParams({
            studentEmail,
            studentName,
            workshopDate,
            additionalNotes
          })
        });

        const data = await response.json();

        if (data.success) {
          showAlert('success', `‚úÖ Invitation sent successfully to ${studentEmail}!`);

          // Save to history
          saveInvitationToHistory({
            email: studentEmail,
            name: studentName,
            date: new Date().toISOString(),
            status: 'sent'
          });

          // Reset form
          document.getElementById('invitationForm').reset();
        } else {
          showAlert('error', `‚ùå Error: ${data.error || 'Failed to send invitation'}`);
        }
      } catch (error) {
        console.error('Error sending invitation:', error);
        showAlert('error', `‚ùå Error: ${error.message}`);
      } finally {
        button.disabled = false;
        button.textContent = 'Send Invitation';
      }
    }

    // Preview CSV file
    function previewCSV(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const text = e.target.result;
        const rows = text.split('\n').filter(row => row.trim());

        // Skip header row
        const students = rows.slice(1).map(row => {
          const [email, name] = row.split(',');
          return { email: email?.trim(), name: name?.trim() };
        }).filter(s => s.email);

        if (students.length > 0) {
          const previewList = document.getElementById('csvPreviewList');
          previewList.innerHTML = students.slice(0, 5).map(student => `
            <div class="invitation-item">
              <div class="invitation-info">
                <div class="name">${student.name || 'No name'}</div>
                <div class="email">${student.email}</div>
              </div>
              <span class="invitation-status pending">Ready to send</span>
            </div>
          `).join('');

          document.getElementById('csvPreview').style.display = 'block';
          document.getElementById('bulkSendButton').disabled = false;

          // Store students data
          window.bulkStudents = students;
        }
      };
      reader.readAsText(file);
    }

    // Send bulk invitations
    async function sendBulkInvitations(event) {
      event.preventDefault();

      if (!window.bulkStudents || window.bulkStudents.length === 0) {
        showAlert('error', '‚ùå No students to send invitations to');
        return;
      }

      const button = document.getElementById('bulkSendButton');
      button.disabled = true;
      button.textContent = 'Sending...';

      const workshopDate = document.getElementById('bulkWorkshopDate').value;
      const additionalNotes = document.getElementById('bulkNotes').value;

      let successCount = 0;
      let failCount = 0;

      for (const student of window.bulkStudents) {
        try {
          const response = await fetch('/api/send-workshop-invitation', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
              studentEmail: student.email,
              studentName: student.name,
              workshopDate,
              additionalNotes
            })
          });

          const data = await response.json();

          if (data.success) {
            successCount++;
            saveInvitationToHistory({
              email: student.email,
              name: student.name,
              date: new Date().toISOString(),
              status: 'sent'
            });
          } else {
            failCount++;
            saveInvitationToHistory({
              email: student.email,
              name: student.name,
              date: new Date().toISOString(),
              status: 'failed'
            });
          }

          // Update button text with progress
          button.textContent = `Sending... (${successCount + failCount}/${window.bulkStudents.length})`;

          // Small delay between sends to avoid rate limiting
          await new Promise(resolve => setTimeout(resolve, 500));

        } catch (error) {
          console.error('Error sending to', student.email, error);
          failCount++;
        }
      }

      button.disabled = false;
      button.textContent = 'Send All Invitations';

      showAlert('success', `‚úÖ Sent ${successCount} invitations successfully${failCount > 0 ? `, ${failCount} failed` : ''}!`);

      // Reset form
      document.getElementById('bulkForm').reset();
      document.getElementById('csvPreview').style.display = 'none';
      window.bulkStudents = [];
    }

    // Save invitation to history
    function saveInvitationToHistory(invitation) {
      const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      history.unshift(invitation);

      // Keep only last 100 invitations
      if (history.length > 100) {
        history.pop();
      }

      localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
    }

    // Load invitation history
    function loadInvitationHistory() {
      const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');

      if (history.length === 0) {
        return;
      }

      // Update stats
      const sent = history.filter(h => h.status === 'sent').length;
      const pending = history.filter(h => h.status === 'pending').length;
      const failed = history.filter(h => h.status === 'failed').length;

      document.getElementById('totalSent').textContent = sent;
      document.getElementById('totalPending').textContent = pending;
      document.getElementById('totalFailed').textContent = failed;

      // Display history
      const historyList = document.getElementById('invitationHistory');
      historyList.innerHTML = history.map(invitation => {
        const date = new Date(invitation.date);
        return `
          <div class="invitation-item">
            <div class="invitation-info">
              <div class="name">${invitation.name || 'No name provided'}</div>
              <div class="email">${invitation.email} - ${date.toLocaleDateString()} ${date.toLocaleTimeString()}</div>
            </div>
            <span class="invitation-status ${invitation.status}">${invitation.status}</span>
          </div>
        `;
      }).join('');
    }

    // Load history on page load
    loadInvitationHistory();

    // =============================================
    // STUDENT PROGRESS TRACKING
    // =============================================

    let studentProgressData = [];

    // Load student progress data
    async function loadStudentProgress() {
      try {
        const response = await fetch('/api/track-student-progress?getAllStudents=true');
        const data = await response.json();

        if (data.success) {
          studentProgressData = data.students || [];
          renderProgressDashboard();
        } else {
          console.error('Error loading student progress:', data.error);
        }
      } catch (error) {
        console.error('Error fetching student progress:', error);
      }
    }

    // Render progress dashboard
    function renderProgressDashboard() {
      // Calculate stats
      const total = studentProgressData.length;
      const avgCompletion = total > 0 ?
        Math.round(studentProgressData.reduce((sum, s) => sum + (s.completionRate || 0), 0) / total) : 0;

      const now = Date.now();
      const oneDayAgo = now - (24 * 60 * 60 * 1000);
      const activeStudents = studentProgressData.filter(s =>
        s.lastActivity && new Date(s.lastActivity).getTime() > oneDayAgo
      ).length;

      const completedStudents = studentProgressData.filter(s => s.completionRate === 100).length;

      // Update stats cards
      document.getElementById('totalStudents').textContent = total;
      document.getElementById('avgCompletion').textContent = `${avgCompletion}%`;
      document.getElementById('activeStudents').textContent = activeStudents;
      document.getElementById('completedStudents').textContent = completedStudents;

      // Render student list
      const listContainer = document.getElementById('studentProgressList');

      if (total === 0) {
        listContainer.innerHTML = `
          <div class="invitation-item">
            <div class="invitation-info">
              <div class="email" style="color: #999;">No student progress data yet. Students need to start the workshop.</div>
            </div>
          </div>
        `;
        return;
      }

      // Sort by last activity (most recent first)
      const sortedStudents = [...studentProgressData].sort((a, b) => {
        const aTime = a.lastActivity ? new Date(a.lastActivity).getTime() : 0;
        const bTime = b.lastActivity ? new Date(b.lastActivity).getTime() : 0;
        return bTime - aTime;
      });

      listContainer.innerHTML = sortedStudents.map(student => {
        const completionRate = student.completionRate || 0;
        const lastActivity = student.lastActivity ? new Date(student.lastActivity) : null;
        const timeAgo = lastActivity ? getTimeAgo(lastActivity) : 'Never';

        const completed = Object.values(student.exercises || {}).filter(ex => ex.completed).length;
        const totalTimeSpent = Math.round((student.totalTimeSpent || 0) / 60); // Convert to minutes

        let statusColor = '#dc3545'; // Red for low progress
        if (completionRate >= 75) statusColor = '#28a745'; // Green for high progress
        else if (completionRate >= 40) statusColor = '#ffc107'; // Yellow for medium progress

        return `
          <div class="invitation-item" style="flex-direction: column; align-items: stretch; padding: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
              <div class="invitation-info">
                <div class="name" style="font-size: 1.1rem;">${student.studentName || student.studentId}</div>
                <div class="email">${student.studentId}</div>
              </div>
              <div style="text-align: right;">
                <div style="font-size: 1.5rem; font-weight: bold; color: ${statusColor};">${completionRate}%</div>
                <div style="font-size: 0.8rem; color: #666;">Completion</div>
              </div>
            </div>

            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 10px;">
                <div>
                  <div style="font-size: 0.8rem; color: #666;">Exercises Done</div>
                  <div style="font-weight: 600;">${completed} / 9</div>
                </div>
                <div>
                  <div style="font-size: 0.8rem; color: #666;">Time Spent</div>
                  <div style="font-weight: 600;">${totalTimeSpent} min</div>
                </div>
                <div>
                  <div style="font-size: 0.8rem; color: #666;">Last Active</div>
                  <div style="font-weight: 600;">${timeAgo}</div>
                </div>
              </div>

              <div style="margin-top: 10px;">
                <div style="font-size: 0.8rem; color: #666; margin-bottom: 5px;">Progress:</div>
                <div style="background: #e0e0e0; height: 8px; border-radius: 4px; overflow: hidden;">
                  <div style="background: ${statusColor}; height: 100%; width: ${completionRate}%; transition: width 0.3s;"></div>
                </div>
              </div>
            </div>

            <button onclick="viewStudentDetail('${student.studentId}')" class="button secondary" style="margin-top: 15px; padding: 8px 16px; font-size: 0.9rem;">
              View Detailed Progress ‚Üí
            </button>
          </div>
        `;
      }).join('');

      // Render exercise stats
      renderExerciseStats();
    }

    // Render exercise completion statistics
    function renderExerciseStats() {
      const exerciseNames = [
        'Exercise 1: Echo Bot',
        'Exercise 2: Question Counter',
        'Exercise 3: Context-Aware Responses',
        'Exercise 4: Conversation History',
        'Exercise 5: Add OpenAI',
        'Exercise 6: Response Timing',
        'Exercise 7: Error Handling',
        'Exercise 8: Tool Calling',
        'Exercise 9: Handle Interruptions'
      ];

      const exerciseStats = exerciseNames.map((name, index) => {
        const exerciseId = `exercise-${index + 1}`;
        const completedCount = studentProgressData.filter(student =>
          student.exercises && student.exercises[exerciseId] && student.exercises[exerciseId].completed
        ).length;

        const total = studentProgressData.length;
        const percentage = total > 0 ? Math.round((completedCount / total) * 100) : 0;

        return { name, completedCount, total, percentage };
      });

      const statsContainer = document.getElementById('exerciseStats');
      statsContainer.innerHTML = exerciseStats.map(stat => `
        <div style="margin-bottom: 20px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <span style="font-weight: 600;">${stat.name}</span>
            <span style="color: #666;">${stat.completedCount} / ${stat.total} students (${stat.percentage}%)</span>
          </div>
          <div style="background: #e0e0e0; height: 8px; border-radius: 4px; overflow: hidden;">
            <div style="background: linear-gradient(135deg, #F22F46 0%, #ff6b6b 100%); height: 100%; width: ${stat.percentage}%; transition: width 0.3s;"></div>
          </div>
        </div>
      `).join('');
    }

    // View detailed student progress
    function viewStudentDetail(studentId) {
      const student = studentProgressData.find(s => s.studentId === studentId);
      if (!student) return;

      const exercises = student.exercises || {};
      const exerciseNames = [
        'Exercise 1: Echo Bot',
        'Exercise 2: Question Counter',
        'Exercise 3: Context-Aware Responses',
        'Exercise 4: Conversation History',
        'Exercise 5: Add OpenAI',
        'Exercise 6: Response Timing',
        'Exercise 7: Error Handling',
        'Exercise 8: Tool Calling',
        'Exercise 9: Handle Interruptions'
      ];

      const detailHTML = `
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 800px; margin: 0 auto;">
          <h2 style="margin-bottom: 20px;">${student.studentName || student.studentId}</h2>
          <div style="color: #666; margin-bottom: 30px;">${student.studentId}</div>

          <h3 style="margin-bottom: 15px;">Exercise Progress:</h3>
          ${exerciseNames.map((name, index) => {
            const exerciseId = `exercise-${index + 1}`;
            const ex = exercises[exerciseId] || {};
            const completed = ex.completed || false;
            const timeSpent = Math.round((ex.timeSpent || 0) / 60);
            const attempts = ex.attempts || 0;

            return `
              <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <span style="font-weight: 600;">${name}</span>
                    ${completed ? '<span style="color: #28a745; margin-left: 10px;">‚úì Completed</span>' : '<span style="color: #666; margin-left: 10px;">In Progress</span>'}
                  </div>
                  <div style="text-align: right; font-size: 0.9rem; color: #666;">
                    ${timeSpent > 0 ? `${timeSpent} min` : ''}
                    ${attempts > 0 ? ` ‚Ä¢ ${attempts} attempts` : ''}
                  </div>
                </div>
              </div>
            `;
          }).join('')}

          <button onclick="closeStudentDetail()" class="button" style="margin-top: 20px;">Close</button>
        </div>
      `;

      // Create modal overlay
      const overlay = document.createElement('div');
      overlay.id = 'studentDetailOverlay';
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        overflow-y: auto;
      `;
      overlay.innerHTML = detailHTML;
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) closeStudentDetail();
      });
      document.body.appendChild(overlay);
    }

    // Close student detail modal
    function closeStudentDetail() {
      const overlay = document.getElementById('studentDetailOverlay');
      if (overlay) overlay.remove();
    }

    // Refresh progress data
    async function refreshProgressData() {
      showAlert('info', 'Refreshing student progress data...');
      await loadStudentProgress();
      showAlert('success', 'Student progress data updated!');
    }

    // Get time ago string
    function getTimeAgo(date) {
      const seconds = Math.floor((new Date() - date) / 1000);

      const intervals = {
        year: 31536000,
        month: 2592000,
        week: 604800,
        day: 86400,
        hour: 3600,
        minute: 60
      };

      for (const [unit, secondsInUnit] of Object.entries(intervals)) {
        const interval = Math.floor(seconds / secondsInUnit);
        if (interval >= 1) {
          return interval === 1 ? `1 ${unit} ago` : `${interval} ${unit}s ago`;
        }
      }

      return 'Just now';
    }

    // Update switchTab function to load progress when switching to that tab
    const originalSwitchTab = switchTab;
    switchTab = function(tabName) {
      originalSwitchTab.call(this, tabName);

      if (tabName === 'progress') {
        loadStudentProgress();
      }
    };

    // Load progress on page load
    loadStudentProgress();

    // =============================================
    // CLEANUP TAB - Session Management
    // =============================================

    let cleanupSessions = [];
    let selectedSessionTokens = new Set();

    async function loadCleanupSessions() {
      const password = document.getElementById('cleanupAdminPassword').value;

      if (!password) {
        showAlert('error', '‚ùå Please enter the admin password');
        return;
      }

      try {
        const response = await fetch('/api/admin-list-configs', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            adminPassword: password
          })
        });

        const data = await response.json();

        if (!data.success) {
          showAlert('error', `‚ùå ${data.error || 'Failed to load sessions'}`);
          return;
        }

        cleanupSessions = data.sessions || [];
        selectedSessionTokens.clear();

        // Show sessions container
        document.getElementById('cleanupSessionsContainer').style.display = 'block';
        document.getElementById('sessionCount').textContent = cleanupSessions.length;

        // Render sessions
        renderCleanupSessions();

        showAlert('success', `‚úÖ Loaded ${cleanupSessions.length} sessions`);

      } catch (error) {
        console.error('Load sessions error:', error);
        showAlert('error', `‚ùå Error: ${error.message}`);
      }
    }

    function renderCleanupSessions() {
      const listContainer = document.getElementById('sessionsList');

      if (cleanupSessions.length === 0) {
        listContainer.innerHTML = `
          <div class="invitation-item">
            <div class="invitation-info">
              <div class="email" style="color: #999;">No sessions found in database</div>
            </div>
          </div>
        `;
        return;
      }

      listContainer.innerHTML = cleanupSessions.map(session => {
        const isSelected = selectedSessionTokens.has(session.sessionToken);
        const createdDate = new Date(session.createdAt).toLocaleString();
        const updatedDate = new Date(session.updatedAt).toLocaleString();

        return `
          <div class="invitation-item" style="flex-direction: column; align-items: stretch; padding: 20px; background: ${isSelected ? '#fff3cd' : 'white'};">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
              <div style="display: flex; align-items: flex-start; gap: 15px; flex: 1;">
                <input
                  type="checkbox"
                  ${isSelected ? 'checked' : ''}
                  onchange="toggleSessionSelect('${session.sessionToken}')"
                  style="margin-top: 5px; cursor: pointer; width: 18px; height: 18px;"
                />
                <div class="invitation-info" style="flex: 1;">
                  <div class="name" style="font-size: 1.1rem;">${session.studentName}</div>
                  <div class="email" style="margin-top: 5px;">Session: ${session.sessionToken.substring(0, 40)}...</div>
                  <div style="margin-top: 10px; font-size: 0.9rem; color: #666;">
                    <div>üìû Phone: ${session.phoneNumber || 'Not set'}</div>
                    <div>üéôÔ∏è Voice: ${session.voice || 'Not set'} (${session.ttsProvider || 'N/A'})</div>
                    <div style="margin-top: 5px;">
                      ${session.hasApiKey ? '<span style="background: #fff3cd; padding: 3px 8px; border-radius: 4px; font-size: 0.85rem;">üîë Has API Key</span>' : '<span style="color: #999;">No API Key</span>'}
                      ${session.hasSystemPrompt ? '<span style="background: #e3f2fd; padding: 3px 8px; border-radius: 4px; margin-left: 5px; font-size: 0.85rem;">üìù Has Prompt</span>' : ''}
                      ${session.hasTools ? '<span style="background: #e8f5e9; padding: 3px 8px; border-radius: 4px; margin-left: 5px; font-size: 0.85rem;">üîß Has Tools</span>' : ''}
                    </div>
                  </div>
                </div>
              </div>
              <div style="text-align: right; font-size: 0.85rem; color: #666;">
                <div>Created: ${createdDate}</div>
                <div style="margin-top: 3px;">Updated: ${updatedDate}</div>
              </div>
            </div>
          </div>
        `;
      }).join('');

      updateButtonStates();
    }

    function toggleSessionSelect(sessionToken) {
      if (selectedSessionTokens.has(sessionToken)) {
        selectedSessionTokens.delete(sessionToken);
      } else {
        selectedSessionTokens.add(sessionToken);
      }

      renderCleanupSessions();
    }

    function toggleSelectAll() {
      const selectAll = document.getElementById('selectAllSessions').checked;

      if (selectAll) {
        cleanupSessions.forEach(session => {
          selectedSessionTokens.add(session.sessionToken);
        });
      } else {
        selectedSessionTokens.clear();
      }

      renderCleanupSessions();
    }

    function updateButtonStates() {
      const hasSelection = selectedSessionTokens.size > 0;
      document.getElementById('deleteKeysBtn').disabled = !hasSelection;
      document.getElementById('deleteSessionsBtn').disabled = !hasSelection;
      document.getElementById('selectAllSessions').checked = selectedSessionTokens.size === cleanupSessions.length && cleanupSessions.length > 0;
    }

    async function deleteSelectedKeys() {
      if (selectedSessionTokens.size === 0) {
        showAlert('error', '‚ùå No sessions selected');
        return;
      }

      const confirmDelete = confirm(
        `‚ö†Ô∏è Delete API keys from ${selectedSessionTokens.size} selected session(s)?\n\n` +
        'This will remove only the OpenAI API keys.\n' +
        'All other data will be preserved.\n\n' +
        'This action cannot be undone.'
      );

      if (!confirmDelete) return;

      const password = document.getElementById('cleanupAdminPassword').value;

      try {
        const response = await fetch('/api/admin-delete-sessions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            adminPassword: password,
            sessionTokens: Array.from(selectedSessionTokens),
            deleteType: 'keys-only'
          })
        });

        const data = await response.json();

        if (!data.success) {
          showAlert('error', `‚ùå ${data.error || 'Failed to delete keys'}`);
          return;
        }

        showAlert('success', `‚úÖ ${data.message}`);

        // Reload sessions
        await loadCleanupSessions();

      } catch (error) {
        console.error('Delete keys error:', error);
        showAlert('error', `‚ùå Error: ${error.message}`);
      }
    }

    async function deleteSelectedSessions() {
      if (selectedSessionTokens.size === 0) {
        showAlert('error', '‚ùå No sessions selected');
        return;
      }

      const confirmDelete = confirm(
        `‚ö†Ô∏è PERMANENTLY DELETE ${selectedSessionTokens.size} complete session(s)?\n\n` +
        'This will remove ALL data for these sessions:\n' +
        '‚Ä¢ Student names\n' +
        '‚Ä¢ API keys\n' +
        '‚Ä¢ System prompts\n' +
        '‚Ä¢ Tool configurations\n' +
        '‚Ä¢ Phone numbers\n' +
        '‚Ä¢ All other settings\n\n' +
        'This action cannot be undone. Are you sure?'
      );

      if (!confirmDelete) return;

      const password = document.getElementById('cleanupAdminPassword').value;

      try {
        const response = await fetch('/api/admin-delete-sessions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            adminPassword: password,
            sessionTokens: Array.from(selectedSessionTokens),
            deleteType: 'full'
          })
        });

        const data = await response.json();

        if (!data.success) {
          showAlert('error', `‚ùå ${data.error || 'Failed to delete sessions'}`);
          return;
        }

        showAlert('success', `‚úÖ ${data.message}`);

        // Reload sessions
        await loadCleanupSessions();

      } catch (error) {
        console.error('Delete sessions error:', error);
        showAlert('error', `‚ùå Error: ${error.message}`);
      }
    }
  </script>
</body>
</html>
// force redeploy Wed Oct 22 11:42:26 EDT 2025
