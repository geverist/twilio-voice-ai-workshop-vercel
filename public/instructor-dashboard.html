<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Workshop Instructor Dashboard | Send Student Invitations</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #F22F46 0%, #0d122b 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #F22F46 0%, #0d122b 100%);
      padding: 40px;
      color: white;
      text-align: center;
      position: relative;
    }

    .header h1 {
      font-size: 2rem;
      margin-bottom: 10px;
    }

    .header p {
      opacity: 0.95;
      font-size: 1.1rem;
    }

    .admin-login-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 2px solid rgba(255, 255, 255, 0.5);
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      transition: all 0.3s;
    }

    .admin-login-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.8);
    }

    .admin-login-btn.logged-in {
      background: rgba(76, 175, 80, 0.3);
      border-color: rgba(76, 175, 80, 0.8);
    }

    .content {
      padding: 40px;
    }

    .tabs {
      display: flex;
      border-bottom: 2px solid #e0e0e0;
      margin-bottom: 30px;
    }

    .tab {
      padding: 15px 30px;
      cursor: pointer;
      border: none;
      background: none;
      font-size: 1rem;
      color: #666;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
    }

    .tab.active {
      color: #F22F46;
      border-bottom-color: #F22F46;
      font-weight: 600;
    }

    .tab:hover {
      color: #F22F46;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .form-section {
      background: #f8f9fa;
      padding: 30px;
      border-radius: 12px;
      margin-bottom: 30px;
    }

    .form-section h2 {
      color: #0d122b;
      margin-bottom: 20px;
      font-size: 1.5rem;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 600;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #F22F46;
    }

    .form-group textarea {
      min-height: 120px;
      resize: vertical;
      font-family: inherit;
    }

    .hint {
      font-size: 0.9rem;
      color: #666;
      margin-top: 5px;
    }

    .button {
      background: #F22F46;
      color: white;
      padding: 15px 30px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .button:hover {
      background: #d11f3a;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(242, 47, 70, 0.3);
    }

    .button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .button.secondary {
      background: #6c757d;
    }

    .button.secondary:hover {
      background: #5a6268;
    }

    .alert {
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }

    .alert.success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }

    .alert.error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }

    .alert.info {
      background: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
    }

    .invitation-list {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid #e0e0e0;
    }

    .invitation-item {
      padding: 15px 20px;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .invitation-item:last-child {
      border-bottom: none;
    }

    .invitation-info {
      flex: 1;
    }

    .invitation-info .name {
      font-weight: 600;
      color: #0d122b;
      margin-bottom: 5px;
    }

    .invitation-info .email {
      color: #666;
      font-size: 0.9rem;
    }

    .invitation-status {
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .invitation-status.sent {
      background: #d4edda;
      color: #155724;
    }

    .invitation-status.pending {
      background: #fff3cd;
      color: #856404;
    }

    .invitation-status.failed {
      background: #f8d7da;
      color: #721c24;
    }

    .bulk-section {
      background: #e9ecef;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
    }

    .bulk-section h3 {
      margin-bottom: 15px;
      color: #0d122b;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .stat-card .number {
      font-size: 2.5rem;
      font-weight: bold;
      color: #F22F46;
      margin-bottom: 5px;
    }

    .stat-card .label {
      color: #666;
      font-size: 0.9rem;
    }

    .info-box {
      background: #d1ecf1;
      border-left: 4px solid #0c5460;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
    }

    .info-box h3 {
      color: #0c5460;
      margin-bottom: 10px;
    }

    .info-box p {
      color: #0c5460;
      line-height: 1.6;
      margin: 5px 0;
    }

    .info-box code {
      background: #bee5eb;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: monospace;
    }

    @media (max-width: 768px) {
      .content {
        padding: 20px;
      }

      .tabs {
        overflow-x: auto;
      }

      .tab {
        white-space: nowrap;
      }

      .invitation-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <button class="admin-login-btn" id="adminLoginBtn" onclick="handleAdminLogin()">
        üîì Admin Login
      </button>
      <h1>üë®‚Äçüè´ Workshop Instructor Dashboard</h1>
      <p>Send workshop invitations and manage student access</p>
    </div>

    <div class="content">
      <!-- Configuration Check -->
      <div class="info-box" id="configInfo">
        <h3>‚öôÔ∏è Configuration Required</h3>
        <p>To use this dashboard, you need to configure the following environment variables in your <code>.env</code> file:</p>
        <ul style="margin: 10px 0; padding-left: 20px;">
          <li><code>SENDGRID_API_KEY</code> - Your SendGrid API key (<a href="https://app.sendgrid.com/settings/api_keys" target="_blank">Get one here</a>)</li>
          <li><code>WORKSHOP_URL</code> - Your deployed workshop URL (e.g., https://your-service-dev.twil.io)</li>
          <li><code>INSTRUCTOR_EMAIL</code> - Email address invitations should come from</li>
          <li><code>INSTRUCTOR_NAME</code> - Your name (optional)</li>
          <li><code>GITHUB_REPO_URL</code> - Workshop repository URL (optional)</li>
        </ul>
        <p style="margin-top: 15px;"><strong>After adding these variables, redeploy your Twilio Serverless project:</strong></p>
        <p><code>twilio serverless:deploy</code></p>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab active" onclick="switchTab('progress')">Student Progress</button>
        <button class="tab" onclick="switchTab('single')">Send Single Invitation</button>
        <button class="tab" onclick="switchTab('bulk')">Bulk Send</button>
        <button class="tab" onclick="switchTab('history')">Invitation History</button>
        <button class="tab" onclick="switchTab('cleanup')">üë• Active Students</button>
      </div>

      <!-- Alert Messages -->
      <div id="alertSuccess" class="alert success"></div>
      <div id="alertError" class="alert error"></div>

      <!-- Student Progress Tab -->
      <div id="progressTab" class="tab-content active">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="number" id="totalStudents">0</div>
            <div class="label">Total Students</div>
          </div>
          <div class="stat-card">
            <div class="number" id="avgCompletion">0%</div>
            <div class="label">Avg Completion</div>
          </div>
          <div class="stat-card">
            <div class="number" id="activeStudents">0</div>
            <div class="label">Active (24h)</div>
          </div>
          <div class="stat-card">
            <div class="number" id="completedStudents">0</div>
            <div class="label">Completed 100%</div>
          </div>
        </div>

        <div class="form-section">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin: 0;">üìä Student Progress Dashboard</h2>
            <button class="button secondary" onclick="refreshProgressData()">üîÑ Refresh</button>
          </div>

          <div id="studentProgressList" class="invitation-list">
            <div class="invitation-item">
              <div class="invitation-info">
                <div class="email" style="color: #999;">Loading student progress...</div>
              </div>
            </div>
          </div>
        </div>

        <div class="form-section" style="margin-top: 30px;">
          <h2>üìà Exercise Completion Stats</h2>
          <div id="exerciseStats" style="margin-top: 20px;">
            <!-- Exercise stats will be populated here -->
          </div>
        </div>
      </div>

      <!-- Single Invitation Tab -->
      <div id="singleTab" class="tab-content">
        <div class="form-section">
          <h2>üìß Send Workshop Invitation</h2>

          <form id="invitationForm" onsubmit="sendInvitation(event)">
            <div class="form-group">
              <label for="studentEmail">Student Email Address *</label>
              <input
                type="email"
                id="studentEmail"
                required
                placeholder="student@example.com"
              />
              <div class="hint">The email address where the invitation will be sent</div>
            </div>

            <div class="form-group">
              <label for="studentName">Student Name</label>
              <input
                type="text"
                id="studentName"
                placeholder="John Doe"
              />
              <div class="hint">Optional - used to personalize the email</div>
            </div>

            <div class="form-group">
              <label for="workshopDate">Workshop Date & Time</label>
              <input
                type="text"
                id="workshopDate"
                placeholder="January 15, 2025 at 2:00 PM EST"
              />
              <div class="hint">Optional - when the workshop will take place</div>
            </div>

            <div class="form-group">
              <label for="additionalNotes">Additional Notes</label>
              <textarea
                id="additionalNotes"
                placeholder="Any additional information for the student (Zoom link, special instructions, etc.)"
              ></textarea>
              <div class="hint">Optional - additional information included in the email</div>
            </div>

            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
              <button type="submit" class="button" id="sendButton" style="flex: 1; min-width: 200px;">
                üìß Send Invitation
              </button>
              <button type="button" class="button secondary" onclick="generateAndCopyLink()" style="flex: 1; min-width: 200px;">
                üîó Copy Workshop Link
              </button>
            </div>
            <div class="hint" style="margin-top: 15px;">
              <strong>üìã Copy Link:</strong> Generate a personalized workshop link to share via Slack, Teams, or any other channel
            </div>
          </form>
        </div>
      </div>

      <!-- Bulk Invitation Tab -->
      <div id="bulkTab" class="tab-content">
        <div class="form-section">
          <h2>üì® Bulk Send Invitations</h2>
          <p style="margin-bottom: 20px;">Send invitations to multiple students at once.</p>

          <div class="bulk-section">
            <h3>CSV Format</h3>
            <p>Upload a CSV file with the following columns:</p>
            <pre style="background: white; padding: 15px; border-radius: 8px; margin: 10px 0;">email,name
student1@example.com,John Doe
student2@example.com,Jane Smith</pre>
          </div>

          <form id="bulkForm" onsubmit="sendBulkInvitations(event)">
            <div class="form-group">
              <label for="csvFile">CSV File</label>
              <input
                type="file"
                id="csvFile"
                accept=".csv"
                onchange="previewCSV(event)"
              />
              <div class="hint">Upload a CSV file with student emails and names</div>
            </div>

            <div class="form-group">
              <label for="bulkWorkshopDate">Workshop Date & Time</label>
              <input
                type="text"
                id="bulkWorkshopDate"
                placeholder="January 15, 2025 at 2:00 PM EST"
              />
            </div>

            <div class="form-group">
              <label for="bulkNotes">Additional Notes</label>
              <textarea
                id="bulkNotes"
                placeholder="Additional information for all students"
              ></textarea>
            </div>

            <div id="csvPreview" style="display: none; margin: 20px 0;">
              <h3>Preview (first 5 students):</h3>
              <div id="csvPreviewList" class="invitation-list"></div>
            </div>

            <button type="submit" class="button" id="bulkSendButton" disabled>
              Send All Invitations
            </button>
          </form>
        </div>
      </div>

      <!-- History Tab -->
      <div id="historyTab" class="tab-content">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="number" id="totalSent">0</div>
            <div class="label">Total Sent</div>
          </div>
          <div class="stat-card">
            <div class="number" id="totalPending">0</div>
            <div class="label">Pending</div>
          </div>
          <div class="stat-card">
            <div class="number" id="totalFailed">0</div>
            <div class="label">Failed</div>
          </div>
        </div>

        <div class="form-section">
          <h2>üìã Recent Invitations</h2>
          <div id="invitationHistory" class="invitation-list">
            <div class="invitation-item">
              <div class="invitation-info">
                <div class="email" style="color: #999;">No invitations sent yet</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Active Students Tab (formerly Cleanup) -->
      <div id="cleanupTab" class="tab-content">
        <div class="info-box" style="background: #e3f2fd; border-left-color: #1976d2;">
          <h3 style="color: #1976d2;">üë• Student Session Management</h3>
          <p style="color: #1976d2;">
            View student details, progress, and configurations. Switch between view mode (read-only) and manage mode (cleanup/deletion).
          </p>
        </div>

        <div class="form-section">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
            <h2 style="margin: 0;">üóÑÔ∏è Active Students & Sessions</h2>
            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
              <div style="display: flex; gap: 5px; background: #f0f0f0; padding: 5px; border-radius: 8px;">
                <button
                  id="viewModeBtn"
                  class="button secondary"
                  onclick="setStudentViewMode('view')"
                  style="padding: 8px 16px; font-size: 0.9rem; background: #F22F46; color: white;">
                  üëÅÔ∏è View
                </button>
                <button
                  id="manageModeBtn"
                  class="button secondary"
                  onclick="setStudentViewMode('manage')"
                  style="padding: 8px 16px; font-size: 0.9rem;">
                  üóëÔ∏è Manage
                </button>
              </div>
            </div>
          </div>

          <div class="form-group" id="adminPasswordField">
            <label for="cleanupAdminPassword">Admin Password *</label>
            <input
              type="password"
              id="cleanupAdminPassword"
              placeholder="Enter ADMIN_PASSWORD from environment"
              required
            />
            <div class="hint">Password is saved in your browser session</div>
          </div>

          <div style="display: flex; gap: 10px; margin-bottom: 20px;">
            <button class="button" onclick="loadCleanupSessions()" id="loadSessionsBtn" style="flex: 1;">
              üîì Load Sessions
            </button>
            <button class="button" onclick="clearAllStudentData()" style="background: #dc3545; flex: 0 0 auto;">
              üóëÔ∏è Clear All Data
            </button>
          </div>

          <div id="cleanupSessionsContainer" style="display: none;">
            <!-- View Mode Controls (shown only in view mode) -->
            <div id="viewModeControls" style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none;">
              <div style="font-size: 0.95rem; color: #1976d2;">
                üëÅÔ∏è <strong>View Mode:</strong> Click on any student to view their detailed session information and progress. Switch to Manage mode to delete sessions.
              </div>
            </div>

            <!-- Manage Mode Controls (shown only in manage mode) -->
            <div id="manageModeControls" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: block;">
              <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                <div>
                  <label style="display: inline-flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="selectAllSessions" onchange="toggleSelectAll()" />
                    <span style="font-weight: 600;">Select All (<span id="sessionCount">0</span> sessions)</span>
                  </label>
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                  <button class="button secondary" onclick="deleteSelectedKeys()" id="deleteKeysBtn" disabled>
                    üîë Delete API Keys Only
                  </button>
                  <button class="button" onclick="deleteSelectedSessions()" id="deleteSessionsBtn" disabled style="background: #dc3545;">
                    üóëÔ∏è Delete Selected
                  </button>
                </div>
              </div>
              <div style="font-size: 0.85rem; color: #666; margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 6px;">
                ‚ö†Ô∏è <strong>Manage Mode:</strong> Check a student to select all their sessions, or expand and select individual sessions. Use the expand arrow (‚ñ∂) to see session details.
              </div>
            </div>

            <div id="sessionsList" class="invitation-list" style="max-height: 600px; overflow-y: auto;">
              <!-- Populated dynamically -->
            </div>
          </div>

          <div id="cleanupResults" style="display: none; margin-top: 30px;">
            <div class="form-section" style="background: #d4edda; border: 2px solid #c3e6cb;">
              <h3 style="color: #155724; margin-bottom: 15px;">‚úÖ Cleanup Complete</h3>
              <div id="cleanupResultsContent"></div>
            </div>
          </div>
        </div>

        <div class="form-section" style="background: #e3f2fd; border: 2px solid #90caf9;">
          <h3 style="color: #1976d2; margin-bottom: 15px;">üí° Cleanup Options</h3>
          <ul style="color: #1976d2; line-height: 1.8; padding-left: 20px;">
            <li><strong>Delete API Keys Only:</strong> Removes OpenAI keys but preserves all other data (names, prompts, tools, phone numbers)</li>
            <li><strong>Delete Complete Sessions:</strong> Permanently removes all data for selected sessions</li>
            <li><strong>Best Practice:</strong> Delete API keys for security and cost control after workshop ends</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Store invitation history in localStorage
    const STORAGE_KEY = 'workshop_invitations';

    // Switch between tabs
    function switchTab(tabName) {
      // Hide all tab contents
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });

      // Remove active class from all tabs
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });

      // Show selected tab
      document.getElementById(tabName + 'Tab').classList.add('active');

      // Set active tab
      event.target.classList.add('active');

      // Load history if switching to history tab
      if (tabName === 'history') {
        loadInvitationHistory();
      }
    }

    // Show alert message
    function showAlert(type, message) {
      const alertElement = type === 'success' ?
        document.getElementById('alertSuccess') :
        document.getElementById('alertError');

      alertElement.textContent = message;
      alertElement.style.display = 'block';

      // Hide after 5 seconds
      setTimeout(() => {
        alertElement.style.display = 'none';
      }, 5000);
    }

    // Send single invitation
    async function sendInvitation(event) {
      event.preventDefault();

      const button = document.getElementById('sendButton');
      button.disabled = true;
      button.textContent = 'Sending...';

      const studentEmail = document.getElementById('studentEmail').value;
      const studentName = document.getElementById('studentName').value;
      const workshopDate = document.getElementById('workshopDate').value;
      const additionalNotes = document.getElementById('additionalNotes').value;

      try {
        const response = await fetch('/api/send-workshop-invitation', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: new URLSearchParams({
            studentEmail,
            studentName,
            workshopDate,
            additionalNotes
          })
        });

        const data = await response.json();

        if (data.success) {
          showAlert('success', `‚úÖ Invitation sent successfully to ${studentEmail}!`);

          // Save to history
          saveInvitationToHistory({
            email: studentEmail,
            name: studentName,
            date: new Date().toISOString(),
            status: 'sent'
          });

          // Reset form
          document.getElementById('invitationForm').reset();
        } else {
          showAlert('error', `‚ùå Error: ${data.error || 'Failed to send invitation'}`);
        }
      } catch (error) {
        console.error('Error sending invitation:', error);
        showAlert('error', `‚ùå Error: ${error.message}`);
      } finally {
        button.disabled = false;
        button.textContent = 'Send Invitation';
      }
    }

    // Preview CSV file
    function previewCSV(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const text = e.target.result;
        const rows = text.split('\n').filter(row => row.trim());

        // Skip header row
        const students = rows.slice(1).map(row => {
          const [email, name] = row.split(',');
          return { email: email?.trim(), name: name?.trim() };
        }).filter(s => s.email);

        if (students.length > 0) {
          const previewList = document.getElementById('csvPreviewList');
          previewList.innerHTML = students.slice(0, 5).map(student => `
            <div class="invitation-item">
              <div class="invitation-info">
                <div class="name">${student.name || 'No name'}</div>
                <div class="email">${student.email}</div>
              </div>
              <span class="invitation-status pending">Ready to send</span>
            </div>
          `).join('');

          document.getElementById('csvPreview').style.display = 'block';
          document.getElementById('bulkSendButton').disabled = false;

          // Store students data
          window.bulkStudents = students;
        }
      };
      reader.readAsText(file);
    }

    // Send bulk invitations
    async function sendBulkInvitations(event) {
      event.preventDefault();

      if (!window.bulkStudents || window.bulkStudents.length === 0) {
        showAlert('error', '‚ùå No students to send invitations to');
        return;
      }

      const button = document.getElementById('bulkSendButton');
      button.disabled = true;
      button.textContent = 'Sending...';

      const workshopDate = document.getElementById('bulkWorkshopDate').value;
      const additionalNotes = document.getElementById('bulkNotes').value;

      let successCount = 0;
      let failCount = 0;

      for (const student of window.bulkStudents) {
        try {
          const response = await fetch('/api/send-workshop-invitation', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
              studentEmail: student.email,
              studentName: student.name,
              workshopDate,
              additionalNotes
            })
          });

          const data = await response.json();

          if (data.success) {
            successCount++;
            saveInvitationToHistory({
              email: student.email,
              name: student.name,
              date: new Date().toISOString(),
              status: 'sent'
            });
          } else {
            failCount++;
            saveInvitationToHistory({
              email: student.email,
              name: student.name,
              date: new Date().toISOString(),
              status: 'failed'
            });
          }

          // Update button text with progress
          button.textContent = `Sending... (${successCount + failCount}/${window.bulkStudents.length})`;

          // Small delay between sends to avoid rate limiting
          await new Promise(resolve => setTimeout(resolve, 500));

        } catch (error) {
          console.error('Error sending to', student.email, error);
          failCount++;
        }
      }

      button.disabled = false;
      button.textContent = 'Send All Invitations';

      showAlert('success', `‚úÖ Sent ${successCount} invitations successfully${failCount > 0 ? `, ${failCount} failed` : ''}!`);

      // Reset form
      document.getElementById('bulkForm').reset();
      document.getElementById('csvPreview').style.display = 'none';
      window.bulkStudents = [];
    }

    // Save invitation to history
    function saveInvitationToHistory(invitation) {
      const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      history.unshift(invitation);

      // Keep only last 100 invitations
      if (history.length > 100) {
        history.pop();
      }

      localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
    }

    // Load invitation history
    function loadInvitationHistory() {
      const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');

      if (history.length === 0) {
        return;
      }

      // Update stats
      const sent = history.filter(h => h.status === 'sent').length;
      const pending = history.filter(h => h.status === 'pending').length;
      const failed = history.filter(h => h.status === 'failed').length;

      document.getElementById('totalSent').textContent = sent;
      document.getElementById('totalPending').textContent = pending;
      document.getElementById('totalFailed').textContent = failed;

      // Display history
      const historyList = document.getElementById('invitationHistory');
      historyList.innerHTML = history.map(invitation => {
        const date = new Date(invitation.date);
        return `
          <div class="invitation-item">
            <div class="invitation-info">
              <div class="name">${invitation.name || 'No name provided'}</div>
              <div class="email">${invitation.email} - ${date.toLocaleDateString()} ${date.toLocaleTimeString()}</div>
            </div>
            <span class="invitation-status ${invitation.status}">${invitation.status}</span>
          </div>
        `;
      }).join('');
    }

    // Load history on page load
    loadInvitationHistory();

    // =============================================
    // STUDENT PROGRESS TRACKING
    // =============================================

    let studentProgressData = [];

    // Load student progress data
    async function loadStudentProgress() {
      try {
        const response = await fetch('/api/track-student-progress?getAllStudents=true');
        const data = await response.json();

        if (data.success) {
          studentProgressData = data.students || [];
          renderProgressDashboard();
        } else {
          console.error('Error loading student progress:', data.error);
        }
      } catch (error) {
        console.error('Error fetching student progress:', error);
      }
    }

    // Render progress dashboard
    function renderProgressDashboard() {
      // Calculate stats
      const total = studentProgressData.length;
      const avgCompletion = total > 0 ?
        Math.round(studentProgressData.reduce((sum, s) => sum + (s.completionRate || 0), 0) / total) : 0;

      const now = Date.now();
      const oneDayAgo = now - (24 * 60 * 60 * 1000);
      const activeStudents = studentProgressData.filter(s =>
        s.lastActivity && new Date(s.lastActivity).getTime() > oneDayAgo
      ).length;

      const completedStudents = studentProgressData.filter(s => s.completionRate === 100).length;

      // Update stats cards
      document.getElementById('totalStudents').textContent = total;
      document.getElementById('avgCompletion').textContent = `${avgCompletion}%`;
      document.getElementById('activeStudents').textContent = activeStudents;
      document.getElementById('completedStudents').textContent = completedStudents;

      // Render student list
      const listContainer = document.getElementById('studentProgressList');

      if (total === 0) {
        listContainer.innerHTML = `
          <div class="invitation-item">
            <div class="invitation-info">
              <div class="email" style="color: #999;">No student progress data yet. Students need to start the workshop.</div>
            </div>
          </div>
        `;
        return;
      }

      // Sort by last activity (most recent first)
      const sortedStudents = [...studentProgressData].sort((a, b) => {
        const aTime = a.lastActivity ? new Date(a.lastActivity).getTime() : 0;
        const bTime = b.lastActivity ? new Date(b.lastActivity).getTime() : 0;
        return bTime - aTime;
      });

      listContainer.innerHTML = sortedStudents.map(student => {
        const completionRate = student.completionRate || 0;
        const lastActivity = student.lastActivity ? new Date(student.lastActivity) : null;
        const timeAgo = lastActivity ? getTimeAgo(lastActivity) : 'Never';

        const completed = Object.values(student.exercises || {}).filter(ex => ex.completed).length;
        const totalTimeSpent = Math.round((student.totalTimeSpent || 0) / 60); // Convert to minutes

        let statusColor = '#dc3545'; // Red for low progress
        if (completionRate >= 75) statusColor = '#28a745'; // Green for high progress
        else if (completionRate >= 40) statusColor = '#ffc107'; // Yellow for medium progress

        return `
          <div class="invitation-item" style="flex-direction: column; align-items: stretch; padding: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
              <div class="invitation-info">
                <div class="name" style="font-size: 1.1rem;">${student.studentName || student.studentId}</div>
                <div class="email">${student.studentId}</div>
              </div>
              <div style="text-align: right;">
                <div style="font-size: 1.5rem; font-weight: bold; color: ${statusColor};">${completionRate}%</div>
                <div style="font-size: 0.8rem; color: #666;">Completion</div>
              </div>
            </div>

            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 10px;">
                <div>
                  <div style="font-size: 0.8rem; color: #666;">Exercises Done</div>
                  <div style="font-weight: 600;">${completed} / 9</div>
                </div>
                <div>
                  <div style="font-size: 0.8rem; color: #666;">Time Spent</div>
                  <div style="font-weight: 600;">${totalTimeSpent} min</div>
                </div>
                <div>
                  <div style="font-size: 0.8rem; color: #666;">Last Active</div>
                  <div style="font-weight: 600;">${timeAgo}</div>
                </div>
                <div>
                  <div style="font-size: 0.8rem; color: #666;">Mode</div>
                  <div style="font-weight: 600;">${student.demoMode ? 'üé≠ Demo' : '‚úÖ Live'}</div>
                </div>
              </div>

              <div style="margin-top: 10px;">
                <div style="font-size: 0.8rem; color: #666; margin-bottom: 5px;">Progress:</div>
                <div style="background: #e0e0e0; height: 8px; border-radius: 4px; overflow: hidden;">
                  <div style="background: ${statusColor}; height: 100%; width: ${completionRate}%; transition: width 0.3s;"></div>
                </div>
              </div>
            </div>

            <button onclick="viewStudentDetail('${student.studentId}')" class="button secondary" style="margin-top: 15px; padding: 8px 16px; font-size: 0.9rem;">
              View Detailed Progress ‚Üí
            </button>
          </div>
        `;
      }).join('');

      // Render exercise stats
      renderExerciseStats();
    }

    // Render exercise completion statistics
    function renderExerciseStats() {
      const exerciseNames = [
        'Step 1: Connect Accounts',
        'Step 2: Choose Use Case',
        'Step 3: Provision Services',
        'Step 4: Basic TwiML',
        'Step 5: WebSocket Handler',
        'Step 6: ConversationRelay',
        'Step 7: AI Tools',
        'Step 8: Test Call',
        'Step 9: Multichannel'
      ];

      const exerciseStats = exerciseNames.map((name, index) => {
        const exerciseId = `step-${index + 1}-${name.split(': ')[1].toLowerCase().replace(/\s+/g, '-')}`;
        const completedCount = studentProgressData.filter(student =>
          student.exercises && student.exercises[exerciseId] && student.exercises[exerciseId].completed
        ).length;

        const total = studentProgressData.length;
        const percentage = total > 0 ? Math.round((completedCount / total) * 100) : 0;

        return { name, completedCount, total, percentage };
      });

      const statsContainer = document.getElementById('exerciseStats');
      statsContainer.innerHTML = exerciseStats.map(stat => `
        <div style="margin-bottom: 20px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <span style="font-weight: 600;">${stat.name}</span>
            <span style="color: #666;">${stat.completedCount} / ${stat.total} students (${stat.percentage}%)</span>
          </div>
          <div style="background: #e0e0e0; height: 8px; border-radius: 4px; overflow: hidden;">
            <div style="background: linear-gradient(135deg, #F22F46 0%, #ff6b6b 100%); height: 100%; width: ${stat.percentage}%; transition: width 0.3s;"></div>
          </div>
        </div>
      `).join('');
    }

    // View detailed student progress
    function viewStudentDetail(studentId) {
      const student = studentProgressData.find(s => s.studentId === studentId);
      if (!student) return;

      const exercises = student.exercises || {};
      const exerciseNames = [
        'Step 1: Connect Accounts',
        'Step 2: Choose Use Case',
        'Step 3: Provision Services',
        'Step 4: Basic TwiML',
        'Step 5: WebSocket Handler',
        'Step 6: ConversationRelay',
        'Step 7: AI Tools',
        'Step 8: Test Call',
        'Step 9: Multichannel'
      ];

      const detailHTML = `
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 800px; margin: 0 auto;">
          <h2 style="margin-bottom: 20px;">${student.studentName || student.studentId}</h2>
          <div style="color: #666; margin-bottom: 30px;">${student.studentId}</div>

          <h3 style="margin-bottom: 15px;">Exercise Progress:</h3>
          ${exerciseNames.map((name, index) => {
            const exerciseId = `step-${index + 1}-${name.split(': ')[1].toLowerCase().replace(/\s+/g, '-')}`;
            const ex = exercises[exerciseId] || {};
            const completed = ex.completed || false;
            const timeSpent = Math.round((ex.timeSpent || 0) / 60);
            const attempts = ex.attempts || 0;

            return `
              <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <span style="font-weight: 600;">${name}</span>
                    ${completed ? '<span style="color: #28a745; margin-left: 10px;">‚úì Completed</span>' : '<span style="color: #666; margin-left: 10px;">In Progress</span>'}
                  </div>
                  <div style="text-align: right; font-size: 0.9rem; color: #666;">
                    ${timeSpent > 0 ? `${timeSpent} min` : ''}
                    ${attempts > 0 ? ` ‚Ä¢ ${attempts} attempts` : ''}
                  </div>
                </div>
              </div>
            `;
          }).join('')}

          <button onclick="closeStudentDetail()" class="button" style="margin-top: 20px;">Close</button>
        </div>
      `;

      // Create modal overlay
      const overlay = document.createElement('div');
      overlay.id = 'studentDetailOverlay';
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        overflow-y: auto;
      `;
      overlay.innerHTML = detailHTML;
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) closeStudentDetail();
      });
      document.body.appendChild(overlay);
    }

    // Close student detail modal
    function closeStudentDetail() {
      const overlay = document.getElementById('studentDetailOverlay');
      if (overlay) overlay.remove();
    }

    // Refresh progress data
    async function refreshProgressData() {
      showAlert('info', 'Refreshing student progress data...');
      await loadStudentProgress();
      showAlert('success', 'Student progress data updated!');
    }

    // Get time ago string
    function getTimeAgo(date) {
      const seconds = Math.floor((new Date() - date) / 1000);

      const intervals = {
        year: 31536000,
        month: 2592000,
        week: 604800,
        day: 86400,
        hour: 3600,
        minute: 60
      };

      for (const [unit, secondsInUnit] of Object.entries(intervals)) {
        const interval = Math.floor(seconds / secondsInUnit);
        if (interval >= 1) {
          return interval === 1 ? `1 ${unit} ago` : `${interval} ${unit}s ago`;
        }
      }

      return 'Just now';
    }

    // Update switchTab function to load progress when switching to that tab
    const originalSwitchTab = switchTab;
    switchTab = function(tabName) {
      originalSwitchTab.call(this, tabName);

      if (tabName === 'progress') {
        loadStudentProgress();
      }
    };

    // Load progress on page load
    loadStudentProgress();

    // =============================================
    // ACTIVE STUDENTS TAB - Session Management
    // =============================================

    let cleanupStudents = [];
    let cleanupSessions = [];
    let selectedSessionTokens = new Set();
    let selectedStudentEmails = new Set();
    let studentViewMode = 'view'; // 'view' or 'manage'

    // Admin login management
    function handleAdminLogin() {
      const cachedPassword = sessionStorage.getItem('adminPassword');

      if (cachedPassword) {
        // Already logged in - show option to logout
        const shouldLogout = confirm('You are currently logged in as admin.\n\nClick OK to logout and clear your session.');
        if (shouldLogout) {
          sessionStorage.removeItem('adminPassword');
          document.getElementById('cleanupAdminPassword').value = '';
          updateAdminLoginButton();
          showAlert('success', '‚úÖ Admin session cleared');
        }
      } else {
        // Prompt for password
        const password = prompt('Enter admin password:');
        if (password) {
          // Save to session storage
          sessionStorage.setItem('adminPassword', password);
          document.getElementById('cleanupAdminPassword').value = password;
          updateAdminLoginButton();
          showAlert('success', '‚úÖ Admin password saved for this browser session');
        }
      }
    }

    function updateAdminLoginButton() {
      const btn = document.getElementById('adminLoginBtn');
      const passwordField = document.getElementById('adminPasswordField');
      const cachedPassword = sessionStorage.getItem('adminPassword');

      if (cachedPassword) {
        btn.textContent = '‚úÖ Logged In';
        btn.classList.add('logged-in');
        btn.title = 'Click to logout';
        // Hide password field when logged in
        if (passwordField) passwordField.style.display = 'none';
      } else {
        btn.textContent = 'üîì Admin Login';
        btn.classList.remove('logged-in');
        btn.title = 'Click to enter admin password';
        // Show password field when logged out
        if (passwordField) passwordField.style.display = 'block';
      }
    }

    // Load cached admin password on page load
    window.addEventListener('DOMContentLoaded', () => {
      const cachedPassword = sessionStorage.getItem('adminPassword');
      if (cachedPassword) {
        document.getElementById('cleanupAdminPassword').value = cachedPassword;
      }
      updateAdminLoginButton();
    });

    // Toggle between view and manage modes
    function setStudentViewMode(mode) {
      studentViewMode = mode;

      // Update button styles
      const viewBtn = document.getElementById('viewModeBtn');
      const manageBtn = document.getElementById('manageModeBtn');

      if (mode === 'view') {
        viewBtn.style.background = '#F22F46';
        viewBtn.style.color = 'white';
        manageBtn.style.background = '#6c757d';
        manageBtn.style.color = 'white';

        // Show view controls, hide manage controls
        document.getElementById('viewModeControls').style.display = 'block';
        document.getElementById('manageModeControls').style.display = 'none';
      } else {
        viewBtn.style.background = '#6c757d';
        viewBtn.style.color = 'white';
        manageBtn.style.background = '#F22F46';
        manageBtn.style.color = 'white';

        // Show manage controls, hide view controls
        document.getElementById('viewModeControls').style.display = 'none';
        document.getElementById('manageModeControls').style.display = 'block';
      }

      // Re-render sessions with appropriate UI
      renderCleanupSessions();
    }

    async function loadCleanupSessions() {
      const button = document.getElementById('loadSessionsBtn');
      const originalText = button.textContent;

      // Update button to show loading state
      button.disabled = true;
      button.textContent = 'üîÑ Loading...';

      const password = document.getElementById('cleanupAdminPassword').value;

      if (!password) {
        showAlert('error', '‚ùå Please enter the admin password');
        button.disabled = false;
        button.textContent = originalText;
        return;
      }

      // Cache password in session storage
      sessionStorage.setItem('adminPassword', password);

      try {
        const response = await fetch('/api/admin-list-configs', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            adminPassword: password
          })
        });

        const data = await response.json();

        if (!data.success) {
          showAlert('error', `‚ùå ${data.error || 'Failed to load sessions'}`);
          return;
        }

        cleanupStudents = data.students || [];
        cleanupSessions = data.sessions || [];
        selectedSessionTokens.clear();
        selectedStudentEmails.clear();

        // Auto-expand all students on first load
        expandedStudents.clear();
        cleanupStudents.forEach(student => expandedStudents.add(student.studentEmail));

        // Show sessions container
        document.getElementById('cleanupSessionsContainer').style.display = 'block';
        document.getElementById('sessionCount').textContent = cleanupSessions.length;

        // Render sessions
        renderCleanupSessions();

        const studentCount = cleanupStudents.length;
        showAlert('success', `‚úÖ Loaded ${studentCount} student${studentCount !== 1 ? 's' : ''} with ${cleanupSessions.length} session${cleanupSessions.length !== 1 ? 's' : ''}`);

        // Change button to refresh
        button.textContent = 'üîÑ Refresh';

      } catch (error) {
        console.error('Load sessions error:', error);
        showAlert('error', `‚ùå Error: ${error.message}`);
      } finally {
        button.disabled = false;
      }
    }

    // Track expanded students
    let expandedStudents = new Set();

    function renderCleanupSessions() {
      const listContainer = document.getElementById('sessionsList');

      if (cleanupStudents.length === 0 && cleanupSessions.length === 0) {
        listContainer.innerHTML = `
          <div class="invitation-item">
            <div class="invitation-info">
              <div class="email" style="color: #999;">No students or sessions found in database</div>
            </div>
          </div>
        `;
        return;
      }

      // Group sessions by student email
      const studentGroups = {};

      // Initialize all students (including orphans with no sessions)
      cleanupStudents.forEach(student => {
        studentGroups[student.studentEmail] = [];
      });

      // Add sessions to their student groups
      cleanupSessions.forEach(session => {
        const email = session.studentEmail || 'unknown@example.com';
        if (!studentGroups[email]) {
          studentGroups[email] = [];
        }
        studentGroups[email].push(session);
      });

      // Render hierarchical view
      listContainer.innerHTML = Object.entries(studentGroups).map(([email, sessions]) => {
        const isExpanded = expandedStudents.has(email);
        const student = cleanupStudents.find(s => s.studentEmail === email);
        const studentName = student?.studentName || (sessions[0]?.studentName) || 'Unnamed Student';
        const totalSessions = sessions.length;

        // For orphaned students with no sessions
        const isOrphan = totalSessions === 0;
        const studentSessionTokens = sessions.map(s => s.sessionToken);
        const allSelected = isOrphan ? selectedStudentEmails.has(email) : studentSessionTokens.every(token => selectedSessionTokens.has(token));
        const someSelected = !isOrphan && studentSessionTokens.some(token => selectedSessionTokens.has(token)) && !allSelected;

        return `
          <!-- Student Row -->
          <div class="invitation-item" style="flex-direction: column; align-items: stretch; padding: 15px 20px; background: ${allSelected && studentViewMode === 'manage' ? '#fff3cd' : (someSelected && studentViewMode === 'manage' ? '#fffbf0' : 'white')}; border-bottom: 2px solid #dee2e6; ${studentViewMode === 'view' ? 'cursor: pointer;' : ''}" ${studentViewMode === 'view' ? `onclick="viewStudentSessionDetails('${email}')"` : ''}>
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div style="display: flex; align-items: center; gap: 15px; flex: 1;">
                ${studentViewMode === 'manage' ? `
                  <input
                    type="checkbox"
                    ${allSelected ? 'checked' : ''}
                    ${someSelected ? 'indeterminate' : ''}
                    onchange="toggleStudentSelect('${email}'); event.stopPropagation();"
                    style="cursor: pointer; width: 20px; height: 20px;"
                    ${someSelected ? 'ref="indeterminate"' : ''}
                  />
                ` : ''}
                <button
                  onclick="toggleStudentExpand('${email}'); event.stopPropagation();"
                  style="background: none; border: none; cursor: pointer; font-size: 1.2rem; padding: 5px; color: ${isOrphan ? '#ccc' : '#666'}; ${isOrphan ? 'cursor: default;' : ''}"
                  title="${isOrphan ? 'No sessions' : (isExpanded ? 'Collapse' : 'Expand') + ' sessions'}"
                  ${isOrphan ? 'disabled' : ''}
                >
                  ${isOrphan ? '‚óã' : (isExpanded ? '‚ñº' : '‚ñ∂')}
                </button>
                <div class="invitation-info" style="flex: 1;">
                  <div class="name" style="font-size: 1.2rem; font-weight: 700; color: ${isOrphan ? '#999' : '#0d122b'};">
                    üë§ ${studentName}${isOrphan ? ' <span style="color: #dc3545; font-size: 0.9rem; font-weight: 500;">(No Sessions)</span>' : ''}
                  </div>
                  <div class="email" style="margin-top: 5px; color: #666;">
                    üìß ${email}
                  </div>
                </div>
                ${studentViewMode === 'view' ? `
                  <button onclick="viewStudentSessionDetails('${email}'); event.stopPropagation();" class="button secondary" style="padding: 8px 16px; font-size: 0.85rem; margin-left: auto;">
                    üëÅÔ∏è View Details
                  </button>
                ` : ''}
              </div>
              <div style="text-align: right;">
                <div style="font-size: 1.5rem; font-weight: bold; color: ${isOrphan ? '#dc3545' : '#F22F46'};">${totalSessions}</div>
                <div style="font-size: 0.85rem; color: #666;">${totalSessions === 1 ? 'session' : 'sessions'}</div>
              </div>
            </div>
          </div>

          <!-- Sessions List (expandable) -->
          <div id="student-sessions-${email.replace(/[^a-zA-Z0-9]/g, '_')}" style="display: ${isExpanded ? 'block' : 'none'};">
            ${sessions.map(session => {
              const isSelected = selectedSessionTokens.has(session.sessionToken);
              const createdDate = new Date(session.createdAt).toLocaleString();
              const updatedDate = new Date(session.updatedAt).toLocaleString();

              return `
                <div class="invitation-item" style="flex-direction: column; align-items: stretch; padding: 15px 20px 15px 80px; background: ${isSelected && studentViewMode === 'manage' ? '#fff3cd' : '#f8f9fa'}; border-left: 4px solid ${isSelected && studentViewMode === 'manage' ? '#ffc107' : '#e0e0e0'};">
                  <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div style="display: flex; align-items: flex-start; gap: 15px; flex: 1;">
                      ${studentViewMode === 'manage' ? `
                        <input
                          type="checkbox"
                          ${isSelected ? 'checked' : ''}
                          onchange="toggleSessionSelect('${session.sessionToken}')"
                          style="margin-top: 5px; cursor: pointer; width: 18px; height: 18px;"
                        />
                      ` : ''}
                      <div class="invitation-info" style="flex: 1;">
                        <div class="name" style="font-size: 1rem; font-weight: 600;">üìã Session</div>
                        <div class="email" style="margin-top: 5px; font-size: 0.85rem; color: #666; font-family: monospace;">
                          ${session.sessionToken.substring(0, 50)}...
                        </div>
                        <div style="margin-top: 10px; font-size: 0.9rem; color: #666;">
                          <div>üìû Phone: ${session.phoneNumber || 'Not set'}</div>
                          <div>üéôÔ∏è Voice: ${session.voice || 'Not set'} (${session.ttsProvider || 'N/A'})</div>
                          <div style="margin-top: 5px;">
                            ${session.hasApiKey ? '<span style="background: #fff3cd; padding: 3px 8px; border-radius: 4px; font-size: 0.85rem;">üîë Has API Key</span>' : '<span style="color: #999;">No API Key</span>'}
                            ${session.hasSystemPrompt ? '<span style="background: #e3f2fd; padding: 3px 8px; border-radius: 4px; margin-left: 5px; font-size: 0.85rem;">üìù Has Prompt</span>' : ''}
                            ${session.hasTools ? '<span style="background: #e8f5e9; padding: 3px 8px; border-radius: 4px; margin-left: 5px; font-size: 0.85rem;">üîß Has Tools</span>' : ''}
                          </div>
                        </div>
                      </div>
                    </div>
                    <div style="text-align: right; font-size: 0.85rem; color: #666;">
                      <div>Created: ${createdDate}</div>
                      <div style="margin-top: 3px;">Updated: ${updatedDate}</div>
                    </div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `;
      }).join('');

      // Set indeterminate state for checkboxes
      document.querySelectorAll('input[ref="indeterminate"]').forEach(checkbox => {
        checkbox.indeterminate = true;
      });

      updateButtonStates();
    }

    function toggleStudentExpand(email) {
      if (expandedStudents.has(email)) {
        expandedStudents.delete(email);
      } else {
        expandedStudents.add(email);
      }
      renderCleanupSessions();
    }

    function toggleStudentSelect(email) {
      // Get all sessions for this student
      const studentSessions = cleanupSessions.filter(s => (s.studentEmail || 'unknown@example.com') === email);
      const studentSessionTokens = studentSessions.map(s => s.sessionToken);

      // Check if this is an orphaned student (no sessions)
      if (studentSessionTokens.length === 0) {
        // Toggle the student record itself
        if (selectedStudentEmails.has(email)) {
          selectedStudentEmails.delete(email);
        } else {
          selectedStudentEmails.add(email);
        }
      } else {
        // Check if all sessions are selected
        const allSelected = studentSessionTokens.every(token => selectedSessionTokens.has(token));

        if (allSelected) {
          // Deselect all sessions
          studentSessionTokens.forEach(token => selectedSessionTokens.delete(token));
        } else {
          // Select all sessions
          studentSessionTokens.forEach(token => selectedSessionTokens.add(token));
        }
      }

      renderCleanupSessions();
    }

    function toggleSessionSelect(sessionToken) {
      if (selectedSessionTokens.has(sessionToken)) {
        selectedSessionTokens.delete(sessionToken);
      } else {
        selectedSessionTokens.add(sessionToken);
      }

      renderCleanupSessions();
    }

    function toggleSelectAll() {
      const selectAll = document.getElementById('selectAllSessions').checked;

      if (selectAll) {
        cleanupSessions.forEach(session => {
          selectedSessionTokens.add(session.sessionToken);
        });
      } else {
        selectedSessionTokens.clear();
      }

      renderCleanupSessions();
    }

    function updateButtonStates() {
      const hasSelection = selectedSessionTokens.size > 0;
      document.getElementById('deleteKeysBtn').disabled = !hasSelection;
      document.getElementById('deleteSessionsBtn').disabled = !hasSelection;
      document.getElementById('selectAllSessions').checked = selectedSessionTokens.size === cleanupSessions.length && cleanupSessions.length > 0;
    }

    async function deleteSelectedKeys() {
      if (selectedSessionTokens.size === 0) {
        showAlert('error', '‚ùå No sessions selected');
        return;
      }

      const confirmDelete = confirm(
        `‚ö†Ô∏è Delete API keys from ${selectedSessionTokens.size} selected session(s)?\n\n` +
        'This will remove only the OpenAI API keys.\n' +
        'All other data will be preserved.\n\n' +
        'This action cannot be undone.'
      );

      if (!confirmDelete) return;

      const password = document.getElementById('cleanupAdminPassword').value;

      try {
        const response = await fetch('/api/admin-delete-sessions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            adminPassword: password,
            sessionTokens: Array.from(selectedSessionTokens),
            deleteType: 'keys-only'
          })
        });

        const data = await response.json();

        if (!data.success) {
          showAlert('error', `‚ùå ${data.error || 'Failed to delete keys'}`);
          return;
        }

        showAlert('success', `‚úÖ ${data.message}`);

        // Reload sessions
        await loadCleanupSessions();

      } catch (error) {
        console.error('Delete keys error:', error);
        showAlert('error', `‚ùå Error: ${error.message}`);
      }
    }

    async function deleteSelectedSessions() {
      if (selectedSessionTokens.size === 0) {
        showAlert('error', '‚ùå No sessions selected');
        return;
      }

      const confirmDelete = confirm(
        `‚ö†Ô∏è PERMANENTLY DELETE ${selectedSessionTokens.size} complete session(s)?\n\n` +
        'This will remove ALL data for these sessions:\n' +
        '‚Ä¢ Student names\n' +
        '‚Ä¢ API keys\n' +
        '‚Ä¢ System prompts\n' +
        '‚Ä¢ Tool configurations\n' +
        '‚Ä¢ Phone numbers\n' +
        '‚Ä¢ All other settings\n\n' +
        'This action cannot be undone. Are you sure?'
      );

      if (!confirmDelete) return;

      const password = document.getElementById('cleanupAdminPassword').value;

      try {
        const response = await fetch('/api/admin-delete-sessions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            adminPassword: password,
            sessionTokens: Array.from(selectedSessionTokens),
            deleteType: 'full'
          })
        });

        const data = await response.json();

        if (!data.success) {
          showAlert('error', `‚ùå ${data.error || 'Failed to delete sessions'}`);
          return;
        }

        showAlert('success', `‚úÖ ${data.message}`);

        // Reload sessions
        await loadCleanupSessions();

      } catch (error) {
        console.error('Delete sessions error:', error);
        showAlert('error', `‚ùå Error: ${error.message}`);
      }
    }

    // View detailed session information for a student
    function viewStudentSessionDetails(email) {
      const student = cleanupStudents.find(s => s.studentEmail === email);
      const studentSessions = cleanupSessions.filter(s => s.studentEmail === email);
      const studentName = student?.studentName || 'Unknown Student';

      if (studentSessions.length === 0) {
        showAlert('info', `‚ÑπÔ∏è ${studentName} has no active sessions`);
        return;
      }

      const detailHTML = `
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 900px; margin: 0 auto; max-height: 90vh; overflow-y: auto;">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 30px;">
            <div>
              <h2 style="margin-bottom: 10px; color: #0d122b;">üë§ ${studentName}</h2>
              <div style="color: #666; font-size: 1rem;">üìß ${email}</div>
              <div style="margin-top: 10px; padding: 10px 15px; background: #e3f2fd; border-radius: 8px; display: inline-block;">
                <strong>${studentSessions.length}</strong> active session${studentSessions.length !== 1 ? 's' : ''}
              </div>
            </div>
            <button onclick="closeStudentSessionDetails()" class="button secondary" style="padding: 8px 16px;">‚úï Close</button>
          </div>

          <h3 style="margin-bottom: 20px; color: #0d122b;">üìã Session Details</h3>

          ${studentSessions.map((session, index) => {
            const createdDate = new Date(session.createdAt).toLocaleString();
            const updatedDate = new Date(session.updatedAt).toLocaleString();

            return `
              <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #e0e0e0;">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                  <h4 style="color: #0d122b; margin: 0;">Session ${index + 1}</h4>
                  <div style="text-align: right; font-size: 0.85rem; color: #666;">
                    <div>Created: ${createdDate}</div>
                    <div style="margin-top: 3px;">Updated: ${updatedDate}</div>
                  </div>
                </div>

                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                  <div style="font-size: 0.85rem; color: #666; font-family: monospace; word-break: break-all;">
                    üîë Session Token: ${session.sessionToken}
                  </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                  <div style="background: white; padding: 15px; border-radius: 8px;">
                    <div style="font-size: 0.85rem; color: #666; margin-bottom: 5px;">üìû Phone Number</div>
                    <div style="font-weight: 600;">${session.phoneNumber || 'Not set'}</div>
                  </div>

                  <div style="background: white; padding: 15px; border-radius: 8px;">
                    <div style="font-size: 0.85rem; color: #666; margin-bottom: 5px;">üéôÔ∏è Voice</div>
                    <div style="font-weight: 600;">${session.voice || 'Not set'}</div>
                  </div>

                  <div style="background: white; padding: 15px; border-radius: 8px;">
                    <div style="font-size: 0.85rem; color: #666; margin-bottom: 5px;">üîä TTS Provider</div>
                    <div style="font-weight: 600;">${session.ttsProvider || 'Not set'}</div>
                  </div>
                </div>

                <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                  ${session.hasApiKey ?
                    '<span style="background: #fff3cd; padding: 8px 12px; border-radius: 6px; font-size: 0.9rem; border: 2px solid #ffc107;">üîë API Key Configured</span>' :
                    '<span style="background: #f8d7da; padding: 8px 12px; border-radius: 6px; font-size: 0.9rem; border: 2px solid #f5c6cb; color: #721c24;">‚ùå No API Key</span>'}
                  ${session.hasSystemPrompt ?
                    '<span style="background: #e3f2fd; padding: 8px 12px; border-radius: 6px; font-size: 0.9rem; border: 2px solid #90caf9;">üìù Custom Prompt</span>' :
                    '<span style="color: #999; padding: 8px 12px;">No Custom Prompt</span>'}
                  ${session.hasTools ?
                    '<span style="background: #e8f5e9; padding: 8px 12px; border-radius: 6px; font-size: 0.9rem; border: 2px solid #a5d6a7;">üîß Tools Configured</span>' :
                    '<span style="color: #999; padding: 8px 12px;">No Tools</span>'}
                </div>
              </div>
            `;
          }).join('')}

          <div style="margin-top: 30px; text-align: center;">
            <button onclick="closeStudentSessionDetails()" class="button" style="padding: 12px 30px;">Close</button>
          </div>
        </div>
      `;

      // Create modal overlay
      const overlay = document.createElement('div');
      overlay.id = 'studentSessionDetailsOverlay';
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        overflow-y: auto;
      `;
      overlay.innerHTML = detailHTML;
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) closeStudentSessionDetails();
      });
      document.body.appendChild(overlay);
    }

    // Close student session details modal
    function closeStudentSessionDetails() {
      const overlay = document.getElementById('studentSessionDetailsOverlay');
      if (overlay) overlay.remove();
    }

    // =============================================
    // GENERATE AND COPY WORKSHOP LINK
    // =============================================

    function generateAndCopyLink() {
      const studentEmail = document.getElementById('studentEmail').value;
      const studentName = document.getElementById('studentName').value;

      if (!studentEmail) {
        showAlert('error', '‚ùå Please enter a student email address');
        return;
      }

      // Get the current window location (works for any deployment URL)
      const workshopUrl = window.location.origin;

      // Build URL with query parameters
      let link = `${workshopUrl}/?email=${encodeURIComponent(studentEmail)}`;
      if (studentName) {
        link += `&name=${encodeURIComponent(studentName)}`;
      }

      // Copy to clipboard
      navigator.clipboard.writeText(link).then(() => {
        showAlert('success', `‚úÖ Workshop link copied to clipboard!${studentName ? ` (for ${studentName})` : ''}`);
      }).catch(err => {
        // Fallback for browsers that don't support clipboard API
        const textarea = document.createElement('textarea');
        textarea.value = link;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        showAlert('success', `‚úÖ Workshop link copied to clipboard!${studentName ? ` (for ${studentName})` : ''}`);
      });
    }

    // =============================================
    // CLEAR ALL STUDENT DATA
    // =============================================

    async function clearAllStudentData() {
      const password = document.getElementById('cleanupAdminPassword').value;

      if (!password) {
        showAlert('error', '‚ùå Please enter the admin password first');
        return;
      }

      const confirmClear = confirm(
        '‚ö†Ô∏è CLEAR ALL STUDENT AND SESSION DATA?\n\n' +
        'This will PERMANENTLY DELETE:\n' +
        '‚Ä¢ ALL students from all tables\n' +
        '‚Ä¢ ALL sessions from all tables\n' +
        '‚Ä¢ ALL workshop progress data\n' +
        '‚Ä¢ ALL configurations\n\n' +
        'This action CANNOT be undone.\n\n' +
        'Are you absolutely sure?'
      );

      if (!confirmClear) return;

      // Second confirmation
      const confirmText = prompt(
        '‚ö†Ô∏è FINAL CONFIRMATION\n\n' +
        'To confirm you want to delete ALL student data, type: DELETE ALL'
      );

      if (confirmText !== 'DELETE ALL') {
        showAlert('error', '‚ùå Confirmation text did not match. Clear cancelled.');
        return;
      }

      try {
        showAlert('info', 'üîÑ Clearing all data...');

        const response = await fetch('/api/admin-clear-all-data', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            adminPassword: password
          })
        });

        const data = await response.json();

        if (!data.success) {
          showAlert('error', `‚ùå ${data.error || 'Failed to clear data'}`);
          return;
        }

        showAlert('success', `‚úÖ ${data.message}\n\nResults:\n${data.results.join('\n')}`);

        // Reload sessions list to show empty state
        setTimeout(() => {
          loadCleanupSessions();
        }, 1000);

      } catch (error) {
        console.error('Clear all data error:', error);
        showAlert('error', `‚ùå Error: ${error.message}`);
      }
    }

    // =============================================
    // DELETE ALL SESSIONS FOR STUDENT
    // =============================================

    async function deleteAllStudentSessions() {
      const studentEmail = document.getElementById('deleteStudentEmail').value;

      if (!studentEmail) {
        showAlert('error', '‚ùå Please enter a student email address');
        return;
      }

      // Validate email format
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(studentEmail)) {
        showAlert('error', '‚ùå Please enter a valid email address');
        return;
      }

      const confirmDelete = confirm(
        `‚ö†Ô∏è DELETE ALL SESSIONS for ${studentEmail}?\n\n` +
        'This will PERMANENTLY DELETE:\n' +
        '‚Ä¢ ALL workshop sessions for this student\n' +
        '‚Ä¢ Student names and configurations\n' +
        '‚Ä¢ API keys and system prompts\n' +
        '‚Ä¢ Tool configurations\n' +
        '‚Ä¢ Phone numbers and all settings\n\n' +
        'This includes sessions from ALL workshop runs.\n' +
        'This action CANNOT be undone.\n\n' +
        'Type the student email to confirm.'
      );

      if (!confirmDelete) return;

      // Second confirmation - ask them to type the email
      const confirmEmail = prompt(
        `‚ö†Ô∏è FINAL CONFIRMATION\n\nTo delete ALL sessions for ${studentEmail}, please type the email address exactly:`
      );

      if (confirmEmail !== studentEmail) {
        showAlert('error', '‚ùå Email did not match. Deletion cancelled.');
        return;
      }

      const password = document.getElementById('cleanupAdminPassword').value;

      if (!password) {
        showAlert('error', '‚ùå Please enter the admin password first');
        return;
      }

      try {
        const response = await fetch('/api/admin-delete-student', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            adminPassword: password,
            deleteType: 'student',
            studentEmail: studentEmail
          })
        });

        const data = await response.json();

        if (!data.success) {
          showAlert('error', `‚ùå ${data.error || 'Failed to delete student sessions'}`);
          return;
        }

        showAlert('success', `‚úÖ ${data.message}`);

        // Clear the input
        document.getElementById('deleteStudentEmail').value = '';

        // Reload sessions list
        await loadCleanupSessions();

      } catch (error) {
        console.error('Delete student sessions error:', error);
        showAlert('error', `‚ùå Error: ${error.message}`);
      }
    }
  </script>
</body>
</html>
// force redeploy Wed Oct 22 11:42:26 EDT 2025
